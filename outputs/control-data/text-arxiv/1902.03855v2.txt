ALL THOSE EPPA CLASSES
(STRENGTHENINGS OF THE HERWIG–LASCAR THEOREM)

arXiv:1902.03855v2 [math.CO] 21 Aug 2020

JAN HUBIČKA, MATĚJ KONEČNÝ, AND JAROSLAV NEŠETŘIL

Abstract. Let A be a finite structure. We say that a finite structure B is an
EPPA-witness for A if it contains A as a substructure and every isomorphism
of substructures of A extends to an automorphism of B. Class C of finite structures has the extension property for partial automorphisms (EPPA, also called
the Hrushovski property) if it contains an EPPA witness for every structure
in C.
We give a systematic framework for combinatorial constructions of EPPA
witnesses satisfying additional local properties and thus for proving EPPA for
a given class C. Our constructions are elementary, self-contained and lead
to a common strengthening of the Herwig–Lascar theorem on EPPA for relational classes defined by forbidden homomorphisms, the Hodkinson–Otto
theorem on EPPA for relational free amalgamation classes, its strengthening
for unary functions by Evans, Hubička and Nešetřil and their coherent variants by Siniora and Solecki. We also prove an EPPA analogue of the main
results of J. Hubička and J. Nešetřil: All those Ramsey classes (Ramsey classes
with closures and forbidden homomorphisms), thereby establishing a common
framework for proving EPPA and the Ramsey property.
There are numerous applications of our results, we include a solution of
a problem related to a class constructed by the Hrushovski predimension
construction. We also characterize free amalgamation classes of finite ΓL structures with relations and unary functions which have EPPA.

This paper is part of a project that has received funding from the European Research Council
(ERC) under the European Union’s Horizon 2020 research and innovation programme (grant
agreement No 810115). Jan Hubička and Matěj Konečný are further supported by project 1813685Y of the Czech Science Foundation (GAČR), Jan Hubička is also supported by Center for
Foundations of Modern Computer Science (Charles University project UNCE/SCI/004) and by
the PRIMUS/17/SCI/3 project of Charles University and Matěj Konečný is also supported by
the Charles University Grant Agency (GA UK), project 378119.
1

2

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Contents
1. Introduction
1.1. ΓL -structures
1.2. The results
1.3. EPPA and Ramsey
2. Background and notation
2.1. Maps between ΓL -structures
2.2. Amalgamation classes
2.3. EPPA for ΓL -structures
2.4. Coherence of EPPA-witnesses
3. Warm-up: new proof of EPPA for graphs
4. Coherent EPPA for relational structures
5. Infinite languages
5.1. Proof of Proposition 5.1
6. EPPA for structures with unary functions
7. Irreducible structure faithful EPPA
8. Unwinding induced cycles
9. Locally tree-like EPPA-witnesses: Proof of Theorem 1.2
10. A generalisation of the Herwig–Lascar theorem: Proof of Theorem 1.5
11. Connections to the structural Ramsey theory: Proof of Theorem 1.6
12. Applications
12.1. Free amalgamation classes
12.2. Metric spaces without large cliques
12.3. Structures with constants
12.4. EPPA for k-orientations with d-closures
13. Conclusion
References

3
3
4
5
7
7
8
9
10
11
14
16
17
19
21
25
27
31
32
34
34
34
36
38
41
42

ALL THOSE EPPA CLASSES

3

1. Introduction
Let A and B be finite structures (e.g. graphs, hypergraphs or metric spaces)
such that A is a substructure of B. We say that B is an EPPA-witness for A if
every isomorphism of substructures of A (a partial automorphism of A) extends to
an automorphism of B. We say that a class C of finite structures has the extension
property for partial automorphisms (EPPA, also called the Hrushovski property) if
for every A ∈ C there is B ∈ C which is an EPPA-witness for A.
In 1992, Hrushovski [Hru92] established that the class of all finite graphs has
EPPA. This result was used by Hodges, Hodkinson, Lascar, and Shelah to show
the small index property for the random graph [HHLS93]. After this, the quest of
identifying new classes of structures with EPPA continued with a series of papers
including [Her95, Her98, HL00, HO03, Sol05, Ver08, Con19, Ott17, ABWH+ 17c,
HKN19, Kon19a, HKN18, EHKN20].
In particular, Herwig and Lascar [HL00] proved EPPA for certain relational
classes with forbidden homomorphisms. Solecki [Sol05] used this result to prove
EPPA for the class of all finite metric spaces (this was independently obtained by
Vershik [Ver08], see also [Pes08, Ros11b, Ros11a, Sab17, HKN19] for other proofs,
some combinatorial [HKN19], others using the profinite topology on free groups and
the Ribes–Zalesskii [RZ93] and Marshall Hall [Hal49] theorems). Solecki’s argument
was refined by Conant [Con19] for certain classes of generalised metric spaces and
metric spaces with (some) forbidden subspaces. In [ABWH+ 17c], these techniques
were carried further and a layer was added on top of the Herwig–Lascar theorem
to show EPPA for many classes of metrically homogeneous graphs from Cherlin’s
catalogue [Che17] (see also exposition in [Kon18]).
There are known EPPA classes to which the Herwig–Lascar theorem is not well
suited. In particular, EPPA for free amalgamation classes of relational structures was shown by Siniora and Solecki [SS19] using results of Hodkinson and
Otto [HO03]. It was noticed by Ivanov [Iva15] that a lemma on permomorphisms
from Herwig’s paper [Her98, Lemma 1] can be used to show EPPA for structures
with definable equivalences on n-tuples with infinitely many equivalence classes.
Evans, Hubička, and Nešetřil [EHN17] strengthened the aforementioned construction of Hodkinson and Otto and established EPPA for free amalgamation classes
in languages with relations and unary functions (e.g. the class of k-orientations
arising from a Hrushovski construction [EHN19] or the class of all finite bowtie-free
graphs [EHN19]).
We give a combinatorial, elementary, and fully self-contained proof of a strengthening of all the aforementioned results [Her98, HL00, HO03, EHN17] and their
coherent variants by Siniora and Solecki [SS19, Sin17]. This has a number of applications, in Section 12.4 we present a solution of a problem related to a class
constructed by the Hrushovski predimension construction. For additional applications, see also [Kon19b].
1.1. ΓL -structures. Before presenting the summary of our results, let us introduce the structures we are dealing with. With applications in mind, we generalise
the standard notion of model-theoretic L-structures in two directions. We consider
functions which go to subsets of the vertex set and we also equip the languages with
a permutation group ΓL . Our morphisms will consist of a map between vertices
together with a permutation of the language: The standard notions of homomorphism, embedding etc. are generalised naturally, (see Section 2). If ΓL consists of
the identity only and the ranges of all functions consist of singletons, one gets back
the standard model-theoretic L-structures together with the standard mappings,
the standard definition of EPPA etc.

4

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

1.2. The results. We now state the principal results of this paper together with
a short discussion.
A structure is irreducible if it is not a free amalgamation of its proper substructures. If B is an EPPA-witness for A, we say that it is irreducible structure faithful
if whenever C is an irreducible substructure of B, then there is an automorphism
g ∈ Aut(B) such that g(C) ⊆ A. A class has irreducible structure faithful EPPA
if it has EPPA and all EPPA-witnesses can be chosen to be irreducible structure
faithful. (We shall remark that this is a natural generalization of the clique faithful
EPPA introduced by Hodkinson and Otto [HO03] to structures with functions.)
Coherent EPPA is a concept introduced by Siniora and Solecki [SS19, Sin17] and
is defined in Section 2.4.
In this paper, we prove two main theorems. The “base” unrestricted theorem,
formulated as Theorem 1.1, gives irreducible structure faithful coherent EPPA for
the class of all finite ΓL -structures, strengthening results of Herwig’s [Her98, Lemma
1], Hodkinson and Otto [HO03], its coherent variant of Siniora and Solecki [SS19],
and Evans, Hubička, and Nešetřil [EHN17].
Theorem 1.1 (Construction of a unrestricted EPPA-witness). Let L be a language
consisting of relation and unary function symbols equipped with a permutation group
ΓL and let A be a finite ΓL -structure. If A lies in a finite orbit of the action of ΓL
by relabelling, then there is a finite ΓL -structure B, which is an irreducible structure
faithful coherent EPPA-witness for A.
Consequently, the class of all finite ΓL -structures has irreducible structure faithful
coherent EPPA if every finite ΓL -structure lies in a finite orbit of the action of ΓL
by relabelling.
Here, the action of ΓL by relabelling is defined such that g ∈ ΓL sends a ΓL structure A to a ΓL -structure A0 on the same vertex set where the relations and
functions are relabelled according to g (see Definition 2.1). Note that in particular
if ΓL is finite (e.g. ΓL = {idL } or L is finite), then every ΓL -structure lies in a finite
orbit of the action of ΓL by relabelling.
After that, we provide a theorem which, given a finite irreducible structure
faithful (coherent) EPPA-witness B0 for A, produces a finite irreducible structure faithful (coherent) EPPA-witness B for A, providing extra control over the
local structure of B:
Theorem 1.2 (Construction of a restricted EPPA-witness). Let L be a language
consisting of relations and unary functions equipped with a permutation group ΓL ,
let A be a finite irreducible ΓL -structure, let B0 be a finite EPPA-witness for A and
let n ≥ 1 be an integer. There is a finite ΓL -structure B satisfying the following.
(1) B is an irreducible structure faithful EPPA-witness for A.
(2) There is a homomorphism-embedding B → B0 .
(3) For every substructure C of B on at most n vertices there is a tree amalgamation D of copies of A and a homomorphism-embedding f : C → D.
(4) If B0 is coherent then so is B.
Here, a tree amalgamation of copies of A is any structure which can be created by a series of free amalgamations of copies of A over its substructures (see
Definition 9.1).
Theorem 1.1 contains the condition that A needs to lie in a finite orbit of the
action of ΓL by relabelling. We prove that this is in fact necessary:
Theorem 1.3. Let L be a language equipped with a permutation group ΓL and let
A be a finite ΓL -structure. If A lies in an infinite orbit of the action of ΓL by
relabelling, then there is no finite ΓL -structure B which is an EPPA-witness for A.

ALL THOSE EPPA CLASSES

5

Then, we can combine Theorems 1.1 and 1.3 with an easy observation used
earlier [HO03, EHN17, Sin17] and characterize free amalgamation classes of finite
ΓL -structures which have (irreducible structure faithful coherent) EPPA, provided
that all functions in the language are unary. The following theorem strengthens
results of Hodkinson and Otto [HO03], Evans, Hubička, and Nešetřil [EHN17],
and Siniora [Sin17], and in particular implies irreducible structure faithful coherent
EPPA for the class of all graphs, Kn -free graphs or k-regular hypergraphs.
Corollary 1.4. Let L be a language consisting of relations and unary functions
equipped with a permutation group ΓL and let K be a free amalgamation class of
finite ΓL -structures. Then K has EPPA if and only if every A ∈ K lies in a finite
orbit of the action of ΓL on ΓL -structures by relabelling. Moreover, if K has EPPA,
then it has irreducible structure faithful coherent EPPA.
We also provide two corollaries of Theorem 1.2, which might be easier to apply
in some cases. The first corollary is a direct strengthening of the Herwig–Lascar
theorem [HL00, Theorem 3.2] and its coherent variant of Solecki and Siniora [SS19,
Theorem 1.10]. For a set F of ΓL -structures, we denote by Forbhe (F) the set
of all finite and countable ΓL structures A such that there is no F ∈ F with a
homomorphism-embedding F → A.
Theorem 1.5. Let L be a language consisting of relations and unary functions
equipped with a permutation group ΓL . Let F be a finite family of finite ΓL -structures
and let A ∈ Forbhe (F) be a finite ΓL -structure which lies in a finite orbit of the
action of ΓL by relabelling. If there exists a structure M ∈ Forbhe (F) containing
A as a substructure such that each partial automorphism of A extends to an automorphism of M, then there exists a finite structure B ∈ Forbhe (F) which is an
irreducible structure faithful coherent EPPA-witness for A.
Hubička and Nešetřil [HN19] gave a structural condition for a class to be Ramsey.
It turns out that, in papers studying Ramsey expansions of various classes using
their theorem, EPPA is often an easy corollary of one of the intermediate steps,
see e.g. [ABWH+ 17c, ABWH+ 17a, ABWH+ 17b, Kon19a]. In this paper, we make
this link explicit by proving a theorem on EPPA whose statement is very similar
to [HN19, Theorem 2.18]. For the definition of a locally finite automorphismpreserving subclass, see Section 11.
Theorem 1.6. Let L be a language consisting of relation and unary function symbols equipped with a permutation group ΓL and let E be a class of finite ΓL -structures
which has EPPA. Let K be a hereditary locally finite automorphism-preserving subclass of E with the amalgamation property which consists of irreducible structures.
Then K has EPPA.
Moreover, if EPPA-witnesses in E can be chosen to be coherent then EPPAwitnesses in K can be chosen to be coherent, too.
1.3. EPPA and Ramsey. The results and techniques of this paper are motivated
by recent developments of the structural Ramsey theory, particularly the efforts to
characterise Ramsey classes of finite structures. As this paper demonstrates, many
techniques and proof strategies from structural Ramsey theory may serve as a motivation for results about EPPA classes. We were inspired by the scheme of proofs
of corresponding Ramsey results in [HN19], by the construction of clique faithful
EPPA-witnesses for relational structures given by Hodkinson and Otto [HO03] (see
also [EHN17]) and by the recent proof of EPPA for two-graphs [EHKN20]. This
can be outlined as follows:

6

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

In each section, we fix a ΓL -structure A and give an explicit construction of a
ΓL -structure B and an embedding A → B. Then we, given a partial automorphism
of A, show how to construct an automorphism of B extending it, that is, we prove
that B is an EPPA-witness for A. Finally, we prove that B has the given special
properties (e.g. irreducible structure faithfulness, or control over small substructures) and that the extension is coherent. Usually, the constructions are the difficult
part and the proofs are just verification that a function is an automorphism and
that it composes correctly.
While all this may be surprising on the first glance and it is one of the novelties
of this paper, we want to stress at this point some of the main differences between
EPPA and Ramsey. (Further open problems will be in Section 13.)
Both EPPA and the Ramsey property imply the amalgamation property (see
Observation 2.4 and [Neš05]) and have strong consequences for the Fraı̈ssé limits.
Nonetheless, not every amalgamation class has EPPA or the Ramsey property, and
in fact one can not even ask for a “reasonable” expansion with EPPA or the Ramsey property. While there is a meaningful conjecture motivating the classification
program of Ramsey classes (see [HN19, BPT11]), for the classification of EPPA
classes this is not yet the case.
The classification programme for EPPA classes was initiated in [EHN19, EHN17]
by giving examples of classes with non-trivial EPPA expansion. There exist many
classes which have a non-trivial Ramsey expansion but fail to have a non-trivial
EPPA expansion. Examples include the class of all finite linear orders or the class
of all finite finite partially ordered sets. On the other hand, the authors are not
aware of any classes with EPPA for which it is known that their Ramsey expansion
needs to fix all vertices.
The correspondence between the structural conditions for EPPA and Ramsey
classes then motivates the following conjecture.
Conjecture 1.7. Every class with EPPA has a precompact Ramsey expansion.
(See, for example [NVT15] for a definition of a precompact expansion.) Classes
known to have EPPA where the existence of a precompact Ramsey expansion is
open include the class of all finite groups [Sin17, PS18] and the class of all finite
skew-symmetric bilinear forms [Eva05]. More open problems are listed in Section 13.
It is worth to mention a result of Jahel and Tsankov [JT20] who prove that
for a large number of classes, EPPA implies the ordering property (which is closely
related to the Ramsey property, see [KPT05]). In particular, this implies that while
for Ramsey classes, there exists an ordering of Fraı̈ssé limit which is compatible with
the group of automorphisms, for EPPA classes satisfying the conditions of [JT20]
such a global ordering cannot be definable. This in fact may be the main dividing
line which may be schematically depicted as follows.
Ramsey
classes

amalgamation
classes

EPPA
classes

more
special structures

ultrahomogeneous
structures

special
structures

This paper is organised as follows: In Section 2, we give all the necessary notions
and definitions. In Section 3, which is supposed to serve as a warm-up, we give a
new proof of (coherent strengthening of) Hrushovski’s theorem [Hru92]. Then, in
Sections 4 and 5, we show that the construction generalises naturally to relational

ALL THOSE EPPA CLASSES

7

ΓL -structures. In Section 6, we add a new layer which allows the language to also
contain unary functions. In Section 7, we combine this with techniques introduced
earlier [HO03, EHN17] to obtain irreducible structure faithfulness, and in Section 8,
we once again use a similar construction to deal with forbidden homomorphic images, which allows us to prove the main theorems of this paper in Sections 9, 10
and 11. Finally, in Section 12, we apply our results and prove EPPA for the class
of k-orientations with d-closures, thereby confirming the first part of [EHN19, Conjecture 7.5]. We also prove Corollary 1.4, illustrate the usage of Theorems 1.1
and 1.6 on the example of integer-valued metric spaces with no large subspaces,
where all vertices are in distance 1 from each other and prove EPPA for languages
with constants.
2. Background and notation
To state our main result, we find it convenient to work with model-theoretic
structures generalised in two ways: We equip the language with a permutation
group (giving a more systematic treatment to the concept of permomorphisms introduced by Herwig [Her98]) and consider functions to the powerset (a further
generalisation of [EHN17]). This is motivated by applications, see Section 12.4.
Let L = LR ∪ LF be a language consisting of relation symbols R ∈ LR and
function symbols F ∈ LF each having its arity denoted by a(R) ≥ 1 for relations
and a(F) ≥ 0 for functions.
Let ΓL be a permutation group on L which preserves types and arities of all
symbols. We say that ΓL is a language equipped with a permutation group. Observe
that when ΓL is trivial and the ranges of all functions consist of singletons, one obtains the usual notion of model-theoretic language (and structures). All results and
constructions in this paper presented on ΓL -structures thus hold also for standard
L-structures. By this we mean that given a class of standard L-structures, one can
treat them as ΓL -structures with ΓL trivial, use the results of this paper and then,
perhaps after some straightforward adjustments, obtain the same results for the
original class.
Denote by P(A) the set of all subsets of A. A ΓL -structure A is a structure
with vertex set A, functions FA : Aa(F) → P(A) for every F ∈ LF and relations
RA ⊆ Aa(R) for every R ∈ LR . Notice that the domain of a function is a tuple while
the range is a set. If the set A is finite, we call A a finite structure. We consider
only structures with finitely or countably infinitely many vertices. If LF = ∅, we
call L a relational language and say that a ΓL -structure is a relational ΓL -structure.
A function F such that a(F) = 1 is a unary function.
In this paper, the language and its permutation group are often fixed and understood from the context (and they are in most cases denoted by L and ΓL respectively), we also only consider unary functions.
2.1. Maps between ΓL -structures. A homomorphism f : A → B is a pair f =
(fL , fA ) where fL ∈ ΓL and fA is a mapping A → B such that for every R ∈ LR
and F ∈ LF we have:
(a) (x1 , x2 , . . . , xa(R) ) ∈ RA =⇒ (fA (x1 ), fA (x2 ), . . . , fA (xa(R) )) ∈ fL (R)B ,
and
(b) fA (FA (x1 , x2 , . . . , xa(F) )) ⊆ fL (F )B (fA (x1 ), fA (x2 ), . . . , fA (xa(F) )).
For brevity, we will also write f (x) for fA (x) in the context where x ∈ A, and
f (S) for fL (S) where S ∈ L. For a subset A0 ⊆ A, we denote by f (A0 ) the set
{f (x) : x ∈ A0 }.
If fA is injective then f is called a monomorphism. A monomorphism f is an
embedding if for every R ∈ LR and F ∈ LF :

8

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

B1
β1
α1

A

α2
β2
B2
C

Figure 1. An amalgamation of B1 and B2 over A.
(a) (x1 , x2 , . . . , xa(R) ) ∈ RA ⇐⇒ (f (x1 ), f (x2 ), . . . , f (xa(R) )) ∈ f (R)B , and
(b) f (FA (x1 , x2 , . . . , xa(F) )) = f (F )B (f (x1 ), f (x2 ), . . . , f (xa(F) )).
If f is an embedding where fA is one-to-one then f is an isomorphism. An isomorphism from a structure to itself is called an automorphism. If fA is an inclusion
and fL is the identity then A is a substructure of B.
Given a ΓL -structure A and B ⊆ A, the closure of B in A, denoted by ClA (B),
is the smallest substructure of A containing B. For x ∈ A, we will also write ClA (x)
for ClA ({x}).
If f is a homomorphism, we denote by f (A) the homomorphic image of structure
A, that is, the ΓL -structure with vertex set f (A) such that for every R ∈ LR and
F ∈ LF we have:
(a) Rf (A) = fA (fL−1 (R)A ), and
(b) for every x̄ ∈ f (A)a(F) it holds that
[
Ff (A) (x̄) =
fA (fL−1 (F )A (ȳ)).
ȳ∈Aa(F ) ,x̄=f (ȳ)

Note that f is a homomorphism A → f (A) (and moreover all relations and functions of f (A) are minimal possible). Also observe that if fA is injective, then f is
an isomorphism A → f (A).
Definition 2.1. Let L be a language consisting of relations and unary functions equipped with a permutation group ΓL . We define the action of ΓL on ΓL structures by relabelling, such that for a ΓL -structure A and g ∈ ΓL , we define gA
as (g, idA )(A).
Observation 2.2. Let L be a language consisting of relations and unary functions
equipped with a permutation group ΓL . If L is finite or ΓL = {idL }, then every finite
ΓL -structure lies in a finite orbit of the action of ΓL by relabelling.
Proof. If L is finite, then there are only finitely many ΓL -structures on any given
finite set A and the action of ΓL by relabelling preserves the vertex set. If ΓL =
{idL }, then the action is trivial and every orbit is a singleton.

2.2. Amalgamation classes. Let A, B1 , and B2 be ΓL -structures, and let α1 : A
→ B1 , α2 : A → B2 be embeddings. A structure C with embeddings β1 : B1 → C
and β2 : B2 → C such that β1 ◦ α1 = β2 ◦ α2 (note that this also must hold for the
language part of αi ’s and βi ’s) is called an amalgamation of B1 and B2 over A with
respect to α1 and α2 . See Figure 1. We will often call C simply an amalgamation

ALL THOSE EPPA CLASSES

9

of B1 and B2 over A (in most cases α1 and α2 can be chosen to be inclusion
embeddings).
We say that the amalgamation is strong if it holds that β1 (x1 ) = β2 (x2 ) if
and only if x1 ∈ α1 (A) and x2 ∈ α2 (A). Strong amalgamation is free if C =
β1 (B1 ) ∪ β2 (B2 ), and whenever a tuple x̄ of vertices of C contains vertices of both
β1 (B1 \ α1 (A)) and β2 (B2 \ α2 (A)), then x̄ is in no relation of C and for every
function F ∈ L with a(F) = |x̄| it holds that FC (x̄) = ∅.
Definition 2.3. An amalgamation class is a class K of finite ΓL -structures which
is closed for isomorphisms and satisfies the following three conditions:
(1) Hereditary property: For every A ∈ K and every structure B with an
embedding f : B → A we have B ∈ K;
(2) Joint embedding property: For every A, B ∈ K there exists C ∈ K with an
embeddings f : A → C and g : B → C;
(3) Amalgamation property: For A, B1 , B2 ∈ K and embeddings α1 : A → B1 ,
α2 : A → B2 , there is C ∈ K which is an amalgamation of B1 and B2 over
A with respect to α1 and α2 .
If the C in the amalgamation property can always be chosen to be a strong amalgamation, then K is a strong amalgamation class, if it can always be chosen to be
the free amalgamation, then K is a free amalgamation class.
By the Fraı̈ssé theorem [Fra53], relational amalgamation classes in a countable language with trivial ΓL containing only countably many members up to isomorphism correspond to countable homogeneous structures. This correspondence
can be generalised further to languages with functions equipped with permutation
groups etc. under natural conditions (e.g. every finite set needs to have a finite
closure).
Generalising the notion of a graph clique, we say that a structure is irreducible
if it is not the free amalgamation of its proper substructures. A homomorphism
f : A → B is a homomorphism-embedding if the restriction f |C is an embedding
whenever C is an irreducible substructure of A. Given a family F of ΓL -structures,
we denote by Forbhe (F) the class of all finite or countably infinite ΓL -structures A
such that there is no F ∈ F with a homomorphism-embedding F → A.
2.3. EPPA for ΓL -structures. A partial automorphism of a ΓL -structure A is an
isomorphism f : C → C0 , where C and C0 are substructures of A (note that it also
includes a permutation from ΓL ). Let A and B be finite ΓL -structures. We say that
B is an EPPA-witness for A if there is an embedding ψ : A → B and every partial
automorphism of ψ(A) extends to an automorphism of B.
We say that a class of finite ΓL -structures K has the extension property for
partial automorphisms (EPPA, sometimes called the Hrushovski property) if for
every A ∈ K there is B ∈ K which is an EPPA-witness for A. Such a structure B
is irreducible structure faithful (with respect to ψ(A)) if it has the property that
for every irreducible substructure C of B there exists an automorphism g of B such
that g(C) ⊆ ψ(A).
Note that the classes which we are interested in are closed under taking isomorphisms, and hence if there is an EPPA-witness B for A in K, then there is also an
EPPA-witness B0 ∈ K such that ψ is just the inclusion A ⊆ B0 . To simplify the
arguments, we will often ignore this subtle technicality.
Homomorphism-embeddings were introduced in [HN19] and irreducible structure
faithfulness was introduced in [EHN17] as a generalisation of clique faithfulness
of Hodkinson and Otto [HO03]. The following (probably folkloristic) observation
provides a link to the study of homogeneous structures.

10

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Observation 2.4. Every hereditary isomorphism-closed class of finite ΓL -structures
which has EPPA and the joint embedding property (see Definition 2.3) is an amalgamation class.
Proof. Let K be such a class and let A, B1 , B2 ∈ K, α1 : A → B1 , α2 : A → B2 be
as in Definition 2.3. Let B be the joint embedding of B1 and B2 (that is, we have
embeddings β10 : B1 → B and β20 : B2 → B) and let C be an EPPA-witness for B.
Without loss of generality, we can assume that B ⊆ C.
Let ϕ be a partial automorphism of B sending β10 (α1 (A)) to β20 (α2 (A)) and let
θ be its extension to an automorphism of C. Finally, put β1 = θ ◦ β10 and β2 = β20 .
It is easy to check that β1 and β2 certify that C is an amalgamation of B1 and B2
over A with respect to α1 and α2 .

2.4. Coherence of EPPA-witnesses. Siniora and Solecki [Sol09, SS19] strengthened the notion of EPPA in order to get a dense locally finite subgroup of the
automorphism group of the corresponding Fraı̈ssé limit.
Definition 2.5 (Coherent maps). Let X be a set and let P be a family of partial
bijections between subsets of X. A triple (f, g, h) from P is called a coherent triple
if
Dom(f ) = Dom(h), Range(f ) = Dom(g), Range(g) = Range(h)
and
h = g ◦ f.
Let X and Y be sets, and let P and Q be families of partial bijections between
subsets of X and between subsets of Y , respectively. A function ϕ : P → Q is
said to be a coherent map if for each coherent triple (f, g, h) from P, its image
(ϕ(f ), ϕ(g), ϕ(h)) in Q is also coherent.
Definition 2.6 (Coherent EPPA). A class K of finite ΓL -structures is said to have
coherent EPPA if K has EPPA and moreover the extension of partial automorphisms
is coherent. That is, for every A ∈ K, there exists B ∈ K and an embedding
ψ : A → B such that every partial automorphism f of ψ(A) extends to some
fˆ ∈ Aut(B) with the property that the map ϕ from the partial automorphisms of
ψ(A) to Aut(B) given by ϕ(f ) = fˆ is coherent. We also say that B is a coherent
EPPA-witness for A.
The following easy proposition will be used several times. We include its proof
to make this paper self-contained.
Proposition 2.7 (Lemma 2.1 in [SS19]). The class of all finite sets has coherent
EPPA. That is, for every finite set A and a partial injective function ϕ : A → A
(i.e. its domain is a subset of A) there is a permutation θ : A → A such that ϕ ⊆ θ.
Moreover, θ can be chosen so that if ϕ1 , ϕ2 and ϕ are partial injective functions from A to A such that they form a coherent triple and θ1 , θ2 and θ their
corresponding extensions as above, then θ = θ2 ◦ θ1 .
Proof. Fix a set A. We can without loss of generality assume that A = {1, 2, . . . , n}.
Let ϕ be a partial automorphism of A, in other words, a partial injective function
A → A. We construct an automorphism θ : A → A extending ϕ in the following
way:
Put X = A \ Dom(ϕ) and Y = A \ Range(ϕ) and enumerate X = {x1 , . . . , xk }
and Y = {y1 , . . . , yk } such that x1 < · · · < xk and y1 < · · · < yk . Define θ by
(
ϕ(x) if x ∈ Dom(ϕ)
θ(x) =
yi
if x = xi .

ALL THOSE EPPA CLASSES

11

It is obvious that θ is a permutation of A which extends ϕ. Thus it only remains
to prove the furthermore part, that is, coherence.
Consider x ∈ A. If x ∈ Dom(ϕ1 ), then clearly θ(x) = θ2 (θ1 (x)). Put X =
A \ Dom(ϕ) (which is equal to A \ Dom(ϕ1 )), Y = A \ Range(ϕ1 ) (= A \ Dom(ϕ2 ))
and Z = A\Range(ϕ) (= A\Range(ϕ2 )) and again enumerate them in an ascending
order. If x = xi , we have θ1 (xi ) = yi , θ2 (yi ) = zi and θ(xi ) = zi , therefore indeed
θ(xi ) = θ2 (θ1 (xi )).

When using this result, we will often simply say that we extend a partial permutation in an order-preserving way or coherently.
3. Warm-up: new proof of EPPA for graphs
We start with a simple proof of the theorem of Hrushovski [Hru92] (different from
the proof given by Herwig and Lascar [HL00, Section 4.1]). This is the simplest
case where the construction of coherent EPPA-witnesses is non-trivial. We consider
graphs to be (relational) structures in a language with a single binary relation E
which is always symmetric and irreflexive.
Fix a graph A with vertices A = {1, 2, . . . , n}.
Witness construction. We give a construction of a coherent EPPA-witness B for
a structure A0 isomorphic to A, which clearly implies that there is also a coherent
EPPA-witness for A. B will be constructed as follows:
(1) The vertices of B are all pairs (x, χ) where x ∈ A and χ is a function from
A \ {x} to {0, 1} (called a valuation function for x).
(2) Vertices (x, χ) and (x0 , χ0 ) form an edge if and only if x 6= x0 and χ(x0 ) 6=
χ0 (x).
We now define a generic copy A0 of A in B by constructing an embedding ψ : A →
B by putting ψ(x) = (x, χx ), where χx (y) = 1 if x > y and {x, y} ∈ EA and
χx (y) = 0 otherwise (remember that we enumerated A = {1, 2, . . . , n}). We put
A0 to be the graph induced by B on ψ(A). It follows directly that ψ is indeed an
embedding of A into B.
Remark 3.1. Note that the functions χx from the definition of ψ are in fact the
rows of an asymmetric variant of the adjacency matrix of A.
Let π : B → A be the projection mapping (x, χ) 7→ x. Note that π(ψ(x)) = x
for every x ∈ A. This means that A0 is transversal, that is, π is injective on A0 .
Constructing the extension. The construction from the following paragraphs is
schematically depicted in Figure 2.
Let ϕ be a partial automorphism of A0 . Using π we get a partial permutation of (the set) A and we denote by ϕ̂ the order-preserving extension of ϕ (cf.
Proposition 2.7) to a permutation of A.
We now construct a set F ⊆ A2 of flipped pairs by putting {x, y} ∈ F if x 6= y
and there is a valuation function χ such that (x, χ) ∈ Dom(ϕ) and χ(y) 6= χ0 (ϕ̂(y)),
where ϕ((x, χ)) = (ϕ̂(x), χ0 ).
Finally, define a function θ : B → B by putting
θ((x, χ)) = (ϕ̂(x), χ0 ),
where
(
0

χ (ϕ̂(y)) =

χ(y)
if {x, y} ∈
/F
1 − χ(y) if {x, y} ∈ F.

This function will be the coherent extension of ϕ.

12

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

B

θ

ϕ
A0

π
ϕ̂

ψ

ϕ

A

Figure 2. Scheme of the construction of θ.
Proofs. Both of the proofs in this section are only an explicit verification that our
constructions work as expected.
Lemma 3.2. θ is an automorphism of B extending ϕ. In other words, B is an
EPPA-witness for A.
Proof. Observe that the function θ−1 : B → B defined as
θ−1 ((x, χ)) = (ϕ̂−1 (x), χ0 )
where
0

−1

χ (ϕ̂

(
χ(y)
if {ϕ̂−1 (x), ϕ̂−1 (y)} ∈
/F
(y)) =
1 − χ(y) if {ϕ̂−1 (x), ϕ̂−1 (y)} ∈ F

is an inverse of θ and therefore θ is a bijection. Let (x, χ) and (y, ξ) be vertices of
B and denote θ((x, χ)) = (ϕ̂(x), χ0 ) and θ((y, ξ)) = (ϕ̂(y), ξ 0 ). If x = y, then by
the definition of B neither of (x, χ), (y, ξ) and (ϕ̂(x), χ0 ), θ((y, ξ)) = (ϕ̂(y), ξ 0 ) form
an edge. If x 6= y, then we have χ0 (ϕ̂(y)) 6= ξ 0 (ϕ̂(x)) if and only if χ(y) 6= ξ(x) (by
the definition of θ), hence θ preserves both edges and non-edges, that it, it is an
automorphism of B.
Let (x, χx ) ∈ Dom(ϕ) with ϕ((x, χx )) = (z, χz ). This means ϕ̂(x) = z and
therefore we know that θ((x, χx )) = (z, χ0 ) for some χ0 .
Recall the definition of F ({x, y} ∈ F if x 6= y and there is a valuation function χ
such that (x, χ) ∈ Dom(ϕ) and χ(y) 6= χ0 (ϕ̂(y)), where ϕ((x, χ)) = (ϕ̂(x), χ0 )) and
note that if there is also ξ such that (y, ξ) ∈ Dom(ϕ), then the condition above has
the same outcome when the roles of x and y are exchanged, that is, χ(y) 6= χ0 (ϕ̂(y))
if and only if ξ(x) 6= ξ 0 (ϕ̂(x)), where ϕ((y, ξ)) = (ϕ̂(y), ξ 0 ). This follows from the
definition of B and the fact that ϕ maps edges to edges and non-edges to non-edges.
This implies we have {x, y} ∈ F if and only if χx (y) 6= χz (ϕ̂(y)) and that, by
definition of θ, we have χx (y) 6= χ0 (ϕ̂(y)) if and only if {x, y} ∈ F , therefore indeed
χz = χ0 . This means that θ indeed extends ϕ.

Lemma 3.3. Let ϕ1 , ϕ2 and ϕ be partial automorphisms of A such that ϕ = ϕ2 ◦ϕ1
and θ1 , θ2 and θ their corresponding extensions as above. Then θ = θ2 ◦ θ1 .
Proof. Denote by ϕ̂1 , ϕ̂2 and ϕ̂ the corresponding permutations of A constructed
above, by F1 , F2 and F the corresponding sets of flipped pairs.

ALL THOSE EPPA CLASSES

13

By Proposition 2.7 we get that ϕ̂ = ϕ̂2 ◦ ϕ̂1 . To see that θ is a composition of
θ1 and θ2 it remains to verify that pairs flipped by θ are precisely those pairs that
are flipped by the composition of θ1 and θ2 .
This follows from the construction of F . Only pairs with at least one vertex in
the domain of ϕ1 are put into sets F and F1 and again only pairs with at least one
vertex in the domain of ϕ2 (which is the same as the value range of ϕ1 ) are put
into F2 .
Consider {x, y} ∈ F . This means that at least one of them (without loss of generality x) is in π(Dom(ϕ)) = π(Dom(ϕ1 )). Furthermore, for ϕ((x, χx )) = (z, χz ), we
know that χz (ϕ̂(y)) 6= χx (y). Because ϕ = ϕ2 ◦ ϕ1 , we get that either {x, y} ∈ F1 ,
or {ϕ̂1 (x), ϕ̂1 (y)} ∈ F2 (and precisely one of these happens). And this means that
both θ and θ2 ◦ θ1 flip {x, y}.
On the other hand, if {x, y} ∈
/ F , then either {x, y} is in both F1 and F2 or in
neither of them and then, again, neither θ nor θ2 ◦ θ1 flip {x, y}. This implies that
indeed θ = θ2 ◦ θ1 .

The previous lemmas immediately imply the following proposition.
Proposition 3.4. The graph B is a coherent EPPA-witness for A0 .
What now follows is a series of strengthenings of the main ideas from this section.
Each of the constructions will proceed in several steps:
(1) Define a structure B using a suitable variant of valuations.
(2) Give a construction of a generic copy A0 of A in B.
(3) For a partial automorphism ϕ of A0 , give a construction of θ : B → B.
(4) Prove that θ is an automorphism of B and that it extends ϕ.
(5) Prove that θ is coherent.
The proofs often consist of verification, usually very similar as in this section.
Remark 3.5. Note that B only depends on the number of vertices of A and, as
such, is a coherent EPPA-witness for all graphs with at most |A| vertices.
Remark 3.6. Hrushovski’s construction gives EPPA-witnesses on at most (2n2n )!
vertices (where |A| = n) and he asks if this can be improved [Hru92, Section 3].1 The
combinatorial construction of Herwig and Lascar [HL00] provides EPPA-witnesses
on roughly (kn)k vertices, where |A| = n and k is the maximum degree of a vertex
of A. Our construction gives EPPA-witnesses on n2n−1 vertices, thereby providing
the best uniform bound over all graphs on n vertices. The same construction was
found independently by Andréka and Németi [AN19].
Hrushovski also proves a lower bound |B| ≥ 2m + m for |A| = 2m. It remains
open to improve either of the bounds.
Remark 3.7. Corollary 1.4 implies coherent EPPA for the class of all k-uniform
hypergraphs and other such classes. However, its proof takes a detour by first constructing EPPA-witnesses where the k-ary relation is not symmetric and contains
tuples with repeated occurrences of the same vertices (a generalisation of loops),
and then relying on a construction of irreducible structure faithful EPPA-witnesses
to get a k-uniform hypergraph.
However, there is a direct generalisation of the ideas of this section, which gives
coherent EPPA for k-uniform hypergraphs (and more) directly, producing EPPAwitnesses on fewer vertices. For k = 3, vertices of B are pairs (x, χ), where χ is

a function from A\{x}
(the set of all (unordered) pairs of vertices of A different
2
from x) to {0, 1} and we say that (x, χ), (x0 , χ0 ), (x00 , χ00 ) form a hyperedge of B if
1We would like to thank H. Andréka and I. Németi for bringing this question to our attention.

14

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

and only if x, x0 and x00 are distinct and χ({x0 , x00 }) + χ0 ({x, x00 }) + χ00 ({x, x0 }) is
odd. The rest of the construction is generalised in the same way.
4. Coherent EPPA for relational structures
In this section we generalise the construction from the previous section to prove
the following proposition:
Proposition 4.1. Let L be a finite relational language equipped with a permutation
group ΓL and let A be a finite ΓL -structure. There exists a finite ΓL -structure, which
is a coherent EPPA-witness for A.
Fix a finite relational language L equipped with a permutation group ΓL and a
finite ΓL -structure A with A = {1, 2, . . . , n}. We will construct a ΓL -structure B
and give an embedding ψ : A → B such that B is a coherent EPPA-witness A.
Proposition 4.1 then immediately follows.
Witness construction. Given a vertex x ∈ A and an integer n, we denote by
UnA (x) the set of all n-tuples (i.e. n-element sequences) of elements of A containing
x. Note that UnA (x) also includes n-tuples with repeated occurrences of vertices.
Given R ∈ LR of arity n and a vertex x ∈ A, we say that a function χR : UnA (x) →
{0, 1} is an R-valuation function for x. An L-valuation function for a vertex x ∈ A
is a function χ assigning to every R ∈ L an R-valuation function χ(R) for x.
Now we are ready to give the definition of B:
(1) The vertices of B are all pairs (x, χ), where x ∈ A and χ is an L-valuation
function for x.
(2) For every relation symbol R of arity n we put
((x1 , χ1 ), (x2 , χ2 ), . . . , (xn , χn )) ∈ RB
if and only if for every 1 ≤ i < j ≤ n such that xi = xj it also holds that
χi = χj and furthermore
X
χ(R)((x1 , x2 , . . . , xn ))
χ∈{χi :1≤i≤n}

is odd (summing over χ ∈ {χi : 1 ≤ i ≤ n} ensures that possible multiple
occurrences of (xi , χi ) are only counted once).
Next we define a copy A0 of A, whose partial automorphisms we will then extend,
by giving an embedding ψ : A → B, putting ψL to be the identity, and
ψA (x) = (x, χx ),
where χx is an L-valuation function for x such that for every R ∈ L we have
χx (R)((y1 , y2 , . . . , yn )) = 1
if (y1 , y2 , . . . , yn ) ∈ RA and x = y1 , and
χx (R)((y1 , y2 , . . . , yn )) = 0
otherwise. Again it follows directly from the construction that ψ is an embedding
A → B which does not permute the language. We put A0 = ψ(A). Let π : B → A
defined as π((x, χ)) = x be the projection.

ALL THOSE EPPA CLASSES

15

Constructing the extension. As in Section 3, we fix a partial automorphism
ϕ : A0 → A0 and extend the projection of ϕ to a permutation ϕ̂ of A in an orderpreserving way. Note that ϕ already contains a permutation of the language, therefore we will focus on extending the structural part.
For every relation symbol R ∈ L of arity n, we construct a function FR : An →
{0, 1}n . These functions will play a similar role as the set F in Section 3 (i.e., they
will control the flips) and are constructed as follows:
(1) For n-tuples x̄ = (x1 , x2 , . . . , xn ) consisting only of vertices from π(Dom
(ϕ)), we put FR (x̄)i = 1 if and only if χxi (R)(x̄) 6= χ0 (ϕ(R))(ϕ̂(x̄)), where
χxi is the L-valuation function such that (xi , χxi ) ∈ A0 and χ0 is such that
ϕ((xi , χxi )) = (ϕ̂(xi ), χ0 ).
(2) For n-tuples x̄ = (x1 , x2 , . . . , xn ) containing vertices from π(Dom(ϕ)) as
well as vertices from outside of A \ π(Dom(ϕ)), we define FR (x̄)i in the
same way as above for all choices of i such that xi ∈ π(Dom(ϕ)). Let m
be the smallest index such that xm ∈
/ π(Dom(ϕ)). For every j > m such
that xj 6= xm and xj ∈
/ π(Dom(ϕ)) we put FR (x̄)j = 0. Finally we choose
the remaining entries (which all correspond to the same vertex xm ) to be
either all 0 or all 1 to ensure that the number of distinct vertices of x̄, such
that their corresponding entry in FR (x̄) is 1, is even.
(3) For n-tuples x̄ = (x1 , x2 , . . . , xn ) containing no vertices of π(Dom(ϕ)), we
put FR (x̄)i = 0 for all i ∈ {1, 2, . . . , n}.
Observe that by the construction, we get that FR (x̄)i = FR (x̄)j whenever x̄i = x̄j
and that
|{x̄i : FR (x̄)i = 1}|
is even (where taking the size of the set means that each distinct vertex is counted
only once even if it has repeated occurrences in x̄).
Define a function θ : B → B by putting
θ((x, χ)) = (ϕ̂(x), χ0 )
where
(
χ(R)(ȳ)
if FR (ȳ) has 0 on entry corresponding to x
χ0 (ϕ(R))(ϕ̂(ȳ)) =
1 − χ(R)(ȳ) if FR (ȳ) has 1 on entry corresponding to x.
Proofs. The rest follows analogously to Section 3.
Lemma 4.2. θ is an automorphism of B extending ϕ.
Proof. This follows in the same way as in Lemma 3.2. To get that θ is an automorphism, we use the parity property of each FR .

Lemma 4.3. Let ϕ1 , ϕ2 and ϕ be partial automorphisms of A such that ϕ = ϕ2 ◦ϕ1
and θ1 , θ2 and θ their corresponding extensions as above. Then θ = θ2 ◦ θ1 .
Proof. Let ϕ̂1 , ϕ̂2 and ϕ̂ be the permutations of A constructed in the previous
section of ϕ1 , ϕ2 and ϕ respectively, similarly define FR1 , FR2 and FR for every R ∈ L.
Since ϕ1 , ϕ2 and ϕ were extended in an order-preserving way, by Proposition 2.7
we get that ϕ̂ = ϕ̂2 ◦ ϕ̂1 .
Hence, by an argument analogous to the proof of Lemma 3.3, we can see that it
suffices to show that for every R ∈ L, for every x̄ ∈ Aa (R) and for every 1 ≤ i ≤
a(R), it holds that FR (x̄)i = FR1 (x̄)i + Fϕ21 (R) (ϕ̂1 (x̄))i mod 2.
Fix such R, x̄ and i. Put y = x̄i and (y, χ) = ψ(y).

16

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

First suppose that (y, χ) ∈ Dom(ϕ) = Dom(ϕ1 ) and denote (y 0 , χ0 ) = ϕ1 ((y, χ))
and (y 00 , χ00 ) = ϕ((y, χ)) = ϕ2 ((y 0 , χ0 )). By the construction, we have the following:
FR1 (x̄)i = 1 ⇐⇒ χ(x̄) 6= χ0 (ϕ̂1 (x̄)),
Fϕ21 (R) (ϕ̂1 (x̄))i = 1 ⇐⇒ χ0 (ϕ̂1 (x̄)) 6= χ00 (ϕ̂(x̄)),
FR (x̄)i = 1 ⇐⇒ χ(x̄) 6= χ00 (ϕ̂(x̄)).
It immediately follows that FR (x̄)i = 1 if and only if exactly one of FR1 (x̄)i and
Fϕ21 (R) (ϕ̂1 (x̄))i is equal to one and we are done.
Otherwise (y, χ) ∈
/ Dom(ϕ) and recall that we fixed R, x̄ and i. Let m be the
m from case 2 of the definition of θ for R and x̄, similarly let m1 be the m from
case 2 of the definition of θ1 for R and x̄, and let m2 be the m from case 2 of the
definition of θ2 for ϕ1 (R) and ϕ̂1 (x̄). Since (ϕ1 , ϕ2 , ϕ) is a coherent triple, we get
that m = m1 = m2 .
If y = x̄i 6= x̄m , it follows that FR1 (x̄)i = Fϕ21 (R) (ϕ̂1 (x̄))i = FR (x̄)i = 0. Hence
we can assume that y = x̄m .
Define I = {1 ≤ i ≤ n : FR (x̄)i = 1}, I1 = {1 ≤ i ≤ n : FR1 (x̄)i = 1} and
I2 = {1 ≤ i ≤ n : Fϕ21 (R) (ϕ̂1 (x̄))i = 1} and observe that by the previous paragraphs
we have that I is the symmetric difference of I1 and I2 , so in particular
|I| = |I1 | + |I2 + | − 2|I1 ∩ I2 |.
Also note that x̄j = x̄k if and only if ϕ̂1 (x̄)j = ϕ̂1 (x̄)k . It follows that
|{xj : j ∈ I}| = |{xj : j ∈ I1 }| + |{xj : j ∈ I2 } + | − 2|{xj : j ∈ I1 ∩ I2 }|,
where |{xj : j ∈ I}| is the number of distinct vertices of A such that their corresponding entry in FR (x̄) is equal to one. Looking at this equation modulo 2, we
get that |{xj : j ∈ I}| is odd if and only if precisely one of |{xj : j ∈ I1 }| and
|{xj : j ∈ I2 } is odd.
This implies (comparing with case 2 of the definitions of θ, θ1 and θ2 ) that even
for x̄i = x̄m , we have that FR (x̄)i = FR1 (x̄)i + Fϕ21 (R) (ϕ̂1 (x̄))i mod 2, which finishes
the proof.

This now implies Proposition 4.1.
Remark 4.4. The EPPA-witness B constructed in this section has at most


m
O |A|2|L||A|
vertices, where m is the largest arity of a relation in L. Consequently, the size of a
coherent EPPA-witness for A only depends on the language and on the number of
vertices of A.
5. Infinite languages
Contrary to languages (with relations and unary functions) without permutation
group, when a non-trivial permutation group is present, it is no longer true that
for every finite structure there is a finite EPPA-witness. Consider, for example, the
language L consisting of infinitely many unary relations, where ΓL is the symmetric
group. And let A be a structure with a single vertex which is in exactly one
relation. Then every EPPA-witness for A needs to, in particular, extend all partial
automorphisms of A of type (g, ∅), where g ∈ ΓL and ∅ is the empty map. This
implies that every EPPA-witness for A must contain a vertex in precisely one unary
relation U for every U ∈ L, hence infinitely many vertices.
First, we generalise this argument and prove Theorem 1.3:

ALL THOSE EPPA CLASSES

17

Proof of Theorem 1.3. A being in an infinite orbit means that there is an infinite
sequence g1 , g2 , . . . ∈ ΓL such that the sequence (g1 , idA )(A), (g2 , idA )(A), . . . consists of pairwise distinct structures. For a contradiction, assume that there is a
(finite) EPPA-witness B for A.
In particular, B needs to extend all partial automorphisms (gi , ∅), i ≥ 1, which
means that for every i ≥ 1, there is an embedding of (gi , idA )(A) into B. In other
words, for every i ≥ 1 we get a tuple x̄i ∈ B |A| , and by the assumption, all these
tuples are pairwise distinct. This implies that the set B |A| is infinite, and since |A|
is finite, it follows that B is infinite, a contradiction.

On the positive side, we prove the following proposition, thereby characterising
for which relational languages equipped with a permutation group the class of all
finite structures in the language has EPPA.
Proposition 5.1. Let L be a relational language equipped with a permutation group
ΓL and let A be a finite ΓL -structure such that A lies in a finite orbit of the action
of ΓL by relabelling. Then there is a finite ΓL -structure B which is a coherent
EPPA-witness for A.
In order to prove Proposition 5.1, we will need the following observation.
Observation 5.2. Let M be a relational language equipped with a permutation
group ΓM and let C be a class of finite ΓM -structures. Suppose that there is a set
N ⊆ M such that for every A ∈ C and every R ∈ M \ N , it holds that RA = ∅ and
for every π ∈ ΓM we have π(N ) = N (i.e. π fixes N setwise). Put
ΓN = {πN : π ∈ ΓM },
where for a permutation π : M → M , πN is its restriction to N .
Then ΓN is a permutation group on N and C has coherent EPPA if and only if
D does, where D is the class consisting of the same structures as C, but understood
as ΓN -structures.
Proof. Since every π ∈ ΓM fixes N setwise, we immediately get that ΓN is a permutation group on N . If C has coherent EPPA, then clearly D does, too, because
for each π 0 ∈ ΓN , we can simply pick an arbitrary π ∈ ΓM such that π 0 = πN and
use coherent EPPA for C. It thus remains to prove the other direction.
In the following, for A ∈ C, we denote by AN its corresponding ΓN -structure
from D.
Fix A ∈ C. By the assumption that D has coherent EPPA, we get B ∈ C
such that BN is a coherent EPPA-witness for AN . Let f = (fL , fA ) be a partial
automorphism of A. Then (fL N , fA ) is a partial automorphism of AN and it
extends to an automorphism (fL N , θ) of BN . It is straightforward to check that
(fL , θ) is an automorphism of B extending f (it clearly extends f , and it is an
automorphism of B, because B contains no relations from M \ N and fL (N ) = N ).
Coherence follows by coherence in D.

5.1. Proof of Proposition 5.1. First, we will define some auxiliary notions.
Given an n-tuple x̄ = (x1 , . . . , xn ) and a function ω : {1, . . . , m} → {1, . . . , n},
we define an m-tuple
x̄ ◦ ω = (xω(1) , . . . , xω(m) ).
For a ΓL -structure B and an n-tuple x̄ ∈ B containing no repeated vertices (i.e.
if x̄i = x̄j , then i = j), we define σ(x̄, B) to be the set of all pairs (R, ω), where
R ∈ L is an m-ary relation and ω : {1, . . . , m} → {1, . . . , n} is a surjective function,
such that x̄ ◦ ω ∈ RB .

18

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Next, we define sets M1 , M2 , . . ., such that Mn consists of all pairs (R, ω), where
R ∈ L is an m-ary relation and ω is a surjection {1, . . . , m} → {1, . . . , n}. Using
them, we define a language M 0 such that the n-ary relations of M 0 are precisely
RX , where X ⊆ Mn .
We put M = M 0 ∪ L (and assume without loss of generality that M 0 ∩ L = ∅).
For every g ∈ ΓL , we define a permutation πg on M such that
(
g(R) if R ∈ L,
πg (R) =
RY
if R = RX ∈ M 0 ,
where Y = {(g(S), ω) : (S, ω) ∈ X}.
Finally, we put ΓM = {πg : g ∈ ΓL }. It is easy to verify that the map g 7→ πg
is a group isomorphism ΓL → ΓM (this is the only place in the proof where we use
that L ⊆ M ).
Given a ΓL -structure B, we define a ΓM -structure T (B) such that the vertex
set of T (B) is B and for every x̄ ∈ B n containing no repeated vertices, we put
σ(x̄,B)
x̄ ∈ RT (B) . There are no other tuples in any relations of T (B).
In the other direction, given a ΓM -structure B such that RB = ∅ for every R ∈ L,
we define a ΓL -structure U (B) such that the vertex set of U (B) is B, and whenever
X
S
x̄ ∈ RB
, we put x̄ ◦ ω ∈ RU
(B) for every (S, ω) ∈ X. There are no other tuples in
any relations of U (B). It is easy to verify that T and U are mutually inverse, that
is U T (B) = B for every ΓL -structure B, and T U (B) = B for every ΓM -structure
B such that RB = ∅ for every R ∈ L.
In fact, these maps are functorial in the sense of the following lemma.
Lemma 5.3. Let B, C be ΓL -structures. Let (g, f ) be an embedding B → C (g ∈ ΓL ,
f : B → C). Then (πg , f ) is an embedding T (B) → T (C).
Let B, C be ΓM -structures such that RB = RC = ∅ for every R ∈ L. Let (πg , f )
be an embedding B → C (πg ∈ ΓM , f : B → C). Then (g, f ) is an embedding
U (B) → U (C).
Proof. We only need to verify the definition of an embedding. For the first part,
we know that for every S ∈ L, every n-tuple x̄ ∈ B containing no repeated vertices
and for every surjection ω : {1, . . . , m} → {1, . . . , n}, we have x̄ ◦ ω ∈ SB if and only
if f (x̄) ◦ ω ∈ g(S)B , which implies that
σ(f (x̄), (g, f )(B)) = {(g(S), ω) : (S, ω) ∈ σ(x̄, B)} ,
from which the claim follows. The second part can be proved in a complete analogy.

Define N to be the subset of M 0 consisting of all πg (Rσ(x̄,A) ), where πg ∈ ΓM
and x̄ is a tuple of vertices of A containing no repeated ones (remember that A is
the ΓL -structure fixed in the statement of Proposition 5.1).
We claim that N is finite: Whenever RX ∈ N , then there is x̄ ∈ A and πg ∈
ΓM such that RX = πg (Rσ(x̄,A) ), however, this is equivalent to saying that X =
σ(x̄, (g, idA )(A)). In other words, every n-ary relation RX ∈ N corresponds to
at least one pair (x̄, (g, idA )(A)), where x̄ is an n-tuple of vertices of A with no
repeated occurrences and g ∈ ΓL . Since A lies in a finite orbit of the action of
ΓL by relabelling, it follows that there are only finitely many different choices for
(g, ida )(A). By definition, all relations in N have arity at most |A|, hence there are
finitely many choices for x̄ and thus N is indeed finite. Observe also that for every
πg ∈ ΓM we have πg (N ) = N .
Let C be the class consisting of all ΓM -structures B such that whenever R ∈
M \ N , then RB = ∅. Observe that T (A) ∈ C and U (B) is defined for every B ∈ C.

ALL THOSE EPPA CLASSES

19

We have verified that C satisfies the conditions of Observation 5.2. Hence, we
get a permutation group ΓN on N and a class D, which in this case is simply the
class of all finite ΓN -structures and hence has coherent EPPA by Proposition 4.1.
By Observation 5.2 we then get that C also has coherent EPPA.
In particular, we get C ∈ C which is a coherent EPPA-witness for T (A). Putting
B = U (C), we have a ΓL -structure B such that T (B) is a coherent EPPA-witness
for T (A). In the last paragraph, we shall prove that B is a coherent EPPA-witness
for A.
Let (g, f ) be a partial automorphism of A. From the construction it follows that
(πg , f ) is a partial automorphism of T (A) (equivalently, it follows from Lemma 5.3
and the observation that a partial automorphism of A can be understood as a pair
of embeddings of the same structure into A), which extends to an automorphism
(πg , θ) of T (B) (that is, f ⊆ θ). By Lemma 5.3 again, we get that (g, θ) is an
automorphism of B, and since f ⊆ θ, it extends (g, f ). Coherence follows from
coherence of T (B), because πgf = πg πf . This finishes the proof of Proposition 5.1.
6. EPPA for structures with unary functions
We are now ready to introduce unary functions into the language. In order to do
it, we will use valuation structures instead of valuation functions, which was first
done in [EHN17]. Otherwise, we follow the general scheme, and prove the following
proposition.
Proposition 6.1. Let L be a language consisting of relation and unary function
symbols equipped with a permutation group ΓL and let A be a finite ΓL -structure
which lies in a finite orbit of the action of ΓL by relabelling. Then there is a
coherent EPPA-witness for A.
Fix a language L consisting of relation and unary function symbols equipped
with a permutation group ΓL , and a finite ΓL -structure A, which lies in a finite
orbit of the action of ΓL by relabelling.
Denote by LR ⊆ L the language consisting of all relation symbols of L and let
ΓLR be the group obtained by restricting permutations from ΓL to LR . For a ΓL structure D, we will denote by D− the ΓLR -reduct of D (that is, the ΓLR -structure
on the same vertex set as D with RD− = RD for every R ∈ LR )
Witness construction. Let B0 be a finite ΓLR -structure which is a coherent
EPPA-witness for A− (it exists by Proposition 5.1). We furthermore, for convenience, assume that A− ⊆ B0 . Let x ∈ B0 be a vertex of B0 and let V be a
ΓL -structure. We say that V is a valuation structure for x if the following hold:
(1) x ∈ V ,
(2) there exists y ∈ A and an isomorphism ι : V → ClA (y) satisfying ι(x) = y
(note that ι can permute the language),
(3) V− is a substructure of B0 .
We construct B as follows:
(1) The vertices of B are all pairs (x, V) where x ∈ B0 and V is a valuation
structure for x,
(2) for every relation symbol R ∈ L of arity n, we put ((x1 , V1 ), . . . , (xn , Vn )) ∈
RB if and only if (x1 , . . . , xn ) ∈ RB− ,
0
(3) for every (unary) function symbol F ∈ L we put
FB ((x, V)) = {(y, ClV (y)) : y ∈ FV (x)}.
Next we define an embedding ψ : A → B, putting ψA (x) = (x, ClA (x)) and
ψL = idL . Note that ClA (x) (a substructure of A) is indeed a valuation structure

20

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

for ι being the identity, because we assumed that A− ⊆ B0 . We put A0 = ψ(A) to
be the copy of A in B whose partial automorphisms we will extend.
Note that the vertex set of B is finite. Assume, for a contradiction, that it
is infinite. Since there are finitely many vertices in B0 , this implies that there is
x ∈ B0 for which there are infinitely many valuation structures. Moreover, by the
definition of a valuation structure, this implies that in fact there is a vertex y ∈ A,
a structure W ⊆ B0 , an injection ιW : W → ClA (y), a sequence of permutations
g1 , g2 , . . . and a sequence of structures V1 , V2 , . . ., such that the following hold:
(1) Vi− = W for every i ≥ 1 (so, in particular, they have the same vertex set),
(2) the structures V1 , V2 , . . . are pairwise distinct, and
(3) (gi , ιW ) is an embedding Vi → ClA (y) for every i ≥ 1.
Taking the inverse, we get that there is a substructure (g1 , ιW )(V1 ) = X ⊆ ClA (y)
−1
such that the structures (gi−1 , ιW
)(X) = Vi , i ≥ 1 are pairwise distinct, which gives
a contradiction with A lying in a finite orbit of the action of ΓL by relabelling.
Constructing the extension. Let π : B → B0 , defined by π((x, V)) = x, be the
projection. Note that π(A0 ) = A− and that (idL , π) is a homomorphism-embedding
B− → B0 . Fix a partial automorphism ϕ of A0 . It induces (by π and restriction
to ΓLR ) a partial automorphism ϕ0 of A− . Denote by ϕ̂ the extension of ϕ0 to an
automorphism of B0 .
We put
θ((x, V)) = (ϕ̂(x), U),
where U is a ΓL -structure such that U− = ϕ̂(V− ) and for every (unary) function
symbol F and every y ∈ V it holds that ϕL (F)U (ϕ̂(y)) = ϕ̂(FV (y)). In other words,
ϕ̂|V together with the permutation of function symbols from ϕ give an isomorphism
of V and U.
Proofs. We again proceed analogously to Section 3.
Lemma 6.2. θ is an automorphism of B extending ϕ.
Proof. By the definition of U, we get that θ is a bijection from B to B. The
relations on B only depend on the projection, and since ϕ̂ is an automorphism, we
get that θ respects the relations. The fact that θ also respects the functions follows
from the construction of U.

Lemma 6.3. Assume that B0 is a coherent EPPA-witness for A− and thus ϕ̂ can
be chosen to be coherent. Let ϕ1 , ϕ2 and ϕ be partial automorphisms of A such
that ϕ = ϕ2 ◦ ϕ1 and θ1 , θ2 and θ their corresponding extensions as above. Then
θ = θ2 ◦ θ1 .
Proof. Follows straightforwardly from the definition of θ: It is coherent on the first
coordinate by the assumption of B0 , the extension to the second coordinate is then
canonical and hence preserves coherence.

This proves Proposition 6.1.
Observation 6.4. The number of vertices of the EPPA-witness B constructed in
this section can be bounded from above by a function which depends only on the
number of vertices of B0 , the number of vertices of A and the size of the orbit of
the action of ΓL by relabelling in which A lies.
Proof. We know that the vertex set of B consists of pairs (x, V), where x ∈ B0
and V is a valuation structure for x. Thus, it is enough to bound the number of
valuation structures for any vertex of B0 . The vertex set of any valuation structure
is a subset of B0 , hence there are at most 2|B0 | different vertex sets of valuation

ALL THOSE EPPA CLASSES

21

structures (in fact, one can get much better bound). Hence it remains to bound
the number of different valuation structures on a given subset V ⊆ B0 .
Let A1 , . . . , Ao be an enumeration of the orbit of the action of ΓL by relabeling
in which A lies and let g1 , . . . , go ∈ ΓL such that Ai = (gi , idA )(A). Note that for
every embedding (fL , fU ) : U → A, where U is a ΓL -structure, there is i such that
(fL , fU )(U) = (gi−1 , fU )(U). Indeed, by the way embeddings compose, we have that
(fL , fU ) = (fL , idA ) ◦ (idL , fU ). Composing with (fL−1 , idA ) on the left, we get that
(idL , fU ) is an embedding U → (fL−1 , idA )(A). This means that there is i such that
(fL−1 , idA )(A) = Ai = (gi , idA )(A) and hence indeed (fL , fU )(U) = (gi−1 , fU )(U).
Fix V ⊆ B0 . For every valuation structure V on this vertex set, there is an
isomorphism ι = (ιL , ιV ) : V → ClA (y), where y ∈ A. Since ι is in particular
an embedding V → A, by the previous paragraph we get 1 ≤ i ≤ o such that
(ιL , ιV )(V) = (gi−1 , ιV )(V). Hence there are at most as many different structures
V as there are pairs (gi−1 , ιV ). Since there are at most o choices for gi−1 and at
most |A||V | ≤ |A||A| choices for ιV , the claim is proved.

From now on, our structures may contain unary functions. To some extent, the
unary functions do not interfere too much with the properties which we are going
to ensure and thus it is possible to treat them “separately”. Namely, we will always
first introduce a notion of a valuation function (in order to get the desired property)
and then wrap the valuation functions in a variant of the valuation structures.
7. Irreducible structure faithful EPPA
In this section we prove the following proposition, which is a strengthening
of [EHN17, Theorem 1.7], which in turn extends [HO03].
Proposition 7.1. Let L be a language consisting of relation and unary function
symbols equipped with a permutation group ΓL and let A be a finite ΓL -structure.
Let B0 be a finite ΓL -structure which is an EPPA-witness for A. Then there is a
finite ΓL -structure B which is an irreducible structure faithful EPPA-witness for A,
and a homomorphism-embedding B → B0 .
Moreover, if B0 is coherent, then B is coherent, too.
Remark 7.2. Note that up to this point, the permutation group ΓL was not very
relevant. In Section 4, the constructed EPPA-witnesses worked for ΓL being the
symmetric group, and in Section 6, it didn’t play an important role either.
However, in this section, ΓL plays a central role, because it restricts, which
irreducible substructures can be sent to A by an automorphism. For example,
let L be the language consisting of n unary relation R1 , . . . , Rn and let A be an
1
L-structure consisting of one vertex which is in RA
and in no other relations.
For this A, Section 4 will produce an EPPA-witness B0 , where B0 = {vS : S ⊆
i
{1, . . . , n}} such that vS ∈ RB
if and only if i ∈ S. Fix now a permutation group
0
ΓL on the language L and consider A as a ΓL -structure. An irreducible structure
faithful EPPA-witness B for A will contain only vertices, which are in precisely one
i
unary relation RB
such that moreover R1 and Ri are in the same orbit of ΓL . In
particular, if ΓL = {idL }, then A is an irreducible structure faithful EPPA-witness
for itself. If ΓL = Sym(L), then a possible irreducible structure faithful EPPAwitness for A has n vertices v1 , . . . , vn such that vi has precisely one unary mark
Ri .
Fix a language L consisting of relation symbols and unary function symbols
equipped with a permutation group ΓL , a finite ΓL -structure A and its EPPAwitness B0 . Without loss of generality, assume that A ⊆ B0 . We now present

22

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

a construction of an irreducible structure faithful EPPA-witness B with a homomorphism-embedding (projection) to B0 , such that every extension of a partial
automorphism in B is induced by the extension of its projection to B0 .
Witness construction. Let I be an irreducible substructure of B0 . We say that
I is bad if there is no automorphism f : B0 → B0 such that f (I) ⊆ A. Given a
vertex x ∈ B0 , we denote by U (x) the set of all bad irreducible substructures of B0
containing x.
For a vertex x ∈ B0 , we say that a function assigning to every I ∈ U (x) a value
from {1, 2, . . . , |I| − 1} is a valuation function for x. Given vertices x, y ∈ B0 and
their valuation functions χ and χ0 respectively, we say that the pairs (x, χ) and
(y, χ0 ) are generic, if either (x, χ) = (y, χ0 ), or x 6= y and for every I ∈ U (x) ∩ U (y)
it holds that χ(I) 6= χ0 (I). We say that a set S is generic if it consists of pairs
(x, χ) where x ∈ B0 and χ is a valuation function for x, such that every pair
(x, χ), (y, χ0 ) ∈ S is generic. In particular, the projection to the first coordinate is
injective on every generic set.
A valuation structure for a vertex x ∈ B0 is a ΓL -structure V such that:
(1) The vertex set of V is a generic set of pairs (y, χ) where y ∈ ClB0 (x) and
χ is a valuation function for y, and
(2) the pair ι = (idL , ιV ), where ιV ((y, χ)) = y, is an isomorphism of V and
ClB0 (x).
For a pair (x, V), where x ∈ B0 and V is a valuation structure for x, we denote by
χ(x, V) the (unique) valuation function for x such that (x, χ(x, V)) ∈ V and we put
π(x, V) = x (π is again the projection from B to B0 ). We say that a set S of pairs
(x,
S V), such that x ∈ B0 and V is a valuation structure for x, is generic, if the set
(x,V)∈S V is generic. Note that this implies that the set {(x, χ(x, V)) : (x, V) ∈ S}
is also generic and thus π is injective on every generic set.
Now we construct a ΓL -structure B:
(1) The vertices of B are all pairs (x, V), where x ∈ B0 and V is a valuation
structure for x.
(2) For every relation symbol R ∈ LR , we put
((x1 , V1 ), . . . , (xa(R) , Va(R) )) ∈ RB ,
if and only if (x1 , . . . , xa(R) ) ∈ RB0 , and {(x1 , V1 ), . . . , (xa(R) , Va(R) )} is
generic.
(3) For every (unary) function symbol F ∈ LF , we put
FB ((x, V)) = {(y, ClV ((y, χ))) : (y, χ) ∈ FV ((x, χ(x, V)))} .
Note that (idL , π) is a homomorphism-embedding from B to B0 . Observe also
that B is finite, because B0 is finite, U (x) is finite for every x ∈ B0 (hence there
are only finitely many candidate vertex sets for valuations structures), and there is
at most one valuation structure on any candidate vertex set.
Next, we define an embedding ψ : A → B. For every bad irreducible I ⊆ B0 , we
fix an arbitrary injective function fI : I ∩ A → {1, 2, . . . , |I| − 1}. Such a function
exists, because A ∩ I is a proper subset of I (otherwise I would not be bad). Given
a vertex x ∈ A, we put ψ(x) = (x, Vx ), where Vx = {(y, χy ) : y ∈ ClA (x), χy (I) =
fI (y)}, and the structure on Vx is chosen such that the pair (idL , (y, χy ) 7→ y) is an
isomorphism Vx → ClA (x).
It is easy to verify that this is indeed an embedding of A to B and that A0 = ψ(A)
is generic.

ALL THOSE EPPA CLASSES

23

Constructing the extension. At some point, we will also need to prove irreducible structure faithfulness. And in that proof, we are going to need to construct
some automorphisms of B based on some automorphisms of B0 and partial automorphisms of B. Because of it, we prove a more general statement.
Lemma 7.3. Let ϕ be a partial automorphism of B satisfying the following conditions:
(1) Both the domain and the range of ϕ are generic, and
(2) there is an automorphism ϕ̂ of B0 which extends the projection of ϕ via π
(by condition 1, the projection is a partial automorphism of B0 ).
Then there is an automorphism θ of B extending ϕ.
Note that if ϕ is a partial automorphism of A0 , then it satisfies both conditions
and therefore it can be extended to an automorphism of B.
Proof of Lemma 7.3. Put
D = {(x, χ(x, V)) : (x, V) ∈ Dom(ϕ)}
and
R = {(x, χ(x, V)) : (x, V) ∈ Range(ϕ)}.
Because both Dom(ϕ) and Range(ϕ) are generic, we get that |D| = |R| = |π(D)| =
|π(R)|, so in particular no x ∈ B0 appears in D or R with more than one valuation
structure. Therefore, ϕ defines a bijection q : D → R.
For a bad irreducible substructure I ⊆ B0 , we can define a partial permutation
τIϕ of {1, . . . , |I| − 1}, such that for every (y, χ) ∈ D with y ∈ I and for q((y, χ)) =
(ϕ̂(y), χ0 ), we put
τIϕ (χ(I)) = χ0 (ϕ̂(I)).
This is indeed a partial permutation of {1, . . . , |I| − 1}, because both D and R are
generic. Let θIϕ be the order-preserving extension of τIϕ .
Put
V=

[

V.

(x,V)∈B

Having θIϕ for every bad I, we can define q̂ : V → V as
q̂((x, χ)) = (ϕ̂(x), χ0 ),
where χ0 (ϕ̂(I)) = θIϕ (χ(I)). Since ϕ̂ is an automorphism of B0 and each θIϕ is a
permutation of {1, . . . , |I| − 1}, it follows that q̂ is a permutation of V. It is easy
to check that q̂ extends q.
Finally, we define θ : B → B by putting
θ((x, V)) = (ϕ̂(x), U),
where U = q̂(V), that is, q̂ is an isomorphism of V and U. By an analogous
argument as in the previous sections, we get that (ϕL , θ) is an automorphism of B
extending ϕ.

Proofs. We again proceed analogously to Section 3.
Lemma 7.4. If B0 is a coherent EPPA-witness for A, then B is a coherent EPPAwitness for A0 .
Proof. Look at the construction in the proof of Lemma 7.3 for ϕ being a partial
automorphism of A0 and ϕ̂ being the coherent extension of the projection of ϕ by π.
We have coherence of θ on the first coordinate, coherence on the second coordinate
follows from coherence of q̂, which is ensured by extending the mappings τIϕ ’s in
the order-preserving way.


24

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Next, we prove Proposition 7.1.
Proof. It only remains to prove irreducible structure faithfulness of B. First note
that from the definition of B it follows that for every vertex (x, V) ∈ B it holds
that ClB ((x, V)) is a generic set (because V is generic, and whenever (y, U) ∈
ClB ((x, V)), then U ⊆ V).
Let D be an irreducible substructure of B. We claim that D is generic. For
a
contradiction,
suppose that it is not the case, that is, there are (u, χ), (u0 , χ0 ) ∈
S
(x,V)∈D V which form a non-generic pair. This implies that there are (x, X),
(y, Y) ∈ D such that (u, χ) ∈ X and (u0 , χ0 ) ∈ Y (they cannot both lie in the same
valuation structure, because the vertex sets of valuation structures are generic),
and hence the set {(x, X), (y, Y)} is non-generic. Put Ex = {(a, U) ∈ D : (x, X) 6∈
ClD ((a, U))} and similarly define Ey . Since closures are unary, these are substructures of D. Note that since closures in B are generic, we also know that (y, Y) ∈ Ex
and (x, X) ∈ Ey . This means that Ex , Ey are both non-empty and neither is a substructure of the other.
We first prove Ex ∪ Ey = D. Suppose for a contradiction that there is (z, Z) ∈ D
with (x, X), (y, Y) ∈ ClD ((z, Z)). Then (by the construction of B) we have X, Y ⊆
Z, which is a contradiction with (x, X), (y, Y) forming a non-generic pair.
Fix (a, U) ∈ Ex \ Ey and (b, W) ∈ Ey \ Ex . Because we know that Y ⊆ U and
X ⊆ W, we get that (a, U), (b, W) is not a generic pair and therefore no relation
of D contains both (a, U) and (b, W). Thus D is a free amalgam of Ex and Ey
over their intersection, which is a contradiction with its irreducibility. Therefore D
is indeed generic.
Now that we know that D is generic, it follows that π(D) is not a bad substructure of B0 . It is, however, irreducible, because π is a homomorphism-embedding,
and thus there is ϕ̂ ∈ Aut(B0 ) such that ϕ̂(π(D)) ⊆ A. Define ϕ : D → A0 by
ϕ((x, V)) = ψ(ϕ̂(x)). This is a partial automorphism of B with generic domain
and range, whose projection extends to ϕ̂, and Lemma 7.3 then gives an automorphism of B sending D to A0 , which is what we wanted.

We are now ready to prove Theorem 1.1.
Proof of Theorem 1.1. Section 6 gives a finite coherent EPPA-witness B0 for A,
Proposition 7.1 ensures irreducible structure faithfulness and preserves coherence.
The “consequently” part is immediate.

Remark 7.5. Note that Theorem 1.1 can be used to prove EPPA for classes where
the relations are, for example, symmetric (because a non-symmetric relation is
witnessed on a tuple which is irreducible), and similarly it implies EPPA for classes
with unary functions whose range has a given size (for example, size 1, which means
that we can prove EPPA for the standard model-theoretic unary functions).
Observation 7.6. The number of vertices of the EPPA-witness B constructed in
this section can be bounded from above by a function which depends only on the
number of vertices of B0 and the number of vertices of A.
Proof. Put m = |B0 | and n = |A|. There are at most 2m bad substructures of
m
B0 and hence at most (m − 1)2 valuation functions for a given x ∈ B0 (this is a
very rough estimate). Let P be the set of all pairs (x, χ), where x ∈ B0 and χ is a
m
valuation function for x. We get that |P | ≤ m(m − 1)2 .
The vertices of B are pairs (x, V), where x ∈ B0 and V is a valuation structure
for x. The vertex set of every valuation structure is a subset of P (and hence there
are at most 2|P | of them) and the structure on V is determined by an embedding
(idL , ιV ) : V → B0 . There are at most m|V | ≤ mm such embeddings. This finishes
the proof.


ALL THOSE EPPA CLASSES

25

8. Unwinding induced cycles
In this section we give a key ingredient for proving Theorem 1.2:
Lemma 8.1. Let L be a language consisting of relations and unary functions
equipped with a permutation group ΓL . Let A be a finite irreducible ΓL -structure
and let B0 be its (finite) irreducible structure faithful EPPA-witness. Assume that
L contains a binary relation E which is fixed by every permutation in ΓL and assume that EA is a complete graph. (Note that by irreducible structure faithfulness,
EB0 is an undirected graph without loops.)
There is a finite ΓL -structure B which is an irreducible structure faithful EPPAwitness for A satisfying the following:
(1) There is a homomorphism-embedding f : B → B0 .
(2) Let C be a subset of B. Then at least one of the following holds:
(a) EB ∩ C 2 contains no (induced) cycle of length ≥ 4,
(b) |f (C)| < |C|, or
(c) |EB0 ∩ f (C)2 | > |EB ∩ C 2 |.
Moreover, if B0 is a coherent EPPA-witness for A, then B is also coherent.
Note that since f is a homomorphism-embedding, we get that if |f (C)| = |C|,
then |EB0 ∩ f (C)2 | ≥ |EB ∩ C 2 | and f induces an injective mapping from EB ∩ C 2
to EB0 ∩ f (C)2 .
In the rest of the section, we will prove Lemma 8.1. The construction is inspired
by a similar construction for EPPA for metric spaces by the authors [HKN19].
For the rest of the section, fix L, ΓL , A and B0 as in the statement of Lemma 8.1.
Assume without loss of generality that A ⊆ B0 .
Valuations. A sequence (c1 , . . . , ck ) of distinct vertices of B0 is a bad cycle sequence if k ≥ 4 and the structure induced by EB0 on {c1 , . . . , ck } is a graph cycle
containing precisely the edges connecting ci and ci+1 for every 1 ≤ i ≤ k (where
we identify ck+1 = c1 ).
Given a vertex x ∈ B0 , we denote by U (x) the set of all bad cycle sequences
containing x.
We will call functions U (x) → {0, 1} valuation functions for x. Given vertices
x, y ∈ B0 and their valuation functions χ and χ0 , we say that the pairs (x, χ) and
(y, χ0 ) are generic, if either (x, χ) = (y, χ0 ), or x 6= y and for every bad cycle
sequence ~c = (c1 , . . . , ck ) ∈ U (x) ∩ U (y), one of the following holds:
(1) There is 1 ≤ i < k such that {ci , ci+1 } = {x, y} and χ(~c) = χ0 (~c), or
(2) {c1 , ck } = {x, y} and χ(~c) 6= χ0 (~c).
A set S of pairs (x, χ) is generic if every pair (x, χ), (y, χ0 ) ∈ S is generic.
Let x ∈ B0 be a vertex of B0 . A valuation structure for x is a ΓL -structure V
such that:
(1) The vertex set V is a generic set of pairs (y, χ) where y ∈ ClB0 (x) and χ is
a valuation function for y.
(2) Define ι((y, χ)) = y, Then (idL , ι) is an isomorphism of V and ClB0 (x).
Let V be a valuation structure for x. We denote by χ(x, V) the valuation function
for x such that (x, χ(x, V)) ∈ V and we put π(x, V) = x.
ASset S of pairs (x, V), where V is a valuation structure for x, is generic, if the
set (x,V)∈S V is generic.
Witness construction. Now, we construct a ΓL -structure B:
(1) The vertices of B are all pairs (x, V), where x ∈ B0 and V is a valuation
structure for x.

26

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

(2) For every relation symbol R ∈ LR , we put
((x1 , V1 ), . . . , (xa(R) , Va(R) )) ∈ RB ,
if and only if (x1 , . . . , xa(R) ) ∈ RB0 , and {(x1 , V1 ), . . . , (xa(R) , Va(R) )} is
generic.
(3) for every (unary) function symbol F ∈ LF and every vertex (x, V) ∈ B, we
put
FB ((x, V)) = {(y, ClV ((y, χ))) : (y, χ) ∈ FV ((x, χ(x, V)))}.
It is easy to verify that B is a finite ΓL -structure and (idL , π) is a homomorphismembedding from B to B0 .
E
Observe that since every pair of distinct vertices x, y ∈ A is in RA
, it follows that every bad cycle sequence contains at most two vertices of A, and if it
contains precisely two, then they are adjacent in EB0 . For every bad cycle sequence ~c = (c1 , . . . , ck ) containing at least one vertex of A, we define a function
χ~c : A ∩ {c1 , . . . , ck } → {0, 1} as follows.
(
1 if x = c1 and ck ∈ A,
χ~c (x) =
0 otherwise.

Next, we give an embedding ψ : A → B. Given a vertex x ∈ A, we put ψ(x) =
(x, Vx ), where Vx = {(y, χy ) : y ∈ ClA (x), χy (~c) = χ~c (y)}, and the structure on
Vx is chosen such that the pair (idL , (y, χy ) 7→ y) is an isomorphism Vx → ClA (x)
(which is a substructure of A).
It is easy to verify that this is indeed an embedding of A to B and that A0 = ψ(A)
is generic.
Constructing the extension. Fix a partial automorphism ϕ of A0 . Via π, it
induces a partial automorphism of B0 , which we extend to an automorphism ϕ̂ of
B0 .
Let F be the set consisting of all bad cycle sequences ~c for which there is a vertex
(x, Vx ) ∈ Dom(ϕ)
such that that χ(x, Vx )(~c) 6= χ(ϕ((x, Vx )))(ϕ̂(~c)).
S
Put V = (x,V)∈B V . Define a function q̂ : V → V, putting
q̂((x, χ)) = (ϕ̂(x), χ0 ),
where χ0 is the valuation function for x satisfying
(
χ(~c)
if ~c ∈
/F
0
χ (ϕ̂(~c)) =
1 − χ(~c) if ~c ∈ F.
Finally, we construct θB : B → B, putting θB ((x, V)) = (ϕ̂(x), U) such that U =
(idL , q̂)(V) (that is, (idL , q̂) is an isomorphism of V and U).
Note that in this construction (exactly as in Section 7), we only used that both
the domain and range of ϕ are generic and that the projection of ϕ extends to an
automorphism ϕ̂ of B0 .
Proofs. It can be verified that θ = (ϕL , θB ) is indeed an automorphism extending
ϕ in the same way as in the proof of Proposition 4.1, using the fact that A0 is generic
and for every ~c, there are at most two different vertices (x, Vx ), (y, Vy ) ∈ Dom(ϕ)
such that x, y ∈ ~c, and if there are exactly two, then
χ(x, Vx )(~c) 6= χ(ϕ((x, Vx )))(ϕ̂(~c))
if and only if
χ(y, Vy )(~c) 6= χ(ϕ((y, Vy )))(ϕ̂(~c)),
because ϕ is a partial automorphism and (x, Vx ), (y, Vy ) are connected by an edge
of ~c.

ALL THOSE EPPA CLASSES

27

Coherence follows analogously, too. To prove irreducible structure faithfulness,
it is enough to show that every clique in the relation EB can be sent to A0 by
an automorphism of B. However, the projection π of every such clique is a clique
in B0 , which is, by the assumption, irreducible structure faithful, therefore we get
an automorphism ϕ̂ sending the projection to A. One can then proceed as in the
previous section.
To finish the proof of Lemma 8.1, we now prove that for every C ⊆ B such that
EB ∩ C 2 is a cycle of length ≥ 4, it holds that π|C is not an embedding. This would
imply that whenever C ⊆ B contains an induced graph cycle of length ≥ 4, one
of (2b) and (2c) holds.
Fix a set C ⊆ B such that EB |C is an induced graph cycle of length ≥ 4 and,
for a contradiction, assume that its projection π(C) is again an induced graph
cycle of the same length in the relation EB0 . This means that we can enumerate
C as (x1 , V1 ), . . . , (xk , Vk ) such that ~c = (x1 , . . . , xk ) is bad cycle sequence. For
every 1 ≤ i ≤ k, we have {(x1 , V1 ), (x2 , V2 )} ∈ EB (identifying (xk+1 , Vk+1 ) =
(x1 , V1 )), so in particular the set {(x1 , V1 ), (x2 , V2 )} is generic. By definition, this
implies that for every 1 ≤ i < k, we have
χ(xi , Vi )(~c) = χ(xi+1 , Vi+1 )(~c),
but
χ(x1 , V1 )(~c) 6= χ(xk , Vk )(~c),
which is a contradiction.
Observation 8.2. The number of vertices of the EPPA-witness B constructed in
this section can be bounded from above by a function which depends only on the
number of vertices of B0 .
Proof. Let m be the number of vertices of B0 . There are at most (m + 1)m (rough
m
estimate) bad cycle sequences and hence at most 2(m+1) valuation functions for
m
any given vertex x ∈ B0 . This means that there are at most m2(m+1) different
pairs (x, χ), where x ∈ B0 and χ is a valuation function for x, and thus at most
(m+1)m
2m2
different generic sets. Given a generic set V and a vertex x ∈ B0 , there
is at most one valuation structure for x with vertex set V . Since the vertex set of
B consists of all pairs (x, V), where x ∈ B0 and V is a valuation structure for x,
the claim then follows.

9. Locally tree-like EPPA-witnesses: Proof of Theorem 1.2
The goal of this section, is to prove Theorem 1.2 using Lemma 8.1.
Definition 9.1. Let L be a language equipped with a permutation group ΓL and
let A be a finite ΓL -structure. We recursively define what a tree amalgamation of
copies of A is.
(1) If D is isomorphic to A then D is a tree amalgamation of copies of A.
(2) If B1 and B2 are tree amalgamations of copies of A, D is a ΓL -structure
and α1 : A → B1 , α2 : A → B2 and δ1 , δ2 : D → A are embeddings then
the free amalgamation of B1 and B2 over D with respect to α1 ◦ δ1 and
α2 ◦ δ2 is also a tree amalgamation of copies of A.
The following proposition gives an alternative way of viewing tree amalgamations.
Proposition 9.2. Let L be a language equipped with a permutation group ΓL , let A
be a finite ΓL -structure and let C be a finite ΓL -structure. The following statements
are equivalent:

28

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

(1) C is a tree amalgamation of copies of A.
(2) There exists a sequence A = C1 , . . . , Cn = C of finite ΓL -structures such
that for every 1 ≤ i < n there is a ΓL -structure D, embeddings δ1 , δ2 : D →
A and an embedding α : A → Di such that Di+1 is a free amalgamation of
A and Di with respect to δ1 and α ◦ δ2 .
Note that if A is irreducible (which will always be the case in this paper), the process in point 2 can be understood as having a graph tree T whose vertices precisely
correspond to copies of A in C and each edge determines, how the neighbouring
copies of A overlap.
Proof of Proposition 9.2. The direction (2)⇒(1) is trivial, as (2) is just a special
case of the recursive definition of tree amalgamation of copies of A.
To obtain the other direction, we will use induction on the recursive construction
of C to prove an even stronger statement, namely that for every copy of A ∈ C, we
can pick C1 to correspond to the given copy. Clearly, this holds if C is isomorphic
to A. Suppose now that C is the free amalgamation of B1 and B2 with respect to
α1 ◦ δ1 and α2 ◦ δ2 as in Definition 9.1 and without loss of generality assume that
the chosen copy of A lies in B1 .
By the induction hypothesis, we get A = C1 , . . . , Cn = B1 such that C1
corresponds to the chosen copy. Also by the induction hypothesis, we get A =
C01 , . . . , C0m = B2 such that C01 corresponds to the copy of A given by α2 . It is
easy to see that if, for 1 ≤ i ≤ m, we put Cn+1 to be the free amalgamation of Cn
and C0i with respect to α1 ◦ δ1 and α2 ◦ δ2 , then C1 , . . . , Cm+n witnesses that C
satisfies point 2.

Note that in both equivalent definitions, we require that we only amalgamate over
copies of D which lie in a copy of A. The reason for it is that when A is irreducible,
it allows us to prove the following two observations about tree amalgamations of
copies of A.
Observation 9.3. Let A be a finite irreducible ΓL -structure, let C be a tree amalgamation of copies of A witnessed by the sequence A = C1 , . . . , Cn = C of ΓL structures and let I ⊆ C be an irreducible structure. Then either I ⊆ C1 , or there
is 1 < i ≤ n such that I 6⊆ Ci−1 and I lies fully in the copy of A which together
with Ci−1 forms Ci .
Proof. This follows from the fact that if U is a free amalgamation of U1 and U2
(without loss of generality we can assume that all the embeddings are inclusions
and U = U1 ∪ U2 ) and V is an irreducible substructure of U, then V ⊆ U1 or
V ⊆ U2 .

Observation 9.4. Let C be a hereditary amalgamation class of finite ΓL -structures
and let A ∈ C be an irreducible structure. Suppose that C is a tree amalgamation
of copies of A. Then there is E ∈ C and a homomorphism-embedding e : C → E.
Proof. We will proceed by induction on the recursive definition of C. If C is
isomorphic to A, ten clearly the statement holds. Otherwise we get B1 , B2 , D, δ1 ,
δ2 , α1 and α2 as in Definition 9.1. By the induction hypothesis, we get E1 , E2 ∈ C
and homomorphism-embeddings e1 : B1 → E1 and e2 : B2 → E2 . Since A is
irreducible, we get that ei ◦ αi is an embedding A → Ei for i ∈ {1, 2}, hence
in particular the structure induced by Ei on ei (αi (δi (D))) is isomorphic to D for
i ∈ {1, 2}. Therefore, we can put E to be the amalgamation of E1 and E2 with
respect to e1 ◦ α1 ◦ δ1 and e2 ◦ α2 ◦ δ2 .

Note that Observation 9.3 in particular implies that the only copies of A in C
are those which we added in some step of the construction of C. Also note that in

ALL THOSE EPPA CLASSES

29

Observation 9.4, the fact that we are only amalgamating over structures which lie
in a copy of A was crucial, because “being irreducible” is not a hereditary property
(for example, if L is a language containing one ternary relation R and X is an
L-structure such that X = {a, b, c} and RX = {(a, b, c)}, then X is irreducible, but
the substructure of X induced on {a, b} is not irreducible).
We will make use of the following lemma which has a graph-theoretic proof:
Lemma 9.5. Let L be a language equipped with a permutation group ΓL , containing
a binary symmetric relation E, and let A be a finite irreducible ΓL -structure such
that EA is a complete graph. Let B be a ΓL -structure satisfying the following:
(1) Every irreducible substructure of B is isomorphic to a substructure of A,
and
(2) B contains no induced graph cycles (of length ≥ 4) in the relation EB .
Then B is a substructure of a tree amalgamation of copies of A.
Proof. We proceed by induction on |B|. If B is irreducible then the statement
follows trivially, hence we can assume that B is reducible.
Note that condition 1 implies that if C is an irreducible substructure of B, then
EC is a clique. And conversely, whenever EB induces a clique on C ⊆ B then
ClB (C) is irreducible: Indeed, suppose for a contradiction that ClB (C) is the free
amalgamation of some U1 and U2 over V such that U1 , U2 6= ClB (C). If C ⊆ U1 ,
then we would get that ClB (C) ⊆ U1 , because U1 is a (closed) substructure of
ClB (C), which is a contradiction, similarly for U2 . Hence there are x1 , x2 ∈ C such
that x1 ∈ U1 \ V and x2 ∈ U2 \ V . But this implies that (x1 , x2 ) ∈
/ EB , which is a
contradiction.
For the following paragraphs, we will mainly consider the graph relation EB and
we will treat subsets of B as (induced) subgraphs of the graph (B, EB ). We will
use the standard terminology of graph theory.
Let C be an inclusion minimal substructure of B such that C forms a vertex cut
of B (i.e. B \ C is not connected in EB ) and let C 0 ⊆ C be an inclusion minimal
vertex cut of B. Such a C exists, because B is reducible. Note that from the
minimality of C it follows that C = ClB (C 0 ).
First observe that from the minimality of C 0 it follows that for every pair of
distinct vertices x, y ∈ C 0 there are be two distinct nonempty connected components
B1 , B2 ⊂ B \ C 0 such that both B1 , B2 contain a vertex adjacent to x as well as a
vertex adjacent to y. Now observe that C 0 is a clique: If there was a pair of vertices
x 6= y ∈ C 0 such that (x, y) ∈
/ EB , we could construct an induced cycle of length
≥ 4 using x and y and vertices of B1 , B2 from the previous paragraph. This implies
that C is irreducible, because it is the closure of a clique.
From the condition on C, we get that B \ C is not connected, that is, can be
split into two non-empty disjoint parts B1 ∪ B2 = B \ C such that there are no
edges between B1 and B2 (and therefore no relations or functions at all thanks to
condition 1). This means that B is the free amalgamation of (its substructures
induced on) B1 ∪ C and B2 ∪ C over C.
Using the induction hypothesis, we get ΓL -structures D1 and D2 which are tree
amalgamations of copies of A such that the substructures induced by B on Bi ∪ C
are substructures of Di for i ∈ {1, 2}. Since C is irreducible, it follows that there
are embeddings α1 : A → D1 , α2 : A → D2 and δ1 , δ2 : C → A and hence we can
put D to be the free amalgamation of B1 and B2 over C with respect to α1 ◦ δ1
and α2 ◦ δ2 . Clearly B ⊆ D and D is a tree amalgamation of copies of A.

Now we are ready to prove Theorem 1.2.

30

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Proof of Theorem 1.2. We intend to use Lemma 8.1 as the main ingredient to this
proof. However, Lemma 8.1 expects that there is a graph edge relation E in the
language and that EA is a complete graph, which is not guaranteed by the assumptions of Theorem 1.2. For this reason, we extend the language L to L+ , adding a
binary symmetric relation E fixed by every permutation of the language (assuming
without loss of generality that E ∈
/ L), put A0 to be the ΓL+ -structure obtained
from A by putting EA0 to be the complete graph on A, and put B00 to be the
ΓL+ -structure obtained from B0 by putting EB00 to be the complete graph on B00 .
Observe that partial automorphisms of A0 are precisely the partial automorphisms of A (barring the new relation E fixed by every permutation of the language) and Aut(B0 ) = Aut(B00 ). Therefore, B00 is an EPPA-witness for A0 and it
is coherent if B0 is. 
Put N = (n − 1) n2 + 1. Use Proposition 7.1 on A0 and B00 to get B01 , an irreducible structure faithful (coherent) EPPA-witness for A0 with a homomorphismembedding f1 : B01 → B00 . Next, by applying Lemma 8.1 iteratively N times, we
construct a sequence of ΓL+ -structures B02 , B03 , . . . , B0N +1 and a sequence of maps
f2 , f3 , . . . , fN +1 , such that for every 1 ≤ i ≤ N + 1 it holds that B0i is an irreducible structure faithful EPPA-witness for A0 , fi is a homomorphism-embedding
B0i → B0i−1 , and if B0i−1 is coherent then so is B0i .
Put B0 = B0N +1 and put B to be the ΓL -reduct of B0 forgetting the relation E.
Since every automorphism of B0 is also an automorphism of B, we get that B is
an EPPA-witness for A, and if B0 was coherent, then so is B. To get that B is
irreducible structure faithful, note that an irreducible substructure of B is also an
irreducible substructure of B0 .
Let CN +1 be a substructure of B on at most n vertices and let C0N +1 be a
substructure of B0 on the same vertices as CN +1 . Denote by C01 , C02 , . . . , C0N the
structures such that for every 1 ≤ i ≤ N it holds that C0i = fi+1 (C0i+1 ).
Since we used Lemma 8.1 N times, let us count how many times one of (2b)
and (2c) from Lemma 8.1 has happened. Clearly, possibility (2b) could have hap0
0
pened at most n − 1 times, because |CN
+1 | ≤ n and |C1 | ≥ 1. And for every fixed
n
0
m = |Ci |, possibility (2c) could have happened at most m
2 ≤ 2 times. Therefore, (2b) or (2c) have together happened at most N − 1 times, which means that
there is 2 ≤ i ≤ N + 1 such that possibility (2a) happened in the i-th step. This
then means that C0i contains no induced cycles of length ≥ 4.
Because B0i is an irreducible structure faithful EPPA-witness for A0 , we get that
every irreducible substructure of B0i is isomorphic to a substructure of A0 , so in
particular, this holds for irreducible substructures of C0i . Hence, we can apply
Lemma 9.5 on C0i to obtain a tree amalgamation of copies of A0 , which we call
D’, and a homomorphism-embedding f : C0N +1 → D0 (obtained by composing the
output of Lemma 9.5 with some of the fi ’s).
Let D be the ΓL -reduct obtained from D0 by forgetting the relation E. It is easy
to check that f is a homomorphism-embedding CN +1 → D and that D is a tree
amalgamation of copies of A, which concludes the proof.

Observation 9.6. The number of vertices of the EPPA-witness B provided by
Theorem 1.2 can be bounded from above by a function which depends only on the
number of vertices of B0 and on n.

Proof. B was obtained from B0 by iteratively applying Lemma 8.1 N = (n−1) n2 +
1 times. We know that in each step, the number of vertices of the constructed
structure could be bounded by a function of the number of vertices of the original
structure. The claim then follows.


ALL THOSE EPPA CLASSES

31

10. A generalisation of the Herwig–Lascar theorem: Proof of
Theorem 1.5
Next, we show how Theorem 1.2 implies Theorem 1.5. Note that unlike Theorem 1.5, Theorem 1.2 assumes that A is irreducible, because otherwise one can not
define what tree amalgamation is. In order to deal with it, we extend the language
L to L+ , adding a binary symmetric relation E fixed by every permutation of the
language (assuming without loss of generality that E ∈
/ L), and consider the class
consisting of finite ΓL+ -structures A where EA is a complete graph. Moreover, for
such A, we will denote by A− its ΓL -reduct forgetting the relation E.
We will need the following technical lemma.
Lemma 10.1. Let L be a language consisting of relations and unary functions
equipped with a permutation group ΓL , let F be a finite family of finite ΓL -structures
and fix a ΓL+ -structure A such that EA is a complete graph and A− ∈ Forbhe (F).
Assume that there is M ∈ Forbhe (F) containing A− as a substructure such that
every partial automorphism of A− extends to an automorphism of M. Then, for
every tree amalgamation D of copies of A, there is a homomorphism-embedding
h : D− → M. Moreover, for every embedding α : A → D there is an automorphism
f of M such that f (h(α(A))) = A.
Proof. We proceed by induction on the tree construction of D (cf. Definition 9.1).
The claim clearly holds if D is isomorphic to A. Suppose now that B1 and B2 are
tree amalgamations of copies of A and E is a substructure of A with embeddings
δ1 , δ2 : E → A, α1 : A → B1 and α2 : A → B2 such that D is the free amalgamation
of B1 and B2 over E with respect to α1 ◦ δ1 and α2 ◦ δ2 .
By the induction hypothesis, we have homomorphism-embeddings h1 : B−
1 →M
and h2 : B−
2 → M and automorphisms f1 , f2 of M such that fi (hi (αi (A))) = A for
i ∈ {1, 2}. Let ϕ be a partial automorphism of A− sending f1 (h1 (α1 (δ1 (E− )))) 7→
f2 (h2 (α2 (δ2 (E− )))) and let ϕ̂ be its extension to a partial automorphism of M. It
is easy to check that the function h : D → M defined by
(
ϕ̂(f1 (h1 (x))) if x ∈ B1
h(x) =
f2 (h2 (x))
otherwise
is a homomorphism embedding D− → M. The moreover part follows straightforwardly, since A is irreducible and therefore every copy of A in D is either in B1 or
in B2 .

Now we are ready to prove Theorem 1.5.
Proof of Theorem 1.5. Let A+ be the ΓL+ -expansion of A adding a clique in the
relation E. Clearly, A+ is in a finite orbit of the action of ΓL+ by relabelling, hence
we can use Theorem 1.1 to get a ΓL+ -structure B0 which is an irreducible structure
faithful coherent EPPA-witness for A+ . Let n be the number of vertices of the
largest structure in F and let B be as given by Theorem 1.2. We will show that
B− satisfies the statement. Clearly, it is a coherent EPPA-witness for A. Since
every irreducible substructure of B− is all the more so an irreducible substructure
of B, we get that B− is irreducible structure faithful. To finish the proof, it remains
to show that B− ∈ Forbhe (F).
For a contradiction, suppose that there is F ∈ F with a homomorphism-embedding g : F → B− . We have that |g(F )| ≤ |F | ≤ n. Let C be the substructure of B
induced on g(F ). From Theorem 1.2, we get a tree amalgamation D of copies of A+
and a homomorphism-embedding f : C → D. Composing f ◦ g, we get that F has a

32

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

homomorphism-embedding to D− . However, Lemma 10.1 gives a homomorphismembedding D− → M, hence we get a homomorphism-embedding F → M, which is
a contradiction with M ∈ Forbhe (F).

11. Connections to the structural Ramsey theory: Proof of
Theorem 1.6
Most of the applications of the Herwig–Lascar theorem proceed similarly to
applications of a theorem developed independently in the context of the structural
Ramsey theory [HN19]. Both EPPA and the Ramsey property imply amalgamation
(cf. Observation 2.4 and [Neš05]), however, the amalgamation property is not
enough to imply either of them. This motivates the following strengthening of
(strong) amalgamation introduced in [HN19]:
Definition 11.1. Let C be a structure. An irreducible structure C0 is a completion
of C if there is a homomorphism-embedding C → C0 . It is a strong completion if the
homomorphism-embedding is injective. A completion is automorphism-preserving
if it is strong and for every α ∈ Aut(C) there is α0 ∈ Aut(C0 ) such that α ⊆ α0 and
moreover the map α 7→ α0 is a group homomorphism Aut(C) → Aut(C0 ).
To see that completion is a strengthening of amalgamation, let K be a class
of irreducible structures. The amalgamation property for K can be equivalently
formulated as follows: For A, B1 , B2 ∈ K embeddings α1 : A → B1 and α2 : A →
B2 , there is C ∈ K which is a completion of the free amalgamation of B1 and B2
over A with respect to α1 and α2 (which itself is not in K). In the same way,
strong completion strengthens strong amalgamation and automorphism-preserving
completion strengthens the so-called amalgamation property with automorphisms.
Definition 11.2. Let L be a language equipped with a permutation group ΓL .
Let E be a class of finite ΓL -structures and let K be a subclass of E consisting of
irreducible structures. We say that K is a locally finite subclass of E, if for every
A ∈ K and every B0 ∈ E, there is a finite integer n = n(A, B0 ), such that every
ΓL -structure B has a completion B0 ∈ K, provided that it satisfies the following:
(1) Every irreducible substructure of B has an embedding to A,
(2) there is a homomorphism-embedding from B to B0 , and
(3) every substructure of B on at most n vertices has a completion in K.
We say that K is a locally finite automorphism-preserving subclass of E if B0 can
always be chosen to be automorphism-preserving.
Note that if K is hereditary, point 1 implies that every irreducible substructure
of B is in K. Note also that in Definition 11.2, we are only promised that every
substructure on at most n vertices has a completion in K, even though we are asking
for an automorphism-preserving (hence, in particular, strong) completion.
Luckily, for languages where all functions are unary, one can prove that if a
structure has a completion in a strong amalgamation class, then it has in fact a
strong completion, which makes verifying local finiteness much easier. This was
first proved in [HN19] as Proposition 2.6, we include a proof for completeness.
Proposition 11.3. Let L be a language equipped with a permutation group ΓL such
that all function symbols of L are unary, and let K be a hereditary class of finite
irreducible ΓL -structures with the strong amalgamation property. For every finite
ΓL -structure A, it holds that it has a completion in K if and only if it has a strong
completion in K.
Proof. Assume, to the contrary, that there is a ΓL -structure A with no strong
completion in K, a ΓL -structure B ∈ K and a homomorphism-embedding f : A → B

ALL THOSE EPPA CLASSES

l

r

L1

A

33

B

R1
f

L2

R2

C
Figure 3. An example of a decomposition of a structure A containing one unary function constructed in the proof of Proposition 11.3.
(that is, B is a completion of A). Among all such examples, choose one such that
there is no ΓL -structure A0 with homomorphism-embeddings A → A0 → B such
that |A0 | ≤ |A|, A0 6= B and A0 is not isomorphic to A.
We decompose the vertex set of A into five parts denoted by L1 , L2 , R1 , R2 ,
and C as depicted in Figure 3 by the following procedure.
Because f is not a strong completion in K, we know that there is a pair of
vertices l 6= r ∈ A such that f (l) = f (r). Now observe that, by the non-existence
of A0 , for every other pair of vertices v1 6= v2 ∈ A satisfying f (v1 ) = f (v2 ) it holds
that one vertex is in ClA (l) and the other is in ClA (r): Indeed, otherwise we could
first identify only vertices from ClA (l) with vertices from ClA (r), yielding such a
structure A0 .
Because vertex closures are irreducible substructures, we know that f identifies
two irreducible substructures U = ClA (l) and V = ClA (r) of A to one and is
injective otherwise.
Put L1 = U \ V and R1 = V \ U . Observe that because l and r can be chosen
arbitrarily, if a substructure of A contains a vertex of L1 , then it contains all
vertices of L1 . By symmetry, the same holds for R1 . Denote by L2 the set of all
vertices v ∈ A \ L1 such that L1 ⊆ ClA (v). Analogously denote by R2 the set of
all vertices v ∈ A \ R1 such that R1 ⊆ ClA (v). L2 and R2 are disjoint, because
f is an embedding on irreducible substructures, and thus no vertex closure (which
is an irreducible substructure) can contain both L1 and R1 (as f (L1 ) = f (R1 )).
By a similar irreducibility argument, we get that there is no tuple t̄ ∈ RA , R ∈ L,
containing both a vertex from L1 ∪ L2 and a vertex from R1 ∪ R2 .
Let C be the set of all vertices whose vertex closure does not contain L1 nor R1 ,
that is, C = A \ (L1 ∪ L2 ∪ R1 ∪ R2 ). Because all functions are unary, A induces
a substructure C on C. Similarly, denote by Al the substructure induced by A on
C ∪ L1 ∪ L2 , and by Ar the substructure induced by A on C ∪ R1 ∪ R2 .
Because K is hereditary and f is injective on A \ (L1 ∪ R1 ), we know that B ∈ K
is a strong completion of all of Al , Ar and C. Applying the strong amalgamation
property of K, there is D ∈ K which is a strong amalgamation of f (Al ) and f (Ar )
over f (C), hence a strong completion of A, which is a contradiction.

Note that in [HN19], it is also observed that the unarity assumption of Proposition 11.3 cannot be omitted. We now prove Theorem 1.6.
Proof of Theorem 1.6. Given A ∈ K, use the fact that E has (coherent) EPPA to
obtain a (coherent) EPPA-witness B0 ∈ E. Let n = n(A, B0 ) be as in the definition

34

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

of a locally finite subclass and let B1 and a homomorphism-embedding f : B1 → B0
be given by Theorem 1.2 for A, B0 and n.
Because B1 is irreducible structure faithful, it follows that every irreducible
structure of B1 can be sent by an automorphism to A. We also get that every
substructure D ⊆ B1 on at most n vertices has a homomorphism-embedding to a
tree amalgamation of copies of A. Using Observation 9.4, we obtain E ∈ K and
a homomorphism-embedding D → E, by composing these two homomorphismembedding, we get that every substructure of B1 on at most n vertices has a (not
necessarily strong) completion in K.
Now we can use the fact that K is a locally finite automorphism-preserving
subclass of E for A and B and get an EPPA-witness for A in K. Finally, if B
was coherent, then this completion is coherent, too, thanks to the moreover part of
Definition 11.1.

12. Applications
In this section we present three applications of our general results.
12.1. Free amalgamation classes. We characterize free amalgamation classes of
finite ΓL -structures with relations and unary functions which have EPPA. We start
with an easy observation [HO03, EHN17, Sin17].
Observation 12.1. Let K be a free amalgamation class, let A ∈ K be a finite
structure and let B be an irreducible structure faithful EPPA-witness for A. Then
B ∈ K.
Proof. Assume for a contradiction that B ∈
/ K. Let B0 be an inclusion minimal
substructure of B such that B0 ∈
/ K. Because K is a free amalgamation class it
follows that B0 is irreducible. However, this is a contradiction with the existence
of an automorphism ϕ of B such that ϕ(B0 ) ⊆ A.

Now we can prove Corollary 1.4.
Proof. If there is A ∈ K which lies in an infinite orbit of the action of ΓL by
relabelling, then by Theorem 1.3 there is no finite EPPA-witness for A, hence K
does not have EPPA.
If A ∈ K lies in a finite orbit of the action of ΓL by relabelling, then by Theorem 1.1 there is a finite irreducible structure faithful coherent EPPA-witness B for
A. By Observation 12.1, B lies in K and we are done.

12.2. Metric spaces without large cliques. We continue with an example of an
application of Theorem 1.6, which was first proved by Conant [Con19, Theorem 3.9]
(see also [ABWH+ 17c]).
Proposition 12.2. Let Kn denote the metric space on n vertices where all distances are 1. The class Mn of all finite integer-valued metric spaces which do not
contain a copy of Kn has coherent EPPA for every n ≥ 2.
Proof. We will understand integer-valued metric spaces as relational structures in
the language L = {R1 , R2 , . . .} (with trivial ΓL ), where (x, y) ∈ Ra if and only if
d(x, y) = a. We do not explicitly represent d(x, x) = 0. Let En be the class of all
i
L-structures A such that RA
is symmetric and irreflexive for every Ri ∈ L, for
i
every pair of vertices x, y ∈ A it holds that {x, y} is in at most one of RA
and
Kn 6⊆ A.
Clearly, En is a free amalgamation class, and since ΓL is trivial, we get that every
orbit of the action of ΓL by relabelling has size 1. Therefore, by Corollary 1.4, En has
irreducible structure faithful coherent EPPA. Mn is a hereditary subclass of En and

ALL THOSE EPPA CLASSES

35

consists of irreducible substructures. We need to verify that Mn is a locally finite
automorphism-preserving subclass of En and that it has the strong amalgamation
property in order to use Theorem 1.6 and thus finish the proof.
Note that if we have B0 ∈ En and a finite ΓL -structure B with a homomorphismembedding f : B → B0 , the following holds for B:
(1) Kn 6⊆ B,
i
(2) the relation RB
is symmetric and irreflexive for every i ≥ 1,
i
(3) every pair of vertices x, y ∈ B is in at most one RB
relation, and
(4) there is a finite set S ⊂ {1, 2, . . .} such that for every i ∈ {1, 2, . . .} \ S we
i
have RB
= ∅ (i.e. B uses only distances from S).
Note also that whenever we have a structure B satisfying conditions 1–4, we can
view it as an S-edge-labelled graph, that is, a triple (B, E, d) such that {x, y} ∈ E if
i
and only if there is i ∈ S such that {x, y} ∈ RB
and d : E → S is such that d(x, y) =
i
i if and only if {x, y} ∈ RB
(note that we write d(x, y) instead of d({x, y})). It
makes sense to define S-edge-labelled graphs even for infinite S, a metric space is
then an R+ -edge-labelled complete graph which contains no triangles with distances
a, b, c such that a > b + c.
Let C = (C, E, d) be an N+ -edge-labelled cycle (that is, (C, E) is a graph cycle)
and enumerate the vertices as C = {c1 , . . . , cn } such that ci and ci+1 are adjacent
for every 1 ≤ i ≤ n (we identify cn+1 with c1 ) and d(c1 , cn ) is maximal. We say
that C is a non-metric cycle if
d(c1 , cn ) >

n−1
X

d(ci , ci+1 ).

i=1

The following claim is standard and was used many times (e.g. [Sol05, Neš07,
Con19, HN19]).
Claim. Let S ⊂ N+ be a finite set of distances and let B = (B, E, d) be a finite Sedge-labelled graph. There is a metric space M on the same vertex set B such that
the identity is a homomorphism-embedding B → M if and only if there is no nonmetric cycle C with a homomorphism-embedding C → B. Moreover, Aut(M) =
Aut(B), and if Kn 6⊆ B, then Kn 6⊆ M.
In other words, we have a characterization of edge-labelled graphs with a completion to a metric space. Let’s first see how this claim implies both strong amalgamation and local finiteness. For strong amalgamation, it is enough to observe that
free amalgamations of metric spaces contain no non-metric cycles (indeed, if there
was one, then one could find one in B1 or B2 , which would be a contradiction).
For local finiteness observe that there are only finitely many non-metric cycles with
distances from a finite set S, hence there is an upper bound n on the number of
their vertices (which only depends on S) and we are done.
To conclude, we give a sketch of proof of the claim. Put m = max(2, max S) and
define function d0 : B 2 → N as
d0 (x, y) = min(m,

min

P a path x → y in B

kPk),

where by kPk we mean the sum of distances of P. It is easy to check that (B, d0 )
is a metric space, that it preserves automorphisms and that d0 |E = d if and only if
B contains no (homomorphism-embedding of a) non-metric cycle. We remark that
(B, d0 ) is called the shortest path completion of B in [HN19].

Remark 12.3. The fact that we used En as the base class in the proof of Proposition 12.2 was a matter of choice. We could also, for example, start with the class
of all L-structures; the condition that every small enough substructure of B has a

36

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

i
completion in Mn would also ensure that RB
are symmetric and irreflexive, that
every pair of vertices is in at most one relation and that B does not contain Kn .

12.3. Structures with constants. We show how languages equipped with a permutation group can help us reduce EPPA for languages with constants (nulary
functions) to languages without constants. Since the goal of this section is to illustrate applications of our main theorems, we will only construct EPPA-witnesses
for structures where the constants behave in a special way.
To simplify the notation, if A is a ΓL -structure and c is a constant symbol of
ΓL , we will write cA instead of cA (). Moreover, if the image if cA is a singleton x
(recall that in general, functions go to the powerset of A), we will write cA = x
instead of cA = {x}.
We first give a definition.
Definition 12.4. Let L be a language equipped with a permutation group ΓL and
let A be a ΓL -structure. We define the constant trace of A, denoted by tr(A), as
tr(A) = ClA (∅).
In particular, tr(A) is a (possibly empty) ΓL -structure.
For example, if ΓL contains no constants, then the constant traces of all ΓL structures are empty. If ΓL contains, say, two constants a and b and a binary
relation E and A is a ΓL structure such that aA and bA are singletons, aA 6= bA ,
and moreover (aA , bA ) ∈ EA , then tr(A) is the two-vertex ΓL -structure with the
corresponding relation E.
If ΓL contains one constant symbol c and one unary function symbol F and A
is a ΓL -structure containing a vertex x such that cA is a singleton, cA 6= x and
x ∈ FA (cA ), then tr(A) also contains x.
Theorem 12.5. Let L be a language equipped with a permutation group ΓL where
the arity of every function is at most 1 and let A be a finite ΓL -structure. Let L0F
be the set of all constant symbols of L. Assume the following:
(1) For every g ∈ ΓL and every c ∈ L0F it holds that g(c) = c.
(2) L0F is finite.
(3) For every c ∈ L0F it holds that cA is a singleton.
(4) For every c 6= c0 ∈ L0F it holds that cA 6= c0A .
(5) For every c ∈ L0F and for every unary function F ∈ L it holds that
FA (cA ) = ∅.
(6) A lies in a finite orbit of the action of ΓL by relabelling.
Then there is a finite ΓL -structure B which is an irreducible structure faithful coherent EPPA-witness for A.
We again remark that our goal here was to keep the proof as simple as possible,
a similar theorem can be proved with much weaker assumptions. In fact, one can
obtain a category theory-like theorem which then makes it possible to lift the main
theorems of this paper to work for languages with constants. These results will
appear elsewhere.
The structure of the proof will be similar to that of Proposition 5.1. That is, we
will define a new language without constants and we will reduce the question to
the question of EPPA in that language.
Proof of Theorem 12.5. Without loss of generality we will assume that L does not
contain the symbol ?. Given a function f : {1, . . . , n} → L0F ∪ {?}, we put |f | =
|{i ∈ n : f (i) = ?}|. Observe that from assumptions 3 and 5 it follows that the
vertex set of tr(A) is precisely {cA : c ∈ L0F }.

ALL THOSE EPPA CLASSES

37

Now, we define a language M without constant symbols. Let R ∈ L be an n-ary
relation symbol. For every function f : {1, . . . , n} → L0F ∪ {?} such that |f | > 0, we
put an |f |-ary relation symbol RR,f in M . Let F ∈ L be a unary function symbol.
For every c ∈ S, we put a unary relation symbol RF,c in M . We also put all unary
function symbols of L into M .
Given g ∈ ΓL , we define πg : M → M as


if T is a unary function symbol,
g(T )
g(F
),c
πg (T ) = R
if T = RF,c , where F ∈ L is a unary function symbol,

 g(R),f
R
if T = RR,f , where R ∈ L is a relation symbol.
We put ΓM = {πg : g ∈ ΓL }. Observe that ΓM is a permutation group on M
(πgh = πg πh ). We claim that g 7→ πg is a group isomorphism: Clearly it is a
surjective homomorphism, injectivity follows from the fact that M contains all
unary function symbols of L, for every relation symbol R ∈ L we have RR,? ∈ M
(where by ? we mean the constant ? function), and every g ∈ ΓL fixes L0F pointwise.
Given an m-tuple (x1 , . . . , xm ) = x̄ ∈ Am and a function f : {1, . . . , n} → L0F ∪
{?} such that |f | = m, we define x̄f to be the n-tuple (y1 , . . . , yn ), where
(
f (i)A if f (i) ∈ L0F ,
yi =
xj
if f (i) = ? and |{k < i : f (k) = ?}| = j − 1.
Put D = A \ tr(A) (that is, the members of D are precisely the non-constant
vertices of A). We claim that for every n-tuple (y1 , . . . , yn ) = ȳ ∈ An , there is
precisely one triple (m, x̄, f ), where m ∈ N, x̄ ∈ Dm and f is a function {1, . . . , n} →
L0F ∪ {?} with |f | = m, such that ȳ = x̄f . Indeed, put
(
c if yi = cA for some c ∈ L0F ,
f (i) =
? otherwise,
m = |f | and xi = yj , where j is chosen such that f (j) = ? and |{k < j : f (k) =
?}| = i − 1.
Let C be a ΓM -structure such that C is disjoint from K = tr(A). We define a
ΓL -structure T (C) as follows:
(1) The vertex set of T (C) is C ∪ K.
(2) The identity on K is an isomorphism between tr(A) and the structure
induced by T (C) on K (i.e., the constants and relations are defined on K
in T (C) in the same way as in A).
(3) For every unary function F ∈ L and every x ∈ C, we put
F,c
FT (C) (x) = FC (x) ∪ {cT (C) : c ∈ L0F and x ∈ RC
}.
R,f
(4) For every relation RR,f ∈ M and every x̄ ∈ RC
, we put x̄f ∈ RT (C) .
Note that (πg , α) is an embedding of ΓM -structures E → F, if and only if (g, α ∪
idK ) is an embedding T (E) → T (F). This follows directly from the construction.
It also implies that E lies in a finite orbit of the action of ΓM by relabelling if and
only if T (E) lies in a finite orbit of the action of ΓL by relabelling.

Next, we define a ΓM -structure D such that T (D) = A. We put the vertex set
of D to be D, the relations and functions are defined as follows:
(1) For every unary function F ∈ L and every vertex x ∈ D, we put FD (x) =
FA (x) \ tr(A).
(2) For every unary function F ∈ L, every vertex x ∈ D and every constant
F,c
c ∈ L0F , we put x ∈ RD
if and only if cA ∈ FA (x).

38

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

(3) For every n-ary relation R ∈ L and every ȳ ∈ RA such that ȳ = x̄f , where
R,f
x̄ ∈ Dm , f : {1, . . . , n} → L0F ∪ {?} and m ≥ 1, we put x̄ ∈ RD
.
It is straightforward to verify that indeed T (D) = A.
Since ΓM is a language where all functions are unary, by Theorem 1.1 we get
an irreducible structure faithful coherent EPPA-witness C for D. Without loss of
generality we can assume that C is disjoint from K. We claim that B = T (C) is
an irreducible structure faithful coherent EPPA-witness for A.
Let (g, α) be a partial automorphism of A. This implies that (πg , αD ) is a
partial automorphism of D, which by the assumption extends to an automorphism
(πg , θ) of C. This implies that (g, θ ∪ idK ) is an automorphism of B extending
(g, α). Since the extensions in C can be chosen to be coherent, by the construction
we get coherence also for B.
To get irreducible structure faithfulness of B, observe that if P ⊆ C is the free
amalgamation of P1 and P2 over Q, then T (P) is the free amalgamation of T (P1 )
and T (P2 ) over T (Q). This follows from the fact that functions in a ΓM -structure
X are subsets of the corresponding functions in T (X) and if, for n ≥ 2, an n-tuple
is in a relation in X, then is is a sub-tuple of a tuple in a relation of T (X).
Taking the contrapositive, this means that if I is an irreducible substructure
of B, then C induces an irreducible substructure on I \ K. Hence, there is an
automorphism (πg , α) : C → C sending I \ K to A and thus (g, α ∪ idK ) is an
automorphism of B such that (g, α ∪ idK )(I) ⊆ A.

12.4. EPPA for k-orientations with d-closures. Our motivation for introducing languages equipped with a permutation group was that it gives a nice formalism to stack several EPPA constructions on top of each other, thereby allowing to
prove coherent EPPA for certain classes with non-unary functions. We conclude
this paper with an example of this. Namely, we prove EPPA for the class of all
k-orientations with d-closures, thereby confirming a conjecture from [EHN19].
Here we only define the relevant classes and prove EPPA for them. To get more
context (for example the connection with Hrushovski predimension constructions
and the importance for the structural Ramsey theory), see [EHN19].
Let G be an oriented graph. We say that it is a k-orientation if the out-degree
of every vertex is at most k. We say that a vertex x ∈ G is a root if its out-degree
is strictly smaller than k. Let Dk be the class of all finite k-orientations. While Dk
is not an amalgamation class, there are two natural expansions which do have the
free amalgamation property.
Definition 12.6. Let L be the digraph language with a single binary relation E
and let Ls be its expansion by a unary function symbol F .
Let G be a k-orientation. By s(G) we denote the Ls -expansion of G putting
F (x) = {y ∈ G : y is reachable from x}.
Put

Dsk

= {s(G) : G ∈ Dk }.

Recall that by ClA (x) we denote the smallest substructure of A containing x
and call it the closure of x in A. For G ∈ Dsk and y ∈ G, we denote by roots(y)
the set of all roots of G which are in ClG (y).
Definition 12.7. Let Ld be an expansion of Ls adding an n-ary function symbol
Fn for every n ≥ 1.
Given G ∈ Dsk , we denote by d(G) the Ld -expansion of G putting Fn (x1 , . . . , xn )
= ∅ if x1 , . . . , xn is not a tuple of distinct roots and
Fn (x1 , . . . , xn ) = {y ∈ G : roots(y) = {x1 , . . . , xn }}
if x1 , . . . , xn is a tuple of distinct roots. Put Ddk = {d(G) : G ∈ Dsk }.

ALL THOSE EPPA CLASSES

39

It is easy to see that Dsk is a free amalgamation class. Combining with Corollary 1.4 we then get the following theorem proved by Evans, Hubička and Nešetřil
[EHN19, EHN17].
Theorem 12.8. Dsk has irreducible structure faithful coherent EPPA for every
k ≥ 1.
It is again straightforward to verify (and it was done in [EHN19]) that Ddk is a
free amalgamation class. Since it contains non-unary functions, the results of this
paper cannot be applied directly to prove that Ddk has irreducible structure faithful
coherent EPPA. However, we can use the fact that all the non-unary functions go
from root vertices to non-root vertices and still show the following theorem, which
was conjectured to hold in [EHN19, Conjecture 7.5].
Theorem 12.9. Ddk has irreducible structure faithful coherent EPPA for every
k ≥ 1.
The proof of this theorem is based on an observation that for sets consisting of
root vertices only, subsets closed with respect to Ld are precisely those closed with
respect to Ls , and thus all the closures are unary, even in the presence of higherarity functions. We will remove non-root vertices from the structures and represent
them by additional relations (on which we define a permutation group using the
main results of this paper), then we will use the main results of this paper once
more and finally, we will reconstruct non-root vertices from the relations to obtain
EPPA-witnesses in Ddk .
Proof of Theorem 12.9. Fix A ∈ Ddk and denote by A0 its Ls -reduct (thus A0 ∈
Dsk ). Let B0 ∈ Dsk be an irreducible structure faithful coherent EPPA-witness for
A0 given by Theorem 12.8.
Let P be the set of all pairs (x, (x1 , . . . , xn )) such that x is a non-root vertex
of B0 , (x1 , . . . , xn ) is a tuple of distinct root vertices of B0 and rootsB0 (x) =
{x1 , . . . , xn }. Note that we have such a pair for each possible permutation of
{x1 , . . . , xn }. Define π((x, (x1 , . . . , xn ))) = x to be the projection and put |(x, (x1 ,
. . . , xn ))| = n.
Denote by L+ the expansion of Ls adding a |P |-ary relation symbol RP for every
P ∈ P. Let ΓL+ be the permutation group on L+ consisting of all permutations
of the RP symbols induced by the natural action of Aut(B0 ) on P. E and F are
fixed by ΓL+ .
Denote by A1 the ΓL+ -structure created from A0 by removing all non-root vertices, keeping the edges between root vertices, putting FA0 (v) = FA (v) ∩ A0 and
(x,(x ,...,xn ))
adding (x1 , . . . , xn ) ∈ RA1 1
if and only if x is a non-root vertex of A0 and
rootsA0 (x) = {x1 , . . . , xn }. Let B1 be an irreducible structure faithful coherent
EPPA-witness for A1 given by Theorem 1.1.
We will now reconstruct an Ld -structure B ∈ Ddk from B1 such that B will be
an irreducible structure faithful coherent EPPA-witness for A. The construction
is quite technical, but the general idea is to simply put back the non-root vertices
according to the R(x,(x1 ,...,xn )) relations using B0 as a template.
Let T0 be the set consisting of all pairs (P, x̄) such that P ∈ P, x̄ is a tuple of
P
vertices of B1 and x̄ ∈ RB
. We say that (P, x̄) ∼ (P 0 , x̄0 ) if π(P ) = π(P 0 ) and
1
0
x̄ and x̄ are different permutations of the same set. Let T consist of exactly one
(arbitrary) member of each equivalence class of ∼ on T0 .
Let B = B1 ∪ T be the vertex set of our newly constructed EPPA-witness for
A. For u, v ∈ B, we put (u, v) ∈ EB if and only if one of the following holds:
C1 u, v ∈ B1 and (u, v) ∈ EB1 ,

40

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

C2 u ∈ B1 , v = ((x, (x1 , . . . , xn )), (w1 , . . . , wn )) ∈ T , there is 1 ≤ i ≤ n such
that u = wi and (xi , x) ∈ EB0 ,
C3 u = ((x, (x1 , . . . , xn )), (w1 , . . . , wn )) ∈ T , v ∈ B1 , there is 1 ≤ i ≤ n such
that v = wi and (x, xi ) ∈ EB0 , or
C4 u = ((x, (x1 , . . . , xn )), (w1 , . . . , wn )) ∈ T , v = ((y, (y1 , . . . , ym )), (t1 , . . . ,
tm )) ∈ T , {t1 , . . . , tm } ⊆ {w1 , . . . , wn } and (x, y) ∈ EB0 .
For every x ∈ B put
FB (x) = {y ∈ B : y is reachable from x in B}.
Finally, we put Fn (x1 , . . . , xn ) = ∅ if x1 , . . . , xn is not a tuple of distinct vertices
of B1 and Fn (x1 , . . . , xn ) = {y ∈ B : {x1 , . . . , xn } is a vertex set of support(y)} if
x1 , . . . , xn is a tuple of distinct vertices of B1 . Here support(v) is defined as follows:
(1) If v ∈ B1 put support(v) = ClB1 (v).
(2) Otherwise v ∈ T and thus v = (P, x̄) for some choice of P and x̄. In this
case we put support(v) = ClB1 (x̄) (where by ClB1 (x̄) we mean the smallest
substructure of B1 containing all vertices from x̄).
Note that the second case, it in fact holds that support(v) = x̄. To prove it,
observe first that ClB1 (x̄) is irreducible (it is the closure of a tuple in a relation).
By irreducible structure faithfulness of B1 , we get an automorphism f of B1 such
that f (ClB1 (x̄)) ⊆ A1 . In particular, x̄ gets sent by f to a tuple of vertices of A1
which is in relation fL (RP ). By definition of P, we get that ClB1 (f (x̄)) = f (x̄)
and hence also support(v) = x̄.
The following observation follows directly from the construction of B.
Observation 12.10. Whenever (v, v 0 ) ∈ EB , we have that
support(v) ⊇ support(v 0 ).
We now show that B is the desired EPPA-witness. Towards that direction we
define the following procedure to map portions B to substructures of A. Given a
vertex v ∈ B and an automorphism f = (fL , fB1 ) of B1 such that f (support(v)) is
a substructure of A1 we define f -correspondence cf (v) ∈ A as follows:
(1) If v ∈ B1 then put cf (v) = fB1 (v).
(2) If v ∈
/ B1 by our construction v ∈ T . By construction of T we know that
v = (P, x̄) (for some choice of P and x̄). In this case put cf (v) = π(fL (P )).
Claim (on correspondence). Let f = (fL , fB1 ) be an automorphism of B1 and
v 6= v 0 ∈ B such that both f (support(v)) and f (support(v 0 )) are substructures of
A1 . Then
P1 cf (v) 6= cf (v 0 ).
P2 (v, v 0 ) ∈ EB if and only if (cf (v), cf (v 0 )) ∈ EA .
If v, v 0 ∈ B1 then we know that cf (v) = fB1 (v) 6= fB1 (v 0 ) = cf (v 0 ) and P1
follows. If precisely one of v, v 0 is in v ∈ B1 then it follows that precisely one of
cf (v), cf (v 0 ) is a root of A and P1 follows as well. In the remaining case both v, v 0 ∈
/
B1 . Then they correspond to tuples (P, x̄), (P 0 , x̄0 ) ∈ T . From the assumptions on
f , we get that π(P ) 6= π(P 0 ) and hence cf (v) = π(fL (P )) 6= π(fL (P 0 )) = cf (v 0 )
which gives P1.
To see P2, we again consider the three cases. If v, v 0 ∈ B1 , P2 follows from C1.
If precisely one of v, v 0 ∈ B1 then P2 follows from C2 and C3. If v, v ∈
/ B1 we use
C4. This finishes the proof of claim.
The following claim follows directly from P1 and P2:

ALL THOSE EPPA CLASSES

41

Claim (on substructures). Let D1 be a substructure of B1 and f an automorphism
of B1 such that f (D1 ) is a substructure of A1 . Let D be a substructure of B induced
by all vertices v such that support(v) ⊆ D1 . Then cf is an isomorphism from D to
a substructure induced by A on ClA (f (D1 )).
From Observation 12.10, Claim on substructures and irreducible structure faithfulness of B1 it follows that B is a k-orientation and root vertices of B are precisely
vertices of B1 . We also get that every copy of A1 in B1 corresponds to a copy of
A in B.
By the construction of B it follows
S that a substructure C of B is fully determined
by substructure induced by B1 on v∈C support(v) = C ∩ B1 .
Let C be a substructure of B. If C ∩ B1 is a free amalgamation of its proper
substructures, then so is C. Taking the contrapositive, if C is an irreducible substructure of B, we also know that C ∩B1 is an irreducible substructure of B1 . Then,
by Claim on substructures and the fact that B1 is irreducible structure faithful,
we get that C is isomorphic to an irreducible substructure of A. This finishes the
proof that B ∈ Ddk .
Next we construct a copy A0 of A in B whose partial automorphisms we will
extend. Consider the identity automorphism id of B1 . By Claim on substructures,
the id-correspondence on the set of all vertices of B with support in A1 yields a
copy A0 of A in B. We will denote by ψ the corresponding embedding A → B
given by id-correspondence.
To see that B is an EPPA-witness for A0 , let ϕ be a partial automorphism of
A . Consider ψ −1 ◦ ϕ as a partial automorphism of A0 , and extend it to partial
automorphism θ0 of B0 . Let θL be the natural action of θ0 on T . Put ϕ0 = ϕA1
and observe that Range(ϕ0 ) ⊆ A1 , because ϕ preserves, whether a vertex is a root.
Put ϕ1 = (θL , ϕ0 ). It is easy to verify that ϕ1 is a partial automorphism of A1
and hence extends to (θL , θ1 ), an automorphism of B1 . Now, θL ∪ θ1 is a bijection
B → B and one can verify that it is in fact an automorphism of B extending ϕ.
To see that B is a coherent EPPA witness it remains to notice that θ0 and θ1
can be both chosen coherently.

0

13. Conclusion
Comparing known EPPA classes and known Ramsey classes one can easily identify two main weaknesses of the state-of-the-art EPPA constructions.
(1) The need for automorphism-preserving completion procedure is not necessary in the Ramsey context. The example of two-graphs [EHKN20]
shows that there are classes with EPPA which do not admit automorphismpreserving completions (see [Kon19b] for a more systematic treatment of
certain classes of this kind). Understanding the situation better might
lead to solving some of the long standing open problems in this area including the question whether the class of all finite tournaments has EPPA
(see [HPSW18] for recent progress on this problem).
(2) The lack of general EPPA constructions for classes with non-unary function
symbols. Again there are known classes with non-unary function symbols
that have EPPA (e.g. finite groups or a natural interpretation of equivalences on k-tuples with infinitely many equivalence classes). It is however
not known whether, for example, the class of all finite partial Steiner systems or the class of all finite equivalences on pairs with two equivalence
classes have EPPA.

42

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

On the other hand, in this paper we consider ΓL -structures which reduce to the usual
model-theoretic structures in the Ramsey context (because ΓL must be trivial there
in order for the class to be rigid). This has some additional applications including:
(1) Elimination of imaginaries for classes having definable equivalence classes
(see [Iva15, HN19]),
(2) representation of special non-unary functions which map vertices of one
type to vertices of different type (an example is given in the proof of Theorem 12.9), or
(3) representation of antipodal structures and switching classes (generalising
[EHKN20], see also [Kon19b]).
We refer the reader to [HN19, ABWH+ 17c, Kon18, Kon19a] for various examples
of (automorphism-preserving) locally finite subclasses.
One of the main weaknesses of Theorems 1.5, 1.6 and 1.1 is that they only allow
unary functions. It would be interesting to know whether they hold without this
restriction.
Question 13.1. Do Theorems 1.5, 1.6 and 1.1 hold also for languages with nonunary functions?
If answered in the affirmative, Question 13.1 would have some applications which
are interesting on their own and have been asked before. We present two of them
as separate questions.
Question 13.2. Let L be the language consisting of a single binary function and
let C be the class of all finite L-structures (say, such that the image of every pair
of vertices has cardinality at most one). Does C have EPPA?
Question 13.3. Does the class of all finite partial Steiner triple systems have
EPPA, where one only wants to extend partial automorphism between closed substructures? (A sub-hypergraph H of a Steiner triple system is closed if whenever
{x, y, z} is a triple and x, y ∈ H, then z ∈ H.)
References
[ABWH+ 17a] Andres Aranda, David Bradley-Williams, Eng Keat Hng, Jan Hubička, Miltiadis
Karamanlis, Michael Kompatscher, Matěj Konečný, and Micheal Pawliuk. Completing graphs to metric spaces. Electronic Notes in Discrete Mathematics, 61:53–
60, 2017. The European Conference on Combinatorics, Graph Theory and Applications (EUROCOMB’17).
[ABWH+ 17b] Andres Aranda, David Bradley-Williams, Eng Keat Hng, Jan Hubička, Miltiadis
Karamanlis, Michael Kompatscher, Matěj Konečný, and Micheal Pawliuk. Completing graphs to metric spaces. arXiv:1706.00295, accepted to Contributions to
Discrete Mathematics, 2017.
[ABWH+ 17c] Andres Aranda, David Bradley-Williams, Jan Hubička, Miltiadis Karamanlis,
Michael Kompatscher, Matěj Konečný, and Micheal Pawliuk. Ramsey expansions
of metrically homogeneous graphs. Submitted, arXiv:1707.02612, 2017.
[AN19]
H. Andréka and I. Németi. Extending partial isomorphisms, a small construction.
private communication, 2019.
[BPT11]
Manuel Bodirsky, Michael Pinsker, and Todor Tsankov. Decidability of definability.
In Proceedings of the 2011 IEEE 26th Annual Symposium on Logic in Computer
Science, LICS ’11, pages 321–328, Washington, DC, USA, 2011. IEEE Computer
Society.
[Che17]
Gregory Cherlin. Homogeneous ordered graphs and metrically homogeneous
graphs. Submitted, December 2017.
[Con19]
Gabriel Conant. Extending partial isometries of generalized metric spaces. Fundamenta Mathematicae, 244:1–16, 2019.
[EHKN20]
David M. Evans, Jan Hubička, Matěj Konečný, and Jaroslav Nešetřil. EPPA for
two-graphs and antipodal metric spaces. Proceedings of the American Mathematical Society, 148:1901–1915, 2020.

ALL THOSE EPPA CLASSES

[EHN17]

[EHN19]

[Eva05]
[Fra53]
[Hal49]
[Her95]
[Her98]

[HHLS93]

[HKN18]
[HKN19]

[HL00]

[HN19]

[HO03]
[HPSW18]
[Hru92]
[Iva15]
[JT20]
[Kon18]
[Kon19a]
[Kon19b]
[KPT05]

[Neš05]
[Neš07]
[NVT15]

[Ott17]
[Pes08]

43

David M. Evans, Jan Hubička, and Jaroslav Nešetřil. Ramsey properties and extending partial automorphisms for classes of finite structures. To appear in Fundamenta Mathematicae, arXiv:1705.02379, 2017.
David M. Evans, Jan Hubička, and Jaroslav Nešetřil. Automorphism groups and
Ramsey properties of sparse graphs. Proceedings of the London Mathematical Society, 119(2):515–546, 2019.
David M. Evans. Trivial stable structures with non-trivial reducts. Journal of the
London Mathematical Society (2), 72(2):351–363, 2005.
Roland Fraı̈ssé. Sur certaines relations qui généralisent l’ordre des nombres rationnels. Comptes Rendus de l’Academie des Sciences, 237:540–542, 1953.
Marshall Hall. Coset representations in free groups. Transactions of the American
Mathematical Society, 67(2):421–432, 1949.
Bernhard Herwig. Extending partial isomorphisms on finite structures. Combinatorica, 15(3):365–371, 1995.
Bernhard Herwig. Extending partial isomorphisms for the small index property
of many ω-categorical structures. Israel Journal of Mathematics, 107(1):93–123,
1998.
Wilfrid Hodges, Ian Hodkinson, Daniel Lascar, and Saharon Shelah. The small
index property for ω-stable ω-categorical structures and for the random graph.
Journal of the London Mathematical Society, 2(2):204–218, 1993.
Jan Hubička, Matěj Konečný, and Jaroslav Nešetřil. Semigroup-valued metric
spaces: Ramsey expansions and EPPA. In preparation, 2018.
Jan Hubička, Matěj Konečný, and Jaroslav Nešetřil. A combinatorial proof of the
extension property for partial isometries. Commentationes Mathematicae Universitatis Carolinae, 60(1):39–47, 2019.
Bernhard Herwig and Daniel Lascar. Extending partial automorphisms and the
profinite topology on free groups. Transactions of the American Mathematical Society, 352(5):1985–2021, 2000.
Jan Hubička and Jaroslav Nešetřil. All those Ramsey classes (Ramsey classes with
closures and forbidden homomorphisms). Advances in Mathematics, 356C:106791,
2019.
Ian Hodkinson and Martin Otto. Finite conformal hypergraph covers and Gaifman
cliques in finite structures. Bulletin of Symbolic Logic, 9(03):387–405, 2003.
Jingyin Huang, Michael Pawliuk, Marcin Sabok, and Daniel Wise. The Hrushovski
property for hypertournaments and profinite topologies. arXiv:1809.06435, 2018.
Ehud Hrushovski. Extending partial isomorphisms of graphs. Combinatorica,
12(4):411–416, 1992.
Aleksander Ivanov. An ω-categorical structure with amenable automorphism
group. Mathematical Logic Quarterly, 61(4-5):307–314, 2015.
Colin Jahel and Todor Tsankov. Invariant measures on products and on the space
of linear orders. arXiv preprint arXiv:2007.00281, 2020.
Matěj Konečný. Combinatorial properties of metrically homogeneous graphs. Bachelor’s thesis, Charles University, 2018. arXiv:1805.07425.
Matěj Konečný. Semigroup-valued metric spaces. Master’s thesis, Charles University, 2019. arXiv:1810.08963.
Matěj Konečný. Extending partial isometries of antipodal graphs. Discrete Mathematics, page 111633, 2019. https://doi.org/10.1016/j.disc.2019.111633.
Alexander S. Kechris, Vladimir G. Pestov, and Stevo Todorčević. Fraı̈ssé limits,
Ramsey theory, and topological dynamics of automorphism groups. Geometric and
Functional Analysis, 15(1):106–189, 2005.
Jaroslav Nešetril. Ramsey classes and homogeneous structures. Combinatorics,
probability and computing, 14(1-2):171–189, 2005.
Jaroslav Nešetřil. Metric spaces are Ramsey. European Journal of Combinatorics,
28(1):457–468, 2007.
Lionel Nguyen Van Thé. A survey on structural Ramsey theory and topological
dynamics with the Kechris-Pestov-Todorcevic correspondence in mind. Selected
Topics in Combinatorial Analysis, 17(25):189–207, 2015.
Martin Otto. Amalgamation and symmetry: From local to global consistency in
the finite. arXiv:1709.00031, 2017.
Vladimir G Pestov. A theorem of Hrushovski–Solecki–Vershik applied to uniform
and coarse embeddings of the Urysohn metric space. Topology and its Applications,
155(14):1561–1575, 2008.

44

[PS18]
[Ros11a]
[Ros11b]
[RZ93]
[Sab17]
[Sin17]
[Sol05]
[Sol09]
[SS19]

[Ver08]

J. HUBIČKA, M. KONEČNÝ, AND J. NEŠETŘIL

Gianluca Paolini and Saharon Shelah. The automorphism group of Hall’s universal
group. Proceedings of the American Mathematical Society, 146(4):1439–1445, 2018.
Christian Rosendal. Finitely approximable groups and actions part II: Generic
representations. The Journal of Symbolic Logic, 76(04):1307–1321, 2011.
Christian Rosendal. Finitely approximate groups and actions part I: The Ribes–
Zalesskiı̆ property. The Journal of Symbolic Logic, 76(04):1297–1306, 2011.
Luis Ribes and Pavel A Zalesskiı̆. On the profinite topology on a free group. Bulletin
of the London Mathematical Society, 25(1):37–43, 1993.
Marcin Sabok. Automatic continuity for isometry groups. Journal of the Institute
of Mathematics of Jussieu, pages 1–30, 2017.
Daoud Siniora. Automorphism Groups of Homogeneous Structures. PhD thesis,
University of Leeds, March 2017.
Slawomir Solecki. Extending partial isometries. Israel Journal of Mathematics,
150(1):315–331, 2005.
Slawomir Solecki. Notes on a strengthening of the Herwig–Lascar extension theorem. Unpublished note, 2009.
Daoud Siniora and Slawomir Solecki. Coherent extension of partial automorphisms,
free amalgamation, and automorphism groups. The Journal of Symbolic Logic,
2019.
Anatoly M. Vershik. Globalization of the partial isometries of metric spaces and
local approximation of the group of isometries of Urysohn space. Topology and its
Applications, 155(14):1618–1626, 2008.

Charles University, Faculty of Mathematics and Physics, Department of Applied
Mathematics (KAM), Prague, Czech Republic
E-mail address: hubicka@kam.mff.cuni.cz
Charles University, Faculty of Mathematics and Physics, Department of Applied
Mathematics (KAM), Prague, Czech Republic
E-mail address: matej@kam.mff.cuni.cz
Charles University, Faculty of Mathematics and Physics, Computer Science Institute of Charles University (IUUK), Prague, Czech Republic
E-mail address: nesetril@iuuk.mff.cuni.cz

