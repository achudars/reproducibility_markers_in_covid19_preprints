Discovering Context Effects from Raw Choice Data

Arjun Seshadri 1 Alexander Peysakhovich 2 Johan Ugander 1

arXiv:1902.03266v2 [cs.LG] 31 Jan 2020

Abstract
Many applications in preference learning assume
that decisions come from the maximization of a
stable utility function. Yet a large experimental
literature shows that individual choices and judgements can be affected by “irrelevant” aspects of
the context in which they are made. An important
class of such contexts is the composition of the
choice set. In this work, our goal is to discover
such choice set effects from raw choice data. We
introduce an extension of the Multinomial Logit
(MNL) model, called the context dependent random utility model (CDM), which allows for a
particular class of choice set effects. We show
that the CDM can be thought of as a second-order
approximation to a general choice system, can
be inferred optimally using maximum likelihood
and, importantly, is easily interpretable. We apply
the CDM to both real and simulated choice data
to perform principled exploratory analyses for the
presence of choice set effects.

1. Introduction
Modeling individual choice is an important component of
recommender systems (Resnick and Varian, 1997), search
engine ranking (Schapire et al., 1998), analysis of auctions
(Athey and Levin, 2001), marketing (Allenby and Rossi,
1998), and demand modeling in diverse domains (Berry
et al., 1995; Bruch et al., 2016). The workhorse models
used either implicitly or explicitly in these disparate literatures are random utility models (RUMs) (Manski, 1977),
which assume that individuals have a numeric utility for
each item and that they make choices that maximize noisy
observations of these utilities (Luce, 1959; McFadden, 1980;
Kreps, 1988).
1
Stanford University, Stanford, CA 2 Facebook Artificial Intelligence Research, New York, NY. Correspondence to: Arjun Seshadri <aseshadr@stanford.edu>, Alexander Peysakhovich <alexpeys@fb.com>, Johan Ugander <jugander@stanford.edu>.

Proceedings of the 36 th International Conference on Machine
Learning, Long Beach, California, PMLR 97, 2019. Copyright
2019 by the author(s).

The most well known and widely used RUM is the conditional multinomial logit (MNL), also called the Luce model,
which is the unique RUM that satisfies the axiom known
as the independence of irrelevant alternatives (IIA) (Luce,
1959). Informally, this axiom states that adding an item to
a choice set does not change the relative probabilities of
choosing the other items. This assumption is very strong,
but it allows analysts to build powerful and interpretable
models. However, if one assumes IIA but it is not actually
true, predictions for out-of-sample choices could be very
wrong. Thus, it is important for analysts to discover whether
IIA is approximately true in a given dataset.
At the same time, there is a large amount of experimental evidence showing significant deviations from rational choice
across many domains. In particular, the value assigned to
an item can strongly depend on the “irrelevant” elements
of the context of the choice (Tversky, 1972; Tversky and
Simonson, 1993). Attempts to model these context effects
in a domain-free manner fall short of being practically valuable, either due to large parameter requirements, inferential
intractability, or both (Park and Choi, 2013).
Our contribution addresses both issues. We consider the
IIA-satisfying MNL model and make small modifications to
subsume a class of IIA violations that we believe are important in practice, while retaining parametric and inferential
efficiency. We refer to this model as the context dependent
random utility model (CDM). The CDM can be thought
of as a “second order” approximation of a general choice
system (the MNL model, meanwhile, corresponds to a “first
order” approximation). Because the CDM nests MNL, it
can fit data that does satisfy IIA just as well, and, importantly, can be used to construct a nested-model hypothesis
test for whether a particular dataset is consistent with IIA.
The key assumption of the CDM is that IIA violations come
from pairwise interactions between items in the choice set
and that larger choice set effects can be approximated additively using all pairwise effects. This assumption means that
the CDM has many fewer parameters than a general choice
system. We can further reduce the CDM’s data dependence
by assuming that these underlying effects can be well modeled by latent vectors of a smaller dimensionality than the
number of items, resulting in what we call the low-rank
CDM. The low-rank CDM can be useful in applications

Discovering Context Effects from Raw Choice Data

where the number of items is relatively large and where
seeing all possible comparisons may be extremely costly.
For a theoretical contribution, we furnish formal results
for conditions under which the parameters of a CDM can
or can not be identified from data. In situations where
identifiability is not achieved, we advocate for additive `2 regularization of the log-likelihood to select the minimum
norm solution. We also provide finite sample convergence
guarantees for the expected squared `2 error of the estimate
as a function of comparison structure.
For an applied contribution, we first test the CDM in synthetic data and show that a nested model likelihood ratio
test—between the CDM and MNL models—has good finite
sample properties. When IIA holds, a p < .05 hypothesis
test rejects the null slightly less than 5% of the time. When
IIA does not hold the null hypothesis is overwhelmingly
rejected even in medium size data-sets. By contrast we see
that using a nested model test based on the nested structure
of a general choice system and MNL model gives a test that
wildly over-rejects the null, even when IIA is true.
We apply the CDM to several real-world datasets. First,
we show that we can strongly reject IIA in the popular
SFWork and SFShop choice datasets. Second, we consider
using the CDM to model choices in the task of Heikinheimo
and Ukkonen (2013), where individuals are presented with
triplets of items and asked which item is least like the other
two. Here the CDM can capture the underlying choice
structure quite well while IIA is an extremely unreasonable
assumption.
1.1. Related Work
The CDM vaguely resembles the continuous bag of
words (CBOW) neural network architecture popularized
by word2vec (Mikolov et al., 2013), with two key differences. First, while the CBOW model tries to predict the
appearance of a word where candidates are any word in the
vocabulary, the CDM models choices from arbitrary subsets.
Second, although in principle the word2vec model and its
extensions train two embeddings per word (one as target and
one as context), these embeddings are typically averaged
together at the end of training to obtain a single embedding
per word. However, it has been shown that keeping these
two embeddings separate does allow one to capture ancillary
information not captured by the single embedding (Rudolph
et al., 2016) and the two embeddings can be used to model
complements and substitutes in supermarket shopping data
(Ruiz et al., 2017).
Utility models with a contextual component are widely used
to analyze intertemporal choice (discount functions) (Muraven and Baumeister, 2000; Fudenberg and Levine, 2012),
choice under uncertainty (Bordalo et al., 2012; Fox and

Tversky, 1995), and choices about cooperation (List, 2007;
Liberman et al., 2004; Peysakhovich and Rand, 2015). They
are also workhorses in modeling consumer behavior in applied settings. Online recommender systems (Resnick and
Varian, 1997), which model user-item interactions as inner
products of low rank vectors, can be seen as employing a
utility function that is an inner product between item attributes and user weights.
The CDM and low-rank CDM generalize a number of prominent choice models in a unified framework. In a later section, after we introduce the basic mathematical notation, we
present connections to the work of Tversky and Simonson
(1993), Batsell and Polking (1985), and Chen and Joachims
(2016a;b). Importantly, this means our convergence and
identifiability results carry over to these other models, which
all previously lacked such results.

2. Modeling Choice Systems
Let X be a finite set of n alternatives that we hold fixed and
let C = {C : C ⊆ X , |C| ≥ 2} be the set of all subsets of X
of size greater than or equal to two. Throughout this work,
we assume there is a single individual that is presented with
choice sets and chooses a single item from each choice set.
In this setting, the fundamental object of study is a choice
system, a collection of probability distributions for every
C ∈ C, describing the probability that an item x is chosen
from C, ∀x ∈ C. We denote each such probability by
P (x | C). In general, a choice system can model arbitrary
preferences on arbitrary subsets with no further restrictions.
The most commonly assumed restriction on choice systems
is that they satisfy the independence of irrelevant alternatives
(IIA), which can be stated as follows.

Assumption 1. A choice system on X satisfies the independence of irrelevant alternatives (IIA) if for any x, y ∈ X
and choice sets A, B ⊆ X with x, y ∈ A, B we have
P (x | A)
P (x | B)
=
.
P (y | A)
P (y | B)
In other words, IIA states that the composition of a choice
set does not affect the relative attractiveness of items. A
main question in this work will be, given a dataset D of
choices from choice sets, can we determine whether D was
generated by a model satisfying IIA or a model of a more
general choice system? If not generated by a model satsify
IIA, is it possible to define tractable model classes between
the class of models satisfying IIA and the class of fully
general choice systems? Our answer to this question is a
formal truncation of a general choice system that we call
the context dependent random utility model (CDM).

Discovering Context Effects from Raw Choice Data

2.1. Context-dependent Random Utility Models
A trivial model of a general choice system is the universal logit model (McFadden et al., 1977), which simply
parameterizes the choice system object, defining utilities
u(x | C), ∀x ∈ C, for each C ∈ C that can vary arbitrarily
for every item, for every set. The choice probabilities for a
universal logit model are then:
exp(u(x | C))
P (x | C) = P
.
y∈C exp(u(y | C))
The above model exhibits scale-invariance
on each subset
P
C, and thus we require that y∈C u(y | C) = 0, ∀C ∈ C
for the purposes of identifiability. While relatively uninteresting as a model, the above formulation is the starting
point for the following observation about choice systems,
first documented by Batsell and Polking (1985).
Lemma 1. The utilities in the universal logit model, u(x |
C), ∀C ∈ C, ∀x ∈ C, can be uniquely mapped as
X
u(x | C) =
v(x | B),
B⊆C\x

where
v(x | B) are values that satisfy the constraints
P
x∈B
/ v(x | B) = 0, ∀B ⊂ X .
For greater clarity, we expand out the terms individually.
X
u(x | C) = v(x) +
v(x | {y}) +
|{z}
y∈C\x
1st order
{z
}
|
2nd order

X

v(x | {y, z}) + . . . + v(x | C \ {x}),
|
{z
}
{y,z}⊆C\x
|C|th
order
|
{z
}
3rd order

and expand out the first three sets of constraints:
X
X
v(x) = 0,
v(x | {y}) = 0,
x∈X

x∈X \y

X

v(x | {y, z}) = 0.

x∈X \{y,z}

We use v(x) = v(x | ∅) for simplicity. This expansion
reveals that arbitrary contextual utilities can be decomposed
into intuitive contributions: the first order terms represent
the item’s intrinsic contribution to the utility, the second order terms represent the contextual contributions from every
other item in the choice set, the third order terms the contributions from contextual pairs not modeled by contributions
of the pairs constituent items, and so on. The expansion
invites one to consider a hierarchy of choice model classes
indexed by their order1 : the pth order model refers to forcing all terms of order greater than p to zero. Denote this
1

This expansion differs from the one used by Batsell and Polking (1985), which expands the log probability ratios of items being
chosen instead of the underlying contextual utilities.

class of choice system models by Mp . Clearly, we have
M1 ⊂ M2 ⊂ . . . ⊂ Mn−1 , where Mn−1 is the universal
logit model. We next consider two excercises. First, we
write out the 1st order model explicitly:
X
exp(v(x))
P (x | C) = P
,
v(x) = 0.
y∈C exp(v(y))
x∈X

This model M1 is the multinomial logit model, the
workhorse model of discrete choice (Luce, 1959; McFadden,
1980). Moving to higher-order models, a counting exercise
reveals that the number of free parameters in the pth order
model is

p 
X
n
(n − q),
q−1
q=1
which simplifies to n − 1 and (n − 2)2n−1 + 1 parameters
for M1 (MNL) and Mn−1 (universal logit), respectively.
Clearly, the parameters grow polynomially in the number
of items and exponentially in the order: there are O(n)
parameters for the 1st order model, O(n2 ) parameters for
the 2nd, and so on.
The principled next step, then, is to consider the minimal
model class that accounts for context effects, M2 :
P
exp(v(x) + z∈C\x v(x | {z}))
P
P (x | C) = P
,
y∈C exp(v(y) +
z∈C\y v(y | {z}))
X
X
s.t.
v(x) = 0,
v(x | {y}) = 0, ∀y ∈ X .
x∈X

x∈X \y

We remove most constraints (see Appendix C.1 for details)
by introducing new parameters uxz = v(x | {z}) − v(z),
∀x, z ∈ X , interpretable as the pairwise push and pull of
z on x’s utility. We may then rewrite the above, ∀C ⊆
X , ∀x ∈ C, as
P
exp( z∈C\x uxz )
P
P (x | C) = P
,
(1)
y∈C exp(
z∈C\y uyz )
P
P
with one constraint, x∈X y∈X \x uxy = 0. We may then
do away with this final constraint by noticing that P (x | C)
is invariant to a constant shift of uxz , as in the case of
both the MNL and universal logit model. We refer to the
model M2 , as parameterized in equation (1), as the context
dependent random utility model (CDM), and note that it has
n(n − 1) − 1 free parameters.
The CDM then corresponds to the following restriction on
choice systems.
Assumption 2 (Pairwise linear dependence of irrelevant
alternatives). A choice system on X satisfies pairwise linear
dependence of irrelevant alternatives if, in the universal
logit representation of Lemma 1, v(x | B) = 0 for all
B ⊂ X for which |B| ≥ 2.
This assumption can either be taken literally, or can be

Discovering Context Effects from Raw Choice Data

justified as an approximation on the grounds of applications:
in practice many problems are concerned with choices from
relatively small sets, and the linear context effect assumption
is then a decent approximation.
2.2. Low-rank CDMs
From equation (1), it is clear that the parameters of the CDM,
uxz , ∀x, z ∈ X , have a matrix-like structure. Note that
the parameters do not quite form a matrix, as the diagonal
elements uxx are undefined and unused. But given this
structure, it is natural ask if the pairwise contextual utilities
can be modeled by a lower-dimensional parameterization.
Formally, we define the low-rank CDM as a CDM where
the pairwise contextual utilities jointly admit a low-rank
factorization uxz = cTz tx , ∀x, y ∈ X . We call tx , cx ∈ Rr ,
the target and context vectors, respectively, for each item
x ∈ X . We can then write the choice probabilities of the
low-rank CDM, for all C ⊆ X , for all x ∈ C, as:
P
exp(( z∈C\x cz )T tx )
P
.
(2)
P (x | C) = P
T
y∈C exp((
z∈C\y cz ) ty )
The rank-r CDM then has 2nr parameters and has at most
min{(2n − r)r, n(n − 1) − 1} degrees of freedom.
Our low-rank assumption is strongly related to standard additive utility models where one is given a low-dimensional
featurization x ∈ Rr of each item and an individual’s utility
is β T x. A difference here, other than the notion of contextual utility, is that we assume no featurization is available
and that it must be learned.

3. Identifiability and Estimation of the CDM
Consider a dataset D of choices with generic element (x, C)
that correspond to observing element x being chosen from
set C. Let CD denote the collection of unique subsets of
X represented in D. If we assume that the data was generated by a CDM, it is important to understand conditions
under which the parameters of that CDM are identifiable
and conditions under which the expected error of a tractable
estimation procedure converges to zero as the dataset gets
large. In this section we furnish two sufficient conditions
and one “insufficient” condition for identifiability. We then
bound the expected squared `2 error of the maximum likelihood estimate (MLE) of a full-rank CDM. Because the
log-likelihood of the full-rank CDM is convex (by the convexity of log-sum-exp), we know we can efficiently find this
MLE, and that this bound on the error of the full-rank model
also bounds the error of any low-rank model.

on the set of all subsets of X .
2. The chooser chooses an item x from the choice set A
according to a CDM with parameters θ ∈ Θ.
We can parametrize the utility function by θ referring to it as
uθ (· | ·). Given a D and guess θ we can write the probability
of (x, A) as
exp(uθ (x | A))
.
y∈A exp(uθ (y | A))

Pθ (x | A) = P

This means we have a well defined likelihood function for
the full dataset
Y
L(D | θ) =
Pθ (x | A).
(3)
(x,A)∈D

For now we consider a full rank CDM where the parameter vector θ is the set of pairwise contextual utilities uxz ,
∀x, z ∈ X . We will consider u ∈ Rd as the parameter
vector, where for the full-rank CDM d = n(n − 1) − 1.
Because u can only be identified up to aP
scale, we consider
possible CDMs with the constraint that xz uxz = 0.
The likelihood (3) can be maximized using standard techniques. We will say that a dataset identifies a CDM if there
are no two sets of parameters that have the same distribution
P (x | C), ∀C ∈ C, ∀x ∈ C. We now give a sufficient (but
not necessary) condition for identification.
Theorem 1. A CDM is identifiable from a dataset D if CD
contains comparisons over all choice sets of two sizes k, k 0 ,
where at least one of k, k 0 is not 2 or n.
The proof is given in Appendix A. In the multinomial logit
model, the constraints of IIA allow us to identify all parameters given just the probability distribution P (· | X ), but in
the less constrained CDM more information is needed. For
a simple demonstration of the theorem, consider a choice
system on X = {a, b, c} where
P (a | X ) = 0.8, P (b | X ) = 0.1, P (c | X ) = 0.1.

We consider the dataset D as being generated in the following hierarchical manner:

Here, if we assume IIA we can infer any pairwise choice
probability simply by taking the appropriate ratio. However,
if we do not assume IIA and only assume Assumption 2
(equivalent to assuming the choice system is a CDM), any
set of pairwise probabilities is consistent with what we’ve
observed. Thus the CDM is not identified if we only receive
data about choices from {a, b, c}. Moreover, because CDM
can fit any pairwise probability while retaining the above
choice probabilities over {a, b, c}, the CDM clearly violates
IIA. We elaborate further in Appendix C.2, showing specific
CDM parameters handling violations of IIA, and further
discuss the various context effects (e.g. the compromise
effect) the CDM can discover and accommodate.

1. A choice set A is chosen at random from a distribution

In Appendix A we show that the identifiability of the fullrank CDM for a given dataset D is equivalent to testing the

Discovering Context Effects from Raw Choice Data

rank of an integer design matrix G(D) constructed from the
dataset (Theorem 4). This characterization of the identifiability of the full-rank CDM also gives a sufficient condition
for the identifiability of low-rank CDMs. The proof of this
theorem can be easily expanded to demonstrate an advantage of the CDM instead of a general choice system: for
a general choice system to be identified CD would need to
include in its support every choice set.
In addition to the above sufficient conditions for identifiability, we also have the following result about an important
“insufficient” condition.
Theorem 2. No rank r CDM, 1 ≤ r ≤ n, is identifiable
from a dataset D if CD contains only choices from sets of a
single size.
The proof is given in Appendix A. Requiring comparisons
over two different choice set sizes is not unique to the CDM;
recent results (Chierichetti et al., 2018) demonstrate that
even a uniform mixture of two multinomial logit models,
a special case of the mixed logit that violates IIA, requires
comparisons over two different choice set sizes.
As a result of this theorem, for choice data collected from
sets of a fixed size, the parameters of a CDM model that
has been fit to data can not be interpreted without some
amount of explicit or implicit regularization. This nonidentifiability also applies to all blade-chest models (Chen
and Joachims, 2016a), which (as alluded to in Section 3.3)
are CDM models restricted to pairwise choices. We further
explore regularization and identifiability in Appendix C.3.
3.1. Uniform Performance Guarantees
The likelihood function is log-concave and can thus be
solved to arbitrary error through standard convex optimization
P procedures (avoiding shift invariance with the constraint
xz uxz = 0). We now show that maximum likelihood estimation efficiently recovers the true CDM parameters under
mild regularity conditions.
Theorem 3. Let u? denote the true CDM model from which
data is drawn. Let ûMLE denote the maximum likelihood
solution. Assume CD identifies the CDM. For any u? ∈
UB = {u ∈ Rd : kuk∞ ≤ B, 1T u = 0}, and expectation
taken over the dataset D generated by the CDM model,

d−1
2
E kûMLE (D) − u? k2 ≤ cB,kmax
,
m
where kmax refers to the maximum choice set size in the
dataset, and cB,kmax is a constant that depends on B, kmax
and the spectrum of the design matrix G(D).
The proof is given in Appendix B, where we also state
the exact relationship of cB,kmax to the max norm radius B,
the maximum choice set size kmax and design matrix G(D).
Both the identifiability condition and maximum norm bound

are essential to the statement, as the right hand side diverges
when the former is violated, and diverges as B → ∞.
Theorem 3 is a generalization of a similar convergence
result previously shown for the multinomial logit case (Shah
et al., 2016) (the multinomial logit model class is a subset
of the CDM model class). The proof follows the same steps,
showing first that the objective satisfies a notion of strong
convexity, and using that fact to bound the distance between
the estimate and the true value. Our contributions augment
the notation of Shah et al. (2016) to support multiple set
sizes and the more complex structure of the CDM, and
carefully bound the role of these deviations in the steps
leading to the result.
To our knowledge, this convergence bound furnishes the first
tractable sample complexity result for a model that can accommodate deviations from a random utility model (RUM).
A comparable lower bound, which we do not furnish in this
work, would make clear whether the maximum likelihood
procedure is inferentially optimal or not. And while stated
for the full-rank model, our convergence bound holds for
CDMs of any rank. It is possible that low-rank CDMs admit
an improved rank-dependent convergence rate.
3.2. Testing
We can use the CDM to construct a statistical test of whether
our data is indeed consistent with the MNL/Luce model, and
thus IIA, across the choice sets we observe. Recall that the
class of Luce models is nested within the CDM, which is
in turn nested within the universal logit, as discussed in
Section 2. We can consider the following likelihood ratio
statistic,
supθ∈ΘLuce ⊂ΘCDM L(D | θ)
,
Λ(D) =
supθ∈ΘCDM L(D | θ)
where ΘLuce and ΘCDM respectively refer to the parameter
classes of Luce and CDM Models. We then appeal to a
classical result from asymptotic statistics (Wilks, 1938) that
as the sample size m → ∞, D = −2 log(Λ(D)) converges
to the χ2 distribution with degrees of freedom ∆ equal to the
difference between the number of parameters between the
two model classes. For CDM and
PLuce, ∆ = n(n−2). For a
universal logit and Luce, ∆ = ( C∈CD (|C|−1))−(n−1),
where CD are the unique subsets in the dataset that the test
can reasonably evaluate. Our test then compares the statistic
to the value of the χ2∆ distribution corresponding to a desired
level of statistical significance.
We are keen to note that the CDM test likely enjoys finite sample guarantees when the true distribution is sampled
from a CDM, owing to the vanishing risk of the MLE shown
in Theorem 3. In experiments that follow, we look at the
finite sample performance of this likelihood ratio test, evaluating this claim empirically and comparing the performance

Discovering Context Effects from Raw Choice Data

of our test to the universal logit test.
3.3. Unifying Existing Choice Models
The CDM and low-rank CDM generalize a number of prominent choice models in a unified framework. In this section we present connections to the work of Tversky and
Simonson (1993), Batsell and Polking (1985), and Chen
and Joachims (2016a;b). This means that our convergence
and identifiability results carry over to these other models,
which all previously lacked such results.
The Tversky-Simonson model. The additive separable
utility model (ASM) is the cornerstone of random utility
modeling in many applications. In the ASM the utility of
item x can be written as an inner product u(x) = wT tx ,
where tx is a feature vector of item x (typically known to the
analyst, but sometimes latent) and the vector w contains the
parameters of the linear model (estimated from data). The
parameters w have a real world interpretation: they are the
weights that an individual places on each attribute. These
can be used to estimate counterfactuals: for example, how
much would an individual rank a new item y that we have
not seen before?
A seminal experiment by Tversky and Kahneman asks individuals to consider a situation where they are purchasing an
object and they learn that the same object is available across
town (a 20 minute drive away) for $5 cheaper (Tversky and
Kahneman, 1985). They then ask whether the individuals
would drive across town to take advantage of this lower
price, essentially a question about their value of time. Individuals are more likely to drive across town when they are
considering purchasing a $10 object compared to when they
are purchasing a $120 object, even though the time/money
tradeoff is identical.
The ASM assumes that the weights are constant across contexts, making the choices in the story above impossible if
the ASM is indeed the true model. Tversky and Simonson (1993) expand the ASM to allow context to adjust the
weights that individuals place on attributes while keeping
the attributes fixed. This approach has a particular psychological interpretation: the presence of certain items makes
some dimensions of a choice more salient than others, an
effect that appears across a variety of decision situations.
This is formalized by setting utility of x in context C to
be uT S (x | C) = w(C)T tx . Tversky and Simonson discuss several ways in which some experimental results can
be modeled using various forms of weights w(C), though
their approach requires both features and context-dependent
weight functions to be hand-engineered. They do not formalize any procedure for how one can learn such a model
from choice data directly. Thus our CDM can be seen as a
method for learning the parameters of a Tversky-Simonson

model directly from data in an efficient manner.
The Batsell-Polking model. Batsell and Polking (1985)
introduces a model of competing product market shares
that can also be written as a truncated expansion of the
log ratio of choice probabilities. The CDM can be viewed
as an alternative parameterization of a third-order BatsellPolking model. There are several significant differences
between the way Batsell and Polking viewed their thirdorder model and how we view the CDM. First, Batsell and
Polking advocated for fitting their models to data using a
hand-tuned least squares procedure whereas we use more
general maximum likelihood techniques. Second, our identifiability and convergence results are entirely new. Their
least-squares procedure understandably has no analogous
guarantees. Lastly, our restriction to low-rank parameterizations is squarely new and can greatly reduce the model
complexity.
The Blade-Chest model. Standard models for competition
build on the Elo rating system for chess (Elo, 1978) and
the TrueSkill rating system for online gaming (Herbrich
et al., 2006). Both of these models assume that individuals
have a one-dimensional latent “skill” parameter that can be
discovered from matchup data between competitors.
The Blade-Chest model (Chen and Joachims, 2016a;b) tries
to model rock-paper-scissors-type intransitivies in pairwise
matchups through a multidimensional latent embedding of
skill. In the language of our CDM, the blade-chest “inner product” model (the authors also consider a “distance”
model) defines the probability that x beats y as:
Pr(x | {x, y}) =

exp(tTx cy )
,
exp(tTx cy ) + exp(tTy cx )

which is precisely a CDM restricted to pairs. We can view
the CDM as a natural extension of the Blade-Chest model
from pairs to larger sets. Considering our negative identifiability result for choice data consisting of only a single set
size (Theorem 2), we conclude that the Blade-Chest model
is not identifiable and requires either explicit or implicit
regularization in order to make the parameters interpretable.

4. Experiments
We now evaluate the CDM and low-rank CDM on data.
Our evaluation includes comparisons with MNL/Luce models and mixed MNL models (McFadden and Train, 2000).
MNL and CDM model likelihoods are optimized using
Adam (Kingma and Ba, 2014), a stochastic gradient descent algorithm with adaptive moment estimation. Mixed
MNL likelihoods are optimized using open source code
from (Ragain and Ugander, 2016). The CDM parameter
optimization is initialized with values corresponding to a
Luce MLE for that dataset. All datasets are pre-existing and

Discovering Context Effects from Raw Choice Data

Figure 1. (a) Approximation error of an estimated CDM in 10 growing datasets validates our convergence theorem. The dashed black line
is a visual guide of the slope 1/m. (b,c,d) The proportion of rejections for a CDM-based hypothesis test of IIA (at a threshold of p < .05)
when the data is generated by a MNL, CDM, and general choice system model as a function of the number of samples. When IIA is true,
the CDM-based test has a 5% of false rejection rate while the test based on the general choice system is highly anti-conservative. When
IIA is false, both tests quickly and correctly reject. All model parameters are described in the main text.

public; replication code for all figures will be released at
publication time.
Simulated Data. We begin with simulated data, which
allows us to validate our theoretical results regarding the
convergence of the MLE in a setting where the underlying
data-generating process is known. Since we know whether
IIA holds in the simulated data, simulated data is also useful
for examining two aspects of the CDM-based hypothesis
test. First, we ask about the power of the test, in other
words, does the test reject IIA when it is not true? Second,
we ask about the conservatism of the test. The nested model
likelihood ratio tests are only valid asymptotically; in our
simulated data we can check whether the CDM over or
under-rejects the null hypothesis of IIA in finite samples.
We consider three data-generating processes: one where the
data is generated from a MNL model (where IIA holds), one
where the data is generated from a CDM, and one where
the data is generated from a general choice system. The
universe has n = 6 items. In the IIA dataset the underlying MNL model has parameters [1, 2, 3, 4, 5, 6]/21. In the
CDM dataset the parameters U = T T C are generated by
sampling elements of both 6x6 matrices T and C i.i.d. from
N (0, 1). The probabilities of the general choice system are
sampled U [0, 1] and renormalized. We sample choice sets
uniformly at random (thus our identification conditions are
quickly met) and then a choice according to the underlying
model. We fit a Luce, CDM, and universal logit model to
the data and look at both the error of the CDM MLE (to evaluate convergence) and the p-value from the nested model
likelihood ratio tests. When the p-value falls below .05 we
say that the hypothesis of IIA is rejected.
In addition, we compare the CDM-based nested test to another nested model test where we use a general choice system as the alternative model. Recall that the general choice
system also nests MNL. However, the general choice system
has combinatorially more parameters.
Figure 1 shows our results. The left panel validates the
1
O( m
) convergence result in Theorem 3. The right three
panels look at how often the hypothesis of IIA is rejected,

Figure 2. The out of sample negative log-likelihood of the MLE
for the SFWork and SFshop datasets under an MNL/Luce model,
mixed MNL model with varying number of mixture components,
and CDMs of varying rank. The CDM outperforms the other
models at all ranks.

out of 1000 independent growing datasets, when the underlying data comes from the three different data generating
processes. We see that the CDM rejects the null less than
5% of the time when the data generating process indeed
satisfies IIA and rejects IIA when it is not true almost all the
time, even with relatively small amounts of data.
By contrast we see that the universal logit requires quite a
lot of data to reach the asymptotically valid coverage, even
with a universe of only 6 items. For finite samples it is
highly anti-conservative, over-rejecting when IIA is true for
small and medium amounts of data.
SFwork/SFshop. We now turn to two real-world datasets:
SFwork and SFshop. These data are collected from a survey
of transportation preferences around the San Francisco Bay
Area (Koppelman and Bhat, 2006). SFshop consists of 3,157
observations of a choice set of transportation alternatives
available to individuals traveling to and from a shopping
center, as well as what transportation that individual actually
chose. SFwork is similar, containing 5,029 observations
consisting of commuting options and the choice made.
These datasets are similar to those employed in many demand estimation applications. For example, Berry et al.
(1995) fit a MNL model to aggregate data in order to estimate the utility function of an average consumer for automobiles as well as how individuals (on average) trade
off various qualities of a car (e.g., gas mileage vs. price).
With access to underlying parameters, the analyst can then

Discovering Context Effects from Raw Choice Data

Figure 3. (Left) The out of sample negative log-likelihood and accuracy of the MLE for the nature photo dataset under an MNL/Luce
model, mixed MNL model with varying number of mixture components, and CDMs of varying rank. The CDM outperforms the other
models at all ranks in terms of both likelihood and accuracy. The target (center) and context (right) vector embeddings for the nature
photo dataset with a rank-2 CDM, with three sample vectors highlighted. An item’s context and target vectors have, on average, a negative
dot product, showing that the addition of an item makes similar items already in the choice set less likely to be chosen.

make counterfactual estimates such as, for example, what
would be the sales of a hypothetical cheaper and higher gas
mileage car? With the SFWork/SFShop data, we can ask
questions like: what would happen if we made certain types
of transit more or less available? Of course, if the underlying assumption (IIA) of the MNL model is wrong, then we
may expect our counterfactual answers to also be wrong.
We run both hypothesis test for IIA (asking: “is there IIA
in the data?”) and examine the out-of-sample performance
of the low-rank CDM (asking: “does the violation of IIA
have meaningful consequence for prediction?”). From the
hypothesis test we obtain a p-value of 10−7 and can strongly
reject IIA. Figure 2 shows the out of sample fit on a held out
20% of the data for low-rank CDMs, mixed MNLs, and an
MNL model, again showing that IIA is not satisfied in this
data. The full-rank unfactorized CDM is omitted from the
figure for improved visibility, but attains an out of sample
log-likelihood of 0.808 and 1.540, respectively for SFwork
and SFshop. Though the unfactorized CDM outperforms
MNL and mixed MNLs, it fails to outperform low-rank
CDMs.
Not Like The Other. We turn to a slightly different dataset
to demonstrate another way the CDM can be used. We
consider the task introduced by Heikinheimo and Ukkonen
(2013) where individuals are shown triplets of nature photographs and asked to choose the one photo that is most
unlike the other two. This task involves comparison-based
choices (Kleinberg et al., 2017) where there are no “irrelevant alternatives” and IIA is clearly violated: consider two
example task where the choice set is two mountains and a
beach vs. two beaches and a mountain.
The dataset is comprised of m = 3355 triplets spanning
n = 120 photos. Because the dataset only has choice sets
of a fixed size, the CDM is not directly identifiable (Theo-

rem 2). We resolve this issue by adding an `2 regularization
term to the log-likelihood. For a small positive regularization penalty, the optimizer then selects the least norm
solution within the null space. We choose a non-negligible
penalty, chosen through cross-validation, to serve the additional purpose of improving model generalization.
We fit low-rank CDMs and see that they handily outperforms a MNL model (i.e. just item-level utilities) and mixed
MNL models on a 20% held-out test set (Figure 3, left).
Though mixed MNL is often a competitive baseline, it is
still a RUM, and cannot model the inherent asymmetric
dominance of this task. The full-rank, unfactorized CDM is
again omitted, but attains an out of sample log-likelihood of
0.843, yet again outperforming MNL and mixed MNL but
falling significantly short of the low rank models. We plot
the vectors learned in the low-rank CDM (Figure 3, right).
We see that similar images are grouped together both as targets and as contexts. We also see an intuitive property of the
dataset: for most items x, tx and cx have a negative inner
product. Essentially, having two copies of the same item in
a choice set makes each copy less likely to be chosen.

5. Conclusion
Existing work has argued that context dependence, and in
particular choice-set dependence, is an important part of human decision-making (Ariely et al., 2003; Slovic, 1995;
Tversky and Simonson, 1993). Tractable tools like the
CDM are therefore crucial to further understanding decisionmaking, providing both good empirical performance and
optimistic worst case guarantees. It should also be noted
that IIA violations are often seen in intertemporal choice,
choice under uncertainty, and choices about cooperation.
Applying a CDM to these domains is an important area of
future work.

Discovering Context Effects from Raw Choice Data

There is separate experimental evidence that human choices
are intransitive in some settings, where people may prefer A
to B and B to C but then C to A. This evidence has given
rise to a theoretical literature on relaxing the transitivity
axiom of rational choice or the regularity axiom of random
utility (Tversky, 1969; Ragain and Ugander, 2016; Benson
et al., 2016). To that end, an axiomatic characterization
of the CDM and the kinds of violations of rational choice
that the model can or cannot represent would be worthy of
further study.
Understanding human decision-making is an important endeavor for both basic and applied science and is becoming
increasingly important in human-centered machine learning and artificial intelligence. We view the introduction
of techniques from machine learning and AI into behavioral science and the flow of realistic models of human
behavior in the other direction as crucial and beneficial
for both fields (Wager and Athey, 2015; Fudenberg and
Peysakhovich, 2014; Naecker, 2015; Epstein et al., 2016;
Peysakhovich and Rand, 2017). We hope that our work
contributes to this important conversation.

Acknowledgments
We thank Fred Feinberg, Stephen Ragain, and Steve Yadlowsky for their helpful comments and feedback. AS was
supported in part by an NSF Graduate Research Fellowship.
JU was supported in part by an ARO Young Investigator
Award.

References
Allenby, G. M. and Rossi, P. E. (1998), ‘Marketing models of consumer heterogeneity’, Journal of econometrics
89(1), 57–78.
Ariely, D., Loewenstein, G. and Prelec, D. (2003), “coherent arbitrariness’: Stable demand curves without stable preferences’, The Quarterly Journal of Economics
118(1), 73–106.
Athey, S. and Levin, J. (2001), ‘Information and competition
in us forest service timber auctions’, Journal of Political
economy 109(2), 375–417.
Batsell, R. R. and Polking, J. C. (1985), ‘A new class of
market share models’, Marketing Science 4(3), 177–198.
Benson, A. R., Kumar, R. and Tomkins, A. (2016), On the
relevance of irrelevant alternatives, in ‘Proceedings of the
25th International Conference on World Wide Web’, International World Wide Web Conferences Steering Committee, pp. 963–973.
Berry, S., Levinsohn, J. and Pakes, A. (1995), ‘Automobile

prices in market equilibrium’, Econometrica: Journal of
the Econometric Society pp. 841–890.
Bordalo, P., Gennaioli, N. and Shleifer, A. (2012), ‘Salience
theory of choice under risk’, The Quarterly journal of
economics p. qjs018.
Bruch, E., Feinberg, F. and Lee, K. Y. (2016), ‘Extracting
multistage screening rules from online dating activity
data’, Proceedings of the National Academy of Sciences
113(38), 10530–10535.
Chen, S. and Joachims, T. (2016a), Modeling intransitivity
in matchup and comparison data, in ‘Proceedings of the
Ninth ACM International Conference on Web Search and
Data Mining’, ACM, pp. 227–236.
Chen, S. and Joachims, T. (2016b), Predicting matchups
and preferences in context, in ‘Proceedings of the 22nd
ACM SIGKDD International Conference on Knowledge
Discovery and Data Mining’, ACM, pp. 775–784.
Chierichetti, F., Kumar, R. and Tomkins, A. (2018), Learning a mixture of two multinomial logits, in ‘International
Conference on Machine Learning’, pp. 960–968.
Elo, A. E. (1978), The rating of chessplayers, past and
present, Arco Pub.
Epstein, Z. G., Peysakhovich, A. and Rand, D. G. (2016),
‘The good, the bad, and the unflinchingly selfish: Cooperative decision-making can be predicted with high
accuracy using only three behavioral types’, Proceedings of the 17th Economics and Computation Conference
(EC17) .
Fox, C. R. and Tversky, A. (1995), ‘Ambiguity aversion
and comparative ignorance’, The Quarterly Journal of
Economics 110(3), 585–603.
Fudenberg, D. and Levine, D. K. (2012), ‘Timing and selfcontrol’, Econometrica pp. 1–42.
Fudenberg, D. and Peysakhovich, A. (2014), Recency,
records and recaps: Learning and non-equilibrium behavior in a simple decision problem, in ‘Proceedings of
the fifteenth ACM conference on Economics and Computation’, ACM, pp. 971–986.
Heikinheimo, H. and Ukkonen, A. (2013), The crowdmedian algorithm, in ‘First AAAI Conference on Human
Computation and Crowdsourcing’.
Herbrich, R., Minka, T. and Graepel, T. (2006), TrueskillTM :
a bayesian skill rating system, in ‘Proceedings of the 19th
International Conference on Neural Information Processing Systems’, MIT Press, pp. 569–576.

Discovering Context Effects from Raw Choice Data

Kingma, D. and Ba, J. (2014), ‘Adam: A method for stochastic optimization’, arXiv preprint arXiv:1412.6980 .
Kleinberg, J., Mullainathan, S. and Ugander, J. (2017),
Comparison-based choices, in ‘Proceedings of the 2017
ACM Conference on Economics and Computation’,
ACM, pp. 127–144.
Koppelman, F. S. and Bhat, C. (2006), ‘A self instructing
course in mode choice modeling: multinomial and nested
logit models’.
Kreps, D. (1988), Notes on the Theory of Choice, Westview
press.
Liberman, V., Samuels, S. M. and Ross, L. (2004), ‘The
name of the game: Predictive power of reputations versus situational labels in determining prisoner?s dilemma
game moves’, Personality and social psychology bulletin
30(9), 1175–1185.
List, J. A. (2007), ‘On the interpretation of giving in dictator
games’, Journal of Political economy 115(3), 482–493.
Luce, R. D. (1959), Individual Choice Behavior a Theoretical Analysis, John Wiley and sons.
Manski, C. F. (1977), ‘The structure of random utility models’, Theory and decision 8(3), 229–254.
McFadden, D. (1980), ‘Econometric models for probabilistic choice among products’, Journal of Business pp. S13–
S29.
McFadden, D. and Train, K. (2000), ‘Mixed mnl models
for discrete response’, Journal of applied Econometrics
15(5), 447–470.
McFadden, D., Tye, W. B. and Train, K. (1977), An application of diagnostic tests for the independence from
irrelevant alternatives property of the multinomial logit
model, Institute of Transportation Studies, University of
California.
Mikolov, T., Sutskever, I., Chen, K., Corrado, G. S. and
Dean, J. (2013), Distributed representations of words and
phrases and their compositionality, in ‘Advances in neural
information processing systems’, pp. 3111–3119.
Muraven, M. and Baumeister, R. F. (2000), ‘Self-regulation
and depletion of limited resources: Does self-control
resemble a muscle?’, Psychological bulletin 126(2), 247.
Naecker, J. (2015), ‘The lives of others: Predicting donations with non-choice responses’.
Park, S.-J. and Choi, S. (2013), ‘A theoretical note on the
number of free parameters in the elimination-by-aspects
model’, Journal of Mathematical Psychology 57(5), 255–
259.

Peysakhovich, A. and Rand, D. G. (2015), ‘Habits of virtue:
Creating norms of cooperation and defection in the laboratory’, Management Science 62(3), 631–647.
Peysakhovich, A. and Rand, D. G. (2017), ‘In-group favoritism caused by pokemon go and the use of machine
learning to learn its mechanisms’, SSRN .
Ragain, S., Peysakhovich, A. and Ugander, J. (2018), ‘Improving pairwise comparison models using empirical
bayes shrinkage’, arXiv preprint arXiv:1807.09236 .
Ragain, S. and Ugander, J. (2016), Pairwise choice markov
chains, in ‘Advances in Neural Information Processing
Systems’, pp. 3198–3206.
Resnick, P. and Varian, H. R. (1997), ‘Recommender systems’, Communications of the ACM 40(3), 56–58.
Rudolph, M., Ruiz, F., Mandt, S. and Blei, D. (2016), Exponential family embeddings, in ‘Advances in Neural
Information Processing Systems’, pp. 478–486.
Ruiz, F. J., Athey, S. and Blei, D. M. (2017), ‘Shopper: A
probabilistic model of consumer choice with substitutes
and complements’, arXiv preprint arXiv:1711.03560 .
Schapire, R. E., Cohen, W. W. and Singer, Y. (1998), ‘Learning to order things’, Advances in Neural Information Processing Systems 10(451), 24.
Shah, N. B., Balakrishnan, S., Bradley, J., Parekh, A., Ramchandran, K. and Wainwright, M. J. (2016), ‘Estimation
from pairwise comparisons: Sharp minimax bounds with
topology dependence’, The Journal of Machine Learning
Research 17(1), 2049–2095.
Slovic, P. (1995), ‘The construction of preference.’, American psychologist 50(5), 364.
Srivastava, N. and Schrater, P. R. (2012), Rational inference
of relative preferences, in ‘Advances in neural information processing systems’, pp. 2303–2311.
Tversky, A. (1969), ‘Intransitivity of preferences’, Preference, Belief, and Similarity p. 433.
Tversky, A. (1972), ‘Elimination by aspects: A theory of
choice.’, Psychological review 79(4), 281.
Tversky, A. and Kahneman, D. (1985), The framing of decisions and the psychology of choice, in ‘Environmental
Impact Assessment, Technology Assessment, and Risk
Analysis’, Springer, pp. 107–129.
Tversky, A. and Simonson, I. (1993), ‘Context-dependent
preferences’, Management science 39(10), 1179–1189.

Discovering Context Effects from Raw Choice Data

Wager, S. and Athey, S. (2015), ‘Estimation and inference
of heterogeneous treatment effects using random forests’,
arXiv preprint arXiv:1510.04342 .
Wilks, S. S. (1938), ‘The large-sample distribution of the
likelihood ratio for testing composite hypotheses’, The
Annals of Mathematical Statistics 9(1), 60–62.

Discovering Context Effects from Raw Choice Data

A. Proofs of Identifiability
There are three main theorems proven in this section of the appendix. The first two are given in the main text.
Theorem 1. A CDM is identifiable from a dataset D if CD contains comparisons over all choice sets of two sizes k, k 0 ,
where at least one of k, k 0 is not 2 or n.
Theorem 2. No rank r CDM, 1 ≤ r ≤ n, is identifiable from a dataset D if CD contains only choices from sets of a single
size.
Theorem 4. A full rank CDM is identifiable from a dataset D if and only if the rank of an integer design matrix G(D),
properly constructed, is n(n − 1) − 1.
We begin with a few definitions and simple facts, providing proofs for clarity. Given these facts, main workhorse for proving
our identifiability theorems is Lemma 2.
Since the CDM parameters are invariant to constant offsets, we choose (for the full rank case) an offset such that
 X

X
exp
uxz = 1.
x∈X

(4)

z∈X \x

P
Note that this implies Px,X = exp( z∈X \x uxz ).
Because the CDM is a logit-based model, it will be much easier to work with log probability ratios. To that end, we define,
for a choice set C 3 x,
βx,C = log(Px,C /P¯C ),
(5)
1
Q
where P¯C = ( y∈C Py,C ) |C| , the geometric average of the probabilities.

Fact 1. Given a choice set C of size s, there is a 1-to-1 mapping between the set of log probability ratios {βx,C : x ∈ C}
and the set of probabilities {Px,C : x ∈ C}.
Proof. Uniquely find βx,C ∀x ∈ C using the mapping in equation (5). Now, for the other direction, observe that
P
/P¯
P exp βx,C
P x,C C ¯ = Px,C ∀x ∈ C.
exp βy,C =
Py,C /PC
y∈C

y∈C

Hence, statements regarding identifiability between CDM parameters and the β’s can be mapped to statements about
identifiability between CDM parameters and probabilities. It will also be much easier to relate differences in CDM
parameters of the following pattern, uxy − uyx and uxz − uyz ∀x 6= y 6= z, to the β’s. Because CDM is shift invariant,
these differences between parameters uniquely identify the parameters when the offset constraint (4) is applied.
Fact 2. Under the offset constraint (4), CDM parameter differences uxy − uyx and uxz − uyz , ∀x 6= y 6= z, have a 1-to-1
mapping with CDM parameters uxy ∀x 6= y.
Proof. It is immediately obvious that given the parameters, we can uniquely construct the differences. For the other direction,
consider that
X
 X

1
uxy = uxy +
log
exp
uwz
n−1
w∈X
z∈X \z



X
X
1
=
log
exp
uwz − uxy
n−1
w∈X
z∈X \w



X
X
1
=
log
exp [uwy − uxy ]1(w 6= y) +
uwz − uxy
n−1
w∈X
z∈X \w,y



X
X
1
=
log
exp [uwy − uxy ]1(w 6= y) +
[uzy − uxy ] + [uyz − uzy ] + [uwz − uyz ] .
n−1
w∈X

z∈X \w,y

Discovering Context Effects from Raw Choice Data

Here the first equality follows because the second term on the right hand size is 0, by the offset constraint (4). The
remaining equalities are simply algebraic manipulations. The last equality is purely a function of differences following the
aforementioned statement, therefore proving the claim.
Hence, statements regarding identifiability between CDM parameter differences of the pattern uxy − uyx and uxz − uyz
∀x 6= y 6= z and the β’s can be mapped to statements about identifiability between CDM parameters and probabilities.
We now link the above facts with the following: the β’s can be conveniently represented in terms of these CDM parameter
differences. Using u ∈ Rn(n−1) to refer to a vectorization of the parameters, with elements of the vector indexed as we have
so far (i.e., uxy finds the subset of (n − 1) entries associated with item x, and finds the contextual role of item y within
those entries), we have the following fact.


P
P
1
Fact 3. For any set C and any x ∈ C, βx,C = |C|
y∈C\x [uxy − uyx ] +
z∈C\{x,y} [uxz − uyz ] .
Proof. From the definition of βx,C in equation (5) we have:
Px,C
βx,C = log( ¯ )
PC
X
1 X X
uyz
=
uxz −
|C|
y∈C z∈C\y
z∈C\x
X
1 X 
=
[uxy − uyx ] +
|C|
y∈C\x


[uxz − uyz ]

z∈C\{x,y}

Here the final equality is a rearrangement of terms into the parameter differences of interest.
We introduce an indicator vector gx,C ∈ Zn(n−1) that contains non-zero values at the relevant indices of u so that the final
equality can be rewritten as

X
1 X 
1 T
g u.
(6)
[uxy − uyx ] +
[uxz − uyz ] =
|C|
|C| x,C
y∈C\x

z∈C\{x,y}

Lastly, we state and prove the following lemma, which will serve as the departure P
point for the three proofs. Consider a
collection CD of unique subsets of the universe X of sizes 2 or greater, and let Ω = C∈CD |C| be the sum of the sizes of
all the sets. We then refer to a system design matrix G(CD ) ∈ ZΩ×n(n−1) as the linear system relating the parameters u to
the scaled log probability ratios |C|βx,C . We construct such a matrix by concatenating, for each set C ∈ CD , for every item
T
x ∈ C, the indicator vector gx,C
, as defined in (6), as a row.
Lemma 2. The full rank CDM is identifiable up to a shift for collection CD iff rank(G(CD )) = n(n − 1) − 1.
Proof. Clearly, rank(G(CD )) ≤ n(n − 1) − 1, due to the shift invariance of u. That is, G is only specified in terms of
differences of elements in u, and hence null(G(CD )) 3 1.
Suppose first that rank(G(CD )) = n(n − 1) − 1. Then, for two vectors u1 , u2 ∈ Rn(n−1) , if u1 6= α1 + u2 for any α ∈ R
1
then β1 = C−1 Gu1 6= Gu2 = C−1 β2 , where C−1 ∈ RΩ×Ω is the diagonal matrix with values are |C|
, ∀C ∈ CD (which
undoes the scaling of the scaled log probability ratios). Since Fact 1 states that β’s have a unique mapping with the choice
system probabilities over the collection CD , u vectors are identifiable up to a shift for a given set of probabilities over the
collection CD .
Suppose now that rank(G(CD )) < n(n − 1) − 1. Then, there exists some vector v ∈ null(G(CD )), v 6= α1 for any α, for
which C−1 G(CD )(u1 ) = C−1 G(CD )(u1 + v). Again since the β’s uniquely map to the probabilities, there exist two u
vectors different beyond a shift that map to the same set of choice system probabilities. Hence, u is not identifiable up to a
shift.
We add as an additional note that under the offset constraint (4), the CDM parameters are uniquely identifiable, following the
analysis of Fact 2. Now we proceed to proving the individual theorems, each of which essentially boils down to analyzing

Discovering Context Effects from Raw Choice Data

the rank of the system design matrix G(CD ) of collections CD comprised of sets of a single size, of collections CD comprised
of sets of multiple sizes, and formalizing the calculation of G(CD ) for a given dataset.
A.1. Proof of Theorem 1
Proof. It is sufficient to show that the statement holds for the full rank case, as further constraining the parameters using rank
conditions does not affect identifiability. Note that the statement of the theorem is a sufficient condition for identifiability,
and for low-rank CDMs in particular it is possibly an overly strong requirement.
Consider two different subset sizes s and t, and assume wlog that t is within [3, n−1]. For any {x, y}, consider Cwz 3 {x, y},
C
|Cwz | = t − 1, indexed by items {w, z} ∈ X , {w, z} ∈
/ Cwz . Let Awz = Cwz ∪ {w} and Bwz = Cwz ∪ {z}. Using βxy
as shorthand for βx,C − βy,C ., we have that
Awz
Bwz
βxy
− βxy
= [uxw − uyw ] − [uxz − uyz ].

Now, if s < t, Take D 3 {x, y} of size s and A (of size t) such that D ⊂ A. Now,
X
A
D
βxy
− βxy
=
[uxq − uyq ].
q∈A\D

Then, we can solve for [uxw − uyw ] as follows:
[uxw − uyw ] =

X
1
A
D
Awq
Bwq
(βxy
− βxy
+
βxy
− βxy
).
t−s
q∈A\D

With this relation we see that [uxy − uyx ] =

A
βxy

−

P

q∈A\{x,y} [uxq

− uyq ].

P
D
A
If s > t, Take D of size s such that A ⊂ D. We then see that βxy
− βxy
= q∈D\A [uxq − uyq ], and as before, we can
solve for [uxw − uyw ] as:
X
1
Bwq
D
A
Awq
).
− βxy
[uxw − uyw ] =
(βxy
− βxy
+
βxy
s−t
q∈D\A

With this relation we see that [uxy − uyx ] =

D
βxy

−

P

q∈D\{x,y} [uxq

− uyq ].

Applying Facts 1 and 2, statements regarding identifiability between CDM parameter differences of the pattern uxy − uyx
and uxz − uyz ∀x 6= y 6= z and the β’s can be mapped to statements about identifiability between CDM parameters and
probabilities. We then conclude that the CDM parameters can be uniquely recovered from probabilities over two choice sets.
Thus, comparisons over all choice sets of two sizes uniquely identify the CDM.
A.2. Proof of Theorem 2
Proof. To prove this claim, we separately consider three conditions on the set size s: s = 2, s = n, and 3 ≤ s ≤ n − 1. For
each case, we first demonstrate the result for the full rank CDM and then show that every low rank CDM suffers from the
same problem.
In terms of notation, we consider a U “matrix”, U ∈ Rn×n , organizing the parameters uxy , ∀x 6= y, with the matrix
diagonal taking on arbitrary unused values. For the low rank case, the U matrix is the dot product of the matrix of target
vectors T ∈ Rn×r and the matrix of context vector C ∈ Rn×r . Here, the diagonal formed by tx · cx can be arbitrary and is
C
unused. We also use βxy
as shorthand for βx,C − βy,C .
(i) s = 2
C
For any pair C = {x, y}, βxy
= uxy − uyx . Thus, increasing both uxy and uyx by the same value leaves the pairwise
probabilities unchanged. Thus the CDM parameter U matrix is only specified up to a symmetric matrix A, where U + A
produces the same pairwise probabilities as U .

Any rank r matrix also suffers from the same identifiability issue: consider T + B and C + F , where B = βC + γ1 αβT ,
and F = αT + γ2 αβC for α, β ∈ R, γ1 , γ2 ∈ {0, 1}, γ1 6= γ2 . These scalar parameters form a subset of perturbations that
modify the dot product U = T C T only by a symmetric matrix, thereby leaving the pairwise probabilities unchanged.

Discovering Context Effects from Raw Choice Data

(ii) s = n
P
X
For the full universe X , βxy
= uxy − uyx + z∈X \{x,y} uxy − uyx . Consider then any matrix A ∈ Rn×n that has
(A − diag(A))1 = g1, where g is a constant and 1 ∈ Rn×1 is the vector of all ones. This is, any matrix A where the rows
(not including the diagonal) all sum to the same constant. Then U and U + A have the same choice probabilities on the full
universe set.
For the identifiability problem to transfer to the rank r case, we find T + γ1 B and C + γ2 F where γ1 , γ2 ∈ {0, 1}, γ1 6= γ2
such that the perturbation to a U matrix follows the same properties as the matrix A in the full rank case above. We show
how to find such a matrix for the rank 1 case, which is sufficient for all rank r. Consider U = tcT , where t, c ∈ Rn×1 . We
g
may perturb t by a vector b ∈ Rn×1 where bx = (cT 1−c
, ∀x, for any constant g, as long as (cT 1 − cx ) 6= 0 ∀x. In case
x)
(cT 1 − cy ) = 0 for any y, set g = 0, bx = 0 ∀x 6= y, and by to any arbitrary value. The perturbation to U is then bcT , and
we leave the reader to verify ((bcT ) − diag(bcTP
))1 = g1, thereby not changing the universe probabilities. Similarly, we
1
1
1
may perturb c by a vector f , where fx = g[ n−1
z ( tz ) − tx ] if tx 6= 0, ∀x. In case ty = 0 for some y, set g = 0, fx = 0,
∀x 6= y, and fy to any arbitrary value. The perturbation to U is then tT f , and we have ((tf T ) − diag(tf T ))1 = g1, thereby
not changing the universe probabilities.
(iii) 3 ≤ s ≤ n − 1
For all other set sizes, we again show the identifiability issue for the full rank case, and show that the null space in
the parameters also transfers over to the rank r case. Consider any C 3 {x, y}, {w, z} ∈
/ C of size s − 1 for any
{x, y, w, z}. Take Cw = C ∪ {w}, and Cz = C ∪ {z}. Note that we can always identify such sets because we are in
Cw
Cz
the size regime 3 ≤ s ≤ n − 1. Then, βxy
− βxy
= [uxw − uyw ] − [uxz − uyz ]. Thus, given [uxz − uyz ] for a single
P
Cw
Cz
Cz
z, we can set [uxw − uyw ] = βxy − βxy + [uxz − uyz ], and set [uxy − uyx ] = βxy
− q∈Cz \{x,y} [uxq − uyq ] =
P
C
Cz
Cz
βxy
− q∈Cz \{x,y} [βxy
− βxyq ] − (s − 2)[uxz − uyz ] to keep the choice probabilities unchanged. This invariance implies
that the U matrix can be perturbed by the rank-1 matrix a1T where a ∈ Rn×1 is any vector and the choice probabilities are
unchanged.
We can now show that such perturbations to U can be produced in the rank r case by modifiying C. Consider C + 1bT where
b ∈ Rr×1 . Then, U = T (C + 1bT )T = T C T + (T b)1T , which is a perturbation to U of the proper form. Through these
three cases, we have now shown that every rank r CDM cannot be uniquely identified even when provided all comparisons
of a single choice set size.
A.3. Proof of Theorem 4
Proof. Consider a dataset of the form D = {(xj , Cj )}m
j=1 of a decision maker making choices: a datapoint j represents
a decision scenario,
and
contains
C
,
the
context
provided
in that decision, and xj ∈ Cj , the item chosen in the context.
j
Pm
Recall that ΩD = j=1 |Cj |. Construct then a matrix G(D) ∈ ZΩD ×n(n−1) by concatenating, for every datapoint j, for
T
every item x ∈ Cj , the indicator vector gx,C
as defined in equation (6) as a row. Denoting CD as the collection of unique
j
choice sets in dataset D, it is clear that rank(G(D)) = rank(G(CD )), where the latter matrix is defined as in Lemma 2 for
the collection CD . This equality of ranks follows from the fact that the set of unique rows of G(D) are the same as those in
G(CD ), and repeated rows do not change the rank of a matrix. Thus, we can directly test whether a dataset results in an
identifiable CDM by testing the rank of G(D).

Discovering Context Effects from Raw Choice Data

B. Convergence proof
We restate and then prove Theorem 3.
Theorem 3. Let u? denote the true CDM model from which data is drawn. Let ûMLE denote the maximum likelihood
solution. Assume CD identifies the CDM. For any u? ∈ UB = {u ∈ Rd : kuk∞ ≤ B, 1T u = 0}, and expectation taken over
the dataset D generated by the CDM model,

d−1
2
E kûMLE (D) − u? k2 ≤ cB,kmax
,
m
where kmax refers to the maximum choice set size in the dataset, and cB,kmax is a constant that depends on B, kmax and the
spectrum of the design matrix G(D).
Proof. We describe the sampling process as follows using the same notation as before. Given some true CDM u? ∈ UB , for
each datapoint j ∈ [m] we have the probability of choosing item x from set Cj as
P
exp( z∈Cj \x u?xz )
?
P
P(yj = x|u , Cj ) = P
.
?
y∈Cj exp(
z∈Cj \y uyz ))
We now introduce notation that will let us represent the above expression in a more compact manner. Because our datasets
involve choice sets of multiple sizes, we use kj ∈ [kmin , kmax ] to denote the choice set size for datapoint j. Extending a
similar concept in (Shah et al., 2016) to the multiple set sizes, and the more complex structure of the CDM, we then define
matrices Ej,kj ∈ Rd×kj , ∀j ∈ [m] as follows: Ej,kj has a column for every item y ∈ Cj (and hence kj columns), and
the column corresponding to item y ∈ Cj has a one at P
the position of each uyz for z ∈ Cj \ y, and zero otherwise. This
construction allows us to write the familiar expressions z∈Cj \y uyz , for each y, simply as a single vector-matrix product
P
P
P
uT Ej,kj = [ z∈Cj \y1 uy1 z , z∈Cj \y2 uy2 z , . . . z∈Cj \yk uykj z ] ∈ R1×kj .
j

k

Next, we define a collection of functions Fk : R 7→ [0, 1], ∀k ∈ [kmin , kmax ] as
exp(x1 )
Fk ([x1 , x2 , . . . , xk ]) = Pk
,
l=1 exp(xl )
where the numerator always corresponds to the first entry of the input. These functions Fk have several properties that will
become useful later in the proof. First, it is easy to verify that all Fk are shift-invariant, that is, Fk (x) = Fk (x + c1), for
any scalar c. Next, we show that all Fk are strongly log-concave, that is, ∇2 (− log(Fk (x)))  Hk for some Hk ∈ Rk×k ,
λ2 (Hk ) > 0. The proof for this property stems directly from its counterpart in (Shah et al., 2016), as multiple set sizes does
not affect the result. We compute the Hessian as:
∇2 (− log(Fk (x))) =

exp(x1 )
(hexp(x), 1idiag(exp(x)) − exp(x) exp(x)T ),
(hexp(x), 1i)4

where exp(x) = [ex1 , . . . , exk ]. Note that
exp(x1 )
v T (hexp(x), 1idiag(exp(x)) − exp(x) exp(x)T )v
(hexp(x), 1i)4
exp(x1 )
=
(hexp(x), 1ihexp(x), v 2 i − hexp(x), vi2 )
(hexp(x), 1i)4
≥ 0,

v T ∇2 (− log(Fk (x)))v =

where v 2 refers to the element-wise square operation on vector v. While the final inequality is an expected consequence
of the positive
semidefiniteness
of the Hessian, we note that it also follows from an application of Cauchy-Schwarz to the
p
p
vectors exp(x) and exp(x) v, and is thus an equality if and only if v ∈ span(1). Thus, we have that the smallest
eigenvalue λ1 (∇2 (− log(Fk (x)))) = 0 is associated with the vector 1, a property we expect from shift invariance, and that
the second smallest eigenvalue λ2 (∇2 (− log(Fk (x)))) > 0. Thus, we can state that
1
∇2 (− log(Fk (x)))  Hk = βk (I − 11T ),
(7)
k

Discovering Context Effects from Raw Choice Data

where
βk :=

min

x∈[−(k−1)B,(k−1)B]k

λ2 (∇2 (− log(Fk (x)))),

(8)

and it’s clear that βk > 0. The minimization is taken over x ∈ [−(k − 1)B, (k − 1)B]k since each xi is a sum of k − 1
values of the u vector, each entry of which is in [−B, B]. We conclude that all Fk are strongly log-concave.
As a final notational addition, in the same manner as (Shah et al., 2016) but accounting for multiple set sizes, we define
k permutation matrices R1,k , . . . , Rk,k ∈ Rk,k , ∀k ∈ [kmin , kmax ], representing k cyclic shifts in a fixed direction. That is,
these matrices allow for the cycling of the entries of row vector v ∈ R1×k so that any entry can become the first entry of the
vector, for any of the relevant k. This construction allows us to represent any choice made from the choice set Cj as the first
element of the vector x that is input to F , thereby placing it in the numerator.
Given the notation introduced above, we can now state the probability of choosing the item x from set Cj compactly as:
P(yj = x|u? , Cj ) = P(yj = x|u? , kj , Ej,kj ) = Fkj (u? T Ej,kj Rx,kj ).
We can then rewrite the full-rank CDM likelihood as
Y
sup
u∈UB

Fkj (uT Ej,kj Rxj ,kj ),

(xj ,kj ,Ej,kj )∈D

and the scaled negative log-likelihood as
`(u) = −

1
m

m

X

log(Fkj (uT Ej,kj Rxj ,kj )) = −

(xj ,kj ,Ej,kj )∈D

kj

1 XX
1[yj = i] log(Fkj (uT Ej,kj Ri,kj )).
m j=1 i=1

Thus,
ûMLE = arg max `(u).
u∈UB

The compact notation makes the remainder of the proof a straightforward application of results from convex analysis: we
first demonstrate that the scaled negative log-likelihood is strongly convex with respect to a semi-norm2 , and we use this
property to show the proximity of the MLE to the optimal point as desired. The remainder of the proof exactly mirrors that
in (Shah et al., 2016) with a few extra steps of accounting created by the multiple set sizes. The notable exception is in the
definition of L, and conditions about its eigenvalues that tie back to the previous results about identifiability. While in (Shah
et al., 2016) there is a clear connection of L to the graph Laplacian matrix of the item comparison graph, it is unclear here
how to interpret L as a graph Laplacian.
First, we have the gradient of the negative log-likelihood as
m

∇`(u) = −

kj

1 XX
1[yj = i]Ej,kj Ri,kj ∇ log(Fkj (uT Ej,kj Ri,kj )),
m j=1 i=1

and the Hessian as
m

∇2 `(u) = −
2

kj

1 XX
T
T
1[yj = i]Ej,kj Ri,kj ∇2 log(Fkj (uT Ej,kj Ri,kj ))Ri,k
Ej,k
.
j
j
m j=1 i=1

A semi-norm is a norm that allows non-zero vectors to have zero norm.

Discovering Context Effects from Raw Choice Data

We then have, for any vector z ∈ Rd ,
kj

m

1 XX
T
T
z ∇ `(u)z = −
1[yj = i]z T Ej,kj Ri,kj ∇2 log(Fkj (uT Ej,kj Ri,kj ))Ri,k
Ej,k
z
j
j
m j=1 i=1
T

2

m

kj

m

kj

m

kj

=

1 XX
T
T
Ej,k
z
1[yj = i]z T Ej,kj Ri,kj ∇2 (− log(Fkj (uT Ej,kj Ri,kj )))Ri,k
j
j
m j=1 i=1

≥

1 XX
T
T
1[yj = i]z T Ej,kj Ri,kj Hk Ri,k
Ej,k
z
j
j
m j=1 i=1

1 XX
1
T
T
=
1[yj = i]z T Ej,kj Ri,kj βkj (I − 11T )Ri,k
Ej,k
z
j
j
m j=1 i=1
kj
m

kj

≥ βkmax

1 XX
1
T
1[yj = i]z T Ej,kj (I − 11T )Ej,k
z
j
m j=1 i=1
kj

= βkmax

1 X T
1
T
z Ej,kj (I − 11T )Ej,k
z.
j
m j=1
kj

m

The first line follows from applying the definition of the Hessian. The second line follows from pulling the negative sign
into the ∇2 term. The third and fourth line follow from (7), strong log-concavity of all Fk . The fifth line follows from the
pulling out βkj and lower bounding it with βkmax and recognizing that Hk is invariant to permutation matrices. The sixth line
follows from removing the inner sum since the terms are independent of i. Now, defining the matrix L as
m

1 X
1
T
L=
Ej,kj (I − 11T )Ej,k
,
j
m j=1
kj
we first note a few properties of L. First, it is easy to verify that L1 = 0, and hence span(1) ⊆ null(L). Moreover,
we now show that λ2 (L) > 0, that is, null(L) ⊆ span(1). Consider the matrix G(D) in Theorem 4. Define a matrix
−1
ΩD ×ΩD
X(D) = C−1
is the diagonal matrix with values are k1j , for every datapoint j, for every item
D G(D), where CD ∈ R
x ∈ Cj . Simple calculations show that,
L=

1
X(D)T X(D)  0.
m

As a consequence of the properties of matrix rank, we then have that rank(L) = rank(X(D)) = rank(G(D)). Thus, from
Theorem 4, we have that if the dataset D identifies the CDM, rank(L) = d − 1, and hence λ2 (L) > 0. With this matrix, we
can write,
z T ∇2 `(u)z ≥ βkmax z T Lz = βkmax ||z||2L ,
which is equivalent to stating that `(u) is βkmax -strongly convex with respect to the L semi-norm at all u ∈ UB . Since
u? , ûMLE ∈ UB , strong convexity implies that
βkmax ||ûMLE − u? ||2L ≤ `(ûMLE ) − `(u? ) − h∇`(u? ), ûMLE − u? i.
Further, we have
`(ûMLE ) − `(u? ) − h∇`(u? ), ûMLE − u? i ≤ −h∇`(u? ), ûMLE − u? i
≤ |(ûMLE − u? )T ∇`(u? )|
1

1

†

= |(ûMLE − u? )T L 2 L 2 ∇`(u? )|
1

1

†

≤ ||L 2 (ûMLE − u? )||2 ||L 2 ∇`(u? )||2
= ||ûMLE − u? ||L ||∇`(u? )||L† .
Here the third line follows from the fact that 1T (ûMLE − u? ) = 0, and so (ûMLE − u? ) ⊥ null(L), which also implies that
1

1

1

†

(ûMLE − u? ) ⊥ null(L 2 ), and so (ûMLE − u? )L 2 L 2 = (ûMLE − u? ). The fourth line follows from Cauchy-Schwarz. Thus,

Discovering Context Effects from Raw Choice Data

we can conclude that
||ûMLE − u? ||2L ≤

1
1
||∇`(u? )||2L† = 2 ∇`(u? )T L† ∇`(u? ).
βk2max
βkmax

Now, all that remains is bounding the term on the right hand side. Recall the expression for the gradient
m

∇`(u? ) = −

kj

m

1 X
1 XX
1[yj = i]Ej,kj Ri,kj ∇ log(Fkj (u? T Ej,kj Ri,kj )) = −
Ej,kj Vj,kj ,
m j=1 i=1
m j=1

where in the equality we have defined Vj,kj ∈ Rkj as
kj
X

Vj,kj :=

1[yj = i]Ri,kj ∇ log(Fkj (u? T Ej,kj Ri,kj )).

i=1

Useful in our analysis will be an alternate expression for the gradient,
m

∇`(u? ) = −

1 X
1
Ej,kj Vj,kj = − X(D)T V,
m j=1
m

where we have defined V ∈ RΩD as the concatenation of all Vj,kj .
Now, we have
exp(xl )
(∇ log(Fk (x)))l = 1[l = 1] − Pk
,
p=1 exp(xp )
Pk
l)
T
) = 0, and hence, Vj,k
1 = 0.
and so h∇ log(Fk (x)), 1i = Fk1(x) h∇Fk (x), 1i = l=1 (1[l = 1] − Pkexp(x
j
exp(x )
p=1

(9)

p

1
T
k 11 ).

We now consider the matrix Mk = (I −
We note that Mk has rank k − 1, with its nullspace corresponding to the
span of the ones vector. We state the following identities:
1

1

Mk = Mk† = Mk2 = Mk† 2 .
1

1

Thus we have Mkj Vj,kj = Mkj 2 Mk2j Vj,kj = Mk Mk† Vj,kj = Vj,kj , where the last equality follows since Vj,kj is orthogonal
to the nullspace of Mkj . Now, taking expectations over the dataset, we have,
kj
hX
i
E[Vj,kj ] = E
1[yj = i]Ri,kj ∇ log(Fkj (u? T Ej,kj Ri,kj ))
i=1
kj

=

i
X h
E 1[yj = i] Ri,kj ∇ log(Fkj (u? T Ej,kj Ri,kj ))
i=1

=

kj
X

Fkj (u? T Ej,kj Ri,kj )Ri,kj ∇ log(Fkj (u? T Ej,kj Ri,kj ))

i=1

=

kj
X

Ri,kj ∇Fkj (u? T Ej,kj Ri,kj )

i=1

= ∇z

kj
X


Fkj (z T Ri,kj ) = ∇z (1) = 0.

i=1

Here, the third equality follows from applying the expectation to the indicator and retrieving the true probability. The
fourth line follows from applying the definition of gradient of log, and the final line from performing a change of variables
z = u? T Ej,kj , pulling out the gradient and undoing the chain rule, and finally, recognizing that the expression sums to 1 for
any z, thus resulting in a 0 gradient. We note that an immediate consequence of the above result is that E[V ] = 0, since V is
simply a concatenation of the individual Vj,kj .

Discovering Context Effects from Raw Choice Data

Next, we have
E[∇`(u? )T L† ∇`(u? )] =

m m
i
1 hXX T
T
†
E
V
E
L
E
V
l,k
l,k
j,k
j,k
l
l
j
j
m2
j=1
l=1

m m
i
1
1
1 hXX T
T
L† El,kl Mkl 2 Vl,kl
= 2E
Vj,kj Mkj 2 Ej,k
j
m
j=1
l=1

m
i
1
1
1 hX T
T
†
2V
L
E
M
= 2E
Vj,kj Mkj 2 Ej,k
j,k
k
j,k
j
j
j
j
m
j=1

≤

m
i1 X


1
1
1 h
T
E sup ||Vl,kl ||22
tr Mkj 2 Ej,k
L† Ej,kj Mkj 2
j
m l∈[m]
m j=1

m

i1 X

1
1
1 h
T
E sup ||Vl,kl ||22
tr L† Ej,kj Mkj 2 Mkj 2 Ej,k
j
m l∈[m]
m j=1
i 

1 h
= E sup ||Vl,kl ||22 tr L† L
m l∈[m]
i
1 h
= E sup ||Vl,kl ||22 (d − 1),
m l∈[m]

=

where the second line follows from identities of the M matrix, the third from the independence of the Vj,kj , the fourth from
an upper bound of the quadratic form, the fifth from the properties of trace, the sixth from the definition of the matrix L, and
the last from the value of the trace, which is simply the identity matrix with one zero entry in the diagonal. We then have
that,
sup ||Vj,kj ||22 = sup
j∈[m]

kj
X

j∈[m] i=1

= sup

kj
X

T
1[yj = i]∇ log(Fkj (uT Ej,kj Ri,kj ))T Ri,k
Ri,kj ∇ log(Fkj (uT Ej,kj Ri,kj ))
j

1[yj = i]∇ log(Fkj (uT Ej,kj Ri,kj ))T ∇ log(Fkj (uT Ej,kj Ri,kj ))

j∈[m] i=1

= sup

kj
X

1[yj = i]||∇ log(Fkj (uT Ej,kj Ri,kj ))||22

j∈[m] i=1

≤

sup
v∈[−(kmax −1)B,(kmax −1)B]kmax

||∇ log(Fkmax (v))||22 ≤ 2,

T
where Ri,k
Ri,kj in the first line is simply the identity matrix. For the final line, recalling the expression for the log gradient
j
of Fk in equation (9), it is straightforward to show that supv∈[−(kmax −1)B,(kmax −1)B]kmax ||∇ log(Fkmax (v))||22 is always upper
bounded by 2. We again note that an immediate consequence of this is that the absolute value of every element of V is also
upper bounded by 2.

Bringing this back to E[∇`(u? )T L† ∇`(u? )], we have that
2(d − 1)
.
m
This immediately yields a bound on the expected risk in the L semi-norm, which is,
E[∇`(u? )T L† ∇`(u? )] ≤

E[||ûMLE − u? ||2L ] ≤

2(d − 1)
.
mβk2max

By noting that ||ûMLE − u? ||2L = (ûMLE − u? )L(ûMLE − u? ) ≥ λ2 (L)||ûMLE − u? ||2L , since ûMLE − u? ⊥ null(L), we can
translate this into the `2 norm:
2(d − 1)
E[||ûMLE − u? ||22 ] ≤
.
mλ2 (L)βk2max

Discovering Context Effects from Raw Choice Data

Now, setting
cB,kmax :=

2
,
λ2 (L)βk2max

we retrieve the theorem statement,

d−1
2
E kûMLE (D) − u? k2 ≤ cB,kmax
.
m
We close with some remarks about cB,kmax . The quantity βkmax , defined in equation (8), serves as the important term
that approaches 0 as a function of B and kmax , requiring that the former be bounded. Finally, λ2 (L) is a parallel to the
requirements on the algebraic connectivity of the comparison graph in (Shah et al., 2016) for the multinomial setting.
Though the object L here appears similar to the graph Laplacian L in that work, there are major differences that are most
worthy of further study.

C. Auxiliary Material
C.1. Removing Constraints from M2
We restate M2 for convenience.
P (x | C) = P

exp(v(x) +

P

z∈C\x

v(x | {z}))

,
exp(v(y) + z∈C\y v(y | {z}))
X
X
s.t.
v(x) = 0,
v(x | {y}) = 0, ∀y ∈ X .
P

y∈C

x∈X

x∈X \y
2

Here, a counting exercise reveals that there are n variables (n from the v(x) and n(n − 1) from the v(x | {u}) and there are
n+1 linear equality constraints (1 from the constraint on v(x), and n from the constraints on v(x | {u})). Our goal in this step
is to find a parameterization such that there remains only one equality
and n(n − 1) variables. To do this,
P constraint
P
P we define
1
the variable uxz ∀x 6= z ∈ X , and subject it to the constraint that x∈X y∈X \x uxy = 0. Set v(z) = − n−1
x∈X \z uxz ,
P
P
P
P
1
1
v(z)
=
∀z and set v(x | {z}) = uxz − n−1
.
We
may
then
verify
that
u
z∈X
y∈X \z yz
z∈X
x∈X \z uxz = 0
n−1
because of the constraint on u. We can also verify that
X
X
X
1
v(x | {z}) =
[uxz −
uyz ] = 0.
n−1
x∈X \z

x∈X \z

y∈X \z

Thus, the assignment is feasible for any u satisfying its sum constraint. Substituting the assignments into the expression for
the probability, we have,
P
P
P
1
1
exp(− n−1
w∈X \x uwx +
w∈X \z uwz ])
z∈C\x [uxz − n−1
P
P
P
P (x | C) = P
1
1
y∈C exp(− n−1
w∈X \y uwy +
z∈C\y [uyz − n−1
w∈X \z uwz ])
P
P
P
1
exp(− z∈C n−1 w∈X \z uwz + z∈C\x uxz )
P
P
P
=P
1
y∈C exp(−
z∈C n−1
w∈X \z uwz +
z∈C\y uyz )
P
exp( z∈C\x uxz )
P
=P
y∈C exp(
z∈C\y uyz )
P
where the third step followsPfrom Pz∈C v(z) terms cancelling out across the numerator and denominator. Thus, every u
that satisfies the constraint x∈X y∈X \x uxy = 0 always satisfies the constraints on v(x) and v(x | {z}), and hence the
new P (x | C) is a valid reparameterization.
C.2. Examples of IIA Violations Handled by CDM
Copying over the example from the main text, consider a choice system on X = {a, b, c} where
P (a | X ) = 0.8, P (b | X ) = 0.1, P (c | X ) = 0.1.
Assuming IIA implies that we can immediately infer the parameters. Using the notation from model M1 , we have that
v(a) = 1.386, v(b) = v(c) = −.693. These three values sum to zero, as per the constraint. We may then state the three

Discovering Context Effects from Raw Choice Data

relevant pairwise probabilities using these parameters:
P (a | {a, b}) = 0.89, P (b | {b, c}) = 0.50, P (c | {a, c}) = 0.11
Thus, IIA is full specified and constrained this way. This is in contrast to the CDM, which can specify any arbitrary pairwise
probability. As an example, we can model an extreme preference reversal as follows:
P (a | {a, b}) = 0.11, P (b | {b, c}) = 0.50, P (c | {a, c}) = 0.89
Although b is disproportionately preferred over a in the pair setting, the story almost reverses in the triplet setting. The CDM
parameters corresponding to this example are: [uab , uac , uba , ubc , uca , ucb ] = [.693, .693, 2.784, −3.477, 2.784, −3.477],
where the sum to 0 constraint is being enforced. This notion of preference reversal, and CDM’s ability to accommodate
it, is actually fairly versatile. Indeed, many of the storied effects in discrete choice, such as those of Similarity Aversion,
Asymmetric Dominance, and the Compromise Effect are simply instances of preference reversal. We illustrate this using the
following table, adapted from (Srivastava and Schrater, 2012). Px,A is used to denote the probability of choosing an item x
from a set A.

Table 1. An Overview of the Various Effects
Name
Preference Reversal
Similarity Aversion
Compromise Effect
Asymmetric Dominance

Effect
Px,{x,y}
Px,{x,y}
Px,{x,y}
Px,{x,y}

> Py,{x,y} ,
> Py,{x,y} ,
> Py,{x,y} ,
> Py,{x,y} ,

but Px,{x,y,z}
but Px,{x,y,z}
but Px,{x,y,z}
but Px,{x,y,z}

Constraints
< Py,{x,y,z}
< Py,{x,y,z}
< Py,{x,y,z}
< Py,{x,y,z}

None
z ≈ x, splits share
x > y, x > z, y > z
x ≈ y, y ≥ z

Table 1 provides an overview of the idea that the famous observations of IIA violations in discrete choices are simply
instances of preference reversals. Since the CDM can help model such reversals, it can consequently model these effects.
C.3. Identifiability and Regularization
In this section, we further explore the concepts developed in the main text about identifiability and regularization. Intricate
conditions of identifiability are not unique to the CDM, but are rather widespread in the embeddings literature. These
conditions, however, are not very well described or stated anywhere, and especially matter in the embedding setting because
regularization is often omitted. Here, we explore a few different models, starting first with the Blade Chest model.
C.3.1. B LADE C HEST
As stated before, we may treat the Blade Chest model as the CDM applied only to the pairwise comparisons. But Theorem 2
demonstrates that the CDM is not identified in this setting, hence, neither is the Blade Chest Model. We make this clear as
follows. Consider first the full rank case, d = n. If Û is a solution to the problem, then Ũ = Û + A for any symmetric matrix
A. Using this, we can consider d < n. A subset of solutions when d < n is T̂ + X, Ĉ + Y , where X = β Ĉ + γ1 αβ T̂ , and
Y = αT̂ + γ2 αβ Ĉ where α, β ∈ R, γ1 , γ2 ∈ {0, 1}, γ1 6= γ2 .
We note that this, however, is only an illustrative small subset to a more general set of solutions that could be better explored
through heuristic approaches to the computationally hard affine rank minimization problem.
C.3.2. S HOPPER
Yet another model that suffers from identifiability issues is the Shopper model (Ruiz et al., 2017). We refer the reader to the
orignal work for a review on the model in order to keep the dicussion here terse. Consider first the full rank case, d = n.
If Û is a solution to the problem, then Ũ = Û + 1z T + diag(a) for any vectors z, a ∈ Rn . A subset of solutions when
d < n is T̂ + x1T , or the origin of the target vector. Though mere shifts of the origin might seem trivial in visualizing the
underlying embeddings, these shifts become significant under a measure like cosine distance, or the embeddings use in any
absolute, as opposed to relative setting.

Discovering Context Effects from Raw Choice Data

C.3.3. C ONTINUOUS BAG OF W ORDS (CBOW)
Here, we describe the original CBOW, not the version with negative sampling that is an entirely different objective (Rudolph
et al., 2016). Consider first the full rank case, d = n. If Û is a solution to the problem, then Ũ = Û + 1z T for any vector
z ∈ Rn . A subset of solutions when d < n is T̂ + x1T , or the origin of the target vector. Yet again, when the underlying
measure of comparing word similarity is cosine distance—which it frequently is in natural language processing—an origin
discrepancy make a difference in underlying task performance.
C.3.4. R EGULARIZATION
A clean solution to issues of uniqueness is to add regularization. Specifically, any amount of `2 regularization immediately
guarantees identifiability, whereas the same cannot be said of `1 regularization. We consider the impact of regularization on
the CDM in two specific instances.
`1 regularization on exponentiated variables. Because the CDM
we may set the shift such that the sum
P is shift invariant,
P
of the exponentiated sum of all the rows may be set to 1. That is, y∈X exp( x∈X \y uxy ) = 1. With such a shift, applying
`1 regularization to the exponentiated entries may be reformulated as adding a uniform prior of choices from the Universe.
Such an idea is described in (Ragain et al., 2018) for the MNL model. This regularization is a valuable addition when the set
of observations is small or the comparison graph is irregular. In these settings, the regularization plays a balancing role that
is also interpretable for any dataset: additional choices from the universe. However, we know that such an addition alone
will not uniquely identify the CDM - especially if the dataset only contains pairwise comparisons, where the CDM will not
be identified even with an arbitrarily large sample size. Even with datasets of a choice set size greater than 2, the dataset still
requires samples from a diverse range of choice sets within that size before it is identifiable with the regularization. This is
consistent with the view that `1 does not always identify the CDM.
`2 regularization on the U matrix. As stated earlier, any small amount of `2 regularization immediately identifies the CDM.
Since the “pairwise comparisons only” setting suffers in a rather extreme way from identifiability issues, understanding the
role `2 regularization plays there is important. We recall from earlier than in the setting of pairwise comparisons, the CDM
matrix U is only specified up to a symmetric matrix A when inferred from pairwise comparisons. Since `2 regularization
will minimize the entrywise norm of the U matrix, A will be chosen to be zero. That is, the U matrix will be antisymmetric.
We may then use this property to solve for parameter uxy as a function of the pairwise probabilities:
P

1
x,{x,y}
uxy = log
2
Py,{x,y}
It is most interesting to look at
uxz − uyz =

P

1
z,{y,z} Px,{x,z}
log
.
2
Py,{y,z} Pz,{x,z}

Since uxz − uyz corresponds to the influence a third item z’s presence has on the choice between x and y, it is interesting
that the relative intransitivities of the three items in their respective pairwise settings are leveraged to describe this influence
in the triplet case. This is quite possibly the best outcome one could hope for having just pairwise comparisons, and
demonstrates the value of regularization.
C.4. Auxiliary Lemmas
Lemma 3. For ΣD :=

1
†
T
m2 X(D)L X(D) ,

tr(ΣD ) =

d−1
m

where the remaining quantities are defined in the proof of Theorem 3, we have,
tr(Σ2D ) =

(d − 1)2
m2

||ΣD ||op =

1
.
m

1
Proof. Consider first that L = m
X(D)T X(D). Since L is symmetric and positive semidefinite, it has an eigenvalue
decomposition of U ΛU T . By definition, the Moore-Penrose inverse is L† = U Λ† U T . We must have that X(D) =
√
1
1
mV Λ 2 U T for some orthogonal matrix V in order for L to equal m
X(D)T X(D). With these facts, we have
√
1
1
1
1 √
X(D)L† X(D)T = 2 mV Λ 2 U T U Λ† U T U Λ 2 V T m
2
m
m
1
= V ΛΛ† V T .
m

Discovering Context Effects from Raw Choice Data

That is, ΣD is a positive semi-definite matrix with spectra corresponding to d − 1 values equaling
The three results about the traces and the operator norm immediately follow.

1
m,

and the last equaling 0.

