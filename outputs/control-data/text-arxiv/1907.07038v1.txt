MNRAS 000, 1–12 (2019)

Preprint 17 July 2019

Compiled using MNRAS LATEX style file v3.0

Coronagraphic phase diversity through residual
turbulence: performance study and experimental validation
Olivier Herscovici-Schiller,1? Jean-François Sauvage,2,3 Laurent M. Mugnier,2
Kjetil
Dohlen3 and Arthur Vigan3
1
2

arXiv:1907.07038v1 [astro-ph.IM] 16 Jul 2019

3

DTIS, ONERA, Université Paris Saclay, F-91123 Palaiseau – France
DOTA, ONERA, Université Paris Saclay, F-92322 Châtillon – France
Laboratoire d’Astrophysique de Marseille UMR 7326, Aix-Marseille Université, CNRS, 13388 Marseille, France

Accepted 2019 July 15. Received 2019 July 15; in original form 2019 January 17

ABSTRACT

Quasi-static aberrations in coronagraphic systems are the ultimate limitation to the
capabilities of exoplanet imagers both ground-based and space-based. These aberrations – which can be due to various causes such as optics alignment or moving optical
parts during the observing sequence – create light residuals called speckles in the focal plane that might be mistaken for a planets. For ground-based instruments, the
presence of residual turbulent wavefront errors due to partial adaptive optics correction causes an additional difficulty to the challenge of measuring aberrations in the
presence of a coronagraph. In this paper, we present an extension of COFFEE, the
coronagraphic phase diversity, to the estimation of quasi-static aberrations in the presence of adaptive optics-corrected residual turbulence. We perform realistic numerical
simulations to assess the performance that can be expected on an instrument of the
current generation. We perform the first experimental validation in the laboratory
which demonstrates that quasi-static aberrations can be corrected during the observations by means of coronagraphic phase diversity.
Key words: instrumentation: high angular resolution — instrumentation: adaptive
optics — techniques: high angular resolution — techniques: image processing – turbulence – methods: data analysis

1

INTRODUCTION

Imaging exoplanets is a challenging task. Current groundbased exoplanet imagers such as SPHERE or GPI reach
contrast levels of 10−6 in H-band at 0.5 arc second separations (Beuzit et al. 2008; Macintosh et al. 2008). Such high
contrast imaging is enabled by the use of coronagraphs, devices which reject the on-axis starlight but let out-of-axis
light from disks or planets pass through. However, any optical aberration in the instrument causes light to leak through
the coronagraph, which results in speckles appearing in the
focal plane of the telescope. These speckles constitute the
ultimate contrast limit for exoplanet imagers.
Since the quasi-static aberrations evolve slowly during
the night (Martinez et al. 2012, 2013), the full contrast capacity of exoplanet imagers can be reached only if a correction is applied during the night. A few methods have been
developed to measure the quasi-static aberrations (N’Diaye

?

E-mail: olivier.herscovici@onera.fr (OHS)

© 2019 The Authors

et al. 2013; Galicher et al. 2008). However, none of them
is currently adapted to being used during the observations
of a ground-based instrument, although some tests are currently taking place (Vigan et al. 2018). Our goal is to present
the adequacy of the coronagraphic phase diversity, COFFEE, to the measurement of quasi-static phase aberrations
in the presence of adaptive-optics-corrected residual turbulence. We start with the adaptation of the algorithm. We
continue with a performance assessment consisting in numerical studies of the sensitivity of the method to various
sources of perturbation. We finish with the description of a
laboratory validation of the coronagraphic phase diversity
in the presence of residual turbulence on the MITHiC bench
at laboratoire d’astrophysique de Marseille.

2
2

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan
FORMALISM OF THE CORONAGRAPHIC
PHASE DIVERSITY IN THE PRESENCE OF
RESIDUAL
ADAPTIVE-OPTICS-CORRECTED
TURBULENCE

In this section, we recall the formalism of coronagraphic
phase diversity and we present its adaptation to the presence
of adaptive-optics-corrected turbulence.
2.1

COFFEE, the coronagraphic phase diversity

COFFEE, the coronagraphic phase diversity, is a postcoronagraphic wavefront sensor (Sauvage et al. 2012; Paul
et al. 2013a). As its name suggests, it is a flavour of the phase
diversity (Gonsalves 1982; Mugnier et al. 2006) method. The
principle is to use information encoded in images produced
by the scientific instrument to retrieve the aberrations of
the instrument. Unfortunately, more than only one image is
needed to do so. In phase diversity, two (or more) images
are used. One is called the focused image. The other one,
called the diversity image, is taken while a known aberration, called the diversity phase, is voluntarily introduced in
the system. In the context of coronagraphic phase diversity
for ground-based instruments, the diversity phase can be
easily introduced by the deformable mirror of the adaptive
optics system.
From a mathematical point of view, COFFEE is a maximum a posteriori estimator with non-homogeneous Gaussian noise assumption. The principle is to find the upstream
phase aberration d
φup and the downstream phase aberration

φdown that minimise the cost function J :
J (φ) =

Õ i(k, x, y) − m(φup, φdown, k, x, y) 2
k, x,y

2σ 2 (k, x, y)

+R(φup )+R(φdown ).
(1)

In the first term of the right hand sign, i is an experimental image produced by the detector. Its counterpart m is a
numerical model of the image, which takes into account the
sought quasi-static aberrations φup and φdown . The indexes
of the sum are x and y, which are the coordinates of the pixels in images, and k, which is there to distinguish between
the focal image and the diversity image. The denominator
σ 2 is the variance of the noise level of pixel x, y in the image
i(k). This first term is a noise-weighted distance between the
experimental data and the output of a model. The second
term of the right hand sign, R, is a regularisation term, often
taken as
1 Õ
(2)
R(φ) =
k∇φk 2 (x, y),
2
2σ∇φ
x,y
where ∇φ is the spatial gradient of φ. This second term represents prior knowledge of the statistics of the aberrations.
More precisely, this terms penalises the phase spatial gradients, which smooths the reconstructed phase and attenuates
the noise propagation in the wavefront. This avoids unrealistic very high spatial frequencies to appear in the reconstructed wavefront.
If the images are not narrow-band, the impact of spectral width is negligible for ∆ λ/λ < 15% (Meynadier et al.
1999). If the image is broad-band, then the numerical

model of the image must be calculated for several wavelengths (Seldin et al. 2000). This will increase the computation cost of the numerical model in proportion to the width
of the spectral band. However, the calculations at different
wavelengths can absolutely be done in parallel, so the increase in the number of computations will not result in an
increase in the duration of the computation if a multiplecore-computer can be used.

2.2

Implementation: taking turbulence into
account

The numerical implementation of COFFEE in a turbulencefree case is described in Paul et al. (2013a) and Paul et al.
(2013b). The expression of m in COFFEE is
m(φ, k, x, y) = fk × [hdet ? hc (φ + φk )] (x, y) + bk ,

(3)

where fk the incoming flux, hdet is the response of the detector, ? is the convolution operator, hc is the point spread
function of the coronagraphic instrument, φ is the static
aberration that we seek to retrieve, φk is zero for the focused
image and is the diversity phase in the diversity image, and
bk is a constant background.
In order to take the effect of atmospheric turbulence
into account, the model of data formation m must reckon
the impact of turbulence. In order to do so, we developed an
analytic expression for coronagraphic imaging through turbulence (Herscovici-Schiller et al. 2017) to use as the point
spread function of the instrument. The optical impulse response of the coronagraphic instrument in the presence of
(residual) turbulence is noted hlec – the index stands for
“long exposure coronagraphic”. We still note hc the impulse
response of the coronagraphic instrument without turbulence. By analogy with the atmospheric transfer function
(Roddier 1981) as described by Herscovici-Schiller et al.
(2017), we note ha (Dφ ) the atmospheric point spread function, defined as



1
ha (Dφ ) = F −1 exp − Dφ ,
(4)
2
where Dφ is the phase structure function of the (residual)
atmospheric turbulence. If the turbulence is supposed to be
stationary and ergodic, then, for an exposure time much
larger than the characteristic time of turbulence,
hlec (α; φup, φdown, Dφ ) =
∬


ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown dα 0,

(5)

where α is a two-dimensional angular position in the focal
plane, φup is the static aberration upstream of the coronagraph, φdown is the static aberration downstream of the
coronagraph, and Id is the identity function of R2 . In order to use this forward model into COFFEE, one needs to
compute it efficiently, and to compute its gradients.
The numeric model of the instrument is computed by
performing a discrete sum to approximate the integral, using
the same Fourier optics model for hc as in Paul et al. (2013a),
as long as an estimate of Dφ is available, for example using
one of the methods described in Sauvage et al. (2012) or
Véran et al. (1997). If the point spread function is sampled
on N × N pixels, a natural choice is to calculate the numeric
MNRAS 000, 1–12 (2019)

Coronagraphic phase diversity through residual turbulence

3

point spread function as
hlec (α; φup, φdown, Dφ ) =
N
/2
Õ

N
/2
Õ

(6)



ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown .

α0x =−N /2 αy0 =−N /2

2.3

A physical approximation that reduces
computing costs

The resulting cost of calculation is then N 2 times the cost
of calculating hc . This cost can be considerably alleviated if
the coronagraph is a Lyot-type coronagraph such as Lyot’s
opaque mask or Roddier’s phase mask coronagraphs. Indeed,
for those coronagraphs consisting of small phase or amplitude features strictly located in the vicinity of the stellar
image, the influence of the focal mask on the point spread
function is essentially negligible when there is a strong upstream tip-tilt. Let us define a central square region of side
M in the focal plane of the coronagraphic mask. If the light
beam is centred outside of this central square, the coronagraph is supposed to have no influence on the beam. Then,
the previous equation can be split into two regions:

Figure 1. Evolution of the quality of the point spread function
calculation as a function of the size of the zone where the influence
of a Lyot coronagraph is taken into account

hlec (α; φup, φdown, Dφ ) =

+

N
/2
Õ

N
/2
Õ

(7)

which amounts to a convolution in the first double sum :

hlec (α; φup, φdown, Dφ ) = ha0 (Dφ ) ? h φup, φdown (α)
(11)
M/2
Õ

M/2
Õ



ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown .

α0x =−M/2 αy0 =−M/2

Since the cost of calculating the convolution product
ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown
is negligible in comparison with the cost of calculating the
double sum, the total cost of the calculation has diminished
from N 2 times the cost of calculating hc to M 2 times the
M/2
M/2
Õ
Õ


0
0
cost of calculating hc . An important point is then to deterha α ; Dφ × hc α; φup + 2πα · Id, φdown .
+
mine which is the quality of the approximation as a func0
0
αx =−M/2 αy =−M/2
tion of the side of the exact calculation zone, M. Figure 1
presents the energy in the difference between the field calcuSince the double sum on the first line exists only for strong
lated without approximation and the field calculated using
tip-tilts, the value of hc in it is very close to the value of a
Equation (11). Various sizes M, varying from 1 to 41, are
non-coronagraphic point spread function, denoted h:
considered. The coronagraph that is considered here is a
hlec (α; φup, φdown, Dφ ) ≈
(8)
Lyot coronagraph of radius 2λ/D. The root mean square
of the upstream aberration is 100 nm at a wave-length
N
/2
N
/2
Õ
Õ


ha α 0 ; Dφ × h α; φup + 2πα 0 · Id, φdown λ = 1, 589 nm, and the phase structure function is representative of SPHERE’s SAXO adaptive optics system. The
α0x =−N /2
αy0 =−N /2
α0x <[−M/2, M/2] αy0 <[−M/2, M/2]
normalisation factor is taken such that the coronagraphic
point spread function without any aberration, without turM/2
M/2
Õ
Õ


0
0
bulence, has a total energy of 1. The sampling factor is cho+
ha α ; Dφ × hc α; φup + 2πα · Id, φdown .
sen to satisfy exactly the Shannon–Nyquist condition, that
0
0
αx =−M/2 αy =−M/2
is to say that a numeric field of M pixels corresponds to an
optic angular size of Mλ/2D.
Now, we can give a convolutive structure to the first
There are two regimes of loss of precision due to the apdouble sum. Let us define ha0 as
proximation. In the first regime, the approximation is crude

0 if α 0 ∈ [−M/2, M/2] × [−M/2, M/2]
because the size M is insufficient, and the error decreases
ha0 (α 0 ) =
(9)
ha (α 0 ) otherwise.
greatly with any increase in M. In the second regime, where
M > 10, the exact calculation is performed on a zone of exThen, Equation (8) can be re-written as :
tension 5λ/D. Beyond this zone, the error committed by approximating a tilted coronagraphic point spread function by
hlec (α; φup, φdown, Dφ ) =
(10)
a non-coronagraphic one becomes negligible. Indeed, even
N
/2
N
/2
Õ
Õ


if there is a Lyot (or Roddier & Roddier) coronagraph, a
ha0 α 0 ; Dφ × h α; φup + 2πα 0 · Id, φdown
light beam tilted by more than 5λ/2D will essentially not be
α0x =−N /2 αy0 =−N /2
modified by the coronagraph. Consequently, in the second
M/2
M/2
regime, the approximation error is very low, and decreases
Õ
Õ


+
ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown ,
more slowly.
α0x =−M/2 αy0 =−M/2
In conclusion, for coronagraphs such as the Lyot coronαy0 =−N /2
α0x =−N /2
α0x <[−M/2, M/2] αy0 <[−M/2, M/2]

MNRAS 000, 1–12 (2019)





4

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan

agraph or the Roddier & Roddier coronagraph, and in particular the popular APLC, the cost of a long-exposure coronagraphic image simulation can be about a hundredfold the
cost of a short-exposure coronagraphic image. In practice,
the simulation of a 1024 × 1024-pixel long-exposure coronagraphic image results in a calculation time of less than five
seconds on a single core of an office computer equipped with
a 2.6 GHz Intel processor. In principle, the approximation
could be adapted to a four-quadrant phase mask coronagraph, where the convolutive approximation could be done
far from the transitions.

2.4

Calculating the gradients

The COFFEE criterion given by Equation (1) can be separated into two parts. The gradient of the regularisation part,
R, is easier to calculate, for the inclusion of turbulence into
the model does not change it. As can be found in Paul (2014)
∂R
1
(φ) = − 2 ∆φ
∂φ
σ

for

R(φ) =

∇φ

1

Õ

2
2σ∇φ
x,y

Let us define D as the other part of the criterion, that
is, the distance between the model m and the data i :
Õ i(k, x, y) − m(φup, φdown, k, x, y) 2
k, x,y

2σ 2 (k, x, y)

∂D
=
∂φ

N
/2
Õ

N
/2
Õ

ha α 0 ; Dφ



(18)

α0x =−N /2 αy0 =−N /2

×


∂
∂D
×
hc l, m; φup + 2πα 0 · Id, φdown .
∂h
(l,
m)
∂φ
lec
m

ÕÕ
l

One can note that the second line of this last expression is the gradient of the non-regularised criterion in the
absence of turbulence, whose expression is given in the appendix of Paul et al. (2013a). Consequently, the structure of
the calculation of this gradient is similar to the calculation
of the point spread function itself. Thus, its calculation can
also benefit from the acceleration described in the previous
subsection.
Now that the formalism and implementation of coronagraphic phase diversity in the presence of turbulence are
described, let us move on to a numerical study of the robustness of the method.

k∇φk 2 (x, y).
(12)

D=

Now, a rearrangement of the summation operators leads to

.

(13)

Then, using the complete expression of m, D is


Õ i(k, x, y) − fk × hdet ? hlec (φup + φk , φdown ) (x, y) − bk 2
,
D=
2σ 2 (k, x, y)
k, x,y
(14)

3

NUMERICAL STUDY OF THE
ROBUSTNESS OF THE METHOD

In this section, we perform numerical simulations to study
the impact on the quality of the COFFEE reconstruction of
various discrepancies between the model m and the actual
imaging process leading to i. A simulation result when there
is no discrepancy is presented in Herscovici-Schiller et al.
(2017). We consider successive discrepancies in order to obtain a realistic simulation of the performance that can be
expected of the technique on a real instrument.

3.1

Parameters of the simulations

In all this section, the phase aberrations are expressed
at a wavelength λ = 1.589 nm. The simulation is purely
monochromatic, the wavelength being λ = 1.589 nm.. The inhlec (α; φup, φdown, Dφ ) =
(15)
put parameters of the simulations include a phase structure
N
/2
N
/2
function Dφ that is representative of turbulence at Paranal
Õ
Õ


after correction by SPHERE’s adaptive optics SAXO. The
ha α 0 ; Dφ × hc α; φup + 2πα 0 · Id, φdown .
upstream phase aberration, φup , has a root mean square of
α0x =−N /2 αy0 =−N /2
50 nm, with an energy spectral density that follows a f −2
The gradient of D with respect to φ can be calculated
statistics. This upstream phase aberration is what we wish to
using the long-exposure coronagraphic point spread function
estimate thanks to COFFEE in the simulations. The downas an intermediate variable :
stream phase aberration, φdown , has a root mean square of
20 nm, with the same energy spectral density as the upÕ
Õ
∂D
∂D
∂hlec (l, m)
=
.
(16)
stream aberration. The coronagraph is an unapodized Lyot
∂φ
∂hlec (l, m)
∂φ
l m
coronagraph, with a ratio of 95 % between the diameter of
the entrance pupil and the diameter of the Lyot stop. There
By using the analytic expression for hlec , this gradient is also
are no amplitude aberrations in the system. The total flux
of the source is taken at 109 photons, and the root mean
∂D
square of the electronic noise of the detector is one electron
∂φ
per pixel. The diversity phase is supposed to be perfectly
ÕÕ
∂D
=
(17)
known. It is taken as a pure defocus, with root mean square
∂hlec (l, m)
l m
125 nm. The images in the focal plane have 128 × 128 pixels.
N
/2
N
/2
The
value of the sampling is chosen as 2, so the Shannon–
Õ
Õ


∂
×
ha α 0 ; Dφ × hc l, m; φup + 2πα 0 · Id, φdown . Nyquist condition is respected, and the estimated phases are
∂φ 0
αx =−N /2 αy0 =−N /2
sampled over 64 × 64 pixels.

where

MNRAS 000, 1–12 (2019)

Coronagraphic phase diversity through residual turbulence
3.2

Sensitivity to an error on the phase structure
function

The analytic model that we use in the reconstruction algorithm requires the knowledge of the phase structure function
of the post-adaptive optics residuals.
During operations, the statistics of the adaptive opticscorrected turbulence can be estimated using several techniques (Véran et al. 1997; Sauvage et al. 2012). A first family is telemetry techniques that give access to such data as
the seeing or the wind speed. Those data can then be used
jointly with the parameters of the adaptive optics system
in a numeric simulation whose output is the phase structure function Dφ . A second family of techniques is to use
such real-time measurements of the adaptive optics system
as residual slopes and command voltages. Since this section
is concerned with performing simulations, we used the first
option to produce the phase structure function.
Whether one or the other technique is chosen, the phase
structure function will not be perfectly known in practice. In
this subsection, we test how an error on the parameter Dφ
impacts the quality of the reconstruction. We generate data
using the parameters detailed in the previous subsections.
We then perform COFFEE reconstructions using different
phase structure functions, which are obtained by multiplying the “true” phase structure function Dφ by a factor 1 − p.
For the sake of legibility, a reconstruction performed using
(1− p)× Dφ as phase structure function is called a reconstruction with a error of magnitude p on Dφ . This corresponds
to a reconstruction where the seeing is underestimated, but
with a correct knowledge of the wind velocity and the magnitude of the source. Indeed, Dφ translates the phase residual
statistics after the AO system, and this residual behaves in
direct relation with the Fried parameter r0 (Rigaut et al.
1998; Fétick et al. 2018), as the adaptive optics loop acts
mainly as a filter. A more detailed analysis should also indicate the impact of a wind difference (hence only impacting
the on-axis residuals), or a boiling effect, or mis-registration
evolution, or the impact of additionnal dead actuators; here
we perform a principle demonstration taking only r0 , which
is the main contributor to the final correction error of the
adaptive optics loop, hence producing a scaling on Dφ .
Figure 2 displays the root mean square error between
the estimated upstream phase, φbup , and the true upstream
phase, φup as a function on the error on Dφ , for five different
values of the error p. The error evolves in the same way for
p < 0.. On SAXO, the adaptive optics of SPHERE, one can
expect an error ranging from 5% to 15%. Consequently, one
can expect an error of one to three nanometres on the part
of the aberrations that can be corrected by the deformable
mirror. Thus, COFFEE is expected be a good candidate
to measure and correct the quasi-static aberrations several
times per night, using on-sky measurements.

Figure 2. Estimation error as a function of the error on the
knowledge of D φ . The total error is separated as an error in the
zone that is corrected by the deformable mirror and the uncorrected zone.

decreases, so we expect the quality of the estimation to increase. This expectation is confirmed by the results shown
on Fig. 3. It shows that the estimation error decreases with
an increase in the flux. Moreover, it shows that the quality
of the estimation is much less sensitive to an increase in the
incoming light flux at around one million incoming photons
in the pupil.
We can explain the order of magnitude of this critical
point in a simple manner. The coronagraph blocks about
90% of the incoming 106 photons. About 105 reach the 128 ×
128 = 16, 384 pixels of the detector, which amounts to an
average of about 6 photons per pixel. Since the electronic
noise is one electron per pixel, we deduce that the effect of
an increase in the total flux is reduced if the average flux
per pixel is such that the signal to noise ratio is higher than
5, which is easily reachable in a reasonable amount of time
for a H magnitude of nine to twelve.
Let us consider the case of an observation by the Very
Large Telescope of a star of magnitude 15 in the visible.
The photonic flux on the detector without a coronagraph
is about 2 × 105 photons per second in H-band. Since the
data that we aim to use are typically exposures of a several
hundred seconds, the resulting number of photons is in the
range of 107 , which is quite enough to avoid the estimation
to be limited by the noise level.

3.4
3.3

5

Sensitivity to the noise level

The incoming photonic flux has a critical impact on the noise
level in the images. In this subsection, we study the impact
of the photonic flux on the estimation quality of φup . We
perform this study with a 10 % error level on Dφ , for we do
not have proof that the various causes of estimation errors
are independent. When the light flux increases, the noise
MNRAS 000, 1–12 (2019)

Sensitivity to the presence of a planet in the
data

The data formation model that we use in COFFEE relies
on the light propagation from a point source. However, for
practical on-sky implementations, COFFEE must be able
to estimate aberrations while observing planets. Here, we
present COFFEE estimates performed on simulated images
where there is a planet. We chose realistic parameters: we

6

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan

Figure 5. Left: focused image taken as a COFFEE input with
the presence of a planet. The planet is at a third of the adaptive
optics correction radius, below the star. The flux of the planet is
10−3 times the flux of the star. Middle: direct model corresponding to the COFFEE reconstruction. Right: difference between direct model corresponding to the COFFEE reconstruction (middle) and direct model corresponding to the true aberration; the
impact of the planet on the estimation quality is clearly visible.

Figure 3. Root mean square of the estimation error of the upstream phase as a function of the incoming light flux (in photons).
The estimation is performed with a 10 % error on the phase structure function.

Figure 4. Top, from left to right: COFFEE estimate without a
planet, COFFEE estimate with a planet of flux 10−5 relative to the
star, COFFEE estimate with a planet of flux 10−4 relative to the
star, and COFFEE estimate with a planet of flux 10−3 relative to
the star. Bottom: difference between top and COFFEE estimate
without a planet.

kept a 10% error level on Dφ , and an incoming light flux of
106 photons in the pupil. The position of the planet is at
an angle 3.5λ/D from the star. We simulated planets with
flux ratios of 10−3 , 10−4 , and 10−5 between the star and the
planet, so that we could test the various impacts that various
planet fluxes could have on the estimation error.
Figure 4 presents COFFEE estimates with no planet in
the data, and with planets whose fluxes are 10−5 , 10−4 , and
10−3 with respect to the star.
In the case where the flux ratio is 10−5 , the phase
estimation is almost unperturbed by the planet: the root
mean square of the difference between the reconstruction
with a planet and the reconstruction without planet is only

Figure 6. Same as Fig. 5, except this time the flux of the planet
is 10−5 times the flux of the star. Contrarily to Fig. 5, the planet
is invisible in the data, and it has no impact on the estimation
quality.

0.35 nm. This difference is mainly due to the fact that the
realisations of the noise in the data are different.
In the case where the flux ratio is 10−3 , the phase estimation is strongly perturbed by the planet. In that case, the
root mean square of the difference between the reconstruction with a planet and the reconstruction without planet
is 6.0 nm. The error is mainly a sinusoidal structure whose
image through the data formation model generates a strong
speckle that looks like a planet.
In the intermediate where the flux ratio is 10−4 , the
phase estimation is slightly perturbed by the planet. In that
case, the root mean square of the difference between the
reconstruction with a planet and the reconstruction without
planet is 0.5 nm.
These results show that COFFEE may or may not mistake a planet in the data for a speckle, depending on its light
flux. This influence of the light flux of the planet can be explained by comparing it with the regularisation level. If the
flux of the planet is high, the associated noise in the pixels
that image it is low, and the planet then has an important
impact on the criterion, leading to a sinusoidal estimation
for φup . On the opposite, if the flux of the planet is low, the
associated noise in the pixels that image it is high, and the
planed then has a low impact in the criterion, so the regularisation will prevent the emergence of an artefact. This is
especially obvious if one compares Figs 5 and6.
We conclude that, for a planet whose light flux compared to its star is less than 10−4 , its presence in the data
will account for an estimation error of root mean square
less than half a nanometre in the SPHERE-like case of a
MNRAS 000, 1–12 (2019)

Coronagraphic phase diversity through residual turbulence
f’ = 250 Lyot stop

FPM

Beam splitter

PP

f’ = 500

SLM
Beam splitter

PP
f’ = 100

PP
FP

FP

ZELDA
mask

f’ = 150

FP

PP

Camera

ZELDA
Camera

PP

Source

Phase screen
f’ = 100

Polarizer

f’ = 100

FP
PP

f’ = 100

Figure 7. Schematical representation of MITHiC, reproduced
from Leboulleux (2018). Courtesy Lucie Leboulleux.

fifty-nanometre upstream aberration. If, however, a planet
of flux higher than 10−4 happened to be in the field, then
it would be clearly visible in the raw data (compare Figs 5
and 6). In that case, one could choose to ignore a small
region about the planet in the COFFEE input data. The alternative is to implement a model of the planet as a source
point in the COFFEE algorithm. Even in the presence of
an imperfect knowledge of the phase structure function, and
with a limited exposure time, the expected error root mean
square of the estimation error is of the order of a nanometre
in the adaptive optics-corrected zone, for a 50-nanometres
root mean square phase aberration. With this encouraging
simulation result in mind, we proceed to the laboratory validation.

4

LABORATORY VALIDATION OF THE
CORONAGRAPHIC PHASE DIVERSITY IN
THE PRESENCE OF RESIDUAL
TURBULENCE

4.1
4.1.1

Strategy of validation
Aim

The aim of our experiment was to use the coronagraphic
phase diversity to estimate a static phase aberration upstream of a coronagraph by using post-coronagraphic images
as input data. The experiment was performed in a controlled
environment, the MITHiC testbed.

4.1.2

The MITHiC testbed

MITHiC is the Marseille Imaging Testbed for High Contrast imaging. It has been developed at the laboratoire d’astrophysique de Marseille (LAM) for almost ten
years N’Diaye et al. (2012). It is schematically described on
Fig. 7.
The light source is a super-luminescent diode. It emits
light in a narrow spectral band centred around λ = 677 nm.
In all our data processing, it is considered as a monochromatic light source. The light undergoes linear polarisation,
and injected on the bench through an entrance pupil.
It is propagated in a second pupil plane, where it passes
through a rotating transparent phase screen. On this screen
are engraved random path differences whose statistics is that
of atmospheric turbulence corrected by SAXO, the adaptive
MNRAS 000, 1–12 (2019)

7

optics system of the SPHERE instrument. The scale of these
path differences is such that the 45-nm-RMS phase shift
that they create at the working wavelength of 677 nm is the
same as the 100-nm-RMS phase shift created by the SAXOcorrected atmospheric turbulence at 1,600 nm, which is a
typical observational wavelength for SPHERE. The phase
screen used on MITHIC to produce the wavefront errors
(both the residual turbulence, or dedicated static patterns)
have been specified by LAM and realized by SILIOS company on a pixel map interface. LAM has provided exactly
the phase map (pixel by pixel depth graduated in nanometers) to be engraved on the phase screen. The realization
of SILIOS has been checked at LAM with a high-resolution
ZYGO interferometer after delivery, and they are correct at
a nanometric level, which guarantees that the statistic, as
well as the power law and RMS across the aperture are the
expected ones.
In a third pupil plane, the light meets the surface of a
spatial light modulator. The presence of this element is the
reason why the light is polarised in the first place. The spatial light modulator is used as a high resolution deformable
mirror.
The light is then split into two paths using a beam
splitter. The auxiliary path, or ZELDA path (N’Diaye et al.
2013), can be used to perform ZELDA experiments, or to use
a HASO wavefront sensor as a calibration reference, which is
what we did. The main path, which is the one of interest for
us here, comprises a Roddier & Roddier focal plane mask,
and a Lyot stop in the next pupil plane.
Finally, the light reaches a focal plane camera. This focal plane can be turned into a pupil plane by introducing a
movable lens in the light beam.
4.1.3

Validation strategy

Our goal was to validate aberration estimation using coronagraphic phase diversity in the presence of residual adaptive optics-corrected turbulence. The plainest strategy imaginable would have been to introduce a known pupil-plane
phase aberration upstream of the coronagraph, take focused
and diversity images, process them with COFFEE, and compare the output of COFFEE to the known aberration. However, this plain strategy would have needed that the optical
testbed be absolutely perfect, that is to say that the introduced aberration be perfectly known. Since aberrations
always exist on the bench, and COFFEE is an absolute wavefront sensor, this was not feasible. So we proceeded in two
times, using a differential estimation strategy, as for example
in Herscovici-Schiller et al. (2018).
First, we did not introduce any aberration. Let us call
φ0up the static aberration on the bench. We took a focused
image and a diversity image, which we collectively denote
by i0 . We used i0 as an input in COFFEE, the output being
our estimate of the static aberration on the bench, d
φ0 .
up

Then, we used the spatial light modulator to introduce a
F . This did not suppress the aberration
known aberration, φup
0
φup on the bench, so the resulting total aberration on the
F . We took a focused image and a diversity
bench was φ0up +φup
image, which we collectively denote by i1 . We used i1 as an
input in COFFEE, the output being our estimate of the
0 + φF .
total aberration on the bench, φ
up

up

8

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan
4.2.2

Figure 8. Strategy for the experimental validation of coronagraphic phase diversity in the presence of residual turbulence.

The Lyot ratio is defined as the ratio between the diameter
of the entrance pupil and the diameter of the Lyot stop. It
is a necessary parameter for the direct model. In order to
determine it, we introduced the Lyot stop — but not the
Roddier & Roddier focal mask — on the bench. Then, just
as for the determination of the sampling on the detector, we
took an image and examined the cut of the corresponding
modulation transfer function. It is located between pixels 99
and 100. Since the Lyot ratio is proportionnal to the ratio
of the cut frequencies, the Lyot ratio is
rL =

4.2.3

Figure 9. Circular average of the modulation transfer function
of MITHiC

99.5 ± 0.5
= 0.93 ± 0.01.
107 ± 1

(20)

Detector noise

The only information on the electronic noise of the camera
given by the manufacturer is that its root mean square is
less than 5 electrons per pixels Photometrics (2014). A previous calibration had found a root mean square value of one
electron per pixel. We calculated the root mean square of
a stack of 4000 images taken in complete darkness, which
yielded a root mean square of 1.6 electrons per pixel. We
use this value σdet as the detector noise in the denominator in Equation 1. The exact formula for the denominator
2
2 , where σ 2
is σ 2 = σphoton
+ σdet
is directly estimated
photon
from the images (Mugnier et al. 2004).

4.2.4
0 + φF −d
0
The last step is to compute the difference φ
up
up φup ,
which we use as the estimate d
φ F of φ F . This validation

Lyot ratio

Phase structure function

Since COFFEE relies on a model of image formation, some
calibrations are necessary to perform an estimation. We detail these calibrations here.

A key parameter of the direct model in the presence of turbulence is the phase structure function of the post-adaptive
optics turbulence. In order to estimate it in our case, we took
the specification file of the rotating phase screen, and calculated a variance over as many distinct realisation as there
were non-overlapping disks in the adaptive-optics corrected
turbulence path difference strip on the phase screen. The absolute value of the corresponding atmospheric
  point spread
function (defined by Eq. 4), F exp −Dφ /2 , is displayed
on Fig. 10. The correction limit of the adaptive optics at a
radius of 20 λ/D is clearly visible.

4.2.1

4.2.5

up

up

strategy is described symbolically on Fig. 8.

4.2

Calibration of the parameters of the optical
model

Sampling on the detector

To determine the sampling on the detector, we took a noncoronagraphic image whose size is 1, 000 × 1, 000 pixels. The
modulus of its Fourier transform is the modulation transfer
function. This modulation transfer function, whose circular
average is shown on Fig. 9, goes to zero at spatial frequency
pixel number 107. Consequently, the sampling factor s f on
the detector is
sf =

1000
= 9.43 ± 0.1.
107 ± 1

(19)

In order to shorten calculation times, the data used as
input to COFFEE were under-sampled by a factor 4. The resulting sampling being higher than 2, the Shannon–Nyquist
condition is satisfied, so there is no loss of information in the
reconstruction.

Uncertainty on the introduced diversity

The diversity phase was introduced by the spatial light modulator. Since any error on the diversity phase impacts the
quality of the estimation, it is important to check the exactness of the introduced diversity. In order to do so, we first
introduced a command for a 200 nm defocus on the spatial
light modulator. We measured the defocus that was effectively introduced thanks to an Imagine Optic HASO wavefront sensor. The HASO measurement, displayed on Fig. 11,
shows that the introduced phase diversity is really a pure defocus. When projected on the first thirty-two Zernike polynomials, the HASO measurement is of a 196 nm root mean
square aberration, 195 nm of whose are concentrated in the
defocus. This shows that the spatial light modulator produces phase is close to that which it is commanded to produce.
MNRAS 000, 1–12 (2019)

Coronagraphic phase diversity through residual turbulence

9

Figure 11. Top: HASO measurement for a 200 nm root mean
square pure defocus control applied on the spatial light modulator. Bottom: Projection of this measurement on the 32 first
Zernike modes.

Figure
10.  The atmospheric point spread function

F exp −D φ /2 used in the experimental estimations (top) and
its circular average (bottom, log scale).

Another important matter is the linearity of the response of the spatial light modulator. We tested the amplitude of the defocus, as measured by the HASO, for various
commands. Figure 12 shows the excellent linearity of the
response, with a linear correlation coefficient of 0.994. Consequently, for a defocus diversity whose root mean square
is 75 nanometres, the error on the diversity should have an
impact of less than a nanometre on the estimation (Blanc
et al. 2003).

4.3
4.3.1

Estimation of the reference wavefront
Data

We aligned the coronagraph on the bench, activated the turbulence simulator, and turned on the light source. The spatial light modulator is sent a flat command. The resulting
phase aberration is denoted by φ0up on Fig. 8. A stack of 400
images is saved. Each exposure lasts 0.035 s, with a wait
of 0.020 s between exposures. After that, the light source is
turned off, and a stack of 400 images is saved in the same
condition. The first stack (the data stack) is then averaged;
the median of each pixel of the second stack (the background
stack) is calculated; and then the background is subtracted
from the data sum average. The resulting data is then underMNRAS 000, 1–12 (2019)

Figure 12. Response of the spatial light modulator to a defocus
command, as measured by the HASO.

sampled by a factor 4 for the sake of calculation speed, and
constitutes the data i0foc that will be input into COFFEE.
Then the whole procedure is repeated, this time with
the spatial light modulator being sent a 75 nm defocus. The
resulting data, i0div , joins i0foc to constitute i0 , the complete
COFFEE input for the reconstruction. This input is displayed on the bottom part of Fig. 13.

4.3.2

Reconstruction

We perform an estimation of φ0up using i0 as input data,
along with the model of the bench calibrated in the previous
section. The estimate d
φ0 of the reference wavefront φ0 is
up

shown on Fig. 14. Its root mean square is 24 nm.

up

10

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan

Figure 15. Non-coronagraphic pupil image of a high-frequency
aberration.

Figure 13. Bottom left: focused experimental coronagraphic image for the reference wavefront. Bottom right: diversity (75 nm defocus) experimental coronagraphic image for the reference wavefront. Top left: focused experimental coronagraphic image for the
high-frequency aberration wavefront. Top right: diversity (75 nm
defocus) experimental coronagraphic image for the high frequency
aberration wavefront. The colorbar is expressed relatively to the
maximum of intensity and is non-linear (asinh function) to best
display the structure of the point spread functions and the differences between them. There is a slight difference between the
top and the bottom row, for example there is a speckle on the
horizontal axis just on the right of the core of the PSF in the
high-frequency aberration images (top) that is absent from the
reference wavefront images (bottom).

d
F
Figure 16. Estimated high-frequency aberration phase, φ
up

then the background is subtracted from the data sum average. The resulting data is then under-sampled by a factor 4
for the sake of calculation speed, and constitutes the data
i1foc that will be input into COFFEE.
Then the whole procedure is repeated, this time with
the spatial light modulator being sent a 75 nm defocus on
top of the F-shape aberration. The resulting data, i1div , joins
i1foc to constitute i1 , the complete COFFEE input for the
reconstruction. This input is displayed on the top part of
Fig. 13.

4.4.2

Reconstruction

F using i1 as input data,
We perform an estimation of φ0up + φup
along with the model of the bench calibrated in the previous
0 + φ F of the high-frequency wavesection.The estimate φ
up

up

F is shown on Fig. 16. Its root mean square is
front φ0up + φup
28 nm.

d
0
Figure 14. Estimated reference phase, φ
up

4.4.3
4.4
4.4.1

Estimation of a high-frequency aberration
Data

The spatial light modulator is now sent a F-shape command.
The corresponding pupil image (taken when no coronagraph
was in place) is displayed on Fig. 15. The root mean square
of this command is 11 nm.
F on
The resulting phase aberration is denoted by φup
Fig. 8. Just like before, a stack of 400 images is saved. Each
exposure lasts 0.035 s, with a wait of 0.020 s between exposures. After that, the light source is turned off, and a stack
of 400 images is saved in the same condition. The first stack
(the data stack) is then averaged; the median of each pixel
of the second stack (the background stack) is calculated; and

Differential reconstruction

0 + φ F and φ0 is our estimate d
F
φup
The difference between φ
up
up
up
F
of the introduced F-shape aberration, φup . It is displayed on
Fig. 17. The estimate has a root mean square of 13 nanometres, whereas the introduced aberration has a root mean
square of 11 nanometres. We conclude that we are able to
reconstruct a high-frequency aberration of about 10 nanometres with a 2 nanometres accuracy, using the scientific camera of a coronagraphic system in the presence of turbulence.
The total computing time necessary for the reconstruction of the aberration is about two hours and a half on a single core of an office computer equipped with a 2.6 GHz Intel
processor, running a COFFEE program written in Interactive Data Language, without much optimisation. Therefore,
using a modern computer running an optimised code, quasi-

MNRAS 000, 1–12 (2019)

Coronagraphic phase diversity through residual turbulence

F , the 13-nm root mean square estimate of the
Figure 17. φup
introduced 11-nm root mean square F-shape aberration.

static aberrations compensation could be performed on an
instrument such as SPHERE at least once per hour.

5

CONCLUSIONS

We have presented coronagraphic phase diversity through
turbulence as a post-coronagraphic wavefront sensor
adapted to high-precision wavefront measurement in the
presence of adaptive optics-corrected turbulence. We have
performed realistic simulations which show that the estimation error when used on a high-contrast system such as
SPHERE should not exceed a few nanometres, whereas the
quasi-static aberration of SPHERE is about 50 nanometres. Finally, we have performed a laboratory demonstration of the validity of the technique, reconstructing a highfrequency aberration with a precision of about two nanometres through a coronagraph and turbulence. Our team’s next
step in to perform a measurement and correction of quasistatic aberrations on SPHERE, thanks to data collection by
A. Vigan and M. N’Diaye. Since we demonstrated coronagraphic phase diversity in the presence of residual adaptiveoptics-corrected turbulence, since there are no intrinsic chromatic limitations with COFFEE, and since the execution
time of the program allows it to be executed several time
during the night, we hope to soon prove that it is efficient
on-sky.

ACKNOWLEDGEMENTS
The PhD work of O. Herscovici-Schiller was co-funded by
CNES and ONERA. We thank J.-M. Le Duigou for his support. This work received funding from the E.U. under FP7
Grant Agreement No. 312430 OPTICON, from the CNRS
(Défi Imag’In), and from ONERA in the framework of the
VASCO research project. We thank Raphaël Galicher for
helpful criticism of a first draft of this paper. We thank the
reviewer for their careful review and constructive comments,
which helped us to improve this article.

REFERENCES
Beuzit J.-L., et al., 2008, in Ground-based and airborne instrumentation for astronomy II. p. 701418
Blanc A., Fusco T., Hartung M., Mugnier L., Rousset G., 2003,
Astronomy & Astrophysics, 399, 373
MNRAS 000, 1–12 (2019)

11

Fétick R. J. L., Neichel B., Mugnier L. M., Montmerle-Bonnefois
A., Fusco T., 2018, Monthly Notices of the Royal Astronomical Society, 481, 5210
Galicher R., Baudoz P., Rousset G., 2008, Astronomy & Astrophysics, 488, L9
Gonsalves R. A., 1982, Optical Engineering, 21, 215829
Herscovici-Schiller O., Mugnier L. M., Sauvage J.-F., 2017,
Monthly Notices of the Royal Astronomical Society: Letters,
467, L105
Herscovici-Schiller O., Mugnier L. M., Baudoz P., Galicher R.,
Sauvage J.-F., Paul B., 2018, Astronomy & Astrophysics, 614,
A142
Leboulleux L., 2018, Thèse de doctorat, Université d’AixMarseille
Macintosh B. A., et al., 2008, in Adaptive Optics Systems. p.
701518
Martinez P., Loose C., Carpentier E. A., Kasper M., 2012, Astronomy & Astrophysics, 541, A136
Martinez P., Kasper M., Costille A., Sauvage J. F., Dohlen K.,
Puget P., Beuzit J. L., 2013, Astronomy & Astrophysics, 554,
A41
Meynadier L., Michau V., Velluet M.-T., Conan J.-M., Mugnier
L. M., Rousset G., 1999, Applied optics, 38, 4967
Mugnier L. M., Fusco T., Conan J.-M., 2004, JOSA A, 21, 1841
Mugnier L. M., Blanc A., Idier J., 2006, in Hawkes P., ed.,
, Vol. 141, Advances in Imaging and Electron Physics.
Elsevier, pp 1–76, doi:10.1016/S1076-5670(05)41001-0,
http://www.sciencedirect.com/science/article/pii/
S1076567005410010
N’Diaye M., Dohlen K., Fusco T., Hadi K. E., Soummer R., Cuevas S., Zerrad M., Ferrari M., 2012,
in Modern Technologies in Space- and Groundbased Telescopes and Instrumentation II. International Society for Optics and Photonics, p. 84500N,
doi:10.1117/12.926876, https://www.spiedigitallibrary.
org/conference-proceedings-of-spie/8450/84500N/
Lab-results-of-the-circular-phase-mask-concepts-for-high/
10.1117/12.926876.short
N’Diaye M., Dohlen K., Fusco T., Paul B., 2013, Astronomy &
Astrophysics, 555, A94
Paul B., 2014, Thèse de doctorat, Université d’Aix-Marseille,
https://tel.archives-ouvertes.fr/tel-01080626/
document
Paul B., Mugnier L. M., Sauvage J.-F., Dohlen K., Ferrari M.,
2013a, Optics Express, 21, 31751
Paul B., Sauvage J.-F., Mugnier L. M., 2013b, Astronomy & Astrophysics, 552, A48
Photometrics 2014, CoolSNAP(TM) HQ2 Monochrome
Datasheet,
https://www.photometrics.com/products/
ccdcams/coolsnap_hq2.php
Rigaut F. J., Véran J.-P., Lai O., 1998, in Adaptive Optical System Technologies. pp 1038–1049
Roddier F., 1981, in , Vol. 19, Progress in optics. Elsevier, pp
281–376
Sauvage J.-F., Mugnier L., Paul B., Villecroze R., 2012, Optics
Letters, 37, 4808
Seldin J. H., Paxman R. G., Zarifis V. G., Benson L., Stone R. E.,
2000, in Imaging technology and telescopes. pp 48–64
Vigan A., et al., 2018, in Adaptive Optics Systems VI. International Society for Optics and Photonics, p. 107035O,
doi:10.1117/12.2313656, https://www.spiedigitallibrary.
org/conference-proceedings-of-spie/10703/107035O/
On-sky-compensation-of-non-common-path-aberrations-with-the/
10.1117/12.2313656.short
Véran J.-P., Rigaut F., Maı̂tre H., Rouan D., 1997, J. Opt. Soc.
Am. A, 14, 3057

12

O. Herscovici-Schiller, J.-F. Sauvage, L. M. Mugnier, K. Dohlen & A. Vigan

This paper has been typeset from a TEX/LATEX file prepared by
the author.

MNRAS 000, 1–12 (2019)

