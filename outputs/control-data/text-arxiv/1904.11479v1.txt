A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH
IWAHORI LEVEL STRUCTURES
HAO LI

arXiv:1904.11479v1 [math.NT] 25 Apr 2019

A BSTRACT. In this paper I’m going to study the intersection of two Heegner-Drinfeld cycles coming from two different nonsplit tori on the Yun-Zhang moduli stack of PGL2 Drinfeld stukas with
Iwahori level structure. We will see that the intersection number is related to a certain period
integral. It is an extension of the result by Howard-Shinidman to the Iwahori case.

1. I NTRODUCTION
In their secomd volumn[7], Yun-Zhang generalized their previous work[6] to the moduli
stack of shtukas with Iwahori level structure and Heegner-Drinfeld cycles coming from a double cover with ramification points away from the level. A natural question is whether one can
do a similar thing for Heegner-Drinfeld cycles coming from two different double covers, i.e. relating the intersection number of two Heegner-Drinfeld cycles attached to two different double
covers (or rather their certain Hecke eigen-parts) with automorphic L-functions with Iwahori
levels, like what Howard and Shnidman did previously in the no level structure case[4]. This
case can be viewed as a function field analogue of the Gross-Kohnen-Zagier formula[2].
In this paper I will give the answer to this question in the case where the two double covers
are still everywhere nonramified. Let p be a prime number greater than 2, k a finite field of
characteristic p with cardinality q (i.e. Fq ). Let X be a smooth geometrically connected curve
over k of genus g with F its field of rational functions. Take two everywhere nonramified double
covers Y1 and Y2 of X, and let Y = Y1 × X Y2 be the associated fourfold cover X. Then there exists
a unique third double cover over X, Y3 , below Y different from Y1 and Y2 , and they fit into the
following diagram:
Y
π1

Y1

~

π3

(1.1)
π2


Y3
ν1

ν3

 ~
X

Y2
ν2

The generic fiber of this diagram gives the field extension diagram:
K
π1

K1

π3

(1.2)
π2


K3
~

ν1

ν3

 ~
F

K2
ν2

ei =
Let A be the adelic ring of F and Ai be the adelic ring of Ki for i = 1, 2, 3. Also let T
×
×
×
ei /Gm,X . Then one has T
ei ( F ) = K and Ti ( F ) = K /F .
ResYi /X Gm,Yi and Ti = T
i
i
Let Σ ⊂ | X | be a finite set of physical points of X of total degree N, this will be the “level”.
Like what Yun and Zhang did in their second volumn, one needs to consider the splitting
Date: April 22, 2019.
1

2

HAO LI

behavior of points in Σ in the double covers. In order to make the question under consideration
here meaningful, I require the following: there exist a partition of Σ:
Σ = Σ f t Σ∞
such that: Any x ∈ Σ f splits in both Y1 and Y2 , and any x ∈ Σ∞ is inert in both the double
covers. Let S∞ = ∏ x∈Σ Speck x and G = PGL2,X . Yun-Zhang defined the moduli of shtukas
with Iwahori level structures ShtrG (Σ; Σ∞ ). It is a smooth Deligne-Mumford stack of dimension
2r equipped with a map:
ΠrG : ShtrG (Σ; Σ∞ ) −→ X r ×k S∞
0 , S0
To define the Heegner-Drinfeld cycle for Y1 , Y2 , one needs something similar to S∞ : S1,∞
2,∞
e ∞ . They are all zero dimensional schemes over k and fit into the following diagram:
and S

e∞
S

0
S1,∞

}

!
0
S2,∞
!

S∞

}

e ∞ needs some explainaI refer you to section 2.6 for the precise meaning of them because S
tion. Also, one needs a choice of auxilary data: µ := (µ, µ f , µ∞ ) ∈ {±1}r × {±1}Σ f × {±1}Σ∞ .
µ

0 )
With its help , one can define a smooth Deligne-Mumford stack of dimesion r, Sht T (µ∞ · Σi,∞
i
equipped with a map:
µ

0
0
) −→ Yir ×k Si,∞
Sht T (µ∞ · Σi,∞
i

For i = 1, 2. For some technical reasons, I will consider the following intersection problem: Let
e ∞ (k ), consider the following morphism:
ξ∈S
µ

0
Sht T (µ∞ · Σi,∞
) ×S0 ξ −→ ShtrG (Σ; Σ∞ ) ×S∞ ξ
i

i,∞

µ
Zi ( ξ )

Let
be the push foward of the fundamental cycle of the left hand side along this morphism.
Yun-Zhang proved the following “coarse spectral decomposition” of the total cohomology
of ShtrG (Σ; Σ∞ ) ([7], Theorem 3.41) (By total cohomology I mean not the cohomology of the
generic fiber): Let V (ξ ) = Hcr (ShtrG (Σ; Σ∞ ) ×S∞ ξ, Ql ), then one has the decompostion:
V (ξ ) ⊗ Ql = V (ξ )π ⊕ (VEis (ξ ) ⊗ Ql )
In which π runs through all the automorphic representations of PGL2,F with Iwahori level at
µ
µ
Σ. Let Zi,π be the projection to the π-th part of the cycle class of Zi .
e3 = GL2,ν O be the X-group scheme whose functor of
Following Howard-Shnidman, let G
∗

Y3

e3 /Z ( G
e3 ).
points on an X-scheme f : U −→ X is given by H 0 (U, EndOU ( f ∗ (ν∗ OY3 )) and G3 = G
Then T3 is canonically sitting inside G3 . It’s generic fiber is isomorphic to the generic fiber
of PGL2,X though they are different X-schemes. The choice of auxilary data (µ f , µ∞ ) above
determines an isomorphism:
∼

G3 (A) −
→ G (A)
Let π be an automorphic representation of G (A) and φ ∈ π. Using the above isomorphism,
π3

one can view φ as an automorphic form on G3 (A), denoted by φ3 . The double cover Y −→ Y3
determines a quadratic character η of T3 (A) = A3× /A× . Then it is legitimate to define the
following global period integral of φ:
P0 (φ, s) =

Z
[ A]

φ(t0 )|t0 |s dt0

P3 (φ, s) =

Z
[ T3 ]

φ3 (t3 )η (t3 )dt3

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

3

In which A is the standard diagonal torus of G, [ A] = A( F )\ A(A) and [ T3 ] = T3 ( F )\ T3 (A).
Then the first main result is the following:
Theorem 1.1. Fix the choice of µ = (µ, µ f , µ∞ ) and ξ and N = degΣ as above. Let π be an automorphic represetation of G (A) with Iwahori level at Σ. Let φ ∈ π be the vector whose local components are
hyperspecial fixed away from Σ and Iwahori fixed at Σ. Then one has:

( Z1,π (ξ ), Z2,π (ξ )) = (logq)−r (
µ

µ

P0 (φ, s)P3,η (φ3 )
d r
) |s=0 (q Ns
)
ds
hφ, φi

Let χ1 and χ2 be quadratic characters of A× determined by the double covers Y1 and Y2
respectively. Let L(π ⊗ χ1 , s) and L(π ⊗ χ2 , s) be the twisted L-functions. Also, one defines
L (π, s) = q2g−2+ N L(π, s) to be the normalized L-function. The period integral is actually
related to the product of these L-functions, as in the case worked out by Howard-Shnidman.
This leads to the following corollary.
Theorem 1.2. In the notations as above, one has:
µ

µ

( Z1,π (ξ ), Z1,π (ξ )) = 0
is equivalent to:
L (r) (π, 1/2) · L(π ⊗ χ1 , 1/2) · L(π ⊗ χ2 , 1/2) = 0
Also, in their paper, Howard and Shnidman computed the plain pairing of the two cycles,
i.e. without projecting to the π-th eigenpart ([4], Theorem C). Here one also has a slightly
different result:
Theorem 1.3. Again, with the notations above,
µ

µ

( Z1 (ξ ), Z2 (ξ )) = 0
For the precise meaning of those symbols, please go to the main body of the paper.
The method of proof basically follows the philosophy of Yun-Zhang, with some technical ingredients from Howard-Shnidman. In the second section I’m going to review the moduli stack
of shtukas with Iwahori level structure defined by Yun and Zhang, and introduce the HeegnerDrinfeld cycles to be used in this paper. The third section is devoted to the construction of the
auxilary moduli spaces, which Yun calls “the Hitchin type moduli spaces”[5]. In the fourth
section the intersection pairing is computed by applying the Grothendieck-Lefschetz trace formula to the relative cohomology of the “Hitchin type fiberation”. Then I’ll move to the analytic
side of the picture, relating the geometric side of the relative trace formula with the relative
cohomology of a certain local system for the “dual Hitchin type fiberation”. Then the main result would follow from comparing the cohomological side of the two Grothendieck-Lefschetz
formulae. I’m also going to prove the other two theorems in the last section.
The reason I still work with everywhere nonramified covers is that I will use descent along
torsors in section 3. In the more general case in which the covers are ramified at some points
away from the level, I hope the more general fppf-descent can work. I’ll probably return to this
topic later.
2. T HE SHTUKA SIDE SET UP
In this section I review Yun-Zhang’s definition of moduli of shtukas with Iwahori level structure and define the Heegner-Drinfeld cycles with which I’m going to work later.
2.1. Splitting behavior of Σ in Y3 . Recall Y1 , Y2 and Y3 are the three everywhere nonramified
double covers in the introduction. Y is the associated fourfold cover and Σ be the set of closed
point in | X | satisfying following condition:
Σ = Σ f t Σ∞
and any x ∈ Σ f splits in both Y1 and Y2 , and any x ∈ Σ∞ is inert in both the double covers. One
also needs to know the splitting behavior of each x ∈ Σ in Y3 . Actually , by an easy exercise of
class field theory, one has the following:

4

HAO LI

Proposition 2.1. All the points in Σ split in Y3 .
Then we have the following complete description of the splitting behavior of x ∈ Σ in all the
covers:

• Each x ∈ Σ f has two physical points (just prime ideals) over it in each Yi for i = 1, 2, 3,
and four points over it in the top cover Y. Let y x , y0x be the two points over x in Y1 ,
z x , z0x be the two points over x in Y2 . Then one can denote the four preimages of x in
Y by (y x , z x ), (y0x , z x ), (y x , z0x ), (y0x , z0x ). Then let wx be the point in Y3 below (y x , z x ) and
(y0x , z0x ), w0x be the point below (y0x , z x ), (y x , z0x ).
• Each point x ∈ Σ∞ has one physical point with residue extension of degree 2 in each
Yi , i = 1, 2. Each of these points over x is split in the top cover, so two physical points
above. x has two physical points above it in Y3 , and these two points are both inert in
Y.
2.2. Review of the moduli of G-torsor over a curve with Iwahori level structures. In their
second volume, Yun and Zhang defined the moduli stack of G-torsors over X with Iwahori
level structure at Σ ([7], section 3.1). First, let Bun2 (Σ) be the functor from the category of
k-schemes to the category of groupoids whose S points are the following:
1
E † = (E , {E (− )} x∈Σ )
2
in which:

• E is a rank 2 vector bundle over the product X ×k S.
• For each x ∈ Σ, a rank 2 vector bundle E (− 12 x ) who fits into the following chain of
coherent sheaves:
1
E ⊃ E (− x ) ⊃ E (− x ) := E ⊗ O X (− x )
2
such that the quotient sheaf E /E (− 21 x ) is a skycrayper sheaf supported on the subscheme
{ x } × S.
Let Pic X be the Picard stack of X, i.e. the stack whose S points are line bundles over X ×k S.
Pic X acts Bun2 (Σ) by simultenously twisting E and all E (− 12 x ). Then BunG (Σ) is defined to be
the quotient:
Bun2 (Σ)/Pic X
Of course, they defined these stacks for general GLn and PGLn , and their definition can be
easily extended to arbitrary parahoric level structures, but here I only work with n = 2, so I just
review this simpler case.
Actually the dimension of BunG (Σ) is well known:
Proposition 2.2. BunG (Σ) is an Artin stack of dimension 3( g − 1) + N
One already knows that the plain BunG is of dimension is 3( g − 1), the Iwahori level structure just ”adds” N copies of P1k to it, hence the above number.
2.3. Fractional twists and Atkin-Lehner involution. To define the moduli of shtukas with
level structures, Yun-Zhang introduced fractional twists and Atkin-Lehner involution for vector bundles with Iwahori level structures ([7], Definition 3.2). Again, I only review what I need
here, for the more general cases, you can just go to read their paper.
First we define:
S∞ = ∏ Speck x
x ∈Σ

An S point of S∞ is simply a set of maps: x (1) −→ Speck x for each x ∈ Σ∞ . Let x (i+1) =
x (i) ◦ FrS . Let d x = [k x : k], we get d x maps from S to Speck x .
As in their paper, one has the canonical point:
x(1) : S∞ −→ Speck x −→ X

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

5

for each x ∈ Σ∞ . It is simply projection followed by injection. Let x(2) = x(1) ◦ FrS∞ . Let Γx(i)
be the graph of x(i) . Then we have the following:
dx

Speck x ×k S∞ =

ä Γ x( i )

i =1

Take an S point E † , of Bun2 (Σ) × S∞ . Then S acquires a k x structure for each x ∈ Σ∞ . Therefore
we have:
dx

Speck x ×k S =

ä S (i )

i =1

S (i )

x (i ) .

In which
is the image of
By the definition of E † , E /E (− 12 x ) is supported on these d x copies of Ss, therefore splits into
( j)

( j)

a direct sum ⊕dj=x 1 Li , where Li

is supported on the j-th copy of S, S( j) .

( j)

( j)

Let D = ∑ x∈Σ∞ ∑1≤ j≤dx c x x(1) , In which all c x ∈ 12 Z. Yun and Zhang defined the fractional
twist by D of E † as follows: First define:
1
1
( j) 
E (− x ( j) ) := ker E −→ E /E (− x ) −→ Li
2
2
Then for any D as above, first rewrite it as D = D0 − D1 , in which D0 is an integral divisor on
( j)

( j)

X ×k S∞ and D1 = ∑ x∈Σ∞ ∑1≤ j≤dx ix2 x ( j) x(1) in which each i x is either 0 or 1. Define E (− D1 )
as the kernel of the following direct sum of projections:

E −→ ⊕ x∈Σ∞ ,1≤ j≤dx E /E (−

( j)
ix 
)
2

Then define E ( D ) := E (− D1 ) ⊗OX× S∞ OOX× S∞ . For E (− 12 x ), apply the same operation to the
k
k
chain:
1
E (− x ) ⊃ E (− x )
2
1
One can get the corresponding E ( D )(− 2 x ). This process defines the following map:
f ( D ) : Bun2 (Σ) ×k S∞ −→ Bun2 (Σ)
AL

(2.1)

quotient out the simultenous twisting by Pic X , one has the follow:
AL( D ) : BunG (Σ) ×k S∞ −→ BunG (Σ)
This is the Atkin-Lehner involution of BunG (Σ).
As in their paper, for the moduli of shtukas to be used later, one only cares about the case
(1)

(1)

D∞ = ∑ x∈Σ∞ 12 x(1) , and the Atkin-Lehner involution by − D∞ . Again let E † be an S point of
Bun2 (Σ). Then we simply have:
1
(1)
E (− D∞ ) = ker E −→ E (− x (1) ))
2
i.e.The sections of E who is belong to E (− 21 ) on the first copy of S, S(1) .
2.4. The Hecke stack. To define moduli of shtukas, one also has to review the Hecke stack for
BunG (Σ) ([7], Definition 3.3).
Let r be a nonnegative integer, and let µ = (µ1 , ..., µr ) ∈ {±1}r .
µ

Definition 2.3. Let Hk2 (Σ) be the stack over k whose S-points is the following:

• A sequence of r + 1 rank 2 vector bundles with Iwahori level structure: Ei† = (Ei , {Ei (− 21 x )} x∈Σ ) ∈
BunG (Σ)(S) in which i = 0, 1, ..., r.
• r morphisms xi : S −→ X for i = 1, ..., r, with the graph Γ xi ⊂ X ×k S.

6

HAO LI

• Isomorphism of vector bundles
∼

f i : E i −1 | X × k S − Γ x −
→ Ei | X ×k S−Γ x
i

i

for i = 1, ..., r, such that the induced relative position on the formal neighbourhood of
Γ xi is µi , and f i respects the filtration given by Ei−1 (− 12 x ) and Ei (− 21 x ) for all x ∈ Σ.
µ

µ

Let Hk G (Σ) := Hk2 (Σ)/Pic X .
µ

From the definition, one has the projections from Hk2 to X r recording the points of modifications xi (people call them pattes, recently the term “legs” becomes popular). Also, to record
the ith bundle with Iwahori level structure Ei† , one has the following projections:
µ

pei : Hk2 (Σ) −→ Bun2 (Σ)
for i = 0, ..., r. Again, quotient out the simultanous twist by Pic X , we get the following:
µ

pi : Hk G (Σ) −→ BunG (Σ)
Yun and Zhang proved the following geometric properties of the Hecke stacks ([7], Proposition
3.4).
µ

Proposition 2.4.
(1) For 0 ≤ i ≤ r, the projection map pei : Hk2 (Σ) −→ Bun2 (Σ) is smooth of
relative dimension 2r.
µ
µ
(2) For 0 ≤ i ≤ r, the morphism ( pei , π H k ) : Hk2 (Σ) −→ Bun2 (Σ) ×k X r is smooth of relative
dimension r when restricted to Bun2 (Σ) ×k ( X − Σ)r .
µ
µ
(3) For 0 ≤ i ≤ r, the morphism ( pei , π H k ) : Hk2 (Σ) −→ Bun2 (Σ) ×k X r is flat of relative
dimension r.
µ
(4) All of the above hold for Hk G (Σ) and Bun G (Σ).
These properties are needed later.
2.5. The moduli of shtukas. Now we are ready to review the definition of the moduli of
(i )

shtukas ([7], section 3.2). First define the moduli of shtukas for GL2 . Let D∞ = {∑ x∈Σ∞ ,1≤ j≤dx c x x(1) :
( j)

ci ∈ 12 Z}. Take a µ ∈ {±1}r . To define the moduli of stukas attached to D∞ ∈ D∞ and µ, one
furthur requires the following condition:
r

∑ µi =

i =1

∑

x ∈Σ∞ ,1≤ j≤d x

cix = 2degD∞

(2.2)

Once one sees the following definition of the moduli of shtukas, it is clear why there should be
such a relation.
µ

Definition 2.5. Define the stack Sht2 (Σ; D∞ ) as the following Cartesian diagram:
/ Hkµ (Σ) ×k S∞
2

µ

Sht2 (Σ; D∞ )


( pe0 ,AL(− D∞ )◦( per ×idS∞ ))

ω0

Bun2 (Σ)

(2.3)

(id,Fr )


/ Bun2 (Σ) × Bun2 (Σ)

µ

More precisely, an S point of Sht2 (Σ; D∞ ) consists of the following data:

• A map: S −→ S∞ , which gives x (1) : S −→ Speck x for each x ∈ Σ∞ ;
• r morphisms xi : S −→ X for i = 1, ..., r, with the graph Γ xi ⊂ X ×k S.
• A sequence of modifications, which starts at E0† and ”ends at” τ E0 ( D∞ ):
E0

f1

/ E1

f2

/ ......

fr

/ Er

ι

/ τ E 0 ( D∞ )

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

7

each f i is a modification from Ei−1 to Ei of relative position µi around Γ xi , respecting the
filtration as in the definition of the Hecke stack, and ι at the end is an isomorphism. τ E0
is the pull back of E0 along the map:
id X × FrS

X ×k S −−−−→ X ×k S
Now the restriction above is clear: Modification by f i changes the degree by µi , therefore:
r

∑ µi

degτ E0 ( D∞ ) − degE0 =

i =1

This implies that one must have the above restriction, because otherwise the stack would be
empty.
Define the moduli of shtukas for G as the quotient by the discrete groupoid Pic X (k):
µ

µ

ShtG (Σ; D∞ ) = Sht2 (Σ; D∞ )/Pic X (k)
Then it fits into the following Cartesian diagram:
/ Hkµ (Σ) ×k S∞
G

µ

ShtG (Σ; D∞ )


Let

µ

( pe0 ,AL(− D∞ )◦( per ×idS∞ )

ω0

BunG (Σ)

(2.4)

(id,Fr )

µ


/ BunG (Σ) × BunG (Σ)
µ

ΠG,D∞ = (πG , πG,∞ ) : ShtG (Σ; D∞ ) −→ X r ×k S∞

(2.5)

be the map recording the points of modification and the S∞ structure of S.
µ
Yun and Zhang proved the following properties of ShtG (Σ; D∞ ) ([7], Proposition 3.9):
µ

(1) The stack Sht G (Σ; D∞ ) is Deligne-Mumford of dimension 2r.

Proposition 2.6.
µ

µ

(2) ΠG,D∞ = (πG , πG,∞ ) is separated, and is smooth of relative dimension r when restricted to
( X − Σ ) r × S∞
Recall that we have fixed a rational divisor on the scheme X ×k S∞ , D∞ = ∑ x∈Σ 12 x(1) . Define:
µ
µ
ShtG (Σ; Σ∞ ) := ShtG (Σ; D∞ )
(2.6)
For the following rs, µs and D∞ s:
r = #Σ∞ mod2

D∞ ∈ D∞ , and

r

∑ µi = 2degD∞

(2.7)

i =1

They proved that for the above D∞ s, the Atkin-Lehner involutions:
AL(− D∞ ) : BunG (Σ) ×k S∞ −→ BunG (Σ)

(2.8)

(1)
AL(− D∞ )

f (− D∞ )), and the right hand side of (2.6) is
all agree with
(of course not for AL
independent of choice of µ and D∞ as long as the above conditions are satisfied.
2.6. Hecke correspondence for moduli of shtukas. Now review the Hecke correspondences
([4], section 3.3). Let’s define the partial spherical Hecke algebra as the following:
HGΣ = ⊗ x∈| X −Σ| Hx

(2.9)

in which Hx is the local spherical Hecke algebra with Q coefficients. It has a basis indexed by
the group of effective divisors of X − Σ, i.e. Div+ ( X − Σ).
Let D ∈ Div+ ( X − Σ) be an effective divisor, then define the associated ”vertical Hecke
modification” stack as follows:
µ

Definition 2.7. Sht2 (Σ; D∞ ; h D ) is the functor from k−schemes to groupoids whose category of
S points is the following data:

• A map: S −→ S∞ , which gives x (1) : S −→ Speck x for each x ∈ Σ∞ ;
• r morphisms xi : S −→ X for i = 1, ..., r, with the graph Γ xi ⊂ X ×k S.

8

HAO LI

µ

• Two of the points of Sht2 (Σ; D∞ )(S), say (Ei† , f i , ι, ...) and (Ei0† , f i0 , ι0 , ...) sharing the
above data, i.e. map to the same point in S∞ , points of modifications xi , together with
injections of coherent sheaves φi , fitting into the following diagram:
f1

E0
φ0

/ E1

f2

/ ......

fr

/ ......

f r0

/ Er

φ1


E00

f 10


/ E0
1

/ τ E 0 ( D∞ )

ι

φr

f 20


/ Er0



ι0

(2.10)

τφ
0

/ τ E 0 ( D∞ )
0

such that each φi preserves the Iwahori level structure (i.e. sending E (− 21 x ) to E 0 (− 12 x )
for all x ∈ Σ); the induced maps φi : det(Ei−1 ) −→ det(Ei ) has divisor D ×k X ⊂ X ×k S.
As usual, define:
µ

µ

ShtG (Σ; Σ∞ ; h D ) := Sht2 (Σ; D∞ ; h D )/Pic X (k)

(2.11)

and the map recording the points of modifications and S∞ -structure:
µ

ΠrG (h D ) : ShtG (Σ; Σ∞ ; h D ) −→ X r ×k S∞
µ

By definition, it is a self-correspondence of ShtG (Σ; Σ∞ ; h D ) over X r ×k S∞ , i.e. one has the
following diagram:
µ

←
−
p

ShtG (Σ; Σ∞ ; h D )

(2.12)
−
→
p

w
µ
ShtG (Σ; Σ∞ )

'
µ
ShtG (Σ; Σ∞ )
(
v
X r × k S∞

It has the following properties:
Proposition 2.8. Let D ∈ Div+ ( X − Σ).
−
→
(1) Both ←
p and −
p are proper and representable;
−
→
(2) Over ( X − Σ)r , both of ←
p and −
p are fintie étale;
µ

(3) The fibers of ΠrG (h D ) : ShtG (Σ; Σ∞ ; h D ) −→ X r ×k S∞ have dimension r.
For the detail of the proof, one just reads Yun-Zhang’s second volume.
These Hecke correspondences induces the following ring homomorphisms:
Proposition 2.9. One can extend the map:
µ
−
→
h D −→ (←
p ×−
p )∗ ShtG (Σ; Σ∞ ; h D )

(2.13)

HGΣ −→ c Ch2r (ShtG (Σ; Σ∞ ) × ShtG (Σ; Σ∞ ))Q

(2.14)

to a ring homomorphism:
µ

µ

which in turn allow HGΣ to act on the group of compactly supported Chow cycles.
2.7. The Heegner-Drinfeld cycles. Now we define the Heegner-Drinfeld cycles for Y1 and Y2 ,
with some auxilary choice of data.
As one has seen in the last section, over a certain point x ∈ Σ∞ , there is one point over it in
each Yi , i = 1, 2 respectively, which we denoted y x , z x , and there are two points over it in Y. We
choose one of these two points for each x ∈ Σ∞ and denoted it by v x , and call the other point by

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

9

v0x . The corresponding points below them in Y3 are denoted by wx and w0x respectively. Then
define the following:
S0∞,1 = Π x∈Σ Speck yx
S0∞,2 = Π x∈Σ Speck zx
e ∞ = Π x∈Σ Speck vx
S
From the definition, one can see that there are cononical maps:
e ∞ = Π x∈Σ Speck vx −→ S0∞,1 = Π x∈Σ Speck yx ;
S
e ∞ = Π x∈Σ Speck vx −→ S0∞,2 = Π x∈Σ Speck zx
S
(1)

(1)

(1)

Similar to the case of S∞ , denote the following by yx , zx , vx :
S0∞,1 −→ Speck yx −→ Y1
S0∞,2 −→ Speck zx −→ Y2
e ∞ −→ Speck vx −→ Y
S
in which the first arrows are the projection and the second arrows are the natural injections.
( i −1)

(i )

( i −1)

(i )

Similar to x(i) , define yx = yx
◦ FrS0 , zx = zx
∞,1
has the following decomposition:

( i −1)

(i )

◦ FrS0 , vx = vx
∞,2

◦ FrSe ∞ . Then one

e ∞ = ä2dx Γ (i)
Speck vx ×k S
i =1 v
x

t
x
Speck yx ×k S0∞,1 = ä2d
i =1 Γ y( i )

*
x
Speck zx ×k S0∞,2 = ä2d
i =1 Γ z( i )

x

x

*
t
Speck x ×k S∞ = äid=x 1 Γx(i)
For Γ

(i )

yx

and Γ

we also use Γ

(i ) ,

Γ

(i )

(i )

zx

(i )

vx

(yx ,zx )

e ∞ sitting above them. For this reason,
is the unique piece in Speck vx ×k S

to denote Γ

However, for each Γ

(i )

yx

(or Γ

(i ) .

vx

(i ) ),

zx

Γ

(i )

vx

e ∞ . Just as
does not exhaust its preimage in Y ×k S

Speck vx ×k Y, Speck v0x ×k Y also decomposes into 2d x pieces, and for Γ

(i )

yx

and Γ

( d x +i )

zx

(( d x + i )

is understood to be mod2d x ), there is a unique piece of Speck v0x ×k Y sitting over them, let it be
Γ(y(i) ,z(dx +i) ) . Then one has:
2d x

Speck v0x ×k Y =

ä Γ(y(i) ,z(dx +i) )

i =1

e ∞ , one gets y(i) : S −→ Speck yx −→ Y1 and z(i) : S −→
For a k-scheme S with S −→ S
Speck yx −→ Y2 . One has a diagrams for S similar to the one above:
x
Speck vx ×k S = ä2d
i =1 Γ(y(i) ,z(i) )
x

t
x
Speck yx ×k S = ä2d
i =1 Γ y (i )
x


Speck wx ×k S
*

t
Speck x ×k S = äid=x 1 Γ x(i)

x

*
x
Speck zx ×k S = ä2d
i =1 Γ z (i )
x

10

HAO LI

and
x
Speck v0x ×k S = ä2d
i =1 Γ(y(i) ,z(d x +i) )
x

t

Speck yx ×k S =

2d
äi=x1

Γ

x

*
x
Speck zx ×k S = ä2d
i =1 Γ z (i )



Speck w0x ×k S

(i )

yx

x

*

t
Speck x ×k S = äid=x 1 Γ x(i)
(i )

(i )

(i )

(i )

For simplicity, I will just use y x , z x and (y x , z x ) to denote Γ
(i )

ple, I will write L(y x ) for L(Γ
Γ

(i ) .

(i )

yx

(i ) , Γ (i )
zx

yx

and Γ

(i ) (i )

(y x ,z x )

. For exam-

) to mean twisting the line bundle L on X ×k S by the divisor

yx

Now let’s review the definition of Ti -shtukas, I will only do this for i = 1 and i = 2 is all the
same.
First Let
Bun Ti = PicYi /Pic X

(2.15)

and
µ

µ

Hk T = Hk1,Y /Pic X
i

(2.16)

i

for µ ∈ {±1}r be as usual. Of course, one knows the following properties of them ([6], Remark
5.2, section 5.4.4):
Proposition 2.10.

(1) Bun Ti is a Deligne-Mumford stack of dimension g − 1.
µ

(2) For 0 ≤ i ≤ r, the projection map pi : Hk T1 −→ Bun T1 is smooth of relative dimension r.
µ

µ

(3) For 0 ≤ i ≤ r, the morphism ( pi , π Hk ) : Hk T1 −→ Bun T1 ×k Y1r is an isomorphism.
e ∞ be a divisor in Y ×k S
e ∞ of the following form:
Let D
e∞ =
D

∑

(i )

x ∈Σ∞ ,1≤i ≤2d x

(i )

(i )

c x (y x , z x )

(2.17)

Project to Y1 ×k S0∞,1 , one gets:
D1,∞ =

∑

(i ) (i )

x ∈Σ∞ ,1≤i ≤2d x

c x yx

Then one has the Atkin-Lehner involution:
f (D
f ( D1,∞ ) : PicY ×k S
e ∞ ) := AL
e ∞ −→ PicY
AL
1
1
e ∞ ) := AL( D1,∞ ) := Bun T ×k S
e ∞ −→ Bun T
AL( D
1
1

L 7−→ L(

∑∞ cx

x ∈Σ

(i ) (i )
yx )

e ∞ satisfy the equation:
Let µ ∈ {±1}r and D
r

∑ µi =

i =1

∑

x ∈Σ∞ ,1≤i ≤2d x

(i )

cx

(2.18)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

11

Of course, this is due to the same degree reason as in the previous subsection. Define
µ
Sht T ( D1,∞ )0 to be following fiber product:
i

/ Hkµ (Σ) ×k S
e∞
T

µ

Sht T ( D1,∞ )0
i

(2.19)

i

e 1,∞ )◦( per ×idS )
( pe0 ,AL(− D
∞

ω0


Bun Ti


/ Bun T × Bun T
i
i

(id,Fr )

µ

Given Sht T ( D1,∞ ), the moduli of shtukas defined using S0∞,1 , the above one is nothing but
i

µ

Sht T ( D1,∞ ) ×S0
i

(2.20)

e∞
S

1,∞

e ∞:
As in Yun-Zhang, one only works with the following divisor in Y ×k S
e∞ =
µ∞ · Σ

∑∞ µx (yx

(1)

x ∈Σ

(1)

, zx )

(2.21)

Then projects to Y1 ×k S0∞ , we get
0
µ∞ · Σ1∞
=

∑∞ µx yx

(1)

(2.22)

x ∈Σ

Fix r = #Σ∞ mod 2, then for this special choice of divisor, we have the following:
µ

µ

i

i

0
0
Sht T (µ∞ · Σ1,∞
)0 = Sht T (µ∞ · Σ1,∞
) × S0

1,∞

(2.23)

e∞
S

According to Yun-Zhang, one has:
µ

µ

i

i

0
) = Sht T ( D1,∞ )
Sht T (µ∞ · Σ1,∞

(2.24)

0 mod ν∗ D . Also, Yun-Zhang showed ([7], Corollary 4.3):
for any choice of D1,∞ = µ∞ · Σ1∞
1 ∞
µ

0 ) is a smooth Deligne-Mumford stack of dimension r
Proposition 2.11. Sht T (µ∞ · Σ1,∞
i

µ

0 )0 is also a smooth DeligneTherefore the stack we are going to consider here Sht T (µ∞ · Σ1,∞
i
Mumford stack of dimension r.
To define Heegner-Drinfeld cycles, one first need to know how to assign an Iwahori level
structure to the push foward of a line bundle. To do this, we now fix a tuple of 1 and −1s:

µΣ = (µ f , µ∞ ) ∈ {±1}Σ f × {±1}Σ∞

(2.25)

define the following morphism:
Definition 2.12. Define:

µΣ
e ∞ −→ Bun2 (Σ)
: PicY1 × S
θe1,Bun

(2.26)

e ∞ , the image of L, a line bunde over
in the following way: For a k-scheme S with a map S −→ S
Y1 × S, is ν1,∗ L, whose Iwahori level structure, i.e. the ”lattice filtration” at Σ is given by:
(1) At x ∈ Σ f :
• If µ x = 1, define ν1,∗ L(− 12 ) to be ν1,∗ (L(−y x ))
• If µ x = −1, define ν1,∗ L(− 21 ) to be ν1,∗ (L(−y0x ))
(2) At x ∈ Σ∞
(1)
(2)
• If µ x = 1, define ν1,∗ L(− 12 ) to be ν1,∗ (L(−y x − y x − ... − y(dx ) ))
( d x +1)

• If µ x = −1, define ν1,∗ L(− 21 ) to be ν1,∗ (L(−y x

( d x +2)

− yx

− ... − y(2dx ) ))

This definition is the same as Yun-Zhang’s definition applied to the S0∞,1 structure for S
e ∞ with the canonical projection mentioned above.
induced by its S
For Y2 we define the map
µΣ
e ∞ −→ Bun2 (Σ)
θe2,Bun
: PicY2 × S

in completely the same way.

(2.27)

12

HAO LI

By quotienting out Pic X , one gets:
Σ
e ∞ −→ BunG (Σ)
θ1,Bun
: Bun T1 × S

(2.28)

µΣ
e ∞ −→ BunG (Σ)
θ2,Bun
: Bun T2 × S

(2.29)

µ

and
We can define the morphism on the Hecke stacks:
µ

µ

e ∞ −→ Hk (Σ)
Hk T1 ×k S
G

(2.30)

Σ
By applying θ Bun,1
to each single Li in the sequence of line bundles.
As in their paper, define the following #-Atkin-Lehner for T1 :

µ

e ∞ ), Fr e ) : Bun T × S
e ∞ −→ Bun T × S
e∞
AL#T1 ,µ∞ := ( AL(−µ∞ · Σ
1
1
S∞

(2.31)

Then one has the following commutative diagram:
Bun T1

e∞
×S

AL#T

1 ,µ∞

/ Bun T × S
e∞
1

µΣ
(θ1,Bun
,ν∞ )

(2.32)

µΣ
θ1,Bun


BunG (Σ) ×k S∞


/ BunG (Σ)

AL G,∞

µ

By unraveling the meaning of the functor of points of Sht T1 (µ∞ · Σ1,∞ )0 , one finds that it also
fits in the following fiber diagram:
/ Hkµ (Σ) ×k S
e∞
T1

µ

Sht T1 (µ∞ · Σ1,∞ )0

(2.33)

( p0 ×idSe ∞ ,AL#T

1 ,µ∞


Bun T1

(id,Fr )

/ ( Bun T
1


e ∞ ) × ( Bun T × S
e ∞)
×S
1

◦( pr ×idSe ∞ )

Then by (2.32), (2.33), together with the morphism of the Hecke stacks (2.30), one gets the
Heegner-Drinfeld map for Y1 :
µ

µ

θ1 : Sht T1 (µ∞ · Σ1,∞ )0 −→ ShtG (Σ; Σ∞ )
µ

(2.34)

e ∞ -structure, one actually gets:
By remembering the S
0µ
e∞
θ1 : Sht T1 (µ∞ · Σ1,∞ )0 −→ ShtG (Σ; Σ∞ ) ×S∞ S
µ

µ

(2.35)

Repeat all the above for Y2 , one gets the Heegner-Drinfeld map for Y2 :
0µ
e∞
θ2 : Sht T2 (µ∞ · Σ2,∞ )0 −→ ShtG (Σ; Σ∞ ) ×S∞ S
µ

µ

(2.36)

µ

Denote the common right hand side by ShtG (Σ; Σ∞ )0 . Note that unlike Yun-Zhang, there is
no base with respect to Yir −→ X r .
By pushing foward the fundamental cycles of the left hand side of the equation, one gets
classes in the middle dimension Chow groups of the right hand side:
Definition 2.13. Define the Heegner-Drinfeld cycle for Y1 and Y2 as follows:
0µ

µ

µ

(2.37)

µ
Chc,r (ShtG (Σ; Σ∞ )0 )

(2.38)

Z1 := θ1 [Sht T1 (µ∞ · Σ1,∞ )0 ] ∈ Chc,r (ShtG (Σ; Σ∞ )0 )
µ

µ
Z2

:=

µ
0µ
θ2 [Sht T2 (µ∞

0

· Σ2,∞ ) ] ∈

Finishing all the setups, it is the time for us to state the question:
“Compute” the following number:
µ

µ

hZ1 , f ∗ Z2 i

(2.39)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

13

for an f ∈ HGΣ . One can first take f to be a basis element indexed by an effective divisor D
µ
µ
of X − Σ, namely h D . hZ1 , h D ∗ Z2 i can be computed by the following fiber diagram:
/ Shtµ (Σ; Σ∞ ; h D )0
G

∗

µ
Sht T1 (µ∞

· Σ1,∞

)0

(2.40)



0µ
0µ
θ1 × θ2
µ
µ
µ
0
∞
0
/
× Sht T2 (µ∞ · Σ2,∞ )
ShtG (Σ; Σ ) × ShtG (Σ; Σ∞ )0

µ

In which ShtG (Σ; Σ∞ ; h D )0 is defined as:
µ

µ

e∞
ShtG (Σ; Σ∞ ; h D )0 := ShtG (Σ; Σ∞ ; h D ) ×S∞ S

(2.41)

µ
µ
0µ
0µ
∗ Z2 i = deg(θ1 × θ2 )! [ShtG (Σ; Σ∞ ; h D )0 ].
µ
µ
2d x )−1 hZ1 , f ∗ Z2 i. The clumsy factor before

µ
hZ1 , h D

and we will later give ∗ a name. Then
For simplicity, for f , let Iµ ( f ) = (∏ x∈Σ∞
the
e ∞,
intersection pairing is for the nomalization purpose. To remove it, one can fix a k-point of S
e ∞ to k:
say ξ, and consider the base change from S
µ

ShtG (Σ; ξ ) := ShtG (Σ; Σ∞ ) ×S∞ ξ
µ

µ

µ

Sht T (µ∞ · ξ ) := Sht T (µ∞ · Σi,∞ )0 ×S
e∞ ξ
i

Then one has:
0µ

µ
Sht T (µ∞
i

θi,ξ

µ

µ

µ

· ξ ) −→ ShtG (Σ; Σ∞ )0 ×Se ∞ ξ = ShtG (Σ; Σ∞ ) ×S∞ ξ = ShtG (Σ; ξ )
0µ

µ

Define Zi (ξ ) := θi,ξ [Sht T (µ∞ · ξ )] ∈ Chc,r (ShtG (Σ; ξ ))Q for i = 1, 2. Actually the pull back
µ

µ

i

µ

of Zi to ShtG (Σ; Σ∞ )0 ×S
e ∞ k splits into is just the disjoint union of Zi ( ξ ) as ξ runs through all
e ∞ . Following the method of Yun-Zhang ([7], Corollary 4.11), one
the ∏ x∈Σ∞ 2d x k-points of S
can prove the following:
µ

µ

e (k), one has:
Lemma 2.14. For any two ξ, ξ 0 ∈ S

hZ1 (ξ ), f ∗ Z2 (ξ )iShtµ (Σ;ξ ) = hZ1 (ξ 0 ), f ∗ Z2 (ξ 0 )iShtµ (Σ;ξ 0 )

(2.42)

Iµ ( f ) = hZ1 (ξ ), f ∗ Z2 (ξ )iShtµ (Σ;ξ )

(2.43)

µ

µ

µ

µ

G

G

In particular:
µ

µ

G

By the general theory of Yun-Zhang, one expects that this number can be computed by applying the Grothendieck-Lefschetz trace formula to some cohomological self-correspondence
of certain “Hitchin type” fiberation derived from the moduli of shtukas and the constant sheaf
for D of large enough degree. This is the topic of the next section.
3. T HE H ITCHIN TYPE FIBERATION FOR THE H EEGNER -D RINFELD CYCLES
3.1. The moduli space Md Σ . Unraveling the definition of diagram used to compute hZ1 , h D ∗
µ
Z2 i, i.e.(??) and the general philosophy of Yun-Zhang’s work, we are led to the following definition. Fixing µ∞ = (µ f , µ∞ ) as in the last section.
µ

µ

f Σ as the stack whose funtor of point on a k-scheme S is the following:
Definition 3.1. Define M
d
e
• A map S −→ S∞
• A line bundle L on Y1 ×k S and a line bundle F on Y2 ×k S.
µΣ
µΣ
• A morphim of coherent sheaves on X ×k S, φ from θe1,Bun
(L) to θe2,Bun
(F ), more precisely:
φ : ν1,∗ L −→ ν2,∗ F
(3.1)
sending each “sublattice” of ν1,∗ L defined in (2.12) to the corresponding one of ν2,∗ F .
And φ has the following property: the induced map on the determinant line bundle
µ

detφ : det(ν1,∗ L) −→ det(ν2,∗ F )

(3.2)

14

Let

HAO LI

has zeroes of total degree d and away from Σ.
fµΣ /Pic X .
:= M

µ
Md Σ

d

Now let N = degΣ, and Ŷ2d− N be the moduli space of the effective divisor of degree 2d − N
on Y, which is simply the 2d − N-fold symmetric product scheme of Y. I want to define a map
µ
e ∞ , depending on our choice of (µ f , µ∞ ) as
from Md Σ to Ŷ2d− N . First define a divisor on Y ×k S
follows:
e:=
D
(3.3)
∑ (y0x , zx ) + ∑ (yx , z0x )
x ∈Σ f ,µ x =1

+

∑

x ∈Σ f ,µ x =−1

dx

∑ (y x x

x ∈Σ∞ ,µ x =1 i =1

( d +i )

(i )

, zx ) +

∑

dx

∑ (y x

x ∈Σ∞ ,µ x =−1 i =1

(i )

( d x +i )

, zx

)

(3.4)

And also let D30 = ∑ x∈Σ w0x , it is a divisor of Y3 . For the definition of wx and w0x , look at
section (2.1) and section (2.7).
Now as Howard-Shnidman did, pull back φ : ν1,∗ L −→ ν2,∗ F all the way up to Y, this map
splits into the following:
φ
→ Fe ⊕ τ3∗ Fe
Le ⊕ τ3∗ Le −

(3.5)

e can be described more precisely:
in which φ
φ11
Le −→ Fe
τ1 (φ11 )
∼
∼
Le −
→ τ1∗ Le −−−−→ τ1∗ Fe −
→ τ3∗ Fe
τ2 (φ11 )
∼
∼
τ3∗ Le −
→ τ2∗ Le −−−−→ τ2∗ Fe −
→ Fe
τ3 (φ11 )
τ3∗ Le −−−−→ τ3∗ Fe

Now φ11 can be viewed as a section of Le−1 ⊗ Fe .
Let ∆ := det(ν1,∗ L)−1 ⊗ det(ν2,∗ F ). It is a degree d line bundle on X ×k S since it admits a
section det(φ) of degree d by definition. Then by observing that:
ν3∗ ∆ = Nm(Le−1 ⊗ Fe )

(3.6)

one can see that the degree of Le−1 ⊗ Fe is 2d:
∼
∼
ν∗ ∆ −
→ π3∗ ν3∗ ∆ = π3∗ Nm(Le−1 ⊗ Fe ) −
→ Le−1 ⊗ Fe ⊗ τ3∗ Le−1 ⊗ τ3∗ Fe

(3.7)

Of course ν∗ ∆ has degree 4d, so Le−1 ⊗ Fe has degree 2d since deg(Le−1 ⊗ Fe = deg(τ3∗ Le−1 ⊗ τ3∗ Fe .
We also have to take care of the Iwahori level structure. we will see that this results in certain
prescribed zeros of φ11 :
(1) At x ∈ Σ f .
• µ x = 1. In this case, the Iwahori level structures are defined by ν1,∗ (L(−y x )) and
ν2,∗ (F (−z x )) respectively. Pull them back to the very top curve Y, one finds that:
e
e
ν∗ ν1,∗ (L(−y x )) = L(−(
y x , z x ) − (y x , z0x )) ⊕ τ3∗ L(−(
y0x , z x ) − (y0x , z0x ))
ν∗ ν2,∗ (F (−z x )) = Fe (−(y x , z x ) − (y0x , z x )) ⊕ τ3∗ Fe (−(y0x , z0x ) − (y0x , z0x ))
e
Since φ preserves Iwahori level structure, φ11 should send L(−(
y x , z x ) − (y x , z0x ))
0
to Fe (−(y x , z x ) − (y x , z x )), and by Galois equivariancy this is enough. Therefore
one has:
φ11 |(y0x ,zx ) = 0 and φ11 |(yx ,zx ) , 0, φ11 |(y0x ,z0x ) , 0

(3.8)

The nonvanishing part comes from the nonvanishing of det(φ) at Σ
• µ x = −1. In this case, the Iwahori level structures are defined by ν1,∗ (L(−y0x )) and
ν2,∗ (F (−z0x )) respectively. The same analysis as above yields:
φ11 |(yx ,z0x ) = 0 and φ11 |(yx ,zx ) , 0, φ11 |(y0x ,z0x ) , 0

(3.9)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

15

(2) At x ∈ Σ∞ .
• µ x = 1. In this case, the Iwahori level structures are defined by:
(1)

ν1,∗ (L(−y x − ... − y(dx ) ))
(1)

ν2,∗ (F (−z x − ... − z(dx ) ))
pull back them to the very top curve Y, one gets:
(1) (1)
(d ) (d )
( d +1)
(2d )
e
L(−(
y x , z x )... − (y x x , z x x ) − (y(1) , z x x )... − (y(dx ) , z x x ))
( d x +1)

e
yx
⊕τ3∗ L(−(

(1)

(2d x )

, z x )... − (y x

(d x )

, zx

( d x +1)

)... − (y x

( d x +1)

, zx

(2d x )

)... − (y x

(2d x )

, zx

))

(1) (1)
(d ) (d )
(1)
(d )
Fe (−(y x , z x )... − (y x x , z x x ) − (y(dx +1) , z x )... − (y(2dx ) , z x x ))
(1) ( d +1)
(d ) (2d )
( d +1) ( d +1)
(2d ) (2d )
⊕τ3∗ Fe (−(y x , z x x )... − (y x x , z x x )... − (y x x , z x x )... − (y x x , z x x ))

Preserving Iwahori level structures translates to:
φ11 |

(1)

(d x )

(y(d x +1) ,z x )...+(y(2d x ) ,z x

)

=0

(3.10)

• µ x = −1. In this case, the Iwahori level structure are defined by:
( d x +1)

− ... − y(2dx ) ))

( d x +1)

− ... − z(2dx ) ))

ν1,∗ (L(−y x

ν2,∗ (F (−z x

The same analysis as above yields the following:
φ11 |

( d x +1)

(y(1) ,z x

(2d x )

)...+(y(d x ) ,z x

)

=0

(3.11)

e is defined. Due to the vanishing conditions, one can
Now you must see how the divisor D
e ), which as degree 2d − N.
view φ11 as a section of the line bundle (Le−1 ⊗ Fe )(− D
Definition 3.2. Define the map:

Md Σ −→ Ŷ2d− N

(3.12)

e ), φ11 )
(L, F , φ) 7−→ ((Le−1 ⊗ Fe )(− D

(3.13)

µ

as

Remark 3.3. Roughly speaking, this map is something to remember the divisor of φ11 . Since φ11
must vanish at some prescribed points arising from the Iwahori level structure, one only has to
e
remember the varying parts. This is the meaning of twisting it by D.
3.2. The moduli space Ad . The “Hitchin type” fiberation needs a base space. I’m going to
describe it here.
Definition 3.4. Define Ad to be the stack over k whose functor of point on a k-scheme S consisting of:
• A degree d line bundle ∆ over X ×k S
• A global section a ∈ H 0 (Y3 ×k S, ν3∗ ∆) who vanishes at the support of D30 , and Tr ( a) is a
nonzero section of ∆ who doesn’t vanish at Σ.
This is almost the same as the definition of Howard-Shnidman, the new things are the vanishing and nonvanishing conditions, as you know, coming from the Iwahori level structure.
Unlike the case considered by Yun-Zhang, this Ad is somehow simpler, since it is a scheme
on the nose ([4], section 3.4).
Proposition 3.5. Consider the trace map:
Tr : Ad −→ X̂d

(∆, a) 7−→ (∆, σ3 invariant of a + σ3 ( a))
This map is quasi-projective, and Ad is a quasi-projective scheme.
As in the case of Md Σ , one can define the divisor memorizing map for Ad .
µ

16

HAO LI

Definition 3.6. Define the map:

Ad −→ Ŷ3,2d− N

(3.14)

as

(∆, a) 7−→ (ν3∗ ∆(− D30 ), a0 )
In which a0 means viewing a as a section of ν3∗ ∆(− D30 ) rather than ν3∗ ∆

(3.15)

Let D ∈ Div+ ( X − Σ) be an effective divisor on X − Σ. We can define A D as the following
fiber product:
Definition 3.7.

/ Ad

AD

Speck

Tr


/ X̂d

(O X ( D ),1)

From the definitions of Md Σ and Ad , it is obvious that there exists a map from Md Σ to Ad .
µ

µ

Definition 3.8. The “Hitchin type” fiberation for the shtuka side is the following morphism:
f d : Md Σ −→ Ad

(3.16)

(L, F , φ) 7−→ (∆ := det(ν1,∗ L)−1 ⊗ det(ν2,∗ F ), Nm(φ11 ))

(3.17)

µ

Preserving the Iwahori level structure makes sure the image lies in the right hand side. Also
this map fits into the following diagram:

Md Σ

/ Ŷ2d− N


Ad



µ

(3.18)

Nm

/ Ŷ3,2d− N

This diagram is almost a Cartesian diagram. As we will see.
3.3. The diagram above is almost Cartesion. First for convenience, denote by Md the Cartesian product, i.e.
/ Ŷ2d− N
Md
(3.19)

Ad



Nm

/ Ŷ3,2d− N

Since Ad is a scheme, Md is a scheme. From Howard-Shnidman, one can know the following
([4], Lemma 4.4):
Proposition 3.9. When 2d ≥ 2(2g3 − 1) − 1 + N, Md and Ad are of dimension 2d − N − g + 1.
First Let U2d− N = { E ∈ Ŷ2d− N : TrY3 /X ( NmY/Y3 ( E)) ∩ Σ = ∅}, this is an open subscheme of
Ŷ2d− N . The space Md actually also fits into the following Cartesian diagram:

Md

/ U2d− N


PicdX


/ Pic2d− N
Y3

The bottom horizontal arrow is simply pull back then twisted by the divisor D30 .
The right vertical arrow is the restriction to U2d− N of the map:
AJ

NmY/Y3

2d− N
Ŷ2d− N −→ PicY
−−−−→ PicY2d3 − N

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

17

in which AJ is the Abel-Jacobi map, which is smooth when 2d − N ≥ 2(2g3 − 1) − 1. And the
smoothness of NmY/Y3 is shown by Howard-Shnidman. Therefore the right vertical map in the
Cartesian diagram is smooth. From this, one can concludes that:
2d− N
dimMd = dimU2d− N − dimPicY
+ dimPicdX
3

= 2d − N − ( g3 − 1) + ( g − 1)
= 2d − N − (2g − 2) + g − 1 = 2d − N − g + 1
We used g3 = 2g − 2 since Y3 is nonramified over X. Then from the defining diagram for Md
(3.19), one knows Ad is of the same dimension. 
e ∞ . Actually this is the
By the definition of MµΣ one can see that it is actually a space over S
µΣ
only difference between Md and Md :
Proposition 3.10. We have an isomorphism:
∼

e∞
Md Σ −
→ Md ×k S
µ

(3.20)

Therefore Md Σ is also a scheme, not just a Deligne-Mumford stack.
µ

From the left to the right is simply the maps from Md Σ to Ŷ2d− N , to Ad defined in the last
e ∞ . We only have to construct its
subsection, together with remembering the map: S −→ S
inverse.
What does an S point of Md consists of? It is the following
µ

• a degree 2d − N effective divisor (K 0 , ψ0 ) on Y ×k S;
• a degree d line bundle on X ×k S, say ∆, and a section a of ν3∗ ∆, vanishing at D30 , and
Tr ( a) doesn’t vanish at Σ.
such that:
Nm((K 0 , ψ0 )) = (ν3∗ ∆(− D30 ), a0 )
(3.21)
In which, again, a0 is just a viewed as a section ν3∗ ∆(− D30 ).
e ), ψ) in which ψ is ψ0 viewed as a
e ∞ structure allows us to consider the twists (K 0 ( D
The S
0
e
section of the more positive line bundle K ( D ). Denote this more positive one by just K. Then
from the above equation we find the following equation:

K ⊗ τ3∗ K = ν∗ ∆

(3.22)

This provides K ⊗ τ3∗ K with the τ1 and τ2 equivariant structure, since it is pulled back from the
very bottom:
∼

∼

K ⊗ τ3∗ K −
→ τ1∗ (K ⊗ τ3∗ K) −
→ τ1∗ K ⊗ τ2∗ K

(3.23)

This in turn yields:
∼

∼

τ1∗ K −1 ⊗ K −
→ τ3∗ K −1 ⊗ τ2∗ K −
→ τ2∗ (τ1∗ K −1 ⊗ K)

(3.24)

Therefore τ1∗ K −1 ⊗ K descent to Y2 ×k S. Denote the descent by M.
Since one has the canonical τi , i = 1, 2, 3-equivariant isomorphism:
∼

π2∗ (M ⊗ σ2∗ M) −
→ τ1∗ K −1 ⊗ K ⊗ τ3∗ (τ1∗ K −1 ⊗ K)
∼

∼

→ OY × k S
−
→ τ1∗ K −1 ⊗ K ⊗ τ2∗ K −1 ⊗ τ3∗ K −
The last equation comes from the left equation above, moving everything to the left hand side.
This equivariant trivialization shows that NmY2 ×k S/X ×k S (M) is trivial. Therefore from the exact
sequence:
id−σ

Nm

2
0
1−
→ PicY2 /Pic X −−−→
PicY
−−→ Pic0X −
→1
2

(3.25)

one knows that there exists a unique line bundle F over Y2 ×k S up to twisted by line bundles
pulling back from X ×k S, such that
∼

F ⊗ σ ∗ F −1 −
→M

(3.26)

18

HAO LI

Now π2∗ (K −1 ⊗ F ) has a τ1 equivariant structure:
∼

τ1∗ (K −1 ⊗ π2∗ F ) −
→ τ1∗ K −1 ⊗ π2∗ σ2∗ F
∼

−
→ τ1∗ K −1 ⊗ M−1 ⊗ π2∗ F
∼

−
→ τ1∗ K −1 ⊗ τ1∗ K ⊗ K −1 ⊗ π2∗ F
∼

−
→ K −1 ⊗ π2∗ F
∼

This produces the desired line bundle L on Y1 ⊗k S such that π1∗ L −
→ K −1 ⊗ π2∗ F .
As in the previous subsections, let Le = π1∗ L and Fe = π2∗ F , one gets
∼
Le−1 ⊗ Fe −
→K

(3.27)

Le−1

Via this isomorphism, one can view ψ as a global section of
⊗ Fe . Note that (K, ψ) comes
0
0
−
1
e
e
e ). In other words, one
from (K ( D ), ψ), one can also view ψ as a global section of L ⊗ Fe (− D
can view a as:
e
ψ : Le −→ K
(3.28)
e
vanishing at the divisor D.
By applying τi s to it, one can produce:
ψ
Le −
→ Fe
τ1 (ψ)
∼
∼
Le −
→ τ1∗ Le −−−→ τ1∗ Fe −
→ τ3∗ Fe
τ2 (ψ)
∼
∼
τ3∗ Le −
→ τ2∗ Le −−−→ τ2∗ Fe −
→ Fe
τ3 (ψ)
τ3∗ Le −−−→ τ3∗ Fe

This matrix descent to a morphism:
φ : ν1,∗ L −→ ν2,∗ F

(3.29)

e makes sure that φ preserves
It is easy to check that det(φ) = Tr ( a). The fact that ψ vanishes at D
the Iwahori level structure, and the nonvanishing of Tr ( a) at Σ makes sure the nonvanishing of
det(φ) at Σ. This finishes the construction of the inverse map. One can check that this is really
the inverse. 
3.4. The Hecke correspondence for Md Σ and Md . You may have noticed that in the definition
µ
of Md Σ , the φ comes from the vertical Hecke symmetries of the moduli of shtukas. Now we
take care of the horizontal Hecke modifications. As before, fix our choice of (µ, µ f , µ∞ ). Define
the following stack:
µ

f µ be the stack over k whose functor of points on a k-scheme S consists
Definition 3.11. Let Hk
Md
of the following:
e∞
• S −→ S
• r S-points of Y1 : y1 , y2 , ..., yr : S −→ Y1 and S-points of Y2 : z1 , z2 , ..., zr : S −→ Y2
such that ν1 ◦ yi = ν2 ◦ zi as S points of X, for i = 1, ...r. These two points is equivalent
to r S-points of Y = Y1 × X Y2 .
µ
• r + 1 S-objects of Md Σ : (L0 , F0 , φ0 ), ..., (Lr , Fr , φr ).
• Morphisms of coherent sheaves: f i : Li−1 d Li and f i0 : Fi−1 d Fi such that their push
foward to X ×k S fit into the following commutative diagram:
ν1,∗ L0


ν1,∗ f 1

φ0

ν2,∗ F0

ν2,∗ f 10

/ ν1,∗ L1


ν1,∗ f 2

/ ......

ν1,∗ f r

/ ......

ν2,∗ f r0

φ1

/ ν2,∗ F1

ν2,∗ f 20

/ ν1,∗ Lr


φr

/ ν2,∗ Fr

(3.30)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

19

µ
f µ /Pic X .
As usual, let Hk M be Hk
M
d

d

µ
e ∞ , though we don’t
It is a self-correspondence of Md Σ over Ad (actually even over Ad ×k S
use it)
µ

←
−
p

Md Σ
µ

Hk M

(3.31)

d

−
→
p

z
$

Md Σ
µ

$
z
e∞
Ad ×k S
The case µ = +1 is the building block of the mutiple modification points ones, i.e., one has
the following isomorphism as a self-correspondence of Md over Ad :
µ

1
1
→
−
→
−
→
−
Hk M = Hk1Md ×−
p ,M d ,←
p Hk Md
p ,M d ,←
p ...... ×−
p ,M d ,←
p Hk Md ×−
d

(3.32)

The purpose now is to transfer the Hecke correspondence for Md Σ to a Hecke correspondence for Md . But let’s first see what that looks like. Recall a definition made by HowardShnidman ([4] section 4.3).
µ

Definition 3.12. Let H2d− N be the k-stack whose typical S-objects are the following:

• Two S-points of Ŷ2d− N : (K00 , ψ00 ), (K10 , ψ10 ).
• An S-point of Y, i.e. v : S −→ Y.
∼
• An isomorphism of sheaves: s : K00 (τ2 (v) − τ1 (v)) −
→ K10 , such that s(ψ00 ) = ψ10 , in
0
0
which vewing a0 as a rational section of K0 (τ2 (v) − τ1 (v)).
The last condition guarantees that Nm(K00 , ψ00 ) = Nm(K10 , ψ10 ), therefore one gets the following diagram:
H2d− N
γ0

(3.33)
γ1

z

$

Ŷ2d− N

Ŷ2d− N
$
z
Ŷ3,2d− N

Recall that Md is defined to be the fiber product: Md := Ŷ2d− N ×Ŷ

3,2d− N

Ad . Pull back the

above self-correspondence of Ŷ2d− N to a self-correspondence of Md over Ad , denoted by Hd :

Hd

(3.34)

γ0

Md

γ1

}

!

!

Ad

Md

}

We know the dimension of Hd :
Proposition 3.13. γ0 and γ1 are finite and surjective. Hd is a scheme of dimension 2d − N − g + 1.
You may wonder how this Hd is so defined, the next proposition just tells you this:
e ∞ is isomorphic to Hk1 as a self-correspondence over A ×k S
e ∞ if one
Proposition 3.14. Hd ×k S
Md
µ
Σ
e ∞ with M via the proposition in the last subsection.
identifies Md ×k S
d

20

HAO LI

e ∞ actually is the definition of Hd . Starts with the point of
Going from Hk1M to Hd ×k S
Hk1M , say:

d

d

e ∞ , (L0 , F0 , φ0 ), (L1 , F1 , φ1 ), f , f 0 , (y, z)
S −→ S
one gets two S-point of Md :
e ), ψ10 )
e ), ψ00 ), (Le−1 ⊗ Fe1 (− D
(Le0−1 ⊗ Fe0 (− D
1
Pulling back f and f 0 to Y, one finds:
∼
fe : Le0 ((y, z) + (y, z0 )) −
→ Le1
∼
fe0 : Fe0 ((y, z) + (y0 , z)) −
→ Fe1

from this one can get:
−1
∼
→ Le1−1 ⊗ Fe1
fe ⊗ fe0 : Le0−1 ⊗ Fe0 ((y0 , z) − (y, z0 )) −

Therefore the following tuple:
e ), ψ00 ), (Le−1 ⊗ Fe1 (− D
e ), ψ10 ), ( fe ⊗ fe0 −1 )(− D
e)
(Le0−1 ⊗ Fe0 (− D
1
lies in Hd .
µ
e ∞ , the important part is
Like in the proof of the equivalence between Md Σ and Md ×k S
going backwards. From that equivalence, starting from a point Ŷ2d− N : (K00 , ψ00 ), (K10 , ψ10 ) on
µΣ
e ∞ , one can produce a point on MµΣ ×
(Md ×Ad Md ) ×k S
e ∞ Md :
A × S
d
d

k

(L0 , F0 , φ0 ), (L1 , F1 , φ1 )
Now the only thing need to do is to prove that giving an S point v = (y, z) of Y and s identifying
(K00 (τ2 (v) − τ1 (v)), ψ00 ) with (K10 , ψ10 ), one can reconstruct the following:
∼

∼

f : L0 ( y ) −
→ L1 and f 0 : F0 (z) −
→ F1
To do this, as mentioned by Howard-Shnidman, one has to go back to the prove of the equivalence.
e ). Apply τ ∗ to
e ∞ allows one to define: Ki = K 0 ( D
As in the prove of the equivalence, S −→ S
1
i
the following the equation and taking the inverse:
∼

s : K0 ((y0 , z) − (y, z0 )) −
→ K1
one gets:

∼

τ1 (s) : τ1∗ K0−1 ((y, z) − (y0 , z0 )) −
→ τ1∗ K1−1
Tensor them up:
∼

→ τ1∗ K1−1 ⊗ K1
τ1∗ K0−1 ⊗ K0 ((y0 , z) − (y, z0 ) + (y, z) − (y0 , z0 )) −
Descent to Y2 , one finds:

∼

M0 ( z − z 0 ) −
→ M1
∼

By construction, F1 is the unique line bundle up twists by Pic X such that F1 ⊗ σ2∗ F1 −
→ M1 ,
∼
but the above equation shows that F0 (z) is another such. This way one gets f 0 : F0 (z) −
→ F1 .
Now recall how we reconstructed L. Li is defined to be a line bundle on Y1 ⊗k S pullback to
be Ki−1 ⊗ Fei . Using the isomorphism s and f 0 :
∼
Le1 −
→ K0 ((y, z) − (y0 , z)) ⊗ Fe0 ((y, z0 ) + (y0 , z))
∼
−
→ K0 ⊗ Fe0 ((y, z0 ) + (y, z))
∼

−
→ π1∗ (L0 (y))
One can check that this isomorphism is actually τ1 -equivariant, therefore descent to an isomor∼
phism: f : L0 (y) −
→ Le1 (I have taken the reverse direction).
µ
The Iwahori level structure part is already built up in the proof of the equivalence of Md Σ
e ∞. 
and Md ×k S

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

21

µ

Similarly one can form the multiple Hecke correspondence for Md : Hd . The same proof as
µ
above can show that there is an isomorphism of self-correspondences of Md Σ over Ad , when
µΣ
e ∞:
Md is identified with Md ×k S
∼

µ

µ

e∞
Hk M −
→ Hd ×k S

(3.35)

d

µ

and Hd is actually the building block of Hd :
µ ∼

Hd −
→ Hd ×γ1 ,Md ,γ0 Hd ×γ1 ,Md ,γ0 ... ×γ1 ,Md ,γ0 Hd

(3.36)

4. G OING TOWARDS THE INTERSECTION NUMBER
4.1. The master diagram. The master diagram plays a key role in Yun-Zhang’s theory. We first
review an auxilary moduli space appearing in this diagram, namely Hd .
e d (Σ) to be the k-stack whose S-points consist of the following:
Definition 4.1. Define H

• two S-points of BunG (Σ), say E † = (E , {E (− 21 x )}) and E 0 † = (E 0 , {E 0 (− 12 x )}), overX ×k
S;
• a morphism of coherent sheaves φ : E −→ E 0 preserving the Iwahori level structure, i.e.
sending {E (− 21 x )} to {E 0 (− 21 x )}. Also, as before, det(φ) has degree d and its vanishing
locus is away from Σ.
e d (Σ)/Pic X , and let:
As you know, define Hd (Σ) := H

←
→
−
→
p H = (←
p H, −
p H ) : Hd (Σ) −→ BunG (Σ)2 .
be the two projections. Yun and Zhang pointed out the following ([4], Definition 5.7):

−
→
Proposition 4.2. The two projections, ←
p H, −
p H are representable and smooth of relative dimension 2d.
Therefore, Hd (Σ) is a smooth Artin stack of pure dimension 2d + 3( g − 1) + N.
From this definition you can see that the above Md Σ is simply the following fiber product:
µ

Md Σ
µ

Bun T1


e∞
×k Bun T2 ×k S

/ Hd (Σ)


(4.1)

−
→
(←
p ,−
p)

/ BunG (Σ)

Since the definition of shtukas involves Atkin-Lehner involution, here we also introduce the
µ
Atkin-Lehner involution for Hd (Σ) and Md Σ . Recall we have the Atkin-Lehner involution for
BunG (Σ), namely ALG,∞ . For Hd (Σ), its Atkin-Lehner involution AL H∞ :
Hd (Σ) ×k S∞ −→ Hd (Σ)
† φ

(4.2)
φ

(E −
→ E 0† , S −→ S∞ ) 7−→ ( ALG,∞ (E † ) −
→ ALG,∞ (E † ))

(4.3)

Recall the relation (2.32), define the Atkin-Lehner involution ALM,∞ in the following way:

Md Σ −→ Md Σ
µ

µ

(4.4)
Fr

S
e ∞ ) 7−→ ( AL T ,µ∞ (L), AL T ,µ∞ (F ), φ, S −−→
e ∞)
(L, F , φ, S −→ S
S −→ S
2
1

(4.5)

Of course as you can see, Hd (Σ) is modeled on the vertical Hecke symmetries of moduli
shtukas. Considering the horizontal Hecke modifications lead one to the following definition:
f µ (Σ) to be the stack whose S-points consist of:
Definition 4.3. Let’s define Hk
H
d

• r-S points of X, say x1 , ..., xr

22

HAO LI

• a commutative diagram:
f1

E0
φ0


E00

f2

/ E1

/ ......

fr

/ ......

f r0

/ Er

φ1


/ E0
1

f 10

(4.6)

φr

f 20


/ Er0

e d (Σ)(S). f i and f 0 are isomorphisms away from Γ x
in which each column is a point of H
i
i
for i = 1, ..., r, and have relative position µi .
µ
f µ (Σ)/Pic X . One has:
Let Hk H (Σ) := Hk
H
d

d

Proposition 4.4.

µ
Hk H (Σ)
d

is an Artin stack of dimension 2d + 2r + 3( g − 1) + N

Now we are ready for Yun-Zhang’s master diagram, adapted to our current case:
µ

θ1,Hk ×θ2,Hk × IdS
e

µ

e∞
Hk T1 × Hk T2 × S

( Bun T1

/ Hkr (Σ)2 × S
e∞ o
G

∞

µ
µ
p T ,0 × p T ,0 × IdS
e ∞ ,α T
2
1
µΣ
µΣ
(θ1,Bun
×θ2,Bun
)2
2


e ∞)
× Bun T2 × S
O

←
→
q × IdS
e∞

d

p2G,0 ,α G


/ BunG (Σ)2 × BunG (Σ)2 o
O

e∞
HkrH (Σ) × S
p H,0 ,α H

←
←
→
p→
H × pH


Hd (Σ) × Hd (Σ)
O

id,Fr

id,Fr
Σ ×θ Σ
θ1,Bun
2,Bun
µ

e∞
Bun T1 × Bun T2 × S

id,Fr

←
p→
H

µ

/ BunG (Σ)2 o

Hd (Σ)
(4.7)

Let’s review the meaning of those αs appeared above.
(1)
µ

αT :

µ
Hk T1

×

µ
Hk T2

pT

µ
,r × p T ,r ×id e

S∞
1
1
e ∞ −−−−−−−−−−
e∞
×S
→ Bun T1 × Bun T2 × S

(4.8)

AL

T1 ,T2 ,µ∞
e∞
−−−−−−
→ Bun T1 × Bun T2 × S

(4.9)

e ∞ ) to:
In which AL T1 ,T2 ,µ∞ sends (L, F , v(1) : S −→ S

(L(−

∑

x ∈Σ∞

(1)

µ x y x ), F (−

∑

x ∈Σ∞

(1)

Fr
v
(1)
e ∞)
µ x z x ) , v (2) : S −
→ S −−→ S

(4.10)

Notice that there is a Frobenius shift on the last factor. From the master diagram, this is
obvious.
p2 ×id e

AL2

G,r
G,∞
S∞
e ∞ −−−−−−
e ∞ −−−
(2) αG : HkrG (Σ)2 × S
→ BunG (Σ)2 × S
→ BunG (Σ)2

p2 ×id e

AL

H,r
H,∞
S∞
e ∞ −−−−−−
e ∞ −−−→
(3) α H : HkrH (Σ) × S
→ Hd (Σ) × S
Hd (Σ)
d

How this diagram plays its role in Yun-Zhang’s theory? Because taking the fiber products
of the columns is how we reached the “thing we want to compute”, taking the fiber product of
the rows is how we are going to compute it.
The fiber product of the columns:
µ

µ

µ

θ × θ2

µ

µ

µ

µ

0 1
0
0
− Sht Hd (Σ; Σ∞ )0
Sht T1 (µ∞ · Σ1,∞ )0 ×S
e ∞ Sht T2 ( µ∞ · Σ2,∞ ) −−−→ Sht G ( Σ; Σ∞ ) ×S
e ∞ Sht G ( Σ; Σ∞ ) ←
(4.11)
In which:
µ
/ Hkr (Σ) × S∞
(4.12)
Sht (Σ; Σ∞ )
Hd

Hd

p H,0 ,α H


Hd (Σ)

id,Fr


/ Hd (Σ) × Hd (Σ)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

23

µ

µ

e ∞.
and Sht H (Σ; Σ∞ )0 = Sht H (Σ; Σ∞ ) ×S∞ S
d
d
This looks familiar right? Actually by taking the fiber product of the two arrows one obtains
all ∗s in (2.40) for all D ∈ Div+ ( X − Σ) of degree d collectively. To see it, just observe that one
has the following decomposition:

ä

µ

Sht H (Σ; Σ∞ ) =
d

µ

D ∈ Divd ( X −Σ)(k ),degD =d

ShtG (Σ; Σ∞ , h D )

(4.13)

e ∞ with respect to S∞ :
Here for use, base change this equality to S

ä

µ

Sht H (Σ; Σ∞ )0 =
d

µ

D ∈ Divd ( X −Σ)(k ),degD =d

ShtG (Σ; Σ∞ , h D )0

Now taking the fiber product of each row, what you see? The following:
µ

Hk M

(4.14)

d

pM,0 ,α M

Md Σ
µ


µ
× Md Σ
O

id,Fr

Md Σ
µ

in which: αM := ALM,∞ ◦ pM,r .
Let the fiber product of these two arrows be:
Definition 4.5.
/ Hkµ
M

µ

ShtM

µ
Md Σ

d

(4.15)

d

pM,0 ,αM

id,Fr

/ MµΣ
d


µ
× Md Σ

Of course, Shtµ should coincide with (4.11). Then (4.13) can induce the following decompoµ
sition of ShtM :
d

µ

ShtM =
d

µ

ä

µ

ShtM,D

D ∈ Div+ ( X −Σ)(k ),degD =d
µ
preimage of Sht H (Σ; Σ∞ , h D )0 in
d

in which ShtM,D means the
The expectation is the following:

(4.16)

µ

ShtM,D .

µ

e ∞ ] = [Sht (Σ; Σ∞ )0 ]
(id, Fr )! [ HkrHd (Σ) × S
Hd

(4.17)

then one has the following equation:
µ
0µ
0µ
0µ
0µ
e ∞]
(θ1 × θ2 )! [Sht Hd (Σ; Σ∞ )0 ] = (θ1 × θ2 )! (id, Fr )! [ HkrHd (Σ) × S

(4.18)

If one can check those conditions listed by Yun-Zhang in their first volumn concerning the
master diagram, one should get:
0µ

0µ

e ∞ ] = (id, Fr )! (θ1,Hk × θ2,Hk × id e )! [ HkrH (Σ) × S
e ∞ ] (4.19)
(θ1 × θ2 )! (id, Fr )! [ HkrHd (Σ) × S
S∞
d
If one can check the following:
µ

e ∞ ] = [ Hk ]
(θ1,Hk × θ2,Hk × idSe ∞ )! [ HkrHd (Σ) × S
M
d

(4.20)

the right hand side of the equation would become:
µ

(id, Fr )! [ Hk M ]
d

which can be shown is accessible to the Grothendieck-Lefschetz trace formula.

(4.21)

24

HAO LI

4.2. Checking the equations. This section is devoted to check those equations mentioned above.
They basically follow from Yun-Zhang’s fundamental work.
First, checking (4.17). Let (( X − Σ)d × X r )◦ ⊂ (( X − Σ)d × X r ) be the locus {( D; x1 , ...xr ) :
µ
D is disjoint from x1 , ..., xr }. Then restrict Sht H (Σ; Σ∞ ) to (( X − Σ)d × X r )◦ ⊂ (( X − Σ)d × X r ):
d

µ,◦
Sht H (Σ; Σ∞ )
d

/ Shtµ (Σ; Σ∞ )
H


(( X − Σ)d × X r )◦ × S∞


/ (( X − Σ)d × X r ) × S∞

(4.22)

d

µ

Then the preimage of each piece on the right hand of the decomposition (4.13) in Sht H (Σ; Σ∞ )◦
µ

µ

d

is simply ShtG (Σ; Σ∞ , h D )|(X − D)r ×S∞ , which is étale over ShtG (Σ; Σ∞ ), therefore is smooth of
µ

µ

dimension 2r, since ShtG (Σ; Σ∞ ) is. Then ShtG (Σ; Σ∞ , h D )0 |(X − D)r ×S
e ∞ , base change from S∞
e
to S∞ , is also smooth of dimension 2r. Then the following diagram is a complete intersection
diagram:
µ,◦

Sht H (Σ; Σ∞ )0

/ Hkr,◦ (Σ) × S
e∞
H


Hd (Σ)


/ Hd (Σ) × Hd (Σ)

d

d

(4.23)

p H,0 ,α H
id,Fr

µ,◦

since Sht H (Σ; Σ∞ )0 is smooth of the expected dimension:
d

e ∞ + dim( Im(id, Fr )) − 2 · dimHd (Σ) × Hd (Σ)
dimHkr,H◦ (Σ) × S

(4.24)

= 2d + 2r + 3( g − 1) + N − (2d + (3g − 1) + N ) = 2r

(4.25)

d

µ,◦

e ∞ ] = [Sht (Σ; Σ∞ )0 ]. But one already knows that the dimenTherefore (id, Fr )! [ Hkr,H◦ (Σ) × S
H
d

µ

d

sion of ShtG (Σ; Σ∞ , h D )0 is 2r (not necessarily smooth though), the equation holds not only after
e ∞ , but entirely, that is to say, one has the expected equation:
restricted to (( X − Σ)d × X r )◦ × S
µ

e ∞ ] = [Sht (Σ; Σ∞ )0 ]
(id, Fr )! [ HkrHd (Σ) × S
Hd

(4.26)


Next, check the conditions concerning the master diagram.
(1) Condition one: In the master diagram, all stacks except the right top corner, namely
e ∞ are smooth. Basically Yun and Zhang proved all of these in their second
HkrH (Σ) × S
d
e ∞ , this doesn’t affect the
volumn. Here we just take the product of some of them with S
e ∞ is just a product of points.
smoothness since S
(2) Condition two: The following fiber products are of the expected dimension:
µ
µ
• The first column: it is Sht T1 (µ∞ · Σ1,∞ )0 ×Se ∞ Sht T2 (µ∞ · Σ2,∞ )0 . It is of dimension
2r. The expected dimension is:
µ

µ

dimHk T1 + dimHk T2 − dimBun T1 − dimBun T2

(4.27)

= r + dimBun T1 + r + dimBun T2 − dimBun T1 − dimBun T2 = 2r

(4.28)

• The last row: The fiber product is Md Σ . For d large enough, as we have seen
µ
dimMd Σ = 2d − N − g + 1. The expected dimension is:
µ

dimHd (Σ) − dimBun T1 − dimBun T2

(4.29)

= 2d + 3( g − 1) + N − 4( g − 1) − 2N
= 2d − g + 1 − N

(4.31)

(4.30)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

25

µ

µ

• The middle column: the fiber product is ShtG (Σ; Σ∞ )0 ×Se ∞ ShtG (Σ; Σ∞ )0 , so its dimension is simply 4r, and the expected dimension is:
µ

2dimHk G (Σ) − 2dimBunG (Σ)

(4.32)

= 6( g − 1) + 2N + 4r − 6( g − 1) − 2N
= 4r

(4.33)
(4.34)

• The middle row. It is simply double of the last row.
(3) Condition three:
×θ

θ

×id

µ
µ
e∞
1,Hk
2,Hk
S
e ∞ −−−−−−−−−−
e ∞ can be factored into a regular
• Hk T1 × Hk T2 × S
→ HkrG (Σ)2 × S
local immersion followed by a smooth relative Deligne-Mumford type morphism.
µ
Yun and Zhang showed this is true for Hk T −→ HkrG (Σ). Therefore the product
i
also has the desired property.
id,Fr

• Hd (Σ) −−→ Hd (Σ) × Hd (Σ) satisfy the conditions in (A.2.10) in their first volumn[6].
They proved it in their second volumn, and nothing changed here.
(4) Condition four:
µ
µ
µ
• ShtM admits a finite flat presentation. ShtM −→ Md Σ is representable, and in
d
d
∼
µ
→ Md × Se∞ is actually a smooth scheme, as have seen from last
our case M Σ −
d

µ

section. Therefore ShtM admits a finite flat presentation. For the same reason
d

•

µ id,Fr
µ
µ
Md Σ −−→ Md Σ × Md Σ is a regular local immersion.
µ
µ
Sht T (µ∞ · Σ1,∞ )0 for i = 1, 2 and ShtG (Σ; Σ∞ )0 are all
i

smooth Deligne-Mumford

stacks. So

µ

µ

0
Sht T1 (µ∞ · Σ1,∞ )0 ×S
e ∞ Sht T2 ( µ∞ · Σ2,∞ )
µ

θ ×θ

µ

µ

µ

2
1
0
−−−
→
ShtG (Σ; Σ∞ )0 ×S
e ∞ Sht G ( Σ; Σ∞ )

can automatically be factored as a regular local immersion followed by a smooth
relative Deligne-Mumford type morphism, according to the observation by Yun
and Zhang in their first volumn ([6], Remark A4). 
µ

!
r
e
Finally checking (θ1,Hk × θ2,Hk × idS
e ∞ ) [ Hk Hd ( Σ ) × S∞ ] = [ Hk Md ]. First consider the restricr
r
tion of Hk H (Σ) to ( X − Σ)r × X , which means div(φ) and the horizontal modification points
d
are disjoint, and denoted by Hkr,H◦ (Σ). As Yun-Zhang pointed out ([7], Lemma 5.19), the map:
d
HkrH (Σ) −→ HkrG (Σ) × BunG (Σ) Hd (Σ) is an isomorphism when restricted to HkrH (Σ)◦ , so
d

µ,◦

d

Hkr,H◦ (Σ) is a smooth stack of dimension 3( g − 1) + N + 2r + 2d. Therefore Hk M , which means
d

d

µ

e ∞ in Hk , should have dimension:
the preimage of Hkr,H◦ (Σ) × S
M
d

d

µ

µ

dimHkr,H◦ (Σ) + dimHk T1 + dimHk T1 − 2dimHkrG (Σ)
d

= 3( g − 1) + N + 2r + 2d + 2( g − 1 + r ) − 6( g − 1) − 2N − 4r = 2d − g + 1 − N
µ,◦

r,◦
!
e
Therefore (θ1,Hk × θ2,Hk × idS
e ∞ ) [ Hk H ( Σ ) × S∞ ] = [ Hk M ].
d

d

µ

µ,◦

µ

The remaining thing to check is that: dim( Hk M − Hk M ) < dimHk M . Since there is
∼

µ

µ

d

d

d

µ

e ∞ , one only has to check a similar inequality for H ×
the isomorphism: Hk M −
→ Hd × S
d
µ

d

e ∞ . Recall the H from the last section, its points can be considered as: a tuple of divisors
S
d
( E0 , E1 , ...Er ), each of degree 2d − N, and a sequence of points (y1 , ..., yr ) such that Ei is obtained
from Ei−1 by changing a point yi ∈ Ei to τ3 (yi ); together with ∆ ∈ PicdX (S) and a ∈ H 0 (Y3 ×
µ,◦

S, ν3∗ ∆) such that D30 ∈ div( a) and div( a) − D30 = π3 ( Ei ) := E for all i = 1, ...r. Let Hd
µ

be the

subscheme of Hd whose points have the property that div( TrY3 /X ) ∩ (∑ri=1 ν3 π3 (yi )). Then a

26

HAO LI

µ,◦

µ

point in Hd − Hd is characterized by the following:
div( TrY3 /X ( a)) ∩ ν3 ( E) , ∅
This implies that there exist an x ∈ | X | such that ν3−1 ( x ) ⊂ E. Now consider the pair (∆(− x ), div( a) −
ν3−1 ( x )), it is a point of Ad−1 by the construction. There is a map:
X × Ad−1 −→ Ad

( x, (∆, div( a))) 7−→ (∆( x ), div( a) + ν3 ( x ))
Then obviously (∆, a) is the image of (∆(− x ), div( a) − ν3−1 ( x )). Therefore the projection of
µ

µ,◦

Hd − Hd to Ad lies in the image of X × Ad−1 under the above map. However, one has
dim( X × Ad ) = 1 + 2(d − 1) − N − g + 1 = 2d − N − g. By the finiteness of the projection,
µ
µ,◦
one has dim(Hd − Hd ) ≤ dim( X × Ad ) = 2d − N − g < 2d − N − g + 1. 
Recall that we have the following diagram:
/ Hkµ
M

µ

ShtM

d

(4.35)

d

pM,0 ,αM


µ
Md Σ

id,Fr


µ
× Md Σ

/ MµΣ
d

µ

µΣ
!
r
e
Let ζ = [ Hk M ] = (θ1,Hk × θ2,Hk × idS
e ∞ ) [ Hk Hd ( Σ ) × S∞ ]. Then from the smoothness of Md ,
d
one knows that:
µ
(id, Fr )! ζ ∈ Ch0 (ShtM,d )
(4.36)

is well defined.
µ
Using the decomposition (4.13), define ((id, Fr )! ζ ) D ∈ Ch0 (ShtM,D ) be the D-component.
µ

Since ShtM is proper, one can take the degree, and define:
d

hζ, Γ( FrMµΣ )i D := deg((id, FrMµΣ )! ζ ) D
d

(4.37)

d

From all have been checked above, one has:
Proposition 4.6. Suppose D is an effective divisor on X − Σ of degree d such that 2d ≥ 2(2g3 − 1) −
µ
1 + N (as we have seen, this is for the dimension purpose of Md Σ ), then one has:

hZ1 , h D ∗ Z2 i = hζ, Γ( FrMµΣ )i D
µ

µ

(4.38)

d

From all the facts in the last subsection, one has:
0µ

0µ

0µ

µ

0µ

e ∞]
(θ1 × θ2 )! [Sht Hd (Σ; Σ∞ )0 ] = (θ1 × θ2 )! (id, Fr )! [ HkrHd (Σ) × S

(4.39)

e ∞]
= (id, Fr )! (θ1,Hk × θ2,Hk × idSe ∞ )! [ HkrHd (Σ) × S

=

µ
(id, Fr )! [ Hk M ]
d

(4.40)

= (id, Fr )! ζ

(4.41)

Extracting the D-component and taking the degree, one gets:
0µ

0µ

µ

deg((θ1 × θ2 )! [Sht H (Σ; Σ∞ ; h D )0 ]) = deg((id, Fr )! ζ ) D

(4.42)

d

By definition, left hand side is hZ1 , h D ∗ Z2 i while the right hand side is hζ, Γ( FrMµΣ )i D .
µ

µ

d

4.3. The intersection number and the Grothendieck-Lefschetz trace formula. Define the “modµ
uli of shtukas” Sd , for Md as follow first:
/ Hµ
d

µ

Sd


Md

( pH,0 ,pH,r )

(id,Fr )


/ Md × Md

(4.43)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

27

e ∞:
Base change all the spaces above to S
/ Hµ × S
e∞
d

µ

e∞
Sd × S

e∞
Md × S

(4.44)

( pH,0 ×idSe ∞ ,pH,r ×idSe ∞ )

(id,Fr ×idSe ∞ )


/ (Md × S
e ∞ ) × (Md × S
e ∞)

We want to compare this diagram with (4.5). From meaning of its functor of points,
/ Hkµ
M

µ

ShtM

µ
Md Σ

d

(4.45)

d

( pM,0 ,pM,r )

1
(id,AL−
M,∞ ◦ Fr )

/ MµΣ
d


µ
× Md Σ

Actually (4.44) and (4.45) are isomorphic, with the assistance of the following lemma:
Lemma 4.7. The following diagram is commutative:
e∞
Md × S

µ
Md Σ

Fr ×idS
e

∞

/ Md × S
e∞

(4.46)


/ MµΣ
d

1
(id,AL−
M,∞ ◦ Fr )

I’m going to check the diagram with the vertical arrows reversed. Since one can checks it
locally, here I only check one x ∈ Σ∞ . In other words I assume Σ∞ = { x } and Σ f = ∅. Take an
S-object of the left bottom corner:

(L, F , x : S −→ Speck vx , φ : ν1,∗ L −→ ν2,∗ F ).
Going up along the reversed left arrow, one gets:

Le ⊗ Fe (−(y(d+1) , z(1) ) − ... − (y(2d) , z(d) )), x : S −→ Speck vx .
Then going along the top horizontal arrow, one gets:
τ

Le ⊗ τ Fe (−(y(d+2) , z(2) ) − ... − (y(2d) , z(d) ) − (y(1) , z(d+1) ))

On the other hand, if the original objects goes along the bottom horizontal arrow, it becomes:
τ

e∞
L(y(1) ), τ F (z(1) ), x : S −→ S

Then going up long the right vertical arrow, one gets:
τ

Le ⊗ τ Fe (−(y(1) , z(1) ) − (y(1) , z(d+1) ) + (y(1) , z(1) ) + (y(d+1) , z(1) )
−(y(d+1) , z(1) ) − (y(d+2) , z(2) )... − (y(2d) , z(d) ))

One can see that (y(1) , z(1) ) and (y(d+1) , z(1) ) both cancel away, so the remaining is:
τ

Le ⊗ τ Fe (−(y(1) , z(d+1) ) − (y(d+2) , z(2) ) − ... − (y(2d) , z(d) ))

It is the same as you going the other way around as above. 
µ
∼
µ
e ∞ ]. Since we just
e ∞ , we still use ζ for [H µ × S
→ Hd × S
Now via the identification Hk M −
d
d
saw that one can identify (4.45) with (4.44), it is ok to instead consider
e ∞]
(id, Fr × idSe ∞ )! ζ = (id, Fr × idSe ∞ )! [Hd × S
µ

= ((id, Fr )

!

µ
e ∞ ])
[Hd ] × [S

∈

µ
Ch0 (Sd

(4.47)
e ∞)
×S

(4.48)

Extracting the D component one gets:
e ∞ ) · h[H ], Γ( Fr )i D
h(ζ, Γ( Fr ))i D = deg(S
d
µ

(4.49)

28

HAO LI

fd

µ

As you know, the image of the map Sd −→ Md −
→ Ad is in the rational points of Ad , i.e.
A(k). This is because any point in its image is “the same” as its Frobenius twist, therefore must
µ
descent to k. Sd can be decomposed in the following way:

ä

µ

Sd =

a∈A(k )

µ

Sd ( a)

(4.50)

Under the identification of (4.45) with (4.44), one has:
∼

µ

ä

→
ShtM −
D

µ

a∈A D (k )

Sd ( a)

(4.51)

[Hd ] defines a cohomological self-correspondence of (Md , Ql ), therefore induces an endomorphism of the cohomology sheaf (complex) R f d,! Ql :
µ

f d,! [Hd ] : R f d,! Ql −→ R f d,! Ql
µ

(4.52)

According to Yun-Zhang, one can apply the Grothendieck-Lefschetz trace formula to the
diagram (4.43), getting the following formula:

h[Hd ], Γ( Fr )i D =

∑

µ

Tr( f d,! [Hd ] ◦ Fr a , (R f d,! Ql ) a )
µ

a∈A D (k )

(4.53)

µ

In which a is the geometric point sitting over a. Since Hd is built up from composing the
µ
building block Hd with itself, one can furthur writes f d,! [Hd ] = ( f d,! [Hd ])r .
In summary, we reach the following:
Proposition 4.8. Suppose D has degree greater than 2g3 − 1 + N, then one has:
µ

µ

hZ1 , h D ∗ Z2 i = (

∏

2d x ) ·

x ∈Σ∞

in other words:
Iµ ( h D ) =

∑

a∈A D (k )

∑

Tr( f d,! [Hd ] ◦ Fr a , (R f d,! Ql ) a )
µ

a∈A D (k )

Tr( f d,! [Hd ] ◦ Fr a , (R f d,! Ql ) a )
µ

(4.54)

(4.55)

5. T HE ANALYTIC SIDE
e ∞ , for each x ∈ Σ f
5.1. The moduli space on the analytic side. Recall that we fixed a choice of S
Σf
Σ
an over point in Y, and (µ f , µ∞ ) ∈ {±1} × {±1} ∞ . This choice defined a divisor D30 =
∑ x∈Σ f w0x on Y3 .
Now fix a nonnegative integer d. For any pair of nonnegative integers (d1 , d2 ) such that
d1 + d2 = 2d, define the following moduli space:
f(d ,d ) be the stack over k whose functor of points on a k-scheme S consistDefinition 5.1. Let N
1 2
ing of the following:
• A line bundle L on Y3 ×k S, a splitted rank 2 vector bundle L1 ⊕ L2 on X ×k S.
• A map of coherent sheaves over X ×k S, φ : ν3,∗ L −→ L1 ⊕ L2 , such that degφ = d and
div(det(φ)) is away from Σ. Also we require φ(ν3,∗ (L(−w0x ))) ⊂ L1 ⊕ L2 (− x ) for each
x ∈ Σ.
• 2degL1 − degL = d1 and 2degL2 − degL = d2
f(d ,d ) modulo the action of Pic X . Collecting all
Then as usual, N(d1 ,d2 ) is defined to be N
1 2
(d1 , d2 ) such that d1 + d2 = 2d, one can denote:

Nd =

ä

d1 +d2 =2d

N(d1 ,d2 ) .

(5.1)

This N(d1 ,d2 ) fits into a commutative diagram similar to (3.18), in particular, admits a “Hitchin
type fiberation” over the moduli space Ad . To get it, first base change φ to Y3 , one gets:

L ⊕ σ3∗ L −→ ν3∗ L1 ⊕ ν3∗ L2

(5.2)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

29

Let φ11 : L −→ ν3∗ L1 and φ21 : L −→ ν3∗ L2 . Then the condition φ(ν3,∗ (L(−w0x ))) ⊂ L1 ⊕
L2 (− x ) for each x ∈ Σ becomes:

L(−w0x ) ⊕ σ3∗ L(−wx ) −→ ν3∗ L1 ⊕ ν3∗ L2 (−wx − w0x )

(5.3)

This puts restrictions on φ21 :
σ3 (φ21 )|w0x = 0 and φ21 |wx = 0

(5.4)

Therefore one can view σ3 (φ21 ) as a section of the line bundle σ3∗ L−1 ⊗ ν3∗ L2 (− D30 ), which is of
degree d2 − N. By recording φ11 and σ3 (φ21 ), one gets the following morphism:

N(d1 ,d2 ) −→ Ŷ3,d1 ×k Ŷ3,d2 − N

(5.5)

(L, L1 , L2 ) 7−→ ((L−1 ⊗ ν3∗ L1 , φ11 ), (σ3 ∗ L−1 ⊗ ν3∗ L2 (− D30 ), σ3 (φ21 ))

(5.6)

Taking the tensor product of φ11 and σ (φ21 ), one gets φ11 ⊗ σ3 (φ21 ) as a section of L−1 ⊗
σ3∗ L−1 ⊗ ν3∗ L1 ⊗ ν3∗ L2 vanishing at D30 . But L−1 ⊗ σ3∗ L−1 ⊗ ν3∗ L1 ⊗ ν3∗ L2 is nothing but ν3∗ ∆,
in which ∆ is det(ν3,∗ L)−1 ⊗ det(L1 ⊕ L2 ).
The fact that L−1 ⊗ ν3∗ L admits a global section φ11 implies that d1 ≥ 0 and σ3 (φ21 ) must
vanish at D30 forces d2 ≥ N, one has:

Nd =

ä

d1 +d2 =2d,d1 ≥0,d2 ≥ N

N(d1 ,d2 )

(5.7)

From the definition, one obviously has the commutative diagram:

N(d1 ,d2 )

/ Ŷ3,d ×k Ŷ3,d − N
2
1


Ad


/ Ŷ3,2d− N

(5.8)

Actually one has the following:
Proposition 5.2. This diagram is Cartesian.
It is amount to showing that given: (∆, a) ∈ Ad (S) and (K1 , φ11 ) ∈ Ŷ3,d1 , (K2 , φ22 ) ∈ Ŷ3,d2 − N
∼
together with an isomorphism ν3∗ ∆(− D30 ) −
→ K1 ⊗ K2 carrying a0 to φ11 ⊗ φ22 (recall that I use
a0 to mean a viewed as a section of ν3∗ ∆(− D30 ).), one can reconstruct a unique object in N(d1 ,d2 ) .
It is more or less the same as what Howard-Shnidman did, but paying attention to the sublattice
or vanishing of the sections at D30 .
∼
→ K1 ⊗ K2 by D30 , one gets:
Let K20 = K2 ( D30 ). Twisting the isomorphism ν3∗ ∆(− D30 ) −
∼

ν3∗ ∆ −
→ K1 ⊗ K2 ( D30 ) = K1 ⊗ K20
Take L1 to be any line bundle over X ×k S. Then you can guess that L is simply defined to be
K1−1 ⊗ Le1 . Then from the definition of the map N(d1 ,d2 ) −→ Ŷ3,2d− N , one can guess that ν3∗ L2
should be defined as σ3∗ L ⊗ K20 . So one has to show that σ3∗ L ⊗ K20 can descent to X to get L2 ,
but:
σ3∗ (σ3∗ L ⊗ K20 ) = σ3∗ (σ3∗ K1−1 ⊗ σ3∗ ν3∗ L1 ) ⊗ σ3∗ K20
∼

∼

→ K1−1 ⊗ σ3∗ K1−1 ⊗ ν3∗ ∆ ⊗ ν3∗ L1
−
→ K1−1 ⊗ ν3∗ L1 ⊗ σ3∗ K20 −
∼

∼

−
→ (K1−1 ⊗ ν3∗ ∆) ⊗ σ3∗ K1−1 ⊗ ν3∗ L1 −
→ K20 ⊗ σ3∗ (K1−1 ⊗ ν3∗ L1 )
∼

−
→ σ3∗ L ⊗ K20
All the isomorphisms are either canonical or from the definition. Therefore, σ3∗ L ⊗ K20 is an σ3 equivariant line bundle, hence descent to X. One can view φ11 as a section of HomOY (L, ν3∗ L1 )
3

30

HAO LI

and φ22 as a section of HomOY (L, ν3∗ L2 ) vanishing at D30 . Now the homomorphisms of line
3
bundles over Y3 :
φ11 : L −→ ν3∗ L1
∼

φ12 = σ3 (φ11 ) : σ3∗ L −→ σ3∗ ν3∗ L1 −
→ ν3∗ L1
∼

φ21 = σ3 (φ22 ) : σ3∗ L −→ σ3∗ ν3∗ L2 −
→ ν3∗ L2
φ22 : L −→ ν3∗ L2
descent to a homomorphism: φ : ν3,∗ L −→ L1 ⊕ L2 . Since φ22 vanishes at D30 and φ21 vanishes
at σ3 ( D30 ), φ actually sends ν3,∗ (L(−w0x )) to L1 ⊕ L2 (− x ) for each x ∈ Σ. 
e3 = GL2,ν O be the group scheme over X whose functor of
5.2. The orbital integral. Recall G
∗ Y3
e3 /Z ( G
e3 ). Also, G = PGL2,X .
points on an X-scheme U is H 0 (U, EndOU ( f ∗ (ν∗ OY3 ))), G3 = G
∗
The pushfoward ν3 OY3 is not isomorphic to O X ⊕ O X , but their generic fibers are simply K3
and F ⊕ F, both 2-dimensional vector space over F. Fix an isomorphism ρ : F ⊕ F −→ K3 . This
isomorphism induces isomorphisms: Fx ⊕ Fx −→ (K3 ) x for all x ∈ | X |. Almost all of them are
integral, except at finitely many xs. Therefore it induces an isomorphism: ρ : A ⊕ A −→ A3 ,
in which A is the adelic ring of X, and A3 = K3 ⊗ F A. It carries O ⊕ O not exactly to O3 .
One can take an h ∈ G3 (A) such that ρ(O ⊕ O) = h · O3 . Any x ∈ Σ splits in K3 into wx
and w0x as we have seen above. Therefore one has (K3 ) x = Kwx ⊕ Kw0x and each one of them is
isomorphic to Fx as local fields. For later use, I furthur require that h−1 carries ρ(Ox ⊕ vx Ox )
into Owx ⊕ vw0x Ow0x . Use ρ and h, one can define the following maps:
ρ : GF −→ G3,F , g 7−→ ρ ◦ g ◦ ρ−1

(5.9)

ρ · h : G (A) −→ G3 (A), g 7−→ ρ ◦ g ◦ ρ−1 · h

(5.10)

The first map is an isomorphism of group schemes over F, not over X, and the second map
is an isomorphism of topological spaces, not a group homomorphism. Via the first isomorphism of group schemes, one gets a one to one correspondence between the Borel subgroups of
G0 (A) and G3 (A). Via the second isomorphism of topological spaces, one identify the space of
automorphic forms on them:
L2 ( G ( F )\ G (A)) −→ L2 ( G3 ( F )\ G3 (A))
φ 7−→ φ3 : y 7−→ φ(ρ

−1

◦ (y · h

(5.11)
−1

) ◦ ρ)

(5.12)

Even though there is such a weird h here, one still has the following:
Proposition 5.3. The above map of function spaces enjoys the properties:
(1) It identifies L2cusp ( G ( F )\ G (A)) with L2cusp ( G3 ( F )\ G3 (A)).
f x be the Iwahori subgroup of G (Ox ) stablizing the lattice chain: Ox ⊕ Ox ⊃ Ox ⊕ vx Ox
(2) Let Iw
f w0 be the Iwahori subgroup of G3 (Ox ) stablizing the lattice chain: Ox ⊕ Owx ⊃ Ow0 ⊕
and Iw
x

x

vw0x Ow0x . Let Iw x and Iww0x be their image in G (Ox ) and G3 (Ox ). Then the above maps
induces:
L2 ( G ( F )\ G (A))G(O

Σ )×

∏ x∈Σ Iw x

−→ L2 ( G3 ( F )\ G3 (A))

G3 (OΣ )×∏ x∈Σ Iww0

x

(5.13)

For the first part, recall that φ ∈ L2cusp ( G ( F )\ G0 (A)) if it satisfy the following equation:


Z
1 x
φ(
g)dx = 0
0 1
F \A
for any Borel subgroup (the above equation is for the standard upper triangular one) and any
g. Since ρ : GF −→ G3,F is an isomorphism of group schemes, it induces a one to one correspondence between the Borels of GF and those of G3,F . Now let φ3 be the function on G3 (A)
correspond to φ as above, consider the following integral:

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

Z



1
φ3 (ρ ◦
0
F \A

31


x
◦ ρ−1 · y)dx = 0
1

Using the relation between φ and φ3 :


1 x
φ3 (ρ ◦
◦ ρ −1 · y )
0 1


1 x
= φ ( ρ −1 ◦ ρ ◦
◦ ρ −1 · y · h −1 ◦ ρ )
0 1


1 x
= φ(
· ρ −1 ◦ y · h −1 ◦ ρ )
0 1
Therefore one has the equation:



Z
Z
1 x
1
φ3 (ρ ◦
◦ ρ−1 · y)dx =
φ(
0 1
0
F \A
F \A


x
· ρ−1 ◦ y · h−1 ◦ ρ)dx
1

Now ρ−1 ◦ y · h−1 ◦ ρ is an element of G (A), so by the cupidality of φ, the right hand side
integral vanishes, therefore also the left hand side one.
For the second part, one needs to check that φ3 (y · g) = φ3 (y) for any g ∈ G3 (OΣ ) ×
∏ x∈Σ Iww0x , if φ is fixed by G (OΣ ) × ∏ x∈Σ Iwx . First let’s check for g ∈ idΣ × ∏ x∈Σ Iww0x . To see
this:
φ3 (y · g) = φ(ρ−1 ◦ y · g · h−1 ◦ ρ)

= φ((ρ−1 ◦ y · h−1 ◦ ρ) · (ρ−1 ◦ h · g · h−1 ◦ ρ))
As I required, h−1 · ρ(Ox ⊕ vx Ox ) = Owx ⊕ vw0x Ow0x for every x ∈ Σ. Since g ∈ ∏ x∈Σ Iwwx , one
gets: g · h−1 · ρ(Ox ⊕ vx Ox ) = Owx ⊕ vw0x Ow0x . Therefore ρ−1 ◦ h · g · h−1 ◦ ρ stablizes the lattice
chain: Ox ⊕ Ox ⊃ Ox ⊕ vx Ox , therefore is in ∏ x∈Σ Iwx . Therefore one finds:
φ((ρ−1 ◦ y · h−1 ◦ ρ) · (ρ−1 ◦ h · g · h−1 ◦ ρ))

= φ(ρ−1 ◦ y · h−1 ◦ ρ) = φ3 (y)
The spherical part is the same, only easier because you only have to care about the maximal
lattices not lattice chains. 
To relate the orbital side of relative trace formula to the moduli space on the analytic side,
one needs the following J space, introduced by Howard and Shnidman.
Definition 5.4. Let e
J be the following functor over X:

(Sch/X ) −→ ( Ens)
U 7−→ IsomOU (ν3,∗ OY3 , O X ⊕ O X )
It is representable by a scheme over X. Let J be e
J/Gm,X . It is a G × G3 bitorsor.
One can take its adelic point:
J (A) = IsoA (A3 , A ⊕ A)/A∗
Using ρ and h, it can be identified with G (A) as topological spaces:
J (A) −→ G (A)
ψ 7−→ ψ ◦ h

−1

(5.14)

◦ρ

(5.15)

This map has the property:
f J,x be the subspace of e
Proposition 5.5. Let Iw
J (Ox ) sending the lattice chain Ox ⊕ Owx ⊃ Ow0x ⊕
vw0x Ow0x to the lattice chain Ox ⊕ Ox ⊃ Ox ⊕ vx Ox for each x ∈ Σ. Let Iw J,x be its image in J (Ox ).
Then the above isomorphism of topological spaces identifies Iw J,x with Iwx . Away from Σ, it identifies
J (Ox ) with G (Ox ).

32

HAO LI

Let Cc∞ ( G (A)) be the compactly supported group algebra (test functions) of G (A). Via the
above isomorphism of topological spaces, one can get the an isomorphism of function spaces:
Cc∞ ( G (A)) −→ Cc∞ ( J (A))

(5.16)

f 7−→ f J : ψ 7−→ f (ψ ◦ h

−1

◦ ρ)

(5.17)

We also identify J ( F ) and G ( F ) as follows:
G ( F ) −→ J ( F )

(5.18)

γ 7−→ γ ◦ ρ

(5.19)

Note that it is different from the map on the adelic points.
Recall the integration kernel for f ∈ Cc∞ ( G (A) in the trace formulae:
K f : G (A) × G (A) −→ Ql

( g0 , g00 ) 7−→

(5.20)

∑

f ( g0−1 γg00 )

(5.21)

γ∈ G ( F )

To relate it with the moduli space on the analytic side, we want to “make” it a kernel function
on G (A) × J (A).
Proposition 5.6. Let f and f J be the functions on G (A) and J (A) respectively, matching each other as
(5.16). Let γ0 ∈ G ( F ) and γ = γ0 ◦ ρ−1 ∈ J (A). Let g3 ∈ G3 (A) and g00 ∈ G (A) match each other
as in (5.10). Then one has:
f J ( g0−1 γg3 ) = f ( g0−1 γ0 g00 )
(5.22)
To see it:
f J ( g0−1 γg3 ) = f ( g0−1 γg3 ◦ h−1 ◦ ρ)

= f ( g0−1 γ ◦ ρ ◦ ρ−1 ◦ g3 ◦ h−1 ◦ ρ)
By (5.10), one has ρ−1 ◦ g3 ◦ h−1 ◦ ρ = g00 . Also since γ0 = γ ◦ ρ, one sees the right hand side is
exactly f ( g0−1 γ0 g00 ). 
For f J , define:
K f J : G (A) × G3 (A) −→ Ql

( g0 , g3 ) 7−→

∑

(5.23)
f J ( g0−1 γg3 )

(5.24)

γ∈ J ( F )

Let A ⊂ G be the diagonal torus and T3 = ResY3 /X Gm /Gm be the nonsplit torus determined
by Y3 naturally sitting inside G3 as in the introduction. By Howard-Shnidman, the fourfold
cover Y defines a character η of T3 (A) = A3∗ /A∗ . Let:
A(A)n = {t0 ∈ A(A) : deg(t0 ) = n}
and [ A]n = A( F )\ A(A)n . For any f J ∈
Jn ( f J , s ) =

Cc∞ ( J (A),

Z
[ A]n ×[ T3 ]

= q−2ns

(5.25)

define the integral:

K f J (t0 , t3 )|t0 |2s η (t3 )dt0 dt3

(5.26)

K f J (t0 , t3 )η (t3 )dt0 dt3

(5.27)

Z
[ A]n ×[ T3 ]

and one has the fact:
Proposition 5.7. The integral Jn ( f J , s) vanishes for |n| sufficiently large.
Therefore it is legitimate to define:
J( f J , s ) =
Also, let:
K f J ,γ ( g0 , g3 ) =

∑

n ∈Z

Jn ( f J , s )

∑

δ∈ A( F )γT3 ( F )

f J ( g0−1 δg3 )

(5.28)

(5.29)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

33

For any γ ∈ J ( F ) and g0 ∈ G ( F )\ G (A), g3 ∈ G3 ( F )\ G3 (A). One also define:
Jn (γ, f J , s) =

Z
[ A]n ×[ T3 ]

K f J ,γ (t0 , t3 )|t0 |2s η (t3 )dt0 dt3

and
J( f J , s ) =

(5.30)

∑ J(γ, f J , s)

(5.31)

∑

Jn (γ, f J , s)

(5.32)

∑

J(γ, f J , s)

(5.33)

n∈Σ

so that:
Jn ( f J , s ) =

γ∈ A( F )\ J ( F )/T3 ( F )

and
J( f J , s ) =

γ∈ A( F )\ J ( F )/T3 ( F )

Recall that Howard and Shnidman defined the invariants of A( F )\ J ( F )/T3 ( F ):
Proposition 5.8. There is a bijection:
inv : A( F )\ J ( F )/T3 ( F ) −→ { a ∈ K3 : TrK3 /F ( a) = 1}

(5.34)

Let me review their proof. Actually this is the generic fiber version of the Hitchin type
fiebration introduced above. Take a morphism of F-vector spaces:
φ : K3 −→ F ⊕ F
base change it to SpecK3 (the double cover) to split K3 (the rank two vector bundle):
φ⊗id

∼

∼

K3 ⊕ K3 −
→ K3 ⊗ K3 −−→ K0 ⊗ F K3 −
→ K3 ⊕ K3
As in its geometrization, one gets the maps of K3 -vector spaces:
φ11 : K3 −→ K3 , σ3 (φ11 ) : K3 −→ K3
φ21 : K3 −→ K3 , σ3 (φ21 ) : K3 −→ K3
In which σ3 ( a) and σ3 (c) are σ3 -linear. Let:
∆ = Hom F (det F (K3 ), det F ( F ⊕ F ))
Then det F (φ) is an element of this vector space (a section of this line bundle over the generic
point of X).
Now the invariant map is defined to be inv(φ) = (φ11 · σ3 (φ21 ))/det(φ). The map φ is called
regular if a = inv(φ) is not 0 in K3 . 
Therefore one can also index the double cosets in A( F )\ J ( F )/T3 ( F ) by their invariants, i.e.:
J( f J , s ) =

∑

J(γ, f J , s) =

γ∈ A( F )\ J ( F )/T3 ( F )

∑

J( a, f J , s)

(5.35)

a∈K3 ,TrK3 /F ( a)=1

5.3. The orbital integral and the period integral. The relative trace formula relates the orbital
integral with certain period integrals summed over automorphic forms. Let π be a cuspidal
automorphic representation of G (A). For any φ ∈ π, define the period integral along A(A):
P0 (φ, s) =

Z
[ A]

φ(t0 )|t0 |2s dt0

(5.36)

Using (5.3), one can move acusp form φ on G (A) to a cusp form φ3 on G3 (A). Define the period
of φ3 along T3 (A):
Z
P3,η (φ3 ) =

[ T3 ]

φ3 (t3 )η (t3 )dt3

(5.37)

Both integrals are absolutely convergent. For T3 there is no variable since it is anisotropic.
Define the global spherical character relative to ( A × T3 , 1 × η ) as:
Jπ ( f J , s ) =

∑
φ

P0 (π ( f )φ, s)P3,η (φ3 )
hφ, φi

(5.38)

34

HAO LI

in which f ∈ Cc∞ ( G (A)) is the function correspond to f J and φ3 is the automorphic form of
G3 (A) corresponding to φ. The sum is over an orthogonal basis of φ, and hφ, φi is the Petersson
inner product of φ with itself.
Now let’s choose the test function to be used. In their second volumn, Yun and Zhang
Σ ∈ H Σ . And they proved the following theorem:
defined the Eisenstein ideal I Eis
G
Σ . Take any f ∈ C ∞ ( G (A )) such that it is left invariant under the Iwahori
Theorem 5.9. Let f ∈ I Eis
Σ
c
subgroup ∏ x∈Σ Iwx . Then the kernel function of f Σ = f ⊗ f Σ has vanishing Eisenstein part, i.e.:

K f Σ = K f Σ ,cusp + K f Σ ,sp
In other words, K f only has cuspidal and residual parts.
Please notice that f Σ doesn0 t mean the product of the components away from Σ as usual,
N
Σ .
it is a product over all primes. Consider the test function f Σ = f ⊗ ( x∈Σ 1 Iwx ) for f ∈ I Eis
N
Σ
Then f J has the form f J = f J ⊗ ( x∈Σ 1 Iw J,x ). Define the
Proposition 5.10. For each f Σ of the form above, one has:
J( f JΣ , s) =

Jπ ( f JΣ , s)

∑

(5.39)

π

where the sum is over all π with G (AΣ ) × ∏ x∈Σ Iwx fixed vector.
First on G (A), one has:
K f Σ ( g0 , g00 ) = ∑

φ( g0 )φ( g00 )
hφ, φi

λπ ( f ) ·

π

+∑

λχ ( f ) · ·χ(det( g0 )) · χ(det( g00 ))

(5.40)
(5.41)

χ

where the sums are over πs and χs with Iwahori fixed vectors, and φ is the G (AΣ ) × ∏ x∈Σ Iwx fixed vector. Now transfer to J (A):
K f Σ ( g0 , g3 ) =
J

∑

λπ ( f ) ·

π

φ( g0 )φ3 ( g3 )
hφ, φi

+∑

λχ ( f ) · ·χ(det( g0 )) · χ(det(ρ ◦ g3 · h−1 ◦ ρ))

=∑

λπ ( f ) ·

+∑

λχ ( f ) · ·χ(det( g0 )) · χ(det(ρ−1 ◦ g3 ◦ ρ ◦ ρ−1 · h−1 ◦ ρ))

χ

π

φ( g0 )φ3 ( g3 )
hφ, φi

χ

Let det3 : G3,F −→ Gm,F be the character defined by det3 ( g3 ) := det(ρ−1 ◦ g3 ◦ ρ). It is a
generator of X ∗ ( G3,F ). The last term above becomes:
χ(det(ρ−1 ◦ g3 ◦ ρ ◦ ρ−1 · h−1 ◦ ρ)) = χ(det3 ( g3 )) · χ(det3 (h−1 ))
in which χ(det3 (h−1 )) is a nonzero number.
Now one only has to show that either one of the following is 0:
Z

Z

2s

[ A]n

χ(det(t0 ))|t0 | dt0 ,

[ T3 ]

χ(det3 (t3 ))η (t3 )dt3

If χ is non trivial on A1 = A0∗ , take a t00 such that χ(det(t00 )) , 1. Then one has:
Z
[ A]n

χ(det(t0 ))|t0 |2s dt0 =

=

Z
[ A]n

Z
[ A]n

χ(det(t00 t0 ))|t00 t0 |2s d(t00 t0 )
χ(det(t00 ))χ(det(t0 ))|t0 |2s dt0

From this one gets:

(1 − χ(det(t00 ))) ·

Z
[ A]n

χ(det(t0 ))|t0 |2s dt0 = 0

(5.42)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

35

This implies the second factor is 0.
If χ is trivial on A1 , then the integral on [ T3 ] becomes:

(a non zero constant) ·

Z
[ T3 ]

η (t3 )dt3

(5.43)

The constant is something in q. Now since η is the quadratic character defining K over K3 , it
is non trivial on A13 . Applying the same trick above to η and A13 proves the vanishing of this
integral. 
We want to study the r-th derivative of q Ns J( f JΣ , s), hence define.:
Jr ( f JΣ , s) =

dr
|s=0 (q Ns J( f JΣ , s))
dsr

(5.44)

dr
|s=0 (q Ns J( a, f JΣ , s))
dsr

(5.45)

Similarly define:
Jr ( a, f JΣ , s) =

The q Ns is to make it match the geometric side later.
Then one has:
Jr ( f JΣ , s) =

∑

Jr ( a, f JΣ , s)

(5.46)

a∈K3 ,TrK3 /F ( a)=1

Actually one needs f J ’s spherical part to be in the Eisenstein ideal, but that is not directly related
to the moduli spaces. Rather, one first consider those h D ∈ H Σ , then use the linear combination
of these elements indexed by the effective divisors on X − Σ to approximate the elements in the
Eisenstein ideal (in some representation of the Hecke algebra). With the assit of (5.5), we have:
Proposition 5.11. Let h D ∈ H Σ be the element indexed by D ∈ Div+ ( X − Σ), then h D ⊗ ( x∈Σ 1 Iwx )
N
matches h D,J ⊗ ( x∈Σ 1 Iw J,x ) where h D,J is the element in Cc∞ ( G (OΣ )\ G (AΣ )/G3 (OΣ )) indexed by
D.
N

From now on, I use hΣD to denote h D,J ⊗ (

N

x ∈Σ 1 Iw J,x ).

5.4. The orbit integral and the moduli space. The general spirit of Yun-Zhang’s theory is to
“upgrade” the equality of two numbers to an “equality” between two complexes of sheaves on
the Hitchin base Ad first. After proving the equality of complexes of sheaves, one decategorify
it via Grothendieck’s faisceaux-fonctions correspondence to get the expected equality between
two numbers. Now we have to express the numbers Jr ( a, hΣD , s) as the Frobenius traces of some
complexes of sheaves on Ad .
What that complex of sheaf is? First Y is a double cover of Y3 , the pushforward of the constant sheaf π3,∗ Ql decomposes as Ql ⊕ LY/Y3 , in which LY/Y3 is the local system on Y3 defined
by the representation:
π1et (Y3 ) −→ hτ3 i −→ {±1}

(5.47)

in which the second arrow is non trivial.
From the geometric class field theory for Y3 , there is a corresponding local system on PicY3 ,
therefore a local system on PicYd 3 for each d. Pull it back along the cover:
Ŷ3,d −→ PicY3

(5.48)

one gets a local system on Ŷ3,d for every d. Denote it by Ld .
Recall that we have the morphism:
j(d1 ,d2 ) : N(d1 ,d2 ) −→ Ŷ3,d1 ×k Ŷd2 − N
Let L(d1 ,d2 ) = j(∗d ,d ) ( Ld1  Ql )
1 2
Recall that we defined A D before (3.7):

(5.49)

36

HAO LI

Definition 5.12.

/ Ad

AD

Speck

Tr

(O X ( D ),1)


/ X̂d

Then we have the proposition parallel to the one in Howard-Shnidman:
Proposition 5.13. There is a canonical bijection:


∼
a ∈ K3
invD : A D (k) −
→


TrK3 /F ( a) = 1




div( a) + ν3∗ D − D30 ≥ 0



From the definition of A D , a point of it consists of a line bundle ∆ ∈ Picd ( X ), a global section
∼
a of ν3∗ ∆, vanishing at D30 and an isomorphism: (∆, TrY3 /X ( a)) −
→ (O X ( D ), 1). The identification
∼
∼
here ∆ −
→ O X ( D ) induces an identification ν3∗ ∆ −
→ OY3 (ν3∗ D ). Via this latter isomorphism, a is
∗
identified with a global section of OY3 (ν3 D ) vanishing at D30 . This is nothing but a a ∈ K3 such
that div( a) + ν3∗ D − D30 ≥ 0. 
One call the set on the right hand side the invariants for A D (k ).
Now it is the time to state what we want:
Proposition 5.14. Let a ∈ K3 such that TrK3 /F ( a) = 1. Identify Ad (k) as a subset of K3 via invD as
above. Then one has the following:
(1) If a < A D (k), then J( a, hΣD , s) = 0;
(2) If a ∈ A D (k), then one has:
J( a, hΣD , s) =

∑

(d1 +d2 =2d,d1 ≥0,d2 ≥ N )

q(d1 −d2 )·s Tr( Fr a , (Rg! L(d1 ,d2 ) ) a )

(5.50)

where a is the geometric point sitting over the k-point a : Speck −→ A D .
First let e
h D ∈ H ( GL2 (OΣ )\ GL2 (AΣ )/GL2 (OΣ )) be the characteristic function of those double cosets whose determinants have divisor D on X − Σ. Let:
O
e
hD ⊗
1f
hΣ := e
(5.51)
D

x ∈Σ

Iw J,x

e be a preimage of γ in GL2 ( F ), then one has:
Let γ be an element with invariant ξ, and γ
J(γ, hΣD , s) =

Z
e(A)× T
e3 (A)
Z (A)\ A

e
et3 )|t0 |2s η (t3 )dt0 dt3
hΣD (t0−1 γ

(5.52)

One rewrite it as:
Z
e(A)× T
e(O)× T
e3 (A)/ A
e3 (O)
Z (A)\ A

(

Z
e(O)× T
e3 (O)
A

e
hΣD (t0−1 x −1 γyt3 )| xt0 |2s η (yt3 )dxdy)dt0 dt3

Since | x | = 1 and η is trivial on O3 , one can simply it:
Z
e(A)× T
e(O)× T
e3 (O)
e3 (A)/ A
Z (A)\ A

=

e
hΣD (t0−1 γt3 )|t0 |2s η (t3 ) · (

Z
e(A)× T
e(O)× T
e3 (A)/ A
e3 (O)
Z (A)\ A

Z
e(O)× T
e3 (O)
A

dxdy)dt0 dt3

e
hΣD (t0−1 γt3 )|t0 |2s η (t3 )dt0 dt3

e D,eγ whose
To furthur simply this integral and relate it to geometry, we introduce the set X
points consist of the tuples ( E, E1 , E2 ) ∈ Div(Y3 ) × Div( X ) × Div( X ) who satisfy the following:
e : ν3,∗ OY3 d O X ⊕ O X :
• The map induced by γ
φγe : ν3,∗ (OY3 (− E)) −→ O X (− E1 ) ⊕ O X (− E2 )
is everywhere defined.
• div(det(φ)) is D.

• it sends ν3,∗ (OY3 (− E)(−w0x )) into O X (− E1 ) ⊕ O X (− E2 )(− x ) for every x ∈ Σ.

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

37

e D,eγ /Div( X ). The integral furthur simplies to:
Let XD,eγ = X
Z
e(A)× T
e(O)× T
e3 (A)/ A
e3 (O)
Z (A)\ A

e
hΣD (t0−1 γt3 )|t0 |2s η (t3 )dt0 dt3

∑

=

q−deg(E1 −E2 )·2s η ( E)

(5.53)
(5.54)

( E,E1 ,E2 )∈XD,eγ

e, let’s denote XD,eγ(ξ ) .
We have the invariant χ attached to γ
The set XD,eγ(a) is closedly related to the moduli space Nd for d = degD. For a k-rational
point of A D , a, furthur define Nd,a to be the fiber product:

Nd,a

/ Nd


Speck


/ Ad

(5.55)

g
a

e. If a is not in the image of the invariants of A D (k), then
Proposition 5.15. Let a be the invariant of γ
XD,eγ = ∅; If a is an invariant of A D (k ), then there exists a bijection:
∼

λ : XD,eγ(a) −
→ Nd,a (k)

(5.56)

Let’s first define a map:
∼

λ : XD,eγ(a) −
→ Nd (k )

(5.57)

by sending ( E, E1 , E2 ) to (OY3 (− E), O X (− E1 ), O X (− E2 ), φγe ). Since the induced map φγe has
devisor D degree d, the image really lies in Nd (k), and its image in Ad (k ) lies in A D (k). From
e and of φγe , one can see they are the same. So a is in the image
the definition of the invariant of γ
of A D (k ). Therefore if a is not an invariant of A D (k), XD,eγ(a) must be empty.
Now one has to show that any element of Nd,a arise as a image of some point of XD,eγ(a) .
This basically follows from Howard-Shnidman. Given a tuple (L, L1 , L2 , φ) ∈ Nd,a (k), fix
isomorphisms of the generic fiber of ν3∗ L with K3 , L1 , L2 with F respectively:
∼

g3 : ν3,∗ L|ηX −
→ K3 ,

∼

g1 : L 1 | η X −
→ F,

∼

g2 : L 2 | η X : −
→F

(5.58)

Then φ transfer to a map of F-vector spaces γ : K3 −→ F ⊕ F. The inverse images of 1 under
g3 and g1 , g2 defines rational sections of ν3,∗ L and L1 , L2 , say s1 , s2 , s3 . Then ( E, E1 , E2 ) can be
selected as (−div(s3 ), −div(s1 ), −div(s2 )). The requirement at Σ is automatic from the same
requirement for (L, L1 , L2 , φ). 
One can furthur decompose Nd,a into N(d1 ,d2 ),a , getting:

ä

Nd,a =

d1 +d2 =2d,d1 ≥0,d2 ≥ N

N(d1 ,d2 ,a)

(5.59)

The point counding formula (5.53) on Xγe,D (k) can be reinterpreted as counting points on Nd,a (k):

∑

q−deg(L1 −L2 )·2s · η (L)

(5.60)

(L,L1 ,L2 ,φ)∈Nd,a (k)

∑

=

q(d1 −d2 )·s

(d1 +d2 =2d,d1 ≥0,d2 ≥ N )

∑

(L,L1 ,L2 ,φ)∈N(d

η (L)

(5.61)

(k)
1 ,d2 ),a

Apply the Grothendieck-Lefschetz trace formula to the diagram (5.55) and the complex of vector spaces (Rg! L(d1 ,d2 ) ) a , one get the desired equation:
J( a, hΣD , s) =

∑

(d1 +d2 =2d,d1 ≥0,d2 ≥ N )

This finish the proof of (5.14).

q(d1 −d2 )·s Tr( Fr a , (Rg! L(d1 ,d2 ) ) a )

38

HAO LI

6. C ONCLUSIONS
6.1. Comparision of sheaves. Now both the intersection number and the orbital integral are
translated into Frobenius traces on some complexes of sheaves, one has to compare these
sheaves.
First let me review some combinatorial facts proved by Howard-Shnidman. Let d20 = d2 − N
and d0 = 2d − N. Consider the group:
0

Γd0 = {±1}d o Sd0

(6.1)

Let 1 be the trivial representation of the group Sd0 , and:
Γ 0

IndSd0 1 = {Φ : Sd0 \Γd0 −→ Ql }

(6.2)

d

0

0

Sd0 is embedded into Γd0 as the subgroup {1}d o Sd0 . For each x ∈ {±1}d , let Φ x be characteristic function of the coset x · Sd0 . When x runs through all of these tuples formed by 1 and −1,
one get a basis of the induced representation above. Let:
ei = (1, ..., 1, −1, 1, ..., 1) ∈ {±1}d

0

Γ 0

in which −1 appears at the i-th spot. Let H be the operator on IndSd0 1 defined by:
d

H · Φx =

d0

∑ Φ ei x

i =1
0

i.e. H is the element ∑id=1 ei ∈ Z[Γd0 ] acting on the induced representation.
Similarly, for a pair of numbers d1 , d20 such that d1 + d20 = d0 , define:
Γd1 = {±1}d1 o Sd1

0

Γd0 = {±1}d2 o Sd0

2

2

and characters:
ηd1 : {±1}d1 −→ {±1}

0

ηd2 : {±1}d2 −→ {±1}

Then one has the following proposition of Γd0 -module:
Proposition 6.1. There is a decomposition:
Γ 0

M

IndSd0 1 =
d

d1 ,d20 ≥0,d1 +d20 =d0

V(d1 ,d0 )

such that:
• Each V(d1 ,d0 ) is an irreducible representation of Γd0 ;
2
• H acts on V(d1 ,d0 ) by the scalar (d1 − d20 );
2
• V(d1 ,d0 ) is isomorphic V(d0 ,d1 ) ;
2

2

Γ 0

• V(d1 ,d0 ) is isomorphic to IndΓdd
2

×Γd0
1

2

(6.3)

2

Γ 0

(ηd1  1) and IndΓdd

1

×Γd0

2

(1  ηd1 ).

Now we can state the basic fact about sheaves comparison. Recall one has the following
diagram:

Hd

(6.4)

γ0

Md

γ1

}

!

fd

!

Ad

}

Md

fd

Proposition 6.2. Assume d ≥ 2g3 − 1 + N. One has the following isomorphism:
∼

→
R f d,! Ql −

M
d1 ≥0,d2 ≥ N,d1 +d2 =2d

Rg(d1 ,d2 ),! L(d1 ,d2 )

(6.5)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

39

in the category Dcb (Ad , Ql ). Each summand on the right is stable under the Hecke correspondence Hd , which acts on Rg(d1 ,d2 ),! L(d1 ,d2 ) by d1 − d2 + N.
The prove is the same as Yun-Zhang and Howard-Shnidman. The idea is first compare them
◦ ⊂ Ŷ 0 be the open dense subscheme classifying divisors
on an open dense part of Ad . Let Ŷ3,d
0
3,d
0
on Y3 of degree d without multiplicity. Similarly define Ŷd◦0 ⊂ Ŷd0 . Then one has the everywhere
unramified finite cover of schemes:
Nm : Ŷd0 −→ Ŷ3,d0

(6.6)

with deck transformation group Γd0 . Then Nm∗ Ql is the local system determined by the repreΓ 0

sentation IndSd0 1. Using the decomposition (6.1), one gets:
d

∼

Nm∗ Ql −
→

M
d1 ,d20 ≥0,d1 +d20 =d0

V(d1 ,d0 )
2

(6.7)

Here right hand side means the local systems determined by the representations V(d1 ,d0 ) . Define
2
A◦d to be the open dense part of Ad such that ÷ξ − D30 is multiplicity free, i.e.:

A◦d

/ Ad


◦
Ŷ3,d
0


/ Ŷ3,d0

(6.8)

By the proper base change theorem of étale cohomology, one has:
∼

R f d,! Ql |A◦d −
→ Nm! Ql |A◦d
∼

→ V(d1 ,d2 ) |A◦d
Rg(d1 ,d2 ),! L(d1 ,d2 ) |A◦d −

(6.9)
(6.10)

Now by the finiteness of of f d and gd , one knows that R f d,! Ql [d0 − g + 1] is the middle extension of R f d,! Ql [d0 − g + 1]|A◦d and Rg(d1 ,d2 ),! L(d1 ,d2 ) [d0 − g + 1] is the middle extension of
Rg(d1 ,d2 ),! L(d1 ,d2 ) [d0 − g + 1]|A◦d . Therefore the isomorphism above extends to the entire Ad .
For the Hecke correspondence part, it is easy to check combinatorially that when restricted to
◦
Ad , the action [Hd ] on V(d1 ,d0 ) |Ad coincide with H in (6.1), hence a scalar d1 − d20 = d1 − d2 + N.
2
Again by the theory of middle extension, this extends to all the Rg(d1 ,d2 ),! L(d1 ,d2 ) over the entire
Ad .
6.2. Comparison of the intersection number and the orbital integral. First let’s review some
theorems about the Hecke algebra H Σ in Yun-Zhang.
fΣ as the image of the following map:
Define H
l
HGΣ ⊗ Ql −→ EndQl (V ) × EndQl (A(K ) ⊗ Ql ) × Ql [ Pic X (k )]ι P ic
It is a finitely generated algebra over Ql . Then they proved:
Proposition 6.3. Let H Σ,† ⊂ HGΣ . be the linear span of h D for effective divisors D of degree greater
then a fixed positive number, say M. Then the map:
H

Σ,†

⊗ Ql −→ HGΣ ⊗ Ql −→ Hfl Σ

is surjective.
This lead to:
Proposition 6.4. For any f ∈ HGΣ , one has:
Iµ ( f ) = (logq)−r Jr ( f )
First one check the equation for f = h D for degD ≥ 2g3 − 1 + N. The left hand side:

∑

ξ ∈A D (k )

Tr( f d,! [Hd ] ◦ Frξ , (R f d,! Ql )ξ )
µ

(6.11)

40

HAO LI

∼

From the last part, we have seen R f d,! Ql −
→
one can rewrite the above formula as:

∑

∑

L

d1 ≥0,d2 ≥ N,d1 +d2 =2d Rg(d1 ,d2 ),! L(d1 ,d2 ) .
µ

ξ ∈A D (k ) d1 ≥0,d2 ≥ N,d1 +d2 =2d

Tr( f d,! [Hd ] ◦ Frξ , (Rg(d1 ,d2 ),! L(d1 ,d2 ) )ξ )

Therefore
(6.12)

µ

Since Hd acts on Rg(d1 ,d2 ),! L(d1 ,d2 ) by the scalar, one has:

∑

∑

ξ ∈A D (k ) d1 ≥0,d2 ≥ N,d1 +d2 =2d

(d1 − d2 + N )r Tr( Frξ , (Rg(d1 ,d2 ),! L(d1 ,d2 ) )ξ )

The right hand side:

∑

∑

ξ ∈A D (k ) (d1 +d2 =2d,d1 ≥0,d2 ≥ N )

q(d1 −d2 + N )·s Tr( Frξ , (Rg! L(d1 ,d2 ) )ξ )

Taking the rth derivative and evaluate it at s = 0, one gets:

∑

∑

ξ ∈A D (k ) (d1 +d2 =2d,d1 ≥0,d2 ≥ N )

(d1 − d2 + N )r Tr( Frξ , (Rg! L(d1 ,d2 ) )ξ )

It is the same as the left hand side.
Now for any f ∈ HGΣ , Yun and Zhang proved that Iµ ( f ) and (logq)−r Jr ( f ) only depend on
fΣ . From the last proposition, one can get the conclusion.
f ’s image in H
l
6.3. Final conclusion. A larger part of Yun-Zhang’s papers was devoted to proving a “coarse”
spectral expansion of the cohomology of the moduli of shtukas (integral model, not just the
generic fiber). I’m going to restate it and use it.
fΣ and V (ξ ) be Hcr (Shtµ (Σ; ξ ) for a ξ : S∞ −→ S
e ∞ . They proved the followLet Y = SpecH
G
l
ing:
(1) There is a decomposition of the scheme Y red :

Theorem 6.5.

Y red = ZEis,Ql ä Y0
where Y0 is a finite set of closed points. Also there is a corresponding decomposition:
fΣ = H
fΣ × H
fΣ
H
l
l,Eis
l,0
fΣ = Y0 .
fΣ = ZEis,Q and SpecH
such that SpecH
l,0
l,Eis
l
(2) There is a unique decomposition:
V (ξ ) = V0 (ξ ) ⊕ VEis (ξ )
such that SuppVEis (ξ ) ⊂ Zl,Eis and SuppV0 (ξ ) ⊂ Y0 . V0 is of finite dimension over Ql .
(3) Base change the scheme and the module over it to Ql . Then the above decomposition of module
becomes:
V (ξ ) ⊗ Ql = VEis (ξ ) ⊗ Ql ⊕ (⊕m∈Y0 (Q ) Vm (ξ ))
l

fΣ .
where Vm (ξ ) is the eigenspace of the character m of H
l
µ

µ

µ

Let Zi be the image cohomology class in V (ξ ) of Zi (ξ ) for i = 1, 2. Further let Zi,m to be the
µ
fΣ as (0, h) in H
fΣ . By the self-adjointness of the H Σ
projection of Z to Vm (ξ ). Identify h ∈ H
l,0

i

G

l

action with respect to the cup product, one has:
Iµ ( h ) =

∑

m∈Y0 (Ql )

µ

µ

( Z1,m , h ∗ Z2,m )

(6.13)

On the analytic side, looking at the spectral expansion side:
Jr ( h ) =

∑

π ∈ Π Σ (Ql )

λπ (h)(

d r
) |s=0 (q Ns Jπ (hΣJ , s))
ds

(6.14)

where ΠΣ (Ql ) is the set of automorphic representations of level G (OΣ ) × ∏ x∈Σ Iwx . This set
can be viewed as a subset of Y0 (Ql ): For any π, take its G (OΣ ) × ∏ x∈Σ Iwx fixed line, then
fΣ ⊗ Ql −→ Ql .
fΣ ⊗ Ql acts on this fixed line by the character λπ : H
H
l,0
l,0

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

41

Now take the test function to be the idempotent eπ corresponding to the point π ∈ Y0 (Qi ),
then one has:
Iµ (eπ ) = ( Z1,π , Z2,π )
µ

Jr ( e π ) = (

µ

d r
) |s=0 (q Ns Jπ ( f , s))
ds

Applying (6.11), one gets:

( Z1,π , Z2,π ) = (logq)−r (
µ

µ

d r
) |s=0 (q Ns Jπ ( f , s))
ds

In conclusion:
µ

µ

µ

µ

Theorem 6.6. Let Z1 and Z2 be the Heegner-Drinfeld cycles attached to Y1 , Y2 and µ and Z1 , Z2 be
their cohomology class in Hcr (ShtrG (Σ)0 ). Then one has:

( Z1,π , Z2,π ) = (logq)−r (
µ

µ

P0 (φ, s)P3,η (φ3 )
d r
) |s=0 (q Ns
)
ds
hφ, φi

6.4. Some more conlusions. In the Yun-Zhang case, the analytic side is just the base change
L-function times some additional terms related to the genus of the base curve and the level Σ.
Here the period integral is not an L-function of any standard form. It is just a period integral.
However, using the classical result due to Waldspurger (the function field version was proved
by Chuang and Wei, look at their paper [1]), we still have the following:
Theorem 6.7. Let π be antomorphic representation who has spherical level away from Σ and is a nonramified twist of Steinberg at each point in Σ. In the notations as above, one has:
µ

µ

( Z1,π , Z1,π ) = 0
is equivalent to:
L (r) (π, 1/2) · L(π ⊗ χ1 , 1/2) · L(π ⊗ χ2 , 1/2) = 0
in which L (π, s + 1/2) = q(2g−2+ N )s · L(π, s + 1/2)
To see this, first, according to Yun-Zhang’s papers, one has:
P0 (φ, s) = q(2g−2)s · L(π, s + 1/2)
For φ a G (OΣ ) × ∏ x∈Σ Iwx fixed vector in π.
The other part, P3,η (φ3 ), one consider the T3 (A) × T3 (A)-invariant linear functional:
P3π : π × π −→ C
φ1 ⊗ φ2 7−→ P3 (φ1 , η )P3 (φ2 , η )
One has the local T3 ( Fx ) × T3 ( Fx )-bilinear form:
α x (φ1 ⊗ φ2 ) =

L(χ3,x , 1) L(π x , ad, 1)
ζ Fx (2) L(π x , ηx , 1/2)

Z
×
K3,x
/Fx×

(π x (t)φ1 , φ2 ) x ηx (t)dt

and the global-local relation:
P3π =

ζ F (2) L(π, η, 1/2)
8L(χ3 , 1)2 L(π, ad, 1)

∏

αx

x ∈| X |

Now take φ as above, and its corresponding form φ3 on G (A3 ) is a G3 (OΣ ) × ∏ xΣ Iwwx fixed
vector. One has T3 (Ox ) ⊂ G3 (Ox ) for x < Σ and T3 (Ox ) ⊂ Iwwx . Therefore one can apply the
proposition by Gross-Prasad[3] to conclude that:

∏

α x ( φx ⊗ φ x ) , 0

x ∈| X |

ζ F (2)
is a nonvansihing constant, whether P3π (φ ⊗ φ) vanishes or
8L(χ3 , 1)2 L(π, ad, 1)
not depends on whether L(π, η, 1/2) vanishes or not, but because one has:

Since the term

L(π, η, s) = L(π ⊗ χ1 , s) · L(π ⊗ χ2 , s)

42

HAO LI

Therefore P3 (φ3 ) = 0 is equivalent to L(π ⊗ χ1 , s) · L(π ⊗ χ2 , s) = 0. 
µ
µ
Howard and Shnidman also computed the intersection number of the entire Z1 and Z2 by
computing the orbital integral side. Here one can apply their method directly to get a similar
but slightly different result:
Theorem 6.8. No matter how many points of modification you have i.e. for any r ≥ 0, you’ll always
get:
µ
µ
( Z1 , Z2 ) = 0
Take the test function f to be the characteristic function of G0 (A), one gets:
d r
) |s=0 (q Ns J( f JΣ , s))
ds
The point is that J( f JΣ , s)) is always 0. To get this, let me first cite a lemma proved by Howard
and Shnidman:

( Z1 , Z2 ) = (logq)−r (
µ

µ

Lemma 6.9. Fix γ ∈ J ( F ), let a ∈ K3 be its invariant. If there exist t0 ∈ T0 (A) and t3 ∈ T3 (A) such
that f JΣ (t0−1 γt3 ) , 0, then a ∈ k and 2a = 1.
Notice that in their paper f is the characteristic function of the image of e
J (O) in J (A), but
here one changes the local components at Σ to 1 Iw J,x , but the hypothesis in the lemma still forces
the existence of φ ∈ e
J (A) lifting t0−1 γt3 and send O3 to O ⊕ O. This is because to be in Iw J,x is
more restrictive than to be in Iso (OK3 ,x , Ox ⊕ Ox ). Therefore all of their arguments still apply
here.
Now the orbital integral simplies to just one term J(γ, f JΣ , s), and from their lemma, one can
even write down the element γ: First take an element of K3 : e such that K3 = F (e) and e
satisfies an equation of the form x2 − a = 0 for a ∈ F. Then as an F-vector space, K3 = F + Fe,
and there is an F-linear isomorphism: K3 −→ F ⊕ F : x + ye 7−→ ( x, y). Then this φ is a
representative of γ with invariant 1/2: base change it K3 , one gets:
K3 ⊕ K3 −→ K3 ⊕ K3
a+b a−b
,
)
2
2e
−1 −1
1
Then invairant, as we have seen, is given by:
/
= .
4e 2e
2
Factorize the test function and the character η: f JΣ = ∏ x∈| X −Σ| f x ⊗ ∏ x∈Σ 1 Iwwx and η =
∏ x∈| X | ηx . The points away from Σ is exactly the same as in Howard-Shnidman’s paper. So one
only has to care about x ∈ Σ. According to our set up, any x ∈ Σ splits in K3 . As they pointed
out, here one can choose c ∈ Fx such that (cex )2 = 1, and define the idempodents:
1 + cex
1 − cex
e=
, f =
2
2
These two idempotents actually split K3,x into K3,wx ⊕ K3,w0x , though one doesn’t know the order
the two over points. The integral over T3 ( Fx ) is just summing over the set of lattices:

( a, b) 7−→ (

×
Fx× \K3,x
/OK×3 ,x = {e + v l f : l ∈ Z}

Moding out OK×3 ,x is because OK×3 ,x is contained in Iww0x or Iwwx . Similarly, the integration over
×
the split torus T0 ( Fx ) is just summing over Fx× \ Fx × Fx /O×
F,x × O F,x .
For 1 Iwx ((1, v −k ) · γ · (e + v l f )) to be not 0, one must first have φ(OK×3 ,x · (e + v l f ) = (O×
F,x ×

−k
×
k
O×
F,x ) · (1, v ) up to rescaling by Fx . From Howard-Shnidman, this is equal to saying: | v | =
|c| and l = 0. This is because of the following: by the definition of φ, one has:

1 c
1
c
e 7−→ ( , ) v l f 7−→ ( v l , − v l )
2 2
2
2
they should span the same lattice as (1, v k ) up to some rescaling by Fx× . So there exists a matrix:


a11 a12
∈ GL2 (Ox )
a21 a22

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

43

and a power of the uniformizer v α , such that:
1 α l
v v = a12
2
c α
c
v = a21 v k − v α v l = a22 v k
2
2
Since the matrix is in GL2 (Ox ), we must have the following: If ord x ( a12 a21 ) > 0, then one
must have ord x ( a11 ) = ord x ( a22 ) = 0. Then from the first equation above, one gets α = 0.
Then from the last equation, one gets ord x (c) = k − l, plugging in the third equation, one
gets ord x ( a21 ) = −l ≥ 0. From the second equation, one gets ord x ( a12 ) = l ≥ 0. These two
inequalities forces l = 0. This in turn tells us ord x (c) = k. Their claim is correct;
If ord x ( a11 a22 ) > 0, then ord x ( a12 ) = ord x ( a21 ), one plays a similar game: By the second
equation, one gets α = −l. Then plug it into the third equation, one sees ord x (c) = k + l.
Now by the last equation one gets ord x ( a22 ) = l ≥ 0 and from the first equation one gets
ord x ( a11 ) = −l. Again, both l and −l should be non-negative, therefore l = 0 and ord x (c) = k.
In case all four coefficients has valuation 0, either of the two arguments above works. This is
the proof of their claim.
In their case this is enough, but now there is one more condition, i.e. φ should send the
sublattice OK3 ,x · (e + v l +1 ) or OK3 ,x · (e + v l −1 ) to OF,x · (1, v k+1 ), up to rescaling by v α . The
same argument as above shows that one must have l = 1 or l = −1 and ord x (c) = k + 1, this
contradicts what we got above. This implies that for all t0 and t3 , 1 Iww0 (t0−1 γt3 ) = 0. The local
x
factors at the level are all 0, therefore the global integrand is always 0, the integral just vanish.

1 α
v = a11
2

R EFERENCES
[1] Chih-Yun Chuang and Fu-Tsun Wei. Waldspurger formula over function fields. Trans. Amer. Math. Soc., 371(1):173–
198, 2019.
[2] B. Gross, W. Kohnen, and D. Zagier. Heegner points and derivatives of L-series. II. Math. Ann., 278(1-4):497–562,
1987.
[3] Benedict H. Gross and Dipendra Prasad. Test vectors for linear forms. Math. Ann., 291(2):343–355, 1991.
[4] Benjamin Howard and Ari Shnidman. A Gross-Kohnen-Zagier formula for Heegner-Drinfeld cycles. arXiv e-prints,
page arXiv:1707.00213, Jul 2017.
[5] Zhiwei Yun. Hitchin type moduli stacks in automorphic representation theory. arXiv e-prints, page arXiv:1809.01811,
Sep 2018.
[6] Zhiwei Yun and Wei Zhang. Shtukas and the Taylor expansion of L-functions. Ann. of Math. (2), 186(3):767–911,
2017.
[7] Zhiwei Yun and Wei Zhang. Shtukas and the Taylor expansion of L-functions (II). Ann. of Math. (2), 189(2):393–526,
2019.

