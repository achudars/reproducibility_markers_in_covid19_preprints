bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Ultrafast Readout of Representations from Spatially Distributed
Rodent Hippocampal Field Potentials
Liang Cao1,2, Viktor Varga1, and Zhe S. Chen1,4,*
1

The Neuroscience Institute, New York University School of Medicine, New York, NY 10016, USA.

2

Department of Physics, East China Normal University, Shanghai, China.

3

Center for Neural Science, New York University, New York, NY 10016, USA.

4

Department of Psychiatry, Department of Neuroscience and Physiology, New York University School of

Medicine, New York, NY 10016, USA.
* Correspondence: zhe.chen@nyulangone.org (Z.S.C.)

SUMMARY
Demodulated oscillatory activity at theta frequency band extracted from spatially distributed
hippocampal local field potentials (LFPs) encode rodent’s position during maze run. However, it
remains unclear how spatial information is encoded in hippocampal field potentials across various
immobility and sleep states. Here, we showed that unclustered hippocampal field potential
amplitude at ultra-high frequency band (>300 Hz), or known as multiunit activity (MUA), across highdensity silicon probe channels provide not only a fast and reliable reconstruction of the rodent’s
position in wake, but also a direct readout of replay content during sharp wave ripples (SPW-Rs) in
immobility and slow wave sleep. We also employed unsupervised learning approaches to extract
low-dimensional MUA features during run and ripple periods, and developed Bayesian methods to
infer latent dynamical structures from lower-rank MUA features that were coherent with those
derived from clustered spikes. Furthermore, we used an optical flow estimation method to identify
propagating spatiotemporal LFP patterns, and derived a set of hippocampal LFP spatiotemporal
features for decoding applications. Finally, we developed hybrid forward decoding strategies to
predict animal’s future decision at a choice point in goal-directed navigation. Our results point to a
robust real-time decoding strategy from large-scale (up to 100,000 electrodes) recordings for
closed-loop neuroscience experiments.

1

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

INTRODUCTION
Cutting-edge large-scale high-density electrode arrays have enabled us to record spatially
distributed neural activity within local or multiple brain circuits (Berenyi et al., 2014; Jun et al. 2017;
Chung et al., 2019), yet it remains challenging to reliably uncover representations of
spatiotemporal neural activity. The hippocampus contributes to a wide range of brain functions
responsible for spatial and episodic memories, learning and planning (Pfeiffer and Foster, 2013).
Population spike activities from hippocampal place cell assemblies provide a readout of the rat’s
spatial location (Zhang et al., 1998; Davidson et al. 2009; Kloosterman et al. 2014; Grosmark and
Buzsaki, 2016; Hu et al. 2018; Ciliberti et al. 2018). However, direct use of spike information for
neural decoding remains challenging due to practical issues of spike sorting and unit instability,
let alone the prohibitive computational cost in the era of big data (Rey et al., 2015; Rossant et al.,
2016; Carlson and Carin, 2019). In contrast, hippocampal field potentials consist of collective local
subthreshold activities around the recording site, serving as an alternative information carrier for
spatial representation (Buzsaki et al. 2012; Agarwal et al. 2014). On the other hand, advances in
neurotechnology on electrode arrays have enabled us to record large-scale field potentials from
human brain (Khodagholy et al., 2015; Chang, 2015; Zhang and Jacobs, 2015). Developing
effective statistical methods for uncovering neural representations of these signals during memory
tasks or sleep remains a central goal in computational neuroscience.
Hippocampal sharp-wave ripples (SPW-Rs) are important hallmarks for memory
reactivations during immobility and non-rapid-eye-movement (NREM) sleep (Roumis and Frank,
2015; Buzsaki, 2015; Fernandez-Ruiz et al. 2015). Decoding the content of hippocampal replays
during ripple events can help dissect circuit mechanisms of memory consolidation, planning and
decision-making (Davidson et al., 2009; Pfeiffer and Foster, 2013; Foster, 2017; Olafsdottir et al.,
2018). Evidence has suggested that hippocampal LFPs may encode neuronal ensemble
activations during SPW-Rs (Taxidis et al. 2015), but it remains unknown how the information
embedded in field potentials contribute to spatial representations, and how these spatially
distributed LFP representations relate to ensemble spike representations at different brain states.
To address these questions and challenges, here we systematically investigate large-scale
multi-site recorded rodent hippocampal field potentials and the spatial representation power
during maze running, memory replay decoding, and spatial decision-making. We propose and
develop a set of independent and complementary hippocampal field potential-derived features,
and develop innovative supervised or unsupervised learning methods while validating them in
various applications. Without the need of spike sorting, these spatiotemporal features not only
provide direct and robust solutions to decoding and prediction problems, but also open new
opportunities for exploratory neural data visualization or finding latent structures in the absence
of behavioral measure.

RESULTS
Spatially Distributed Hippocampal Field Potentials Encode Position in Maze Run

2

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Rats and mice were implanted with high-density silicon probes (varying from 64 to 512 channels;
see Table S1) in the dorsal hippocampus or hippocampi while freely foraging in a circular track,
linear track, T-maze or open field environment (Figure S1A). We processed the extracellular raw
voltage traces of hippocampal recordings and extracted independent neural signals at different
frequency bands (Figure 1A). During run epochs, we found that both demodulated theta (4-12
Hz) activity—or in short LFPq (amplitude or phase or both, Agarwal et al. 2014) and the
instantaneous LFP amplitude at ultra-high frequency (>300 Hz) band---also referred to as MUA
(Stark and Abeles, 2007; Bansal et al., 2012 Smith et al., 2013), recorded from multiple recording
sites could be used to reliably decode animal’s position (Figures 1B,C and S1B). Augmenting
multiple LFP-based features, such as combining LFPq or MUA with their own activity history
(Figure 1C) or combining MUA with LFPq (Figure S1B), further improved the decoding accuracy.
We systematically assessed the decoding performance using instantaneous LFP amplitude
features at various frequency bands and temporal bin sizes and found that >300 Hz band was
most effective. In temporal windows of <300 ms the various LFP and spike features and their
combinations were comparable, whereas at longer time intervals coding errors increased more
rapidly from LFPq than for spike-containing combinations (Figure S2).
Spatial coverage of the hippocampal place fields are crucial to the decoding accuracy in a
larger environment. In the open field, we found that 64-channel joint LFP-based features yielded
better decoding accuracy than clustered spike-based decoding (Dataset 5; mean±SD median
error: 10.81±0.25 cm for spikes and 8.85±0.21 cm for LFPs; rank-sum test, P=1.95´10-21; Figures
1D and 1E; see also Movie S1), possibly because decoding 2D environments requires a large
number of isolated units (Wilson and McNaughton, 1983).
It is noted that the >300 Hz LFP signal also contains spike activity (Zano et al. 2011; Buzsaki
et al., 2012; Waldert et al. 2013). To remove the contamination of spike activity, we decomposed
the broadband LFP signal into non-spiking (by removing detected spikes) and ‘soft’ spiking
components (by retaining only detected spikes; Figure 1F). Following down-sampling (1,250 Hz)
and high-pass filtering (>300 Hz) operations (Figure 1G), and repeating decoding analyses
showed that MUA features produced the best decoding accuracy (Figure 1H), suggesting that
the position decoding contribution of >300 Hz amplitude was mainly derived from the clustered
spiking-related activity, although decoding the animal’s position does not require a preprocessed
clustering step.
Since spiking activity is derived mainly from the somatic layer, we further examined the
impact of anatomical location of recording electrodes on decoding performance (Figure S3;
Dataset 3). As expected, recording sites in the CA1 and CA3 pyramidal layers contributed most
to overall MUA decoding accuracy. Interestingly, because these two layers are known to have
higher cell density.
High-Frequency Band Hippocampal MUA Features Decode Replay Events
During immobility and NREM sleep, putative hippocampal memory replay events occur during
SPW-Rs, where population firing bursts coincide with a high ripple band amplitude (Figure 2A).
A central task of statistical analysis is to identify the content of these replay contents and assess
3

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

their significance in the absence of behavioral ground truth. Remarkably, we found that these
unclustered, spatially distributed MUA features also encoded the replay content during ripple
events (Figure 2B). Remarkably, the linear decoder estimated from maze run (based on sparse
Bayesian linear regression; Methods) could be directly transferred to ripple periods, with similar
reconstruction of memory replays as the results derived from clustered spikes (Figures 2C and
S4A). In addition, MUA and clustered spike-based decoding strategies produced slightly different
statistics for significant memory replay events (Figures 2D and S4B), suggesting that these two
decoding strategies are complementary.
Unsupervised Learning Reveals Consistent Representations between Low-Rank
Structures of Hippocampal MUA with Spikes of Neuronal Ensembles
Establishing a mapping between animal’s position and neural activity requires training samples
during maze run. However, from an internal brain observer perspective, it is important for
downstream structures of the hippocampus to quickly infer spatial representations without direct
behavioral measures. We employed two latent variable models and unsupervised learning
methods, nonnegative matrix factorization (NMF) and reconstruction independent component
analysis (RICA), to extract lower-rank features from multi-site recorded hippocampal MUA
(Methods; Figures 3A and 3B). Position-averaging on the feature matrix derived from NMF or
RICA revealed localized structures in the latent state space. From the lower-rank MUA features
(derived from NMF or RICA, followed by feature resampling; see Methods and Figure S5), we
further trained an unsupervised Bayesian hidden Markov model (HMM) (Linderman et al., 2016)
and inferred the latent state trajectories (Figure 3C). During run, the lower-rank MUA-inferred
state trajectories matched well with the animal’s position as well as spike-inferred state
trajectories (Figure 3D). During ripples, we also observed similar correspondence between two
latent state trajectories derived independently from lower-rank MUA features and clustered spikes
(Figure 3E). In both maze run and ripple events, the preprocessed lower-rank feature extraction
was critical for learning the latent state trajectories; direct use of LFP or MUA features alone yield
poor performance.
Furthermore, projecting high-dimensional MUA features onto a 2D embedding space
revealed coherent structures in agreement with the animal’s position or spatial topology of the
environment (Figure S6). Together, these results confirmed that unsupervised learning methods
can uncover neural representations of large-scale hippocampal LFP signals without a priori
measurement of animal’s behavior, which has been a challenge for inferring memory replays of
hippocampal nonspatial representations or hippocampal-neocortical representations during sleep
(Allen et al., 2016; Chen et al. 2016; Chen and Wilson, 2017; Maboudi et al., 2018).
Independent, Parallel and Complementary Hippocampal LFP Spatiotemporal Patterns for
Spatial Representation
Propagating waves in the rat hippocampus have been reported at the theta and ripple frequency
bands (Lubenov and Siapas, 2009; Patel et al. 2012, 2013; Agawal et al., 2014). Next, we
investigated how these spatiotemporal patterns across multi-site LFP channels were coordinated
4

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

in space and time. We mapped the bandpass-filtered LFP signals (at 4-12 Hz or >300 Hz band)
onto the 2D electrode space in time to obtain a video sequence (frame rate: 10 Hz), and then
employed an optical flow estimation approach to compute the vector field between two
consecutive image frames (Methods; Figure 4A). The spatiotemporally local optical flow revealed
position-tuned wave patterns in the MUA or other LFP-derived features. Therefore, the optical
flow method can help reveal the intrinsic propagating wave characteristic of band-limited signals
(beyond theta and ultra-high frequency bands).
In addition to exploratory data visualization, we further investigated whether the highdimensional optical flow features were useful for decoding. Remarkably, these spatiotemporal
patterns estimated directly from bandpass-filtered LFP signals provided sufficient information for
reconstructing animal’s position (LFPq-flow in Figure 4B; see also Figure S7 and Movie S2). In
fact, we discovered that a set of field potential-derived spatiotemporal patterns (Figure 4C)
contained complementary information for position decoding (Figure 4D for Dataset 3; Figure S7C
for Dataset 1). The variability in contributions of individual LFP features in different datasets might
be ascribed to spatial sampling or different layout in the implanted probes (Figure S1C). Together,
these hippocampal LFP spatiotemporal features or their combinations provide a rich repertoire
for position decoding across brain states (Table 1).
Hybrid Decoding Strategy for Predicting Goal-Directed Navigation Behavior
Hippocampal place cells exhibit trajectory-dependent or prospective/retrospective memory coding
in spatial navigation (Frank et al., 2000; Ferbinteanu and Shapiro, 2003; Ji and Wilson, 2008).
Here we investigated if a prospective decoding strategy based on hippocampal LFP features
could predict animal’s decision in a spatial alternating task (Dataset 6). We adapted the standard
decoding strategy and attempted to predict animal’s prospective L/R arm position while the animal
ran in the central arm towards the choice point, with forward time lag ranging from 0.5 s to 0.15 s
(5-15 temporal bins; Figure 5A). Remarkably, both hippocampal spikes and joint (LFPq+MUA)
features (Figures 5B and S8) carried predictive representations of upcoming maze locations in
the L/R arm. We found that the prediction accuracy in prospective coding improved as animals
moved closer to the choice point, where the predictability was far beyond the chance level (see
shuffled statistics in Figure S8). In two tested animals, the joint features achieved a high (~90%)
prediction accuracy in correct trials (n=4 sessions for each mouse; see Figure S8 for incorrect
trials).
In another independent test, we further trained a linear support vector machine (SVM)
classifier to predict the L/R decision (for correct trials only) by pooling LFPq and MUA features at
consecutive 5 temporal bins prior to the choice point (Methods and Figure 5C). The crossvalidation classification accuracy and trend was also comparable to Figure 5B in two tested
animals (correct trials: 72-98% for spikes, 62-95% for joint (LFPq+MUA) features; incorrect trials:
62-92% for spikes, 56-85% for joint features). The gradual decay in classification accuracy away
from the choice point was partially due to the increased trial variability in the animal’s actual
position because of the variability in run speed. Notably, the degraded accuracy trend remained

5

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

consistent between forward and backward direction, when triggering temporal bins from either the
end (‘backward’) or start (‘forward’) position of the central arm (Figure S9).
Real-Time Decoding Strategy for Large-Scale Hippocampal Recordings
Our results directly point to an efficient hippocampal MUA or LFPq-based decoding strategy with
two key advantages: easy circuit implementation (linear mapping), as well as the stability and
longevity of LFP signals (in contrast to unreliable spike detection and sorting of unstable units).
First, we validated the robustness of MUA or LFPq-based decoding strategy. In multiple
consecutive recording sessions (separated by days in between) from the same animal and the
same environment (Dataset 6), we trained the linear decoder using one run session and tested it
on remaining run sessions. Remarkably, the MUA and LFPq decoding strategies produced
outstanding performance across several consecutive run sessions/days (Figure 6A).
Furthermore, we assessed the average cross-session decoding performance when training and
testing sessions were separated by different intervals, and found a V-shaped performance drop
with increasing time intervals (Figure 6B). When the intervals between training and testing
session was short, MUA features produced better decoding performance; yet the performance of
LFPq features decayed slower. While MUA and LFPq features were complementary, combining
them further improved the decoding accuracy. The slowly degraded decoding accuracy in these
features across days might be induced by neuroplasticity and place cell remapping (Frank et al.,
2004).
Furthermore, we ran computer simulations to test the scalability of hippocampal MUA
decoding algorithm. Running an optimized C/C++ code on a multi-core desktop computer, the
readout could accommodate a real-time speed at a scale up to hundreds of thousands of
(>100,000) recording channels during both wake and sleep (Figure 6C). Next, it is important to
assess the statistical significance of online decoded replay events. We adapted a real-time spikebased replay assessment strategy (Hu et al., 2018) to accommodate MUA decoding (Methods).
By presetting the pseudorandom shuffle operations (n=2,000 shuffles), we could accommodate a
real-time speed (<20 ms) for both decoding and significance assessment for 128 channels in a
1D environment (Figure 6D), with comparable results derived from off-line significance
assessment (Table S3).

DISCUSSION
Rodent hippocampal clustered spikes and spatially distributed theta waves are known to encode
animal’s position. Here, we further demonstrated that unclustered hippocampal spatiotemporal
patterns at different frequency bands contain rich spatial representations in wake and sleep.
Based on high-density electrophysical recordings of the rodent hippocampus, we proposed a set
of spatiotemporal features of hippocampal field potentials and developed efficient statistical
decoding methods for ultrafast readout of spatial representations. The decoding performance
derived from each feature depends heavily on the layout of the silicon probe and the implanted
location of hippocampus layer.
6

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

The instantaneous readout of multi-site hippocampal field potentials provides a plausible
mechanism of information integration along the septotemporal axis of the hippocampus, forming
the traveling waves (Lubenov and Siapas, 2009; Patel et al. 2012, 2013). Such traveling waves
can also propagate the coded information to the downstream structures of the hippocampus. Our
results on MUA decoding were also consistent with our previous finding that unsorted
hippocampal ensemble spikes can reliably encode rodent’s position (Kloosterman et al. 2014;
Deng et al., 2015; Hu et al. 2018). We have also demonstrated that MUA decoding strategies are
robust and reliable to predict animal’s decision-making in goal-directed navigation. The most
computationally efficient MUA decoding strategy is particularly useful for content-based real-time
closed-loop circuit manipulation in rodents with chronic implant, which may prove critical for
causal circuit dissection of hippocampal-prefrontal coordination in decision-making (Singer et al.,
2013; Schmidt et al., 2019). Efficient sampling, processing and transmission of band-limited
signals make it ideal for wireless-empowered implanted devices.
A central task in computational neuroscience is to link neural representations with animal’s
behavior or internal cognitive state. Therefore, development of unsupervised machine learning
methods is important for discovering intrinsic latent structures of high-dimensional spatiotemporal
neural data, especially in the absence of behavioral measures (Cunningham and Yu, 2014; Chen
et al., 2014; Linderman et al., 2016; Townsend and Gong, 2018; Chaudhuri et al., 2019). Since
high-density LFP recordings produce a high degree of input correlation between neighboring
channels, low-rank feature extraction or dimensionality reduction (e.g., ICA, NMF and embedding)
can help exploratory data visualization and subsequent decoding analysis.
Hippocampal spatiotemporal patterns often display in the form of traveling wave (Lubenov
and Siapas, 2009; Patel et al. 2012, 2013) or sequential structure (‘hippocampal sequences’) in
space and time during various behavioral states (Buzsaki and Tingley, 2018). In addition to ripple
sequences, hippocampal theta sequences have been known to encode look-ahead trajectories
or current goals in planning (Foster and Wilson, 2008; Gupta et al., 2012; Wikenheiser and Redish,
2015). Furthermore, internally-generated sequences may predict animal’s choices in a memory
task or guide navigation when external spatial cues are reduced (Pastakova et al., 2008; Wang
et al., 2015; Villette et al., 2015). To date, rodent hippocampal memory replays have been widely
studied in NREM sleep. During REM sleep, rodent hippocampal LFP theta oscillations are
pronounced, yet their spatiotemporal patterns are less well understood (Louie and Wilson, 2001).
Our LFP-based features and decoding methods proposed here may provide new opportunities to
investigate these REM sleep-associated spatiotemporal patterns.
Although we only investigated the rodent hippocampal circuit here, our ‘place’ decoding
analysis and methods can be readily applied to other neocortical areas that encode similar spatial
information, such as the entorhinal cortex, primary visual cortex, retrosplenial cortex, parietal
cortex and somatosensory cortex (Hafting et al., 2015; Whitlock et al., 2008; Mao et al., 2017; Ji
and Wilson, 2007; Haggerty and Ji, 2015; Hu et al., 2018; Long and Zhang, 2019). Examination
of the coordinated representations of large-scale hippocampal-neocortical spatiotemporal activity
during various behavioral states would help dissect the mechanisms of memory, learning,
planning and decision-making (Chung et al., 2019).
7

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Finally, the superior representational power of hippocampal field potentials points to
potential applications for investigating human memory replays based on high-density MEG or
EEG recordings (Kurth-Nileson et al. 2016; Liu et al., 2019; Huang et al. 2018), or for predicting
human hippocampal memory task outcomes based on ECoG recordings (Zhang and Jacobs,
2015).

STAR METHODS
Detailed methods are provided in the online version of this paper and include the following:
•

KEY RESOURCE TABLE

•

CONTACT FOR REAGENT AND RESOURCE SHARING

•

EXPERIMENTAL MODEL AND SUBJECT DETAILS

•

METHOD DETAILS
Data preprocessing and analysis
Multichannel LFP feature extraction
Decoding analysis
Real-time decoding

•

QUANTIFICATION AND STATISTICAL ANALYSIS
Statistical assessment of decoding
Region-specific assessment of decoding

•

DATA AND SOFTWARE AVAILABILITY

SUPPLEMENTAL INFORMATION
Supplemental information includes ten figures, three tables, and three movies.
AUTHOR CONTRIBUTIONS
Z.S.C. and L.C. conceived this research and designed the experiments; L.C. and Z.S.C. analyzed the data;
V.V. performed the mouse experiments; Z.S.C. wrote the paper; and all authors participated in the editing
and revisions of the manuscript.
ACKNOWLEDGMENTS
We thank G. Agarwal and I.H. Stevenson for valuable discussions. We also thank the valuable feedback
and support of G. Buzsaki and the Buzsaki lab members for sharing the experimental data. This work was
partially supported by the US National Science Foundation (NSF) grant CBET-1835000 (Z.C.), NIH grants
R01-NS100065 (Z.C.), R01-MH118928 (Z.C.), L.C. was supported by the China Scholar Council fellowship
(CSC201806140122).

8

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

REFERENCES
Agarwal, G., Stevenson, I.H., Berenyi, A., Mizuseki, K., Buzsaki, G. and Sommer, F.T. (2014). Spatially distributed local
fields in the hippocampus encode rat position. Science 344, 626-630.
Allen, T.A., Salz, D.M., McKenzie, S. and Fortin, N.J. (2016). Nonspatial sequence coding in CA1 neurons. J. Neurosci.
36, 1547-1563.
Bansal, A.K., Truccolo, W., Vargas-Irwin, C.E. and Donogue, J.P. (2012). Decoding 3D reach and grasp from hybrid
signals in motor and premotor cortices: spikes, multiunit activity, and local field potentials. J. Neurophysiol. 107, 13371355.
Berenyi, A. et al. (2014). Large-scale, high-density (up to 512 channels) recording of local circuits in behaving animals.
J. Neurophysiol. 111, 1132-1149.
Berry, M.W., Browne, M., Langville, A.N., Pauca, V.P. and Plemmons, R.J. (2007). Algorithms and applications for
approximate nonnegative matrix factorization. Computational Statistics and Data Analysis, 52, 155-173.
Bishop, C. (2006). Pattern Recognition and Machine Learning. Springer.
Brown, E.N. et al. (1998). A statistical paradigm for neural spike train decoding applied to position prediction from
ensemble firing patterns of rat hippocampal place cells. J. Neurosci. 18, 7411-7425.
Buzsaki, G., Anastassiou, C.A. and Koch, C. (2012). The origin of extracellular fields and currents---EEG, ECoG, LFP
and spikes. Nat. Rev. Neurosci. 13, 407-420.
Buzsaki, G. (2015). Hippocampal sharp wave-ripples: a cognitive biomarker for episodic memory and planning.
Hippocampus 25, 1073-1188.
Buzsaki, G. and Tingley, D. (2018). Space and time: the hippocampus as a sequence generator. Trends Cog. Sci. 22,
853-868.
Chang, E. (2015). Towards large-scale human-based mesoscale neurotechnologies. Neuron 86, 68-78.
Chaudhuri, R., Gercek, B., Pandey, B., Peyrache, A. and Fiete, I. (2019). The intrinsic attractor manifold and population
dynamics of a canonical cognitive circuit across waking and sleep. Nat. Neurosci. 22, 1512-1520.
Chen, Z., Gomperts, S.N., Yamamoto, J. and Wilson, M.A. (2014). Neural representation of spatial topology in the
rodent hippocampus. Neural Computat. 26, 1-39.
Chen, Z., Grosmark, A.D., Penagos, H. and Wilson, M.A. (2016). Uncovering representations of sleep-associated
hippocampal ensemble spike activity. Sci. Rep. 6, 32193.
Chen, Z. and Wilson M.A. (2017). Deciphering neural codes of memory during sleep. Trends. Neurosci. 40, 260-275.
Chung, J. E. et al. (2019). High-density, long-lasting, and multi-region electrophysiological recordings using polymer
electrode arrays. Neuron 101, 21-31.
Cichocki, A., Zdunek, R., Phan, A.H. and Amari, S-I. (2009). Nonnegative Matrix and Tensor Factorizations:
Applications to Exploratory Multi-Way Data Analysis and Blind Source Separation. Wiley.
Ciliberti, D., Michon, F. and Kloosterman, F. (2018). Real-time classification of experience-related ensemble spiking
patterns for closed-loop applications. eLife 7, e36275.

9

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Cunningham, J.P. and Yu, B.M. (2014). Dimensionality reduction for large-scale neural recordings. Nat. Neurosci. 17,
1500-1509.
Davidson, T.J., Kloosterman, F. and Wilson, M.A. (2009). Hippocampal replay of extended experience. Neuron, 63,
497-507.
Deng, X., Liu, D.F., Kay, K., Frank, L.M. and Eden, U.T. (2015). Clusterless decoding of position from multiunit activity
using a Marked point process filter. Neural Computat. 27, 1438-1460.
Drugowtisch,

J.

(2017).

Variational

Bayesian

inference

for

linear

and

logistic

regression.

https://arxiv.org/pdf/1310.5438.pdf.
Ferbinteanu, J. and Shapiro, M.L. (2003). Prospective and retrospective memory coding in the hippocampus. Neuron
40, 1227-1239.
Fernandez-Ruiz, A., Oliva, A., de Oliveira, E.F., Rocha-Almeida, F., Tingley, D. and Buzsaki, G. (2019). Long-duration
hippocampal sharp wave ripples improve memory. Science 364, 1082-1086.
Foster, D.J. (2017). Replay comes of age. Ann. Rev. Neurosci. 40, 581-602.
Foster, D.J. and Wilson, M.A. (2007). Hippocampal theta sequences. Hippocampus 17, 1093-1099.
Frank, L.M., Brown, E.N. and Wilson, M.A. (2000). Trajectory encoding in the hippocampus and entorhinal cortex.
Neuron 27, 169-178.
Frank, L.M., Stanley, G.B. and Brown, E.N. (2004). Hippocampal plasticity across multiple days of exposure to novel
environments. J. Neurosci. 24, 7681-7689.
Grosmark, A.D. and Buzsaki, G. (2016). Diversity in neural firing dynamics supports both rigid and learned hippocampal
sequences. Science 351, 1440-1443.
Gupta, A.S., van der Meer, M.A.A., D.S. Touretzky, D.S. and Redish, A.D. (2012). Segmentation of spatial experiences
by hippocampal theta sequences. Nat. Neuroci. 15, 1032-1039.
Hafting, T., Fyhn, M., Molden, S., Moser, M.-B., and Moser, E-I. (2005). Microstructure of a spatial map in the entorhinal
cortex. Nature 436, 801-806.
Haggerty, D.C. and Ji, D. (2015). Activities of visual cortical and hippocampal neurons co-fluctuate in freely moving rats
during spatial behavior. eLife 4, e08902.
Honey, C.J., Sporns, O., Crmmoun, L., Gigandet, X., Thiran, J.P., Meduli, R. and Hagmann, P. (2009). Predicting
human resting-state functional connectivity from structural connectivity. Proc. Natl. Acad. Sci. USA 106, 2035-2040.
Hu, S., Ciliberti, D., Grosmark, A.D., Michon, F., Ji, D., Penagos, H., Buzsaki, G., Wilson, M.A., Kloosterman, F. and
Chen, Z. (2018). Real-time readout of large-scale unsorted neural ensemble place codes. Cell Rep. 25, 2635-2642.
Huang, Q., Jia, J., Han, Q. and Luo, H. (2018). Fast-backward replay of sequentially memorized items in humans. eLife
7, e35164.
Hyvarien, A., Karhunen, J. and Oja, E. (2001). Independent Component Analysis. Wiley.
Ji, D. and Wilson, M.A. (2018). Firing rate dynamics in the hippocampus induced by trajectory learning. J. Neurosci. 28,
4679-4689.
Jun, J.J. et al. (2017). Fully integrated silicon probes for high-density recording of neural activity. Nature 551, 232-236.

10

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Khodagholy, D., Gelinas, J.N., Thesen, T., Doyle, W., Devinsky, O., Malliaras, G.G. and Buzsaki, G. (2015). NeuroGrid:
recording action potentials from the surface of the brain. Nat. Neurosci. 18, 310-315.
Kloosterman, F., Layton, S.P., Chen, Z. and Wilson, M.A. (2014). Bayesian decoding using unsorted spikes in the rat
hippocampus. J. Neurophysiol. 111, 217-227.
Kurth-Nelson, Z., Economides, M., Dolan, R.J. and Dayan, P. (2016). Fast sequences of non-spatial state
representations in humans. Neuron 91, 194-204.
Le, Q.V., Karpenko, A., Ngiam, J. and Ng, A.Y. (2011). ICA with reconstruction cost for efficient overcomplete feature
learning. Advances in Neural Information Processing Systems (NIPS), vol. 24, pp. 1017-1025. MIT Press.
Lee, D.D. and Seung, H.S. (1999). Learning the parts of objects by non-negative matrix factorization. Nature 401, 788791.
Linderman, S., Johnson, M.J., Wilson, M.A. and Chen, Z. (2016). A Bayesian nonparametric approach for uncovering
rat hippocampal population codes during spatial navigation. J. Neurosci. Methods 263, 36-47.
Liu, S., Grosmark, A.D. and Chen, Z. (2018). Methods for assessment of memory reactivation. Neural Computat. 30,
2175-2209.
Liu, Y., Dolan, R.J., Kurth-Nelson, Z. and Behrens, T.E.J. (2019). Human replay spontaneously reorganizes experience.
Cell 178, 640-652.
Long, X. and Zhang, S-J. (2019). A novel somatosensory spatial navigation system outside the hippocampal information.
https://www.biorxiv.org/content/10.1101/473090v1
Louie, K. and Wilson, M.A. (2001). Temporally structured replay of awake hippocampal ensemble activity during rapid
eye movement sleep. Neuron 29, 145-156.
Lubenov, E.V. and Siapas, A.G. (2009). Hippocampal theta oscillations are travelling waves. Nature 459, 534-539.
Maboudi, K., Ackermann, E., de Jong, L.W., Pfeiffer, B.E., Foster, D., Diba, K. and Kemere, C. (2018). Uncovering
temporal structure in hippocampal output patterns. eLife 7, e34467.
Mao, D., Kandler, S., McNaughton, B.L., and Bonin, V. (2017). Sparse orthogonal population representation of spatial
context in the retrosplenial cortex. Nat. Commu. 8, 243.
Olfsdottir, H.F., Bush, D. and Barry, C. (2018). The role of hippocampal replay in memory and planning. Curr. Biol. 28,
R37-R50.
Pastakova, E., Itskov, V., Amarasingham, A. and Buzsaki, G. (2008). Internally generated cell assembly sequences in
the rat hippocampus. Science 321, 1322-1327.
Patel, J., Fujisawa, S., Berenyi, A., Royer, S. and Buzsaki, G. (2012). Traveling theta waves along the entire
septotemporal axis of the hippocampus. Neuron 75, 410-417.
Patel, J., Schomburg, E.W., Berenyi, A., Fujisawa, S. and Buzsaki, G. (2013). Local generation and propagation of
ripples along the septotemporal axis of the hippocampus. J. Neurosci. 33, 17029-17041.
Pfeiffer, B.E. and Foster, D.J. (2013). Hippocampal place-cell sequences depict future paths to remembered goals.
Nature 497, 74-79.
Rey, H.G., Pedreira, C. and Quiroga, R.Q. (2015). Past, present and future of spike sorting techniques. Brain Res. Bull.
119, 106-117.
Rossant, C. et al. (2016). Spike sorting for large, dense electrode arrays. Nat. Neurosci. 19, 634-641.

11

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Roumis, D.K. and Frank, L.M. (2015). Hippocampal sharp-wave ripples in waking and sleeping states. Curr. Opin.
Neurobiol. 35, 6-12.
Schmidt, B., Duin, A.A. and Redish, A. (2019). Disrupting the medial prefrontal cortex alters hippocampal sequences
during deliberative decision making. J. Neurophysiol. 121, 1981-2000.
Smith, E., Kellis, S., House, P. and Greger, B. (2013). Decoding stimulus identity from multi-unit activity and local field
potentials alone the ventral auditory stream in the awake primate: implications for cortical neural prostheses. J. Neural
Eng. 10, 016010.
Stark, E. and Abeles, M. (2007). Predicting movement from multiunit activity. J. Neurosci. 27, 8387-8394.
Singer, A., Carr, M.F., Karlsson, M.P. and Frank, L.M. (2013). Hippocampal SWR activity predicts correct decisions
during the initial learning of an alternation task. Neuron 77, 1163-1173.
Taxidis, J., Anastassioiu, C.A., Diba, K. and Koch, C. (2015). Local field potentials encode place cells ensemble
activation during hippocampal sharp wave ripples. Neuron 87, 590-604.
Townsend, R.G. and Gong, P. (2018). Detection and analysis of spatiotemporal patterns in brain activity. PLoS Comput.
Biol. 14, e1006643.
van der Maaten, L.J.P. and Hinton, G.E. (2008). Visualizing high-dimensional data using t-SNE. Journal of Machine
Learning Research, 9, 2579-2605.
Villette, V., Malvache, A., Tressard, T., Dupuy, N. and Cossart, R. (2015). Internally recurring hippocampal sequences
as a population template of spatiotemporal information. Neuron 88, 357-366.
Waldert, S., Lemon, R.N. and Kraskov, A. (2013). Influence of spiking activity on cortical local field potentials. J. Physiol.
591, 5291-5303.
Wang, Y., Romani, S., Lustig, B., Leonardo, A. and Pastakov, E. (2015). Theta sequences are essential for internally
generated hippocampal firing fields. Nat. Neurosci. 18, 282-288.
Whitlock, J.R., Sutherland, R. J., Witter, M. P., Moser, M-B. and Moser, E-I. (2008). Navigating from hippocampus to
parietal cortex. Proc. Nat. Acad. Sci. USA 105,14755-14762.
Wikenheiser, A.M. and Redish, A.D. (2015). Hippocampal theta sequences reflect current goals. Nat. Neuroci. 18, 289294.
Wu, W., Nagarajan, S. and Chen, Z. (2016). Bayesian machine learning: EEG/MEG signal processing measurements.
IEEE Signal Processing Magazine, 33, 14-36.
Zanos, T.P., Mineault, P.J. and Pack, C.C. (2011). Removal of spurious correlations between spikes and local field
potentials. J. Neurophysiol. 105, 474-486.
Zhang, H. and Jacobs, J. (2015). Traveling theta waves in the human hippocampus. J. Neurosci. 35, 12477-12487.
Zhang, K., Ginzburg, I., McNaughton, B.L. and Sejnowski, T.J. (1988). Interpreting neuronal population activity by
reconstruction: unified framework with application to hippocampal place cells. J. Neurophysiol. 79, 1017-1044.

12

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

STAR METHODS
KEY RESOURCES TABLE
REAGENT or RESOURCE
Deposited Data
Datasets 1, 2
Datasets 3, 4
Dataset 5
Experimental Models: Organisms/Strains
Long-Evans rats
Mice C57BL/6J
Software and Algorithms
MATLAB
PYTHON
Custom code for various decoding methods

SOURCE

IDENTIFIER

https://crcns.org/datasets/hc/hc-11
http://buzsakilab.com/wp
/datasets/.
https://crcns.org/datasets/hc/hc-3

N/A

Charles River Labs
The Jackson Laboratory

RRID:
RGD_2308852
stock no.: 000664

MathWorks
Open source
This paper

N/A
N/A
N/A

N/A
N/A

CONTACT FOR REAGENT AND RESOURCE SHARING
Further information and requests for resources should be directed to and will be fulfilled by the Lead
Contacts, Zhe S. Chen (zhe.chen@nyulangone.org).
EXPERMIMENTAL MODEL AND SUBJECT DETAILS
All experimental studies were performed in accordance with the National Institutes of Health (NIH) Guide
for the Care and Use of Laboratory Animals to ensure minimal animal use and discomfort, and were
approved by the New York University School of Medicine (NYUSOM) Institutional Animal Care and Use
Committee (IACUC). Long-Evans rats (n=3) and mice (n=2) were used in the behavior tasks, and were
maintained on a 12:12-h light-dark cycle and housed individually with access to food and water.
METHOD DETAILS
Electrophysiological Recordings
Datasets 1 and 2: Circular track and linear track (rat 1). Male Long-Evans rats were bilaterally implanted
with two 6-shank silicon probes (128 channels in total) parallel to the septo-temporal axis of the dorsal
hippocampus. The silicon probe is a custom Buzsaki64SPL probe (NeuroNexus). This 6-shank silicon
probe had 10 sites at each shank, and there were 4 extra channels spaced every 1.25 mm starting 1.25
mm from the tip of Shank 4 (6´10+4=64 channels). All sites were vertically staggered along the shank with
20 µm spacing between sites (Figure S1C). We selected one rat (‘Achilles’) in the analysis. The recording
session consisted of a long (~4 hr) pre-RUN sleep epoch in a familiar room, followed by a RUN epoch (~45

13

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

minutes) in a novel circular maze (1 m diameter, Dataset 1) or a linear track (1.6 m long, Dataset 2). After
the RUN epoch the animal was transferred back to its home cage in the familiar room where another long
(~4 hour) post-RUN sleep was recorded. Details of experimental protocols and data have been published
(Grosmark and Buzsaki, 2016; Chen et al., 2016). The electrophysiological data are publicly available
(https://crcns.org/data-sets/hc/hc-11/).

Datasets 3 and 4: T-maze and linear track (rat 2). Two 256-channel (512 channels in total) custom-made
silicon electrodes were implanted to the right hippocampus of the rat. The silicon probe is a custom
Buzsaki256 probe with 32´8 array layout (Figure S1C). The two probes were perpendicularly aligned to
each other in order to record along both the septotemporal and suiculo-fimbrial axis of the hippocampus.
In the T-maze, rat was trained to perform a delayed alteration task, in which the animal had to choose either
the left or the right arm at the decision point. After returning to the start area, the rat was confined for 10
seconds. In the next following trial, the rat had to choose the opposite direction and would obtain water
reward with a correct choice. In the linear track, animal simply foraged back and forth to collect water reward.
Details of experimental protocols have been published (Berenyi et al., 2014), and data are available at
http://buzsakilab.com/wp/datasets/.
Dataset 5: Open field (rat 3). Male Long-Evans rats foraged and chased randomly dispersed drops of water
or food on an elevated square platform (120 ´120 cm2). The silicon probe consists of two 32-channel (4´8)
array (Figure S1C). The probe was implanted in the rat’s left and right dorsal hippocampi. Data are available
at https://crcns.org/data-sets/hc/hc-3
Dataset 6: Circular T-maze (mouse 1 and mouse 2). Male mice were trained to perform a spatial alternating
memory task in a circular T-maze. The silicon probe consists of a 64-channel (4´16) poly2 layout (Figure
S1C). Each animal’s recordings consisted of multiple sessions during 4-6 consecutive days, and each
session lasted 50-60 min run epochs. At each session, animal was able to run 120-160 trials, with a
minimum of 120 correct trials. The probe position was kept intact across sessions in order to assure the
stability of LFP channels. Spikes were sorted separately for each session, yielding varying number of unit
yields (Table S1).
Data Preprocessing and Analysis
Spike sorting. Extracellular representations of action potentials were extracted from recorded broadband
(0.3 Hz-10 kHz) signals followed by threshold-based spike detection algorithm. We applied principal
component analysis (PCA) to the spike waveform representations on the contact sites of a given shank,
and the individual spikes were automatically clustered into groups with the lowest internal variance using
the KlustaKwik algorithm (http://klustakwik.sourceforge.net/). For high-density probes, spikes were sorted
using the Kilosort algorithm (https://github.com/MouseLand/Kilosort2) (Rossant et al., 2016). The clusters
were manually refined by discarding multiunit clusters showing lack of clear refractories in the
autocorrelogram, and groups with unstable firing patterns over time.

14

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Bandpass filtering and calculation of instantaneous LFP amplitude. Broadband LFP signals were
downsampled and filtered separately into different frequency bands. To extract theta-modulated LFP
features, LFP signals were zero-phase filtered using a complex Morlet wavelet. We applied Hilbert
transform (MATLAB function ‘hilbert.m’) to the bandpass filtered LFP signals (e.g., theta band, gamma
band, ripple band or >300 Hz) and obtained an analytic signal. We then computed the amplitude of the
analytic signal to derive the instantaneous LFP amplitude at the specific frequency band.
Theta-band LFP demodulation. We applied a complex Morlet wavelet (with central frequency at 8 Hz) to
the broadband LFP signal followed by (noncausal) zero-phase filtering. From the theta-band LFP, we
applied demodulation using the following equation to obtain theta-demodulated LFP signals 𝑦" (𝑡)
𝑦" (𝑡) = 𝑦(𝑡)exp (−𝜑(𝑡)𝑖)
where 𝑖 = √−1 , 𝑦(𝑡) denotes the band-pass filtered signals at the theta band, 𝜑(𝑡) denotes the phase of
the first principal component (PC) of the complex-valued, filtered multi-channel LFP signal within the theta
frequency band. The first PC reflects the oscillatory component common to all channels. Demodulation
preserves amplitude and relative timing of the wave at each channel, while discarding the theta-band
oscillatory component (Agarwal et al. 2014).
Spike removal from raw LFPs. To remove putative spikes from the broadband LFP signal (up to 10 kHz),
we ran the Kilosort algorithm (Rossant et al., 2016) to identify putative spikes across all channels. Once the
spikes were identified in each channel, we removed the spikes, by using a linear interpolation from the start
to end points of spike waveform or using a Bayesian spike removal algorithm (Zanos et al., 2011), and
further obtained the resulting spike-free signal (Figure 1F). After high-pass filtering (>300 Hz), the filtered
LFP signal 𝐘123 was decomposed into an additive sum of two components (Figure 1G):
𝐘123 = 𝐘456789:;<= + 𝐘456789?@88
where 𝐘456789:;<= denotes the spike-only component and 𝐘456789?@88 denotes the spike-free component. The
instantaneous amplitude of 𝐘123 (>300 Hz) was referred to as MUA.

Multichannel LFP Feature Extraction
Nonnegative matrix factorization (NMF). Let Y denote the N-by-T matrix consisting of nonnegative Nchannel LFP amplitude features at a specific frequency band. NMF is aimed at finding an approximate lowrank matrix factorization form:
𝐘 ≈ 𝐖𝐇,
where W is a low-rank (m-by-N, m<N) nonnegative matrix, and H is an m-by-T nonnegative matrix. We
interpreted the column vectors of W as a set of basis functions that reflected the spatially localized feature

15

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

in the latent space. There were many versions of NMF algorithms (Lee and Seung, 1999; Berry et al., 2007;
Cichocki et al. 2009). We used the MATLAB function ‘nnmf.m’ in our data analysis. Other NMF optimization
algorithms (e.g., https://github.com/hiroyuki-kasai/NMFLibrary) also yielded similar results. We varied the
model order m and compared the visualization effects. In the testing phase, given unseen data Ytest, we
fixed the basis function W, and estimated the Htest (with nonnegative elements) via the equation: 𝐘D84D ≈
𝐖𝐇D84D .

Independent component analysis (ICA). Let Y denote the N-by-T matrix consisting of real or complexvalued N-channel LFP features at a specific frequency band. The ICA assumes that Y is a linear
combination of independent source signals: Y=MZ, where M is a square mixing matrix, and Z denotes the
N-by-T source signal matrix consisting of mutually statistically independent source signals. The source
signals are assumed to non-Gaussian and sparsely represented. ICA is aimed to seek an optimal demixing
matrix, W, operated on the Y, such that 𝐙F = 𝐖𝐘 recovers the independent source signals 𝐙F ≈ 𝐙, subject to
the scale and permutation ambiguity (Hyvarien et al. 2001). Provided that data Y are pre-whitened, ICA
solves the following optimization problem
min‖𝐖𝒚‖L
𝐖

s. t. 𝐖𝐖P = 𝐈

where 𝒚 is a column vector of Y.
For real-valued MUA features, we employed a reconstruction ICA (RICA) algorithm (Le et al., 2011).
In contrast to ICA, RICA replaces the orthonormal constraint with a soft reconstruction penalty and allows
an overcomplete representation (i.e., W is a non-square matrix). Mathematically, RICA solves the following
penalized optimization problem
min ‖𝐖𝒚‖L + 𝜌‖𝐖 P 𝐖𝒚 − 𝒚‖SS
𝐖

where 𝜌 > 0 is a regularization parameter. When 𝐖 P 𝐖 = 𝐈, it recovers the ICA as a special case. We used
the MATLAB function ‘rica.m’ in our data analysis.
Characterization of LFP traveling waves. To characterize the traveling wave patterns of multichannel
LFP signals, we used the optical flow (vector field) method. Optical flow is commonly referred to the pattern
of apparent motion of objects, and edges in a visual scene. In computer vision, the optical flow methods try
to calculate the motion between two image frames which are taken at times t and 𝑡 + ∆𝑡 at every voxel or
pixel position. These methods are called differential since they are based on local Taylor series
approximations of the frame images; that is, they use partial derivatives with respect to the spatial and
temporal coordinates. For a 2D+t dimensional case, a voxel at location (𝑥, 𝑦, 𝑡) with intensity 𝐼(𝑥, 𝑦, 𝑡) will
have moved by {∆𝑥 , ∆𝑦 , ∆𝑡} between the two image frames, and the following brightness constancy
constraint can be given:
𝐼(𝑥, 𝑦, 𝑡) = 𝐼(𝑥 + ∆𝑥, 𝑦 + ∆𝑦, 𝑡 + ∆𝑡)

16

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Based on first-order Taylor series expansion, we derived
[\
[]

where 𝑉] =

∆]
∆_

and 𝑉^ =

∆^
∆_

[\

[\

∆𝑥 + [^ ∆𝑥 + [_ ∆𝑡 = 0 or

[\
𝑉
[] ]

[\

[\

+ [^ 𝑉] + [_ = 0

. In the vector form, the above equation is:
e⃗ = ∇𝐼] 𝑉] + ∇𝐼^ 𝑉^ = −∇𝐼_ .
∇𝐈⃗ ∙ 𝐕

From the filtered (4-12 Hz or >300 Hz) multichannel LFP signals, we projected their Z-scored values
onto a 2D image according to the array size. We then used the Horn-Schunck estimation method (MATLAB
function ‘opticalFlowHS’) to estimate the optical flow based on neighboring frames. The optical flow was
represented and visualized by a 2D vector field (MATLAB function ‘quiver.m’), with arrows indicating the
direction, and the size of arrow proportional to the scale. The spatiotemporal patterns of optical flow or
vector field provided a characterization of the spatiotemporally local motion of traveling waves in space and
time. For the purpose of decoding animal’s position, we further temporally averaged the vector field movie
at a frame rate of 10 Hz (i.e., bin size: 100 ms). These high-dimensional flow patterns were used in a simple
linear decoding method (such as OLE). In real-time applications, estimation of optical flow can be
implemented

via

graphic

processing

unit

(GPU),

such

as

NVIDIA

optical

flow

SDK

(https://developer.nvidia.com/opticalflow-sdk).

Stochastic neighbor embedding (SNE) of multichannel MUA features. The t-distributed SNE algorithm
is a robust probabilistic dimensionality reduction method for visualization of high-dimensional data (van der
Matten and Hinton, 2008). The goal of embedding was to approximate the probability distribution of highdimensional MUA features when the same operation was performed on the low-dimensional (n=2 or 3)
“image” of the MUA. We used the MATLAB function ‘tsne.m’, with the default parameter setup (“Euclidean
distance”). During animal’s maze run, we color coded the embedded MUA features in a two-dimensional
embedding space according to the animal’s linearized position.

Decoding Analysis
Several spike-based or LFP-based decoding strategies were investigated (Table S1 and Figure S2C). In
all decoding analyses, spikes or LFP features were Z-scored across neurons or channels, respectively.
Likelihood-based spike decoding. From the sorted ensemble spikes, we constructed the place receptive
fields for hippocampal pyramidal neurons (‘place cells’). Let 𝝀g denote the place field of the c-th (c=1,…,C)
neuron for the binned position; assuming Poisson probability firing for each neuron, the likelihood function
given the observed sorted spike activity 𝒚L:P = i𝑦g,_ jk×P within a fixed-time interval is given as follows
(Zhang et al., 1998; Davidson et al., 2009):

17

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

P

k

𝑃(𝒚|𝒙) = p p Poisson(𝑦g,_ |𝝀g (𝒙), Δ)
_tL gtL

where 𝝀g (𝒙) denotes the place field or spatial tuning curve for the c-th neuron, and ∆ denotes the temporal
bin size. The likelihood was normalized between 0 and 1 (as probability) for all position bins. The maximum
u such that
likelihood estimate (MLE) seeks to find the optimal estimate 𝒙
uv.<.8. = argmax] 𝑃(𝒚|𝒙)
𝒙
To extend the likelihood-based decoding to Bayesian decoding, we incorporated a temporal Gaussian prior
conditional on the previously decoded position (Brown et al., 1998; Agarwal et al. 2014).
LFP decoding based on optimal linear estimation (OLE). We used the standard OLE method previously
described before (Agarwal et al. 2014).

We assumed that the decoded variable 𝒙 can be linearly

reconstructed from neural activity 𝒚 = {𝑦g } using a set of functions 𝜙(𝒙)
u = argmax] | 𝑦g 𝜙g (𝒙)
𝒙
g

We further assumed a local basis function 𝜙g (𝒙) for the decoded position variable. In one-dimensional
environment, we mapped the linearized position (with length L) via K equally spaced von Mises functions
characterized by a circular variable 𝜃 = 2𝜋𝑥/𝐿: 𝐵ƒ (𝜃) = exp (𝜅 cos(𝜃 − 𝜃ƒ )) for k=1,…,K. The original linear
representation can be reformulated as
‡ = argmax𝜽 | 𝑦g | 𝑣g,ƒ 𝐵ƒ (𝜽)
𝜽
g

ƒ

The optimization of parameter 𝑽 = {𝑣g,ƒ } will be solved by a least-squared (LS) solution
‡ = argmin𝑽 | ‖𝒚_ − 𝑽𝑩(𝜽_ )‖
𝑽
_

where 𝒚_ denotes the vectors of spike count or multichannel LFP features at time t, and 𝑩(𝜽_ ) =
[𝐵L (𝜽_ ), … . , 𝐵• (𝜽_ )] denotes a K-dimensional vector that expands the position in the basis. Unless stated
otherwise, we used K=75, 𝜅 = 100 and a temporal bin size of 100 ms (maze run) or 20 ms (ripple events).
In all decoding methods, all LFP features were first averaged within each time bin and then Z-scored across
all channels. We rescaled the OLE output between 0 and 1 via a softmax operation.
In addition, we considered incorporating the prior history of LFP activity (such as 𝒀_9L) as additional
covariance in the linear regression estimator. However, this was at the cost of doubling computational
complexity and potential overfitting.
In the open field, we mapped the two-dimensional position by replacing K von Mises basis functions
with a set of two-dimensional Gaussian tiling (Agarwal et al., 2014)

18

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

𝐵ƒ (𝒙) =

1
2𝜋•|𝚺|

exp (−(𝒙 − 𝝁ƒ )P 𝚺9L (𝒙 − 𝝁ƒ ))

Where the vectors 𝒙 represents the animal’s 2D position, and 𝚺 denotes the (diagonal or isotropic)
covariance, and {𝝁ƒ } denotes the mean vectors of K Gaussians that tile the field. We used K=144 and
temporal bin size of 300 ms for the open field environment.
LFP feature likelihood-based decoding. We designed a Gaussian likelihood-based decoder (i.e.,
noninformative prior) based on LFP features
𝑦g ~Gaussian(𝜆g , 𝜎gS )
where 𝜎gS denotes the variance, and the mean 𝜆g is represented by a sum of one or two-dimensional basis
functions
𝜆g = ∑ƒ 𝑣g,ƒ 𝐵ƒ (𝒙)

or 𝜆g = ∑ƒ 𝑣g,ƒ 𝐵ƒ (𝜽)

The Gaussian log-likelihood function, denoted as ℒ, is written as
P

k

›𝒚g,_ − 𝜆g,_ œ
1
ℒ = | | ln(2𝜋𝜎gS ) −
2
2𝜎gS

S

_tL gtL

where 𝜆g,_ = ∑ƒ 𝑣g,ƒ 𝐵ƒ (𝒙_ ). The unknown parameters {𝑣g,ƒ , 𝜎gS } were estimated from the maximum likelihood
estimation.
LFP feature selection used for decoding. For each channel, we extracted the instantaneous LFP
amplitude and phase at specific frequency bands. We systematically investigated the LFP features at the
following frequency bands: theta (4-12 Hz), slow gamma (30-80 Hz), fast gamma (80-140 Hz), ripple (140250 Hz), and ultra-high frequency (>300 Hz).
LFP decoding by imposing a sparsity constraint. In the OLE method, the traditional linear least-squared
(LS) regression method is subject to overfitting in the presence of high-dimensional features. To improve
generalization and assist variable, we used a sparse Bayesian linear regression method based on
variational Bayes (VB) and automatic relevance determination (ARD) (Bishop, 2016; Wu et al., 2016). The
mathematical details and MATLAB implementation are referred to (Drugowitsch et al., 2017). We extended
the multi-input single-output (MISO) regression problem to a multi-input multi-output (MIMO) regression
problem. Finally, the VB inference produced the posterior mean and posterior variance of the individual
parameter in 𝑽 = {𝑣•,ƒ }. For the purpose of variable selection, the parameter with a small mean and a small
variance would be discarded. See Figure S10 for an illustration of encoding and decoding application.
Bayesian hidden Markov model (HMM) for unsupervised learning decoding analysis. To discover
latent structures of large-scale hippocampal population codes, we developed a HMM for analyzing
hippocampal ensemble spike activity during spatial navigation and sleep (Chen et al. 2014; Chen et al.,

19

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

2016; Linderman et al. 2016). In a basic HMM, we assumed that the latent state process follows a firstorder discrete-state Markov chain {𝑆_ } Î{1,2,···,Ns}, and the observations of neural activity at discrete time
index t, follow a conditional probability distribution (conditioned on the latent state 𝑆_ ). In the case of
nonnegative features (either in the form of neuronal spike counts or multisite MUA features), we assumed
a Poisson probability associated with associated tuning curve functions 𝚲 = {𝝀g } = i𝜆g,• j . The joint
probability distribution of observed and latent variables are given by
𝑃(𝒚L:P , 𝑆L:P |𝝅, 𝑷, 𝚲)= 𝑝(𝑆L |𝝅) ∏P_tS 𝑝(𝑆_ |𝑆_9L , 𝑷) ∏P_tL 𝑝(𝒚_ |𝑆_ , 𝚲)
where 𝑷 = i𝑃•¤ j denotes an Ns -by-Ns state transition matrix, with Pij representing the transition probability
from state i to j; 𝝅 = {𝜋• } denotes a probability vector for the initial state S1; yc,t denotes the number of spike
counts from cell c within the t-th temporal bin (bin size: 100 ms during wake and 20 ms during ripples) and
𝒚L:P = i𝑦g,_ jk×P denotes the time series of C-dimensional neural response vector. In the case of spike
counts, we assumed the conditional probability distribution has a factorial form: 𝑝(𝒚_ |𝑆_ , 𝚲) =
∏kgtL 𝑃𝑜𝑖𝑠𝑠𝑜𝑛(𝑦g,_ |𝜆g,¨© ), which defined the products of conditionally independent Poisson distributions. We
developed a Bayesian inference procedure to identify the unknown parameters {𝝅, 𝑷, 𝚲} and the latent state
sequences {S1:T} (Chen et al., 2014). We further developed a Bayesian nonparametric version of the HMM,
the hierarchical Dirichlet process-HMM (HDP-HMM), which extends the finite-state HMM with a
nonparametric HDP prior, and inherits a great flexibility for modeling complex data (Linderman et al., 2016).
The associated Markov chain Monte Carlo (MCMC)-based inference algorithm allowed us to infer the
optimal model order Ns.
LFP feature resampling. In the HDP-HMM, the assumed observations were Poisson-distributed spike
counts (nonnegative integers). Therefore, we need to adapt the likelihood model of the HMM to
accommodate LFP-feature observations. In the case of nonnegative LFP features 𝒚_ (e.g., derived from
NMF operated on nonnegative MUA or LFPq power), we generated the same size of random samples from
a desired Poisson distribution based on a rank-invariant resampling procedure (Honey et al., 2009), and
replaced the original samples with the ordered new samples (by keeping their rank or order unchanged).
ª_ as the pseudo spike count observations and then repeated the same Bayesian inference
We treated 𝒚
ª_ |𝑆_ , 𝚲) = ∏¬
procedure assuming a new Poisson likelihood 𝑝(𝒚
«¤,_ |𝜆¤,¨© ). For the real-valued Z¤tL 𝑃𝑜𝑖𝑠𝑠𝑜𝑛(𝑦
scored LFP features, a similar resampling procedure was also employed. A schematic illustration of the
resampling procedure is shown in Figure S7. The choice of the mean statistic (say 10) in the new Poisson
distribution was ad hoc, yet the final performance was robust with respect to a wide range of the Poisson
mean statistic.

Identification of ripples and awake and sleep replay candidate events. We first used the
electromyography (EMG) and LFP for sleep staging. NREM sleep was primarily determined by the low
EMG amplitude, high delta/theta power ratio, the presence of slow waves and sleep spindles in LFP activity.
REM sleep was determined by the low EMG amplitude and high theta/delta power ratio. SPW-Rs were
identified based on a previously described method (Grosmark and Buzsaki, 2016). The integrated power
of the filtered LFP signal was calculated in a sliding window for each electrode. To identify the candidate

20

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

events of memory replay during immobility and NREM sleep (Figure 2A), we used a combined criterion of
hippocampal LFP amplitude at ripple band (140-250 Hz) and total spike count (threshold >mean+3 SD).
For visual inspection, we computed the spectrogram to assist identification. Time-frequency analysis was
done using the established multitaper method (Chronux; http://chronux.org/). We selected subsets of
candidate events during immobility (in the maze or sleep box) and post-NREM periods for MUA or clustered
spike-based decoding analysis.

Prospective decoding and prediction of animal’s future spatial decision-making. In goal-directed
navigation tasks, we developed a look-ahead decoding strategy to predict animal’s future decision (L vs. R
turns) based on either ensemble spikes or LFP features collected in the central arm of T-maze. During the
training phase, we correlated the animal’s future position at the L/R arm with neural activity with a time lag
(0.5-1.5 s, 100 ms temporal bin size) while animal ran in the central arm (see Figure 5A for schematic
illustration). We assessed the “mode” of decoded L vs. R-turn trajectories and determined the prediction
outcome based on their sums of weighted scores---the one with a higher cumulative sum was deemed the
winner. The score at each time point was weighted with a slow decay from the future to the past. For
instance, we used a linear decay vector [1, 0.9, 0.8, 0.7, 0.6], by imposing a larger weight on the future
predicted outcome (yet the ultimate prediction outcome was insensitive to the exact values in the decay
vector). To assess the prediction accuracy, we conducted 10-fold cross-validation. In addition, we ran 1,000
Monte Carlo runs (by randomly selecting 90% training trials in each run) and reported the mean±SD
classification accuracy. As control for each strategy, we also performed 1,000 random shuffles and
computed the chance-level accuracy.
Furthermore, we trained a linear support vector machine (SVM) classifier (Bishop, 2006) to predict
animal’s future decision based on the joint (MUA+LFPq) features. The SVM is a discriminative supervised
learning model that constructs the classification boundary by a separating hyperplane with maximum
margin. Specifically, the SVM maps the input x into high-dimensional feature spaces, which allows linear
or nonlinear classification, as follows:
¬

𝑦• = | 𝐾(𝐱, 𝐱• ) + 𝑏
•tL

where 𝑦• denotes the class label for the training sample 𝐱• , b denotes the bias, and 𝐾(𝐱, 𝐱• ) denotes the
kernel function. For the ease of interpretation, we used a linear kernel in the SVM (MATLAB Machine
Learning Toolbox ‘fitcsvm’ function). In addition to the classification accuracy, we also reported the AUROC
(area under ROC curve) statistic. An AUROC value of 0.5 indicates a chance level, whereas a high AUROC
value (close to 1) implies excellent performance.
Real-Time Decoding
Real-time MUA decoding based on the OLE method. Our real-time MUA decoding operation consisted
of three steps. Step 1: Broadband voltage signals were filtered (>300 Hz) in data acquisition hardware. In

21

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

real-time processing, we used a causal, low-latency 5th-order Butterworth finite-impulse response (FIR)
filter. Step 2: In the memory buffer (20 ms during ripples and 100 ms during run), multichannel LFP signals
were processed by a Hilbert transform in parallel (using multi-core CPU), and instantaneous LFP amplitude
features were computed. The memory was constantly updated in time. Step 3: Position was reconstructed
based on a pretrained linear map V. The pipeline was initially implemented in MATLAB R2019 (MathWorks),
and optimized by C/C++ implementation (with Intel complier). We tested all real-time operations on a
desktop (3.6 GHz 4-core Intelâ i7700 CPU, with Windowsâ10 OS, Visual Studio 2017 and Intelâ Parallel
Studio XE 2018 environment).
Once the LFP features were computed across channels and averaged within each time bin, the
remaining computational complexity of OLE operation was O(N*L) per time bin (where N denotes the
number of channels and L denotes the number of spatial bins), which was split into multiple threads in
parallel for computational speedup. Since the computational bottleneck was the Hilbert transform. Further
speedup in the computation of FIR filtering and Hilbert transform may be done by hardware implementation,
such as FPGA (Field Programmable Gate Array).
Real-time significance assessment of decoded memory replay. An important step in analyzing online
hippocampal memory replay is to assess the statistical significance of decoded spatial trajectory (Hu et al.,
2018). To assess the significance of the MUA decoding result, we ran shuffle analyses. To accommodate
the real-time computation, we performed and saved two types of pseudorandom shuffles (i.e., channel
order shuffle by permutating columns and receptive field shuffle by circular-shifting each column) in
advance and directly applied those in online decoding.
We used Hilbert transform to computed the LFP amplitude at ripple band (140-250 Hz) for a
preselected channel that shows the largest ripple amplitude, and then compared ripple band amplitude with
a predetermined threshold (e.g., mean+SD) to detect the onset of candidate event (Figure 6D). Since the
decoding speed is ultrafast, we used a “decode-as-you-go” strategy. Specifically, we calculated >300 Hz
high-passed amplitudes features (MUA) for all recording channels and continuously decoded the content
for each time bin. But the significance assessment of the candidate event was only ran after the length of
event above 3 bins. Once the significance assessment is started, we ran 2,000 (1,000 for each type of
shuffle operation) random shuffle decoding analysis for the whole event at each time step and computed
the Monte Carlo P-value (based on the distance correlation measurement). After the P-value is calculated,
we update the cumulative score as follows
𝑆𝑐𝑜𝑟𝑒• = ³

𝑆𝑐𝑜𝑟𝑒•9L , if Ripple_band amplitude < threshold or 𝑃»¼½¾¿ (𝑖) > 0.05
𝑆𝑐𝑜𝑟𝑒•9L − log›𝑃»¼½¾¿(•) œ , otherwise

where i denotes the time bin index, and 𝑆𝑐𝑜𝑟𝑒Â = 0 at the time of event onset. Once the online cumulative
score was above a predetermined threshold (e.g., −3log (0.01) used in our current analyses), the event
was deemed statistically significant and we reset the cumulative score to be 0. All analyses were first
implemented in MATLAB scripts and then optimized in C/C++ code.
QUANTIFICATION AND STATISTICAL ANALYSIS

22

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Statistical assessment of decoding. During maze run (velocity threshold: 5-15 cm/s depending on the
spatial environment), we evaluated the decoding accuracy by the absolute error between the animal’s
uÅ8Æ:Å8 | (where 𝒙
uÅ8Æ:Å8 was derived from a specific
actual position and the decoded position: |𝒙D@Ä8 − 𝒙
decoding strategy using either clustered spikes, MUA or LFP-based features). We used 10-fold crossvalidation to assess the median decoding error, and computed the bootstrapped standard deviation (SD).
During ripple events, we computed the distance correlation (Liu et al., 2018), and then computed
2,000 random shuffles for each event to derive the Z-score statistic or Monte Carlo P-value. For spikebased likelihood decoding, we used cell identity shuffling and receptive field shuffling; for MUA decoding,
we used channel order shuffling and linear map shuffling (with respect to the rows of matrix V from the
OLE). Among different types of shuffling operations, we used the worst Z-score or Monte Carlo P-value as
the final shuffle statistics.
Region-specific assessment of decoding. High-density silicon probes enabled us to record multiple
regions (e.g., CA1, CA3, dental gyrus) or layers of the hippocampus. To assess the region-specific
contribution to specific decoding strategy, we first split the channels according to their implanted anatomical
regions (Figure S3). To control the imbalance of channel counts between regions, we randomly selected
the matched number of channels from other regions and repeated the same decoding analysis. We
repeated the random selection for 1,000 times and compared their Monte Carlo statistics.

DATA AND SOFTWARE AVAILABILITY
All data needed to evaluate the conclusions in the paper are present in the paper and/or the supplementary
materials. Some datasets included in this study are publicly available at https://crcns.org/data-sets/hc/ or
are available upon request. Custom MATLAB and Python scripts can be downloaded from
www.cn3lab.org/software.html.

23

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 1. Spatial Distributed Hippocampal Recordings Encode Rat Position during Maze Running
(A) Illustration of processing raw voltage traces of hippocampal recordings into three different signals:
clustered spikes (red), filtered LFP at theta band (blue), and high-pass filtered signal (>300 Hz, green).
(B) Comparison of rat’s decoded movement trajectory on a circular track (Dataset 1) based on three
different signals derived from (A): clustered spikes (red), demodulated LFP theta (referred to as LFPq,
amplitude plus phase, blue), high-pass filtered (>300 Hz) LFP amplitude (referred to as MUA, green). The
rat’s position is marked by the black line. In all illustrations, we used an OLE method trained by sparse
Bayesian regression.
(C) Histograms (left) and error cumulative distribution function (CDF; right) curves of 10-fold cross-validated
decoding errors during maze run. Augmenting the covariate with their respective history at the decoded
preceding time bin (‘history decoding’) further improved the cross-validated decoding accuracy in each case
by ~10% (dotted line in the CDF curves; two-sample Kolmogorov-Smirnov test, P=1.4´10-4, 4.6´10-5,
1.1´10-2 for three respective panels). The numbers in the CDF plot indicate the median position decoding
error of two CDF curves.
(D) Illustration of position decoding in 2D open field environment (Dataset 5) based on the same decoding
strategy derived from clustered spikes, LFPq, MUA, and joint LFP (LFPq+MUA) features. The animal’s
actual position is marked in black. We used a Bayesian filter decoder with a Gaussian temporal prior for all
features. To reduce input correlation of multichannel LFP features, we conducted a PCA-whitening step
before the encoding procedure. See also Movie S1.
(E) Comparison of decoding error CDF curve derived from the four different signals shown in (D). Numbers
indicate the corresponding median position decoding error.
(F) Decomposition of a broadband raw voltage trace (1st row) into the sum of a spike-free component (2nd
row) and a spike-only component (3rd row). To investigate the effect of spike waveform and amplitude, we
normalized individual spike waveforms by their respective peak amplitudes and derived the signal in the 4th
row. Color ticks in the top represent identified spikes from clustered units (with the associated averaged
spike waveform).
(G) Down-sampled (1,250 Hz) and high-pass filtered (>300 Hz) version of the four signals in (F).
(H) Comparison of decoding error CDF curve derived from the four different signals shown in (G). Numbers
indicate the corresponding median position decoding error.

24

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 2. Spatial Distributed Hippocampal LFP Patterns Encode Rat Position during Ripple Events
(A) Illustration of a broadband hippocampal recording trace (black) during a candidate replay event. The
candidate event was determined by a joint criterion (Methods) using the total unclustered spike count (red)
and ripple-band amplitude (blue). The red and blue horizontal dotted lines indicate their respective
thresholds.
(B) Three representative example trajectories of virtual maze positions decoded from the spikes during
hippocampal ripple periods, derived from a maximum likelihood estimator (MLE) using clustered spikes
( “ground truth”; top), from an optimal linear estimator (OLE) with sparse Bayesian regression using
clustered spikes (middle), and from an OLE with sparse Bayesian regression using MUA (bottom). Dark
pixels show high probability values.
(C) Histogram comparisons between the three estimators shown in (B).
(D) Comparison of Z-scored statistics of distance correlation (see Methods) for ripple replay candidate
events (n=727 ripples during waking and NREM sleep). Decoding methods (OLE or Bayesian) and features
(MUA or clustered spikes) are labeled in each paired comparison. Dashed lines mark the Z-score value of
2.33 (P=0.01).

25

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 3. Unsupervised Learning Methods for Extracting Multichannel MUA Features
(A) Illustration of NMF (top) and RICA (bottom) methods for extracting lower-rank features from MUA during
maze run (Dataset 1). After sorting, the position-average patterns (from the rows of NMF’s matrix H or
RICA’s matrix Z) yielded localized position-tuned features covering the entire track (similar to “place fields”).
(B) Same as (A), during ripple events. The virtual position was decoded from clustered spikes.
(C) A Bayesian HMM was used for inferring latent state sequences {S1(t)} and {S2(t)}, based on the spike
ensembles and MUA features, respectively. The sorted ensemble spikes are assumed to be Poisson
distributed. The lower-rank MUA features were obtained from the NMF’s matrix H, followed by a feature
resampling procedure (Methods). The matrix frame color (green, blue, red) represent the source of feature
matrix (spike count, H, Z).
(D) During maze running, the Bayesian HMM analysis revealed a strong one-to-one correspondence map
between the animal’s position and the inferred latent states {S1(t), S2(t)}, as well as between {S1(t)} and
{S2(t)} (upon sorting). These consistency results indicated that the most valued signal in MUA is clustered
spikes (top row: bases on NMF; bottom row: based on RICA). Label color (S1 in green and S2 in blue or
red) represents the latent state sequence derived from clustered spikes and lower-rank features (H or Z).
(E) During ripples in the absence of behavior measures, the Bayesian HMM analysis also revealed a
correspondence map between {S1(t)} and {S2(t)}, which were derived from the ensemble spikes and MUA
features (top row: bases on NMF; bottom row: based on RICA), respectively. Label color same as (D).

26

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 4. Spatiotemporal Patterns of Multisite Recorded Hippocampal LFP Encode Run Trajectories
(A) Illustration of optical flow estimation and visualization by 2D vector field. High-density silicon probe
recordings (8 shank, 32 sites each rank) in the same hippocampus in the transversal (T) and longitudinal
(L) axes of a rat are shown separately (Dataset 3). Each 2D vector was visualized as an arrow
(characterized by size and direction). (i) Background color in the raw map represents the voltage of filtered
LFP traces. (ii) Background was color coded according to the arrow direction.

(B) Optical flow estimated from band-pass filtered (4-12 Hz) 2´256-site recorded LFP signals show positiondependent patterns on a T-maze (Dataset 3). The vector field patterns showed trial-by-trial consistency.
See Movie S3 for the demonstration of clear propagating wave patterns.
(C) Schematic of extracting parallel and independent spatiotemporal features from hippocampal field
potentials at theta (4-12 Hz) and ultra-high (>300 Hz) frequency bands. Features are labeled as

① ② ③ ④.

(D) Comparison of median position decoding error during maze run derived from four different
spatiotemporal features in (C) and their feature combinations (Dataset 3). Error bar shows the bootstrapped
SD.

27

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 5. LFP, MUA and Spike-based Features Predict Animal’s Decision-making in the Mouse
(A) Schematic of prospective decoding, with time lag of 0.5-1.5 s (5-15 temporal bins, 100 ms bin size) prior
to the choice point in the T maze.
(B) Comparison of cross-validated prediction accuracy between clustered spike-based and joint
(LFPq+MUA) decoding strategies (Dataset 6). Mean and SD results were pooled over multiple sessions.
Left panel: mouse 1 (n=4 sessions, n=120 correct trials per session); right panel: mouse 2 (n=4 sessions,
n=120 correct trials per session).
(C) Top panel: SVM classification accuracy (for mouse 1). The peak classification rate from cross-validation
was ~90% and the AUROC statistic was ~0.94. Bottom panel: Boxplot statistics of animal’s actual location
at specific temporal bins across all tested trials. The classification accuracy degraded with increased
variability in the range of animal’s location.

28

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 6. Robustness and Scalability of Different Decoding Strategies
(A) Cross-session decoding error matrices summarize within-session and between-session assessment of
the LFPq and MUA decoding strategies in five consecutive run sessions (Dataset 6, Mouse 1). Combining
two complementary features further improved the decoding accuracy. The number in the matrix shows the
median position decoding error. Sessions (labeled by A,B,C,…E) were separated by ~24 hours.
(B) Average statistics of the k-th (−4 ≤ 𝑘 ≤ 4) diagonal of cross-session decoding error matrices in (A).
k=0 implies within-session decoding; k<0 (lower diagonal) implies training on historical sessions and testing
the subsequent sessions in time; k>0 (upper diagonal) implies the reverse order.
(C) MUA decoding strategy (green: 20 ms; blue: 100 ms bin size) with respect to the number of channels,
N. In the computer simulations, the linear mapping was assumed of dimensionality N´145 for a 1D
environment with 145 spatial bins. Horizontal green and blue dotted lines mark 20 ms and 100 ms,
respectively. Signals were down-sampled (up to 1,250 Hz) and high-pass filtered (>300 Hz) prior to
computation. Shaded areas correspond to the SD from 1,000 realizations.
(D) Illustration of online detection and assessment of rat hippocampal memory replay (Dataset 1). First,
given the raw extracellular voltage trace (1st row), we identified the onset of candidate event using a
threshold criterion based on the ripple band amplitude (2nd row). Next, we continuously decoded “spatial
trajectory” from hippocampal MUA at each time bin (20 ms bin size; 3rd row). Once the duration of candidate
event was more than 3 bins, the significance of decoded “spatial trajectory” was assessed using online
shuffling statistics (4th row). The Monte Carlo P value was computed based on distance correlation (red).
An accumulative score (blue) was computed as we continuously updated the assessment if P<0.05 (red
horizontal dashed line). Finally, a significance decision for spatial memory replay was made when
the accumulative score was above a threshold (blue horizontal dashed line). The accumulative score was
set to 0 at the detection onset and reset to 0 when the cumulative score threshold was reached. The
computation time for online evaluation at each temporal bin is shown in the last row.

29

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Table 1. Comparison of four different hippocampal LFP spatiotemporal features (N denotes the
channel count) and their potential decoding applications.

LFP features

# dim.

Operation

Spatiotemporal Decoding
characteristic
applications

demodulated theta
(4-12 Hz)

2N

bandpass filtering,
Hilbert transform, PCA

spatially global

run, REM sleep

theta flow (4-12 Hz)

2N
N

spatially local,
temporally local
temporally
independent

run, REM sleep

>300 Hz amplitude

bandpass filtering,
optical flow estimation
high-pass filtering,
Hilbert transform

>300 Hz flow

2N

high-pass filtering,
optical flow estimation

spatially local,
temporally local

run, ripple
sequences, theta
sequences
run, ripple
sequences, theta
sequences

30

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 1
A

B

C

0.1

1

290

Density

g

rtin

o
gs

ikin

Sp

Clustered spikes

0

0

Demodulated theta (LFPθ)

0

290

h-p

as

s

2s

D

0

25

LFPθ

MUA

0

0

25

0
290
True position (cm)

0.5

5.3 cm
(4.9 cm)

0

0
25
50
Decoding error (cm)

LFPθ + MUA

10 s

G

50 ms

50

1

10.8 cm
17.7 cm
12.9 cm
8.9 cm

F

50

5.5 cm
(4.7 cm)

E
Clustered spikes

100 cm

290

CDF

hig

0

290

Estimated (cm)

Hz

>300 Hz amplitude (MUA)

150 cm

00

0

0.5
0

>3

0
1

290

Theta bandpass

100 ms

5.6 cm
(4.9 cm)

0.5

H

5.3 cm
8.7 cm
4.5 cm
24.6 cm

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 2
A

B

C
(cm)

290

Probability
0

0

290

(cm)
Position from

Position (cm)
0

0.1
0.2
Time (s)

0.1
0.2
Time (s)

0.1
0.2
Time (s)

0.3

6

6

4

4

4

2
0
-2
-2

0

2

Spike (MLE)

4

6

MUA (OLE)

6

MUA (OLE)

Spike (OLE)

0

290

290

D

0.5

2
0
-2
-2

0

2

Spike (MLE)

4

6

0
0

0
Position from

290
(cm)

2
0
-2
-2

Density (count/cm2)

Position from

0.1

0

2

4

Spike (OLE)

6

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 3

×

CA

…

S1

St-1

St

St+1

Latent state
sequences

…

Position

E

yt+1

HMM

Time

S2

yt

Z

×

CA

D

Observed
neural activities
yt-1

RI ≈

Position

Position

Position

S1

S1

Position

S1

C

M
Time

Time

×

≈

S2

RI ≈

Time

Z

N

H

S2

M

Y
Channel

Channel

×

≈

S2

N

Y

MF

S2

MF

W

B

H

S2

W

A

S1

S1

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 4

B

A

(i)

(ii)

D

C

Raw Voltage
traces
300 Hz
highpass
filter

5.5

1

Optical Flow

2

Hilbert Tranform

3

Optical Flow

4

Decoding
median error (cm)

4-12 Hz
bandpass
filter

Demodulation

5
4.5
4
3.5

1

2

3

4

1 + 3

2 + 4

1 + 2

3 + 4

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 5

Positition

A
...
t
d ic
P re

Left

...

Right

Look-ahead
prediction

LFPs

...
100 ms

Lag

B
(i)

LFPθ + MUA
Spikes

(ii)

LFPθ + MUA
Spikes

C
LFPθ + MUA
Spikes

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Figure 6
A

B

+
Decoding median error (cm)

D

Computation time (ms)

C

Number of channles

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Supplemental Information

Ultrafast Readout of Representations from Spatially Distributed
Rodent Hippocampal Field Potentials
Liang Cao, Viktor Varga, and Zhe S. Chen*
*Correspondence: zhe.chen@nyulangone.org (Z.S.C.)

31

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Table S1. Related to Figures 1-6. Summary of experimental datasets under investigation. Mouse 1
consisted of five sessions, but only four sessions contained well-isolated hippocampal units.
Dataset Animal
# Session Environment
# LFP channels
#
sorted
units
1
Rat 1
1
circular maze (1 m diameter) 64×2 channels
92
2
Rat 1
1
linear track (1.6 m length)
120
64×2 channels
3
Rat 2
1
square T-maze
223
256×2 channels
4
Rat 2
1
linear track
261
256×2 channels
5
Rat 3
1
78
Open field (120 ×120 cm2)
32×2 channels
6
Mouse 1
5
[56,52,59,46]
circular T-maze
64 channels
[24,17,12,24]
Mouse 2
4
circular T-maze
64 channels

Table S2. Related to Figures 1-6. Summary and comparison of clustered spike-based and LFP-based
decoding strategies.
Method
Features
Likelihood
clustered spikes
OLE
clustered spikes
OLE
clustered spikes
Likelihood
LFP-based features
OLE
LFP-based features
OLE
LFP-based features
Bayesian
LFP-based features

Likelihood
Poisson
Gaussian
Gaussian
Gaussian
Gaussian
Gaussian
Gaussian

Estimator
MLE
linear LS regression
sparse VB-ARD linear regression
MLE
linear LS regression
sparse VB-ARD linear regression
Bayesian

Table S3. Related to Figure 2. Result comparison between online and offline significance assessment of
rat hippocampal memory replay events (Dataset 1).
# detected candidate events
# significant replay events
# significant replay events detected by both methods
# significant replay events detected by off-line method only
# significant replay events detected by on-line method only

Off-line
727
129

Online
672
105
56
73
49

34

A

Rat 1

Rat 2

Mouse 1&2

Rat 3

0.65 m

1.6 m

1.6 m

1m

2.5 m

1.3 m

1.2 m

B
Circular track

Linear track

120

Decoding
median error (cm)

7

T-Maze

14

Linear track

261

12

92

15

4

5

78

223

4

10

es

ik
Sp

A

U
P θ UA
+M
M
Pθ
LF

LF

es

ik
Sp

Pθ

LF

UA
A
+M
Pθ
F
L

MU

0

~19

~54

2

2
4

Mouse 2

6

8
6

Mouse 1

10
8

10
6

Open field

20

es

ik
Sp

Pθ

LF

UA
A
+M
Pθ
F
L

MU

es

ik
Sp

5

A

U
P θ UA
+M
M
Pθ
LF

LF

s

ike

Sp

Pθ

LF

A

MU

LF

UA

+M

Pθ

0
Sp

A
s
ike LFP θ MUA +MU
Pθ
LF

ike
Sp

s

UA
A
Pθ
LF MU P θ+M
LF

C
500 μm

1600 μm

500μm
2100 μm

058

600μm

140 μm

200μm

1000 μm

130μm
450 μm

Figure S1. Related to STAR Methods and Figures 1-5. (A) Schematic of four spatial environments using Datasets 1-6. (B) Summary of median position
decoding error during maze run derived from four different features. Error bar shows the bootstrapped SD. The following default setup was used: 100 ms
bin size; OLE decoding method using sparse Bayesian regression. The differing variabilities across animals is largely part of electrode type used. LFPθ
decoding was superior in rat 1 and rat 2 because large numbers of sites across all layers of the hippocampus was used but only a fraction of those were
in the pyramidal layer. The number of clustered single units in each session are indicated above the spike bar. (C) Configuration of the recording silicon
probes used in each dataset.

A

B

C

D

Figure S2. Related to Figure 1. Comparison of median position decoding error results derived from different
band-pass filtered LFP features (phase, amplitude, phase+amplitude) at (A) different frequency bands, (B) different
temporal bin size, and (C) different decoding methods (see Table S2; Dataset 1). Shaded area or error bar shows
the bootstrapped SD. (D) Same as (C), except for Dataset 3 using a different configuration of silicon probe.

B
Decoding
Median Error (cm)

A

Demodulated Theta Phase
40
30
20

*
***

10
0

Decoding
Median Error (cm)

>300Hz Amplitude
40
30

**

***

20
10
0

6)

P

(2
yr.

8)

R

. (4
ad

.
Lm

)

(47

)

47

(
DG

CA

)

23

(
3p

O

r
the

)

(65

)

55

(2
All

Figure S3. Related to Figure 1. (A) Current source density (CSD) analysis revealed distinct hippocampal LFP sinks and sources in different
anatomical layers (256 channels, 8 shanks, Dataset 3). (B) Demodulated LFPθ (top) and MUA (bottom) median position decoding error
using recording sites in different layers (blue) compared to median position decoding error (error bar: SD) derived from 1,000 random selections of matched number of recording sites (red). (Pyr: stratum pyramidale; Rad: stratum radiatum; Lm: stratum lacunosum moleculare; DG:
dental gyrus; CA3p: CA3 pyramidal layer). The number inside parentheses indicates the channel count within that layer/region. CA1 layers
with changing layer-by-layer theta phase shift gave best position decoding by LFPθ decoding strategy, while MUA was most effective in CA1
and CA3 pyramidal layer.

A

Probability

0.1

0

Position (cm)

320

0

0.2

0.1

0.2
Time (s)

0.3

0.1
Time (s)

6

6

4

4

4

2
0
-2
-2

MUA (OLE)

6

MUA (OLE)

Spike (OLE)

B

0.1
Time (s)

2
0

0

2

Spike (MLE)

4

6

-2
-2

0.2

2
0

0

2

Spike (MLE)

4

6

-2
-2

0

2

Spike (OLE)

4

6

Figure S4. Related to Figure 2. (A) Examples of decoded ripple-replay contents derived
from clustered spikes and MUA features in post-run sleep (Datasets 2). (B) Comparison of
detection statistics of hippocampal memory replay candidates in awake and NREM ripples
(n=1,038 candidate events) derived from spikes and MUA features.

0.8

Original distribution

0.1

PDF

PDF

0.6
0.4

0.05

0.2
0
-2

Target distribution (Poisson)

0.15

0

2

0

4

1

0

5

10

15

20

5

10

15

20

1

CDF

CDF

Resampling
0.5

0
-2

0

2

4

0.5

0

0

Figure S5. Related to Figure 3. Schematic procedure of resampling to rescale the
Z-scored real-valued observations (from an empirical distribution) to nonnegative count
observations (from a target Poisson distribution with mean statistic of 10). The red
arrows indicate the conceptual procedure. Note that the order statistics remained
unchanged between two cumulative distributed function (CDF) curves.

A

B

C
Left

Right

Figure S6. Related to Figure 3. Dimensionality reduction of multi-site recorded MUA features during track
running, produced by t-distributed stochastic neighbor embedding (t-SNE) algorithm. Each dot was color-coded in
relation to the animal’s position on the track. Two multi-site MUA feature patterns were similar if they were close in
the two-dimensional embedding space. (A) For the circular track (Dataset 1), we recovered a continuous trajectory pattern in the embedding space. (B) For the linear track (Dataset 2), we recovered direction-specific trajectory
pattern in the embedding space. (C) For the T-maze (Dataset 3), we recovered distinct clustered patterns, corresponding to L and R turns, in the embedding space.

B
290

Estimated (cm)

Density (count/cm2)

0.1

0

0

True position (cm)

0

290

1

CDF

A

0.5

0

0

25

50

Decoding error (cm)

C
Decoding median error (cm)

12
10
8
6
4
2
0

1

2

3

4

1 + 3

2 + 4

1 + 2

3 + 4

Figure S7. Related to Figure 4. (A) Optical flow estimated from MUA features (temporal bin size: 100 ms) showed position-dependent
patterns on a circular track (Dataset 1). The vector field patterns showed trial-by-trial consistency in three representative trials. See also
Movie S3. (B) Histograms and error CDF curves (solid line) of cross-validated decoding errors based on optical flow of MUA features during
run periods (Dataset 1). In the CDF curve, results derived from MUA (dotted line, same as Figure 1B) are shown for comparison. (C) Comparison of median position decoding error in run behavior derived from different hippocampal LFP spatiotemporal features (the numbers ① ②
③ ④ refer to the same spatiotemporal feature label as Figure 4) and their combinations (Dataset 1). Error bar shows the bootstrapped SD.

A

B

Mouse 1 - Look ahead prediction

Mouse 2 - Look ahead prediction

Figure S8. Related to Figure 5. Comparison of discrimination accuracy in prospective position decoding (L vs. R arm) derived from clustered spikes
and joint (MUA+LFPθ) for both correct and error trials. Results of four sessions are shown for each mouse (Dataset 6). In each session, we ran
1,000 Monte Carlo runs to compute the mean and SD statistics of 10-fold cross-validation for correct and incorrect trials. Shuffled statistics were
also computed for each method and shaded area represents the SD derived from 1,000 random samples. (A) mouse 1. (B) mouse 2.

A

Mouse 1 - Linear SVM classification

B

Mouse 2 - Linear SVM classification

Figure S9. Related to Figure 5. Comparison of linear SVM decoding accuracy (L vs. R arm) derived from clustered spike and joint (MUA+LFPθ)
features for correct trials only. Results of four run sessions are shown for each mouse (Dataset 6), in both backward (top row) and forward (bottom
row) directions. In each session, we ran 1,000 Monte Carlo runs to compute the mean and SD statistics of 10-fold cross-validation for correct trials.
(A) mouse 1. (B) mouse 2.

A

1 + 3

2 + 4

1 + 2

3 + 4

B

Figure S10. Related to Figure 1. (A) Comparison of median decoding error results (Dataset 1) between methods
using standard least-squared (LS, blue) and sparse VB-ARD (red) regression while testing different combinations of
LFP-based features (①: demodulated LFP theta power and phase; ②: LFP-optical flow using 4-12 Hz band; ③: MUA
at >300 Hz band; ④: MUA-optical flow at >300 Hz band). *, P<0.05; **, P<0.01; *** P<0.001, rank-sum test. Error bar
shows the bootstrapped SD. (B) Comparison of the mapping V between the VB-ARD (left) and LS (right) estimators
used in the OLE method (“①+②” LFP features combination). The weight coefficients learned from the VB-ARD
estimator were sparse.

bioRxiv preprint doi: https://doi.org/10.1101/828467; this version posted November 1, 2019. The copyright holder for this preprint (which was
not certified by peer review) is the author/funder. All rights reserved. No reuse allowed without permission.

Supplementary movie legends
Movie 1. Related to Figure 1. Demonstration of Bayesian filter (likelihood plus a temporal prior) decoding
in an open field environment (Dataset 5) based on clustered spikes, LFP, MUA, joint (LFP+MUA) features,
and combining all features. Video frame: 3.3 Hz.
Movie 2. Related to Figure 5. Demonstration of location-tuned spatiotemporal patterns in 512-channel rat
hippocampal LFP signals filtered at 4-12 Hz (Dataset 3). Animal’s actual position (grey) and decoded
position (blue) are shown. The 2D vector field illustrates the optical flow patterns across two Buzsaki256
probes. Background was color coded according to the arrow direction. Video frame rate: 10 Hz.
Movie 3. Related to Figure 5. Demonstration of location-tuned spatiotemporal patterns in 120-channel rat
hippocampal MUA features while running in a circular maze (Dataset 1). Animal’s actual position (grey) and
decoded position (blue) are shown. The 2D vector field illustrates the optical flow patterns across two
Buzsaki64SPL probes (610 layout). Background shows the MUA amplitude (warm color represents high
value). Video frame rate: 10 Hz.

35

