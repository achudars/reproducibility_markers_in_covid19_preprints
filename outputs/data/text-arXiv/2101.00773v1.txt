Optimal adaptive testing for epidemic control: combining
molecular and serology tests
D. Acemoglu1 , A. Fallah2 , A. Giometto3 , D. Huttenlocher2 , A. Ozdaglar2 ,
F. Parise∗4 , S. Pattathil2

arXiv:2101.00773v1 [eess.SY] 4 Jan 2021

1

Department of Economics, Massachusetts Institute of Technology (MIT)
2
Department of Electrical Engineering and Computer Science, MIT
3
School of Civil and Environmental Engineering, Cornell University
4
Department of Electrical and Computer Engineering, Cornell University
Abstract

The COVID-19 crisis highlighted the importance of non-medical interventions,
such as testing and isolation of infected individuals, in the control of epidemics. Here,
we show how to minimize testing needs while maintaining the number of infected
individuals below a desired threshold. We find that the optimal policy is adaptive,
with testing rates that depend on the epidemic state. Additionally, we show that
such epidemic state is difficult to infer with molecular tests alone, which are highly
sensitive but have a short detectability window. Instead, we propose the use of baseline
serology testing, which is less sensitive but detects past infections, for the purpose of
state estimation. Validation of such combined testing approach with a stochastic
model of epidemics shows significant cost savings compared to non-adaptive testing
strategies that are the current standard for COVID-19.

1

Introduction

A large literature in mathematical epidemiology has studied how to control and eradicate
diseases by means of therapeutics and vaccinations, [Nowzari et al., 2016, Behncke, 2000].
However, the influenza pandemic of 1918 and the current COVID-19 pandemic underscore
the difficulty of such eradication in the case of virulent viruses, and have necessitated measures to reduce transmissions, for example with the use of face masks [Chu et al., 2020], social distancing and costly lockdown measures [Flaxman et al., 2020, Bertuzzo et al., 2020]
[Di et al., 2020]. Another powerful tool to limit transmissions is early identification of
infected individuals and epidemic hot-spots in local communities, which can both be
accomplished by testing [Grassly et al., 2020, OECD, 2020]. Nevertheless, during the
COVID-19 pandemic testing resources have proven to be limited and expensive in much
of the world [AACC, 2020, Apuzzo and Gebredikan, 2020, Mervosh and Fernandez, 2020,
Pullano et al., 2020]; in the US, lack of testing capacity not only helped spread the virus
but also led to the underestimation of the severity of the pandemic in the first half of 2020,
[Fink and Baker, 2020]. This crucial role of testing notwithstanding, the question of how
limited testing resources can be deployed to optimally control the spread of a pandemic
has attracted relatively little systematic attention.
In this paper, we derive an optimal (dynamic) testing strategy in an SIR (Susceptible,
Infected, Recovered) model of epidemics. Because undetected individuals may pass the
∗
Corresponding author: F. Parise (fp264@cornell.edu), D. Acemoglu (daron@mit.edu), A. Fallah (afallah@mit.edu), A. Giometto (giometto@cornell.edu), D. Huttenlocher (huttenlocher@mit.edu), A. Ozdaglar
(asuman@mit.edu), S. Pattathil (sarathp@mit.edu). We acknowledge support from the C3.AI grant.
Authors are listed in alphabetical order.

1

disease to others and may be more likely to develop serious symptoms requiring hospitalization, we start by assuming that the number of undetected infected individuals has to be
kept below a maximum imax at all times. We show that the optimal testing strategy takes
a simple form: the testing rate has to be time-varying in order to satisfy the constraint,
and takes the form of a most rapid approach path, [Spence and Starrett, 1975]. Namely,
there is no testing until undetected infections reach imax , after which testing resources are
used to keep infections at the threshold imax until infections decline naturally, bringing the
pandemic to an effective close. The intuition for this result is that it is not worth using
testing resources to keep undetected infections strictly below imax so long as the pandemic
is still ongoing and infections cannot be brought down to zero. Hence, the best approach is
to let the infection reach the threshold and then keep it there with a time-varying testing
policy. Note that such optimal time-varying strategy is state-dependent, that is, the level
of testing is dependent on the epidemic state (the current number of infected, susceptible
and recovered individuals).
The second contribution of our paper starts by recognizing that the epidemic state
needed to implement the aforementioned optimal testing strategy is typically hard to
know precisely, as highlighted by the early stages of COVID-19 spread in the US. In fact,
the most common qPCR tests for COVID-19, which are molecular tests based on detection
of the virus’ genetic material via quantitative polymerase chain reaction, may be ill-suited
to obtain such aggregate information. These tests identify infected individuals only during
a short window of time. For example, according to [Kucirka et al., 2020] the probability
of COVID-19 detection via qPCR is above 75% in a window of roughly a week within
active cases, while [Roche, 2020] gives a three weeks window for detectability of cases via
qPCR. In contrast, serology tests, which detect antibodies produced by the immune system in response to current and past infections, identify infections during a longer window
[Kubina and Dziedzic, 2020], but are typically less sensitive and thus received relatively
less attention in the epidemic control literature. These problems are unlikely to be confined
to COVID-19 and would probably recur in the event of future pandemics. To systematize
these observations we study the effectiveness of both types of tests for identifying the epidemic state and find that serology tests, which have lower sensitivity but are faster, cheaper
and can reveal past infections, offer a better alternative than qPCR-like tests (from here
on termed molecular tests), which have high accuracy but a short-window of detection.
Namely, we show that if the transmission rate in the SIR model is time-varying, then the
epidemic state cannot be identified—is not observable—with molecular tests alone. Intuitively, just observing the flow of current infections may not be sufficient to distinguish
the nonlinear dynamic evolution of the system due to different initial conditions versus
different time-varying trajectories of transmission rates. Serology testing overturns this
result, however, by providing a cheap way of estimating the stocks of past infected and recovered individuals. This is despite the fact that serology tests may have significant Type
II errors because of low sensitivity (especially in the first stage - 0 to 6 days - of infection,
[Roche, 2020]). Indeed, we find that Type II errors, which can be very costly when the
purpose is to diagnose individual infections, are not problematic for the purpose of estimating the epidemic state (which is aggregate information). For such purpose, detection
of recovered individuals is a more important feature than high sensitivity. Hence, serology
tests are an ideal complement to molecular tests for the purpose of estimating aggregate
infections—an intuition that is formally established by our mathematical analysis.
In addition to our main analysis, we consider two important extensions. First, we
study a variant of our baseline model of optimal testing in which both undetected and
detected infections have to be kept below a maximum threshold. In this case, the optimal
testing strategy is more complex. Nevertheless, we establish that the basic insights from
our baseline analysis generalize to this problem. Second, we recognize that in reality

2

the dynamics of epidemics are intrinsically stochastic. To confirm the robustness of the
proposed approach, we apply our testing methodology to a stochastic continuous-time
Markov chain model of epidemics and develop an extended Kalman filter [Khalil, 2015]
to estimate the epidemic state in the presence of stochasticity. To this end, we exploit
an expansion of the master equation governing the probability distribution of the Markov
chain model [van Kampen, 2007, Gardiner, 2009] to derive a description of the epidemic
dynamics in terms of a Langevin equation, whose mean coincides with the deterministic
SIR model used for computing the optimal testing strategy. The covariance matrix of the
noise term in the Langevin equation (which can be explicitly characterized as a function
of the epidemic state) is then given as input to the extended Kalman filter to optimally
incorporate new observations in the model predictions.
Our paper is related to the growing literature on SIR models, especially applied to
the recent COVID-19 pandemic. Classic references on the SIR model and its applications to model epidemics include [Kermack and McKendrick, 1927, Daley and Gani, 2001,
Diekmann and Heesterbeek, 2000, Keeling and Rohani, 2011, Andersson and Britton, 2012].
Additionally, see [Pastor-Satorras et al., 2015] for a review of models of epidemic processes
over networks and [Anderson and May, 1992, Nowzari et al., 2016] for analysis and control of epidemic models. Several papers developed more general compartmental models
for analyzing the spread of COVID-19 and examining the effects of interventions (see e.g.,
[Gatto et al., 2020, Atkeson, 2020, Stock, 2020, Cashore et al., 2020, Zhang et al., 2020,
Chinazzi et al., 2020]). Other papers, such as [Paré et al., 2017, Hota and Sundaram, 2019,
Paré et al., 2020, Hota and Gupta, 2020] analyzed the spread of epidemics over both timevarying and static networks.
Our work is more closely connected to a smaller literature that considers testing within
this framework. [Alvarez et al., 2020, Acemoglu et al., 2020a, Brotherhood et al., 2020]
consider testing in the context of optimal lockdown policies in SIR models (in the latter two papers with explicit recognition of heterogeneities across different age groups).
Neither of these papers studies optimal testing, nor discusses the problem of identifying
the underlying epidemic state, which is assumed to be known in this branch of the literature. [Acemoglu et al., 2020b] considers optimal testing in a simple model of disease
percolation, but their focus is on the countervailing effects that testing creates by discouraging social distancing among certain groups of individuals. Moreover, their analysis
is simplified by focusing on a non-SIR percolation model that enables explicit characterization and they do not discuss the issue of estimating the underlying epidemic state.
[Drakopoulos and Randhawa, 2020] studies settings where accurate tests are not available
in abundance. They show that moderately good tests provide enough information to have
a positive social outcome, and that it is not optimal to wait for tests with very high
accuracy. Similarly, [Larremore et al., 2020] compared molecular and antigen tests and
found that test sensitivity is less important than testing frequency for screening purposes.
[Kraay et al., 2020] suggests the use of serology testing to allow seropositive individuals
(i.e., individuals with immunity) to increase their level of social interaction. They conclude through extensive simulations that serology testing has the potential to mitigate the
impacts of the COVID-19 pandemic while also allowing a substantial number of individuals to safely return to social interactions and to the workplace. Information about the
epidemic state of individuals obtained through both qPCR and serology tests is used in
[Li et al., 2020a] to derive disease-dependent lockdown policies. [Vespignani et al., 2020]
highlights the need for integrating seroepidemiological data into transmission models to
reduce the uncertainty in the parameter estimates of clinical severity and transmission dynamics. [Behncke, 2000] studies the optimal testing policy when the objective is a weighted
combination of the cost of infection and testing with no constraints on the state variables.
They show that the optimal testing policy takes the maximal value until some time and

3

then zero after. The key novelty of our work is to suggest the combined use of serology
testing for the purpose of state estimation with molecular testing for optimal containment
of the number of infected within a desired thresholds, together with an analytic derivation
of the optimal adaptive testing rates.
In characterizing optimal controls in an SIR framework, our paper is related to a
few other papers that study optimal lockdown policies in SIR models. These include
[Miclo et al., 2020], which provides an analytical characterization of optimal lockdown
policies in a setting where suppression is costly and there is an upper bound on the number
of infections, representing a constraint on intensive care unit resources. Another related
paper in this regard is [Kruse and Strack, 2020] which studies optimal social distancing
measures to minimize a combination of the total health and economic cost of the infected
population and the cost of reducing the transmission rate. The key difference of our work
is that we focus on testing as a means to identify and isolate infected individuals instead
of lockdown policies that impose a degree of isolation to an entire community.
Finally, because of its analytical focus, our paper is distinguished from a large number
of recent papers that analyze intervention policies numerically (see e.g., [Zaman et al., 2008,
Sharma and Samanta, 2015, Di Giamberardino and Iacoviello, 2017, Farboodi et al., 2020],
[Gollier and Gossner, 2020], [Berger et al., 2020] among others). As detailed in the discussion section, we believe that the theoretical insights generated from our analysis of the
SIR model highlight fundamental mechanisms and properties related to the use of testing
as a tool for controlling an epidemic, that can then be generalized and refined to more
sophisticated models of specific epidemics as typically done in the numerical literature
above.

2
2.1

Results
Optimal adaptive testing strategies

We model the progression of the epidemic in a population via a Susceptible-InfectedRecovered (SIR) model with three compartments corresponding to susceptible, infected
and recovered individuals. Testing is introduced in the model by partitioning the infected
compartment into infected individuals that have not yet been detected and are free to
circulate, which we term infected-undetected (Iu ), and infected individuals that have been
detected and are therefore separated from the general population (e.g., quarantined),
which we term infected-detected (Id ) (see Fig. 1A). Infected-undetected individuals infect
susceptible ones with possibly time-varying transmission rate β(t), denoting the number
of contacts per unit time multiplied by the probability that a contact leads to infection.
For the purpose of controlling the epidemics, we assume that molecular testing (such as
qPCR) is performed at rate θ(t) and has sensitivity η, i.e., infected individuals who get
tested are detected with probability η. Individuals that test positive for the infection
are quarantined and moved to the infected-detected compartment. Infected individuals
become recovered with rate γ. The corresponding model equations are:
ds(t)
dt
diu (t)
dt
did (t)
dt
dr(t)
dt

= −β(t)s(t)iu (t)
= β(t)s(t)iu (t) − γiu (t) − ηθ(t)iu (t)
(1)
= ηθ(t)iu (t) − γid (t)
= γiu (t) + γid (t),

4

where small letters denote the fraction of individuals in each compartment. We assume
that the population size is constant with time, thus the last equation is redundant since
r = 1 − s − iu − id .
A. Model for the derivation of optimal testing policies

S

βsiu

Iu
ɣiu
R

ηθiu
ɣid
Id

B. Model for state estimation

S

βsiu

ɣiu

Iu

ηθiu

ηBIθBiu

Id

Ru

ηBRθBru
ɣid

Rd

Figure 1: The deterministic epidemiological models used for the derivation of optimal
testing policies (A) as discussed in Section 2.1 and for state estimation (B) as discussed
in Section 2.2. Individuals in the population are divided in compartments according to
their epidemiological state. In (A), Susceptible individuals (S) are infected via contact
with infected-undetected individuals (Iu ), which either transition to the infected-detected
(Id ) compartment if they are tested positive for infection, or to the Recovered (R) compartment if they recover from the infection before being tested positive. Infected-detected
individuals also recover from the infection. In (B), infected-undetected individuals (Iu )
can transition to the infected-detected state by being tested positive via either adaptive
molecular testing or baseline testing. Infected-undetected individuals can also transition
to the recovered-undetected (Ru ) compartment, if they recover from the infection before
being tested positive or displaying symptoms. With serology baseline testing, recoveredundetected individuals can transition to the recovered-detected compartment (Rd ) if they
are tested positive for past infection. Infected-detected individuals transition directly to
the recovered-detected compartment when they recover from the infection. Transitions
between compartments are indicated along with the corresponding rates, orange arrows
indicate transitions due to serology testing.
Subject to these dynamics, we aim at solving the following constrained optimization
problem:
Z ∞
min
θ(t)dt
θ(·)≥0
(2)
t=0
such that: iu (t) ≤ imax ∀t.
In words, our goal is to design the optimal adaptive testing rate to minimize the total
number of tests needed while controlling the epidemic so that the fraction of infectedundetected individuals always remains below a desired threshold imax  1. This constraint
5

is motivated by two considerations. First, infected-undetected individuals circulate freely
in the society and infect others, and thus a high number of such individuals would lead to a
rapid takeoff in infections. Second, because they do not receive care, undetected infected
individuals may later develop severe complications, and may need emergency intensive
care unit (ICU) capacity, which has proven to be in short supply during the COVID19 pandemic. The appropriate level of imax is a policy choice, and depends on several
factors, including whether policymakers are intending to keep the reproduction rate of the
pandemic below one and the maximum surge capacity of ICU resources.
Our first main result provides a complete characterization of the optimal adaptive
policy for problem (2). For simplicity we here discuss the case when the transmission rate
β is constant (i.e., β(t) = β for all times). In this case, we say that the system reaches
herd immunity when the epidemic state is such that s(t) = γ/β, as from that time on the
number of infected-undetected individuals decreases even without testing. We prove an
analogous theorem with time-varying monotonic β(t) in the Supplementary Materials.
Theorem 1. The optimal testing policy θ† (t) for problem (2) with dynamics as in Eq. (1)
and constant transmission rate β is described in three phases:
1. While iu (t) < imax , do not test, i.e., set θ† (t) = 0.
2. After iu (t) reaches imax , test with time-varying rate θ† (t) = (βs(t) − γ)/η.

Population fractions and rates (1/d)

3. Once herd immunity is reached, stop testing, i.e., set θ† (t) = 0.

s
iu
imax
θ†
(βs-ɣ)/η

1.0
0.8
0.6
0.4
0.2
0.0
0

20

40

60
Time (d)

80

100

120

Figure 2: Illustration of the optimal testing policy for problem (2). The green and lightblue curves are, respectively, the fractions of susceptible and infected-undetected individuals in the population. The fraction of infected-undetected iu is kept below the constraint
imax (black, dashed line) at all times by the optimal adaptive testing policy (red, dashed
curve), which is equal to zero until iu reaches imax , is then equal to (βs(t) − γ)/η (yellow
curve) until herd immunity is reached (i.e., when s(t) = γ/β), and is equal to zero afterwards. For illustration purposes, we set imax = 0.1 and η = 1, the other parameters are
as in Table 1.
As illustrated in Fig. 2, the optimal policy for problem (2) starts testing only once
the constraint on iu is attained, and then sets a time-varying rate (βs(t) − γ)/η such
that diu (t)/dt = 0, keeping the fraction of infected-undetected individuals constant at the
threshold imax until herd immunity is reached, after which there is no need for further
testing as the epidemic tends naturally towards extinction. Intuitively, given that no
testing is needed once herd immunity is reached, the optimal policy takes the form of
6

the most rapid approach path introduced in [Spence and Starrett, 1975] to reach herd
immunity as fast as possible, while satisfying the imax constraint. The testing policy
detailed above leads to the highest number of infected-undetected individuals by employing
no testing until undetected infections reach imax and then utilizing testing resources to
keep the infections at this threshold, thus guaranteeing the most rapid feasible path to
herd immunity.

2.2

State Estimation

The optimal adaptive testing policy θ† (t) derived in the previous section depends on
knowledge of the aggregate epidemic state, i.e., the values of s, iu , id and r at all times.
In practice, because this information is not readily available, the state of the epidemic
must be estimated from detected infections. Additionally, the policy makers must know
the model parameters. While many of such parameters are related to properties of the
disease, the transmission rate is a function of people’s behavior [Weitz et al., 2020], is
typically time-varying and needs to be estimated from data. This is a nontrivial problem,
since the dynamics induced by the SIR model is highly nonlinear and a given path of
infections can be due to different β(t) trajectories coupled with different initial conditions.
To address these problems, we propose the use of baseline testing with a constant rate
θB to complement the adaptive testing policy derived above, see Fig. 3. Importantly, the
objective of baseline testing is not to control the epidemic, but rather to collect enough
data to robustly estimate the state of the epidemic and the parameter β(t). The policy
maker can then use the estimated state and parameter to implement the optimal adaptive
policy discussed in Section 2.1.
Baseline testing

✓B
Epidemic Dynamics

✓ˆ† (t)
Optimal testing

id (t)
rd (t)

îu (t)

State estimator

ŝ(t)

Figure 3: Schematic of the proposed procedure. Measurements of detected-infected and
detected-recovered individuals (id (t), rd (t)) as defined in Eq. (3) obtained via baseline
testing with rate θB are used to estimate the aggregate epidemic state (ŝ(t), îu (t)), which
is then used to compute the optimal adaptive testing rate (θ̂† (t)) according to the results
of Theorem 1 (the hat symbol denotes the fact that the optimal testing rate is evaluated
as a function of the estimated state). The objective of adaptive testing is to contain the
fraction of infected-undetected individuals below the desired threshold imax .
We next argue that state estimation may be infeasible with molecular testing, which
is highly sensitive but detects infections only during a short window of time. Intuitively,
detection of current infections from molecular testing is not always sufficient to identify
whether a given trajectory of infections is due to a particular time path of β(t) coupled
with a given set of initial conditions, or to a different time path of transmission coupled
with a different set of initial conditions. In contrast, such identification is always possible
with baseline serology testing.
To illustrate these points, we consider a more detailed model where we partition the
recovered population into recovered-undetected (Ru ), consisting of individuals who had
the disease but are not recorded as having immunity (because they were not diagnosed
7

with either test) and recovered-detected (Rd ), which consists of individuals that are known
to have immunity because they were either detected during their illness or at a later time
(via serology testing). Correspondingly, we consider an augmented model that includes
both adaptive and baseline testing with different sensitivities (Fig. 1B). All individuals
are tested via adaptive molecular testing with rate θ(t) and sensitivity η, and via baseline
testing with sensitivity ηBI for the detection of current infections and ηBR for the detection
of past infections. The model equations read:
ds(t)
= −β(t)s(t)iu (t)
dt
diu (t)
= β(t)s(t)iu (t) − γiu (t) − ηθ(t)iu (t) − θB ηBI iu (t)
dt
did (t)
(3)
= ηθ(t)iu (t) + θB ηBI iu (t) − γid (t)
dt
dru (t)
= γiu (t) − θB ηBR ru (t)
dt
drd (t)
= γid (t) + θB ηBR ru (t),
dt
where the last equation is redundant since rd = 1 − s − iu − id − ru .
We use the more detailed model in Eq. (3) to study the system’s observability, that is,
the question of whether an outside observer or policymaker can estimate the underlying
state from detected cases. We prove that even when id (t) is observed perfectly and continuously in time but there is no detection of recovered individuals, the underlying state
cannot always be estimated (see Lemma 1 in the Materials and Methods Section 4.3). Instead, we prove that when serology testing is used, which allows the correct reconstruction
of the time path of both id (t) and rd (t) via observations of both ongoing and past infections, the underlying state can always be estimated (see Lemma 2 in the Materials and
Methods Section 4.3). This result does not depend on the frequency of baseline testing,
nor on the exact sensitivity of serology testing.

2.3

Extensions

In the previous sections we presented a rigorous analysis of optimal testing and observability for a simple yet insightful deterministic SIR model. Such results are derived under the
assumption of perfect and continuous time observations. We next discuss some extensions
to account for non-idealities encountered in practice.
First, we consider a model where individuals are detected not only via the testing
program but also because they may become symptomatic. Specifically, we assume that
infected-undetected individuals may develop symptoms and thus become infected-detected
with rate κ (this leads to an additional flow from infected-undetected to infected-detected
with rate κ as detailed in Eq. (S4) in the Supplementary Materials). Accordingly, we
consider a variant of the original optimization problem where the constraint is imposed on
the total number of infected individuals, instead of infected-undetected individuals only.
We also impose a constraint on the maximum testing rate, modeling daily limitations
in processing capacity. Overall, this results in the following extended optimal control
problem:
Z
∞

min

θ(·)≥0

such that:

θ(t)dt
t=0

iu (t) + id (t) ≤ imax
θ(t) ≤ θmax
θ∗ (t)

∀t

(4)

∀t.

To find the optimal adaptive testing policy
for the extended problem of Eq. (4),
we adopted a numerical approach using the interior point optimizer library within the
8

1.0

0.100

0.8

s
i
imax
θ*
(β(s-iu)-ɣ-κ)/η

0.6
0.4

i, imax

Population fractions and rates (1/d)

GEKKO optimization suite [Beal et al., 2018, Wächter and Biegler, 2006]. The optimal
testing policy, computed numerically using parameters taken from the literature on the
COVID-19 epidemic (see Materials and Methods Table 1 and Section 4.7) is shown in
Fig. 4. Remarkably, the optimal adaptive testing policy for the extended optimization

0.098
0.096 tD

tE

60

70
80
Time (d)

90

0.2
0.0

tA tB
0

20

tC tD
40

60
Time (d)

tE
80

100

120

Figure 4: Optimal testing strategy for the extended problem (4). The green and blue
curves are, respectively, the fractions of susceptible and infected individuals in the population, respectively. The black, dashed line represents the constraint on the total fraction
of infected individuals, i = iu + id ≤ imax . The optimal testing policy (red, dashed curve)
is equal to zero at first, switches to its maximum value θmax at time tA , such that iu + id
reaches the constraint imax with zero derivative at time tB . Between times tB and tC , the
optimal testing policy is equal to (β(s(t) − iu (t)) − γ − κ)/η (yellow curve), which keeps
iu + id = imax . At time tC , the optimal testing policy switches back to θmax until time
tD , after which it is equal to zero. The times tC and tD are such that, after tD , the total
fraction of infected individuals grows initially, reaching the constraint imax tangentially
(inset), and then decreases to zero. The switching times can be computed analytically,
given the initial condition (as discussed in the Supplementary Materials). For illustration
purposes, we set imax = 0.1 and η = 1, while the other parameters are as in Table 1.
problem of Eq. (4) follows the same principle as the optimal testing policy for the original
optimization problem of Eq. (2), that is, it aims at keeping the constrained quantity (iu for
Eq. (2) and iu +id for Eq. (4)) at the threshold imax for as long as possible, in order to bring
the epidemic as fast as possible to a point after which it naturally goes to extinction. Two
differences arise in the testing policy that optimizes the modified problem (4). First, in the
original problem, one can afford to delay testing right until the time at which iu reaches
the constraint imax . This is possible because in the original model the first derivative
of the constrained quantity, diu /dt = iu (βs − γ − ηθ), depends explicitly on the testing
frequency θ, and thus one can set the testing rate to θ = (βs − γ)/η to instantaneously
ensure diu /dt = 0. In the extended model, instead, the first derivative of the constrained
quantity iu +id does not depend directly on the testing frequency θ. Therefore, one cannot
instantaneously impose d(iu +id )/dt = 0 and thus testing must start before the constrained
quantity iu + id reaches the threshold imax . The optimal testing policy thus switches from
θ = 0 to θ = θmax at a time tA (for which iu (tA ) + id (tA ) < imax ) such that iu + id reaches
imax with zero derivative at time tB > tA (Fig. 4). After time tB , the optimal testing
strategy switches to a frequency that maintains iu + id at the imax value (the specific rate
can be computed from equating the second derivative of iu + id to zero). Second, iu + id
can naturally decrease even before herd immunity if id > 0. For this reason, towards the
end of the epidemic the optimal testing policy for the extended problem of Eq. (4) adopts
a second phase with maximal testing frequency θmax that decreases iu and increases id up
9

to a point when, if testing is stopped, iu + id naturally remains below the threshold imax
for all subsequent times (it increases initially but again reaches the threshold tangentially,
see inset of Fig. 4). The switching times can be characterized analytically as discussed in
the Supplementary Materials.
Next, we allow the dynamics of the epidemic to be governed by a stochastic process
rather than a deterministic (albeit time-varying) one. This is, of course, more realistic
given the stochastic nature of transmissions and the time-varying and stochastic transition
of individuals across different compartments. Additionally, we assume that observation of
detected cases happens at discrete time instants (e.g. daily) instead of continuously. To
deal with this type of non-idealities and stochasticity in our state estimation, we propose
the use of a state-estimator which, given observations at discrete time instants tk , produces
estimates of the state of the system (denoted by ŝ, ı̂u , ı̂d , r̂u , r̂d ), which can then be used
to implement the adaptive testing policy. For the purpose of this analysis, we assume that
β is known and constant, and use an extended Kalman filter with state constraints as state
estimator (Materials and Methods Section 4.5) coupled with a system size expansion of the
master equation governing the probability distribution of the stochastic model to derive
the dependence of process noise on the epidemic state and population size (Materials
and Methods Section 4.4). Extensions to unknown and time-varying β are discussed
in the Supplementary Materials Section S.5. To validate our procedure in the presence
of non-idealities, we used a receding horizon implementation θ̂∗ of the optimal testing
policy derived for the deterministic SIR model (see Materials and Methods Section 4.6).
Fig. 5A shows the performance of the state estimator and of the adaptive testing policy
for multiple stochastic realizations with θB = 1/14 d−1 (where d stands for day). The
extended Kalman filter provides good estimates (black, dashed curves in Fig. 5C-D) of
the real state of the epidemic (blue and orange curves), which lies within the confidence
bounds of the estimate. In addition, the time-varying testing rate implemented using the
estimated state is effective in maintaining the number of infected individuals around the
desired threshold Imax = N imax (where N is the population size). Fluctuations of order
√
N around such threshold are to be expected as the epidemic is simulated as a stochastic,
Markov process (Materials and Methods Section 4.4). Finally, we show that the mean of
the receding horizon testing policy, computed across realizations of the stochastic model
of epidemics, follows the optimal policy derived for the deterministic SIR model (Fig. 5B).

3

Discussion

A major lesson from the recent COVID-19 crisis is that, in the absence of comprehensive
vaccines and therapeutic solutions, rapid testing and isolation become crucial tools to
contain the spread of a pandemic. In this paper, we developed an approach to determine
an optimal testing strategy, relevant especially when there are scarce or expensive testing
resources.
Our approach has two basic pillars. First, we showed that, in the context of a classic SIR model, when the epidemic state in terms of infected, recovered and susceptible
individuals is known and the objective can be formulated as keeping the number of undetected infections below a certain threshold, then the optimal testing strategy takes a
simple form, similar to a most rapid approach path. In particular, there should be no
testing until the aforementioned threshold is reached, and thereafter, testing resources
should be used to keep infections at this threshold until herd immunity is reached and the
epidemic starts disappearing naturally. The standard molecular tests, which have high
accuracy, are crucial for this result, because they enable the identification and isolation of
infected individuals.
The second pillar of our approach turns to the identification of the epidemic state. Our
10

B 0.3

A

I
Iu
I, Iu
Imax
95% CI
(β(S - Iu )/N-ɣ-κ)/η
θ*̂
θmax

1200
0.2
800
θ

Iu(t) , I(t)

1000

600

0.1

400
200
0
0

200

400

0
0

600

200
Time (d)

Time (d)

400

D 400

C
1200

300

800

Iu(t) , I(t)

Iu(t) , I(t)

1000

200

600
400

I
Iu
Imax
I,̂ Iû
95% CI

100

200
0
0

200

400

600

Time (d)

0
0

5

10 15
Time (d)

20

25

Figure 5: Control of stochastic trajectories by using a receding horizon version of
the optimal testing policy θ∗ in combination with baseline serology testing with rate
θB = 1/(14 days). Panel A shows the mean number of infected-undetected individuals
hIu (t)i (blue, thick curves), the mean total number of infected individuals hI(t)i (orange,
thick curves) across 500 realizations and Iu (t), I(t) in five, randomly selected stochastic
trajectories (solid, thin lines). Note that capital letters denote absolute numbers instead
of fractions of individuals. Colored bands are 95% empirical confidence intervals and the
thick, yellow lines show the value of Imax . Panel B shows the mean molecular time-varying
testing rate in the simulations (thick, green curve) and its 95% confidence interval. The
dotted, black line shows (β(hSi − hIu i)/N − γ − κ)/η, which is the functional form of the
optimal adaptive testing rate θ∗ (t) for the deterministic SIR model in the interval [tB , tC ]
(Eq. S11). The black, dashed line shows the maximum testing rate θmax . Panel C shows
the number of infected-undetected individuals Iu (t) (blue curve) and the total number of
infected individuals I = Iu (t) + Id (t) (orange curve) in a single realization. The estimated
number of infected-undetected individuals Iˆu (t) and estimated total number of infected
ˆ are shown with black, dashed curves. The 95% confidence intervals for
individuals I(t)
ˆ
ˆ
Iu (t) and I(t) computed using the predicted variance estimated according to the extended
Kalman filter are shown as colored bands. The infected threshold value Imax is shown as
a yellow line. Panel D shows a zoom of the initial phases of the epidemic highlighting the
accuracy of the Kalman filter estimates. Model parameters and initial conditions are as
in the Materials and Methods Table 1 and Section 4.7.

11

optimal testing policy crucially depends on such knowledge, but where does this knowledge
come from? We tackle this question by adopting a state estimation framework, where the
underlying state is unknown but can be estimated from the sequence of infections and
additional information obtained from testing. Though molecular tests are also useful in
this context (because they reveal the trajectory of infections), our main result in this part
is that this information by itself is not sufficient for identifying the underlying state. This
is because the dynamics of the SIR model are highly nonlinear and dependent on initial
conditions, and it is not always possible to tell apart whether a given sequence of infections
is due to one of many time-varying paths of transmission rates coupled with different initial
conditions. Instead, we showed that serology testing which is lower-accuracy, cheaper and
longer-range (in terms of estimating past infections) can be useful to disentangle this
information.
More specifically, we proposed a two-pronged approach in which baseline serology
testing is used to collect information about the state of the epidemic, and the more costly
and sensitive molecular testing is adaptively deployed based on such information (Fig. 3).
Our analysis formalizes the notion that serology offers advantages as a baseline testing
tool not only because of cost benefits, but also because it conveys information about past
infections, which proves fundamental to correctly and timely estimate the state of the
epidemic. We then showed that, based on information about the state of the epidemic,
optimal adaptive molecular testing can be adopted and implemented.
Inevitably for a mathematical analysis based on a stylized model, our approach simplified many aspects of the problem. Our extensions dealt with two such aspects. First, we
showed that similar insights apply in the context of an SIR model in which both detectedinfected and undetected-infected numbers have to be kept below a certain threshold. Second, our state estimation techniques apply even when we are dealing with a stochastic
model of epidemics.
Our analysis suggests that there are tangible gains from the proposed approach. Fig. 6
shows that our two-pillar approach with state estimation plus optimal testing can lead to
significant reductions of overall cost with respect to constant testing strategies, leading to
up to 60% cost reduction for the parameters we investigated.
In concluding, we make three additional remarks. First, optimality of the proposed
approach is claimed in terms of the problems formulated in Eqs. (2) and (4) where the
only epidemic constraint comes from keeping infections below a desired threshold imax .
Strategies that achieve such an objective are typically classified as “containment strategies”, since their objective is to contain the disease to a state that can be handled by
the health system. This is very different from “eradication strategies” where instead the
objective is to eradicate the disease as fast as possible. It is important to note that the
more costly constant testing strategy detailed in the Materials and Methods Section 4.2
would lead to faster eradication of the disease than the adaptive strategy suggested here,
but testing would need to continue indefinitely to ensure that outside infections would not
create further waves, as for the parameters considered in the simulations herd immunity
is not reached before eradication under constant testing. Whether eradication or containment strategies should be preferred depends on considerations about testing availability,
possible long-term effects of infections on the health of individuals [Davis et al., 2020] and
the impact of the epidemic on the economy, and is outside of the scope of this work. Our
objective here was to derive the optimal containment strategy for cases when eradication
is simply not possible, e.g., because of test scarcity or budget limitations.
Second, we derived our results for a standard SIR model (yet with extensions to testing
and symptomatic individuals). Our objective was to derive analytic insights for a model
of epidemics that is general enough to encode the core traits of an epidemic without
getting lost in the details of specific diseases. Clearly, caution is required when applying

12

Cost relative to optimal
constant testing strategy

0.4

0.3
Total cost
qPCR cost
Serology cost
95% CI

0.2

0.1

0

10

15

20
25
Baseline Δt (1/θB)

30

Figure 6: Cost of the optimal testing policy for the optimization problem 4, as a function
of different baseline testing rates θB . Costs are normalized with respect to the cost of
the constant testing policy with the minimum testing frequency required to maintain the
constraints Iu + Id ≤ Imax at all times (Materials and Methods Section 4.2). Data points
connected by straight lines are mean statistics across 1000 simulations of the stochastic
trajectories. Shaded bands represent 95% confidence intervals. Orange and black data
points report the relative contribution of adaptive qPCR testing and baseline serology
testing to the total cost (blue points), respectively. All adaptive policies induce significant
cost savings, up to 60% reduction with respect to the cost under the optimal constant
testing strategy derived in Section 4.2 for the parameters investigated. Model parameters
and initial conditions are as in the Materials and Methods Table 1 and Section 4.7.
our findings in the field and additional steps are needed to validate our suggestions with
detailed models of any specific disease before translation to practice. We note especially
that we did not account explicitly for delays due to test processing time in our model.
However, the fact that serology has typically a faster turnaround time than qPCR is an
additional argument in support of serology as a baseline testing tool.
Finally, we investigated the robustness of our procedure to sources of stochasticity
that are intrinsic to the spread of an epidemic, and found that using information on
the expected scaling of fluctuations with the population size and the state of the epidemic, one can apply the testing strategies developed for the deterministic SIR model
to control epidemics even in the presence of intrinsic stochasticity. In practical applications, one may encounter additional sources of exogenous stochasticity due to people’s
behavioral responses, changes in policies, infections coming from external sources such
as neighboring states, seasonal changes, etc. We believe that a dual approach where
our theoretical results are used as a guideline for formulating candidate policies that are
then tested extensively with numerical approaches adopting an ensemble of models (as in
[Ray et al., 2020, Viboud and Vespignani, 2019]) would be a powerful tool in the control
of future pandemics.

4
4.1

Materials and Methods
Model parameters

In our numerical studies, we used model parameters that have been used in the literature
to describe the spread of COVID-19. Table 1 reports the parameter values, along with
the corresponding sources. Note that we decided to use low sensitivity both for molecular
13

and serology testing to be conservative and to account for the fact that infected agents in
the initial incubation period may not be detectable.
Parameter
Transmission rate (β)

Value
0.3 d−1

Recovery rate (γ)
Rate of symptoms development (κ)

1/14 d−1
0.04 d−1

qPCR sensitivity (η)
Serology sensitivity (current infections) (ηBI )

0.9
0.6

Serology sensitivity (past infections) (ηBR )

0.8

Cost of serology relative to qPCR (cser )

0.4

Maximum adaptive testing rate (θmax )

2/7 d−1

Sources
[Della Rossa et al., 2020]
[Gatto et al., 2020]
[Bertozzi et al., 2020]
[Della Rossa et al., 2020]
[McAloon et al., 2020]
[Gatto et al., 2020]
[Watson et al., 2020]
[Roche, 2020], [FDA, 2020]
[Public Health England, 2020]
[Roche, 2020], [FDA, 2020]
[Public Health England, 2020]
[Haseltine, 2020a]
[Haseltine, 2020b]
[Cashore et al., 2020]

Table 1: Parameter values and corresponding sources. Our estimate for β is a compromise
between different estimates reported in the literature on COVID-19. The rate of symptoms
development κ was estimated as the product of the probability of becoming symptomatic,
times the incubation rate.

4.2

Constant testing strategy

One possibility for controlling an epidemic with a constant testing rate is selecting a value
of the testing rate θconst that guarantees a basic reproduction number [Daley and Gani, 2001]
smaller than unity. For the model with symptomatic agents (Supplementary Materials
Eq. S4) the basic reproduction number is
R0 =

β
,
γ + κ + ηθconst

corresponding to the number of secondary infections generated by an individual when
he/she is free to circulate and the rest of the population is made entirely of susceptible
individuals. Setting the basic reproduction number to unity and solving for θconst leads
to a testing rate guaranteeing that the number of infected undetected is monotonically
decreasing. This is a more restrictive condition than what is needed to satisfy the constraint iu + id ≤ imax in Problem (4). Indeed, a lower testing rate for which the fraction of
infected-undetected initially increases but reaches the constraint imax tangentially would
suffice. To be fair in the comparison with the adaptive testing policy, we next derive
such lower constant testing rate as a function of the fractions s0 and i0 of susceptible and
infected individuals (all assumed to be undetected) at time t = 0. Note that to satisfy the
constraint with the least amount of constant testing, θconst should be such that i = iu + id
reaches the constraint imax tangentially (i.e., only once at time t̄ with first derivative
equal to zero). Our objective is to derive a series or relations between the initial state
(s(0), iu (0), id (0)), the state at time t̄ (i.e., s(t̄), iu (t̄), id (t̄)), and the testing rate θconst .
We then exploit these relations to solve for θconst . From the discussion above we have
iu (t̄) + id (t̄) = imax

14

(5)

and

di(t̄)
= βs(t̄)iu (t̄) − γi(t̄) = βs(t̄)iu (t̄) − γimax = 0.
(6)
dt
Next, by Eq. (1) it holds ds(t)/dt = −βs(t)iu (t) and did (t)/dt+dr(t)/dt = (ηθconst +γ)iu (t)
leading to
d(id (t) + r(t))
β
1 ds(t)
+
= 0.
s(t) dt
(ηθconst + γ)
dt
Integrating this equation we can derive a constant of motion for the epidemic which leads
to the following relation between the epidemic state at time zero and at time t̄:


s(t̄)
β
ln
−
(s(t̄) + iu (t̄) − s0 − i0 ) = 0.
(7)
s0
γ + ηθconst
Finally, integrating did (t)/dt = ηθconst iu (t) − γid (t) in the interval [0, t̄] we obtain
id (t̄) = ηθconst e

−γ∆t(s(t̄),s0 ,i0 )

Z

s0

s(t̄)

eγ∆t(s,s0 ,i0 )
ds = imax − iu (t̄),
βs

(8)

where we used id (0) = 0 and a reformulation ∆t(s̃, s0 , i0 ) of the time interval such that
s(∆t) = s̃ as a function of the epidemic state as introduced in [Harko et al., 2014] and
detailed in Supplementary Materials Eq. (S6). Solving Eqs. (5)-(8) for the unknowns
s(t̄), iu (t̄), id (t̄), θconst leads to the minimum constant testing rate θconst that ensures i(t) =
iu (t) + id (t) ≤ imax for all t.

4.3

Observability notions

We formally define observability for a parametric system as follows.
Definition 1. A dynamical system dx(t)/dt = g(x(t), β(t)) with state x(t) and timevarying parameter β(t) is observable from the output y(t) = h(x(t)) if for any two observed
outputs y1 (t) and y2 (t), the condition y1 (t) ≡ y2 (t) for all t implies x1 (0) = x2 (0) and
β1 (t) ≡ β2 (t) for all t.
Lemma 1 (Observability from molecular testing). Consider the system of Eq. (1) with
state x(t) = [s(t), iu (t), id (t), r(t)] and continuous time output y(t) = id (t). Suppose that
ηθ(t) > 0 for all t and that γ is known.
1. If β(t) ≡ β, the system is observable.
2. If β(t) is time-varying, the system is not observable.
Lemma 2 (Observability from serology testing). Consider the system of Eq. (3) with
state x(t) = [s(t), iu (t), id (t), ru (t), rd (t)] and continuous time output y(t) = [id (t), rd (t)].
If ηθ(t) + ηBR θB > 0 and γ is known, the system is observable.
The proofs of these lemmas are provided in the Supplementary Materials.

4.4

Stochastic model

We performed stochastic simulations of a compartmental model of epidemics in which
individuals of a population of size N are assigned to the same compartments S, Iu , Id , Ru
and Rd as in the deterministic SIR model with symptomatic individuals (Supplementary

15

Materials Eq. (S4)). In analogy with the deterministic SIR model, transition rates among
states are set to:
SIu
N
W (S, Iu − 1, Id , Ru + 1|S, Iu , Id , Ru ) = γIu

W (S − 1, Iu + 1, Id , Ru |S, Iu , Id , Ru ) = β

W (S, Iu − 1, Id + 1, Ru |S, Iu , Id , Ru ) = [ηθ + κ + θB ηBI ] Iu
W (S, Iu , Id − 1, Ru |S, Iu , Id , Ru ) = γId
W (S, Iu , Id , Ru − 1|S, Iu , Id , Ru ) = θB ηBR Ru

(new infection)
(recovery of Iu )
(detection of Iu )
(recovery of Id )
(detection of Ru )

where W (X 0 |X) is the probability per unit time of transitioning from state X to state X 0
and the parameters have the same interpretation as in the deterministic SIR model, and
capital letters S, Iu , Id and Ru indicate the absolute number of individuals in the various
compartments of the stochastic model. The compartment Rd is not mentioned explicitly,
as its abundance is equal to N − S − Iu − Id − Ru . Unlike the deterministic SIR model,
the stochastic model of epidemics accounts for the fact that the numbers of individuals in
each compartment are integers and that infection, recovery and detection are stochastic
events. As such, the stochastic model is better suited to describing epidemics in small
populations or the epidemiological dynamics in the initial phases of an epidemic, where
number fluctuations can be important. The dynamics of the stochastic model is governed
by the master equation, [van Kampen, 2007, Gardiner, 2009]:

 SIu

∂P
−1
−1
(S, Iu , Id , Ru , t) = E+1
+ E+1
S EIu − 1 β
Iu ERu − 1 γIu +
∂t
N




+1 −1
(9)
+ EIu EId − 1 Iu (ηθ + κ + θB ηBI ) + E+1
Id − 1 γId +


+ E+1
Ru − 1 θB ηBR Ru P (S, Iu , Id , Ru , t),
where P (S, Iu , Id , Ru , t) is the probability of being in state X := [S, Iu , Id , R] at time t
±1
and the transition operator E+1
S is defined by ES f (S, Iu , Id , Ru ) = f (S ± 1, Iu , Id , Ru ) for
a generic function f , and similarly for the other operators.1 We simulated trajectories of
the stochastic model of epidemics by using the Gillespie algorithm [Gillespie, 1976], with
the parameters reported in Table 1.
For large N , Eq. (9) can be expanded in powers of 1/N following a Kramers-Moyal or
system-size expansion [van Kampen, 2007, Gardiner, 2009]. Eq. (9) can be expressed in
terms of the rescaled variables x̃ := X/N = [s̃, ĩu , ĩd , r̃u ] as follows:




1
1
1
1
1 ∂p
+N
−N
+N
−N
(s̃, ĩu , ĩd , r̃u , t) =
Es̃ Eĩ − 1 βs̃ĩu + Eĩ Er̃u − 1 γ ĩu +
u
u
N ∂t




1
1
1
+N −N
+N
+ Eĩ Eĩ − 1 ĩu (ηθ + κ + θB ηBI ) + Eĩ − 1 γ ĩd + (10)
u
d
d



+1
+ Er̃uN − 1 θB ηBR r̃u p(s̃, ĩu , ĩd , r̃u , t).
Note that x̃(t) is a stochastic process, whereas x(t) as defined in the main text is the
solution to the deterministic SIR model. The right hand side of Eq. (10) is a function of
x̃ ± 1/N . Expanding this function around x̃ up to the second order (1/N 2 ), one obtains
1

In Eq. (9), operators within parentheses act on all the functions
 of state variables to their right
− 1 SIu P (S, Iu , Id , Ru , t) is to be inaccording to conventional operator precedence, e.g.
E+1
E−1
S
I
u

−1
+1 −1
terpreted as E+1
S EIu −1 SIu P (S, Iu , Id , Ru , t) = ES EIu (SIu P (S, Iu , Id , Ru , t)) − SIu P (S, Iu , Id , Ru , t)
= (S + 1)(Iu − 1)P (S + 1, Iu − 1, Id , Ru , t) − SIu P (S, Iu , Id , Ru , t).

16

the Fokker-Planck equation:
X ∂
1 X ∂2
∂p
(gj (x̃, θ)p(x̃, t)) +
(x̃, t) = −
(Bjk (x̃, θ)p(x̃, t)) ,
∂t
∂ x̃j
2N
∂ x̃j ∂ x̃k
j

(11)

j,k

where g is the vector field corresponding to the deterministic dynamics used for computing
the optimal testing strategy (see Eq. (4) and Eq. (S4) in the Supplementary Materials)
and B is the matrix:


βs̃ĩu

−βs̃ĩu

0

− [ηθ + κ + θB ηBI ] ĩu
 −βs̃ĩu [βs̃ + γ + ηθ + κ + θB ηBI ] ĩu
B(x̃, θ) = 
0
− [ηθ + κ + θB ηBI ] ĩu
[ηθ + κ + θB ηBI ] ĩu + γ ĩd
0

−γ ĩu

0

0
−γ ĩu

.
0
γ ĩu + θB ηBR r̃u

Eq. (11) is known as the diffusion approximation of the master Eq. (10) and describes
the probability distribution of a continuous stochastic process specified by the following
Itô Langevin equation: [van Kampen, 2007, Gardiner, 2009]
dx̃
1
= g(x̃, θ) + √ ε(x̃, θ, t),
dt
N

(12)

where ε(x̃, θ, t) is a Gaussian noise with covariance hεj (x̃(t), θ(t), t)εk (x̃(t0 ), θ(t0 ), t0 )i =
Bjk (x̃(t), θ(t))δ(t − t0 ) and zero mean, where δ is the Dirac delta. Intuitively, in Eq. (12)
the first term g(x̃, θ) coincides with the vector field of the deterministic dynamics while the
second term captures diffusive fluctuations due to stochasticity, whose amplitude depends
both on the population size and on the epidemic state. As detailed in the next section,
this approach enables us to characterize the process noise for the extended Kalman filter
with the correct scaling in N and highlights its dependence on the current epidemic state
(e.g., the number of infected-undetected) as captured by the matrix B.

4.5

State estimation for the stochastic simulations

Given the dynamics of Eq. (12), we discuss here how we estimate the state of the epidemic.
We assume the following observation model:
ỹ(tk ) = [ĩd (tk ); r̃d (tk )] = C x̃(tk ) + c
with:


C=

0
0
0
1
−1 −1 −1 −1




,

c=

(13)
0
q


,

that is, only infected-detected and recovered-detected are observed, and we assume discrete observation times tk (e.g., daily observations). Such observations can be used to
estimate the state of the system via a state observer, which we implemented using an
extended Kalman filter with state constraints (see [King et al., 2008, Pasetto et al., 2017,
Pasetto et al., 2018, Li et al., 2020b] for other applications of the Kalman filter in the
context of epidemiology).
In a Kalman filter, observations yk = ỹ(tk ) are used to create an estimate of the
state, denoted by x̂(t) = [ŝ(t); îu (t); îd (t); r̂u (t)]. The first step is to initialize x̂0|0 =
E[x(t0 )], P0|0 = E[(x(t0 ) − x̂(t0 ))(x(t0 ) − x̂(t0 ))> ]. Then, the dynamics of the extended
Kalman filter [Khalil, 2015] is computed as follows, at any time step tk :
1. Predict the next state, given previous observations:

dx̂(t)
(


= g(x̂(t), θ(t))
x̂(tk ) = x̂k|k
∂g
dt
with
and G(t) =

dP
(t)
∂x
P (tk ) = Pk|k

= G(t)P (t) + P (t)G(t)> + Q(t)
dt
17

x̂(t),θ(t)

and set x̂k+1|k = x̂(tk+1 ), Pk+1|k = P (tk )
2. Update the prediction, given the current observation:
Kk+1 = Pk+1|k C > (CPk+1|k C > + R)−1
x̂k+1|k+1 = ΠXk+1 [x̂k+1|k + Kk+1 (yk+1 − C x̂k+1|k )]
Pk+1|k+1 = (I − Kk+1 C)Pk+1|k ,
where ΠXk represents the projection in the feasible set Xk = {x ≥ 0 | Cx + c = yk }.
The matrices Q and R are covariance matrices for the process and measurement noise.
In our analysis, we assume R = 0 (as the number of infected-detected and recovereddetected is perfectly know by the policy maker and thus there is no measurement error
in Eq. (13)), while Q(t) is the covariance of the process noise, which is equal to B/N as
derived from the expansion of the master equation in Section 4.4.

4.6

Testing strategy for the stochastic simulations

The testing policy derived for the deterministic SIR model is not necessarily robust to
the presence of stochastic fluctuations. For this reason, in the stochastic simulations we
implemented a receding horizon version θ̂∗ (t) of the testing policy where at any time
tk > tA (as defined in Fig. 4) we computed the constant testing rate needed to drive
the total fraction of infected to the threshold imax in a horizon of H days (we set H = 3
d), assuming that the dynamics follows the deterministic SIR model, i.e. Eq. (S4) in the
Supplementary Materials. According to the principles of receding horizon control, such
testing rate is applied for one time step and then a new problem is solved for the next
horizon [tk+1 , tk+1 + H] given the new realized state. Thus, at every time step tk the
testing rate is set to:
(
0
if tk < tA
θ̂∗ (tk ) =
(14)
max({0, min{θmax , θrh (ŝ(tk ), îu (tk )}}) otherwise
where θrh is the testing rate that would bring the deterministic system to the constraint
iu + id = imax with zero derivative in a time horizon H, starting from ŝ(tk ) and îu (tk ) (see
Eq. (S16) in the Supplementary Materials). Note that we assume here that the receding
horizon is implemented for any time tk > tA , where tA is the optimal time to start testing
as computed for the deterministic SIR model. In practice, the policy maker may prefer to
implement the receding horizon control from the beginning, for additional robustness and
to compensate for the uncertainty of state estimates in the early phases of the dynamics.
This has a minor cost implications, since tA is typically very small with the parameters
considered here.

4.7

Parameters used in simulations of the stochastic model of epidemics

Simulations of the stochastic model of epidemics were performed with population size
N = 50000 and constraint Imax = 1000 corresponding to 2% of the population size. This
percentage was chosen for illustration purposes and it roughly corresponds to the peak
percentage quarantine capacity estimated to be required for the safe reopening of Cornell’s
Ithaca NY campus during the COVID-19 pandemic in the Fall 2020 [Cashore et al., 2020].
Realizations of stochastic epidemics were initialized with I(0) = Iu (0) = 50 infected
and S(0) = N − 50 susceptible individuals (the other compartments were initialized at
Id (0) = Rd (0) = Ru (0) = 0). The other parameters were set to the values in Table 1.
ˆ = 0 infected and
The initial state estimate for the extended Kalman filter was set to I(0)
18

Ŝ(0) = N susceptible individuals (the estimates for the other compartments were set to
zero). All entries of the initial estimate for the covariance matrix P (see Section 4.5) of
the extended Kalman filter were set to zero, with the exception of the estimate for the
2 /12, to reflect a large uncertainty on
variance of Ŝ(0) and of Iˆu (0), which were set to Imax
the initial condition.

References
[AACC, 2020] AACC (2020). Coronavirus testing survey. Technical report, American
Association for Clinical Chemistry. https://www.aacc.org/science-and-research/
covid-19-resources/aacc-covid-19-testing-survey.
[Acemoglu et al., 2020a] Acemoglu, D., Chernozhukov, V., Werning, I., and Whinston,
M. D. (2020a). Optimal Targeted Lockdowns in a Multi-Group SIR Model. Working
Paper 27102, National Bureau of Economic Research.
[Acemoglu et al., 2020b] Acemoglu, D., Makhdoumi, A., Malekian, A., and Ozdaglar,
A. E. (2020b). Testing, Voluntary Social Distancing and the Spread of an Infection.
Working Paper 27483, National Bureau of Economic Research.
[Alvarez et al., 2020] Alvarez, F. E., Argente, D., and Lippi, F. (2020). A simple planning
problem for covid-19 lockdown. Working Paper 26981, National Bureau of Economic
Research.
[Anderson and May, 1992] Anderson, R. M. and May, R. M. (1992). Infectious Diseases
of Humans: Dynamics and Control. Oxford university press.
[Andersson and Britton, 2012] Andersson, H. and Britton, T. (2012). Stochastic Epidemic
Models and Their Statistical Analysis, volume 151. Springer Science & Business Media.
[Apuzzo and Gebredikan, 2020] Apuzzo, M. and Gebredikan, S. (2020). Can’t Get Tested?
Maybe You’re in the Wrong Country. The New York Times, March 20, 2020.
[Atkeson, 2020] Atkeson, A. (2020). What Will Be the Economic Impact of COVID-19 in
the US? Rough Estimates of Disease Scenarios. Working Paper 26867, National Bureau
of Economic Research.
[Beal et al., 2018] Beal, L., Hill, D., Martin, R., and Hedengren, J. (2018). GEKKO
Optimization Suite. Processes, 6(8):106.
[Behncke, 2000] Behncke, H. (2000). Optimal control of deterministic epidemics. Optimal
control applications and methods, 21(6):269–285.
[Berger et al., 2020] Berger, D. W., Herkenhoff, K. F., and Mongey, S. (2020). An seir
infectious disease model with testing and conditional quarantine. Working Paper 26901,
National Bureau of Economic Research.
[Bertozzi et al., 2020] Bertozzi, A. L., Franco, E., Mohler, G., Short, M. B., and Sledge, D.
(2020). The challenges of modeling and forecasting the spread of COVID-19. Proceedings
of the National Academy of Sciences, 117(29):16732–16738.
[Bertuzzo et al., 2020] Bertuzzo, E., Mari, L., Pasetto, D., Miccoli, S., Casagrandi, R.,
Gatto, M., and Rinaldo, A. (2020). The geography of COVID-19 spread in Italy
and implications for the relaxation of confinement measures. Nature Communications,
11(4264).
19

[Brotherhood et al., 2020] Brotherhood, L., Kircher, P., Santos, C., and Tertilt, M.
(2020). An Economic Model of the Covid-19 Epidemic: The Importance of Testing
and Age-Specific Policies. CESifo Working Paper Series 8316, CESifo.
[Cashore et al., 2020] Cashore, J., Duan, N., Janmohamed, A., Wan, J., Zhang, Y., Henderson, S., Shmoys, D., and Frazier, P. (2020). COVID-19 Mathematical Modeling for
Cornell’s Fall Semester. Technical report, Cornell University.
[Chinazzi et al., 2020] Chinazzi, M., Davis, J. T., Ajelli, M., Gioannini, C., Litvinova, M.,
Merler, S., y Piontti, A. P., Mu, K., Rossi, L., Sun, K., et al. (2020). The effect of travel
restrictions on the spread of the 2019 novel coronavirus (COVID-19) outbreak. Science,
368(6489):395–400.
[Chu et al., 2020] Chu, D. K., Akl, E. A., Duda, S., Solo, K., Yaacoub, S., Schünemann,
H. J., El-harakeh, A., Bognanni, A., Lotfi, T., Loeb, M., et al. (2020). Physical distancing, face masks, and eye protection to prevent person-to-person transmission of
SARS-CoV-2 and COVID-19: a systematic review and meta-analysis. The Lancet,
395(10242).
[Daley and Gani, 2001] Daley, D. J. and Gani, J. (2001). Epidemic Modelling: An Introduction. Cambridge University Press.
[Davis et al., 2020] Davis, H. E., Assaf, G. S., McCorkell, L., Wei, H., Low, R. J.,
Re’em, Y., Redfield, S., Austin, J. P., and Akrami, A. (2020). Characterizing long
covid in an international cohort: 7 months of symptoms and their impact. medRxiv,
2020.12.24.20248802.
[Della Rossa et al., 2020] Della Rossa, F., Salzano, D., Di Meglio, A., De Lellis, F., Coraggio, M., Calabrese, C., Guarino, A., Cardona-Rivera, R., De Lellis, P., Liuzza, D.,
et al. (2020). A network model of Italy shows that intermittent regional strategies can
alleviate the COVID-19 epidemic. Nature communications, 11(1):1–9.
[Di et al., 2020] Di, L. D., Pullano, G., Sabbatini, C., Boëlle, P., and Colizza, V. (2020).
Impact of lockdown on COVID-19 epidemic in Île-de-France and possible exit strategies.
BMC medicine, 18(1):240–240.
[Di Giamberardino and Iacoviello, 2017] Di Giamberardino, P. and Iacoviello, D. (2017).
Optimal control of SIR epidemic model with state dependent switching cost index.
Biomedical Signal Processing and Control, 31:377–380.
[Diekmann and Heesterbeek, 2000] Diekmann, O. and Heesterbeek, J. (2000). Mathematical Epidemiology of Infectious Diseases: Model Building, Analysis and Interpretation.
John Wiley.
[Drakopoulos and Randhawa, 2020] Drakopoulos, K. and Randhawa, R. S. (2020). Why
perfect tests may not be worth waiting for: Information as a commodity. Available at
SSRN: https: // ssrn. com/ abstract= 3565245 .
[Farboodi et al., 2020] Farboodi, M., Jarosch, G., and Shimer, R. (2020). Internal and
external effects of social distancing in a pandemic. Working Paper 27059, National
Bureau of Economic Research.
[FDA, 2020] FDA (2020). Independent Evaluations of COVID-19 Serological Tests. Technical report, U.S. Department of Health and Human Services Food and Drug Administration.

20

[Fink and Baker, 2020] Fink, S. and Baker, M. (2020). ‘It’s Just Everywhere Already’:
How Delays in Testing Set Back the U.S. Coronavirus Response. The New York Times,
March 10, 2020.
[Flaxman et al., 2020] Flaxman, S., Mishra, S., Gandy, A., Unwin, H. J. T., Mellan, T. A.,
Coupland, H., Whittaker, C., Zhu, H., Berah, T., Eaton, J. W., et al. (2020). Estimating the effects of non-pharmaceutical interventions on COVID-19 in Europe. Nature,
584(7820):257–261.
[Gardiner, 2009] Gardiner, C. (2009). Stochastic Methods: A Handbook for the Natural
and Social Sciences. Springer Series in Synergetics. Springer Berlin Heidelberg.
[Gatto et al., 2020] Gatto, M., Bertuzzo, E., Mari, L., Miccoli, S., Carraro, L.,
Casagrandi, R., and Rinaldo, A. (2020). Spread and dynamics of the COVID-19 epidemic in Italy: Effects of emergency containment measures. Proceedings of the National
Academy of Sciences, 117(19):10484–10491.
[Gillespie, 1976] Gillespie, D. T. (1976). A general method for numerically simulating
the stochastic time evolution of coupled chemical reactions. Journal of Computational
Physics, 22(4):403–434.
[Gollier and Gossner, 2020] Gollier, C. and Gossner, O. (2020). Group testing against
Covid-19. Covid Economics, 1(2):32–42.
[Grassly et al., 2020] Grassly, N., Pons, S. M., Parker, E., White, P., Ainslie, K., Baguelin,
M., Bhatt, S., Boonyasiri, A., Boyd, O., Brazeau, N., Cattarino, L., Ciavarella, C.,
Cooper, L., Coupland, H., Cucunuba, P. Z., Cuomo-Dannenburg, G., Dighe, A., Djaafara, A., Donnelly, C., Dorigatti, I., van, E. S., Ferreira, D. N. F., Fitzjohn, R., Fu, H.,
Gaythorpe, K., Geidelberg, L., Green, W., Hallett, T., Hamlet, A., Hayes, S., Hinsley,
W., Imai, N., Jorgensen, D., Knock, E., Laydon, D., Lees, J., Mangal, T., Mellan, T.,
Mishra, S., Nedjati, G. G., Nouvellet, P., Okell, L., Ower, A., Parag, K., Pickles, M.,
Ragonnet-Cronin, M., Stopard, I., Thompson, H., Unwin, H., Verity, R., Vollmer, M.,
Volz, E., Walker, P., Walters, C., Wang, H., Wang, Y., Watson, O., Whittaker, C.,
Whittles, L., Winskill, P., Xi, X., and Ferguson, N. (2020). Report 16: Role of testing
in COVID-19 control. Technical report, Imperial College London.
[Harko et al., 2014] Harko, T., Lobo, F. S., and Mak, M. (2014). Exact analytical solutions
of the Susceptible-Infected-Recovered (SIR) epidemic model and of the SIR model with
equal death and birth rates. Applied Mathematics and Computation, 236:184 – 194.
[Haseltine, 2020a] Haseltine, W. (2020a). How Antibody Tests Can Be Used To Fight
COVID-19. Forbes, April 6, 2020.
[Haseltine, 2020b] Haseltine, W. (2020b). Tests For COVID-19 Are Expensive, But They
Don’t Have To Be. Forbes, April 8, 2020.
[Hota and Gupta, 2020] Hota, A. R. and Gupta, K. (2020). A generalized SIS epidemic
model on temporal networks with asymptomatic carriers and comments on decay ratio.
arXiv preprint arXiv:2008.00826.
[Hota and Sundaram, 2019] Hota, A. R. and Sundaram, S. (2019). Game-theoretic vaccination against networked SIS epidemics and impacts of human decision-making. IEEE
Transactions on Control of Network Systems, 6(4):1461–1472.
[Keeling and Rohani, 2011] Keeling, M. J. and Rohani, P. (2011). Modeling Infectious
Diseases in Humans and Animals. Princeton University Press.
21

[Kermack and McKendrick, 1927] Kermack, W. O. and McKendrick, A. G. (1927). A
contribution to the mathematical theory of epidemics. Proceedings of the Royal Society
of London. Series A, Containing Papers of a Mathematical and Physical Character,
115(772):700–721.
[Khalil, 2015] Khalil, H. K. (2015). Nonlinear control. Pearson.
[King et al., 2008] King, A. A., Ionides, E. L., Pascual, M., and Bouma, M. J. (2008).
Inapparent infections and cholera dynamics. Nature, 454(7206):877–880.
[Kraay et al., 2020] Kraay, A. N., Nelson, K. N., Zhao, C. Y., Weitz, J. S., and Lopman,
B. A. (2020). Modeling serological testing to inform relaxation of social distancing for
COVID-19 control. medRxiv, 2020.04.24.20078576.
[Kruse and Strack, 2020] Kruse, T. and Strack, P. (2020). Optimal control of an epidemic
through social distancing. Cowles Foundation Discussion Paper No. 2229, Available at
SSRN: https: // ssrn. com/ abstract= 3583186 .
[Kubina and Dziedzic, 2020] Kubina, R. and Dziedzic, A. (2020). Molecular and serological tests for COVID-19 a comparative review of SARS-CoV-2 coronavirus laboratory
and point-of-care diagnostics. Diagnostics, 10(6):434.
[Kucirka et al., 2020] Kucirka, L. M., Lauer, S. A., Laeyendecker, O., Boon, D., and
Lessler, J. (2020). Variation in false-negative rate of reverse transcriptase polymerase
chain reaction–based SARS-CoV-2 tests by time since exposure. Annals of Internal
Medicine.
[Larremore et al., 2020] Larremore, D. B., Wilder, B., Lester, E., Shehata, S., Burke,
J. M., Hay, J. A., Tambe, M., Mina, M. J., and Parker, R. (2020). Test sensitivity is
secondary to frequency and turnaround time for COVID-19 screening. Science Advances,
eabd5393.
[Li et al., 2020a] Li, G., Shivam, S., Hochberg, M. E., Wardi, Y., and Weitz, J. S. (2020a).
Disease-dependent interaction policies to support health and economic outcomes during
the COVID-19 epidemic. medRxiv 2020.08.24.20180752.
[Li et al., 2020b] Li, R., Pei, S., Chen, B., Song, Y., Zhang, T., Yang, W., and Shaman,
J. (2020b). Substantial undocumented infection facilitates the rapid dissemination of
novel coronavirus (SARS-CoV-2). Science, 368(6490):489–493.
[McAloon et al., 2020] McAloon, C., Collins, Á., Hunt, K., Barber, A., Byrne, A. W.,
Butler, F., Casey, M., Griffin, J., Lane, E., McEvoy, D., Wall, P., Green, M., O’Grady,
L., and More, S. J. (2020). Incubation period of COVID-19: a rapid systematic review
and meta-analysis of observational research. BMJ Open, 10(8).
[Mervosh and Fernandez, 2020] Mervosh, S. and Fernandez, M. (2020). Months Into Virus
Crisis, U.S. Cities Still Lack Testing Capacity. The New York Times, July 6, 2020.
[Miclo et al., 2020] Miclo, L., Spiro, D., and Weibull, J. (2020). Optimal epidemic suppression under an ICU constraint. arXiv preprint arXiv:2005.01327.
[Nowzari et al., 2016] Nowzari, C., Preciado, V. M., and Pappas, G. J. (2016). Analysis
and control of epidemics: A survey of spreading processes on complex networks. IEEE
Control Systems Magazine, 36(1):26–46.
[OECD, 2020] OECD (2020). Testing for COVID-19: A way to lift confinement restrictions. Technical report, Organisation for Economic Co-operation and Development.
22

[Paré et al., 2017] Paré, P. E., Beck, C. L., and Nedić, A. (2017). Epidemic processes over
time-varying networks. IEEE Transactions on Control of Network Systems, 5(3):1322–
1334.
[Paré et al., 2020] Paré, P. E., Liu, J., Beck, C. L., Kirwan, B. E., and Başar, T. (2020).
Analysis, Estimation, and Validation of Discrete-Time Epidemic Processes. IEEE
Transactions on Control Systems Technology, 28(1):79–93.
[Pasetto et al., 2018] Pasetto, D., Finger, F., Camacho, A., Grandesso, F., Cohuet, S.,
Lemaitre, J. C., Azman, A. S., Luquero, F. J., Bertuzzo, E., and Rinaldo, A. (2018).
Near real-time forecasting for cholera decision making in Haiti after Hurricane Matthew.
PLoS computational biology, 14(5):e1006127.
[Pasetto et al., 2017] Pasetto, D., Finger, F., Rinaldo, A., and Bertuzzo, E. (2017). Realtime projections of cholera outbreaks through data assimilation and rainfall forecasting.
Advances in Water Resources, 108:345–356.
[Pastor-Satorras et al., 2015] Pastor-Satorras, R., Castellano, C., Van Mieghem, P., and
Vespignani, A. (2015). Epidemic processes in complex networks. Reviews of modern
physics, 87(3):925.
[Public Health England, 2020] Public Health England (2020). Evaluation of Roche Elecsys AntiSARS-CoV-2 serology assay for the detection of anti-SARS-CoV-2 antibodies.
Technical report, Public Health England.
[Pullano et al., 2020] Pullano, G., Di Domenico, L., Sabbatini, C. E., Valdano, E., Turbelin, C., Debin, M., Guerrisi, C., Kengne-Kuetche, C., Souty, C., Hanslik, T., Blanchon,
T., Boëlle, P.-Y., Figoni, J., S, V., Campèse, C., Bernard-Stoecklin, S., and Colizza,
V. (2020). Underdetection of COVID-19 cases in France threatens epidemic control.
Nature, Online ahead of print.
[Ray et al., 2020] Ray, E. L., Wattanachit, N., Niemi, J., Kanji, A. H., House, K., Cramer,
E. Y., Bracher, J., Zheng, A., Yamana, T. K., Xiong, X., Woody, S., Wang, Y., Wang,
L., Walraven, R. L., Tomar, V., Sherratt, K., Sheldon, D., Reiner, R. C., Prakash,
B. A., Osthus, D., Li, M. L., Lee, E. C., Koyluoglu, U., Keskinocak, P., Gu, Y., Gu, Q.,
George, G. E., España, G., Corsetti, S., Chhatwal, J., Cavany, S., Biegel, H., Ben-Nun,
M., Walker, J., Slayton, R., Lopez, V., Biggerstaff, M., Johansson, M. A., and Reich,
N. G. (2020). Ensemble Forecasts of Coronavirus Disease 2019 (COVID-19) in the U.S.
medRxiv, 2020.08.19.20177493.
[Roche, 2020] Roche (2020). Elecsys®Anti-SARS-CoV-2. Package Insert 2020-07, V4.0;
Material Numbers 09203095190 and 09203079190.
[Sharma and Samanta, 2015] Sharma, S. and Samanta, G. (2015). Stability analysis
and optimal control of an epidemic model with vaccination. International Journal of
Biomathematics, 8(03):1550030.
[Spence and Starrett, 1975] Spence, M. and Starrett, D. (1975). Most rapid approach
paths in accumulation problems. International Economic Review, 16(2):388–403.
[Stock, 2020] Stock, J. H. (2020). Data gaps and the policy response to the novel coronavirus. Working Paper 26902, National Bureau of Economic Research.
[van Kampen, 2007] van Kampen, N. (2007). Stochastic Processes in Physics and Chemistry. North-Holland Personal Library. Elsevier, Amsterdam, third edition.

23

[Vespignani et al., 2020] Vespignani, A., Tian, H., Dye, C., Lloyd-Smith, J. O., Eggo,
R. M., Shrestha, M., Scarpino, S. V., Gutierrez, B., Kraemer, M. U., Wu, J., et al.
(2020). Modelling COVID-19. Nature Reviews Physics, 2:279–281.
[Viboud and Vespignani, 2019] Viboud, C. and Vespignani, A. (2019). The future of influenza forecasts. Proceedings of the National Academy of Sciences, 116(8):2802–2804.
[Wächter and Biegler, 2006] Wächter, A. and Biegler, L. T. (2006). On the implementation of an interior-point filter line-search algorithm for large-scale nonlinear programming. Mathematical programming, 106(1):25–57.
[Watson et al., 2020] Watson, J., Whiting, P. F., and Brush, J. E. (2020). Interpreting a
covid-19 test result. BMJ, 369.
[Weitz et al., 2020] Weitz, J. S., Park, S. W., Eksin, C., and Dushoff, J. (2020).
Awareness-driven behavior changes can shift the shape of epidemics away from peaks
and toward plateaus, shoulders, and oscillations. Proceedings of the National Academy
of Sciences, 117(51):32764–32771.
[Zaman et al., 2008] Zaman, G., Kang, Y. H., and Jung, I. H. (2008). Stability analysis
and optimal vaccination of an SIR epidemic model. BioSystems, 93(3):240–249.
[Zhang et al., 2020] Zhang, J., Litvinova, M., Liang, Y., Wang, Y., Wang, W., Zhao, S.,
Wu, Q., Merler, S., Viboud, C., Vespignani, A., Ajelli, M., and Yu, H. (2020). Changes
in contact patterns shape the dynamics of the covid-19 outbreak in china. Science,
368(6498):1481–1486.

24

Supplementary Materials
S.1

Optimal testing policy

We next present the proof of the following theorem. Theorem 1 in the main text is obtained
as a special case when the transmission rate is constant.
Theorem 2. Suppose that the transmission rate β(t) is a monotone non-increasing function of time. The optimal testing policy θ† (t) for the optimization problem of Eq. (2) with
dynamics as in Eq. (1) acts in three phases:
1. While iu (t) < imax , do not test, i.e. set θ† (t) = 0.
2. After iu (t) reaches imax , test with time-varying rate θ† (t) = (β(t)s(t) − γ)/η.
3. Once herd immunity is reached, that is s(t) = γ/β(t) for the first time, stop testing,
i.e. set θ† (t) = 0.
To prove such theorem we start with a series of auxiliary lemmas. Let therd be the
first instant of time such that s(therd ) = γ/β(therd ). We say that the system reached herd
immunity at time therd since for any t > therd the fraction of infected naturally decreases.
Mathematically,
diu (t)
= (β(t)s(t) − γ)iu (t) ≤ (β(therd )s(therd ) − γ)iu (t) = 0,
dt
where we use the fact that in this model the susceptible and β are monotonically nonincreasing. We start by proving that after herd immunity it is optimal to stop testing.
Lemma 3. Under the optimal testing policy θ† there exists a finite time therd at which
s(therd ) = γ/β(therd ). Moreover, θ† (t) = 0 for all t ≥ therd . Here the superscript † denotes
the evolution under the optimal testing policy.
Proof. The fact that under the optimal testing policy herd immunity is reached is immediate as if that was not the case the objective function would be infinite. Let therd be
the time when herd immunity is reached and recall that β(therd )s(therd ) − γ ≤ 0 for all
t ≥ therd since β(t) and s(t) are both decreasing with time. Consequently, diu (t)/dt ≤ 0
for all t ≥ therd and the control policy that sets θ† (t) = 0 ∀ t ≥ therd is feasible and
therefore optimal (as no other control policy can achieve zero cost).
We next show that, under the optimal control, once herd immunity is reached the
number of infected undetected must be at the threshold.
Lemma 4. If the optimal objective is strictly positive, i†u (therd ) = imax .
Proof. First, note that if the optimal objective is 0, this means that we do not apply
any control to the system. The optimal trajectory i†u (t) is therefore at most tangent to
imax , because otherwise, we would need to apply some positive control to make sure that
it does not violate the constraint iu ≤ imax . Instead, if the optimal objective is strictly
positive there is an interval of time before herd immunity is reached with positive control.
If i†u (therd ) < imax , we could decrease the control by a small amount before reaching herd
immunity (the last time the control was positive before reaching herd immunity). This
would imply that iu increase faster but for small deviations of the control we could still
guarantee iu (t) ≤ imax for all times. Since the rate of decrease of s increases as iu increases,
this would imply that s will decrease faster and therefore herd immunity will be reached at
a time t0herd < therd . From Lemma 3, we have that the optimal control after reaching herd
immunity is identically 0. Therefore, the new control policy strictly reduces the objective,
violating the optimality of the control.
S-1

Finally, we characterize the optimality of the proposed control θ† before therd .
Lemma 5. The optimal control takes the most rapid approach path to reach herd immunity.
Proof. Lemma 3 characterizes how the optimal control behaves after herd immunity.
Therefore, we can rewrite the original optimization problem in Eq. (2) as follows
Z therd
θ(t)dt
min
t=0

s.t.

iu (t) ≤ imax
θ(t) ≥ 0

∀t

∀t

(S1)

where therd is the time to reach herd immunity (which depends on θ). Integrating the
dynamics
ηθ(t) = β(t)s(t) − γ −

1 diu (t)
iu (t) dt

yields
Z

therd

η
t=0

therd




1 diu (t)
θ(t)dt =
βs(t) − γ −
dt
iu (t) dt
t=0

Z therd
Z therd 
1 diu (t)
=
(βs(t) − γ) dt −
dt
iu (t) dt
t=0
t=0


Z therd
iu (0)
=
(βs(t) − γ) dt + log
iu (therd )
t=0


Z therd
iu (0)
(βs(t) − γ) dt + log
=
,
imax
t=0
Z

where we have used Lemma 4 for the last equality. Note that the second term is a
constant and η is a positive constant. Therefore, the original optimal control problem can
be rewritten as:
Z therd
min
(βs(t) − γ) dt
t=0

s.t.

iu (t) ≤ imax
θ(t) ≥ 0

∀t

∀t.

(S2)

We next show that the trajectory i†u induced by the control θ† pointwise dominates
any other feasible trajectory iu and therefore the corresponding trajectory s† is pointwise smaller than any other feasible trajectory of s, before hitting herd immunity (Fig.
S1). This has two consequences: i) herd immunity is reached sooner under θ† and ii)
(β(t)s(t) − γ) is pointwise smaller. These two points prove that θ† minimizes Eq. (S2)
and thus also Eq. (S1).
To prove points i) and ii) recall that from the first line of Eq. (1)
ds
= −βsiu
dt
and by integration

=⇒


log

1 ds
= −βiu
s dt

s(t)
s(0)



Z
=−

=⇒

d log(s)
= −βiu
dt

t

β(τ )iu (τ )dτ
0

which shows that for two feasible trajectories (s† (t), i†u (t)) and (s(t), iu (t)), if i†u (t) ≥ i(t)
for all t ≤ T , we have that s† (t) ≤ s(t) for all t ≤ T .
S-2

s(t)
s†(t)
sherd

Infected-undetected
fraction iu

Susceptible
fraction s

s(0)

imax
iu†(t)

iu(t)

iu(0)
Time t

τ1

τ2

Figure S1: The trajectory i†u (t) induced by the optimal testing strategy θ† pointwise
dominates any other feasible trajectory iu . Conversely, the trajectory s† (t) induced by the
optimal testing strategy θ† is pointwise smaller than any other feasible trajectory s(t), until
herd immunity is reached. In this illustration β is constant, so that s(therd ) = γ/β = sherd .
Combining the lemmas above proves Theorem 2. The expression of θ† when iu (t) =
imax can be obtained from diu /dt = (βs − γ − ηθ† )iu = 0.

S.2
S.2.1

Proofs of Observability
Proof of Lemma 1

We prove the two statements separately.
1. From the third line of Eq. (1), it holds
1
iu (t) =
ηθ(t)



did (t)
+ γid (t)
dt



hence iu (and all its derivatives) can be reconstructed from the observed output id
(and its derivative). From the second line of Eq. (1), for β constant, we obtain
βs(t) =

1 diu (t)
+ γ + ηθ(t).
iu (t) dt

(S3)

Substituting the expression in Eq. (S3) on the right hand side of
 2

1
d iu (t)
diu (t)
diu (t)
dθ(t)
diu (t)
β=−
− βs(t)
+γ
+η
iu (t) + ηθ(t)
βs(t)i2u (t)
dt2
dt
dt
dt
dt
(obtained by computing the second derivative of id ) yields a formula for β as a
function of known quantities (iu , id , θ and their derivatives). Since βs(t) is known
from Eq. (S3), this implies that s(t) is known and finally r(t) = 1−s(t)−iu (t)−id (t).
2. If β(t) is time-varying the system is not observable. To show this we consider two
evolutions that start from different initial conditions and have different β evolutions,
yet lead to the same observable output id . This proves that just observing the
output it is not possible to distinguish the two scenarios. Specifically consider the
two systems:

S-3


ds


= −βsiu


dt


diu
= βsiu − γiu − ηθ(t)iu

dt




 did = ηθ(t)i − γi
u
d
dt


ds̄


= −β̄s̄īu



dt


dīu
= β̄s̄īu − γ īu − ηθ(t)īu

dt




dī

 d = ηθ(t)īu − γ īd
dt

with initial state s(0) 6= s̄(0), iu (0) = īu (0), id (0) = īd (0) = r(0) = r̄(0) = 0 and
suppose that β̄(t) = β(t)s(t)/s̄(t). Then
diu
= βsiu − γiu − ηθ(t)iu ,
dt
dīu
= βsīu − γ īu − ηθ(t)īu ,
dt

īu (0) = iu (0)

Since iu and īu solve the same differential equation it must be īu (t) ≡ iu (t) for all
t. This immediately implies id (t) ≡ īd (t), yet the evolution of s and s̄ is different as
they start from different initial conditions.
S.2.2

Proof of Lemma 2

Since y(t) is observed continuously in time one can use it to compute exactly did /dt and
drd /dt. The third and fifth equations in Eq. (3) can then be used to recover iu (t) and r(t)
exactly as follows:


1
did
iu (t) =
+ γid ,
ηθ(t) + θB ηBI dt


1
drd
ru (t) =
− γid .
θB ηBR dt
Using the fact that
s(t) = 1 − iu (t) − ru (t) − id (t) − rd (t)
one can reconstruct s(t) as well. Overall, the state can be estimated exactly from the
observed variables. As a byproduct, knowledge of s(t) and iu (t) allows the identification
of β(t) from the first equation in Eq. (3).

S.3

Optimal testing policy for the extended problem in Eq. 4

We consider an extension of the model in Eq. (3) that accounts for detection of symptomatic individuals by considering an additional flow from infected-undetected to infecteddetected with rate κ:
ds(t)
dt
diu (t)
dt
did (t)
dt
dru (t)
dt
drd (t)
dt

= −β(t)s(t)iu (t)
= β(t)s(t)iu (t) − γiu (t) − ηθ(t)iu (t) − κiu (t) − θB ηBI iu (t)
= ηθ(t)iu (t) + κiu (t) + θB ηBI iu (t) − γid (t)
= γiu (t) − θB ηBR ru (t)
= γid (t) + θB ηBR ru (t)
S-4

(S4)

Infected fraction i

sA sB
iA iB

sCsD
iC iD

sE
iE

imax

Testing rate
θ

0
θmax

0

τ1 τ2
tA tB

τ3
Time t

τ4 τ5
tC tD
tE

Figure S2: Structure of the optimal testing strategy (red curve) and corresponding effect
on the total fraction of infected individuals (blue curve). The optimal testing policy θ̂∗
is zero until time tA , when it switches to the maximum testing rate θmax until time tB ,
when i = iu + id reaches the constraint imax with zero derivative. In the interval [tB , tC ]
of duration τ3 , the optimal testing policy maintains i = imax , until switching back to θmax
between times tC and tD . After tD , i increases until reaching imax with zero derivative at
time tE , and decreases afterwards.
The numerical solution of the problem in Eq. (4) for this extended model (and for
the parameters of Fig. 4) has the structure described in Section 2.3 and schematized in
Fig. S2. To generalize this analysis to any set of parameters, we here aim at deriving
an analytic characterization of the optimal testing policy for Problem 4 within the class
of policies with such a structure. More in detail, we aim at deriving analytic expressions
for the optimal switching times tA , tB , tC and tD and for the testing rate in the interval
[tB , tC ] as a function of the model parameters and initial conditions. With slight abuse
of notation, we denote the optimal policy within this class with the symbol θ∗ . For this
analysis we assume β to be constant, and without loss of generality we assume η = 1.
Moreover, we work under the assumption that the state is known, hence we set θB = 0.
The following analytic relationships (adapted from [Harko et al., 2014]) between s and
iu at two times t1 < t2 under constant testing rate θ will be useful:


s(t2 )
β
fθ (s(t1 ), iu (t1 ), s(t2 ), iu (t2 )) := ln
−
(s(t2 ) + iu (t2 ) − s(t1 ) − iu (t1 )) = 0,
s(t1 )
γ+θ+κ
(S5)
β
−
(1−s(t
)−i
(t
))
s(t
)
u
1
1
Z 2 e γ+θ+κ
s(t1 )
1
1
t2 − t1 = − β (1−s(t )−i (t ))
dx
β
u 1
1
(1−s(t1 )−iu (t1 ))
x −β − (γ + θ + κ) ln x + βs(t )xe γ+θ+κ
e γ+θ+κ
1
:= ∆tθ (s(t2 ), s(t1 ), iu (t1 )).
(S6)
S.3.1

Intervals [0, tA ] and [tA , tB ]

First, we evaluate sA := s(tA ), iuA := iu (tA ), sB := s(tB ) and iuB := iu (tB ) as functions
of s0 and i0 . Using Eq. (S5) we have:
f0 (s0 , i0 , sA , iuA ) = 0,

(S7)

fθmax (sA , iuA , sB , iuB ) = 0.

(S8)

S-5

Imposing that at time tB one has (iu + id ) |tB = imax and d(iu + id )/dt |tB = 0 yields:
d(iu + id )
dt

= βsB iuB − γ(iuB + id (tB )) = βsB iuB − γimax = 0,

(S9)

tB

and integrating did /dt = (θmax + κ)iu − γid in [tA , tB ] one finds:


Z tB
γ(t−tA )
idB = imax − iuB = idA + (θmax + κ)
e
iu (t)dt e−γ(tB −tA )
tA


Z sB
dt
γ∆tθmax (s,sA ,iuA )
= idA + (θmax + κ)
iu (s) ds e−γτ2
e
ds
sA
Z sA γ∆tθ (s,sA ,iuA ) !
max
e
= idA + (θmax + κ)
ds e−γτ2 ,
βs
sB

(S10)

where τ2 can be computed from Eq. S6 as a function of sA , iuA and sB . The quantity idA
can be computed as a function of sA by integrating did /dt = −γid + κiu in the interval
[0, tA ], which gives:
Z s0
κ
idA = e−γtA
eγ∆t0 (s,s0 ,0) ds,
βs
sA
where again we made use of Eq. S6. Eqs. (S7)-(S10) are four equations in four unknowns
that can be solved to find sA , iuA , sB , iuB as a function of s0 and i0 . In the interval [tA , tB ],
the optimal testing policy is θ∗ (t) = θmax , and thus the cost of the control in the interval
[0, tB ] is:
Z tB
θ∗ (t)dt = τ2 θmax .
0

S.3.2

Interval [tB , tC ]

In the interval [tB , tC ] the optimal testing policy maintains i = iu + id ≡ imax . Hence, the
first and second derivatives of i must be equal to zero. Note that
d(iu + id )
= βsiu − γ(iu + id ) = βsiu − γimax = 0
dt
d2 (iu + id )
ds
diu
= β iu + βs
= β(−βsiu )iu + βs(βsiu − γiu − θ∗ iu − κiu )
2
dt
dt
dt
= −β 2 si2u + β 2 s2 iu − βsγiu − βsθ∗ iu − βκsiu = 0
which yields
θ∗ = β(s − iu ) − γ − κ.

(S11)

Substituting this expression in the dynamic equations, we obtain that in the interval
[tB , tC ] the undetected fraction of the infected individuals satisfies:
diu
= (βs − γ − θ∗ − κ)iu = βi2u
dt
and thus
iu (t) =

1
1
iuB

.

(S12)

(S13)

− β(t − tB )

Moreover,
did
ds
diu
= θ∗ iu + κiu − γid = βsiu − γiu − βi2u − γid = − − γiu −
− γid
dt
dt
dt
diu did
ds
ds
⇒0=
+
= − − γ(iu + id ) ⇒
= −γimax
dt
dt
dt
dt
⇒ s(t) = sB − γimax (t − tB ).
S-6

(S14)

Thus, sC = sB −γimax τ3 and iuC = 1/(1/iuB − βτ3 ). The value of τ3 is limited from above
by the constraints τ3 < (βiuB )−1 (for solvability of Eq. (S12)) and θ∗ ≥ 0, which can be
expressed as an upper constraint on τ3 via Eqs. (S11), (S13) and (S14). We denote by τ̄3
the minimum of such constraints. The cost of the optimal testing policy in the interval
[tB , tC ] is:
Z tC
Z tC
∗
θ (t)dt =
(β(s(t) − iu (t)) − γ − κ) dt
tB
tB
!
!
Z τ3
1
0
=
β sB − γimax t − 1
− γ − κ dt0
0
−
βt
0
iuB


γ
= τ3 βsB − γ − κ − βimax τ3 + ln (1 − βiuB τ3 ) .
2
S.3.3

Intervals [tC , tD ] and [tD , tE ]

The analysis is identical to that of Section S.3.1, the objective is to evaluate sD , iuD ,sE
and iuE as a function of sC and iC . From Eq. (S5) we have:
fθmax (sC , iuC , sD , iuD ) = 0
f0 (sD , iuD , sE , iuE ) = 0.
At time tE , iu + id is tangent to imax , hence: (similar to Eq. (S9))
βsE iuE = γimax .
Integrating did /dt = θmax iu + κiu − γid in the interval [tC , tD ] yields:
Z sC γ∆tθ (s,sC ,iC ) !
max
e
ds e−γτ4 ,
id (D) = id (C) + (θmax + κ)
βs
sD
where id (C) = imax − iuC . We can also compute id (D) from the equation for id in the
interval [tD , tE ] (during which the testing rate is equal to zero) as:
Z sD γ∆t0 (s,sD ,iD )
e
γτ5
id (D) = (imax − iuE )e − κ
ds,
βs
sE
and equating the two expressions for id (D) we find:
Z sC γ∆tθ (s,sC ,iC ) !
Z sD γ∆t0 (s,sD ,iD )
max
e
e
(imax −iuE )eγτ5 −κ
ds = imax − iuC + (θmax + κ)
ds e−γτ4 ,
βs
βs
sD
sE
The time intervals τ4 and τ5 can be computed from Eq. (S6). The cost of the control in
the interval [tC , +∞] is thus:
Z ∞
θ̂∗ (t)dt = τ4 θmax .
tC

S.3.4

Minimization over τ3 yields the optimal testing policy

So far we obtained a formula for the overall cost that, for fixed s0 and i0 , depends only
on τ3 . Minimizing such cost for τ3 ∈ [0, τ̄3 ] yields the optimal value for τ3 (Fig. S3), with
which the optimal testing strategy θ∗ is characterized. Note that since s is monotonically
decreasing, the testing strategy can be formulated as follows:


if s(t) > sA or s(t) < sD
0
∗
θ (t) = θmax
if s(t) ∈ [sB , sA ] ∪ [sD , sC ]


β(s(t) − iu (t)) − γ − κ otherwise

S-7

Cost relative to optimal
constant testing strategy

0.39

Cost
Cost w/o last pulse

0.385

0.3579

0.38
0.3578

0.375

0.3577

0.37

0.3576
370

0.365
0.36
0.355

340

360

τ3 (d)

τ3 (d)

380

404

400

Figure S3: Cost of testing policies (red curve) with the structure of Fig. S2 for the
deterministic SIR model Eq. (S4), as a function of the duration τ3 of the time interval
[tB , tC ]. Costs are computed relative to the cost of the optimal, constant testing strategy
(Materials and Methods Section 4.2). The optimal testing policy adopts the value of τ3
that minimizes the cost (inset). The dashed, black line indicates the cost of a testing
policy with the largest possible value of τ3 , i.e. a testing policy in which the last phase of
testing at maximum testing rate θmax does not occur. The inset shows that the benefit of
the last phase of testing at maximum testing rate is marginal.

S.4

Receding horizon implementation of the optimal testing policy for
the stochastic simulations

In the receding horizon implementation, at any time t > tA we aim at computing the
testing rate θrh (t) that brings the deterministic dynamics of Eq. (S4) to iu + id = imax
with d(iu + id )/dt = 0 in a time H. This leads to the following set of equations:
fθrh (t) (s(t), iu (t), s(t + H), iu (t + H)) = 0
d(iu (t) + id (t))
dt

= βs(t + H)iu (t + H) − γimax = 0
t+H
t+H

β
(s(t + H)iu (t + H) + s(t)iu (t)) H,
2
t
(S15)
where fθ is as in Eq. (S5) and in the last equation we used the trapezoidal rule to
approximate the integral. We denote the solution of Eq. (S15) as:
Z

s(t + H) = s(t) − β

θrh (s(t), iu (t)) := −β

S.5

s(t0 )iu (t0 )dt0 ' s(t) −

s(t) + iu (t) − s(t + H)
γimax
+
.
ln(s(t + H)/s(t))
s(t + H) ln(s(t + H)/s(t))

(S16)

Validation with time-varying transmission rate

Fig. S4 illustrates the performance of the testing policy θ̂∗ for the optimization problem of
Eq. 4 when the transmission rate is time-varying (in this case sinusoidal to mimic seasonality). For any time t, the transmission rate β(t) is estimated from the reconstructed state
[x̂(τ )]t−1
τ =t−7 over a moving window of length 7 days by nonlinear least square regression.
The testing rate is evaluated by using Eqs. (14) and (S16) with the estimated β̂(t) instead
of β. We see from Fig. S4 that the time-varying transmission rate can be accurately
predicted (while the epidemic is active) and the testing rate implemented using such prediction effectively stabilizes the epidemics at the desired threshold. This is a preliminary
indication that the suggested testing strategy may be effective even in the presence of an
unknown and time-varying transmission rate. A detailed numerical study is needed to
further support this conclusion and is left as future work.
S-8

B 0.4
I
Iu
Imax
0.35
I,̂ Iû
95% CI

A
1200

800

β(t) (d-1)

Iu(t) , I(t)

1000

600
400

Estimated β(t)
True β(t)

0.3

0.25

200
0
0

200
400
Time (d)

600

0.2

0

200
400
Time (d)

600

Figure S4: Performance of the testing policy θ̂∗ when β(t) varies sinusoidally with a one
year period centered at β = 0.3 d−1 and amplitude 0.1 d−1 . At any time tk , β(tk ) was
estimated using data from the previous 7 days by fitting the epidemiological dynamics
to the deterministic SIR model, taking into account the testing rates adopted. Panel A
shows the total number of infected I (orange curve) and infected-undetected (blue curve)
in a stochastic realization of the epidemic, along with the state estimates obtained from
the extended Kalman filter (dashed, black curves). Panel B shows the true (orange curve)
and estimated (blue curve) values of β.

S-9

