Algorithm is Experiment:
Machine Learning, Market Design, and Policy Eligibility Rules
Yusuke Narita

Kohei Yata∗

arXiv:2104.12909v1 [econ.EM] 26 Apr 2021

April 28, 2021

Abstract
Algorithms produce a growing portion of decisions and recommendations both in policy and business. Such algorithmic decisions are natural experiments (conditionally quasirandomly assigned instruments) since the algorithms make decisions based only on observable
input variables. We use this observation to develop a treatment-effect estimator for a class
of stochastic and deterministic algorithms. Our estimator is shown to be consistent and
asymptotically normal for well-defined causal effects. A key special case of our estimator
is a high-dimensional regression discontinuity design. The proofs use tools from differential
geometry and geometric measure theory, which may be of independent interest.
The practical performance of our method is first demonstrated in a high-dimensional
simulation resembling decision-making by machine learning algorithms. Our estimator has
smaller mean squared errors compared to alternative estimators. We finally apply our estimator to evaluate the effect of Coronavirus Aid, Relief, and Economic Security (CARES)
Act, where more than $10 billion worth of relief funding is allocated to hospitals via an
algorithmic rule. The estimates suggest that the relief funding has little effects on COVID19-related hospital activity levels. Naive OLS and IV estimates exhibit substantial selection
bias.

∗

Narita: Yale University, email: yusuke.narita@yale.edu. Yata: Yale University, email: kohei.yata@yale.edu.
We are especially indebted to Aneesha Parvathaneni and Richard Liu for expert research assistance. For their
suggestions, we are grateful to Tim Armstrong, Pat Kline and seminar participants at American Economic Association, Caltech, Columbia, CEMFI, Counterfactual Machine Learning Workshop, Econometric Society, European
Economic Association, Hitotsubashi, JSAI, Stanford, UC Irvine, the University of Tokyo, and Yale.

1

Introduction

Today’s society increasingly resorts to machine learning (“AI”) algorithms for decision-making
and resource allocation. For example, judges in the US make legal judgements aided by predictions from supervised machine learning (descriptive regression). Supervised learning is also
used by governments to detect potential criminals and terrorists, and finance companies (such as
banks and insurance companies) to screen potential customers. Tech companies like Facebook,
Microsoft, and Netflix allocate digital content by reinforcement learning and bandit algorithms.
Uber and other ride sharing services adjust prices using their surge pricing algorithms to take
into account local demand and supply information. Retailers and e-commerce platforms engage
in algorithmic pricing. Similar algorithms are encroaching on increasingly high-stakes settings,
such as in healthcare and the military.
Other types of algorithms also loom large. School districts, college admissions systems,
and labor markets use matching algorithms for position and seat allocations. Objects worth
astronomical sums of money change hands every day in algorithmically run auctions – not only
household objects, art and antiquities, but also securities, energy, and public procurements.
Many public policy domains like Medicaid often decide who are eligible based on algorithmic
rules.
All of the above, diverse examples share a common trait: a decision-making algorithm makes
decisions based only on its observable input variables. Conditional on the observable variables,
therefore, algorithmic treatment decisions are (quasi-)randomly assigned in the sense that they
are independent of any potential outcome or unobserved heterogeneity. This property turns
algorithm-based treatment decisions into instrumental variables (IVs) that can be used for measuring the causal effect of the final treatment assignment. The algorithm-based instrument may
produce regression-discontinuity-style local variation (e.g., machine judges), stratified randomization (e.g., several bandit and reinforcement learning algorithms), or some combination of the
two.
Based on the above observation, this paper shows how to use data obtained from algorithmic decision-making to identify and estimate causal effects. In our framework, the analyst
observes a random sample {(Yi , Xi , Di , Zi )}ni=1 , where Yi is the outcome of interest, Xi ∈ Rp
is a vector of pre-treatment covariates (algorithm’s input variables), Di is the binary treatment
assignment, possibly made by humans, and Zi is the binary treatment recommendation made
by some algorithm. The treatment recommendation Zi is randomly determined based on the
known probability M L(Xi ) = Pr(Zi = 1|Xi ) independently of everything else conditional on
Xi . The central assumption is that the analyst knows function M L and is able to simulate it.
That is, the analyst is able to compute the recommendation probability M L(x) given any input
value x ∈ Rp . The algorithm’s recommendation Zi may influence the final treatment assignment Di , determined as Di = Zi Di (1) + (1 − Zi )Di (0), where Di (z) is the potential treatment
assignment that would be realized if Zi = z. Finally, the observed outcome Yi is determined
as Yi = Di Yi (1) + (1 − Di )Yi (0), where Yi (1) and Yi (0) are potential outcomes that would be
realized if the individual were treated and not treated, respectively. This setup is an IV model
where the IV satisfies the conditional independence condition but may not satisfy the overlap

1

(full-support) condition. There appears to be no standard estimator for this setup.
Example. There is a rapidly growing trend of development and real-world implementation of
automated disease detection algorithms (Gulshan et al., 2016). Machine learning, in particular
deep learning, is used to detect various diseases and to predict patients at risk. Using our
framework described above, a detection algorithm predicts whether an individual i has a certain
disease (Zi = 1) or not (Zi = 0) based on a digital image Xi ∈ Rp of a part of the individual’s
body, where each Xij ∈ R denotes the intensity value of a pixel in the image. The algorithm
uses training data and machine learning (e.g., deep learning) to construct a binary classifier
M L : Rp → {0, 1}. The classifier takes an image of individual i as input and makes a binary
prediction of whether the individual has the disease:
Zi ≡ M L(Xi ).
The algorithm’s diagnosis Zi may influence the doctor’s treatment decision for the individual,
denoted by Di ∈ {0, 1}. We are interested in how the treatment decision Di affects the individual’s outcome Yi .
Within this framework, we first characterize the whole sources of causal-effect identification
(quasi-experimental variation) for a class of algorithms, nesting both stochastic and deterministic
ones. This class includes all of the aforementioned examples, thus nesting existing insights on
quasi-experimental variation in particular algorithms, such as surge pricing (Cohen, Hahn, Hall,
Levitt and Metcalfe, 2016), bandit (Li, Chu, Langford and Schapire, 2010), reinforcement learning
(Precup, 2000), supervised learning (Cowgill, 2018; Bundorf, Polyakova and Tai-Seale, 2019),
and market-design algorithms (Abdulkadiroğlu, Angrist, Narita and Pathak, 2017, Forthcoming;
Narita, 2020, 2021). Our framework also reveals new sources of identification for algorithms that,
at first sight, do not appear to produce a natural experiment.
The sources of causal-effect identification turn out to be summarized by a suitable modification of the Propensity Score (Rosenbaum and Rubin, 1983), which we call the Quasi Propensity
Score (QPS). The Quasi Propensity Score at covariate value x is the average probability of a
treatment recommendation in a shrinking neighborhood around x, defined as
R
∗
∗
B(x,δ) M L(x )dx
ML
R
p (x) ≡ lim
,
∗
δ→0
B(x,δ) dx
where B(x, δ) is a p-dimensional ball with radius δ centered at x. Conditional on the Quasi
Propensity Score, algorithmic decisions are quasi-randomly assigned. The Quasi Propensity Score
provides an easy-to-check condition for what causal effects the data from an algorithm allow us
to identify; non-degeneracy of the Quasi Propensity Score is both sufficient and necessary for
identification of average causal effects conditional on covariates. In particular, we show that the
conditional local average treatment effect (LATE; Imbens and Angrist, 1994) is identified for the
subpopulation with nondegenerate Quasi Propensity Score.
Based on the identification analysis, we offer a way of estimating treatment effects using the
algorithm-produced data. The treatment effects can be estimated by two-stage least squares
2

(2SLS) where we regress the outcome on the treatment with the algorithm’s recommendation
as an IV.1 To make the algorithmic recommendation a conditionally independent IV, we need
to control for appropriate variables. Motivated by the fact that algorithmic decision IVs are
quasi-randomly assigned conditional on the Quasi Propensity Score, we propose controlling for
the Quasi Propensity Score as follows.
1. Standardize each characteristic Xij to have mean zero and variance one for each j = 1, ..., p,
where p is the number of input characteristics.
2. For small bandwidth δ > 0 and a large number of simulation draws S, compute
ps (Xi ; δ) =

S
1X
∗
M L(Xi,s
),
S
s=1

∗ , ..., X ∗ are S independent simulation draws from the uniform distribution on
where Xi,1
i,S
B(Xi , δ).2

3. Using the observations with ps (Xi ; δ) ∈ (0, 1), run the following 2SLS IV regression:
Di = γ0 + γ1 Zi + γ2 ps (Xi ; δ) + νi (First Stage)
Yi = β0 + β1 Di + β2 ps (Xi ; δ) + i (Second Stage).
Let β̂1s be the estimated coefficient on Di .
As the main theoretical result, we prove the 2SLS estimator β̂1s is a consistent and asymptotically normal estimator of a well-defined causal effect (weighted average of conditional local average treatment effects). We also show that inference based on the conventional 2SLS
heteroskedasticity-robust standard errors is asymptotically valid as long as the bandwidth δ goes
to zero at an appropriate rate. We prove the asymptotic properties by exploiting results from
differential geometry and geometric measure theory. There appears to be no existing estimator
with these asymptotic properties even for a multidimensional RDD, a special case of our framework where the decision-making algorithm is deterministic and uses multiple input (running)
variables for determining treatment recommendations. Our estimator can therefore be considered as one of the few consistent and asymptotically normal estimators for a high-dimensional
RDD. Moreover, our asymptotic result applies to much more general settings with stochastic
algorithms, deterministic algorithms, and combinations of the two.
1

Recent empirical studies document that algorithmic treatment recommendations have impacts on final treatment assignment by humans (Cowgill, 2018; Bundorf et al., 2019).
2
For the bandwidth δ, we suggest to the analyst to consider several different values and check if the 2SLS
estimates are robust to bandwidth changes, as we often do in regression discontinuity design (RDD) applications.
It is hard to pick δ in a data-driven way. Common methods for bandwidth selection in univariate RDDs include
Imbens and Kalyanaraman (2012) and Calonico, Cattaneo and Titiunik (2014), who estimate the bandwidth
that minimizes the asymptotic mean squared error (AMSE). It is not straightforward to estimate the AMSEoptimal bandwidth in our setting with many running variables and complex IV assignment, since it requires
nonparametric estimation of functions on the high-dimensional covariate space such as conditional mean functions,
their derivatives, the curvature of the RDD boundary, etc.

3

The practical value of our estimator is demonstrated through simulation and an original application. We first conduct a Monte Carlo simulation mimicking real-world decision-making based
on machine learning. We consider a data-generating process combining stochastic and deterministic algorithms. Treatment recommendations are randomly assigned for a small experimental
segment of the population and are determined by a deterministic machine learning algorithm for
the rest of the population. The deterministic algorithm uses high-dimensional predictors. Our
estimator is shown to have smaller mean squared errors compared to alternative estimators.
Our empirical application is an analysis of COVID-19 relief funding. The Coronavirus Aid,
Relief, and Economic Security (CARES) Act and Paycheck Protection Program designated $175
billion for COVID-19 response efforts and reimbursement to health care entities for expenses or
lost revenues (Kakani, Chandra, Mullainathan and Obermeyer, 2020), as “financially insecure
hospitals may be less capable of investing in COVID-19 response efforts" (Khullar, Bond and
Schpero, 2020). We ask whether this problem is alleviated by the relief funding to hospitals.
We identify the causal effects of the relief funding by exploiting the funding eligibility rule.
The government employs an algorithmic rule to decide which hospitals are eligible for funding.
This fact allows us to apply our 2SLS with Quasi-Propensity-Score controls to estimate the effect
of relief funding. Specifically, 2SLS estimators use eligibility status as an instrumental variable
for funding amounts, while controlling for the Quasi Propensity Score induced by the eligibilitydetermining algorithm. The resulting estimates suggest that COVID-19 relief funding has little
effect on outcomes, such as the number of COVID-19 patients hospitalized and in ICU at each
hospital. The estimated effects of causal relief funding are much smaller and less significant
than the naive ordinary least squares (OLS) or 2SLS estimates with no controls. This finding
contributes to emerging work on how healthcare providers respond to financial shocks (Duggan,
2000; Dranove, Garthwaite and Ody, 2017).

Related Literature
Theoretically, our framework integrates the classic propensity-score (selection-on-observables)
scenario with a multidimensional extension of the RDD. We analyze this integrated setup in the
IV world with noncompliance. Our estimator applies to this general setting, which allows for
both stochastic IV assignment (the propensity-score scenario) and deterministic IV assignment
(the high-dimensional RDD). This general setting appears to have no prior established estimator.
Armstrong and Kolesár (2020) provide an estimator for a related setting with perfect compliance.3
When we adapt our estimator to the sharp multidimensional RDD case, our estimator has
three features. First, it is a consistent and asymptotically normal estimator of a well-interpreted
causal effect (average of conditional treatment effects along the RDD boundary) even if treatment
effects are heterogeneous. Second, it uses observations near all the boundary points as opposed
to using only observations near one specific boundary point, which avoids variance explosion
3

Building on their prior work (Armstrong and Kolesár, 2018), Armstrong and Kolesár (2020) consider estimation and inference on average treatment effects under the assumption that the final treatment assignment is
independent of potential outcomes conditional on observables. Their estimator is not applicable to the IV world
we consider. Their method and our method also achieve different goals; their goal lies in finite-sample optimality
and asymptotically valid inference while our goal is to obtain consistency and asymptotic normality.

4

even when Xi is high dimensional. Third, it can be easily implemented even in cases with highdimensional data and complex algorithms (RDD boundaries), where identifying the decision
boundary from a general decision algorithm is hard. No prior estimator appears to have all of
these properties (Papay, Willett and Murnane, 2011; Zajonc, 2012; Wong, Steiner and Cook,
2013; Keele and Titiunik, 2015; Cattaneo, Titiunik, Vazquez-Bare and Keele, 2016; Imbens and
Wager, 2019). In Appendix A.1, we provide a detailed review of the most closely related papers
on the multidimensional RDD.
The Quasi Propensity Score used in this paper also shares its spirit with the local random
assignment interpretation of the RDD, discussed by Hahn, Todd and van der Klaauw (2001),
Frölich (2007), Cattaneo, Frandsen and Titiunik (2015), Cattaneo, Titiunik and Vazquez-Bare
(2017), Frandsen (2017), Sekhon and Titiunik (2017), Frölich and Huber (2019) and Abdulkadiroğlu et al. (Forthcoming). These papers provide special cases of this paper’s framework.
Substantively, there are heated discussions about whether algorithmic decisions are “better”
than human decisions, where “better” is in terms of fairness and efficiency (Hoffman, Kahn and
Li, 2017; Horton, 2017; Kleinberg, Lakkaraju, Leskovec, Ludwig and Mullainathan, 2017). In
this study, we take a complementary perspective in that we take a decision algorithm as given, no
matter whether it is good or bad, and study how to use its produced data for impact evaluation.
This paper also relates to the emerging literature on the integration of machine learning,
causal inference, and the social sciences. While we are interested in machine learning as a
data-production tool, the existing literature (except the above mentioned strand) focuses on
machine learning as a data-analysis tool. For example, a set of predictive studies applies machine
learning to make predictions important for social policy questions (Kleinberg et al., 2017; Einav,
Finkelstein, Mullainathan and Obermeyer, 2018). Another set of causal and structural work
repurposes machine learning to aid with causal inference and structural econometrics (Athey and
Imbens, 2017; Belloni, Chernozhukov, Fernández-Val and Hansen, 2017; Bonhomme, Lamadon
and Manresa, 2019; Mullainathan and Spiess, 2017). We supplement these studies by highlighting
the role of machine learning as a data-production tool.

2

Framework

Our framework is a mix of the conditional independence, high-dimensional RDD, and instrumental variable scenarios. We are interested in the effect of some binary treatment Di ∈ {0, 1}
on some outcome of interest Yi ∈ R in the setup in the introduction. As is standard in the
literature, we impose the exclusion restriction that the treatment recommendation Zi ∈ {0, 1}
does not affect the observed outcome other than through the treatment assignment Di . This
allows us to define the potential outcomes indexed against the treatment assignment Di alone.4
We consider algorithms that make treatment recommendations based solely on individual i’s
predetermined, observable covariates Xi = (Xi1 , ..., Xip )0 ∈ Rp . Let the function M L : Rp →
[0, 1] represent the decision algorithm, where M L(Xi ) = Pr(Zi = 1|Xi ) is the probability that
4

Formally, let Yi (d, z) denote the potential outcome that would be realized if i’s treatment assignment and
recommendation were d and z, respectively. The exclusion restriction assumes that Yi (d, 1) = Yi (d, 0) for d ∈ {0, 1}
(Imbens and Angrist, 1994).

5

the treatment is recommended for individual i with covariates Xi .5 We assume that the analyst
knows the algorithm M L and is able to simulate it. That is, the analyst is able to compute the
recommendation probability M L(x) given any input value x ∈ Rp . In typical machine-learning
scenarios, an algorithm first applies machine learning on Xi to make some prediction and then
uses the prediction to output the recommendation probability M L(Xi ). The treatment recommendation Zi for individual i is then randomly determined based on the probability M L(Xi )
independently of everything else. Consequently, the following conditional independence property holds regardless of how the algorithm is constructed and how the algorithm computes a
recommendation probability.
Property 1 (Conditional Independence). Zi ⊥
⊥(Yi (1), Yi (0), Di (1), Di (0))|Xi .
Let Yzi be defined as Yzi ≡ Di (z)Yi (1) + (1 − Di (z))Yi (0) for z ∈ {0, 1}. Yzi is the potential outcome when the treatment recommendation is Zi = z. It follows from Property 1 that
Zi ⊥
⊥(Y1i , Y0i )|Xi .
Note that the codomain of M L contains 0 and 1, allowing for deterministic treatment assignments conditional on Xi . Our framework therefore nests the RDD as a special case.6 Another
special case of our framework is the classic conditional independence scenario with the common
support condition (M L(Xi ) ∈ (0, 1) almost surely). In addition to these simple settings, this
framework nests many other situations, such as multidimensional RDDs and complex machine
learning and market-design algorithms, as illustrated in Section 7.
We put a few assumptions on the covariates Xi and the M L algorithm. To simplify the
exposition, the main text assumes that the distribution of Xi is absolutely continuous with
respect to the Lebesgue measure. In practice, the input variables of an algorithm often include
discrete variables. Appendix A.3 extends the analysis and proposed method to the case where
some covariates in Xi are discrete. Let X be the support of Xi , X0 = {x ∈ X : M L(x) = 0},
X1 = {x ∈ X : M L(x) = 1}, Lp be the Lebesgue measure on Rp , and int(A) denote the interior
of a set A ⊂ Rp .
Assumption 1.
(a) (Almost Everywhere Continuity of M L) M L is continuous almost everywhere with respect
to the Lebesgue measure.
(b) (Measure Zero Boundaries of X0 and X1 ) Lp (Xk ) = Lp (int(Xk )) for k = 0, 1.
Assumption 1 (a) allows the function M L to be discontinuous on a set of points with the
Lebesgue measure zero. For example, M L is allowed to be a discontinuous step function as long
as it is continuous almost everywhere. Assumption 1 (b) holds if the Lebesgue measures of the
boundaries of X0 and X1 are zero.
5

We assume that the function M L is supported on Rp irrespective of the support of Xi .
Most of the existing studies on RDDs define the potential treatment assignment indexed against the running variable like Di (x), which represents the counterfactual treatment assignment the individual i would have
received if her running variable had been set to x. Unlike prior work, we define it indexed against the treatment
recommendation z.
6

6

3

Identification

What causal effects can be learned from data (Yi , Xi , Di , Zi ) generated by the M L algorithm?
A key step toward answering this question is what we call the Quasi Propensity Score (QPS).
To define it, let:
R
∗
∗
B(x,δ) M L(x )dx
R
pM L (x; δ) ≡
,
∗
B(x,δ) dx
where B(x, δ) = {x∗ ∈ Rp : kx − x∗ k < δ} is the (open) δ-ball around x ∈ X .7 Here, k · k
denotes the Euclidean distance on Rp . To make common δ for all dimensions reasonable, we
normalize Xij to have mean zero and variance one for each j = 1, ..., p.8 We assume that M L is
a Lp -measurable function so that the integrals exist. We then define QPS as follows:
pM L (x) ≡ lim pM L (x; δ).
δ→0

QPS at x is the average probability of a treatment recommendation in a shrinking ball around
x.9 We call this the Quasi Propensity Score, since this score modifies the standard propensity
score M L(Xi ) to incorporate local variation in the score. We discuss when QPS exists in Section
3.1.
Figure 1 illustrates QPS. In the example, Xi is two dimensional, and the support of Xi is
divided into three sets depending on the value of M L. For the interior points of each set, QPS
is equal to M L (as formally implied by Part 2 of Corollary 2 below). On the border of any two
sets, QPS is the average of the M L values in the two sets. Thus, pM L (x) = 21 (0 + 0.5) = 0.25
for any x in the open line segment AB, pM L (x) = 21 (0.5 + 1) = 0.75 for any x in the open line
segment BC, and pM L (x) = 12 (0 + 1) = 0.5 for any x in the open line segment BD.
QPS provides an easy-to-check condition for whether an algorithm allows us to identify causal
effects. Here we say that a causal effect is identified if it is uniquely determined by the joint
distribution of (Yi , Xi , Di , Zi ). Our identification analysis uses the following continuity condition.
Assumption 2 (Local Mean Continuity). For z ∈ {0, 1}, the conditional expectation functions
E[Yzi |Xi ] and E[Di (z)|Xi ] are continuous at any point x ∈ X such that pM L (x) ∈ (0, 1) and
M L(x) ∈ {0, 1}.
7

Whether we use an open ball or closed ball does not affect pM L (x; δ). When we instead use a rectangle,
ellipsoid, or any standard kernel function to define pM L (x; δ), the limit limδ→0 pM L (x; δ) may be different at some
points (e.g., at discontinuity points of M L), but the same identification results hold under suitable conditions.
We use a ball for simplicity and practicality.
8
This normalization is without loss of generality in the following sense. Take a vector Xi∗ of any continuous
random variables and M L∗ : Rp → [0, 1]. The normalization induces the random vector Xi = A(Xi∗ − E[Xi∗ ]),
where A is a diagonal matrix with diagonal entries Var(X1∗ )1/2 , ..., Var(X1∗ )1/2 . Let M L(x) = M L∗ (A−1 x+E[Xi∗ ]).
i1

ip

Then (Xi∗ , M L∗ ) is equivalent to (Xi , M L) in the sense that M L(Xi ) = M L∗ (Xi∗ ) for any individual i.
9
The idea behind QPS shares some of its spirit with the local randomization interpretation of RDDs (Frölich,
2007; Cattaneo et al., 2015, 2017): the treatment assignment is considered as good as randomly assigned in a
neighborhood of the cutoff.

7

Assumption 2 is a natural multivariate extension of the local mean continuity condition that is
frequently assumed in the RDD.10 M L(x) ∈ {0, 1} means that the treatment recommendation Zi
is deterministic conditional on Xi = x. If QPS at the point x is nondegenerate (pM L (x) ∈ (0, 1)),
however, there exists a point close to x that has a different value of M L from x’s, which creates
variation in the treatment recommendation near x. For any such point x, Assumption 2 requires
that the points close to x have similar conditional means of the outcome Yzi and treatment
assignment Di (z).11 Note that Assumption 2 does not require continuity of the conditional
means at x for which M L(x) ∈ (0, 1), since the identification of the conditional means at such
points follows from Property 1 without continuity.
Under the above assumptions, the following identification result holds.
Proposition 1 (Identification). Under Assumptions 1 and 2:
(a) E[Y1i − Y0i |Xi = x] and E[Di (1) − Di (0)|Xi = x] are identified for every x ∈ int(X ) such
that pM L (x) ∈ (0, 1).12
(b) Let A be any open subset of X such that pM L (x) exists for all x ∈ A. Then either E[Y1i −
Y0i |Xi ∈ A] or E[Di (1) − Di (0)|Xi ∈ A] or both are identified only if pM L (x) ∈ (0, 1) for
almost every x ∈ A (with respect to the Lebesgue measure).13
Proof. See Appendix C.1.
Proposition 1 characterizes a necessary and sufficient condition for identification. Part (a)
says that the average effects of the treatment recommendation Zi on the outcome Yi and on
the treatment assignment Di for the individuals with Xi = x are both identified if QPS at x is
neither 0 nor 1. Non-degeneracy of QPS at x implies that there are both types of individuals
who receive Zi = 1 and Zi = 0 among those whose Xi is close to x. Assumption 2 ensures that
these individuals are similar in terms of average potential outcomes and treatment assignments.
We can therefore identify the average effects conditional on Xi = x. In Figure 1, pM L (x) ∈ (0, 1)
holds for any x in the shaded region (the union of the minor circular segment made by the chord
AC and the line segment BD).
10

In the RDD with a single running variable, the point x for which pM L (x) ∈ (0, 1) and M L(x) ∈ {0, 1} is the
cutoff point at which the treatment probability discontinuously changes.
11
In the context of the RDD with a single running variable, one sufficient condition for continuity of E[Yzi |Xi ] is
a local independence condition in the spirit of Hahn et al. (2001): (Yi (1), Yi (0), Di (1), Di (0)) is independent of Xi
near x. A weaker sufficient condition, which allows such dependence, is that E[Yi (d)|Di (1) = d1 , Di (0) = d0 , Xi ]
and Pr(Di (1) = d1 , Di (0) = d0 |Xi ) are continuous at x for every d ∈ {0, 1} and (d1 , d0 ) ∈ {0, 1}2 (Dong, 2018).
This assumes that the conditional means of the potential outcomes for each of the four types determined based
on the potential treatment assignment Di (z) and the conditional probabilities of those types are continuous at
the cutoff. These two sets of conditions are sufficient for continuity of E[Yzi |Xi ] regardless of the dimension of
Xi , accommodating multidimensional RDDs.
12
The causal effects may not be identified at a boundary point x of X for which pM L (x) ∈ (0, 1). For example,
if M L(x∗ ) = 1 for all x∗ ∈ B(x, δ) ∩ X and M L(x∗ ) = 0 for all x∗ ∈ B(x, δ) \ X for any sufficiently small δ > 0,
pM L (x) ∈ (0, 1) but the causal effects are not identified at x since Pr(Zi = 0|Xi ∈ B(x, δ)) = 0.
13
We assume that pM L is a Lp -measurable function so that {x ∈ A : pM L (x) = 0} and {x ∈ A : pM L (x) = 1}
are Lp -measurable.

8

R
A consequence of Part (a) is that it is possible to identify {x∗ ∈int(X ):pM L (x∗ )∈(0,1)} ω(x)E[Y1i −
R
Y0i |Xi = x]dµ(x) and {x∗ ∈int(X ):pM L (x∗ )∈(0,1)} ω(x)E[Di (1) − Di (0)|Xi = x]dµ(x) for any known
or identified function ω : Rp → R and any measure µ provided that the integrals exist.
Part (a) nests two well-known identification results as special cases. First, suppose that
M L(x) ∈ (0, 1) for every x ∈ X . This corresponds to the classic conditional independence
setting (or stratified randomization setting) with nondegenerate assignment probability, in which
conditional average causal effects are identified (see for example Angrist and Pischke (2008)).
Second, suppose that M L(x) ∈ {0, 1} for all x ∈ X but the value of M L discontinuously changes
at some point x∗ so that pM L (x∗ ) ∈ (0, 1). This case corresponds to an RDD, in which the
average causal effect at a boundary point is identified under continuity of conditional expectation
functions of potential outcomes (Hahn et al., 2001; Keele and Titiunik, 2015).
Part (b) provides a necessary condition for identification. It says that if the average effect
of the treatment recommendation conditional on Xi being in some open set A is identified, then
we must have pM L (x) ∈ (0, 1) for almost every x ∈ A. If, to the contrary, there is a subset of
A of nonzero measure for which pM L (x) = 1 (or pM L (x) = 0), then Zi has no variation in the
subset, which makes it impossible to identify the average effect for the subset.
Proposition 1 concerns causal effects of treatment recommendation, not of treatment assignment. The proposition implies that the conditional average treatment effects and the conditional
local average treatment effects (LATEs) are identified under additional assumptions.
Corollary 1 (Perfect and Imperfect Compliance). Under Assumptions 1 and 2:
(a) The average treatment effect conditional on Xi = x, E[Yi (1) − Yi (0)|Xi = x], is identified
for every x ∈ int(X ) such that pM L (x) ∈ (0, 1) and Pr(Di (1) > Di (0)|Xi = x) = 1 (perfect
compliance).
(b) Let A be any open subset of X such that pM L (x) exists for all x ∈ A, and Pr(Di (1) >
Di (0)|Xi ∈ A) = 1. Then E[Yi (1) − Yi (0)|Xi ∈ A] is identified only if pM L (x) ∈ (0, 1) for
almost every x ∈ A.
(c) The local average treatment effect conditional on Xi = x, E[Yi (1)−Yi (0)|Di (1) 6= Di (0), Xi =
x], is identified for every x ∈ int(X ) such that pM L (x) ∈ (0, 1), Pr(Di (1) ≥ Di (0)|Xi =
x) = 1 (monotonicity), and Pr(Di (1) 6= Di (0)|Xi = x) > 0 (existence of compliers).
(d) Let A be any open subset of X such that pM L (x) exists for all x ∈ A, Pr(Di (1) ≥ Di (0)|Xi ∈
A) = 1, and Pr(Di (1) 6= Di (0)|Xi ∈ A) > 0. Then E[Yi (1) − Yi (0)|Di (1) 6= Di (0), Xi ∈ A]
is identified only if pM L (x) ∈ (0, 1) for almost every x ∈ A.
Proof. See Appendix C.2.
Non-degeneracy of QPS pM L (x) therefore summarizes what causal effects the data from M L
identify. Note that the key condition (pM L (x) ∈ (0, 1)) holds for some points x for every standard
algorithm except trivial algorithms that always recommend a treatment with probability 0 or 1.
Therefore, the data from almost every algorithm identify some causal effect.

9

3.1

Existence of the Quasi Propensity Score

The above results assume that QPS exists, but is it fair to assume so? In general, QPS may fail
to exist; we provide such an example in Appendix A.2. Nevertheless, it exists for most covariate
points and typical M L algorithms. For each x ∈ X and each q ∈ Supp(M L(Xi )), define
Ux,q ≡ {u ∈ B(0, 1) : lim M L(x + δu) = q},
δ→0

where 0 ∈ Rp is a vector of zeros. Ux,q is the set of vectors in B(0, 1) such that the value of M L
approaches q as we approach x from the direction of the vector. With this notation, we obtain
a sufficient condition for the existence of QPS at a point x.
Proposition 2. Take any x ∈ X . If there exists a countable set Q ⊂ Supp(M L(Xi )) such that
Lp (∪q∈Q Ux,q ) = Lp (B(0, 1)) and Ux,q is Lp -measurable for all q ∈ Q, then pM L (x) exists and is
given by
P
p
q∈Q qL (Ux,q )
ML
p (x) =
.
Lp (B(0, 1))
Proof. See Appendix C.3.
If almost every point in B(0, 1) is contained by one of countably many Ux,q ’s, therefore, QPS
exists and is equal to the weighted average of the values of q with the weight proportional to the
hypervolume of Ux,q . This result implies that QPS exists in practically important cases.
Corollary 2.
1. (Continuity points) If M L is continuous at x ∈ X , then pM L (x) exists and pM L (x) =
M L(x).
2. (Interior points) Let Xq = {x ∈ X : M L(x) = q} for some q ∈ [0, 1]. Then, for any interior
point x ∈ int(Xq ), pM L (x) exists and pM L (x) = q.
3. (Smooth boundary points) Suppose that {x ∈ X : M L(x) = q1 } = {x ∈ X : f (x) ≥ 0} and
{x ∈ X : M L(x) = q2 } = {x ∈ X : f (x) < 0} for some q1 , q2 ∈ [0, 1], where f : Rp → R.
Let x ∈ X be a boundary point such that f (x) = 0, and suppose that f is continuously
differentiable in a neighborhood of x with ∇f (x) = ( ∂f∂x(x)
, ..., ∂f∂x(x)
)0 6= 0. In this case,
p
1
pM L (x) exists and pM L (x) = 21 (q1 + q2 ).
4. (Intersection points under CART and random forests) Let p = 2, and suppose that {x ∈ X :
M L(x) = q1 } = {(x1 , x2 )0 ∈ X : x1 ≤ 0 or x2 ≤ 0}, {x ∈ X : M L(x) = q2 } = {(x1 , x2 )0 ∈
X : x1 > 0, x2 > 0}, and 0 = (0, 0)0 ∈ X . This is an example in which tree-based algorithms
such as Classification And Regression Tree (CART) and random forests are used to create
M L. In this case, pM L (0) exists and pM L (0) = 43 q1 + 14 q2 .
Proof. See Appendix C.4.

10

4

Estimation

The sources of quasi-random assignment characterized in Proposition 1 suggest a way of estimating causal effects of the treatment. In view of Proposition 1, it is possible to nonparametrically
estimate conditional average causal effects E[Y1i − Y0i |Xi = x] and E[Di (1) − Di (0)|Xi = x] for
points x such that pM L (x) ∈ (0, 1). This approach is hard to use in practice, however, when Xi
is high dimensional.
We instead seek an estimator that aggregates conditional effects at different points into a single average causal effect. Proposition 1 suggests that conditioning on QPS makes algorithm-based
treatment recommendation quasi-randomly assigned. This motivates the use of an algorithm’s
recommendation as an instrument conditional on QPS, which we operationalize as follows.

4.1

Two-Stage Least Squares Meets QPS

Suppose that we observe a random sample {(Yi , Xi , Di , Zi )}ni=1 of size n from the population
whose data generating process is described in the introduction and Section 2. Consider the
following 2SLS regression using the observations with pM L (Xi ; δn ) ∈ (0, 1):
Di = γ0 + γ1 Zi + γ2 pM L (Xi ; δn ) + νi
Yi = β0 + β1 Di + β2 p

ML

(Xi ; δn ) + i ,

(1)
(2)

where bandwidth δn shrinks toward zero as the sample size n increases. Let Ii,n = 1{pM L (Xi ; δn ) ∈
(0, 1)}, Di,n = (1, Di , pM L (Xi ; δn ))0 , and Zi,n = (1, Zi , pM L (Xi ; δn ))0 . The 2SLS estimator β̂ is
then given by
n
n
X
X
β̂ = (
Zi,n D0i,n Ii,n )−1
Zi,n Yi Ii,n .
i=1

i=1

Let β̂1 denote the 2SLS estimator of β1 in the above regression.
The above regression uses true QPS pM L (Xi ; δn ), but it may be difficult to analytically
compute if M L is complex. In such a case, we propose to approximate pM L (Xi ; δn ) using brute
force simulation. We draw a value of x from the uniform distribution on B(Xi , δn ) a number
of times, compute M L(x) for each draw, and take the average of M L(x) over the draws.14
∗ , ..., X ∗
Formally, let Xi,1
i,Sn be Sn independent draws from the uniform distribution on B(Xi , δn ),
and calculate
Sn
1 X
s
∗
M L(Xi,s
).
p (Xi ; δn ) =
Sn
s=1

We compute
for each i = 1, ..., n independently across i so that ps (X1 ; δn ), ..., ps (Xn ; δn )
are independent of each other. For fixed n and Xi , the approximation error relative to true
√
pM L (Xi ; δn ) has a 1/ Sn rate of convergence.15 This rate does not depend on the dimension of
Xi , so the simulation error can be made negligible even when Xi is high dimensional.
ps (Xi ; δn )

14

See Appendix A.5 for how to efficiently sample from the uniform
distribution on a p-dimensional ball.
√
More precisely, we have |ps (Xi ; δn ) − pM L (Xi ; δn )| = Ops (1/ Sn ), where Ops indicates the stochastic boundedness in terms of the probability distribution of the Sn simulation draws.
15

11

Now consider the following simulation version of the 2SLS regression using the observations
with ps (Xi ; δn ) ∈ (0, 1):
Di = γ0 + γ1 Zi + γ2 ps (Xi ; δn ) + νi
s

Yi = β0 + β1 Di + β2 p (Xi ; δn ) + i .

(3)
(4)

Let β̂1s denote the 2SLS estimator of β1 in the simulation-based regression. This regression is
the same as the 2SLS regression (1) and (2) except that we use the simulated QPS ps (Xi ; δn ) in
place of pM L (Xi ; δn ).16

4.2

Consistency and Asymptotic Normality

We establish the consistency and asymptotic normality of the 2SLS estimators β̂1 and β̂1s . Our
consistency and asymptotic normality result uses the following assumptions.
Assumption 3.
(a) (Finite Moment) E[Yi4 ] < ∞.
(b) (Nonzero First Stage) There exists a constant c > 0 such that E[Di (1) − Di (0)|Xi = x] > c
for every x ∈ X such that pM L (x) ∈ (0, 1).
(c) (Nonzero Conditional Variance) If Pr(M L(Xi ) ∈ (0, 1)) > 0, then Var(M L(Xi )|M L(Xi ) ∈
(0, 1)) > 0.
If Pr(M L(Xi ) ∈ (0, 1)) = 0, then the following conditions (d)–(g) hold.
(d) (Nonzero Variance) Var(M L(Xi )) > 0.
For a set A ⊂ Rp , let cl(A) denote the closure of A and let ∂A denote the boundary of A,
i.e., ∂A = cl(A) \ int(A).
(e) (C 2 Boundary of Ω∗ ) There exists a partition {Ω∗1 , ..., Ω∗M } of Ω∗ = {x ∈ Rp : M L(x) = 1}
(the set of the covariate points whose M L value is one) such that
(i) dist(Ω∗m , Ω∗m0 ) > 0 for any m, m0 ∈ {1, ..., M } such that m 6= m0 . Here dist(A, B) =
inf x∈A,y∈B kx − yk is the distance between two sets A and B ⊂ Rp ;
(ii) Ω∗m is nonempty, bounded, open, connected and twice continuously differentiable for
each m ∈ {1, ..., M }. Here we say that a bounded open set A ⊂ Rp is twice continuously
differentiable if for every x ∈ A, there exists a ball B(x, ) and a one-to-one mapping
16

In many industry and policy applications, the analyst is only able to change the algorithm’s recommendation
Zi by redesigning the algorithm. In this case, the effect of recommendation Zi on outcome Yi may also be of
interest to the practitioner. We can estimate the effect of recommendation by running the following ordinary least
squares (OLS) regression using the observations with ps (Xi ; δ) ∈ (0, 1):
Yi = α0 + α1 Zi + α2 ps (Xi ; δ) + ui .
The estimated coefficient on Zi , α̂1s , is our preferred estimator of the recommendation effect.

12

ψ from B(x, ) onto an open set D ⊂ Rp such that ψ and ψ −1 are twice continuously
differentiable, ψ(B(x, ) ∩ A) ⊂ {(x1 , ..., xp ) ∈ Rp : xp > 0} and ψ(B(x, ) ∩ ∂A) ⊂
{(x1 , ..., xp ) ∈ Rp : xp = 0}.
Let fX denote the probability density function of Xi and let Hk denote the k-dimensional
Hausdorff measure on Rp .17
(f ) (Regularity of Deterministic M L)
R
(i) Hp−1 (∂Ω∗ ) < ∞, and ∂Ω∗ fX (x)dHp−1 (x) > 0.
(ii) There exists δ > 0 such that M L(x) = 0 for almost every x ∈ N (X , δ) \ Ω∗ , where
N (A, δ) = {x ∈ Rp : kx − yk < δ for some y ∈ A} for a set A ⊂ Rp and δ > 0.
(g) (Conditional Moments and Density near ∂Ω∗ ) There exists δ > 0 such that
(i) E[Y1i |Xi ], E[Y0i |Xi ], E[Di (1)|Xi ], E[Di (0)|Xi ] and fX are continuously differentiable
and have bounded partial derivatives on N (∂Ω∗ , δ);
(ii) E[Y1i2 |Xi ], E[Y0i2 |Xi ], E[Y1i Di (1)|Xi ] and E[Y0i Di (0)|Xi ] are continuous on N (∂Ω∗ , δ);
(iii) E[Yi4 |Xi ] is bounded on N (∂Ω∗ , δ).
Assumption 3 is a set of conditions for establishing consistency. Assumption 3 (b) assumes
that, conditional on each value of Xi for which QPS is nondegenerate, more individuals would
change their treatment assignment status from 0 to 1 in response to treatment recommendation
than would change it from 1 to 0.18 Under this assumption, the estimated first-stage coefficient on
Zi converges to a positive quantity. Note that, if there exists c < 0 such that E[Di (1)−Di (0)|Xi =
x] < c for every x ∈ X with pM L (x) ∈ (0, 1), changing the labels of treatment recommendation
makes Assumption 3 (b) hold.
Assumption 3 (c) rules out potential multicollinearity. If the support of M L(Xi ) contains
only one value in (0, 1), pM L (Xi ; δn ) is asymptotically constant and equal to M L(Xi ) conditional on pM L (Xi ; δn ) ∈ (0, 1), resulting in the multicollinearity between pM L (Xi ; δn ) and the
constant term. Although dropping the constant term from the 2SLS regression solves this issue,
Assumption 3 (c) allows us to only consider the regression with a constant for the purpose of
simplifying the presentation. In Appendix C.6, we provide 2SLS estimators that are consistent
and asymptotically normal even if we do not know whether Assumption 3 (c) holds.
Assumption 3 (d)–(g) are a set of conditions we require for proving consistency and asymptotic normality of β̂1 when M L is deterministic and produces only multidimensional regressiondiscontinuity variation. Assumption 3 (d) says that M L produces variation in the treatment
recommendation.
17

The k-dimensional Hausdorff measure on Rp is defined as follows. Let Σ be the Lebesgue σ-algebra on Rp
P
k
(the set of all Lebesgue measurable sets on Rp ). For A ∈ Σ and δ > 0, let Hδk (A) = inf{ ∞
j=1 d(Ej ) : A ⊂
∞
p
∪j=1 Ej , d(Ej ) < δ, Ej ⊂ R for all j}, where d(E) = sup{kx − yk : x, y ∈ E}. The k-dimensional Hausdorff
measure of A on Rp is Hk (A) = limδ→0 Hδk (A).
18
At the cost of making the presentation more complex, the assumption can be relaxed so that the sign of
E[Di (1) − Di (0)|Xi = x] is allowed to vary over x with pM L (x) ∈ (0, 1).

13

Assumption 3 (e) imposes the differentiability of the boundary of Ω∗ = {x ∈ Rp : M L(x) =
1}. The conditions are satisfied if, for example, Ω∗ = {x ∈ Rp : f (x) ≥ 0} for some twice
continuously differentiable function f : Rp → R such that ∇f (x) 6= 0 for all x ∈ Rp with f (x) = 0.
Ω∗ takes this form, for example, when the conditional treatment effect E[Yi (1) − Yi (0)|X] is
predicted by supervised learning based on smooth models such as lasso and ridge regressions, and
treatment is recommended to individuals who are estimated to experience nonnegative treatment
effects.
In general, the differentiability of Ω∗ may not hold. For example, if tree-based algorithms
such as Classification And Regression Tree (CART) and random forests are used to predict the
conditional treatment effect, the predicted conditional treatment effect function is not differentiable at some points. Although the resulting Ω∗ does not exactly satisfy Assumption 3 (e), the
assumptions approximately hold in that Ω∗ is arbitrarily well approximated by a set that satisfies
the differentiability condition.19
Part (i) of Assumption 3 (f) says that the boundary of Ω∗ is (p − 1) dimensional and that
the boundary has nonzero density. Part (ii) puts a weak restriction on the values M L takes on
outside the support of Xi . It requires that M L(x) = 0 for almost every x ∈
/ Ω∗ that is outside
X but is in the neighborhood of X . M L(x) may take on any value if x is not close to X . These
conditions hold in practice.20
Assumption 3 (g) imposes continuity, continuous differentiability and boundedness on the
conditional moments of potential outcomes and the probability density near the boundary of Ω∗ .
When M L is stochastic, asymptotic normality requires additional assumptions. Let
C ∗ = {x ∈ Rp : M L is continuously differentiable at x},
and let D∗ = Rp \ C ∗ be the set of points at which M L is not continuously differentiable.
Assumption 4. If Pr(M L(Xi ) ∈ (0, 1)) > 0, then the following conditions (a)–(c) hold.
(a) (Probability of Neighborhood of D∗ ) Pr(Xi ∈ N (D∗ , δ)) = O(δ).
(b) (Bounded Partial Derivatives of M L) The partial derivatives of M L are bounded on C ∗ .
(c) (Bounded Conditional Mean) E[Yi |Xi ] is bounded on X .
Assumption 4 is required for proving asymptotic normality of β̂1 when M L is stochastic. To
explain the role of Assumption 4 (a), consider a path of covariate points xδ ∈ N (D∗ , δ) ∩ C ∗
indexed by δ > 0. Since M L is continuous at xδ , pM L (xδ ) = M L(xδ ) as implied by Part 1
of Corollary 2. However, pM L (xδ ; δ) does not necessarily get sufficiently close to M L(xδ ) even
Consider the example in Part 4 of Corollary 2 with q1 = 0 and q2 = 1. In this example, Ω∗ = {x ∈ R2 : x1 >
2
2
1
0, x2 > 0}. Let {Ωk }∞
k=1 be a sequence of subsets of R , where Ωk = {x ∈ R : x2 ≥ kx1 , x1 > 0} for each k. Ωk
∗
is twice continuously differentiable for all k, and well approximates Ω for a large k in that dH (Ω∗ , Ωk ) → 0 as
k → ∞, where dH (A, B) = max{supx∈A inf y∈B kx − yk, supy∈B inf x∈A kx − yk} is the Hausdorff distance between
two sets A and B ⊂ Rp .
20
The boundary of Ω∗ fails to be (p − 1) dimensional, for example, when the covariate space is three dimensional
(p = 3) and Ω∗ is a straight line, not a set with nonzero volume nor even a plane. In this example, the boundary
is the same as Ω∗ , and its two-dimensional Hausdorff measure is zero.
19

14

as δ → 0, since xδ is in the δ-neighborhood of D∗ and hence M L may discontinuously change
within the δ-ball B(xδ , δ). Assumption 4 (a) requires that the probability of Xi being in the δneighborhood of D∗ shrinks to zero at the rate of δ, which makes the points in the neighborhood
negligible.
Assumption 4 (a) often holds in practice. If M L is continuously differentiable on X , then
∗
D ∩ X = ∅, so this condition holds. If, for example, the treatment recommendation is randomly
assigned based on a stratified randomized experiment or on the -Greedy algorithm (see Part 2
(a) of Example 1 in Section 7), D∗ is the boundary at which the recommendation probability
changes discontinuously. For any boundary of standard shape, the probability of Xi being in the
δ-neighborhood of the boundary vanishes at the rate of δ, and the required condition is satisfied.
We provide a sufficient condition for this condition in Appendix A.4.
Assumption 4 (b) and (c) are regularity conditions, imposing the boundedness of the partial
derivatives of M L and of the conditional mean of the outcome.
Assumption 5 (The Number of Simulation Draws). n−1/2 Sn → ∞, and Pr(pM L (Xi ; δn ) ∈
n
log n
−1/2 δ 1/2 ) for some γ > 1 .
(0, γ log
n
Sn ) ∪ (1 − γ Sn , 1)) = o(n
2
Assumption 5 is the key to proving asymptotic normality of the simulation-based estimator
Assumption 5 says that we need to choose the number of simulation draws Sn so that it
grows to infinity faster than n1/2 , and that the probability that pM L (Xi ; δn ) lies on the tails
n
log n
−1/2 δ 1/2 . This condition makes the bias caused
(0, γ log
n
Sn ) ∪ (1 − γ Sn , 1) vanishes faster than n
s
M
L
by using p (Xi ; δn ) instead of p (Xi ; δn ) asymptotically negligible. To illustrate how the second
part of this assumption restricts the rate at which Sn goes to infinity, consider an example where
Pr(pM L (Xi ; δn ) ∈ (0, 1)) = O(δn ), and pM L (Xi ; δn ) is approximately uniformly distributed on
n
log n
M L (X ; δ ) ∈ (0, γ log n ) ∪ (1 − γ log n , 1)) =
the tails (0, γ log
i n
Sn ) ∪ (1 − γ Sn , 1). In this case, Pr(p
Sn
Sn
log n
O(δn Sn ), and the second part of Assumption 5 requires that Sn grow sufficiently fast so that
β̂1s .

1/2

n1/2 δn log n
Sn

1/2

= o(1). One choice of Sn satisfying this is Sn = αnκ δn

for some α > 0 and κ > 12 ,

1/2
n1/2 δn
Sn

log n
n
in which case
= αnlog
κ−1/2 = o(1).
Under the above conditions, the 2SLS estimators β̂1 and β̂1s are consistent and asymptotically
normal estimators of a weighted average treatment effect.

Theorem 1 (Consistency and Asymptotic Normality). Suppose that Assumptions 1 and 3 hold,
and that δn → 0, nδn → ∞ and Sn → ∞ as n → ∞. Then the 2SLS estimators β̂1 and β̂1s
converge in probability to
β1 ≡ lim E[ωi (δ)(Yi (1) − Yi (0))],
δ→0

where
ωi (δ) =

pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))
.
E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))]

Suppose, in addition, that Assumptions 4 and 5 hold and that nδn2 → 0 as n → ∞. Then
d

σ̂n−1 (β̂1 − β1 ) −→ N (0, 1),
d

(σ̂ns )−1 (β̂1s − β1 ) −→ N (0, 1),
15

where we define σ̂n−1 and (σ̂ns )−1 as follows. Let
n
n
n
X
X
X
Σ̂n = (
Zi,n D0i,n Ii,n )−1 (
ˆ2i,n Zi,n Z0i,n Ii,n )(
Di,n Z0i,n Ii,n )−1 ,
i=1

i=1

i=1

where
ˆi,n = Yi − D0i,n β̂.
Σ̂n is the conventional heteroskedasticity-robust estimator for the variance of the 2SLS estimator.
σ̂n2 is the second diagonal element of Σ̂n . (σ̂ns )2 is the analogously-defined estimator for the
variance of β̂1s from the simulation-based regression.
Proof. See Appendix C.6.
Theorem 1 says that the 2SLS estimators converge to a weighted average of causal effects
for the subpopulation whose QPS is nondegenerate (pM L (Xi ; δ) ∈ (0, 1)) and who would switch
their treatment status in response to the treatment recommendation (Di (1) 6= Di (0)).21 The
limit limδ→0 E[ωi (δ)(Yi (1) − Yi (0))] always exists under the assumptions of Theorem 1. It also
shows that inference based on the conventional 2SLS heteroskedasticity-robust standard errors
is asymptotically valid if δn goes to zero at an appropriate rate. The convergence rate of β̂1 is
√
√
Op (1/ n) if Pr(M L(Xi ) ∈ (0, 1)) > 0 and is Op (1/ nδn ) if Pr(M L(Xi ) ∈ (0, 1)) = 0.
Our consistency result requires that δn goes to zero slower than n−1 . The rate condition
ensures that, when Pr(M L(Xi ) ∈ (0, 1)) = 0, we have sufficiently many observations in the
δn -neighborhood of the boundary of Ω∗ . Importantly, the rate condition does not depend on the
dimension of Xi , unlike other bandwidth-based estimation methods such as kernel methods. This
is because we use all the observations in the δ-neighborhood of the boundary, and the number
of those observations is of order nδn regardless of the dimension of Xi if the dimension of the
boundary is one less than the dimension of Xi , i.e., (p − 1).
The asymptotic normality result requires that δn goes to zero sufficiently quickly. When
Pr(M L(Xi ) ∈ (0, 1)) > 0, we need to use a small enough δn so that pM L (Xi ; δn ) converges
to pM L (Xi ) at a fast rate and δn -neighborhood of D∗ is asymptotically small enough. When
Pr(M L(Xi ) ∈ (0, 1)) = 0, the asymptotic normality is based on undersmoothing, which eliminates the asymptotic bias by using the observations sufficiently close to the boundary of Ω∗ .
Whether or not Pr(M L(Xi ) ∈ (0, 1)) = 0, when we use simulated QPS, the consistency
result requires that the number of simulation draws Sn goes to infinity as n increases while the
asymptotic normality result requires a sufficiently fast growth rate of Sn to make the bias caused
by using ps (Xi ; δn ) negligible.
Finally, note that the weight ωi (δ) given in Theorem 1 is negative if Di (1) < Di (0), so
E[ωi (δ)(Yi (1) − Yi (0))] may not be a causally interpretable convex combination of treatment
effects Yi (1) − Yi (0). This can happen because the treatment effect of those whose treatment
assignment switches from 1 to 0 in response to the treatment recommendation (defiers) negatively
contributes to E[ωi (δ)(Yi (1) − Yi (0))]. Additional assumptions prevent this problem. If the
21

In principle, it is possible to estimate other weighted averages and the unweighted average by reweighting
different observations appropriately.

16

treatment effect is constant, for example, the 2SLS estimators are consistent for the treatment
effect.
Corollary 3. Suppose that Assumptions 1 and 3 hold, that the treatment effect is constant, i.e.,
Yi (1) − Yi (0) = b for some constant b, and that δn → 0, nδn → ∞, and Sn → ∞ as n → ∞.
Then the 2SLS estimators β̂1 and β̂1s converge in probability to b.
Another approach is to impose monotonicity (Imbens and Angrist, 1994). If Pr(Di (1) ≥
Di (0)|Xi = x) = 1, we have
E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x] = E[Di (1) − Di (0)|Xi = x]LAT E(x),
where LAT E(x) = E[Yi (1) − Yi (0)|Di (1) 6= Di (0), Xi = x] is the local average treatment effect
(LATE) conditional on Xi = x. The 2SLS estimators are then consistent for a weighted average
of conditional LATEs with all weights nonnegative.
Corollary 4. Suppose that Assumptions 1 and 3 hold, that Pr(Di (1) ≥ Di (0)|Xi = x) = 1 for
any x ∈ X with pM L (x) ∈ (0, 1), and that δn → 0, nδn → ∞ and Sn → ∞ as n → ∞. Then the
2SLS estimators β̂1 and β̂1s converge in probability to
lim E[ω(Xi ; δ)LAT E(Xi )],

δ→0

where
ω(x; δ) =

pM L (x; δ)(1 − pM L (x; δ))E[Di (1) − Di (0)|Xi = x]
.
E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))]

The probability limit of the 2SLS estimators is a weighted average of conditional LATEs
over all values of Xi with nondegenerate QPS pM L (Xi ; δn ). The weights are proportional to
pM L (Xi ; δn )(1 − pM L (Xi ; δn )), and to the proportion of compliers, E[Di (1) − Di (0)|Xi ].

4.3

Special Cases

The result in Theorem 1 holds whether M L is stochastic (Pr(M L(Xi ) ∈ (0, 1)) > 0) or deterministic (Pr(M L(Xi ) ∈ (0, 1)) = 0). As shown in the proof of Theorem 1, if we consider these
two underlying cases separately, the probability limit of the 2SLS estimators has a more specific
expression. If Pr(M L(Xi ) ∈ (0, 1)) > 0,
plim β̂1 = plim β̂1s =

E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))(Yi (1) − Yi (0))]
.
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

(5)

The 2SLS estimators converge to a weighted average of treatment effects for the subpopulation
with nondegenerate M L(Xi ). To relate this result to existing work, consider the following 2SLS
regression with the (standard) propensity score M L(Xi ) control:
Di = γ0 + γ1 Zi + γ2 M L(Xi ) + νi

(6)

Yi = β0 + β1 Di + β2 M L(Xi ) + i .

(7)

17

Existing results show that under conditional independence, the 2SLS estimator from this
regression converges in probability to the treatment-variance weighted average of treatment effects in (5) (Angrist and Pischke, 2008; Hull, 2018).22 Not surprisingly, for this selection-onobservables case, our result shows that the 2SLS estimator is consistent for the same treatment
effect whether we use as a control the propensity score, QPS, or simulated QPS.
Importantly, using QPS as a control allows us to consistently estimate a causal effect even
if M L is deterministic and produces high-dimensional regression-discontinuity variation.23 If
Pr(M L(Xi ) ∈ (0, 1)) = 0,
R
p−1 (x)
∗ E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x]fX (x)dH
s
R
plim β̂1 = plim β̂1 = ∂Ω
. (9)
p−1 (x)
∂Ω∗ E[Di (1) − Di (0)|Xi = x]fX (x)dH
The 2SLS estimators converge to a weighted average of treatment effects for the subpopulation
who are on the boundary of the treated region.
Recall that the 2SLS regression uses the observations with pM L (Xi ; δn ) ∈ (0, 1) (or ps (Xi ; δn ) ∈
(0, 1) when we use simulated QPS) only. By definition, if pM L (Xi ; δ) ∈ (0, 1), Xi must be in
the δ-neighborhood of the boundary of Ω∗ . Therefore, to derive the probability limit of β̂1 , it
is necessary to derive the limits of the integrals of relevant variables over the δ-neighborhood
R
(e.g., N (∂Ω∗ ,δ) E[Yi |Xi = x]fX (x)dx) as δ shrinks to zero. We take an approach drawing on
change of variables techniques from differential geometry and geometric measure theory.24 In
this approach, we first use the coarea formula (Lemma B.3 in Appendix B.3) to write the integral
of an integrable function g over N (∂Ω∗ , δ) in terms of the iterated integral over the levels sets of
the signed distance function of Ω∗ :
Z
Z δZ
g(x)dx =
g(x)dHp−1 (x)dλ,
(10)
N (∂Ω∗ ,δ)

−δ

{x0 ∈Rp :dsΩ∗ (x0 )=λ}

22

Precisely speaking, Angrist and Pischke (2008) consider the OLS regression of Yi (or Di ) on Zi controlling a
dummy variable for every value taken on by Xi (i.e., the model is saturated in Xi ) when Xi is a discrete variable:
X
Yi = α1 Zi +
α2,x 1{Xi = x} + ui .
(8)
x∈X
i −E[Zi |Xi ])Yi ]
.
By the Frisch-Waugh Theorem, the population coefficient on Zi from (8) is given by α1 = E[(Z
E[(Zi −E[Zi |Xi ])2 ]
Angrist and Pischke (2008) show that this expression is reduced to the treatment-variance weighted average of
i )(1−M L(Xi ))(Y1i −Y0i )]
under the conditional independence assumption. Their derivation
treatment effects E[M L(X
E[M L(Xi )(1−M L(Xi ))
follows even when Xi is continuous and we control the propensity score linearly.
23
In the standard RDD with a single running variable Xi and cutoff c, pM L (Xi ; δn ) = X2δi −c
+ 21 if Xi ∈
n
ML
ML
[c − δn , c + δn ] and p (Xi ; δn ) ∈ {0, 1} otherwise. Since p (Xi ; δn ) is linear in the running variable Xi if
pM L (Xi ; δn ) ∈ (0, 1), the estimator β̂1 becomes a local regression estimator with the box kernel that places the
same slope coefficient of Xi on both sides of the cutoff. Under our assumptions, β̂1 and standard local linear
estimators are shown to have the same fastest possible convergence rate.
24
Our approach using geometric theory shows that β̂1 converges to an integral of the conditional treatment
effect over boundary points with respect to the Hausdorff measure. In constrast, prior studies on multidimensional
RDDs express treatment effect estimands in terms of expectations conditional on Xi being in the boundary like
E[Y1i − Y0i |Xi ∈ ∂Ω∗ ] (Zajonc, 2012). However, those conditional expectations are, formally, not well-defined,
since Lp (∂Ω∗ ) = 0 and hence Pr(Xi ∈ ∂Ω∗ ) = 0. We therefore prefer our expression in terms of an integral with
respect to the Hausdorff measure to any expressions in terms of conditional expectations on the boundary. Arias,
Rubio-Ramírez and Waggoner (2018), Bornn, Shephard and Solgi (2019), and Qiao (2021) use similar tools from
differential geometry and geometric measure theory, but for different purposes.

18

where dsΩ∗ is the signed distance function of Ω∗ (see Appendix B.2 for the definition). The set
{x0 ∈ Rp : dsΩ∗ (x0 ) = λ} is a level set of dsΩ∗ , which collects the points in Ω∗ when λ > 0 and
the points in Rp \ Ω∗ when λ < 0 whose distance to the boundary ∂Ω∗ is |λ|. Figure 2a shows a
visual illustration.
We then use the area formula (Lemma B.4 in Appendix B.3) to write the integral over each
level set in terms of the integral over the boundary ∂Ω∗ :
Z
Z
∂Ω∗
g(x)dHp−1 (x) =
g(x∗ + λνΩ∗ (x∗ ))Jp−1
ψΩ∗ (x∗ , λ)dHp−1 (x∗ ),
(11)
{x0 ∈Rp :dsΩ∗ (x0 )=λ}

∂Ω∗

where νΩ∗ (x∗ ) is the inward unit normal vector of ∂Ω∗ at x∗ (the unit vector orthogonal to all
∂Ω∗ ψ ∗ (x∗ , λ)
vectors in the tangent space of ∂Ω∗ at x∗ that points toward the inside of Ω∗ ), and Jp−1
Ω
is the Jacobian of the transformation ψΩ∗ (x∗ , λ) = x∗ +λνΩ∗ (x∗ ). Figure 2b illustrates this change
of variables formula. Finally, combining (10) and (11) and proceeding with further analysis, we
prove in Appendix C.6.3 that when g is continuous,
Z

Z
p−1
g(x)dx = δ
g(x)dH (x) + o(1) .
N (∂Ω∗ ,δ)

∂Ω∗

Thus, the integral over the δ-neighborhood of ∂Ω∗ scaled up by δ −1 converges to the integral
over boundary points with respect to the (p − 1)-dimensional Hausdorff measure. This result is
used to derive the expression of the probability limit of β̂1 given by (9).

5

Machine Learning Simulation

We conduct a Monte Carlo experiment to assess the feasibility and performance of our method.
Consider a tech company that conducts a randomized experiment (randomized controlled trial;
RCT) using a small segment of the population and, at the same time, applies a deterministic decision algorithm to the rest of the population. We generate a random sample {(Yi , Xi , Di , Zi )}ni=1
of size n = 10, 000 as follows. There are 100 covariates (p = 100), and Xi ∼ N (0, Σ). Yi (0) is
generated as Yi (0) = 0.75Xi0 α0 + 0.250i , where α0 ∈ R100 , and 0i ∼ N (0, 1). We consider two
models for Yi (1), one in which the the treatment effect Yi (1) − Yi (0) does not depend on Xi and
one in which the effect depends on Xi .
Model A. Yi (1) = Yi (0) + 1i , where 1i ∼ N (0, 1).
Model B. Yi (1) = Yi (0) + Xi0 α1 , where α1 ∈ R100 .
The choice of parameters Σ, α0 and α1 is explained in Appendix D. Di (0) and Di (1) are generated
as Di (0) = 0 and Di (1) = 1{Yi (1)−Yi (0) > ui }, where ui ∼ N (0, 1). To generate Zi , let q0.495 and
q0.505 be the 49.5th and 50.5th (empirical) quantiles of the first covariate X1i , and let τpred (Xi )
be a real-valued function of Xi , which we regard as a prediction of the effect of recommendation
on the outcome for individual i obtained from past data. We will explain how we construct τpred

19

in the next paragraph. Zi is then generated as

∗


Zi ∼ Bernoulli(0.5) if X1i ∈ [q0.495 , q0.505 ]
Zi = 1
if X1i ∈
/ [q0.495 , q0.505 ] and τpred (Xi ) ≥ 0


0
if X1i ∈
/ [q0.495 , q0.505 ] and τpred (Xi ) < 0.
The first case corresponds to the RCT segment while the latter two cases to the deterministic
algorithm segment. The function M L is given by



0.5 if x1 ∈ [q0.495 , q0.505 ]
M L(x) =

1


0

if x1 ∈
/ [q0.495 , q0.505 ] and τpred (x) ≥ 0

if x1 ∈
/ [q0.495 , q0.505 ] and τpred (x) < 0.

Finally, Di and Yi are generated as Di = Zi Di (1)+(1−Zi )Di (0) and Yi = Di Yi (1)+(1−Di )Yi (0),
respectively.
We simulate 1, 000 hypothetical samples from the above data-generating process. Before
obtaining 1, 000 samples, we construct τpred using an independent sample {(Ỹi , X̃i , D̃i , Z̃i )}ñi=1 of
size ñ = 2, 000. The distribution of (Ỹi , X̃i , D̃i , Z̃i ) is the same as that of (Yi , Xi , Di , Zi ) except
(1) that Ỹi (1) is generated as Ỹi (1) = Ỹi (0) + 0.5X̃i0 α1 + 0.51i , where 1i ∼ N (0, 1) and (2) that
Z̃i ∼ Bernoulli(0.5). This can be viewed as data from a past randomized experiment conducted
to construct an algorithm. We then use random forests separately for the subsamples with Z̃i = 1
and Z̃i = 0 to make a prediction of Ỹi from X̃i . Let µz (x) be the trained prediction model, and
set τpred (x) = µ1 (x) − µ0 (x).
This mimics a situation in which the decision maker first conducts an experiment that randomly assigns Zi to predict the conditional average effect of Zi and then constructs an algorithm
that greedily chooses the treatment predicted to perform better based on the predicted effect.
We generate the sample {(Ỹi , X̃i , D̃i , Z̃i )}ñi=1 and construct τpred only once, and we use it for all
of the 1, 000 samples. The distribution of the sample {(Yi , Xi , Di , Zi )}ni=1 is thus held fixed for
all simulations.

5.1

Estimators and Estimands

We use the data {(Yi , Xi , Di , Zi )}ni=1 to estimate treatment effect parameters. Our main approach
is 2SLS with QPS controls in Theorem 1. To compute QPS, we use S = 400 simulation draws
for each observation.
We compare our approach with two alternatives. The first alternative is 2SLS with M L
controls. This method uses the observations with M L(Xi ) ∈ (0, 1) to run the 2SLS regression of
Yi on a constant, Di , and M L(Xi ) using Zi as an instrument for Di (see (6) and (7) in Section
4.3) and reports the coefficient on Di . The second alternative is OLS of Yi on a constant and Di
(i.e., the difference in the sample mean of Yi between the treated group and untreated group)
using all observations.
We consider four parameters as target estimands: ATE ≡ E[Yi (1) − Yi (0)], ATE(RCT) ≡
E[Yi (1)−Yi (0)|X1i ∈ [q0.495 , q0.505 ]], LATE ≡ E[Yi (1)−Yi (0)|Di (1) 6= Di (0)], and LATE(RCT) ≡
E[Yi (1) − Yi (0)|Di (1) 6= Di (0), X1i ∈ [q0.495 , q0.505 ]]. In the case where the treatment effect does
20

not depend on Xi (Model A), the conditional effects are homogeneous, and ATE and LATE are
the same as ATE(RCT) and LATE(RCT), respectively. In the case where the treatment effect
depends on Xi (Model B), the conditional effects are heterogeneous. However, since the RCT
segment consists of those in the middle of the distribution of X1i , the average effect for the RCT
segment is close to the unconditional average effect. As a result, ATE is equal to ATE(RCT)
and LATE is similar to LATE(RCT) under this data-generating process.
For both models, the 2SLS estimator converges in probability to LATE(RCT) whether we
control for QPS or M L.25 However, 2SLS with M L controls uses only the individuals for the
RCT segment while 2SLS with QPS controls additionally uses the individuals near the decision
boundary of the deterministic algorithm (i.e., the boundary of the region for which τpred (x) ≥ 0).
Therefore, 2SLS with QPS controls is expected to produce a more precise estimate than 2SLS
with M L controls if the conditional effects for those near the boundary are not far from the
target estimand.

5.2

Results

Table 1 reports the bias, standard deviation (SD), and root mean squared error (RMSE) of each
estimator. Panels A and B present the results for the cases where the conditional effects are
homogeneous and heterogeneous, respectively. Note first that OLS with no controls is significantly biased, showing the importance of correcting for omitted variable bias. 2SLS with QPS
achieves this goal, as suggested by its smaller biases across all possible treatment effect models,
target parameters, and values of δ. 2SLS with QPS controls shows a consistent pattern; as the
bandwidth δ grows, the bias increases while the variance declines. For several values of δ, 2SLS
with QPS controls outperforms 2SLS with M L controls in terms of the RMSE. This finding implies that exploiting individuals near the high-dimensional decision boundary of the deterministic
algorithm can lead to better performance than using only the individuals in the RCT segment.
To evaluate our inference procedure based on Theorem 1, we also report the coverage probabilities of the 95% confidence intervals for LATE(RCT) constructed from the 2SLS estimates
and their heteroskedasticity-robust standard errors. The confidence intervals still offer nearly
correct coverage when δ is small, which supports the implication of Theorem 1 that the inference
procedure is valid when we use a sufficiently small δ.

6
6.1

Empirical Policy Application
Hospital Relief Funding during the COVID-19 Pandemic

We also provide a real-world empirical application. As part of the 3-phase Coronavirus Aid,
Relief, and Economic Security (CARES) Act, the government has distributed tens of billions of
dollars of relief funding to hospitals since April 2020. We focus on an initial portion of this funding
($10 billion), which was allocated to hospitals that qualified as “safety net hospitals” according
to a specific eligibility criterion. This eligibility criterion intends to focus on hospitals that
25
The 2SLS estimators converge in probability to the right-hand side of Eq.
LATE(RCT) under the data-generating process of this simulation.

21

(5), which is the same as

“disproportionately provide care to the most vulnerable, and operate on thin margins.” Specifically,
an acute care hospital was deemed eligible for funding if the following conditions hold:
• Medicare Disproportionate Patient Percentage (DPP) of 20.2% or greater. DPP is equal
to the sum of the percentage of Medicare inpatient days attributable to patients eligible
for both Medicare Part A and Supplemental Security Income (SSI), and the percentage of
total inpatient days attributable to patients eligible for Medicaid but not Medicare Part
A.26
• Annual Uncompensated Care (UCC) of at least $25, 000 per bed. UCC is a measure of
hospital care provided for which no payment was received from the patient or insurer. It
is the sum of a hospital’s bad debt and the financial assistance it provides.27
• Profit Margin (Net income/(Net patient revenue + Total other income)) of 3.0% or less.
Hospitals that do not qualify on any of the three dimensions are funding ineligible. Figure 3 visualizes how the three dimensions determine safety net eligibility. As the bottom two-dimensional
planes show, eligibility discontinuously changes as hospitals cross the eligibility boundary in the
space of the three characteristics. This setting is a three-dimensional RDD, falling under our
framework.
The final funding amount is calculated as follows. Each eligible hospital is assigned an
individual facility score, which is calculated as the product of DPP and the number of beds in
that hospital. This facility score determines the share of funding allocated to the hospital, out
of the total $10 billion. The share received by each hospital is determined by the ratio of the
hospital’s facility score to the sum of facility scores across all eligible hospitals. The amount of
funding that can be received is bounded below at $5 million and capped above at $50 million.
We use publicly available data from the Healthcare Cost Report Information System (HCRIS)28 ,
to replicate29 the funding eligibility status as well as the amount of funding received. To obtain outcome measures of interest, we use the publicly available COVID-19 Reported Patient
Impact and Hospital Capacity by Facility dataset. This provides facility-level data on hospital
utilization aggregated on a weekly basis, from July 31st 2020 onwards.30 Summary measures of
outcome variables and hospital characteristics are documented in Table 2. Safety net hospitals
have higher levels of inpatient beds and ICU beds occupied by patients who have lab-confirmed
or suspected COVID-19. They also have a higher number of employees and beds and shorter
lengths of inpatient stay.
26

Source: https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/AcuteInpatientPPS/dsh
Source: https://www.aha.org/fact-sheets/2020-01-06-fact-sheet-uncompensated-hospital-care-cost
28
We use the RAND cleaned version of this dataset which can be accessed at https://www.hospitaldatasets.
org/
29
We use the methodology detailed in the CARE ACT website to project funding based on 2018 financial year
cost reports.
30
Source:
https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/
anag-cw7u
27

22

6.2

Covariate Balance Estimates

Using the above data, we study the effect of safety net funding on relevant hospital outcomes,
such as the total number of inpatient beds and the number of staffed ICU beds occupied by adult
COVID patients reported between July 31st 2020 and August 6th 2020.
We first evaluate the balancing property of QPS conditioning using QPS-controlled differences
in covariate means for hospitals who are and are not deemed eligible for safety net funding.
Specifically, we run the following OLS regression of hospital-level characteristics on the eligibility
status using observations with ps (Xi ; δn ) ∈ (0, 1):
Wi = γ0 + γ1 Zi + γ2 ps (Xi ; δn ) + ηi ,
where Wi is one of the predetermined financial and utilization characteristics of the hospital,
Zi is a funding eligibility dummy, Xi is a vector of three input variables (DPP, UCC, and
profit margin) that determine the funding eligibility, and ps (Xi ; δn ) is the simulated QPS. The
estimated coefficient on Zi is the QPS-controlled difference in the mean of the covariate between
eligible and ineligible hospitals. For comparison, we also run the OLS regression of hospital
characteristics on the eligibility status with no controls using the whole sample.
Table 3 reports the covariate balance estimates. Column 1 shows that, without controlling
for QPS, eligible hospitals are significantly different from ineligible hospitals. We find that all
the relevant hospital eligibility characteristics are strongly associated with eligibility.
Once we control for QPS, eligible and ineligible hospitals have similar financial and utilization
characteristics, as reported in columns 2–6 of Table 3. These estimates are consistent with our
theoretical results, establishing the empirical relevance of QPS controls.

6.3

2SLS Estimates

Causal effects of safety net funding are estimated by 2SLS using funding eligibility as an instrument for the amount of funding received. We run the following 2SLS regression on four different
hospital-level outcome variables:
Di = γ0 + γ1 Zi + γ2 ps (Xi ; δn ) + vi
Yi = β0 + β1 Di + β2 ps (Xi ; δn ) + i ,
where Yi is a hospital-level outcome and Di is the amount of relief funding received.31 We also
run the OLS and 2SLS regressions with no controls, computed using the sample of all hospitals,
as benchmark estimators.
The first stage effects of safety net eligibility on funding amount (in millions), shown in
columns 2–9 of Table 4, suggest that safety net eligibility boosts funding significantly. For
example, in column 2 of Table 4, we can see that being eligible for the funding increases the
safety net funding by approximately 14 million dollars.
31

This specification uses a continuous treatment, unlike our theoretical framework with a binary treatment.
We obtain similar results when the treatment is a binary transformation of the amount of relief funding received
(e.g., a dummy indicating whether the amount exceeds a certain value). Results are available upon request.

23

OLS estimates of funding effects, reported as the benchmark in column 1 of Table 4, indicate
that safety net funding is associated with a higher number of adult inpatient beds and higher
number of staffed ICU beds utilized by patients who have lab-confirmed or suspected COVID.
The estimates indicate that a million dollar increase in funding is associated with 5.52 more adult
inpatient beds occupied by patients with lab-confirmed or suspected COVID. The corresponding
increase in total adult inpatient beds occupied by those who have lab-confirmed COVID is 4.50
and the increase in staffed ICU beds occupied by those who have lab-confirmed or suspected
COVID is 1.66. The estimated increase in staffed ICU beds occupied by lab-confirmed COVID
patients is 1.50. Naive 2SLS estimates with no controls produce similar results.
In contrast with the OLS or uncontrolled 2SLS estimates, the 2SLS estimates with QPS
controls in columns 3–9 show a different picture. The gains in number of inpatient beds and
staffed ICU beds occupied by suspected and lab-confirmed COVID patients become much smaller
and lose significance across all bandwidth specifications. These results suggest that QPS reveals
important selection bias in the estimated effects of safety net funding. Once we control for QPS
to eliminate the bias, the safety net relief funding has little to no effect on the hospital utilization
level by COVID-19 patients.

7

Other Examples

Here we give real-world examples and discuss the applicability of our framework.
Example 1 (Bandit and Reinforcement Learning). We are constantly exposed to digital information (movie, music, news, search results, advertisements, and recommendations) through a
variety of devices and platforms. Tech companies allocate these pieces of content by using bandit
and reinforcement learning algorithms. Our method is applicable to many popular bandit and
reinforcement learning algorithms. For simplicity, assume that individuals perfectly comply with
the treatment recommendation (Di = Zi ).
1. (Bandit Algorithms) The algorithms below first use past data and supervised learning to estimate the conditional means and variances of potential outcomes, E[Yi (z)|Xi ] and Var(Yi (z)|Xi ),
for each z ∈ {0, 1}. Let µz and σz2 denote the estimated functions. The algorithms use µz (Xi )
and σz2 (Xi ) to determine the treatment assignment for individual i.
(a) (Thompson Sampling Using Gaussian Priors) The algorithm first samples potential outcomes from the normal distribution with mean (µ0 (Xi ), µ1 (Xi )) and variance-covariance
matrix diag(σ02 (Xi ), σ12 (Xi )). The algorithm then chooses the treatment with the highest
sampled potential outcome:
ZiT S ≡ arg max y(z), M LT S (Xi ) = E[arg max y(z)|Xi ],
z∈{0,1}

z∈{0,1}

where y(z) ∼ N (µz (Xi ), σz2 (Xi )) independently across z. These algorithms often induce
quasi-experimental variation in treatment assignment, as a strand of the computer science

24

literature has observed (Precup, 2000; Li et al., 2010; Narita, Yasui and Yata, 2019; Saito,
Aihara, Matsutani and Narita, 2021). The function M L has an analytical expression:
!
µ
(x)
−
µ
(x)
0
1
,
M LT S (x) = 1 − Φ p 2
σ0 (x) + σ12 (x)
where Φ is the cumulative distribution function of a standard normal distribution. Suppose
that the functions µ0 , µ1 , σ02 and σ12 are continuous. QPS for this case is given by
!
µ
(x)
−
µ
(x)
0
1
.
pT S (x) = 1 − Φ p 2
σ0 (x) + σ12 (x)
This QPS is nondegenerate, meaning that the data from the algorithm allow for causal-effect
identification.
(b) (Upper Confidence Bound, UCB) Unlike the above stochastic one, the UCB algorithm
(Li et al., 2010) is a deterministic algorithm, producing a less obvious example of our
framework. This algorithm chooses the treatment with the highest upper confidence bound
for the potential outcome:
ZiU CB ≡ arg max{µz (Xi ) + ασz (Xi )}, M LU CB (x) = arg max{µz (x) + ασz (x)},
z=0,1

z=0,1

where α is chosen so that |µz (x)−E[Yi (z)|Xi = x]| ≤ ασz (x) at least with some probability,
for example, 0.95, for every x. Suppose that the function g = µ1 − µ0 + α(σ1 − σ0 ) is
continuous on X and is continuously differentiable in a neighborhood of x with ∇g(x) 6= 0
for any x ∈ X such that g(x) = 0. QPS for this case is given by


if µ1 (x) + ασ1 (x) < µ0 (x) + ασ0 (x)

0
pU CB (x) = 0.5
if µ1 (x) + ασ1 (x) = µ0 (x) + ασ0 (x)


1
if µ (x) + ασ (x) > µ (x) + ασ (x).
1

1

0

0

This means that the UCB algorithm produces potentially complicated quasi-experimental
variation along the boundary in the covariate space where the algorithm’s treatment recommendation changes from one to the other. It is possible to identify and estimate causal
effects across the boundary.
2. (Reinforcement Learning Algorithms) Extending bandit algorithms to dynamically changing
environments, reinforcement learning algorithms optimize decisions in dynamic environments,
where the state (the set of observables that the agent receives from the environment) and action
in the current period can affect the future states and outcomes. Let {(Xti , Zti , Yti )}∞
t=0 denote
the trajectory of the states, treatment assignments, and outcomes in periods t = 0, 1, 2, · · · for
individual i. For simplicity, we assume that the trajectory follows a Markov decision process.32
32

Under a Markov decision process, the distribution of the state Xti only depends on the last state and treatment
assignment (Xt−1,i , Zt−1,i ), the distribution of the outcome Yti only depends on the current state and treatment
assignment (Xti , Zti ), and these distributions are stationary over periods.

25

Let Yti (1) and Yti (0) represent the potential outcomes in period t. Let Q : X × {0, 1} → R be
the optimal state-action value function, called the Q-function: for (x, z) ∈ X × {0, 1},
"∞
#
X
Q(x, z) ≡ max E
γ t (Yti (1)π(Xti ) + Yti (0)(1 − π(Xti ))|X0i = x, Z0i = z ,
π:X →[0,1]

t=0

where γ ∈ [0, 1) is a discount factor, and π is a policy function that assigns the probability of
treatment to each possible state.
(a) (-Greedy) This algorithm first uses past data to yield Q̂, an estimate of the Q-function.
For example, the fitted Q iteration (Ernst, Geurts and Wehenkel, 2005) is used to estimate
Q.33 The algorithm then chooses the best treatment based on Q̂(Xti , z) with probability
1 − 2 and chooses the other treatment with probability 2 : for each t,
Zti ≡
M L (x) =

(
arg maxz=0,1 Q̂(Xti , z)

with probability 1 −


2

1 − arg maxz=0,1 Q̂(Xti , z)
with probability 2 ,
(

if Q̂(x, 1) < Q̂(x, 0)
2
1−


2

if Q̂(x, 1) > Q̂(x, 0).

Suppose that the function g(·) = Q̂(·, 1) − Q̂(·, 0) is continuous on X and is continuously
differentiable in a neighborhood of x with ∇g(x) 6= 0 for any x ∈ X such that g(x) = 0.
QPS for this case is given by



if Q̂(x, 1) < Q̂(x, 0)
2


p (x) = 0.5
if Q̂(x, 1) = Q̂(x, 0)


1 − 
if Q̂(x, 1) > Q̂(x, 0).
2

(b) (Policy Gradient Methods) Policy gradient methods such as REINFORCE (Williams, 1992)
and Actor-Critic approximate the optimal policy function by parametrization and learn
the parameter using stochastic gradient ascent. Let π(x; θ) be a parametrization of the
policy function that is differentiable with respect to θ.34 Suppose that we have collected
l
a set of L trajectories {(xlt , ztl , ytl )Tt=0
: l = 1, ..., L} by running the policy π(x; θ0 ) for L
individuals. Policy gradient methods use the trajectories to update the policy parameter
33

Suppose that we have collected a set of L four-tuples {(xltl , ztll , ytll , xltl +1 )}L
l=1 as a result of the agent interacting
with the dynamic environment. Given the dataset and an initial approximation Q̂ of Q (e.g., Q̂(x, z) = 0 for all
(x, z)), we repeat the following steps until some stopping condition is reached: 1. For each l = 1, ..., L, calculate
q l = ytll + γ maxz∈{0,1} Q̂(xltl +1 , z); 2. Use {(xltl , ztll , q l )}L
l=1 and a supervised learning method to train a model
that predicts q from (x, z). Let the model be a new approximation Q̂ of Q. Possible supervised learning methods
used in the second step include tree-based methods, neural networks (Neural Fitted Q Iteration) and deep neural
networks (Deep Fitted Q Iteration).
exp(x0 θ)
34
For example, π might be a softmax function with a linear index: π(x; θ) = 1+exp(x
0 θ) . Another example
is a neural network whose input is a representation of the state x, whose output is the treatment assignment
probability, and whose weights are represented by the parameter θ.

26

to θ1 by stochastic gradient ascent. The algorithms then use the updated policy function
π(x; θ1 ) to determine the treatment assignment for new episodes. For each t,
ZtiP G

≡

(
1

with probability π(Xti ; θ1 )

0

with probability 1 − π(Xti

; θ1 ),

M LT G (x) = π(x; θ1 ).

Suppose that the function π(·; θ1 ) is continuous. QPS for this case is given by
pT G (x) = π(x; θ1 ).
Example 2 (Unsupervised Learning). Customer segmentation is a core marketing practice that
divides a company’s customers into groups based on their characteristics and behavior so that
the company can effectively target marketing activities at each group. Many businesses today
use unsupervised learning algorithms, clustering algorithms in particular, to perform customer
segmentation. Using our notation, assume that a company decides whether it targets a campaign
at customer i (Zi = 1) or not (Zi = 0). The company first uses a clustering algorithm such as
K-means clustering or Gaussian mixture model clustering to divide customers into K groups,
making a partition {S1 , ..., SK } of the covariate space Rp . The company then conducts the
campaign targeted at some of the groups:
ZiCL ≡ 1{Xi ∈ ∪k∈T Sk }, M LCL (x) = 1{x ∈ ∪k∈T Sk },
where T ⊂ {1, .., K} is the set of the indices of the target groups.
For example, suppose that the company uses K-means clustering, which creates a partition
in which a covariate value x belongs to the group with the nearest centroid. Let c1 , ..., cK be the
centroids of the K groups, and define a set-valued function C : Rp → 2{1,...,K} , where 2{1,...,K}
is the power set of {1, ..., K}, as C(x) ≡ arg mink∈{1,...,K} kx − ck k. If C(x) is a singleton, x
belongs to the unique group in C(x). If C(x) contains more than one indices, the group to which
x belongs is arbitrarily determined. QPS for this case is given by


if C(x) ∩ T = ∅

0
CL
p (x) = 0.5
if |C(x)| = 2, x ∈ ∂(∪k∈T Sk )


1
if C(x) ⊂ T
and pCL (x) ∈ (0, 1) if |C(x)| ≥ 3 and x ∈ ∂(∪k∈T Sk ), where |C(x)| is the number of elements in
C(x).35 Thus, it is possible to identify causal effects across the boundary ∂(∪k∈T Sk ).
Example 3 (Supervised Learning). Millions of times each year, judges make jail-or-release
decisions that hinge on a prediction of what a defendant would do if released. Many judges
now use proprietary algorithms (like COMPAS criminal risk score) to make such predictions
and use the predictions to support jail-or-release decisions. Using our notation, assume that a
35

If |C(x)| = 2 and x ∈ ∂(∪k∈T Sk ), x is on a linear boundary between one target group and one non-target
group, and hence QPS is 0.5. If |C(x)| ≥ 3 and x ∈ ∂(∪k∈T Sk ), x is a common endpoint of several group
boundaries, and QPS is determined by the angles at which the boundaries intersect.

27

criminal risk algorithm recommends jailing (Zi = 1) or releasing (Zi = 0) for each defendant i.
The algorithm uses defendant i’s observable characteristics Xi , including criminal history and
demographics. The algorithm first translates Xi into a risk score r(Xi ), where r : Rp → R is
a function estimated by supervised leaning based on past data and assumed to be fixed. For
example, Kleinberg et al. (2017) construct a version of r(Xi ) using gradient boosted decision
trees. The algorithm then uses the risk score to make the final recommendation:
ZiSL ≡ 1{r(Xi ) > c}, M LSL (x) = 1{r(x) > c},
where c ∈ R is a constant threshold that is set ex ante.36 A similar procedure applies to
the screening of potential borrowers by banks and insurance companies based on credit scores
estimated by supervised learning (Agarwal, Chomsisengphet, Mahoney and Stroebel, 2017).
A widely-used approach to identifying and estimating treatment effects in these settings is
to use the score r(Xi ) as a continuous univariate running variable and apply a univariate RDD
method (Cowgill, 2018). However, whether r(Xi ) is continuously distributed or not depends on
how the function r is constructed. For example, suppose that r is constructed by a tree-based
algorithm and is the following simple regression tree with three terminal nodes:


if x1 ≤ 0

r1
r(x) =

r2


r
3

if x1 > 0, x2 ≤ 0

if x1 > 0, x2 > 0,

where r1 < r2 < c < r3 .37 In this case, the score r(Xi ) is a discrete variable, and hence it may
not be suitable to apply a standard univariate RDD method.
Our approach is applicable to this case as long as at least one of the original multi-dimensional
covariates Xi are continuously distributed. QPS for this case is given by


0
if x1 < 0 or x2 < 0




0.25
if x1 = x2 = 0
pSL (x) =

if (x1 = 0, x2 > 0) or (x1 > 0, x2 = 0)

0.5


1
if x1 > 0, x2 > 0.
It is therefore possible to identify causal effects across the boundary {x ∈ X : (x1 = 0, x2 ≥
0) or (x1 > 0, x2 = 0)}.
Example 4 (Policy Eligibility Rules). Medicaid and other welfare policies often decide who
are eligible based on algorithmic rules, as studied by Currie and Gruber (1996) and Brown,
Kowalski and Lurie (2020).38 Using our notation, the state government determines whether each
36

The algorithm sometimes discretizes the original risk score r(Xi ) into d(r(Xi )), where d : R → N (Cowgill,
2018). In this case, the algorithm uses the discretized risk score to make the final recommendation: ZiSL ≡
1{d(r(Xi )) > c}.
37
If the regression tree is larger, or ensemble methods such as random forests and gradient boosted decision
trees are used to construct r, r is of similar form but has a more complicated expression.
38
These papers estimate the effect of Medicaid eligibility by exploiting variation in the eligibility rule across
states and over time (simulated instrumental variable method). In contrast, our method exploits local variation
in the eligibility status across different individuals given a fixed eligibility rule.

28

individual i is eligible (Zi = 1) or not (Zi = 0) for Medicare. The state government’s eligibility
rule M LM edicaid maps individual characteristics Xi (e.g. income, family composition) into an
eligibility decision ZiM edicare . A similar procedure also applies to bankruptcy laws (Mahoney,
2015). These policy eligibility rules produce quasi-experimental variation as in Example 3.
Example 5 (Mechanism Design: Matching and Auction). Centralized economic mechanisms
such as matching and auction are also suitable examples, as summarized below:
i
Xi
Zi
Di
Yi

Matching (e.g., School Choice)

Auction

Student
Preference/Priority/Tie-breaker
Whether student i is
assigned treatment school
Whether student i
attends treatment school
Student i’s
future test score

Bidder
Bid
Whether bidder i
wins the good
same as Zi
Bidder i’s future
economic performance

In mechanism design and other algorithms with capacity constraints, the treatment recommendation for individual i may depend not only on Xi but also on the characteristics of others.
These interactive situations can be accommodated by our framework if we consider the following
large market setting.39 Suppose that there is a continuum of individuals i ∈ [0, 1] and that the
recommendation probability for individual i with covariate Xi is determined by a function M as
follows:
Pr(Zi = 1|Xi ; FX−i ) = M (Xi ; FX−i ).
Here FX−i = Pr({j ∈ [0, 1] \ {i} : Xj ≤ x}) is the distribution of X among all individuals
j ∈ [0, 1] \ {i}. The function M : Rp × F → [0, 1], where F is a set of distributions on Rp ,
gives the recommendation probability for each individual in the market. With a continuum of
individuals, for any i ∈ [0, 1], FX−i is the same as the distribution of X in the whole market,
denoted by FX . Therefore, the data generated by the mechanism M are equivalent to the data
generated by the algorithm M L : Rp → [0, 1] such that M L(x) ≡ M (x; FX ) for all x ∈ Rp . Our
framework is applicable to this large-market interactive setting.
The above discussions can be summarized as follows.
Corollary 5. In all the above examples, there exists x ∈ int(X ) such that pM L (x) ∈ (0, 1).
Therefore, a causal effect is identified under Assumptions 1 and 2.

8

Conclusion

As algorithmic decisions become the new norm, the world becomes a mountain of natural experiments and instruments. These instruments enable us to estimate causal treatment effects,
39

The approach proposed by Borusyak and Hull (2020) is applicable to finite-sample settings if the treatment
recommendation probability, which may depend on all individuals’ characteristics, is nondegenerate for multiple
individuals.

29

as we formalize and illustrate in this paper. Our analysis clarifies a few implications for policy
and management practices around algorithmic decision-making. It is important to record the
implementation of algorithms in a replicable, simulatable way, including what input variables Xi
are used to make algorithmic recommendation Zi . Another key point is to record an algorithm’s
recommendation Zi even if they are superseded by a human decision Di . These data retention
efforts would go a long way to exploit the full potential of algorithms as natural experiments.
In addition to estimating treatment effects, instruments induced by algorithms can also help
inform the improvement of algorithms. To see this, suppose some algorithm M L1 is in use.
As we characterize in this paper, this algorithm M L1 produces instrument IV1 . We can then
use instrument IV1 to make counterfactual predictions about what would happen if we change
M L1 to another algorithm M L2 . We’d then switch to M L2 if it is predicted to be better than
the previous algorithm. This algorithm change in turn would produce another cycle of natural
experiments and improvements:
M L1 → IV1 → Algorithm Improvement1 → M L2 → IV2 → Algorithm Improvement2 ...
This cycle of natural experiments and improvements may provide an alternative to wellestablished A/B testing (randomized experiment). A/B testing is often technically, politically,
or managerially infeasible, since deploying a new algorithm is time- and money-consuming, and
entails a risk of failure and ethical concerns (Narita, 2021). This difficulty with randomized
experiment may be alleviated by additionally making use of algorithms as natural experiments.
Our agenda for future research includes a formalization of such optimal policy (algorithm)
learning. Another important topic is data-driven bandwidth selection. This work needs to extend
Imbens and Kalyanaraman (2012) and Calonico et al. (2014)’s bandwidth selection methods in
the univariate RDD to our setting. Inference on treatment effects in our framework relies on
conventional large sample reasoning. It seems natural to additionally consider permutation or
randomization inference. It will also be challenging but interesting to develop finite-sample
optimal estimation and inference strategies such as those recently introduced by Armstrong and
Kolesár (2018, 2020) and Imbens and Wager (2019). Finite-sample bias is also a related important
topic for further work (Narita, 2020). Finally, we look forward to empirical applications of our
method in a variety of business, policy, and scientific domains.

30

References
Abdulkadiroğlu, A., Angrist, J. D., Narita, Y. and Pathak, P. A. (2017). Research
Design Meets Market Design: Using Centralized Assignment for Impact Evaluation. Econometrica, 85 (5), 1373–1432.
—, —, — and Pathak, P. A. (Forthcoming). Breaking Ties: Regression Discontinuity Design
Meets Market Design. Econometrica.
Agarwal, S., Chomsisengphet, S., Mahoney, N. and Stroebel, J. (2017). Do Banks
Pass Through Credit Expansions to Consumers Who Want to Borrow? Quarterly Journal of
Economics, 133 (1), 129–190.
Angrist, J. D. and Pischke, J.-S. (2008). Mostly Harmless Econometrics: An Empiricist’s
Companion. Princeton University Press.
Arias, J. E., Rubio-Ramírez, J. F. and Waggoner, D. F. (2018). Inference Based on
Structural Vector Autoregressions Identified with Sign and Zero Restrictions: Theory and
Applications. Econometrica, 86 (2), 685–720.
Armstrong, T. B. and Kolesár, M. (2018). Optimal Inference in a Class of Regression
Models. Econometrica, 86 (2), 655–683.
— and Kolesár, M. (2020). Finite-Sample Optimal Estimation and Inference on Average Treatment Effects Under Unconfoundedness. Econometrica.
Athey, S. and Imbens, G. W. (2017). The State of Applied Econometrics: Causality and
Policy Evaluation. Journal of Economic Perspectives, 31 (2), 3–32.
Belloni, A., Chernozhukov, V., Fernández-Val, I. and Hansen, C. (2017). Program
Evaluation and Causal Inference with High-Dimensional Data. Econometrica, 85 (1), 233–
298.
Bonhomme, S., Lamadon, T. and Manresa, E. (2019). Discretizing Unobserved Heterogeneity. University of Chicago, Becker Friedman Institute for Economics Working Paper No.
2019-16, unpublished Manuscript, University of Chicago.
Bornn, L., Shephard, N. and Solgi, R. (2019). Moment conditions and bayesian nonparametrics. Journal of the Royal Statistical Society: Series B (Statistical Methodology), 81 (1),
5–43.
Borusyak, K. and Hull, P. (2020). Non-Random Exposure to Exogenous Shocks: Theory
and Applications. NBER Working Paper No. 27845, unpublished Manuscript, University of
Chicago.
Brown, D., Kowalski, A. E. and Lurie, I. Z. (2020). Long-Term Impacts of Childhood
Medicaid Expansions on Outcomes in Adulthood. The Review of Economic Studies, 87 (2),
729–821.
31

Bundorf, K., Polyakova, M. and Tai-Seale, M. (2019). How Do Humans Interact with
Algorithms? Experimental Evidence from Health Insurance. NBER Working Paper No. 25976.
Calonico, S., Cattaneo, M. D. and Titiunik, R. (2014). Robust Nonparametric Confidence
Intervals for Regression-Discontinuity Designs. Econometrica, 82 (6), 2295–2326.
Cattaneo, M. D., Frandsen, B. R. and Titiunik, R. (2015). Randomization Inference in
the Regression Discontinuity Design: An Application to Party Advantages in the US Senate.
Journal of Causal Inference, 3 (1), 1–24.
—, Titiunik, R. and Vazquez-Bare, G. (2017). Comparing Inference Approaches for RD
Designs: A Reexamination of the Effect of Head Start on Child Mortality. Journal of Policy
Analysis and Management, 36 (3), 643–681.
—, —, — and Keele, L. (2016). Interpreting Regression Discontinuity Designs with Multiple
Cutoffs. Journal of Politics, 78 (4), 1229–1248.
Cohen, P., Hahn, R., Hall, J., Levitt, S. and Metcalfe, R. (2016). Using Big Data to
Estimate Consumer Surplus: The Case of Uber. NBER Working Paper No. 22627, unpublished
Manuscript, University of Chicago.
Cowgill, B. (2018). The Impact of Algorithms on Judicial Discretion: Evidence from Regression
Discontinuities. Unpublished Manuscript, Columbia Business School.
Crasta, G. and Malusa, A. (2007). The Distance Function from the Boundary in a Minkowski
Space. Transactions of the American Mathematical Society, 359, 5725–5759.
Currie, J. and Gruber, J. (1996). Health Insurance Eligibility, Utilization of Medical Care,
and Child Health. Quarterly Journal of Economics, 111 (2), 431–466.
Dong, Y. (2018). Alternative Assumptions to Identify LATE in Fuzzy Regression Discontinuity
Designs. Oxford Bulletin of Economics and Statistics, 80 (5), 1020–1027.
Dranove, D., Garthwaite, C. and Ody, C. (2017). How do nonprofits respond to negative
wealth shocks? the impact of the 2008 stock market collapse on hospitals. RAND Journal of
Economics, 48 (2), 485–525.
Duggan, M. G. (2000). Hospital Ownership and Public Medical Spending. Quarterly Journal
of Economics, 115 (4), 1343–1373.
Einav, L., Finkelstein, A., Mullainathan, S. and Obermeyer, Z. (2018). Predictive
Modeling of U.S. Health Care Spending in Late Life. Science, 360 (6396), 1462–1465.
Ernst, D., Geurts, P. and Wehenkel, L. (2005). Tree-Based Batch Mode Reinforcement
Learning. Journal of Machine Learning Research, 6, 503–556.
Frandsen, B. R. (2017). Party Bias in Union Representation Elections: Testing for Manipulation in the Regression Discontinuity Design When the Running Variable is Discrete. In
32

Regression Discontinuity Designs: Theory and Applications, Emerald Publishing Limited, pp.
281–315.
Frölich, M. (2007). Regression Discontinuity Design with Covariates. IZA Discussion Paper
No. 3024, unpublished Manuscript, University of St. Gallen.
Frölich, M. and Huber, M. (2019). Including Covariates in the Regression Discontinuity
Design. Journal of Business and Economic Statistics, 37 (4), 736–748.
Gulshan, V. et al. (2016). Development and Validation of a Deep Learning Algorithm for
Detection of Diabetic Retinopathy in Retinal Fundus Photographs. Journal of the American
Medical Association, 316 (22), 2402–2410.
Hahn, J., Todd, P. and van der Klaauw, W. (2001). Identification and Estimation of
Treatment Effects with a Regression-Discontinuity Design. Econometrica, 69 (1), 201–209.
Hoffman, M., Kahn, L. B. and Li, D. (2017). Discretion in Hiring. Quarterly Journal of
Economics, 133 (2), 765–800.
Horton, J. J. (2017). The Effects of Algorithmic Labor Market Recommendations: Evidence
from a Field Experiment. Journal of Labor Economics, 35 (2), 345–385.
Hull, P. (2018). Subtracting the Propensity Score in Linear Models. Unpublished Manuscript,
MIT.
Imbens, G. and Kalyanaraman, K. (2012). Optimal Bandwidth Choice for the Regression
Discontinuity Estimator. The Review of Economic Studies, 79 (3), 933–959.
— and Wager, S. (2019). Optimized regression discontinuity designs. Review of Economics and
Statistics, 101 (2), 264–278.
Imbens, G. W. and Angrist, J. D. (1994). Identification and Estimation of Local Average
Treatment Effects. Econometrica, 62 (2), 467–475.
Kakani, P., Chandra, A., Mullainathan, S. and Obermeyer, Z. (2020). Allocation of
COVID-19 Relief Funding to Disproportionately Black Counties. Journal of the American
Medical Association (JAMA), 324 (10), 1000–1003.
Keele, L. J. and Titiunik, R. (2015). Geographic Boundaries as Regression Discontinuities.
Political Analysis, 23 (1), 127–155.
Khullar, D., Bond, A. M. and Schpero, W. L. (2020). COVID-19 and the Financial Health
of US Hospitals. Journal of the American Medical Association (JAMA), 323 (21), 2127–2128.
Kleinberg, J., Lakkaraju, H., Leskovec, J., Ludwig, J. and Mullainathan, S. (2017).
Human Decisions and Machine Predictions. Quarterly Journal of Economics, 133 (1), 237–293.
Krantz, S. G. and Parks, H. R. (2008). Geometric Integration Theory. Birkhäuser Basel.
33

Li, L., Chu, W., Langford, J. and Schapire, R. E. (2010). A Contextual-Bandit Approach
to Personalized News Article Recommendation. Proceedings of the 19th international conference on World Wide Web (WWW), pp. 661–670.
Li, S. (2011). Concise Formulas for the Area and Volume of a Hyperspherical Cap. Asian Journal
of Mathematics and Statistics, 4, 66–70.
Mahoney, N. (2015). Bankruptcy as Implicit Health Insurance. American Economic Review,
105 (2), 710–46.
Mullainathan, S. and Spiess, J. (2017). Machine learning: An applied econometric approach.
Journal of Economic Perspectives, 31 (2), 87–106.
Narita, Y. (2020). A Theory of Quasi-Experimental Evaluation of School Quality. Management
Science.
— (2021). Incorporating ethics and welfare into randomized experiments. Proceedings of the
National Academy of Sciences, 118 (1).
—, Yasui, S. and Yata, K. (2019). Efficient Counterfactual Learning from Bandit Feedback.
Proceedings of the 33rd AAAI Conference on Artificial Intelligence, pp. 4634–4641.
Papay, J. P., Willett, J. B. and Murnane, R. J. (2011). Extending the RegressionDiscontinuity Approach to Multiple Assignment Variables. Journal of Econometrics, 161 (2),
203–207.
Precup, D. (2000). Eligibility Traces for Off-Policy Policy Evaluation. Proceedings of the Seventeenth International Conference on Machine Learning, pp. 759–766.
Qiao, W. (2021). Nonparametric Estimation of Surface Integrals on Level Sets. Bernoulli, 27 (1),
155–191.
Rosenbaum, P. R. and Rubin, D. B. (1983). The Central Role of the Propensity Score in
Observational Studies for Causal Effects. Biometrika, 70 (1), 41–55.
Saito, Y., Aihara, S., Matsutani, M. and Narita, Y. (2021). Open bandit dataset and
pipeline: Towards realistic and reproducible off-policy evaluation. Unpublished Manuscript,
Tokyo Institute of Technology.
Sekhon, J. S. and Titiunik, R. (2017). On Interpreting the Regression Discontinuity Design as
a Local Experiment. In Regression Discontinuity Designs: Theory and Applications, Emerald
Publishing Limited, pp. 1–28.
Stein, E. M. and Shakarchi, R. (2005). Real Analysis: Measure Theory, Integration, and
Hilbert Spaces. Princeton Lectures in Analysis, Princeton, NJ: Princeton Univ. Press.
Voelker, A. R., Gosmann, J. and Stewart, T. C. (2017). Efficiently Sampling Vectors and
Coordinates from the n-Sphere and n-Ball. Centre for Theoretical Neuroscience - Technical
Report.
34

Williams, R. J. (1992). Simple Statistical Gradient-Following Algorithms for Connectionist
Reinforcement Learning. Machine Learning, 8, 229–256.
Wong, V. C., Steiner, P. M. and Cook, T. D. (2013). Analyzing Regression-Discontinuity
Designs with Multiple Assignment Variables: A Comparative Study of Four Estimation Methods. Journal of Educational and Behavioral Statistics, 38 (2), 107–141.
Zajonc, T. (2012). Regression Discontinuity Design with Multiple Forcing Variables. Essays on
Causal Inference for Public Policy, pp. 45–81.

35

Figure 1: Example of the Quasi Propensity Score

Figure 2: Illustration of the Change of Variables Techniques
(a)

(b)

36

Table 1: Bias, SD, and RMSE of Estimators and Coverage of 95% Confidence Intervals
δ = 0.01

Our Method: 2SLS with Quasi Propensity Score Controls
δ = 0.05
δ = 0.1
δ = 0.25
δ = 0.5

δ=1

2SLS
with M L
Controls

OLS
with No
Controls

Panel A: Homogeneous Conditional Effects
Estimand: ATE = ATE(RCT) = 0
Bias
.603
.634
SD
.304
.205
RMSE
.675
.667

.644
.157
.663

.659
.110
.668

.684
.078
.689

.740
.061
.842

.572
.372
.683

.754
.024
.754

Estimand: LATE = LATE(RCT) = 0.564
Bias
.039
.070
.080
SD
.304
.205
.157
RMSE
.306
.217
.176

.095
.110
.145

.120
.078
.143

.176
.061
.186

.008
.372
.372

.190
.024
.191

Coverage
Avg N

94.8%

92.8%

92.9%

84.6%

69.6%

18.6%

—

—

235

727

1275

2567

3995

5561

100

10000

Panel B: Heterogeneous Conditional Effects
Estimand: ATE = ATE(RCT) = 0
Bias
.568
.587
SD
.331
.222
RMSE
.657
.628

.589
.170
.613

.604
.118
.615

.636
.083
.642

.709
.063
.712

.545
.399
.676

1.192
.025
1.193

Estimand: LATE = 0.564
Bias
.004
SD
.331
RMSE
.331

.023
.222
.223

.025
.170
.172

.040
.118
.125

.072
.083
.110

.145
.063
.158

−.019
.399
.399

.628
.025
.629

Estimand: LATE(RCT) = 0.559
Bias
.009
.028
SD
.331
.222
RMSE
.331
.224

.030
.170
.173

.045
.118
.127

.077
.083
.114

.150
.063
.163

−.014
.399
.399

.633
.025
.634

Coverage
Avg N

95.9%

94.8%

95.0%

93.2%

87.1%

37.4%

—

—

235

723

1274

2567

3993

5561

100

10000

Notes: This table shows the bias, the standard deviation (SD) and the root mean squared error (RMSE) of 2SLS with
Quasi Propensity Score controls, 2SLS with M L controls, and OLS with no controls. These statistics are computed with
the estimand set to ATE, ATE(RCT), LATE, or LATE(RCT). The row “Coverage” in each panel shows the probabilities
s , β̂ s + 1.96σ̂ s ] contains LATE(RCT), where β̂ s is the 2SLS
that the 95% confidence intervals of the form [β̂1s − 1.96σ̂n
n
1
1
s is its heteroskedasticity-robust standard error. We use 1, 000
estimate with Quasi Propensity Score controls and σ̂n
replications of a size 10, 000 simulated sample to compute these statistics. We use several possible values of δ to compute
the Quasi Propensity Score. All Quasi Propensity Scores are computed by averaging 400 simulation draws of the M L
value. Panel A reports the results under the model in which the treatment effect does not depend on Xi . Panel B reports
the results under the model in which the treatment effect depends on Xi . The bottom row “Avg N ” in each panel shows
the average number of observations used for estimation (i.e., the average number of observations for which the Quasi
Propensity Score or the M L value is strictly between 0 and 1).

37

Figure 3: Three-dimensional Regression Discontinuity in Hospital Funding Eligibility.

Notes: We remove hospitals above the 99th percentile of disproportionate patient percentage
and uncompensated care per bed, for visibility purposes. The top figure visualizes the three
dimensions that determine safety net eligibility. The bottom figures show the data points plotted
along 2 out of 3 dimensions. The bottom left panel plots disproportionate patient percentage
against profit margin, while the bottom right panel plots uncompensated care per bed against
profit margin.
38

Table 2: Outcome Variables and Hospital Characteristics
All

Ineligible
Hospitals

Eligible
Hospitals

Patients in adult inpatient beds with lab-confirmed or suspected COVID
Patients in adult inpatient beds with lab-confirmed COVID (including those
with both lab-confirmed COVID and influenza)
Patients in adult ICU beds with lab-confirmed or suspected COVID
Patients in adult ICU beds who have lab-confirmed COVID
(including those with both lab-confirmed COVID and influenza)
Observations

105.37

98.32

135.60

80.12
31.40

73.90
28.93

107.65
42.17

26.67
4,008

24.43
3,291

36.71
717

Panel B: Hospital Characteristics
Beds
Interns and residents (full-time equivalents) per bed
Adult and pediatric hospital beds
Ownership: Proprietary (for-profit)
Ownership: Governmental
Ownership: Voluntary (non-profit)
Inpatient length of stay
Employees on payroll (full-time equivalents)
Observations

143.66
.06
120.26
.19
.22
.58
9.21
973.90
4,633

134.60
.05
113.29
.20
.22
.58
10.14
897.31
3,852

188.35
.11
154.66
.18
.23
.59
4.66
1351.57
781

Panel A: Outcome Variable Means

Notes: This table reports averages of outcome variables and hospital characteristics by safety net eligibility. A safety net
hospital is defined as any acute care hospital with disproportionate patient percentage of 20.2% or greater, annual
uncompensated care of at least $25,000 per bed and profit margin of 3.0% or less. Panel A reports the outcome variable
means. Outcome variable estimates are 7 day sums for the week spanning July 31st 2020 to August 6th 2020. Inpatient
bed totals also include observation beds. Panel B reports the means for hospital characteristics for the financial year 2018.

39

Table 3: Covariate Balance Regressions
Our Method with Quasi Propensity Score Controls

No
Controls
(1)

δ = 0.01
(2)

δ = 0.025
(3)

δ = 0.05
(4)

δ = 0.075
(5)

δ = 0.1
(6)

δ = 0.25
(7)

δ = 0.5
(8)

Mean
(9)

Beds

53.75***
(7.05)
N=4633

204.96
(106.65)
N=89

28.85
(67.20)
N=235

9.92
(47.17)
N=473

0.42
(38.63)
N=656

4.22
(33.69)
N=852

16.01
(20.11)
N=1699

8.95
(14.36)
N=2339

134.60

Costs per discharge
(in thousands)

−49.95**
(17.93)
N=3539

4.12
(2.12)
N=89

3.52*
(1.51)
N=235

1.72
(1.24)
N=473

−6.76
(8.34)
N=656

−0.43
(2.06)
N=852

5.68
(4.25)
N=1699

6.33
(4.80)
N=2339

66.28

Disproportionate
payment percent

0.21***
(0.01)
N=4633

−0.09
(0.09)
N=89

−0.09
(0.07)
N=235

−0.09
(0.07)
N=473

−0.08
(0.05)
N=656

−0.09
(0.05)
N=852

−0.06*
(0.02)
N=1699

−0.07***
(0.02)
N=2339

.18

Full time employees

454.26***
(69.23)
N=4626

2,841.76
(1,729.87)
N=89

307.37
(1,009.69)
N=234

127.92
(652.56)
N=472

27.38
(491.24)
N=655

−11.29
(428.97)
N=851

200.42
(218.73)
N=1696

114.27
(141.57)
N=2336

897.32

Medicare net revenue
(in millions)

18.36***
(2.39)
N=4511

37.35
(30.38)
N=88

−9.10
(18.55)
N=234

−4.61
(14.19)
N=471

−2.60
(11.80)
N=653

0.05
(10.77)
N=848

3.59
(6.66)
N=1659

−0.28
(4.62)
N=2295

20.04

Occupancy

0.07***
(0.01)
N=4624

0.19
(0.10)
N=89

0.07
(0.06)
N=235

−0.00
(0.04)
N=473

0.01
(0.04)
N=656

0.01
(0.03)
N=852

0.03
(0.02)
N=1699

0.04**
(0.01)
N=2339

.44

Operating margin

−0.11***
(0.01)
N=4541

−0.04
(0.06)
N=88

−0.01
(0.05)
N=234

0.03
(0.03)
N=465

0.02
(0.03)
N=646

0.03
(0.03)
N=841

0.06***
(0.02)
N=1651

0.07***
(0.01)
N=2285

.02

Profit margin

−0.11***
(0.01)
N=4633

−0.03
(0.06)
N=89

−0.01
(0.04)
N=235

0.02
(0.03)
N=473

0.01
(0.03)
N=656

0.02
(0.02)
N=852

0.04**
(0.01)
N=1699

0.06***
(0.01)
N=2339

.04

11,010.77
(10,352.08)
N=235

−4,644.86
(8,868.36)
N=473

−10,167.80
(7,606.21)
N=656

−11,096.86
(7,274.64)
N=852

−7,850.91
(4,520.95)
N=1699

−6,018.15
(3,638.71)
N=2339

56,556.02

.439

.565

.738

.236

.001

0

Uncompensated
care per bed
p-value for joint significance

19,540.28*** 3,654.68
(3,827.22)
(12,124.80)
N=4633
N=89
0

.697

Notes: This table shows the results of the covariate balance regressions at the hospital level. The dependent variables for these regressions are drawn from the
Healthcare Cost Report Information System for the financial year 2018. Disproportionate patient percentage, profit margin and uncompensated care per bed
are used to determine the hospital’s safety net funding eligibility. Other dependent variables shown indicate the financial health and utilization of the hospitals.
In column 1, we regress the dependent variables on the safety net eligibility of the hospital with no controls. In columns 2–8, we regress the dependent
variables on funding eligibility controlling for the Quasi Propensity Score with different values of bandwidth δ. All Quasi Propensity Scores are computed by
averaging 1,000 simulation draws. Column 9 shows the mean of dependent variables for hospitals that are ineligible to receive safety net funding. Robust
standard errors are reported in the parenthesis and number of observations are reported separately for each regression. The last row reports the p-value of the
joint significance test.

40

Table 4: Estimated Effects of Safety Net Funding on Hospital Utilization
OLS
with No
Controls

2SLS
with No
Controls

(1)

(2)

Our Method: 2SLS with Quasi Propensity Score Controls
δ=
0.01
(3)

δ=
0.025
(4)

δ=
0.05
(5)

δ=
0.075
(6)

δ = 0.1
(7)

δ=
0.25
(8)

δ = 0.5
(9)

7 day sum of patient currently hospitalized in an adult inpatient bed (including observation beds) who have
lab-confirmed or suspected COVID
First stage
(in millions)
$1mm of funding
Observations

5.52***
(0.68)
3544

13.79***
(0.49)
2.70***
(0.58)
3544

15.07*
(5.79)
−1.16
(5.36)
74

13.81***
(3.56)
−1.24
(5.11)
192

14.61***
(2.29)
−2.40
(4.79)
386

14.02***
(1.86)
−4.55
(4.64)
535

13.85***
(1.64)
−3.16
(3.70)
698

13.84***
(1.02)
0.15
(1.64)
1375

13.11***
(0.73)
−0.28
(1.22)
1934

7 day sum of patient currently hospitalized in an adult inpatient bed (including observation beds) who have
lab-confirmed COVID (including those with both lab-confirmed COVID and influenza)
First stage
(in millions)
$1mm of funding
Observations

4.50***
(0.63)
3572

13.91***
(0.50)
2.43***
(0.50)
3572

16.70**
(6.10)
−0.09
(4.09)
71

14.81***
(3.68)
−1.77
(3.70)
188

15.32***
(2.34)
1.79
(2.17)
378

14.62***
(1.91)
−0.21
(2.00)
527

14.41***
(1.67)
−0.07
(1.74)
689

14.01***
(1.04)
−0.08
(1.17)
1355

13.24***
(0.74)
−0.52
(0.97)
1911

7 day sum of patient currently hospitalized in a designated adult ICU bed who have lab-confirmed or suspected COVID
First stage
(in millions)
$1mm of funding
Observations

1.66***
(0.21)
3452

13.92***
(0.50)
0.95***
(0.18)
3452

14.70*
(5.58)
0.89
(1.39)
72

13.89***
(3.50)
0.87
(1.18)
183

16.02***
(2.34)
0.47
(0.73)
367

15.12***
(1.92)
−0.16
(0.70)
507

14.68***
(1.69)
0.06
(0.61)
659

14.26***
(1.06)
0.03
(0.42)
1300

13.27***
(0.75)
−0.26
(0.36)
1832

7 day sum of patient currently hospitalized in a designated adult ICU bed who have lab-confirmed COVID
(including those with both lab-confirmed COVID and influenza)
First stage
(in millions)
$1mm of funding
Observations

1.50***
(0.21)
3510

13.93***
(0.50)
0.88***
(0.17)
3510

15.78*
(6.07)
0.49
(1.45)
67

14.29***
(3.73)
0.08
(1.26)
178

16.06***
(2.42)
0.28
(0.70)
363

15.34***
(2.00)
−0.10
(0.64)
503

14.92***
(1.75)
0.04
(0.57)
648

14.37***
(1.09)
−0.10
(0.40)
1305

13.50***
(0.76)
−0.29
(0.34)
1853

Notes: In this table we regress relevant outcomes at the hospital level on safety net funding. Column 1 presents the results
of OLS regression of the outcome variables on safety net funding without any controls. In columns 2–9, we instrument
safety net funding with eligibility to receive this funding and present the results of 2SLS regressions. In columns 2–9, the
first stage shows the effect of being deemed eligible on the amount of relief funding received by hospitals, in millions of
dollars. Column 2 shows the results of a 2SLS regression with no controls. In columns 3–9, we run this regression
controlling for the Quasi Propensity Score with different values of bandwidth δ on the sample with nondegenerate Quasi
Propensity Score. All Quasi Propensity Scores are computed by averaging 1,000 simulation draws. Robust standard errors
are reported in parentheses.

41

A
A.1

Extensions and Discussions
Related Literature: Details

In this section, we discuss the related methodological literature on the multidimensional RDD in
detail. Imbens and Wager (2019) propose the finite-sample-minimax linear estimator of the form
Pn
i=1 γi Yi and uniform confidence intervals for treatment effects in the multidimensional RDD.
One version of their approach constructs a linear estimator by choosing the weight (γi )ni=1 greedily
to make the inference as precise as possible. Although their estimator is favorable in terms of
precision, it is not obvious what estimand the estimator estimates, without assuming a constant
treatment effect. The other version of Imbens and Wager (2019)’s approach and some other
existing approaches (Zajonc, 2012; Keele and Titiunik, 2015) consider nonparametric estimation
of the conditional average treatment effect E[Yi (1) − Yi (0)|Xi = x] for a specified boundary point
x. The estimand has a clear interpretation, but “when curvature is nonnegligible, equation (6)
can effectively make use of only data near the specified focal point c, thus resulting in relatively
long confidence intervals” (Imbens and Wager, 2019, p. 268), where equation (6) defines their
estimator.
To obtain more precise estimates while keeping interpretability, several papers studying a twodimensional RDD, including Zajonc (2012) and Keele and Titiunik (2015), propose to estimate
an integral of conditional average treatment effects over the boundary. Their approach first
nonparametrically estimates E[Yi (1) − Yi (0)|Xi = x] and the density of Xi for a large number of
points x in the boundary and then computes the weighted average of the estimated conditional
average treatment effects with the weight set to the estimated density.
The above approach is difficult to implement, however, when Xi is high dimensional or the
decision algorithm is a complex, black box function of Xi , for the following reasons. First, it
is computationally demanding to estimate E[Yi (1) − Yi (0)|Xi = x] for numerous points in the
boundary such that the weighted average well approximates the integral of E[Yi (1)−Yi (0)|Xi = x]
over the boundary. Second, identifying boundary points from a general decision algorithm itself
is hard unless it has a known analytical form. By contrast, we develop an estimator that uses
observations near all the boundary points without tracing out the boundary or knowing its
analytical form, thus alleviating the limitations of existing estimators.

A.2

QPS May Not Exist But Does Exist for Almost All x

Figure 4 shows an example where QPS does not exist at 0. In this example, Xi is two dimensional,
and
(
1 if 3( 21 )k−1 < kxk ≤ 4( 12 )k−1 for some k = 1, 2, · · ·
M L(x) =
0 if 2( 12 )k−1 < kxk ≤ 3( 12 )k−1 for some k = 1, 2, · · · .
It is shown that
(
pM L (0; δ) =

7
12
7
27

if δ = 4( 12 )k−1 for some k = 1, 2, · · ·
if δ = 3( 12 )k−1 for some k = 1, 2, · · · .
42

Figure 4: An example of the M L algorithm for which the Quasi Propensity Score fails to exist
Therefore, limδ→0 pM L (0; δ) does not exist.
Nevertheless, the Quasi Propensity Score exists for almost every x, as shown in the following
proposition.
Proposition A.1. pM L (x) exists and is equal to M L(x) for almost every x ∈ X (with respect
to the Lebesgue measure).
Proof. See Appendix C.5.

A.3

Discrete Covariates

In this section, we provide the definition of QPS and identification and consistency results when
Xi includes discrete covariates. Suppose that Xi = (Xdi , Xci ), where Xdi ∈ Rpd is a vector
of discrete covariates, and Xci ∈ Rpc is a vector of continuous covariates. Let Xd denote the
support of Xdi and be assumed to be finite. We also assume that Xci is continuously distributed
conditional on Xdi , and let Xc (xd ) denote the support of Xci conditional on Xdi = xd for each
xd ∈ Xd . Let Xc,0 (xd ) = {xc ∈ Xc (xd ) : M L(xd , xc ) = 0} and Xc,1 (xd ) = {xc ∈ Xc (xd ) :
M L(xd , xc ) = 1}.
Define QPS as follows: for each x = (xd , xc ) ∈ X ,
R
∗
∗
B(xc ,δ) M L(xd , xc )dxc
ML
R
p (x; δ) ≡
,
∗
B(xc ,δ) dxc
pM L (x) ≡ lim pM L (x; δ),
δ→0

where B(xc , δ) = {x∗c ∈ Rpc : kxc − x∗c k ≤ δ} is the δ-ball around xc ∈ Rpc . In other words, we
take the average of the M L(xd , x∗c ) values when x∗c is uniformly distributed on B(xc , δ) holding
xd fixed, and let δ → 0. Below, we assume that Assumptions 1, 2, 3 and 4 hold conditional on
Xdi .
43

Assumption A.1 (Almost Everywhere Continuity of M L).
(a) For every xd ∈ Xd , M L(xd , ·) is continuous almost everywhere with respect to the Lebesgue
measure Lpc .
(b) For every xd ∈ Xd , Lpc (Xc,k (xd )) = Lpc (int(Xc,k (xd ))) for k = 0, 1.
A.3.1

Identification

Assumption A.2 (Local Mean Continuity). For every xd ∈ Xd and z ∈ {0, 1}, the conditional
expectation functions E[Yzi |Xi = (xd , xc )] and E[Di (z)|Xi = (xd , xc )] are continuous in xc at
any point xc ∈ Xc (xd ) such that pM L (xd , xc ) ∈ (0, 1) and M L(xd , xc ) ∈ {0, 1}.
Let intc (X ) = {(xd , xc ) ∈ X : xc ∈ int(Xc (xd ))}. We say that a set A ⊂ Rp is open
relative to X if there exists an open set U ⊂ Rp such that A = U ∩ X . For a set A ⊂ Rp , let
XdA = {xd ∈ Xd : (xd , xc ) ∈ A for some xc ∈ Rpc } and XcA (xd ) = {xc ∈ Xc : (xd , xc ) ∈ A} for
each xd ∈ XdA .
Proposition A.2. Under Assumptions A.1 and A.2:
(a) E[Y1i − Y0i |Xi = x] and E[Di (1) − Di (0)|Xi = x] are identified for every x ∈ intc (X ) such
that pM L (x) ∈ (0, 1).
(b) Let A be any subset of X open relative to X such that pM L (x) exists for all x ∈ A. Then
either E[Y1i − Y0i |Xi ∈ A] or E[Di (1) − Di (0)|Xi ∈ A], or both are identified only if
pM L (x) ∈ (0, 1) for almost every xc ∈ XcA (xd ) for every xd ∈ XdA .
Proof. See Appendix C.7.
A.3.2

Estimation

For each xd ∈ Xd , let Ω∗ (xd ) = {xc ∈ Rpc : M L(xd , xc ) = 1}. Also, let Xd∗ = {xd ∈ Xd :
Var(M L(Xi )|Xdi = xd ) > 0}, and let fXc |Xd denote the probability density function of Xci
conditional on Xdi . In addition, for each xd ∈ Xd , let
C ∗ (xd ) = {xc ∈ Rpc : M L(xd , ·) is continuously differentiable at xc },
and let D∗ (xd ) = Rpc \ C ∗ (xd ).
Assumption A.3.
(a) (Finite Moments) E[Yi4 ] < ∞.
(b) (Nonzero First Stage) There exists a constant c > 0 such that E[Di (1) − Di (0)|Xi = x] > c
for every x ∈ X such that pM L (x) ∈ (0, 1).
(c) (Nonzero Conditional Variance) If Pr(M L(Xi ) ∈ (0, 1)) > 0, then Var(M L(Xi )|M L(Xi ) ∈
(0, 1)) > 0.
44

If Pr(M L(Xi ) ∈ (0, 1)) = 0, then the following conditions (d)–(g) hold.
(d) (Nonzero Variance) Xd∗ 6= ∅.
(e) (C 2 Boundary of Ω∗ (xd )) For each xd ∈ Xd∗ , there exists a partition {Ω∗1 (xd ), ..., Ω∗M (xd )}
of Ω∗ (xd ) such that
(i) dist(Ω∗m (xd ), Ω∗m0 (xd )) > 0 for any m, m0 ∈ {1, ..., M } such that m 6= m0 ;
(ii) Ω∗m (xd ) is nonempty, bounded, open, connected and twice continuously differentiable
for each m ∈ {1, ..., M }.
(f ) (Regularity of Deterministic M L)
(i) For each xd ∈ Xd∗ , Hpc −1 (∂Ω∗ (xd )) < ∞, and

R

∂Ω∗ (xd ) fXc |Xd (xc |xd )dH

pc −1 (x )
c

> 0.

(ii) There exists δ > 0 such that M L(xd , xc ) = 0 for almost every xc ∈ N (Xc (xd ), δ) \
Ω∗ (xd ).
(g) (Conditional Means and Density near ∂Ω∗ (xd )) For each xd ∈ Xd∗ , there exists δ > 0 such
that
(i) E[Y1i |Xi = (xd , ·)], E[Y0i |Xi = (xd , ·)], E[Di (1)|Xi = (xd , ·)], E[Di (0)|Xi = (xd , ·)]
and fXc |Xd (·|xd ) are continuously differentiable and have bounded partial derivatives
on N (∂Ω∗ (xd ), δ);
(ii) E[Y1i2 |Xi = (xd , ·)], E[Y0i2 |Xi = (xd , ·)], E[Y1i Di (1)|Xi = (xd , ·)] and E[Y0i Di (0)|Xi =
(xd , ·)] are continuous on N (∂Ω∗ (xd ), δ);
(iii) E[Yi4 |Xi = (xd , ·)] is bounded on N (∂Ω∗ (xd ), δ).
Assumption A.4. If Pr(M L(Xi ) ∈ (0, 1)) > 0, then the following conditions (a)–(c) hold.
(a) (Probability of Neighborhood of D∗ (xd )) For each xd ∈ Xd∗ , Pr(Xi ∈ N (D∗ (xd ), δ)) =
O(δ).
(b) (Bounded Partial Derivatives of M L) For each xd ∈ Xd∗ , the partial derivatives of M L(xd , ·)
are bounded on C ∗ (xd ).
(c) (Bounded Conditional Mean) For each xd ∈ Xd∗ , E[Yi |Xi = (xd , ·)] is bounded on Xc (xd ).
Theorem A.1. Suppose that Assumptions A.1 and A.3 hold, and that δn → 0, nδn → ∞ and
Sn → ∞ as n → ∞. Then the 2SLS estimators β̂1 and β̂1s converge in probability to
β1 ≡ lim E[ωi (δ)(Yi (1) − Yi (0))],
δ→0

where
ωi (δ) =

pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))
.
E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))]

Suppose, in addition, that Assumptions A.4 and 5 hold and that nδn2 → 0 as n → ∞. Then
d

σ̂n−1 (β̂1 − β1 ) −→ N (0, 1),
d

(σ̂ns )−1 (β̂1s − β1 ) −→ N (0, 1).
45

Proof. See Appendix C.8.
As in the case in which all covariates are continuous, the probability limit of the 2SLS
estimators has more specific expressions depending on whether Pr(M L(Xi ) ∈ (0, 1)) > 0 or not.
If Pr(M L(Xi ) ∈ (0, 1)) > 0,
plim β̂1 = plim β̂1s =

E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))(Yi (1) − Yi (0))]
.
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

If Pr(M L(Xi ) ∈ (0, 1)) = 0,
plim β̂1
= plim β̂1s
P
=

xd ∈Xd∗

R
Pr(Xdi = xd ) ∂Ω∗ (xd ) E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x]fXc |Xd (xc |xd )dHpc −1 (xc )
R
P
.
pc −1 (x )
c
xd ∈X ∗ Pr(Xdi = xd ) ∂Ω∗ (xd ) E[Di (1) − Di (0)|Xi = x]fXc |Xd (xc |xd )dH
d

A.4

A Sufficient Condition for Assumption 4 (a)

We provide a sufficient condition for Assumption 4 (a).
Assumption A.5.
∗ ⊂ Rp such that
(a) (Twice Continuous Differentiability of D∗ ) There exist C1∗ , ..., CM
∗
(i) ∂(C̃ ∗ ) = D∗ , where C̃ ∗ ≡ ∪M
m=1 Cm ;
∗ , C ∗ ) > 0 for any m, m0 ∈ {1, ..., M } such that m 6= m0 ;
(ii) dist(Cm
m0
∗ is nonempty, bounded, open, connected and twice continuously differentiable for
(iii) Cm
each m ∈ {1, ..., M }.

(b) (Regularity of D∗ ) Hp−1 (D∗ ) < ∞.
(c) (Bounded Density near D∗ ) There exists δ > 0 such that fX is bounded on N (D∗ , δ).
The key condition is the twice continuous differentiability of D∗ . This condition holds if,
for example, the -Greedy algorithm described in Part 2 (a) of Example 1 in Section 7 uses an
estimated Q-function that is twice continuously differentiable in x.
Under Assumption A.5 (a), by Lemma B.4 in Appendix B.3 and with change of variables
v = λδ , for any sufficiently small δ > 0,
Pr(Xi ∈ N (D∗ , δ)) =

Z

δ

Z

−δ

Z

∗

D∗
1

D
fX (u + λνC̃ ∗ (u))Jp−1
ψC̃ ∗ (u, λ)dHp−1 (u)dλ

Z

=δ
−1

D∗

∗

D
fX (u + δvνC̃ ∗ (u))Jp−1
ψC̃ ∗ (u, δv)dHp−1 (u)dv.

(See Appendix B for the notation.) If fX is bounded on N (D∗ , δ) and Hp−1 (D∗ ) < ∞, the
right-hand side is O(δ).
46

A.5

Sampling from Uniform Distribution on p-Dimensional Ball

When we calculate QPS by simulation, we need to uniformly sample from B(Xi , δ). We introduce
three existing methods to uniformly sample from a p-dimensional unit ball B(0, 1). By multiplying the sampled vector by δ and adding Xi to it, we can sample from a uniform distribution
on B(Xi , δ).
Method 1.
1. Sample x1 , ..., xp independently from the uniform distribution on [−1, 1].
P
2. Accept the vector x = (x1 , ..., xp ) if pk=1 x2k ≤ 1 and reject it otherwise.
Method 1 is a practical choice when p is small (e.g. p = 2, 3), but is inefficient for higher
dimensions, since the acceptance rate decreases to zero quickly as p increases. The conventional
method used for higher dimensions is the following.
Method 2.
1. Sample x∗1 , ..., x∗p independently from the standard normal distribution, and compute the
qP
p
∗ 2
vector s = (x∗1 , ..., x∗p )/
k=1 (xk ) .
2. Sample u from the uniform distribution on [0, 1].
3. Return the vector x = u1/p s.
There is yet another method efficient for higher dimensions, which is recently proposed by
Voelker, Gosmann and Stewart (2017).
Method 3.
1. Sample x∗1 , ..., x∗p+2 independently from the standard normal distribution, and compute the
qP
p+2 ∗ 2
vector s = (x∗1 , ..., x∗p+2 )/
k=1 (xk ) .
2. Return the vector x = (s1 , ..., sp ).

B
B.1

Notation and Lemmas
Basic Notations

For a scalar-valued differentiable function f : A ⊂ Rn → R, let ∇f : A → Rn be a gradient of f :
for every x ∈ A,


∂f (x)
∂f (x) 0
∇f (x) =
,··· ,
.
∂x1
∂xn
Also, when the second-order partial derivatives of f exist, let D2 f (x) be the Hessian matrix:
 ∂ 2 f (x)
..
.

···
..
.

∂ 2 f (x)
∂xn ∂x1

···

∂x21


D2 f (x) = 

for each x ∈ A.

47

∂ 2 f (x)
∂x1 ∂xn

..
.

∂ 2 f (x)
∂x2n






Let f : A ⊂ Rm → Rn be a function such that its first-order partial derivatives exist. For
each x ∈ A, let Jf (x) be the Jacobian matrix of f at x:


∂f1 (x)
· · · ∂f∂x1 (x)
∂x1
m
 .
.. 
..
..
Jf (x) = 
.
. 

.
∂fn (x)
∂fn (x)
· · · ∂xm
∂x1
For a positive integer n, let In denote the n × n identity matrix.

B.2

Differential Geometry

We provide some concepts and facts from differential geometry of twice continuously differentiable
sets, following Crasta and Malusa (2007). Let A ⊂ Rp be a twice continuously differentiable set.
For each x ∈ ∂A, we denote by νA (x) ∈ Rp the inward unit normal vector of ∂A at x, that is,
the unit vector orthogonal to all vectors in the tangent space of ∂A at x that points toward the
inside of A. For a set A ⊂ Rp , let dsA : Rp → R be the signed distance function of A, defined by
(
d(x, ∂A)
if x ∈ cl(A)
s
dA (x) =
−d(x, ∂A)
if x ∈ Rp \ cl(A),
where d(x, B) = inf y∈B ky − xk for any x ∈ Rp for a set B ⊂ Rp . Note that we can write
N (∂A, δ) = {x ∈ Rp : −δ < dsA (x) < δ} for δ > 0. Lastly, let Π∂A (x) = {y ∈ ∂A : ky − xk =
d(x, ∂A)} be the set of projections of x on ∂A.
Lemma B.1 (Corollary of Theorem 4.16, Crasta and Malusa (2007)). Let A ⊂ Rp be nonempty,
bounded, open, connected and twice continuously differentiable. Then the function dsA is twice
continuously differentiable on N (∂A, µ) for some µ > 0. In addition, for every x0 ∈ ∂A,
Π∂A (x0 + tνA (x0 )) = {x0 } for every t ∈ (−µ, µ). Furthermore, for every x ∈ N (∂A, µ), Π∂A (x)
is a singleton, ∇dsA (x) = νA (y) and x = y + dsA (x)νA (y) for y ∈ Π∂A (x), and k∇dsA (x)k = 1.
Proof. We apply results from Crasta and Malusa (2007). Let K = {x ∈ Rp : kxk ≤ 1}. K is
nonempty, compact, convex subset of Rp with the origin as an interior point. The polar body
of K, defined as K0 = {y ∈ Rp : y · x ≤ 1 for all x ∈ K}, is K itself. The gauge functions
ρK , ρK0 : Rp → [0, ∞] of K and K0 are given by
ρK (x) ≡ inf{t ≥ 0 : x ∈ tK} = kxk,
ρK0 (x) ≡ inf{t ≥ 0 : x ∈ tK0 } = kxk.
Given ρK0 , the Minkowski distance from a set S ⊂ Rp is defined as
δS (x) ≡ inf ρK0 (x − y),
y∈S

x ∈ Rp .

Note that we can write
dsA (x)

=

(
δ∂A (x)

if x ∈ cl(A)
if x ∈ Rp \ cl(A).

−δ∂A (x)
48

It then follows from Theorem 4.16 of Crasta and Malusa (2007) that dsA is twice continuously
differentiable on N (∂A, µ) for some µ > 0, and for every x0 ∈ ∂A,
∇dsA (x0 ) =

νA (x0 )
νA (x0 )
=
= νA (x0 ),
ρK (νA (x0 ))
kνA (x0 )k

where the last equality follows since νA (x0 ) is a unit vector. It then follows that k∇dsA (x0 )k =
kνA (x0 )k = 1 for every x0 ∈ ∂A. Also, it is obvious that, for every x0 ∈ ∂A, Π∂A (x0 ) = {x0 } and
x0 = x0 + dsA (x0 )νA (x0 ), since dsA (x0 ) = 0. In addition, as stated in the proof of Theorem 4.16
of Crasta and Malusa (2007), µ is chosen so that (4.7) in Proposition 4.6 of Crasta and Malusa
(2007) holds for every x0 ∈ ∂A and every t ∈ (−µ, µ). That is, Π∂A (x0 + t∇ρK (νA (x0 ))) =
(x0 )
= νA (x0 ),
{x0 } for every x0 ∈ ∂A and every t ∈ (−µ, µ). Since ∇ρK (νA (x0 )) = kννA
A (x0 )k
Π∂A (x0 + tνA (x0 )) = {x0 } for every x0 ∈ ∂A and every t ∈ (−µ, µ).
Furthermore, for every x ∈ N (∂A, µ) \ ∂A, Π∂A (x) is a singleton as shown in the proof of
Theorem 4.16 of Crasta and Malusa (2007). Let π∂A (x) be the unique element in Π∂A (x). By
Lemma 4.3 of Crasta and Malusa (2007), for every x ∈ N (∂A, µ) \ ∂A,
∇dsA (x) =

νA (π∂A (x))
νA (π∂A (x))
=
= νA (π∂A (x)),
ρK (νA (π∂A (x)))
kνA (π∂A (x))k

where the last equality follows since νA (π∂A (x)) is a unit vector. It then follows that k∇dsA (x)k =
kνA (π∂A (x))k = 1 for every x ∈ N (∂A, µ) \ ∂A.
Lastly, note that
(
dsA (x)
if x ∈ N (∂A, µ) ∩ int(A)
δ∂A (x) =
−dsA (x)
if x ∈ N (∂A, µ) \ cl(A),
and
∇δ∂A (x) =

(
∇dsA (x)

if x ∈ N (∂A, µ) ∩ int(A)
if x ∈ N (∂A, µ) \ cl(A),

−∇dsA (x)

so δ∂A (x)∇δ∂A (x) = dsA (x)∇dsA (x) = dsA (x)νA (π∂A (x)) for every x ∈ N (∂A, µ) \ ∂A. By Proposition 3.3 (i) of Crasta and Malusa (2007), for every x ∈ N (∂A, µ) \ ∂A,
∇ρK (∇δ∂A (x)) =

x − π∂A (x)
,
δ∂A (x)

which implies that
x = π∂A (x) + δ∂A (x)∇ρK (∇δ∂A (x))
= π∂A (x) + δ∂A (x)

∇δ∂A (x)
= π∂A (x) + dsA (x)νA (π∂A (x)).
k∇δ∂A (x)k

We say that a set A ⊂ Rn is a m-dimensional C 1 submanifold of Rn if for every point x ∈ A,
there exist an open neighborhood V ⊂ Rn of x and a one-to-one continuously differentiable
function φ from an open set U ⊂ Rm to Rn such that the Jacobian matrix Jφ(u) is of rank m
for all u ∈ U , and φ(U ) = V ∩ A.
49

Lemma B.2. Let A ⊂ Rp be nonempty, bounded, open, connected and twice continuously differentiable. Then ∂A is a (p − 1)-dimensional C 1 submanifold of Rp ,
Proof. Fix any x∗ ∈ ∂A. By Lemma B.1, ∇dsA (x∗ ) is nonzero. Without loss of generality, let
∂dsA (x∗ )
6= 0. Let ψ : Rp → Rp be the function such that ψ(x) = (x1 , ..., xp−1 , dsA (x)). ψ is
∂xp
continuously differentiable, and the Jacobian matrix of ψ at x∗ is given by



 ∂ψ
0
∂ψ1
∗
∗
1

∂x1 (x ) · · · ∂xp (x )
.. 
 

Ip−1
. 
..
..
.
∗
.



.
Jψ(x ) = 
.
.
.

=
0

 s ∗
∂ψp
∗ ) · · · ∂ψp (x∗ )
s
∗
s
∗
(x
∂dA (x )
∂dA (x )
∂dA (x )
∂x1
∂xp
·
·
·
∂x1
∂xp−1
∂xp
∂ds (x∗ )

A
Since ∂x
6= 0, the Jacobian matrix is invertible. By the Inverse Function Theorem, there
p
exist an open set V containing x∗ and an open set W containing ψ(x∗ ) such that ψ : V → W
has an inverse function ψ −1 : W → V that is continuously differentiable. We make V small
∂dsA (x)
enough so that ∂x
6= 0 for every x ∈ V . The Jacobian matrix of ψ −1 is given by Jψ −1 (y) =
p
Jψ(ψ −1 (y))−1 for all y ∈ W .
Now note that ψ(x) = (x1 , ..., xp−1 , 0) for all x ∈ V ∩ ∂A by the definition of dsA . Let U =
{(x1 , ..., xp−1 ) ∈ Rp−1 : x ∈ V ∩ ∂A} and φ : U → Rp be a function such that φ(u) = ψ −1 ((u, 0))
for all u ∈ U . Below we verify that φ is one-to-one and continously differentiable, that Jφ(u) is
of rank p − 1 for all u ∈ U , that φ(U ) = V ∩ ∂A, and that U is open.
First, φ is one-to-one, since ψ −1 is one-to-one, and (u, 0) 6= (u0 , 0) if u 6= u0 . Second, φ is
continuously differentiable, since ψ −1 is so. The Jacobian matrix of φ at u ∈ U is by definition
 −1

∂ψ1
∂ψ1−1
((u,
0))
·
·
·
((u,
0))
∂yp−1

 ∂y1


..
..
.
.
Jφ(u) = 
.
.
.
.

 ‘
−1
∂ψp −1
∂ψp
((u,
0))
·
·
·
((u,
0))
∂y1
∂yp−1

Note that this is the left p × (p − 1) submatrix of Jψ −1 ((u, 0)). Since Jψ −1 ((u, 0)) has full rank,
Jφ(u) is of rank p − 1. Moreover,
φ(U ) = {ψ −1 ((u, 0)) : u ∈ U }
= {ψ −1 ((x1 , ..., xp−1 , 0)) : x ∈ V ∩ ∂A}
= {ψ −1 (ψ(x)) : x ∈ V ∩ ∂A}
= V ∩ ∂A.
Lastly, we show that U is open. Pick any ū ∈ U . Then, there exists x̄p ∈ R such that
∂ds ((ū,x̄ ))
(ū, x̄p ) ∈ V ∩ ∂A. As (ū, x̄p ) ∈ V ∩ ∂A, dsA ((ū, x̄p )) = 0. Since A ∂xp p 6= 0, it follows by the
Implicit Function Theorem that there exist an open set S ⊂ Rp−1 containing ū and a continuously
differentiable function g : S → R such that g(ū) = x̄p and dsA (u, g(u)) = 0 for all u ∈ S. Since
g is continuous, (ū, g(ū)) ∈ V and V is open, there exists an open set S 0 ⊂ S containing ū such
that (u, g(u)) ∈ V for all u ∈ S 0 . By the definition of dsA , dsA (x) = 0 if and only if x ∈ ∂A.
Therefore, if u ∈ S 0 , (u, g(u)) must be contained by ∂A, for otherwise dsA (u, g(u)) 6= 0, which is
a contradiction. Thus, (u, g(u)) ∈ V ∩ ∂A and hence u ∈ U for all u ∈ S 0 . This implies that S 0
is an open subset of U containing ū, which proves that U is open.
50

B.3

Geometric Measure Theory

We provide some concepts and facts from geometric measure theory, following Krantz and Parks
(2008). Recall that for a function f : A ⊂ Rm → Rn and a point x ∈ A at which f is differentiable,
Jf (x) denotes the Jacobian matrix of f at x.
Lemma B.3 (Coarea Formula, Lemma 5.1.4 and Corollary 5.2.6 of Krantz and Parks (2008)).
If f : Rm → Rn is a Lipschitz function and m ≥ n, then
Z Z
Z
m
g(x)dHm−n (x)dLn (y)
g(x)Jn f (x)dL (x) =
Rn

A

{x0 ∈A:f (x0 )=y}

for every Lebesgue measurable subset A of Rm and every Lm -measurable function g : A → R,
where for each x ∈ Rm at which f is differentiable,
p
Jn f (x) = det((Jf (x))(Jf (x))0 ).
Let A be an m-dimensional C 1 submanifold of Rn . Let x ∈ A and let φ : U ⊂ Rm → Rn be
as in the definition of m-dimensional C 1 submanifold. We denote by TA (x) the tangent space of
A at x, {Jφ(u)v : v ∈ Rm }, where u = φ−1 (x).
Lemma B.4 (Area Formula, Lemma 5.3.5 and Theorem 5.3.7 of Krantz and Parks (2008)).
Suppose m ≤ ν and f : Rn → Rν is Lipschitz. If A is an m-dimensional C 1 submanifold of Rn ,
then
Z
Z
X
A
m
g(x)Jm f (x)dH (x) =
g(x)dHm (y)
Rν x∈A:f (x)=y

A

for every Hm -measurable function g : A → R, where for each x ∈ Rn at which f is differentiable,
A
Jm
f (x) =

Hm ({Jf (x)y : y ∈ P })
Hm (P )

for an arbitrary m-dimensional parallelepiped P contained in TA (x).
Let A ⊂ Rp . For each x ∈ Rp at which dsA is differentiable and for each λ ∈ R, let ψA (x, λ) =
x + λ∇dsA (x).
Lemma B.5. Let Ω ⊂ Rp , and suppose that there exists a partition {Ω1 , ..., ΩM } of Ω such that
(i) dist(Ωm , Ωm0 ) > 0 for any m, m0 ∈ {1, ..., M } such that m 6= m0 ;
(ii) Ωm is nonempty, bounded, open, connected and twice continuously differentiable for each
m ∈ {1, ..., M }.
Then there exists µ > 0 such that dsΩ is twice continuously differentiable on N (∂Ω, µ) and that
Z
Z δZ
∂Ω
g(x)dx =
g(u + λνΩ (u))Jp−1
ψΩ (u, λ)dHp−1 (u)dλ
N (∂Ω,δ)

−δ

∂Ω

for every δ ∈ (0, µ) and every function g : Rp → R that is integrable on N (∂Ω, δ), where for
∂Ω ψ (·, λ) is calculated by applying the operation J ∂Ω to the function
each fixed λ ∈ (−µ, µ), Jp−1
Ω
p−1
∂Ω ψ (x, ·) is continuously differentiable in λ and J ∂Ω ψ (x, 0) = 1 for
ψΩ (·, λ). Futhermore, Jp−1
Ω
p−1 Ω
∂Ω ψ (·, ·) and
every x ∈ ∂Ω, and Jp−1
Ω

∂Ω ψ (·,·)
∂Jp−1
Ω
∂λ

are bounded on ∂Ω × (−µ, µ).
51

Proof. Let µ̄ = 21 minm,m0 ∈{1,...,M },m6=m0 dist(Ω∗m , Ωm0 ) so that {N (∂Ωm , µ̄)}M
m=1 is a partition of
s
s
N (∂Ω, µ̄). Note that for every m ∈ {1, ..., M }, dΩ (x) = dΩm (x) for every x ∈ N (∂Ωm , µ̄). By
Lemma B.1, for every m ∈ {1, ..., M }, there exists µ̄m > 0 such that dsΩm is twice continuously
differentiable on N (∂Ωm , µ̄m ). Letting µ ∈ (0, min{µ̄, µ̄1 , ..., µ̄M }), we have that dsΩ is twice
continuously differentiable on N (∂Ω, µ). This implies that dsΩ is Lipschitz on N (∂Ω, µ). For
every δ ∈ (0, µ) and every function g : Rp → R that is integrable on N (∂Ω, δ),
Z
Z
q
g(x) det(k∇dsΩ (x)k)dx
g(x)dx =
{x0 ∈Rp :dsΩ (x0 )∈(−δ,δ)}

N (∂Ω,δ)

Z
=
{x0 ∈Rp :dsΩ (x0 )∈(−δ,δ)}

Z
=
{x0 ∈Rp :dsΩ (x0 )∈(−δ,δ)}

q
g(x) det(∇dsΩ (x)0 ∇dsΩ (x))dx
q
g(x) det((JdsΩ (x))(JdsΩ (x))0 )dx

Z Z

g(x)dHp−1 (x)dλ

=
R

Z

δ

{x0 ∈Rp :dsΩ (x0 )∈(−δ,δ),dsΩ (x0 )=λ}

Z

g(x)dHp−1 (x)dλ,

=
−δ

{x0 ∈Rp :dsΩ (x0 )=λ}

(12)

where the first equality follows since k∇dsΩ (x)k = 1 for every x ∈ N (∂Ω, δ) by Lemma B.1, the
third equality follows from the definition of the Jacobian matrix, and the fourth equality follows
from Lemma B.3.
Let Γ(λ) = {x ∈ Rp : dsΩ (x) = λ} for each λ ∈ (−µ, µ). Since ∇dsΩ is differentiable on
N (∂Ω, µ), ψΩ (x, λ) is defined on N (∂Ω, µ) × R. We show that {ψΩ (x0 , λ) : x0 ∈ ∂Ω} ⊂ Γ(λ) for
every λ ∈ (−µ, µ). By Lemma B.1, for every x0 ∈ ∂Ω, ψΩ (x0 , λ) = x0 + λνΩ (x0 ) and
Π∂Ω (ψΩ (x0 , λ)) = Π∂Ω (x0 + λνΩ (x0 )) = {x0 }.
Hence,
d(ψΩ (x0 , λ), ∂Ω) = kψΩ (x0 , λ) − x0 k = kλνΩ (x0 )k = |λ|.
Since νΩ (x0 ) is an inward normal vector, ψΩ (x0 , λ) ∈ cl(A) if 0 ≤ λ < µ, and ψΩ (x, λ0 ) ∈
Rp \ cl(A) if −µ < λ < 0. It follows that
dsA (ψΩ (x0 , λ))

=

(
|λ|
−|λ|

if 0 ≤ λ < µ
if µ < λ < 0

= λ,
so {ψΩ (x0 , λ) : x0 ∈ ∂Ω} ⊂ Γ(λ). It also holds that Γ(λ) ⊂ {ψΩ (x0 , λ) : x0 ∈ ∂Ω}, since by
Lemma B.1, for every x ∈ Γ(λ),
ψΩ (π∂Ω (x), λ) = π∂Ω (x) + λ∇dsΩ (π∂Ω (x)) = π∂Ω (x) + dsΩ (x)νΩ (π∂Ω (x)) = x,
where π∂Ω (x) is the unique element in Π∂Ω (x). Thus, {ψΩ (x0 , λ) : x0 ∈ ∂Ω} = Γ(λ).
52

0
Now note that {∂Ωm }M
m=1 is a partition of ∂Ω, since dist(Ωm , Ωm0 ) > 0 for any m, m ∈
{1, ..., M } such that m 6= m0 . By Lemma B.2, ∂Ωm is a (p − 1)-dimensional C 1 submanifold
of Rp for every m ∈ {1, ..., M }, and hence ∂Ω is a (p − 1)-dimensional C 1 submanifold of
Rp . Furthermore, since ∇dsΩ is continuously differentiable on N (∂Ω, µ), ψΩ (·, λ) is continuously
differentiable on N (∂Ω, µ), which implies that ψΩ (·, λ) is Lipschitz on N (∂Ω, µ) for every λ ∈ R.
Applying Lemma B.4, we have that for every λ ∈ (−µ, µ),
Z
Z
∂Ω
∂Ω
p−1
g(ψΩ (u, λ))Jp−1
ψΩ (u, λ)dHp−1 (u)
g(u + λνΩ (u))Jp−1 ψΩ (u, λ)dH (u) =
∂Ω
∂Ω
Z
X
g(ψΩ (u, λ))dHp−1 (x).
(13)
=
Rp u∈∂Ω:ψ (u,λ)=x
Ω

If x ∈
/ {ψΩ (u, λ) : u ∈ ∂Ω}, {u ∈ ∂Ω : ψΩ (u, λ) = x} = ∅. If x ∈ {ψΩ (u, λ) : u ∈ ∂Ω}, there exists
u ∈ ∂Ω such that x = ψΩ (u, λ). Since Π∂Ω (x) = Π∂Ω (u + λ∇dsΩ (u)) = Π∂Ω (u + λνΩ (u)) = {u}
by Lemma B.1, such u is unique, and hence {u ∈ ∂Ω : ψΩ (u, λ) = x} is a singleton. It follow
that
Z
Z
X
p−1
g(ψΩ (u, λ))dH (x) =
g(x)dHp−1 (x)
Rp u∈∂Ω:ψ (u,λ)=x
Ω

{ψΩ (u,λ):u∈∂Ω}

Z
=

g(x)dHp−1 (x),

(14)

Γ(λ)

where the last equality holds since {ψΩ (u, λ) : u ∈ ∂Ω} = Γ(λ). Combining (12), (13) and (14),
we obtain
Z
Z δZ
∂Ω
g(x)dx =
g(u + λνΩ (u))Jp−1
ψΩ (u, λ)dHp−1 (u)dλ.
N (∂Ω,δ)

−δ

∂Ω

∂Ω ψ (x, 0) = 1
We next show that
is continuously differentiable in λ and Jp−1
Ω
for every x ∈ ∂Ω. Fix an x ∈ ∂Ω, and let VΩ (x) be an arbitrary p × (p − 1) matrix whose
columns v1 (x), ..., vp−1 (x) ∈ Rp form an orthonormal basis of T∂Ω (x). Let P (x) ⊂ T∂Ω (x)
Pp−1
be a parallelepiped determined by v1 (x), ..., vp−1 (x), that is, let P (x) = { k=1
ck vk (x) : 0 ≤
ck ≤ 1 for k = 1, ..., p − 1}. Since v1 (x), ..., vp−1 (x) are linearly independent, P (x) is a (p − 1)dimensional parallelepiped. It follows that for each fixed λ ∈ R,
∂Ω ψ (x, ·)
Jp−1
Ω

{JψΩ (x, λ)y : y ∈ P (x)} = {JψΩ (x, λ)

p−1
X

ck vk (x) : 0 ≤ ck ≤ 1 for k = 1, ..., p − 1}

k=1

={

p−1
X

ck JψΩ (x, λ)vk (x) : 0 ≤ ck ≤ 1 for k = 1, ..., p − 1}

k=1

={

p−1
X

ck wk (x, λ) : 0 ≤ ck ≤ 1 for k = 1, ..., p − 1},

k=1

where wk (x, λ) = JψΩ (x, λ)vk (x) for k = 1, ..., p − 1. Since JψΩ (x, λ)vk (x) is the k-th column
of JψΩ (x, λ)VΩ (x), {JψΩ (x, λ)y : y ∈ P (x)} is the parallelepiped determined by the columns of

53

JψΩ (x, λ)VΩ (x). By Proposition 5.1.2 of Krantz and Parks (2008), we have that
∂Ω
ψΩ (x, λ)
Jp−1

=

Hp−1 ({

Pp−1

: 0 ≤ ck ≤ 1 for k = 1, ..., p − 1})
Hp−1 (P (x))

k=1 ck wk (x, λ)

p
det((JψΩ (x, λ)VΩ (x))0 (JψΩ (x, λ)VΩ (x)))
p
=
det(VΩ (x)0 VΩ (x))
p
det((VΩ (x) + λD2 dsΩ (x)VΩ (x))0 (VΩ (x) + λD2 dsΩ (x)VΩ (x)))
p
=
det(Ip−1 )
q
= det(VΩ (x)0 VΩ (x) + 2VΩ (x)0 λD2 dsΩ (x)VΩ (x) + VΩ (x)0 (λD2 dsΩ (x))2 VΩ (x))
q
= det(Ip−1 + λVΩ (x)0 (2D2 dsΩ (x) + λ(D2 dsΩ (x))2 )VΩ (x)))
q
= det(Ip + λVΩ (x)VΩ (x)0 (2D2 dsΩ (x) + λ(D2 dsΩ (x))2 )),
where we use the fact that VΩ (x)0 VΩ (x) = Ip−1 and the fact that det(Im + AB) = det(In + BA)
for an m × n matrix A and an n × m matrix B (the Weinstein-Aronszajn identity). For every
p
∂Ω ψ (x, ·) is continuously differentiable in λ, and J ∂Ω ψ (x, 0) =
det(Ip ) = 1.
x ∈ ∂Ω, Jp−1
Ω
p−1 Ω
∂J ∂Ω ψΩ (·,·)

p−1
∂Ω ψ (·, ·) and
Lastly, we show that Jp−1
Ω
∂λ
∂Ω × Rp×(p−1) → Rp×p be functions such that

are bounded on ∂Ω × (−µ, µ). Let f, h :

f (x, A) = 2AA0 D2 dsΩ (x),
h(x, A) = AA0 (D2 dsΩ (x))2 .
Also, let k : ∂Ω × R × Rp×(p−1) → R be a function such that
q
k(x, λ, A) = det(Ip + λf (x, A) + λ2 h(x, A)).
Observe that
∂Ω
Jp−1
ψΩ (x, λ) = k(x, λ, VΩ (x))

and that
∂Ω ψ (x, λ)
∂Jp−1
Ω
∂λ
∂k(x, λ, A)
=
∂λ
A=VΩ (x)

=

X ∂det(Ip + λf (x, A) + λ2 h(x, A))
1
(fij (x, A) + 2λhij (x, A))
2k(x, λ, A)
∂bij
i,j

,
A=VΩ (x)

where ∂det(B)
denotes the partial derivative of the function det : Rp×p → R with respect to the
∂bij
(i, j) entry of B.
Note that k(·, ·, ·) and ∂k(·,·,·)
are continuous on ∂Ω × R × Rp×(p−1) (except at the points
∂λ
for which k(x, λ, A) = 0), since det is infinitely differentiable, and f and h are continuous on
54

∂Ω × Rp×(p−1) . Let S = {(x, λ, A) ∈ ∂Ω × [−µ, µ] × Rp×(p−1) : kaj k = 1 for k = 1, ..., p − 1},
where aj denotes the jth column of A. Since k(·, ·, ·) and ∂k(·,·,·)
are continuous and S is
∂λ
0
closed and bounded, k̄ = max(x,λ,A)∈S |k(x, λ, A)| and k̄ = max(x,λ,A)∈S | ∂k(x,λ,A)
| exist. Since
∂λ
∂Ω ψ (x, λ)| ≤ k̄ and
(x, λ, VΩ (x)) ∈ S for every (x, λ) ∈ ∂Ω × (−µ, µ), it follows that |Jp−1
Ω
|

∂Ω ψ (x,λ)
∂Jp−1
Ω
|
∂λ

B.4

≤ k̄ 0 for every (x, λ) ∈ ∂Ω × (−µ, µ).

Other Lemmas

2
Lemma B.6. Let {Vi }∞
i=1 be i.i.d. random variables such that E[Vi ] < ∞. If Assumption 1
holds, then for l ≥ 0 and m = 0, 1,

E[Vi pM L (Xi ; δ)l 1{pM L (Xi ; δ) ∈ (0, 1)}m ] → E[Vi M L(Xi )l 1{M L(Xi ) ∈ (0, 1)}m ]
as δ → 0. Moreover, if, in addition, δn → 0 as n → ∞, then for l ≥ 0,
n

1X
p
Vi pM L (Xi ; δn )l Ii,n −→ E[Vi M L(Xi )l 1{M L(Xi ) ∈ (0, 1)}]
n
i=1

as n → ∞.
Proof. Note that E[ n1
show that

Pn

i=1 Vi p

= E[Vi pM L (Xi ; δn )l 1{pM L (Xi ; δn ) ∈ (0, 1)}]. We

M L (X ; δ )l I ]
i n
i,n

E[Vi pM L (Xi ; δ)l 1{pM L (Xi ; δ) ∈ (0, 1)}m ] → E[Vi M L(Xi )l 1{M L(Xi ) ∈ (0, 1)}m ]
for l ≥ 0 and m = 0, 1 as δ → 0, and that
n

1X
Var(
Vi pM L (Xi ; δn )l Ii,n ) → 0
n
i=1

for l ≥ 0 as n → ∞. For the first part, we have
Z
ML
l
ML
m
E[Vi |Xi = x]pM L (x; δ)l 1{pM L (x; δ) ∈ (0, 1)}m fX (x)dx.
E[Vi p (Xi ; δ) 1{p (Xi ; δ) ∈ (0, 1)} ] =
X

Suppose M L is continuous at x and M L(x) ∈ (0, 1). Then limδ→0 pM L (x; δ) = M L(x) by
Part 1 of Corollary 2, and hence pM L (x; δ) ∈ (0, 1) for sufficiently small δ > 0. It follows that
1{pM L (x; δ) ∈ (0, 1)} → 1 = 1{M L(x) ∈ (0, 1)} as δ → 0. Suppose x ∈ int(X0 ) ∪ int(X1 ). Then
B(x, δ) ⊂ X0 or B(x, δ) ⊂ X1 for sufficiently small δ > 0 by the fact that int(X0 ) and int(X1 )
are open, and hence 1{pM L (x; δ) ∈ (0, 1)} → 0 = 1{M L(x) ∈ (0, 1)} as δ → 0. Therefore,
limδ→0 pM L (x; δ) = M L(x) and limδ→0 1{pM L (x; δ) ∈ (0, 1)} = 1{M L(x) ∈ (0, 1)} for almost
every x ∈ X , since M L is continuous at x for almost every x ∈ X by Assumption 1 (a), and
either M L(x) ∈ (0, 1) or x ∈ int(X0 ) ∪ int(X1 ) for almost every x ∈ X by Assumption 1 (b). By
the Dominated Convergence Theorem,
Z
ML
l
ML
m
E[Vi p (Xi ; δ) 1{p (Xi ; δ) ∈ (0, 1)} ] →
E[Vi |Xi = x]M L(x)l 1{M L(x) ∈ (0, 1)}m fX (x)dx
X

= E[Vi M L(Xi )l 1{M L(Xi ) ∈ (0, 1)}m ]
55

as δ → 0. As for variance,
n

Var(

1X
1
Vi pM L (Xi ; δn )l Ii,n ) ≤ E[Vi2 pM L (Xi ; δn )2l (Ii,n )2 ]
n
n
i=1

1
E[Vi2 ]
n
→0
≤

as n → ∞.
Lemma B.7. Let {(δn , Sn )}∞
n=1 be any sequence of positive numbers and positive integers. Fix
x ∈ X , and let X1∗ , ..., XS∗n be Sn independent draws from the uniform distribution on B(x, δn )
so that
Sn
1 X
M L(Xs∗ ).
ps (x; δn ) =
Sn
s=1

Then,
E[ps (x; δn ) − pM L (x; δn )] = 0,
1
E[(ps (x; δn ) − pM L (x; δn ))2 ] ≤
,
Sn
1
|E[ps (x; δn )2 − pM L (x; δn )2 ]| ≤
,
Sn
4
E[(ps (x; δn )2 − pM L (x; δn )2 )2 ] ≤
,
Sn
Pr(ps (x; δn ) ∈ {0, 1}) ≤ (1 − pM L (x; δn ))Sn + pM L (x; δn )Sn .
Moreover, for any  > 0,
E[|ps (x; δn ) − pM L (x; δn )|] ≤

1
+ ,
Sn 2

and if Sn → ∞, then
E[|ps (x; δn ) − pM L (x; δn )|] → 0
as n → ∞.
Proof. By construction, E[M L(Xs∗ )] = pM L (x; δn ), so
s

E[p (x; δn ) − p

ML

Sn
1 X
(x; δn )] = E[
M L(Xs∗ )] − pM L (x; δn )
Sn
s=1

= E[M L(Xs∗ )] − pM L (x; δn )
= 0.

56

We have
E[(ps (x; δn ) − pM L (x; δn ))2 ] = Var(ps (x; δn ))
= Var(

Sn
1 X
M L(Xs∗ ))
Sn
s=1

1
Var(M L(Xs∗ ))
=
Sn
1
≤
E[M L(Xs∗ )2 ]
Sn
1
≤
,
Sn
|E[ps (x; δn )2 − pM L (x; δn )2 ]| = |Var(ps (x; δn )) + (E[ps (x; δn )])2 − pM L (x; δn )2 |
1
≤
+ |(pM L (x; δn ))2 − pM L (x; δn )2 |
Sn
1
=
,
Sn
and
E[(ps (x; δn )2 − pM L (x; δn )2 )2 ]
= E[(ps (x; δn ) + pM L (x; δn ))2 (ps (x; δn ) − pM L (x; δn ))2 ]
≤ 4E[(ps (x; δn ) − pM L (x; δn ))2 ]
4
.
≤
Sn
Now note that we have the following bounds on Pr(M L(Xs∗ ) = 0) and Pr(M L(Xs∗ ) = 1):
0 ≤ Pr(M L(Xs∗ ) = 0) ≤ 1 − pM L (x; δn ),
0 ≤ Pr(M L(Xs∗ ) = 1) ≤ pM L (x; δn ).
It follows that
0 ≤ Pr(ps (x; δn ) ∈ {0, 1})
= Pr(M L(Xs∗ ) = 0)Sn + Pr(M L(Xs∗ ) = 1)Sn
≤ (1 − pM L (x; δn ))Sn + pM L (x; δn )Sn .
Lastly, for any  > 0,
E[|ps (x; δn ) − pM L (x; δn )|]
= E[|ps (x; δn ) − pM L (x; δn )|||ps (x; δn ) − pM L (x; δn )| ≥ ] Pr(|ps (x; δn ) − pM L (x; δn )| ≥ )
+ E[|ps (x; δn ) − pM L (x; δn )|||ps (x; δn ) − pM L (x; δn )| < ] Pr(|ps (x; δn ) − pM L (x; δn )| < )
Var(ps (x; δn ))
+·1
2
1
≤
+ ,
Sn 2
< 1·

57

where we use Chebyshev’s inequality for the first inequality. We can make E[|ps (x; δn ) −
pM L (x; δn )|] arbitrarily close to zero by taking sufficiently small  > 0 and sufficiently large
Sn , which implies that E[|ps (x; δn ) − pM L (x; δn )|] = o(1) if Sn → ∞.
s = 1{ps (X ; δ ) ∈ (0, 1)}, and let {V }∞ be i.i.d. random variables such
Lemma B.8. Let Ii,n
i n
i i=1
2
that E[Vi ] < ∞. If Assumption 1 holds, Sn → ∞, and δn → 0, then
n

n

i=1

i=1

1X
1X
s
Vi ps (Xi ; δn )l Ii,n
−
Vi pM L (Xi ; δn )l Ii,n = op (1)
n
n
for l = 0, 1, 2, 3, 4. If, in addition, Assumption 5 holds, and E[Vi |Xi ] is bounded, then
n

n

i=1

i=1

1 X
1 X
s
√
Vi ps (Xi ; δn )l Ii,n
−√
Vi pM L (Xi ; δn )l Ii,n = op (1)
n
n
for l = 0, 1, 2.
Proof. We have
n

n

i=1

i=1

1X
1X
s
Vi ps (Xi ; δn )l Ii,n
−
Vi pM L (Xi ; δn )l Ii,n
n
n
n
n
1X
1X
s
=
Vi ps (Xi ; δn )l (Ii,n
− Ii,n ) +
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n .
n
n
i=1

We first consider

i=1

1
n

Pn

s
l
i=1 Vi (p (Xi ; δn )

− pM L (Xi ; δn )l )Ii,n . By Lemma B.7, for l = 0, 1, 2,

n

|E[

1X
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n ]|
n
i=1
s

= |E[Vi (p (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n ]|
= E[|E[Vi |Xi ]||E[ps (Xi ; δn )l − pM L (Xi ; δn )l |Xi ]|Ii,n ]
1
≤
E[|E[Vi |Xi ]|Ii,n ]
Sn
= O(Sn−1 ).
Also, by Lemma B.7,
n

|E[

1X
Vi (ps (Xi ; δn )3 − pM L (Xi ; δn )3 )Ii,n ]|
n
i=1
s

= |E[Vi (p (Xi ; δn ) − pM L (Xi ; δn ))(ps (Xi ; δn )2 + ps (Xi ; δn )pM L (Xi ; δn ) + pM L (Xi ; δn )2 )Ii,n ]|
≤ E[|E[Vi |Xi ]||E[(ps (Xi ; δn ) − pM L (Xi ; δn ))(ps (Xi ; δn )2 + ps (Xi ; δn )pM L (Xi ; δn ) + pM L (Xi ; δn )2 )|Xi ]|Ii,n ]
≤ 3E[|E[Vi |Xi ]|E[|ps (Xi ; δn ) − pM L (Xi ; δn )||Xi ]Ii,n ]
= o(1),
58

and
n

1X
|E[
Vi (ps (Xi ; δn )4 − pM L (Xi ; δn )4 )Ii,n ]|
n
i=1
s

= |E[Vi (p (Xi ; δn )2 + pM L (Xi ; δn )2 )(ps (Xi ; δn ) + pM L (Xi ; δn ))(ps (Xi ; δn ) − pM L (Xi ; δn ))Ii,n ]|
≤ E[|E[Vi |Xi ]||E[(ps (Xi ; δn )2 + pM L (Xi ; δn )2 )(ps (Xi ; δn ) + pM L (Xi ; δn ))(ps (Xi ; δn ) − pM L (Xi ; δn ))|Xi ]|Ii,n ]
≤ 4E[|E[Vi |Xi ]|E[|ps (Xi ; δn ) − pM L (Xi ; δn )||Xi ]Ii,n ]
= o(1).
As for variance, for l = 0, 1, 2,
n

Var(

1X
1
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n ) ≤ E[Vi2 (ps (Xi ; δn )l − pM L (Xi ; δn )l )2 Ii,n ]
n
n
i=1

1
E[E[Vi2 |Xi ]E[(ps (Xi ; δn )l − pM L (Xi ; δn )l )2 |Xi ]Ii,n ]
n
4
E[E[Vi2 |Xi ]Ii,n ]
≤
nSn
= O((nSn )−1 ),
≤

and for l = 3, 4,
n

Var(

1X
1
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n ) ≤ E[Vi2 (ps (Xi ; δn )l − pM L (Xi ; δn )l )2 Ii,n ]
n
n
i=1

1
E[Vi2 Ii,n ]
n
= o(1).

≤

P
Therefore, n1 ni=1 Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii,n = op (1) if Sn → ∞ for l = 0, 1, 2, 3, 4, and
Pn
s
l
M L (X ; δ )l )I
−1/2 S → ∞ for l = 0, 1, 2.
√1
i n
i,n = op (1) if n
n
i=1 Vi (p (Xi ; δn ) − p
n
P
n
1
s
l
s
We next show that n i=1 Vi p (Xi ; δn ) (Ii,n − Ii,n ) = op (1) if Sn → ∞ and δn → 0 for l ≥ 0.
We have
n

|E[

1X
s
s
Vi ps (Xi ; δn )l (Ii,n
− Ii,n )]| = |E[Vi ps (Xi ; δn )l (Ii,n
− Ii,n )]|
n
i=1

s
≤ E[|E[Vi |Xi ]||E[ps (Xi ; δn )l (Ii,n
− Ii,n )|Xi ]|]
s
≤ E[|E[Vi |Xi ]|E[|Ii,n
− Ii,n ||Xi ]].

Note that by construction, 1{ps (Xi ; δn ) ∈ (0, 1)} ≤ 1{pM L (Xi ; δn ) ∈ (0, 1)} with probability one
conditional on Xi = x, so that
s
s
E[|Ii,n
− Ii,n ||Xi = x] = −E[Ii,n
− Ii,n |Xi = x].

Suppose M L is continuous at x and M L(x) ∈ (0, 1). Then limδ→0 pM L (x; δ) = M L(x) ∈ (0, 1)
by Part 1 of Corollary 2, and hence pM L (x; δn ) ∈ [, 1 − ] for sufficiently small δn > 0 for some
59

constant  ∈ (0, 1/2). It follows that
s
E[Ii,n
|Xi = x] = 1 − Pr(ps (x; δn ) ∈ {0, 1})

≥ 1 − (1 − pM L (x; δn ))Sn − pM L (x; δn )Sn
≥ 1 − 2(1 − )Sn
→1
s −
as Sn → ∞, where the first inequality follows from Lemma B.7. This implies that E[Ii,n
Ii,n |Xi = x] → 0 as n → ∞. Suppose x ∈ int(X0 )∪int(X1 ). Then B(x, δn ) ⊂ X0 or B(x, δn ) ⊂ X1
for sufficiently small δn > 0 by the fact that int(X0 ) and int(X1 ) are open, and hence pM L (x; δn ) ∈
s − I |X = x] → 0 as
{0, 1} and ps (x; δn ) ∈ {0, 1} for sufficiently small δn > 0, so that E[Ii,n
i,n
i
s
n → ∞. Therefore, E[Ii,n − Ii,n |Xi = x] → 0 for almost every x ∈ X , since M L is continuous at
x for almost every x ∈ X by Assumption 1 (a), and either M L(x) ∈ (0, 1) or x ∈ int(X0 )∪int(X1 )
for almost every x ∈ X by Assumption 1 (b). By the Dominated Convergence Theorem,
s
−E[|E[Vi |Xi ]|E[Ii,n
− Ii,n |Xi ]] → 0

as n → ∞.
As for variance,
n

Var(

1
1X
s
s
Vi ps (Xi ; δn )l (Ii,n
− Ii,n )) ≤ E[Vi2 ps (Xi ; δn )2l (Ii,n
− Ii,n )2 ]
n
n
i=1

1
E[Vi2 ]
n
→ 0.
≤

Lastly, we show that, for l ≥ 0,
holds, and E[Vi |Xi ] is bounded. Let
We have

√1
n

Pn

s
l s
i=1 Vi p (Xi ; δn ) (Ii,n − Ii,n )
n
ηn = γ log
Sn , where γ is the one

= op (1) if Assumption 5
satisfying Assumption 5.

n

1 X
s
|E[ √
Vi ps (Xi ; δn )l (Ii,n
− Ii,n )]|
n
i=1
√
s
− Ii,n ||Xi ]]
≤ nE[|E[Vi |Xi ]|E[|Ii,n
√
s
= − nE[|E[Vi |Xi ]|E[Ii,n − 1|Xi ]Ii,n ]
√
≤ nE[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn ))Ii,n ]
√
= nE[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn ))1{pM L (Xi ; δn ) ∈ (0, ηn ) ∪ (1 − ηn , 1)}]
√
+ nE[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn ))1{pM L (Xi ; δn ) ∈ [ηn , 1 − ηn ]}]
√
√
≤ (sup |E[Vi |Xi = x]|)( n Pr(pM L (Xi ; δn ) ∈ (0, ηn ) ∪ (1 − ηn , 1)) + 2 n(1 − ηn )Sn ),
x∈X
s ≤ I
where the second equality follows from the fact that Ii,n
i,n with strict inequality only if
√
√
M
L
Ii,n = 1. By Assumption 5, n Pr(p (Xi ; δn ) ∈ (0, ηn )∪(1−ηn , 1)) = o(1). As for n(1−ηn )Sn ,
n
log n
1
−1/2 S → ∞ and log n → 0. Using the
first observe that ηn = γ log
n
Sn = γ n1/2 n−1/2 S → 0, since n
n1/2
n

60

fact that et ≥ 1 + t for every t ∈ R, we have
√
√
n(1 − ηn )Sn ≤ n(e−ηn )Sn
√
= ne−ηn Sn
√
= ne−γ log n
√
= nn−γ
= n1/2−γ
→ 0,
since γ > 1/2. As for variance,
n

1 X
s
s
Var( √
Vi ps (Xi ; δn )l (Ii,n
− Ii,n )) ≤ E[Vi2 ps (Xi ; δn )2l (Ii,n
− Ii,n )2 ]
n
i=1

s
≤ E[Vi2 |Ii,n
− Ii,n |]
s
= E[E[Vi2 |Xi ]E[|Ii,n
− Ii,n ||Xi ]]

= o(1).

C
C.1

Proofs
Proof of Proposition 1

Suppose that Assumptions 1 and 2 hold. Here, we only show that
(a) E[Y1i − Y0i |Xi = x] is identified for every x ∈ int(X ) such that pM L (x) ∈ (0, 1).
(b) Let A be any open subset of X such that pM L (x) exists for all x ∈ A. Then E[Y1i −Y0i |Xi ∈
A] is identified only if pM L (x) ∈ (0, 1) for almost every x ∈ A.
The results for E[Di (1) − Di (0)|Xi = x] and E[Di (1) − Di (0)|Xi ∈ A] are obtained by a similar
argument.
Proof of Part (a). Pick an x ∈ int(X ) such that pM L (x) ∈ (0, 1). If M L(x) ∈ (0, 1),
E[Y1i − Y0i |Xi = x] and E[Di (1) − Di (0)|Xi = x] are trivially identified by Property 1:
E[Yi |Xi = x, Zi = 1] − E[Yi |Xi = x, Zi = 0] = E[Y1i − Y0i |Xi = x].
We next consider the case where M L(x) ∈ {0, 1}. Since x ∈ int(X ), B(x, δ) ⊂ X for any
sufficiently small δ > 0. Moreover, since pM L (x) = limδ→0 pM L (x; δ) ∈ (0, 1), pM L (x; δ) ∈ (0, 1)
for any sufficiently small δ > 0. This implies that we can find points x0,δ , x1,δ ∈ B(x, δ)(⊂ X )
such that M L(x0,δ ) < 1 and M L(x1,δ ) > 0 for any sufficiently small δ > 0, for otherwise
pM L (x; δ) ∈ {0, 1}. Noting that x0,δ → x and x1,δ → x as δ → 0,
lim (E[Yi |Xi = x1,δ , Zi = 1] − E[Yi |Xi = x0,δ , Zi = 0]) = lim (E[Yi1 |Xi = x1,δ ] − E[Yi0 |Xi = x0,δ ])

δ→0

δ→0

= E[Y1i − Y0i |Xi = x],
61

where the first equality follows from Property 1, and the second from Assumption 2.
Proof of Part (b).
Suppose to the contrary that Lp ({x ∈ A : pM L (x) ∈ {0, 1}}) > 0. Without loss of generality,
assume Lp ({x ∈ A : pM L (x) = 1}) > 0. The proof proceeds in four steps.
Step C.1.1. Lp (A ∩ X1 ) > 0.
Proof. By Assumption 1, M L is continuous almost everywhere. Part 1 of Cororally 2 then
implies that pM L (x) = M L(x) for almost every x ∈ {x∗ ∈ A : pM L (x∗ ) = 1}. Since Lp ({x ∈ A :
pM L (x) = 1}) > 0, Lp ({x ∈ A : pM L (x) = 1, pM L (x) = M L(x)}) > 0, and hence Lp (A ∩ X1 ) >
0.
Step C.1.2. A ∩ int(X1 ) 6= ∅.
Proof. Suppose that A ∩ int(X1 ) = ∅. Then, we must have that A ∩ X1 ⊂ X1 \ int(X1 ). It then
follows that Lp (A ∩ X1 ) ≤ Lp (X1 \ int(X1 )) = Lp (X1 ) − Lp (int(X1 )) = 0, where the last equality
holds by Assumption 1. But this is a contradiction to the result from Step C.1.1.
Step C.1.3. pM L (x) = 1 for any x ∈ int(X1 ).
Proof. Pick any x ∈ int(X1 ). By the definition of interior, B(x, δ) ⊂ X1 for any sufficiently small
δ > 0. Therefore, pM L (x; δ) = 1 for any sufficiently small δ > 0.
Step C.1.4. E[Y1i − Y0i |Xi ∈ A] is not identified.
Proof. We first introduce some notation. Let Q be the set of all distributions of (Y1i , Y0i , Xi , Zi )
satisfying Property 1 and Assumptions 1 and 2. Let P be the set of all distributions of (Yi , Xi , Zi ).
Let T : Q → P be a function such that, for Q ∈ Q, T (Q) is the distribution of (Zi Y1i + (1 −
Zi )Y0i , Xi , Zi ), where the distribution of (Y1i , Y0i , Xi , Zi ) is Q. Let Q0 and P0 denote the true
distributions of (Y1i , Y0i , Xi , Zi ) and (Yi , Xi , Zi ), respectively. Given P0 , the identified set of
E[Y1i − Y0i |Xi ∈ A] is given by {EQ [Y1i − Y0i |Xi ∈ A] : P0 = T (Q), Q ∈ Q}, where EQ [·] is the
expectation operator under distribution Q. We show that this set contains two distinct values.
In what follows, Pr(·) and E[·] without a subscript denote the probability and expectation under
the true distributions Q0 and P0 as up until now.
Now pick any x∗ ∈ A ∩ int(X1 ). Since A and int(X1 ) are open, there is some δ > 0 such
that B(x∗ , δ) ⊂ A ∩ int(X1 ). Let  = 2δ , and consider a function f : X → R such that f (x) =
E[Y0i |X = x] for all x ∈ X \ B(x∗ , ) and f (x) = E[Y0i |X = x] − 1 for all x ∈ B(x∗ , ). Below,
we show that f is continuous at any point x ∈ X such that pM L (x) ∈ (0, 1) and M L(x) ∈ {0, 1}.
Pick any x ∈ X such that pM L (x) ∈ (0, 1) and M L(x) ∈ {0, 1}. Since B(x∗ , δ) ⊂ int(X1 ) and
int(X1 ) ⊂ {x0 ∈ X : pM L (x0 ) = 1} by Step C.1.3, x ∈
/ B(x∗ , δ). Hence, B(x, ) ⊂ X \ B(x∗ , ).
By Assumption 2 and the definition of f , f is continuous at x.
Now take any random vector (Y1i∗ , Y0i∗ , Xi∗ , Zi∗ ) that is distributed according to the true distribution Q0 . Let Q be the distribution of (Y1iQ , Y0iQ , XiQ , ZiQ ), where (Y1iQ , XiQ , ZiQ ) = (Y1i∗ , Xi∗ , Zi∗ ),
and
(
if Xi∗ ∈ X \ B(x∗ , )
Y0i∗
Q
Y0i =
Y0i∗ − 1
if Xi∗ ∈ B(x∗ , )
62

Note first that Q ∈ Q, since EQ [Y1iQ |XiQ = x] = E[Y1i∗ |Xi∗ = x] and EQ [Y0iQ |XiQ = x] = f (x),
where E[Y1i∗ |Xi∗ ] and f are both continuous at any point x ∈ X such that pM L (x) ∈ (0, 1) and
M L(x) ∈ {0, 1}. Also, ZiQ = Zi∗ = 1 if Xi∗ ∈ B(x∗ , ). It then follows that
YiQ = ZiQ Y1iQ + (1 − ZiQ )Y0iQ
(
Zi∗ Y1i∗ + (1 − Zi∗ )Y0i∗
=
Zi∗ Y1i∗

if Xi∗ ∈ X \ B(x∗ , )

Yi∗ = Zi∗ Y1i∗ + (1 − Zi∗ )Y0i∗
(
Zi∗ Y1i∗ + (1 − Zi∗ )Y0i∗
=
Zi∗ Y1i∗

if Xi∗ ∈ X \ B(x∗ , )

if Xi∗ ∈ B(x∗ , )

and

if Xi∗ ∈ B(x∗ , ).

Thus, YiQ = Yi∗ , and hence T (Q) = T (Q0 ) = P0 .
Using EQ [Y1iQ |XiQ = x] = E[Y1i∗ |Xi∗ = x] and EQ [Y0iQ |XiQ = x] = f (x), we have
EQ [Y1iQ − Y0iQ |XiQ ∈ A]
= EQ [EQ [Y1iQ |XiQ ]|XiQ ∈ A]
− EQ [EQ [Y0iQ |XiQ ]|XiQ ∈ A, XiQ ∈
/ B(x∗ , )]PrQ (XiQ ∈
/ B(x∗ , )|XiQ ∈ A)
− EQ [EQ [Y0iQ |XiQ ]|XiQ ∈ B(x∗ , )]PrQ (XiQ ∈ B(x∗ , )|XiQ ∈ A)
= E[E[Y1i∗ |Xi∗ ]|Xi∗ ∈ A] − E[f (Xi∗ )|Xi∗ ∈ A, Xi∗ ∈
/ B(x∗ , )] Pr(Xi∗ ∈
/ B(x∗ , )|Xi∗ ∈ A)
− E[f (Xi∗ )|Xi∗ ∈ B(x∗ , )] Pr(Xi∗ ∈ B(x∗ , )|Xi∗ ∈ A)
= E[Y1i∗ |Xi∗ ∈ A] − E[Y0i∗ |Xi∗ ∈ A, Xi∗ ∈
/ B(x∗ , )] Pr(Xi∗ ∈
/ B(x∗ , )|Xi∗ ∈ A)
− E[Y0i∗ − 1|Xi∗ ∈ B(x∗ , )] Pr(Xi∗ ∈ B(x∗ , )|Xi∗ ∈ A)
= E[Y1i∗ − Y0i∗ |Xi∗ ∈ A] + Pr(Xi∗ ∈ B(x∗ , )|Xi∗ ∈ A).
By the definition of support, Pr(Xi∗ ∈ B(x∗ , )) > 0. Since T (Q) = T (Q0 ) = P0 but EQ [Y1iQ −
Y0iQ |XiQ ∈ A] 6= E[Y1i∗ − Y0i∗ |Xi∗ ∈ A], E[Y1i − Y0i |Xi ∈ A] is not identified.

C.2

Proof of Corollary 1

If Pr(Di (1) − Di (0) = 1|Xi = x) = 1, Pr(Y1i − Y0i = Yi (1) − Yi (0)|Xi = x) = 1, and hence
E[Y1i − Y0i |Xi = x] = E[Yi (1) − Yi (0)|Xi = x]. Then, Parts (a) and (b) follow from Proposition
1. If Pr(Di (1) ≥ Di (0)|Xi = x) = 1, we have
E[Y1i − Y0i |Xi = x] = E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x]
= Pr(Di (1) 6= Di (0)|Xi = x)E[Yi (1) − Yi (0)|Di (1) 6= Di (0), Xi = x].
63

If in addition Pr(Di (1) 6= Di (0)|Xi = x) > 0, we obtain
E[Y1i − Y0i |Xi = x]
Pr(Di (1) 6= Di (0)|Xi = x)
E[Y1i − Y0i |Xi = x]
=
.
E[Di (1) − Di (0)|Xi = x]

E[Yi (1) − Yi (0)|Di (1) 6= Di (0), Xi = x] =

Then, Part (c) follows from Proposition 1 (a). Part (d) is established by following the procedure
used to show Proposition 1 (b).

C.3

Proof of Proposition 2

With change of variables u =
R

x∗ −x
δ ,

B(x,δ) M L(x

pM L (x; δ) =

R
R
p

δ
=

∗

B(0,1) M L(x + δu)du
R
δ p B(0,1) du

∪q∈Q Ux,q

M L(x + δu)du +
R

R
B(0,1)\∪q∈Q Ux,q

M L(x + δu)du

B(0,1) du

P
=

∗ )dx∗

B(x,δ) dx

R
=

we have

R

q∈Q Ux,q

M L(x + δu)du
,

R

B(0,1) du

where the last equality follows from the assumption that Lp (∪q∈Q Ux,q ) = Lp (B(0, 1)). By the
definition of Ux,q , for each q ∈ Q, limδ→0 M L(x + δu) = q for any u ∈ Ux,q . By the Dominated
Convergence Theorem,
pM L (x) = lim pM L (x; δ)
δ→0
P
p
q∈Q qL (Ux,q )
.
=
Lp (B(0, 1))
P
The numerator exists, since q ≤ 1 for all q ∈ Q and q∈Q Lp (Ux,q ) = Lp (B(0, 1)).

C.4

Proof of Corollary 2

1. Suppose that M L is continuous at x ∈ X , and let q = M L(x). Then, by definition,
Ux,q = B(0, 1). By Proposition 2, pM L (x) exists, and pM L (x) = q.
2. Pick any x ∈ int(Xq ). M L is continuous at x, since there exists δ > 0 such that B(x, δ) ⊂ Xq
by the definition of interior. By the previous result, pM L (x) exists, and pM L (x) = q.
3. Let N be the neighborhood of x on which f is continuously differentiable. By the mean
value theorem, for any sufficiently small δ > 0,
f (x + δu) = f (x) + ∇f (x̃δ ) · δu
= ∇f (x̃δ ) · δu
64

for some x̃δ which is on the line segment connecting x and x + δu. Since x̃δ → x as δ → 0
and ∇f is continuous on N , ∇f (x̃δ ) · u → ∇f (x) · u as δ → 0. Therefore, if ∇f (x) · u > 0,
then f (x + δu) = ∇f (x̃δ ) · δu > 0 for any sufficiently small δ > 0, and if ∇f (x) · u < 0,
then f (x + δu) = ∇f (x̃δ ) · δu < 0 for any sufficiently small δ > 0. We then have
Ux+ ≡ {u ∈ B(0, 1) : ∇f (x) · u > 0} ⊂ Ux,q1
Ux− ≡ {u ∈ B(0, 1) : ∇f (x) · u < 0} ⊂ Ux,q2 .
Let V be the Lebesgue measure of a half p-dimensional unit ball. Since V = Lp (Ux+ ) ≤
Lp (Ux,q1 ), V = Lp (Ux− ) ≤ Lp (Ux,q2 ), and Lp (Ux,q1 ) + Lp (Ux,q2 ) ≤ Lp (B(0, 1)) = 2V , it
follows that Lp (Ux,q1 ) = Lp (Ux,q2 ) = V . By Proposition 2, pM L (x) exists, and pM L (x) =
1
2 (q1 + q2 ).
4. We have that U0,q1 = {(u1 , u2 )0 ∈ B(0, 1) : u1 ≤ 0 or u2 ≤ 0} and U0,q2 = {(u1 , u2 )0 ∈
B(0, 1) : u1 > 0, u2 > 0}. By Proposition 2, pM L (x) exists, and pM L (x) =
3
4 q1

C.5

+

q1 L2 (U0,q1 )+q2 L2 (U0,q2 )
L2 (B(0,1))

1
4 q2 .

Proof of Proposition A.1

Since M L is a Lp -measurable and bounded function, M L is locally integrable with respect to
R
the Lebesgue measure, i.e., for every ball B ⊂ Rp , B M L(x)dx exists. An application of the
Lebesgue differentiation theorem (see e.g. Theorem 1.4 in Chapter 3 of Stein and Shakarchi
(2005)) to the function M L shows that
R
∗
∗
B(x,δ) M L(x )dx
R
lim
= M L(x)
∗
δ→0
B(x,δ) dx
for almost every x ∈ Rp .

C.6

Proof of Theorem 1

We prove consistency and asymptotic normality of the following estimators without imposing
Assumption 3 (c). These estimators are aymptotically equivalent to the estimators defined in
Section 4.1 if Assumption 3 (c) holds.
First, consider the following 2SLS regression using the observations with pM L (Xi ; δn ) ∈ (0, 1):
Di = γ0 (1 − In ) + γ1 Zi + γ2 pM L (Xi ; δn ) + νi

(15)

Yi = β0 (1 − In ) + β1 Di + β2 pM L (Xi ; δn ) + i .

(16)

Here In is a dummy random variable which equals one if there exists a constant q ∈ (0, 1)
such that M L(Xi ) ∈ {0, q, 1} for all i ∈ {1, ..., n}. In is the indicator that M L(Xi ) takes
on only one nondegenerate value in the sample. If the support of M L(Xi ) (in the population) contains only one value in (0, 1), pM L (Xi ; δn ) is asymptotically constant conditional on
pM L (Xi ; δn ) ∈ (0, 1). To avoid the multicollinearity between asymptotically constant pM L (Xi ; δn )
and a constant, we do not include the constant term if In = 1. Let Ii,n = 1{pM L (Xi ; δn ) ∈ (0, 1)},
65

=

M L (X ; δ ))0 , and Znc =
Di,n = (1, Di , pM L (Xi ; δn ))0 , Zi,n = (1, Zi , pM L (Xi ; δn ))0 , Dnc
i n
i,n = (Di , p
i,n
M
L
0
(Zi , p (Xi ; δn )) . The 2SLS estimator β̂ from this regression is then given by
(P
P
( ni=1 Zi,n D0i,n Ii,n )−1 ni=1 Zi,n Yi Ii,n
if In =0
β̂ = Pn
Pn
nc
nc
0
−1
nc
( i=1 Zi,n (Di,n ) Ii,n )
if In =1.
i=1 Zi,n Yi Ii,n

Let β̂1 denote the 2SLS estimator of β1 in the above regression.
Similarly, consider the following simulation version of the 2SLS regression using the observations with ps (Xi ; δn ) ∈ (0, 1):
(17)

Di = γ0 (1 − In ) + γ1 Zi + γ2 ps (Xi ; δn ) + νi

(18)

s

Yi = β0 (1 − In ) + β1 Di + β2 p (Xi ; δn ) + i .
Let β̂1s denote the 2SLS estimator of β1 in the simulation-based regression.
Below, we prove the following result.

Theorem C.1. Suppose that Assumptions 1 and 3 hold except Assumption 3 (c), and that
δn → 0, nδn → ∞ and Sn → ∞ as n → ∞. Then the 2SLS estimators β̂1 and β̂1s converge in
probability to
β1 ≡ lim E[ωi (δ)(Yi (1) − Yi (0))],
δ→0

where
ωi (δ) =

pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))
.
E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))]

Suppose, in addition, that Assumptions 4 and 5 hold and that nδn2 → 0 as n → ∞. Then
d

σ̂n−1 (β̂1 − β1 ) −→ N (0, 1),
d

(σ̂ns )−1 (β̂1s − β1 ) −→ N (0, 1).
where we define σ̂n−1 and (σ̂ns )−1 as follows: let
(P
P
P
( ni=1 Zi,n D0i,n Ii,n )−1 ( ni=1 ˆ2i,n Zi,n Z0i,n Ii,n )( ni=1 Di,n Z0i,n Ii,n )−1
Σ̂n = Pn
P
Pn 2 nc nc 0
nc 0
−1
nc 0
−1
ˆi,n Zi,n (Zi,n ) Ii,n )( ni=1 Dnc
( i=1 Znc
i,n (Zi,n ) Ii,n )
i,n (Di,n ) Ii,n ) ( i=1 

if In = 0
if In = 1,

where
ˆi,n =

(
Yi − D0i,n β̂
0
Yi − (Dnc
i,n ) β̂

if In = 0
if In = 1.

Let σ̂n2 denote the estimator for the variance of β̂1 . That is, σ̂n2 is the second diagonal element of
Σ̂n when In = 0 and is the first diagonal element of Σ̂n when In = 1. (σ̂ns )2 is the analogouslydefined estimator for the variance of β̂1s from the simulation-based regression.
Throughout the proof, we omit the subscript n from Ii,n , Di,n , Zi,n , ˆi,n , Σ̂n , σ̂n , etc.
for notational brevity. We provide proofs separately for the two cases, the case in which
Pr(M L(Xi ) ∈ (0, 1)) > 0 and the case in which Pr(M L(Xi ) ∈ (0, 1)) = 0. For each case, we first
prove consistency and asymptotic normality of β̂1 , and then prove consistency and asymptotic
normality of β̂1s .
66

C.6.1

Consistency and Asymptotic Normality of β̂1 When Pr(M L(Xi ) ∈ (0, 1)) > 0

By Lemma B.6,
lim E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))] = E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))].

δ→0

When Pr(M L(Xi ) ∈ (0, 1)) > 0, E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))] = E[pM L (Xi )(1 −
pM L (Xi ))(Di (1) − Di (0))], since pM L (x) = M L(x) for almost every x ∈ X by Proposition A.1.
Under Assumption 3 (b), E[pM L (Xi )(1 − pM L (Xi ))(Di (1) − Di (0))] > 0. Again by Lemma B.6,
lim E[ωi (δ)(Yi (1) − Yi (0))] =

δ→0

Let β1 =

E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))(Yi (1) − Yi (0)]
.
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

E[M L(Xi )(1−M L(Xi ))(Di (1)−Di (0))(Yi (1)−Yi (0)]
.
E[M L(Xi )(1−M L(Xi ))(Di (1)−Di (0))]

Let

n
n
X
X
0
−1
β̂ = (
Zi D i I i )
Zi Yi Ii
c

i=1

β̂ nc

i=1

n
n
X
X
nc
nc 0
−1
=(
Zi (Di ) Ii )
Znc
i Yi Ii ,
i=1

i=1

and let β̂1c = (0, 1, 0)β̂ c and β̂1nc = (1, 0)β̂ nc . β̂1 is given by
β̂1 = β̂1c (1 − In ) + β̂1nc In .
0
nc
0
Also, let D̃i = (1, Di , M L(Xi ))0 , Z̃i = (1, Zi , M L(Xi ))0 , D̃nc
i = (Di , M L(Xi )) , Z̃i = (Zi , M L(Xi )) ,
M
L
and Ii = 1{M L(Xi ) ∈ (0, 1)}.
We claim that Pr(In = 1) → 0 when Var(M L(Xi )|IiM L = 1) > 0, and that Pr(In = 1) → 1
when Var(M L(Xi )|IiM L = 1) = 0. To show the first claim, observe that In = 1 if and only if
V̂n = 0, where
Pn
Pn
M L(Xi )IiM L 2 M L
i=1
Pn
) Ii
ML
i=1 (M L(Xi ) −
i=1 Ii
Pn
V̂n =
ML
i=1 Ii

is the sample variance of M L(Xi ) conditional on IiM L = 1. When Var(M L(Xi )|IiM L = 1) > 0,
Pr(In = 1) = Pr(V̂n = 0)
≤ Pr(|V̂n − Var(M L(Xi )|IiM L = 1)| ≥ Var(M L(Xi )|IiM L = 1))
→ 0,
p

where the convergence follows since V̂n −→ Var(M L(Xi )|IiM L = 1) > 0.
To show the second claim, note that, when Var(M L(Xi )|IiM L = 1) = 0, there exists q ∈ (0, 1)
such that Pr(M L(Xi ) = q|IiM L = 1) = 1. It follows that
Pr(In = 0) = Pr(M L(Xi ) ∈ {0, 1} for all i = 1, ..., n)
+ Pr(M L(Xi ) = q 0 and M L(Xj ) = q 00 for some q 0 , q 00 ∈ (0, 1) with q 0 6= q 00
for some i, j ∈ {1, ..., n})
= Pr(M L(Xi ) ∈ {0, 1} for all i = 1, ..., n)
= (1 − Pr(M L(Xi ) ∈ (0, 1)))n ,
67

which converges to zero as n → ∞, since Pr(M L(Xi ) ∈ (0, 1)) > 0.
The above claims imply that β̂1 = β̂1c with probability approaching one when Var(M L(Xi )|IiM L =
1) > 0, and that β̂1 = β̂1nc with probability approaching one when Var(M L(Xi )|IiM L = 1) = 0.
Therefore, to prove consistency and asymptotic normality of β̂1 , it suffices to show those of β̂1c
when Var(M L(Xi )|IiM L = 1) > 0 and those of β̂1nc when Var(M L(Xi )|IiM L = 1) = 0.
Below we first show that, if Assumptions 1 and 3 hold and δn → 0 as n → ∞, then
p
β̂1 −→ β1 . We then show that, if, in addition, Assumption 4 holds and nδn2 → 0 as n → ∞, then
d

σ̂ −1 (β̂1 − β1 ) −→ N (0, 1).
p

Proof of Consistency. To prove consistency of β̂1 , we first show that β̂1c −→ β1 when
p
Var(M L(Xi )|IiM L = 1) > 0. We then show that β̂1nc −→ β1 whether or not Var(M L(Xi )|IiM L =
1) > 0. By Lemma B.6,
n
n
X
X
p
β̂ c = (
Zi D0i Ii )−1
Zi Yi Ii −→ (E[Z̃i D̃0i IiM L ])−1 E[Z̃i Yi IiM L ]
i=1

i=1

provided that E[Z̃i D̃0i IiM L ] is invertible. After a few lines of algebra, we have
det(E[Z̃i D̃0i IiM L ])
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[Di (Zi − M L(Xi ))IiM L ]
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[(Zi Di (1) + (1 − Zi )Di (0))(Zi − M L(Xi ))IiM L ]
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[((Zi − Zi M L(Xi ))Di (1) − (1 − Zi )M L(Xi )Di (0))IiM L ]
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[((M L(Xi ) − M L(Xi )2 )Di (1) − (1 − M L(Xi ))M L(Xi )Di (0))IiM L ]
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))IiM L ]
= Pr(IiM L = 1)2 Var(M L(Xi )|IiM L = 1)E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))],
where the fourth equality follows from Property 1. Therefore, E[Z̃i D̃0i IiM L ]
Var(M L(Xi )|IiM L = 1) > 0. Another few lines of algebra gives

∗
1

0 M L −1
(E[Z̃i D̃i Ii ]) =
0
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
∗

68

is invertible when

∗ ∗

1 −1
∗ ∗

when Var(M L(Xi )|IiM L = 1) > 0. Therefore, when Var(M L(Xi )|IiM L = 1) > 0,
E[Zi Yi IiM L ] − E[M L(Xi )Yi IiM L ]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[Zi Y1i IiM L ] − E[M L(Xi )(Zi Y1i + (1 − Zi )Y0i )IiM L ]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[M L(Xi )Y1i IiM L ] − E[M L(Xi )(M L(Xi )Y1i + (1 − M L(Xi ))Y0i )IiM L ]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[M L(Xi )(1 − M L(Xi ))(Y1i − Y0i )IiM L ]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[M L(Xi )(1 − M L(Xi ))((Di (1) − Di (0))(Yi (1) − Yi (0))]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

p

β̂1c −→
=
=
=
=

= β1 ,
where the third line follows from Property 1, and the second last follows from the definitions of
Y1i and Y0i .
We next consider β̂1nc . By Lemma B.6,
β̂

nc

n
n
X
X
p
nc
nc 0
−1
nc
nc 0 M L −1
ML
=(
Zi (Di ) Ii )
Znc
]) E[Z̃nc
]
i Yi Ii −→ (E[Z̃i (D̃i ) Ii
i Yi Ii
i=1

i=1

nc 0 M L ] is invertible. After a few lines of algebra, we have
provided that E[Z̃nc
i (D̃i ) Ii
nc 0 M L
det(E[Z̃nc
]) = E[M L(Xi )2 IiM L ]E[Di (Zi − M L(Xi ))IiM L ]
i (D̃i ) Ii

= E[M L(Xi )2 IiM L ]E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
> 0.
Another few lines of algebra gives
nc 0 M L −1
(E[Z̃nc
])
i (D̃i ) Ii

"
#
1
1 −1
.
=
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))] ∗ ∗

Therefore,
p

β̂1nc −→

E[Zi Yi IiM L ] − E[M L(Xi )Yi IiM L ]
= β1 .
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

Proof of Asymptotic Normality. Let (σ̂ c )2 be the second diagonal element of
n
n
n
X
X
X
Σ̂c = (
Zi D0i Ii )−1 (
ˆ2i Zi Z0i Ii )(
Di Z0i Ii )−1
i=1

and

(σ̂ nc )2

i=1

i=1

be the first diagonal element of
nc

Σ̂

n
n
n
X
X
X
nc
nc 0
−1
2
nc
nc 0
nc 0
−1
=(
Zi,n (Di,n ) Ii ) (
ˆi,n Zi,n (Zi,n ) Ii )(
Dnc
i,n (Zi,n ) Ii ) .
i=1

i=1

i=1

69

d

We only show that (σ̂ c )−1 (β̂1c − β1 ) −→ N (0, 1) when Var(M L(Xi )|IiM L = 1) > 0. We can show
d

that (σ̂ nc )−1 (β̂1nc − β1 ) −→ N (0, 1) by an analogous argument. The proof proceeds in six steps.
Step C.6.1.1. Let β̃n = (E[Z̃i D̃0i Ii ])−1 E[Z̃i Yi Ii ], and let β̃1,n denote the second element of β̃n .
Then β̃1,n = β1 for any choice of δn > 0.
Proof. Note first that, for every δ > 0, pM L (x; δ) ∈ (0, 1) for almost every x ∈ {x0 ∈ X :
M L(x0 ) ∈ (0, 1)}, since by almost everywhere continuity of M L, for almost every x ∈ {x0 ∈ X :
M L(x0 ) ∈ (0, 1)}, there exists an open ball B ⊂ B(x, δ) such that M L(x0 ) ∈ (0, 1) for every
x0 ∈ B. After a few lines of algebra, we have
det(E[Z̃i D̃0i Ii ]) = Pr(Ii = 1)2 Var(M L(Xi )|Ii = 1)E[Di (Zi − M L(Xi ))Ii ]
= Pr(Ii = 1)2 Var(M L(Xi )|Ii = 1)E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))Ii ]
= Pr(Ii = 1)2 Var(M L(Xi )|Ii = 1)E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))],
where the last equality holds since pM L (x; δ) ∈ (0, 1) for almost every x ∈ {x0 ∈ X : M L(x0 ) ∈
(0, 1)}. By the law of total conditional variance,
Var(M L(Xi )|Ii = 1)
= E[Var(M L(Xi )|Ii = 1, IiM L )|Ii = 1] + Var(E[M L(Xi )|Ii = 1, IiM L ]|Ii = 1)
X
≥
Var(M L(Xi )|Ii = 1, IiM L = t) Pr(IiM L = t|Ii = 1)
t∈{0,1}

≥ Var(M L(Xi )|Ii = 1, IiM L = 1) Pr(IiM L = 1|Ii = 1)
= Var(M L(Xi )|IiM L = 1) Pr(IiM L = 1|Ii = 1)
> 0.
Therefore, E[Z̃i D̃0i Ii ] is invertible. Another few lines of algebra gives
(E[Z̃i D̃0i Ii ])−1


∗
1

=
0
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
∗


∗ ∗

1 −1 .
∗ ∗

It follows that
E[Zi Yi Ii ] − E[M L(Xi )Yi Ii ]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))(Yi (1) − Yi (0))Ii ]
=
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))(Yi (1) − Yi (0))]
=
E[M L(Xi )(1 − M L(Xi ))(Di (1) − Di (0))]

β̃1,n =

= β1 .

70

We can write
n
n
n
n
X
X
√
1X
1X
c
0
−1 1
0
−1 1
n(β̂ − β̃n ) = (
Zi D i I i ) √
Z̃i D̃i Ii ) √
Zi Yi Ii − (
Z̃i Yi Ii
n
n
n
n
i=1
i=1
i=1
i=1
{z
}
|
=(A)

+(

1
n

n
X
i=1

1
Z̃i D̃0i Ii )−1 √
n

n
X

√
Z̃i Yi Ii − (E[Z̃i D̃0i Ii ])−1 nE[Z̃i Yi Ii ] .

i=1

|

{z

=(B)

}

We first consider (B). Let ˜i,n = Yi − D̃0i β̃n so that
E[Z̃i ˜i,n Ii ] = E[Z̃i (Yi − D̃0i β̃n )Ii ] = E[Z̃i Yi Ii ] − E[Z̃i D̃0i Ii ]β̃n = 0.
Then
n

n

i=1

i=1

√
1X
1 X
Z̃i D̃0i Ii )−1 √
Z̃i (D̃0i β̃n + ˜i,n )Ii − (E[Z̃i D̃0i Ii ])−1 nE[Z̃i (D̃0i β̃n + ˜i,n )Ii ]
(B) = (
n
n
n
n
X
√
√
1X
0
−1 1
= n(β̃n − β̃n ) + (
Z̃i D̃i Ii ) √
Z̃i ˜i,n Ii − (E[Z̃i D̃0i Ii ])−1 nE[Z̃i ˜i,n Ii ]
n
n
i=1

i=1

n
n
X
1X
0
−1 1
=(
Z̃i D̃i Ii ) √
Z̃i ˜i,n Ii .
n
n
i=1

i=1

Step C.6.1.2.

n

1 X
d
√
Z̃i ˜i,n Ii −→ N (0, E[˜
2i Z̃i Z̃0i IiM L ]).
n
i=1

Proof. We use the triangular-array Lyapunov CLT and the Cramér-Wold device. Pick a nonzero
λ ∈ Rp , and let Vi,n = √1n λ0 Z̃i ˜i,n Ii . First, we have
n
X

2
E[Vi,n
] = λ0 E[˜
2i,n Z̃i Z̃0i Ii ]λ.

i=1

By Lemma B.6,
β̃n → (E[Z̃i D̃0i IiM L ])−1 E[Z̃i Yi IiM L ]
as n → ∞. Let β = (E[Z̃i D̃0i IiM L ])−1 E[Z̃i Yi IiM L ] and ˜i = Yi − D̃0i β. We have
E[˜
2i,n Z̃i Z̃0i Ii ] = E[(Yi − D̃0i β̃n )2 Z̃i Z̃0i Ii ]
= E[(˜
i − D̃0i (β̃n − β))2 Z̃i Z̃0i Ii ]
= E[˜
2i Z̃i Z̃0i Ii ] − 2E[˜
i ((β̃0,n − β0 ) + Di (β̃1,n − β1 ) + M L(Xi )(β̃2,n − β2 ))Z̃i Z̃0i Ii ]
+ E[((β̃0,n − β0 ) + Di (β̃1,n − β1 ) + M L(Xi )(β̃2,n − β2 ))2 Z̃i Z̃0i Ii ]
→ E[˜
2i Z̃i Z̃0i IiM L ]
71

as n → ∞, where the convergence follows from Lemma B.6 and from the fact that β̃n → β.
Therefore,
n
X
2
E[Vi,n
] → λ0 E[˜
2i Z̃i Z̃0i IiM L ]λ.
i=1

We next verify the Lyapunov condition: for some t > 0,
n
X

E[|Vi,n |2+t ] → 0.

i=1

We have
n
X

E[|Vi,n |4 ] =

i=1

1
E[|λ0 Z̃i ˜i,n Ii |4 ].
n

We use the cr -inequality: E[|X + Y |r ] ≤ 2r−1 E[|X|r + |Y |r ] for r ≥ 1. Repeating using the
cr -inequality gives
E[|λ0 Z̃i ˜i,n Ii |4 ] = E[|λ0 Z̃i (Yi − β̃0,n − β̃1,n Di − β̃2,n M L(Xi ))|4 Ii ]
≤ 23c E[(|λ0 Z̃i |4 )(|Yi |4 + |β̃0,n |4 + |β̃1,n |4 Di + |β̃2,n |4 M L(Xi )4 )Ii ]
4
4
4
≤ 23c (λ1 + λ2 + λ3 )4 (E[Yi4 ] + β̃0,n
+ β̃1,n
+ β̃2,n
)

for some finite constant c, and the right-hand side converges to
23c (λ1 + λ2 + λ3 )4 (E[Yi4 ] + β̃04 + β̃14 + β̃24 ),
which is finite under Assumption 3 (a). Therefore,
n
X

E[|Vi,n |4 ] → 0,

i=1

and the conclusion follows from the Lyapunov CLT and the Cramér-Wold device.
We next consider (A). We can write
n

n

i=1

i=1

1X
1 X
Zi D0i Ii )−1 √
(Zi Yi Ii − Z̃i Yi Ii )
(A) = (
n
n
n
n
n
n
X
X
1X
1X
0
−1 1
0
−1 1
0
0
−(
Zi Di Ii ) [ √
(Zi Di Ii − Z̃i D̃i Ii )](
Z̃i D̃i Ii )
Z̃i Yi Ii .
n
n
n
n
i=1

i=1

i=1

i=1

Step C.6.1.3. Let {Vi }∞
i=1 be i.i.d. random variables such that E[|Vi |] < ∞ and that E[Vi |Xi ]
∗
0
is bounded on N (D , δ ) ∩ X for some δ 0 > 0. Then,
E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}] = O(δ)
for l = 0, 1.
72

Proof. For every x ∈
/ N (D∗ , δ), B(x, δ)∩D∗ = ∅, so M L is continuously differentiable on B(x, δ).
By the mean value theorem, for every x ∈
/ N (D∗ , δ) and a ∈ B(0, δ),
M L(x + a) = M L(x) + ∇M L(y(x, a))0 a
for some point y(x, a) on the line segment connecting x and x + a. For every x ∈
/ N (D∗ , δ),
R
B(0,1) M L(x + δu)du
R
pM L (x; δ) =
B(0,1) du
R
0
B(0,1) (M L(x) + δ∇M L(y(x, δu)) u)du
R
=
B(0,1) du
R
0
B(0,1) ∇M L(y(x, δu)) udu
R
= M L(x) + δ
.
B(0,1) du
Now, we can write
E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}]
= E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈
/ N (D∗ , δ)}]
+ E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈ N (D∗ , δ)}].
For the first term,
|E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈
/ N (D∗ , δ)}]|
R
0
B(0,1) ∇M L(y(Xi , δu)) udu
R
1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈
/ N (D∗ , δ)}]|
= δ|E[Vi pM L (Xi ; δ)l
du
B(0,1)
R
Pp
∂M L(y(Xi ,δu))
||uk |du
k=1 |
∂xk
ML
l B(0,1)
R
≤ δE[|Vi |p (Xi ; δ)
1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈
/ N (D∗ , δ)}]
du
B(0,1)
R
p
X
∂M L(x) B(0,1) |uk |du
R
≤ δE[|Vi |]
sup
∂xk
x∈C ∗
B(0,1) du
k=1

= O(δ),
where we use the assumption that the partial derivatives of M L is bounded on C ∗ . For the
second term, for sufficiently small δ > 0,
|E[Vi pM L (Xi ; δ)l (pM L (Xi ; δ) − M L(Xi ))1{pM L (Xi ; δ) ∈ (0, 1)}1{Xi ∈ N (D∗ , δ)}]|
≤ E[|E[Vi |Xi ]|1{Xi ∈ N (D∗ , δ)}]
≤ CE[1{Xi ∈ N (D∗ , δ)}]
= C Pr(Xi ∈ N (D∗ , δ))
= O(δ),
where C is some constant, the second inequality follows from the assumption that E[Vi |Xi ] is
bounded on N (D∗ , δ 0 ) ∩ X for some δ 0 > 0, and the last equality follows from Assumption 4
(a).
73

Step C.6.1.4.

√1
n

Pn

i=1 (Zi Yi Ii

− Z̃i Yi Ii ) = op (1) and

√1
n

Pn

0
i=1 (Zi Di Ii

− Z̃i D̃0i Ii ) = op (1).

P
Proof. We only show that √1n ni=1 (pM L (Xi ; δn )2 − M L(Xi )2 )Ii = op (1). The proofs for the
other elements are similar. As for bias,
n

1 X ML
E[ √
(p (Xi ; δn )2 − M L(Xi )2 )Ii ]
n
i=1
√
= nE[(pM L (Xi ; δn )2 − M L(Xi )2 )Ii ]
√
= nE[(pM L (Xi ; δn ) + M L(Xi ))(pM L (Xi ; δn ) − M L(Xi ))Ii ]
√
= nO(δn )
= 0,
where the third equality follows from Step C.6.1.3 and the last from the assumption that nδn2 → 0.
As for variance, by Lemma B.6,
n

1 X ML
Var( √
(p (Xi ; δn )2 − M L(Xi )2 )Ii )
n
i=1

ML

≤ E[(p

(Xi ; δn )2 − M L(Xi )2 )2 Ii ]

= E[(pM L (Xi ; δn )4 − 2pM L (Xi ; δn )2 M L(Xi )2 + M L(Xi )4 )Ii ]
→ E[(M L(Xi )4 − 2M L(Xi )2 M L(Xi )2 + M L(Xi )4 )IiM L ]
= 0.

p

Step C.6.1.5. nΣ̂c −→ (E[Z̃i D̃0i IiM L ])−1 E[˜
2i Z̃i Z̃0i IiM L ](E[D̃i Z̃0i IiM L ])−1 .
Proof. Let i = Yi − D0i β. We have
n

n

1X 2
1X
ˆi Zi Z0i Ii =
(Yi − D0i β̂ c )2 Zi Z0i Ii
n
n
i=1

i=1

n
1X
(i − D0i (β̂ c − β))2 Zi Z0i Ii
=
n
i=1

n
1X 2
i Zi Z0i Ii
=
n
i=1

n

2X
−
(Yi − D0i β)((β̂0c − β0 ) + Di (β̂1c − β1 ) + pM L (Xi ; δn )(β̂2c − β2 ))Zi Z0i Ii
n
i=1

n
1X c
+
((β̂0 − β0 ) + Di (β̂1c − β1 ) + pM L (Xi ; δn )(β̂2c − β2 ))2 Zi Z0i Ii
n
i=1

n
1X 2
=
i Zi Z0i Ii + op (1)Op (1),
n
i=1

74

where the last equality follows from the result that β̂ c − β = op (1) and from Lemma B.6. Again
by Lemma B.6,
n

n

1X 2
1X 2
i Zi Z0i Ii =
(Yi − 2Yi D0i β + β 0 Di D0i β)Zi Z0i Ii
n
n
i=1

i=1

p

−→ E[(Yi2 − 2Yi D̃0i β + β 0 D̃i D̃0i β)Z̃i Z̃0i IiM L ]
= E[˜
2i Z̃i Z̃0i IiM L ],
and

n

1X
p
Zi D0i Ii −→ E[Z̃i D̃0i IiM L ].
n
i=1

The conclusion then follows.
d

Step C.6.1.6. (σ̂ c )−1 (β̂1c − β1 ) −→ N (0, 1).
Proof. By combining the results from Steps C.6.1.2–C.6.1.4 and by Lemma B.6,
p

(A) −→ 0,
d

(B) −→ N (0, (E[Z̃i D̃0i IiM L ])−1 E[˜
2i Z̃i Z̃0i IiM L ](E[D̃i Z̃0i IiM L ])−1 ),
and therefore,
√

d

n(β̂ c − β̃n ) −→ N (0, (E[Z̃i D̃0i IiM L ])−1 E[˜
2i Z̃i Z̃0i IiM L ](E[D̃i Z̃0i IiM L ])−1 ).

The conclusion then follows from Steps C.6.1.1 and C.6.1.5.

C.6.2

Consistency and Asymptotic Normality of β̂1s When Pr(M L(Xi ) ∈ (0, 1)) > 0

Let Iis = 1{ps (Xi ; δn ) ∈ (0, 1)}, Dsi = (1, Di , ps (Xi ; δn ))0 and Zsi = (1, Zi , ps (Xi ; δn ))0 . Let
β̂

c,s

n
n
X
X
s
s 0 s −1
=(
Zi (Di ) Ii )
Zsi Yi Iis
i=1

and
c,s

Σ̂

i=1

n
n
n
X
X
X
s
s 0 s −1
s 2 s
s 0 s
=(
Zi (Di ) Ii ) ( (ˆ
i ) Zi (Zi ) Ii )(
Dsi (Zsi )0 Iis )−1 ,
i=1

i=1

i=1
p

where ˆsi = Yi − (Dsi )0 β̂ c,s . Here, we only show that β̂1c,s −→ β1 if Sn → ∞ and that (σ̂ s )−1 (β̂1c,s −
d

β1 ) −→ N (0, 1) if Assumption 5 holds when Var(M L(Xi )|IiM L = 1) > 0. For that, it suffices to
show that
β̂ c,s − β̂ c = op (1)
75

if Sn → ∞ and that
√

n(β̂ c,s − β̂ c ) = op (1),
p

nΣ̂c,s −→ (E[Z̃i D̃0i IiM L ])−1 E[˜
2i Z̃i Z̃0i IiM L ](E[D̃i Z̃0i IiM L ])−1
if Assumption 5 holds. We have
n

β̂ c,s − β̂ c = (
=(

n

n

n

i=1
n
X

i=1

1 X s s 0 s −1 1 X s s
1X
1X
Zi (Di ) Ii )
Zi Yi Ii − (
Zi D0i Ii )−1
Zi Yi Ii
n
n
n
n
i=1
n
X

1
n

Zsi (Dsi )0 Iis )−1 (

i=1

i=1
n
X

1
n

i=1

n

−(

Zsi Yi Iis −

1
n

Zi Yi Ii )

i=1

n

n

n

n

i=1

i=1

1 X s s 0 s −1 1 X s s 0 s 1 X
1X
1X
Zi (Di ) Ii ) (
Zi (Di ) Ii −
Zi D0i Ii )(
Zi D0i Ii )−1
Zi Yi Ii .
n
n
n
n
n
i=1

i=1

i=1

√

= op (1) under the boundedness
By Lemma B.8,
= op (1) if Sn → ∞, and
imposed by Assumption 4 (c) if Assumption 5 holds.
By proceeding as in Step C.6.1.5 in Section C.6.1, we have
β̂ c,s

− β̂ c

n

n

i=1

i=1

n(β̂ c,s

− β̂ c )

1X s 2 s s 0 s
1X s 2 s s 0 s
(ˆ
i ) Zi (Zi ) Ii =
(i ) Zi (Zi ) Ii + op (1),
n
n
where

si

= Yi −

(Dsi )0 β.

Then, by Lemma B.8,

n

n

i=1

i=1

1X s 2 s s 0 s 1X 2
(ˆ
i ) Zi (Zi ) Ii −
i Zi Z0i Ii
n
n
n
n
1X 2
1X 2
s 0
0 s
s 0
s
s 0 s
=
(Yi − 2Yi (Di ) β + β Di (Di ) β)Zi (Zi ) Ii −
(Yi − 2Yi D0i β + β 0 Di D0i β)Zi Z0i Ii + op (1)
n
n
i=1

i=1

= op (1)
so that

n

1X s 2 s s 0 s p
(ˆ
i ) Zi (Zi ) Ii −→ E[˜
2i Z̃i Z̃0i IiM L ].
n
i=1

Also,

1
n

C.6.3

Pn

s
s 0 s
i=1 Zi (Di ) Ii

p

−→ E[Z̃i D̃0i IiM L ] by using Lemma B.8. The conclusion then follows.

Consistency and Asymptotic Normality of β̂1 When Pr(M L(Xi ) ∈ (0, 1)) = 0

Since Pr(M L(Xi ) ∈ (0, 1)) = 0, In = 0 with probability one. Hence,
n
n
X
X
0
−1
β̂ = (
Zi Di Ii )
Zi Yi Ii
i=1

i=1

with probability one. We use the notation and results provided in Appendix B. By Lemma B.5,
under Assumption 3 (e), there exists µ > 0 such that dsΩ∗ is twice continuously differentiable on
N (∂Ω∗ , µ) and that
Z
Z δZ
∂Ω∗
g(x)dx =
g(u + λνΩ∗ (u))Jp−1
ψΩ∗ (u, λ)dHp−1 (u)dλ
N (∂Ω∗ ,δ)

−δ

∂Ω∗

76

for every δ ∈ (0, µ) and every function g : Rp → R that is integrable on N (∂Ω∗ , δ).
p

d

Below we show that β̂1 −→ β1 if nδn → ∞ and δn → 0 and that σ̂ −1 (β̂1 − β1 ) −→ N (0, 1) if
3
nδn → 0 in addition. The proof proceeds in eight steps.
Step C.6.3.1. There exist δ̄ > 0 and a bounded function r : ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄) → R
such that
pM L (u + δvνΩ∗ (u); δ) = k(v) + δr(u, v, δ)
for every (u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄), where
k(v) =

(
1
1 − 21 I(1−v2 ) ( p+1
2 , 2)
p+1 1
1
2 I(1−v 2 ) ( 2 , 2 )

for v ∈ [0, 1)
for v ∈ (−1, 0).

Here Ix (α, β) is the regularized incomplete beta function (the cumulative distribution function of
the beta distribution with shape parameters α and β).
Proof. By Assumption 3 (f) (ii), there exists δ̄ ∈ (0, µ2 ) such that M L(x) = 0 for almost every
x ∈ N (X , 3δ̄) \ Ω∗ . By Taylor’s theorem, for every u ∈ ∂Ω∗ ∩ N (X , δ̄) and a ∈ B(0, 2δ̄),
dsΩ∗ (u + a) = dsΩ∗ (u) + ∇dsΩ∗ (u)0 a + a0 R(u, a)a,
where

Z
R(u, a) =

1

(1 − t)D2 dsΩ∗ (u + ta)dt.

0

Since D2 dsΩ∗ is
cl(N (∂Ω∗ , 2δ̄)).

continuous and cl(N (∂Ω∗ , 2δ̄)) is bounded and closed, D2 dsΩ∗ is bounded on
Therefore, R(·, ·) is bounded on ∂Ω∗ ∩ N (X , δ̄) × B(0, 2δ̄). It also follows that
dsΩ∗ (u + a) = νΩ∗ (u)0 a + a0 R(u, a)a,

since dsΩ∗ (u) = 0 and ∇dsΩ∗ (u) = νΩ∗ (u) for every u ∈ ∂Ω∗ ∩ N (X , 2δ̄) by Lemma B.1. For
(u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄),
pM L (u + δvνΩ∗ (u); δ)
R
∗
B(0,1) M L(u + δvνΩ (u) + δw)dw
R
=
B(0,1) dw
R
∗
∗
B(0,1) 1{u + δvνΩ (u) + δw ∈ Ω }dw
=
Volp
R
s
∗
B(0,1) 1{dΩ∗ (u + δ(vνΩ (u) + w)) ≥ 0)}dw
=
Volp
R
0
2
0
∗
∗
∗
∗
∗
B(0,1) 1{δνΩ (u) (vνΩ (u) + w) + δ (vνΩ (u) + w) R(u, δ(vνΩ (u) + w))(vνΩ (u) + w) ≥ 0}dw
=
,
Volp
where Volp denotes the volume of the p-dimensional unit ball, and the second equality follows
since u + δvνΩ∗ (u) + δw ∈ N (X , 3δ̄) and hence M L(u + δvνΩ∗ (u) + δw) = 0 for almost every
77

w ∈ B(0, 1) such that u + δvνΩ∗ (u) + δw ∈
/ Ω∗ . Observe that
1{δνΩ∗ (u)0 (vνΩ∗ (u) + w) + δ 2 (vνΩ∗ (u) + w)0 R(u, δ(vνΩ∗ (u) + w))(vνΩ∗ (u) + w) ≥ 0}
= 1{v + νΩ∗ (u) · w + δ(vνΩ∗ (u) + w)0 R(u, δ(vνΩ∗ (u) + w))(vνΩ∗ (u) + w) ≥ 0}
= 1{v + νΩ∗ (u) · w ≥ 0}
− 1{v + νΩ∗ (u) · w ≥ 0, v + νΩ∗ (u) · w + δ(vνΩ∗ (u) + w)0 R(u, δ(vνΩ∗ (u) + w))(vνΩ∗ (u) + w) < 0}
{z
}
|
=a(u,v,w,δ)

+ 1{v + νΩ∗ (u) · w < 0, v + νΩ∗ (u) · w + δ(vνΩ∗ (u) + w)0 R(u, δ(vνΩ∗ (u) + w))(vνΩ∗ (u) + w) ≥ 0} .
|
{z
}
=b(u,v,w,δ)

Note that the set {w ∈ B(0, 1) : v + ν(u) · w ≥ 0} is a region of the p-dimensional unit ball cut
off by the plane {w ∈ Rp : v + ν(u) · w = 0}. The distance from the center of the unit ball to
the plane is |v|. Using the formula for the volume of a hyperspherical cap (see e.g. Li (2011)),
we have
(
Z
1
Volp − 21 Volp I(2(1−v)−(1−v)2 ) ( p+1
for v ∈ [0, 1)
2 , 2)
1{v + ν(u) · w ≥ 0}dw =
p+1 1
1
for v ∈ (−1, 0).
B(0,1)
2 Volp I(2(1+v)−(1+v)2 ) ( 2 , 2 )
Therefore, for every (u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄),
R
B(0,1) (−a(u, v, w, δ) + b(u, v, w, δ))dw
ML
p (u + δvνΩ∗ (u); δ) = k(v) +
.
Volp
Now let r(u, v, δ) = δ −1 (pM L (u + δvνΩ∗ (u); δ) − k(v)). Since R(·, ·) is bounded on ∂Ω∗ ∩
N (X , δ̄) × B(0, 2δ̄) and kνΩ∗ (u)k = 1, there exists r̄ > 0 such that
|(vνΩ∗ (u) + w)0 R(u, δ(vνΩ∗ (u) + w))(vνΩ∗ (u) + w)| ≤ r̄
for every (u, v, w, δ) ∈ ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × B(0, 1) × (0, δ̄). Therefore,
0 ≤ a(u, v, w, δ) ≤ 1{0 ≤ v + νΩ∗ (u) · w < δr̄}
and
0 ≤ b(u, v, w, δ) ≤ 1{−δr̄ ≤ v + νΩ∗ (u) · w < 0}.
It then follows that
R
R
∗
B(0,1) (−a(u, v, w, δ) + b(u, v, w, δ))dw
B(0,1) 1{0 ≤ v + νΩ (u) · w < δr̄}dw
≤
−
Volp
Volp
R
∗
B(0,1) 1{−δr̄ ≤ v + νΩ (u) · w < 0}dw
≤
.
Volp
The set {w ∈ B(0, 1) : 0 ≤ v + νΩ∗ (u) · w < δr̄} is a region of the p-dimensional unit ball cut
off by the two planes {w ∈ Rp : v + νΩ∗ (u) · w = 0} and {w ∈ Rp : v + νΩ∗ (u) · w = δr̄}. Its

78

Lebesgue measure is at most the volume of the (p − 1)-dimensional unit ball times the distance
between the two planes, so
Z
1{0 ≤ v + νΩ∗ (u) · w < δr̄}dw.
−δVolp−1 r̄ ≤ −
B(0,1)

Likewise,

Z
1{−δr̄ ≤ v + νΩ∗ (u) · w < 0}dw ≤ δVolp−1 r̄.
B(0,1)

Therefore,
δVolp−1 r̄
−
≤
Volp

R

B(0,1) (−a(u, v, w, δ)

+ b(u, v, w, δ))dw

Volp

≤

δVolp−1 r̄
.
Volp

It follows that
R
r(u, v, δ) = δ −1
∈ [−

B(0,1) (−a(u, v, w, δ)

+ b(u, v, w, δ))dw

Volp

Volp−1 r̄ Volp−1 r̄
,
],
Volp
Volp

and hence r is bounded on ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄).
Step C.6.3.2. For every (u, v, δ) ∈ ∂Ω∗ ∩N (X , δ̄)×(−1, 1)×(0, δ̄), pM L (u+δvνΩ∗ (u); δ) ∈ (0, 1).
Proof. Fix (u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̄) × (−1, 1) × (0, δ̄). Suppose v = 0. By Step C.6.3.1,
pM L (u) = limδ0 →0 pM L (u; δ 0 ) = k(0) = 21 . This implies that there exists δ 0 ∈ (0, δ) such that
pM L (u; δ 0 ) ∈ (0, 1). It then follows that 0 < Lp (B(u, δ 0 ) ∩ Ω∗ ) ≤ Lp (B(x, δ) ∩ Ω∗ ) and that
p
∗)
0 < Lp (B(x, δ 0 ) \ Ω∗ ) ≤ Lp (B(x, δ) \ Ω∗ ). Therefore, pM L (u; δ) = L L(B(u,δ)∩Ω
∈ (0, 1).
p (B(u,δ))
Suppose v 6= 0 and let  ∈ (0, δ(1 − |v|)). Note that B(u, ) ⊂ B(u + δvνΩ∗ (u), δ), since for
any x ∈ B(u, ), ku + δvνΩ∗ (u) − xk ≤ kδvνΩ∗ (u)k + ku − xk ≤ δ|v| +  < δ. Since pM L (u) = 12 ,
there exists 0 ∈ (0, ) such that pM L (u; 0 ) ∈ (0, 1). It then follows that 0 < Lp (B(u, 0 ) ∩ Ω∗ ) ≤
Lp (B(u, )∩Ω∗ ) ≤ Lp (B(u+δvνΩ∗ (u), δ)∩Ω∗ ) and that 0 < Lp (B(x, 0 )\Ω∗ ) ≤ Lp (B(x, )\Ω∗ ) ≤
p
∗
Ω∗ (u),δ)∩Ω )
Lp (B(u+δvνΩ∗ (u), δ)\Ω∗ ). Therefore, pM L (u+δvνΩ∗ (u); δ) = L L(B(u+δvν
∈ (0, 1).
p (B(u+δvν ∗ (u),δ))
Ω

N (∂Ω∗ , δ 0 )

Rp

Step C.6.3.3. Let g :
→ R be a function that is bounded on
0
δ > 0. Then, for l ≥ 0, there exist δ̃ > 0 and constant C > 0 such that

∩ N (X , δ 0 ) for some

|δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]| ≤ C
for every δ ∈ (0, δ̃). If g is continuous on N (∂Ω∗ , δ 0 ) ∩ N (X , δ 0 ) for some δ 0 > 0, then
δ
δ

−1

−1

E[p

E[Zi p

ML

ML

l

(Xi ; δ) g(Xi )1{p
l

(Xi ; δ) g(Xi )1{p

ML

ML

Z

1

(Xi ; δ) ∈ (0, 1)}] =

Z

k(v) dv
−1
Z 1

(Xi ; δ) ∈ (0, 1)}] =

∂Ω∗
l

Z

k(v) dv
0

79

l

∂Ω∗

g(x)fX (x)dHp−1 (x) + o(1)
g(x)fX (x)dHp−1 (x) + o(1)

for l ≥ 0. Furthermore, if g is continuously differentiable and ∇g is bounded on N (∂Ω∗ , δ 0 ) ∩
N (X , δ 0 ) for some δ 0 > 0, then
Z 1
Z
−1
ML
l
ML
l
δ E[p (Xi ; δ) g(Xi )1{p (Xi ; δ) ∈ (0, 1)}] =
k(v) dv
g(x)fX (x)dHp−1 (x) + O(δ)
δ −1 E[Zi pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}] =

∂Ω∗

−1
1

Z

k(v)l dv

Z
∂Ω∗

0

g(x)fX (x)dHp−1 (x) + O(δ)

for l ≥ 0.
Proof. Let δ̄ be given in Step C.6.3.1. Under Assumption 3 (g), there exists δ̃ ∈ (0, δ̄) such that
fX is bounded, is continuously differentiable, and has bounded partial derivatives on N (∂Ω∗ , 2δ̃)∩
N (X , 2δ̃). Let δ̃ ∈ (0, δ̄) be such that both g and fX are bounded on N (∂Ω∗ , 2δ̃) ∩ N (X , 2δ̃).
We first show that pM L (x; δ) ∈ {0, 1} for every x ∈ X \ N (∂Ω∗ , δ) for every δ ∈ (0, δ̃). Pick
x ∈ X \ N (∂Ω∗ , δ) and δ ∈ (0, δ̃). Since B(x, δ) ∩ ∂Ω∗ = ∅, either B(x, δ) ⊂ int(Ω∗ ) or B(x, δ) ⊂
int(Rp \ Ω∗ ). If B(x, δ) ⊂ int(Ω∗ ), pM L (x; δ) = 1. If B(x, δ) ⊂ int(Rp \ Ω∗ ), pM L (x; δ) = 0,
since M L(x0 ) = 0 for almost every x0 ∈ B(x, δ) ⊂ N (X , 3δ̄) \ Ω∗ by the choice of δ̄. Therefore,
{x ∈ X : pM L (x; δ) ∈ (0, 1)} ⊂ N (∂Ω∗ , δ) for every δ ∈ (0, δ̃). By this and Lemma B.5, for
δ ∈ (0, δ̃),
δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z
−1
=δ
pM L (x; δ)l g(x)1{pM L (x; δ) ∈ (0, 1)}fX (x)dx
Z
pM L (x; δ)l g(x)1{pM L (x; δ) ∈ (0, 1)}fX (x)dx
= δ −1
= δ −1

N (∂Ω∗ ,δ)
δ Z

Z

∂Ω∗

−δ

pM L (u + λνΩ∗ (u); δ)l g(u + λνΩ∗ (u))1{pM L (u + λνΩ∗ (u); δ) ∈ (0, 1)}
∗

∂Ω
× fX (u + λνΩ∗ (u))Jp−1
ψΩ∗ (u, λ)dHp−1 (u)dλ.

With change of variables v = λδ , we have
δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z 1Z
pM L (u + δvνΩ∗ (u); δ)l 1{pM L (u + δvνΩ∗ (u); δ) ∈ (0, 1)}
=
−1

∂Ω∗

∗

∂Ω
× g(u + δvνΩ∗ (u))fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv.

For every (u, v, δ) ∈ ∂Ω∗ \ N (X , δ̃) × (−1, 1) × (0, δ̃), u + δvνΩ∗ (u) ∈
/ X , so
δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z 1Z
=
pM L (u + δvνΩ∗ (u); δ)l 1{pM L (u + δvνΩ∗ (u); δ) ∈ (0, 1)}
−1

∂Ω∗ ∩N (X ,δ̃)

∗

∂Ω
× g(u + δvνΩ∗ (u))fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv

Z

1

Z

=
−1

∂Ω∗ ∩N (X ,δ̃)

∗

∂Ω
(k(v) + δr(u, v, δ))l g(u + δvνΩ∗ (u))fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv,

80

∗

∂Ω ψ ∗ (·, ·)
where the second equality follows from Steps C.6.3.1 and C.6.3.2. By Lemma B.5, Jp−1
Ω
∗
is bounded on ∂Ω × (−δ̃, δ̃). Since r, g and fX are also bounded, for some constant C > 0,

|δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]| ≤ C

Z

1

−1

Z

dHp−1 (u)dv,

∂Ω∗ ∩N (X ,δ̃)

which is finite by Assumption 3 (f) (i). Moreover, if g and fX are continuous on N (∂Ω∗ , 2δ̃) ∩
N (X , 2δ̃), by the Dominated Convergence Theorem,
δ

−1

ML

E[p

l

(Xi ; δ) g(Xi )1{p

ML

Z

1

(Xi ; δ) ∈ (0, 1)}] →

l

Z

k(v) dv
∂Ω∗

−1

g(u)fX (u)dHp−1 (u),

∗

∗

∂Ω ψ ∗ (u, λ) is continuous in λ and J ∂Ω ψ ∗ (u, 0) =
where we use the fact from Lemma B.5 that Jp−1
Ω
p−1 Ω
1.
Note that M L(x) = 1 for every x ∈ Ω∗ and M L(x) = 0 for almost every x ∈ N (X , 2δ̃) \ Ω∗ .
Also, for every (u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̃) × (−1, 1) × (0, δ̃), u + δvνΩ∗ (u) ∈ Ω∗ if v ∈ (0, 1) and
u + δvνΩ∗ (u) ∈ N (X , 2δ̃) \ Ω∗ if v ∈ (−1, 0]. Therefore,

δ −1 E[Zi pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
= δ −1 E[M L(Xi )pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z 1Z
M L(u + δvνΩ∗ (u))(k(v) + δr(u, v, δ))l g(u + δvνΩ∗ (u))
=
∂Ω∗ ∩N (X ,δ̃)

−1

∗

∂Ω
× fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv

Z

1Z

∗

=
∂Ω∗ ∩N (X ,δ̃)

0

Z
→

1
l

∂Ω
(k(v) + δr(u, v, δ))l g(u + δvνΩ∗ (u))fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv

Z

k(v) dv
0

∂Ω∗

g(u)fX (u)dHp−1 (u).

Now suppose that g and fX are continuously differentiable on N (∂Ω∗ , 2δ̃) ∩ N (X , 2δ̃) and
that ∇g and ∇f are bounded on N (∂Ω∗ , 2δ̃) ∩ N (X , 2δ̃). Using the mean-value theorem, we
obtain that, for any (u, v, δ) ∈ ∂Ω∗ ∩ N (X , δ̃) × (−1, 1) × (0, δ̃),
g(u + δvνΩ∗ (u)) = g(u) + ∇g(yg (u, δvνΩ∗ (u)))0 δvνΩ∗ (u),
fX (u + δvνΩ∗ (u)) = fX (u) + ∇fX (yf (u, δvνΩ∗ (u)))0 δvνΩ∗ (u)
for some yg (u, δvνΩ∗ (u)) and yf (u, δvνΩ∗ (u)) that are on the line segment connecting u and
u + δvνΩ∗ (u). In addition,
∗

∂Ω∗
Jp−1
ψΩ∗ (u, δv)

∂Ω ψ ∗ (u, y (u, δv))
∂Jp−1
Ω
J
δv
=
+
∂λ
∗
∂Ω ψ ∗ (u, y (u, δv))
∂Jp−1
Ω
J
=1+
δv
∂λ
∂Ω∗
Jp−1
ψΩ∗ (u, 0)

81

∗

for some yJ (u, δv) that is on the line segment connecting 0 and δv. By Lemma B.5,
is bounded on ∂Ω∗ × (−δ̃, δ̃). We then have

∂Ω ψ ∗ (·,·)
∂Jp−1
Ω
∂λ

δ −1 E[pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z 1Z
(k(v) + δr(u, v, δ))l (g(u) + ∇g(yg (u, δvνΩ∗ (u)))0 δvνΩ∗ (u))
=
−1

∂Ω∗ ∩N (X ,δ̃)

∗

∂J ∂Ω ψΩ∗ (u,yJ (u,δv))
δv)dHp−1 (u)dv
∂λ

Z

1

=
−1
1

× (fX (u) + ∇fX (yf (u, δvνΩ∗ (u)))0 δvνΩ∗ (u))(1 + p−1
Z
(k(v)l g(u)fX (u) + δh(u, v, δ))dHp−1 (u)dv
∂Ω∗ ∩N (X ,δ̃)

Z

Z

l

=

k(v) dv
∂Ω∗

−1

g(u)fX (u)dH

p−1

Z

1

Z

h(u, v, δ)dHp−1 (u)dv

(u) + δ
−1

∂Ω∗ ∩N (X ,δ̃)

for some function h bounded on ∂Ω∗ ∩ N (X , δ̃) × (−1, 1) × (0, δ̃). It then follows that
Z 1
Z
l
−1
ML
l
ML
k(v) dv
g(u)fX (u)dHp−1 (u) + O(δ).
δ E[p (Xi ; δ) g(Xi )1{p (Xi ; δ) ∈ (0, 1)}] =
∂Ω∗

−1

Also,
δ −1 E[Zi pM L (Xi ; δ)l g(Xi )1{pM L (Xi ; δ) ∈ (0, 1)}]
Z 1Z
∂Ω∗
=
(k(v) + δr(u, v, δ))l g(u + δvνΩ∗ (u))fX (u + δvνΩ∗ (u))Jp−1
ψΩ∗ (u, δv)dHp−1 (u)dv
∂Ω∗ ∩N (X ,δ̃)

0

Z
=

1
l

Z

k(v) dv
∂Ω∗

0

g(u)fX (u)dHp−1 (u) + O(δ).

Step C.6.3.4. Let SD = limδ→0 δ −1 E[Zi D0i 1{pM L (Xi ; δ) ∈ (0, 1)}] and SY = limδ→0 δ −1 E[Zi Yi 1{pM L (Xi ; δ) ∈
−1
SY is β1 .
(0, 1)}]. Then the second element of SD
Proof. Note that Di = Zi Di (1) + (1 − Zi )Di (0) and Yi = Zi Y1i + (1 − Zi )Y0i . By Step C.6.3.3,
SD


2f¯X

=
f¯X
R1
k(v)dv f¯X
−1

where f¯X =


R1
E[Di (1) + Di (0)|Xi = x]fX (x)dHp−1 (x)
k(v)dv f¯X
−1
R1

p−1
(x)
k(v)dv f¯X  ,
∗ E[Di (1)|Xi = x]fX (x)dH
∂Ω
0
R
R
R1
R0
1
( k(v)dvE[Di (1)|Xi = x] + −1 k(v)dvE[Di (0)|Xi = x])fX (x)dHp−1 (x) −1 k(v)2 dv f¯X
∂Ω∗ 0
R

∂Ω∗R

fX (x)dHp−1 (x), and


R
p−1 (x)
∂ΩR∗ E[Y1i + Y0i |Xi = x]fX (x)dH


p−1 (x)
SY = 
.
∂Ω∗ E[Y1i |XRi = x]fX (x)dH
R1
R
0
p−1
(x)
∂Ω∗ ( 0 k(v)dvE[Y1i |Xi = x] + −1 k(v)dvE[Y0i |Xi = x])fX (x)dH
R

∂Ω∗

After a few lines of algebra, we have
Z
−2
¯
det(SD ) =fX
E[Di (1) − Di (0)|Xi = x]fX (x)dHp−1 (x)
∂Ω∗
Z 0
Z 0
Z 1
Z 1
×(
(k(v) −
k(s)ds)2 dv +
(k(v) −
k(s)ds)2 dv),
−1

−1

0

82

0

which is nonzero under Assumption 3 (b) and (f) (i). After another few lines of algebra, we
−1
obtain that the second element of SD
SY is
R
(1) − Di (0))(Yi (1) − Yi (0))|Xi = x]fX (x)dHp−1 (x)
∂Ω∗ E[(D
Ri
.
p−1 (x)
∂Ω∗ E[Di (1) − Di (0)|Xi = x]fX (x)dH
On the other hand, by Step C.6.3.3,
β1 = lim E[ωi (δ)(Yi (1) − Yi (0))]
δ→0

δ −1 E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))(Yi (1) − Yi (0))1{pM L (Xi ; δ) ∈ (0, 1)}]
δ −1 E[pM L (Xi ; δ)(1 − pM L (Xi ; δ))(Di (1) − Di (0))1{pM L (Xi ; δ) ∈ (0, 1)}]
R
p−1 (x)
−1 k(v)(1 − k(v))dv ∂Ω∗ E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x]fX (x)dH
=
R1
R
p−1 (x)
−1 k(v)(1 − k(v))dv ∂Ω∗ E[Di (1) − Di (0)|Xi = x]fX (x)dH
R
p−1 (x)
∗ E[(Di (1) − Di (0))(Yi (1) − Yi (0))|Xi = x]fX (x)dH
R
= ∂Ω
.
p−1 (x)
∂Ω∗ E[Di (1) − Di (0)|Xi = x]fX (x)dH
= lim
δ→0
R1

p

Step C.6.3.5. If nδn → ∞ as n → ∞, then β̂1 −→ β1 .
P
P
Proof. It suffices to verify that the variance of each element of nδ1n ni=1 Zi D0i Ii and nδ1n ni=1 Zi Y Ii
P
is o(1). Here, we only verify that Var( nδ1n ni=1 pM L (Xi ; δn )Yi Ii ) = o(1). Note that
E[Yi2 |Xi ] = E[Zi Y1i2 + (1 − Zi )Y0i2 |Xi ] ≤ E[Y1i2 + Y0i2 |Xi ].
Under Assumption 3 (g), there exists δ 0 > 0 such that E[Y1i2 +Y0i2 |Xi ] is continuous on N (∂Ω∗ , δ 0 ).
Since cl(N (∂Ω∗ , 12 δ 0 )) is closed and bounded, E[Y1i2 + Y0i2 |Xi ] is bounded on cl(N (∂Ω∗ , 12 δ 0 )). We
have
Var(

n
1 X ML
1 −1
p (Xi ; δn )Yi Ii ) ≤
δ E[pM L (Xi ; δn )2 Yi2 Ii ]
nδn
nδn n
i=1

1 −1
δ E[pM L (Xi ; δn )2 E[Yi2 |Xi ]Ii ]
nδn n
1
≤
C
nδn
=

for some C > 0, where the last inequality follows from Step C.6.3.3. The conclusion follows since
nδn → ∞.
−1
Now let β = (β0 , β1 , β2 )0 = SD
SY and let i = Yi − D0i β. We can write
n
n
p
1 X
1 X
0
−1
nδn (β̂ − β) = (
Zi D i I i ) √
Zi i Ii
nδn
nδn
i=1

i=1

n
n
1 X
1 X
0
−1
=(
Zi D i I i ) √
{(Zi i Ii − E[Zi i Ii ]) + E[Zi i Ii ]}.
nδn
nδn
i=1

i=1

83

Step C.6.3.6.

n
1 X
d
√
(Zi i Ii − E[Zi i Ii ]) −→ N (0, V),
nδn i=1

where V = limn→∞ δn−1 E[2i Zi Zi Ii ].
Proof. We use the triangular-array Lyapunov CLT and the Cramér-Wold device. Pick a nonzero
1
λ0 (Zi i Ii − E[Zi i Ii ]). First,
λ ∈ Rp , and let Vi,n = √nδ
n

n
X

2
E[Vi,n
] = δn−1 λ0 (E[2i Zi Z0i Ii ] − E[Zi i Ii ]E[Z0i i Ii ])λ.

i=1

By Step C.6.3.3,
E[Zi i Ii ] = E[Zi (Yi − D0i β)Ii ] = O(δn ),
so
δn−1 E[Zi i Ii ]E[Z0i i Ii ] = o(1).
We have
E[2i Zi Z0i Ii ] = E[(Yi − β0 − β1 Di − β2 pM L (Xi ; δn ))2 Zi Z0i Ii ]
= E[Zi (Y1i − β0 − β1 Di (1) − β2 pM L (Xi ; δn ))2 Zi Z0i Ii ]
+ E[(1 − Zi )(Y0i − β0 − β1 Di (0) − β2 pM L (Xi ; δn ))2 Zi Z0i Ii ].
Since E[Y1i |Xi ], E[Y0i |Xi ], E[Di (1)|Xi ], E[Di (0)|Xi ], E[Y1i2 |Xi ], E[Y0i2 |Xi ], E[Y1i Di (1)|Xi ] and
E[Y0i Di (0)|Xi ] are continuous on N (∂Ω∗ , δ 0 ) for some δ 0 > 0 under Assumption 3 (g), limn→∞ δn−1 E[2i Zi Z0i Ii ]
exists and finite. Therefore,
n
X
2
E[Vi,n
] → λ0 Vλ < 0.
i=1

We next verify the Lyapunov condition: for some t > 0,
n
X

E[|Vi,n |2+t ] → 0.

i=1

We have
n
X

E[|Vi,n |4 ] =

i=1

≤

1 −1
δ E[|λ0 (Zi i Ii − E[Zi i Ii ])|4 ]
nδn n
1 3c −1
2 δn {E[|λ0 Zi i Ii |4 ] + |λ0 E[Zi i Ii ]|4 }
nδn

by the cr -inequality. Repeating using the cr -inequality gives
δn−1 E[|λ0 Zi i Ii |4 ] = δn−1 E[|λ0 Zi (Yi − β0 − β1 Di − β2 pM L (Xi ; δn ))|4 Ii ]
≤ 23c δn−1 E[(|λ0 Zi |4 )(|Yi |4 + |β0 |4 + |β1 |4 Di + |β2 |4 pM L (Xi ; δn )4 )Ii ]
≤ 23c (λ1 + λ2 + λ3 )4 δn−1 E[(Yi4 + β04 + β14 + β24 )Ii ]
= 23c O(1)
84

for some finite constant c, where the last equality holds by Step C.6.3.3 under Assumption 3 (g).
Moreover,
δn−1 |λ0 E[Zi i Ii ]|4 = δn3 |λ0 δn−1 E[Zi i Ii ]|4
= δn3 O(1)
= o(1).
Therefore, when nδn → ∞,

n
X

E[|Vi,n |4 ] → 0,

i=1

and the conclusion follows from the Lyapunov CLT and the Cramér-Wold device.
p

−1
0 )−1 .
Step C.6.3.7. nδn Σ̂ −→ SD
V(SD

Proof. We have
n
n
1 X 2
1 X
0
ˆi Zi Zi Ii =
(Yi − D0i β̂)2 Zi Z0i Ii
nδn
nδn
i=1

i=1

n
1 X
=
(i − D0i (β̂ − β))2 Zi Z0i Ii
nδn
i=1

n
1 X 2
=
i Zi Z0i Ii
nδn
i=1

−

n
2 X
(Yi − D0i β)((β̂0 − β0 ) + Di (β̂1 − β1 ) + pM L (Xi ; δn )(β̂2 − β2 ))Zi Z0i Ii
nδn
i=1

n
1 X
+
((β̂0 − β0 ) + Di (β̂1 − β1 ) + pM L (Xi ; δn )(β̂2 − β2 ))2 Zi Z0i Ii
nδn

i=1
n
1 X 2
=
i Zi Z0i Ii
nδn
i=1

+ op (1)Op (1),

where the last equality follows from the result that β̂ − β = op (1) and from application of
P
p
Step C.6.3.3 as in Steps C.6.3.5 and C.6.3.6. To show nδ1n ni=1 2i Zi Z0i Ii −→ V, it suffices
P
to verify that the variance of each element of nδ1n ni=1 2i Zi Z0i Ii is o(1). We only verify that
P
Var( nδ1n ni=1 2i pM L (Xi ; δn )2 Ii ) = o(1). Using the cr -inequality, we have that for some constant

85

c,
n
1 X 2 ML
1 −1
δ E[4i Ii ]
Var(
i p (Xi ; δn )2 Ii ) ≤
nδn
nδn n
i=1

1 −1
δ E[(Yi − β0 − β1 Di − β2 pM L (Xi ))4 Ii ]
nδn n
1 3c −1
≤
2 δn E[(Yi4 + β04 + β14 Di + β24 pM L (Xi )4 )Ii ]
nδn
1 3c −1
≤
2 δn E[(Yi4 + β04 + β14 + β24 )Ii ]
nδn
1 3c
=
2 O(1)
nδn
= o(1),
=

where the second last equality holds by Step C.6.3.3 under Assumption 3 (g). Therefore,
n
1 X 2
p
ˆi Zi Z0i Ii −→ V.
nδn
i=1

It follows that
n
n
n
X
1 X
1 X
p
−1
0 −1
0
−1 1
2
0
nδn Σ̂ = (
V(SD
) .
Zi Di Ii ) (
ˆi Zi Zi Ii )(
Di Z0i Ii )−1 −→ SD
nδn
nδn
nδn
i=1

i=1

i=1

d

Step C.6.3.8. σ̂ −1 (β̂1 − β1 ) −→ N (0, 1).
−1 −1
δn E[Zi Yi Ii ]. We then have
Proof. Let βn = SD

√

n
p
1 X
E[Zi i Ii ] = nδn δn−1 E[Zi (Yi − D0 β)Ii ]
nδn i=1
p
= nδn δn−1 E[Zi (Yi − D0i βn + D0i (βn − β))Ii ]
p
= nδn δn−1 {E[Zi Yi Ii ] − E[Zi D0i Ii ]βn + E[Zi D0i Ii ](βn − β)}
p
−1 −1
= nδn {(SD − δn−1 E[Zi D0i Ii ])SD
δn E[Zi Yi Ii ]
−1 −1
+ δn−1 E[Zi D0i Ii ]SD
(δn E[Zi Yi Ii ] − SY )}
p
= nδn (O(δn )O(1) + O(1)O(δn ))
p
= O( nδn δn ),

where we use Step C.6.3.3 for the second last equality. Thus, when nδn3 → 0,
n
n
p
1 X
1 X
nδn (β̂ − β) = (
Zi D0i Ii )−1 √
{(Zi i Ii − E[Zi i Ii ]) + E[Zi i Ii ]}
nδn
nδn
i=1

i=1

d

−1
0 −1
−→ N (0, SD
V(SD
) ).

The conclusion then follows from Step C.6.3.7.

86

C.6.4

Consistency and Asymptotic Normality of β̂1s When Pr(M L(Xi ) ∈ (0, 1)) = 0

Let Iis = 1{ps (Xi ; δn ) ∈ (0, 1)}, Dsi = (1, Di , ps (Xi ; δn ))0 and Zsi = (1, Zi , ps (Xi ; δn ))0 . β̂ s and Σ̂s
are given by
n
n
X
X
β̂ s = (
Zsi (Dsi )0 Iis )−1
Zsi Yi Iis .
i=1

and

i=1

n
n
n
X
X
X
s
s 0 s −1
s 2 s
s 0 s
Σ̂ = (
Zi (Di ) Ii ) ( (ˆ
i ) Zi (Zi ) Ii )(
Dsi (Zsi )0 Iis )−1 ,
s

i=1

i=1

i=1

where ˆsi = Yi − (Dsi )0 β̂ s . It is sufficient to show that
β̂ s − β̂ = op (1),
if Sn → ∞ and that
p
nδn (β̂ s − β̂) = op (1),
p

−1
0 −1
nδn Σ̂s −→ SD
V(SD
)

if Assumption 5 holds.
2
Step C.6.4.1. Let {Vi }∞
i=1 be i.i.d. random variables. If E[Vi |Xi ] and E[Vi |Xi ] are bounded on
N (∂Ω∗ , δ 0 ) ∩ N (X , δ 0 ) for some δ 0 > 0, and Sn → ∞, then
n
n
1 X
1 X
Vi ps (Xi ; δn )l Iis −
Vi pM L (Xi ; δn )l Ii = op (1)
nδn
nδn
i=1

i=1

for l = 0, 1, 2, 3, 4. If, in addition, Assumption 5 holds, then
n
n
1 X
1 X
s
l s
√
Vi p (Xi ; δn ) Ii − √
Vi pM L (Xi ; δn )l Ii = op (1)
nδn i=1
nδn i=1

for l = 0, 1, 2.
Proof. We have
n
n
1 X
1 X
Vi ps (Xi ; δn )l Iis −
Vi pM L (Xi ; δn )l Ii
nδn
nδn
i=1

i=1

n
n
1 X
1 X
=
Vi ps (Xi ; δn )l (Iis − Ii ) +
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii .
nδn
nδn
i=1

i=1

87

P
We first consider nδ1n ni=1 Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii . By using the argument in the proof
of Step C.6.3.3 in Section C.6.3, we have
|E[
=
≤

n
1 X
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii ]|
nδn

i=1
−1
δn |E[E[Vi |Xi ]E[ps (Xi ; δn )l − pM L (Xi ; δn )l |Xi ]Ii ]|
δn−1 E[|E[Vi |Xi ]||E[ps (Xi ; δn )l − pM L (Xi ; δn )l |Xi ]|Ii ]

Z

1

Z

=
∂Ω∗ ∩N (X ,δ̃)

−1

|E[Vi |Xi = u + δn vνΩ∗ (u)]||E[ps (u + δn vνΩ∗ (u); δn )l − pM L (u + δn vνΩ∗ (u); δn )l ]|
∗

∂Ω
× fX (u + δn vνΩ∗ (u))Jp−1
ψΩ∗ (u, δn v)dHp−1 (u)dv,

where the choice of δ̃ is as in the proof of Step C.6.3.3. By Lemma B.7, for l = 0, 1, 2,
n
1 X
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii ]|
nδn
i=1
Z 1Z
1
∂Ω∗
|E[Vi |Xi = u + δn vνΩ∗ (u)]|fX (u + δn vνΩ∗ (u))Jp−1
≤
ψΩ∗ (u, δn v)dHp−1 (u)dv
Sn −1 ∂Ω∗ ∩N (X ,δ̃)

|E[

= O(Sn−1 ).
Also, by Lemma B.7,
|E[

n
1 X
Vi (ps (Xi ; δn )3 − pM L (Xi ; δn )3 )Ii ]|
nδn

i=1
−1
= |δn E[Vi (ps (Xi ; δn ) − pM L (Xi ; δn ))(ps (Xi ; δn )2 + ps (Xi ; δn )pM L (Xi ; δn ) + pM L (Xi ; δn )2 )Ii ]|
≤ δn−1 E[|E[Vi |Xi ]||E[(ps (Xi ; δn ) − pM L (Xi ; δn ))(ps (Xi ; δn )2 + ps (Xi ; δn )pM L (Xi ; δn ) + pM L (Xi ; δn )2 )|Xi ]|Ii ]
≤ 3δn−1 E[|E[Vi |Xi ]|E[|ps (Xi ; δn ) − pM L (Xi ; δn )||Xi ]Ii ]
Z 1Z
=
|E[Vi |Xi = u + δn vνΩ∗ (u)]|E[|ps (u + δn vνΩ∗ (u); δn ) − pM L (u + δn vνΩ∗ (u); δn )|]
∗
−1 ∂Ω ∩N (X ,δ̃)
∂Ω∗
× fX (u + δn vνΩ∗ (u))Jp−1
ψΩ∗ (u, δn v)dHp−1 (u)dv

≤(

1
+ )O(1)
Sn 2

for every  > 0. We can make the right-hand side arbitrarily close to zero by taking suffiP
ciently small  > 0 and sufficiently large Sn , which implies that |E[ nδ1n ni=1 Vi (ps (Xi ; δn )3 −
pM L (Xi ; δn )3 )Ii ]| = o(1) if Sn → ∞. Likewise,
|E[
=
≤
≤

n
1 X
Vi (ps (Xi ; δn )4 − pM L (Xi ; δn )4 )Ii ]|
nδn

i=1
−1
|δn E[Vi (ps (Xi ; δn )2 + pM L (Xi ; δn )2 )(ps (Xi ; δn ) + pM L (Xi ; δn ))(ps (Xi ; δn ) − pM L (Xi ; δn ))Ii ]|
δn−1 E[|E[Vi |Xi ]||E[(ps (Xi ; δn )2 + pM L (Xi ; δn )2 )(ps (Xi ; δn ) + pM L (Xi ; δn ))(ps (Xi ; δn ) − pM L (Xi ; δn ))|Xi ]|Ii ]
8δn−1 E[|E[Vi |Xi ]|E[|ps (Xi ; δn ) − pM L (Xi ; δn )||Xi ]Ii ]

= o(1).
88

As for variance, for l = 0, 1, 2,
Var(

n
1 X
1 −1
δ E[Vi2 (ps (Xi ; δn )l − pM L (Xi ; δn )l )2 Ii ]
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii ) ≤
nδn
nδn n
i=1

1 −1
δ E[E[Vi2 |Xi ]E[(ps (Xi ; δn )l − pM L (Xi ; δn )l )2 |Xi ]Ii ]
nδn n
4
≤
δ −1 E[E[Vi2 |Xi ]Ii ]
nδn Sn n
= O((nδn Sn )−1 ),
≤

and for l = 3, 4,
Var(

n
1 X
1 −1
δ E[Vi2 (ps (Xi ; δn )l − pM L (Xi ; δn )l )2 Ii ]
Vi (ps (Xi ; δn )l − pM L (Xi ; δn )l )Ii ) ≤
nδn
nδn n
i=1

1 −1
δ E[Vi2 Ii ]
nδn n
= o(1).

≤

√
nδn

We

Pn

s
l
M L (X ; δ )l )I = o (1) if S → ∞ for l = 0, 1, 2, 3, 4, and
i n
i
p
n
i=1 Vi (p (Xi ; δn ) − p
s
l
M
L
l )I = o (1) if n−1/2 S → ∞ for l = 0, 1, 2.
V
(p
(X
;
δ
)
−
p
(X
;
δ
)
i n
i n
i
p
n
i=1 i
1 Pn
s
l
s
next show that nδn i=1 Vi p (Xi ; δn ) (Ii − Ii ) = op (1) if Sn → ∞ for l ≥ 0. We have

Therefore,
1 Pn

|E[

1
nδn

n
1 X
Vi ps (Xi ; δn )l (Iis − Ii )]| = δn−1 |E[Vi ps (Xi ; δn )l (Iis − Ii )]|
nδn
i=1

≤ δn−1 E[|E[Vi |Xi ]||E[ps (Xi ; δn )l (Iis − Ii )|Xi ]|]
= δn−1 E[|E[Vi |Xi ]|E[|Iis − Ii ||Xi ]].
Since Iis − Ii ≤ 0 with strict inequality only if Ii = 1,
E[|Iis − Ii ||Xi ] = −E[Iis − Ii |Xi ]Ii = (1 − E[Iis |Xi ])Ii = Pr(ps (Xi ; δn ) ∈ {0, 1}|Xi )Ii .
We then have
n
1 X
|E[
Vi ps (Xi ; δn )l (Iis − Ii )]|
nδn
≤
≤

i=1
−1
δn E[|E[Vi |Xi ]| Pr(ps (Xi ; δn ) ∈ {0, 1}|Xi )Ii ]
δn−1 E[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn )Ii ]

Z

1

Z

|E[Vi |Xi = u + δn vνΩ∗ (u)]|{(1 − pM L (u + δn vνΩ∗ (u); δn ))Sn

≤
−1

∂Ω∗ ∩N (X ,δ̃)
ML

+p

∗

∂Ω
(u + δn vνΩ∗ (u); δn )Sn }fX (u + δn vνΩ∗ (u))Jp−1
ψΩ∗ (u, δn v)dHp−1 (u)dv,

where the second inequality follows from Lemma B.7. Note that for every (u, v) ∈ ∂Ω∗ ∩N (X , δ̃)×
(−1, 1), limδ→0 pM L (u + δn vνΩ∗ (u); δn ) = k(v) ∈ (0, 1) by Step C.6.3.1 in Section C.6.3. Since
∂Ω∗ ψ ∗ are bounded, by the Bounded Convergence Theorem,
E[Vi |Xi ], fX and Jp−1
Ω
n
1 X
Vi ps (Xi ; δn )l (Iis − Ii )]| = o(1)
|E[
nδn
i=1

89

if Sn → ∞.
As for variance,
Var(

n
1 X
1 −1
δ E[Vi2 ps (Xi ; δn )2l (Iis − Ii )2 ]
Vi ps (Xi ; δn )l (Iis − Ii )) ≤
nδn
nδn n
i=1

1 −1
δ E[Vi2 |Iis − Ii |]
nδn n
1 −1
=
δ E[E[Vi2 |Xi ]E[|Iis − Ii ||Xi ]]
nδn n
= o(1).
≤

Lastly, we show that, for l ≥ 0,
holds. Let ηn =

n
γ log
Sn ,

√1
nδn

Pn

i=1 Vi p

s (X ; δ )l (I s
i n
i

− Ii ) = op (1) if Assumption 5

where γ is the one satisfying Assumption 5. We have

n

1 X
|E[ √
Vi ps (Xi ; δn )l (Iis − Ii )]|
nδn i=1
q
≤ nδn−1 E[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn )Ii ]
q
= nδn−1 E[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn ))1{pM L (Xi ; δn ) ∈ (0, ηn ) ∪ (1 − ηn , 1)}]
q
+ nδn−1 E[|E[Vi |Xi ]|((1 − pM L (Xi ; δn ))Sn + pM L (Xi ; δn )Sn ))1{pM L (Xi ; δn ) ∈ (ηn , 1 − ηn )}]
q
≤(
sup
|E[Vi |Xi = x]|)( nδn−1 Pr(pM L (Xi ; δn ) ∈ (0, ηn ) ∪ (1 − ηn , 1))
x∈N (∂Ω∗ ,2δ̃)∩N (X ,2δ̃)

+2

p
nδn (1 − ηn )Sn δn−1 E[1{pM L (Xi ; δn ) ∈ (ηn , 1 − ηn )}]).

p
By Assumption 5, nδn−1 Pr(pM L (Xi ; δn ) ∈ (0, ηn ) ∪ (1 − ηn , 1)) = o(1). For the second term,
p
p
2 nδn (1 − ηn )Sn δn−1 E[1{pM L (Xi ; δn ) ∈ (ηn , 1 − ηn )}] ≤ 2 nδn (1 − ηn )Sn δn−1 E[Ii ]
p
= 2 nδn (1 − ηn )Sn O(1).
n
log n
1
−1/2 S → ∞ and
Observe that ηn = γ log
n
Sn = γ n1/2 n−1/2 Sn → 0, since n
t
that e ≥ 1 + t for every t ∈ R, we have
p
p
nδn (1 − ηn )Sn ≤ nδn (e−ηn )Sn
p
= nδn e−ηn Sn
p
= nδn e−γ log n
p
= nδn n−γ

= n1/2−γ δn1/2
→ 0,

90

log n
n1/2

→ 0. Using the fact

since γ > 1/2. As for variance,
n
1 X
Var( √
Vi ps (Xi ; δn )l (Iis − Ii )) ≤ δn−1 E[Vi2 ps (Xi ; δn )2l (Iis − Ii )2 ]
nδn i=1

≤ δn−1 E[E[Vi2 |Xi ]E[|Iis − Ii ||Xi ]Ii ]
= o(1).

We have
β̂ s − β̂
n
n
n
n
1 X s s 0 s −1 1 X s s
1 X
1 X
=(
Zi (Di ) Ii )
Zi Yi Ii − (
Zi D0i Ii )−1
Zi Yi Ii
nδn
nδn
nδn
nδn
i=1

i=1

i=1

i=1

n
n
n
1 X s s 0 s −1 1 X s s
1 X
=(
Zi (Di ) Ii ) (
Zi Yi Ii −
Zi Yi Ii )
nδn
nδn
nδn
i=1

i=1

i=1

n
n
n
n
n
X
1 X s s 0 s −1 1 X s s 0 s
1 X
1 X
0
0
−1 1
−(
Zi (Di ) Ii ) (
Zi (Di ) Ii −
Zi Di Ii )(
Zi Di Ii )
Zi Yi Ii .
nδn
nδn
nδn
nδn
nδn
i=1
i=1
i=1
i=1
i=1
√
By Step C.6.4.1, β̂ s − β̂ = op (1) if Sn → ∞, and nδn (β̂ s − β̂) = op (1) if Assumption 5 holds.
By proceeding as in Step C.6.3.7 in Section C.6.3, we have
n
n
1 X s 2 s s 0 s
1 X s 2 s s 0 s
(ˆ
i ) Zi (Zi ) Ii =
(i ) Zi (Zi ) Ii + op (1),
nδn
nδn
i=1

where

si

= Yi −

(Dsi )0 β.

i=1

Then, by Step C.6.4.1,

n
n
1 X 2
1 X s 2 s s 0 s
(ˆ
i ) Zi (Zi ) Ii −
i Zi Z0i Ii
nδn
nδn

=

1
nδn

i=1
n
X

i=1

(Yi2 − 2Yi (Dsi )0 β + β 0 Dsi (Dsi )0 β)Zsi (Zsi )0 Iis −

i=1

n
1 X 2
(Yi − 2Yi D0i β + β 0 Di D0i β)Zi Z0i Ii + op (1)
nδn
i=1

= op (1)
so that

n
1 X s 2 s s 0 s p
(ˆ
i ) Zi (Zi ) Ii −→ V.
nδn
i=1

Also,

C.7

1
nδn

Pn

s
s 0 s
i=1 Zi (Di ) Ii

p

−→ SD by using Step C.6.4.1. The conclusion then follows.

Proof of Proposition A.2

We can prove Part (a) using the same argument in the proof of Proposition 1 (a). For Part (b),
suppose to the contrary that there exists xd ∈ XdA such that Lpc ({xc ∈ XcA (xd ) : pM L (xd , xc ) ∈
{0, 1}}) > 0. Without loss of generality, assume Lpc ({xc ∈ XcA (xd ) : pM L (xd , xc ) = 1}) > 0.
The proof proceeds in five steps.
91

Step C.7.1. Lpc (XcA (xd ) ∩ Xc,1 (xd )) > 0.
Step C.7.2. XcA (xd ) ∩ int(Xc,1 (xd )) 6= ∅.
Step C.7.3. pM L (xd , xc ) = 1 for any xc ∈ int(Xc,1 (xd )).
Step C.7.4. For every x∗c ∈ XcA (xd ) ∩ int(Xc,1 (xd )), there exists δ > 0 such that B(x∗c , δ) ⊂
XcA (xd ) ∩ int(Xc,1 (xd )).
Step C.7.5. E[Y1i − Y0i |Xi ∈ A] is not identified.
Following the argument in the proof of Proposition 1 (b), we can prove Steps C.7.1–C.7.3. Once
Step C.7.4 is established, we prove Step C.7.5 by following the proof of Step C.1.4 in Proposition
1 (b) with B(x∗c , δ) and B(x∗c , ) in place of B(x∗ , δ) and B(x∗ , ), respectively, using the fact
that Pr(Xci ∈ B(x∗c , )|Xdi = xd ) > 0 by the definition of support. Here, we provide the proof
of Step C.7.4.
Proof of Step C.7.4. Pick an x∗c ∈ XcA (xd ) ∩ int(Xc,1 ). Then, x∗ = (xd , x∗c ) ∈ A. Since A
is open relative to X , there exists an open set U ∈ Rp such that A = U ∩ X . This implies that
for any sufficiently small δ > 0, B(x∗ , δ) ∩ X ⊂ U ∩ X = A. It then follows that {xc ∈ Rpc :
(xd , xc ) ∈ B(x∗ , δ) ∩ X } ⊂ {xc ∈ Rpc : (xd , xc ) ∈ A}, equivalently, B(x∗c , δ) ∩ Xc (xd ) ⊂ XcA (xd ).
By choosing a sufficiently small δ > 0 so that B(x∗c , δ) ⊂ int(Xc,1 (xd )) ⊂ Xc (xd ), we have
B(x∗c , δ) ⊂ XcA (xd ) ∩ int(Xc,1 (xd )).

C.8

Proof of Theorem A.1

The proof is analogous to the proof of Theorem 1. The only difference is that, when we prove the
convergence of expectations, we show the convergence of the expectations conditional on Xdi ,
and then take the expectations over Xdi .

D

Machine Learning Simulation: Details

Parameter Choice. For the variance-covariance matrix Σ of Xi , we first create a 100 × 100
symmetric matrix V such that the diagonal elements are one, Vij is nonzero and equal to
Vji for (i, j) ∈ {2, 3, 4, 5, 6} × {35, 66, 78}, and everything else is zero. We draw values from
Unif(−0.5, 0.5) independently for the nonzero off-diagonal elements of V. We then create matrix
Σ = V × V, which is a positive semidefinite matrix.
For α0 and α1 , we first draw α̃0j , j = 51, ..., 100, from Unif(−100, 100) independently
across j, and draw α̃1j , j = 1, ..., 100, from Unif(−150, 200) independently across j. We then
set α̃0j = α̃1j for j = 1, ..., 50, and calculate α0 and α1 by normalizing α̃0 and α̃1 so that
Var(Xi0 α0 ) = Var(Xi0 α1 ) = 1.
Training of Prediction Model. We first randomly split the sample {(Ỹi , X̃i , D̃i , Z̃i )}ñi=1 into
train (80%) and test datasets (20%). We use random forests on the training sample to obtain
92

the prediction model µz and validate its performance on the test sample. The trained algorithm
has an accuracy of 97% on the test data.

E
E.1

Empirical Policy Application: Details
Hospital Cost Data

We use publicly available Healthcare Cost Report Information System (HCRIS) data,40 to
project41 safety net eligibility and funding amounts for all hospitals in the dataset. This data
set contains information on various hospital characteristics including utilization, number of employees, medicare cost data and financial statement data.
The data is available from financial year 1996 to 2019. As the coverage is higher for 2018
(compared to 2019), we utilize the data corresponding to the 2018 financial year. Hospitals are
uniquely identified in a financial year by their CMS (Center for Medicaid and Medicare Services)
Certification Number. We have data for 4,705 providers for the 2018 financial year. We focus
on 4,648 acute care and critical access hospitals that are either located in one of the 50 states or
Washington DC.

Disproportionate patient percentage
Disproportionate patient percentage is equal to the percentage of Medicare inpatient days attributable to patients eligible for both Medicare Part A and Supplemental Security Income (SSI)
summed with the percentage of total inpatient days attributable to patients eligible for Medicaid
but not Medicare Part A.42 In the data, this variable is missing for 1560 hospitals. We impute
the disproportionate patient percentage to 0 when it is missing.

Uncompensated care per bed
Cost of uncompensated care refers to the care provided by the hospital for which no compensation
was received from the patient or the insurer. It is the sum of a hospital’s bad debt and the
financial assistance it provides.43 The cost of uncompensated care is missing for 86 hospitals,
which we impute to 0. We divide the cost of uncompensated care by the number of beds in the
hospital to obtain the cost per bed. The data on bed count is missing for 15 hospitals, which we
drop from the analysis, leaving us with 4,633 hospitals in 2,473 counties.
40

We use the RAND cleaned version of this dataset, which can be accessed https://www.hospitaldatasets.
org/
41
We use the methodology detailed in the CARE ACT website to project funding based on 2018 financial year
cost reports.
42
For the precise definition, see https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/
AcuteInpatientPPS/dsh.
43
The
precise
definition
can
be
found
at
https://www.aha.org/fact-sheets/
2020-01-06-fact-sheet-uncompensated-hospital-care-cost.

93

Profit Margin
Hospital profit margins are indicative of the financial health of the hospitals. We calculate profit
margins as the ratio of net income to total revenue where total revenue is the sum of net patient
revenue and total other income. After the calculation, profit margins are missing for 92 hospitals,
which we impute to 0.

Funding
We calculate the projected funding using the formula on the CARES ACT website. Hospitals that
do not qualify on any of the three dimensions are not given any funding. Each eligible hospital
is assigned an individual facility score, which is calculated as the product of disproportionate
patient percentage and number of beds in that hospital. We calculate cumulative facility score
as the sum of all individual facility scores in the dataset. Each hospital receives a share of $10
billion, where the share is determined by the ratio of individual facility score of that hospital to
the cumulative facility score. The amount of funding received by hospitals is bounded below at
$5 million and capped above at $50 million.

E.2

Hospital Utilization Data

We use the publicly available COVID-19 Reported Patient Impact and Hospital Capacity by
Facility dataset for our outcome variables. This provides facility level data on hospital utilization
aggregated on a weekly basis, from July 31st onwards. These reports are derived from two
main sources – (1) HHS TeleTracking and (2) reporting provided directly to HHS Protect by
state/territorial health departments on behalf of health care facilities.44
The hospitals are uniquely identified for a given collection week (which goes from Friday to
Thursday) by their CMS Certification number. All hospitals that are registered with CMS by
June 1st 2020 are included in the population. We merge the hospital cost report data with the
utilization data using the CMS certification number. According to the terms and conditions of
the CARES Health Care Act, the recipients may use the relief funds only to “prevent, prepare
for, and respond to coronavirus” and for “health care related expenses or lost revenues that
are attributable to coronavirus”. Therefore, for our analysis we focus on 4 outcomes that were
directly affected by COVID-19, for the week spanning July 31st to August 6th 2020. The outcome
measures are described below.
1. Total reports of patients currently hospitalized in an adult inpatient bed who have laboratoryconfirmed or suspected COVID-19, including those in observation beds reported during the
7-day period.
2. Total reports of patients currently hospitalized in an adult inpatient bed who have laboratoryconfirmed COVID-19 or influenza, including those in observation beds. Including patients
who have both laboratory-confirmed COVID-19 and laboratory confirmed influenza during
the 7-day period.
44

Source:
anag-cw7u.

https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/

94

3. Total reports of patients currently hospitalized in a designated adult ICU bed who have
suspected or laboratory-confirmed COVID-19.
4. Total reports of patients currently hospitalized in a designated adult ICU bed who have
laboratory-confirmed COVID-19 or influenza, including patients who have both laboratoryconfirmed COVID-19 and laboratory-confirmed influenza.
In the dataset, when the values of the 7 day sum are reported to be <4, they are replaced with
-999,999. We recode these values to missing.

E.3

Computing Quasi Propensity Score

As the three determinants of safety net eligibility are continuous variables, we can think of this
setting as a multi-dimensional regression discontinuity design and a suitable setting to apply our
method. In this setting, the Xi are disproportionate patient percentage, uncompensated care
per bed and profit margin. Funding eligibility (Zi ) is determined algorithmically using these 3
dimensions. Di is the amount of funding received by hospital i, which depends on both safety
net eligibility status Zi , number of beds in the hospital, and disproportionate patient percentage.
Before calculating QPS, we normalize each characteristic of Xi to have mean 0 and variance 1.
For each hospital and every δ ∈ {0.01, 0.025, 0.05, 0.075, 0.1, 0.25, 0.5}, we draw 1000 times from
a δ-ball around the normalized covariate space and calculate QPS by averaging funding eligibility
Zi over these draws.

95

