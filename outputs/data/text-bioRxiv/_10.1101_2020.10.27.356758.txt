bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

A skyline birth-death process for inferring the population size from a
reconstructed tree with occurrences
Jérémy Andréoletti*, Antoine Zwaans*,
Rachel C. M. Warnock, Gabriel Aguirre-Fernández, Joëlle Barido-Sottani,
Ankit Gupta, Tanja Stadler, Marc Manceau
October 27, 2020

Affiliations :
Department of Biosystems Science and Engineering, ETH Zürich, Basel, Switzerland
GeoZentrum Nordbayern, Friedrich-Alexander-Universität Erlangen-Nürnberg, Germany
Paleontological Institute and Museum, University of Zürich, Zürich, Switzerland
Department of Ecology, Evolution and Organismal Biology, Iowa State University, Ames, USA
Keywords :
skyline birth-death process; epidemiology; macroevolution; phylogenetics; fossils
Abstract
Phylodynamic models generally aim at jointly inferring phylogenetic relationships, model parameters, and
more recently, population size through time for clades of interest, based on molecular sequence data. In the
fields of epidemiology and macroevolution these models can be used to estimate, respectively, the past number of
infected individuals (prevalence) or the past number of species (paleodiversity) through time. Recent years have
seen the development of “total-evidence” analyses, which combine molecular and morphological data from extant
and past sampled individuals in a unified Bayesian inference framework. Even sampled individuals characterized
only by their sampling time, i.e. lacking morphological and molecular data, which we call occurrences, provide
invaluable information to reconstruct past population sizes.
Here, we present new methodological developments around the Fossilized Birth-Death Process enabling us to
(i) efficiently incorporate occurrence data while remaining computationally tractable and scalable; (ii) consider
piecewise-constant birth, death and sampling rates; and (iii) reconstruct past population sizes, with or without
knowledge of the underlying tree. We implement our method in the RevBayes software environment, enabling
its use along with a large set of models of molecular and morphological evolution, and validate the inference
workflow using simulations under a wide range of conditions.
We finally illustrate our new implementation using two empirical datasets stemming from the fields of epidemiology and macroevolution. In epidemiology, we apply our model to the Covid-19 outbreak on the Diamond
Princess ship. We infer the total prevalence throughout the outbreak, by taking into account jointly the case
count record (occurrences) along with viral sequences for a fraction of infected individuals. In macroevolution,
we present an empirical case study of cetaceans. We infer the diversity trajectory using molecular and morphological data from extant taxa, morphological data from fossils, as well as numerous fossil occurrences. Our case
studies highlight that the advances we present allow us to further bridge the gap between between epidemiology
and pathogen genomics, as well as paleontology and molecular phylogenetics.

1

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

1

Introduction

Birth-death processes are stochastic processes used to model population dynamics with two main parameters, the
birth rate and the death rate, which are respectively the rate at which new individuals appear, and the rate at
which individuals are removed from the process. In macroevolution, these two rates correspond to the speciation
and extinction rates, while in epidemiology they correspond to the transmission and recovery rates. These processes
already enjoy a long history of applications in evolutionary biology. In the first half of the twentieth century, Yule
(1925) introduces them in the field with macroevolutionary applications in mind, to model the number of species
within genera. Kendall (1948) then derives analytically the transition probabilities for linear birth-death processes,
and discusses their use in the context of evolutionary biology, with a special focus on epidemiology. Ground-breaking
work by Nee et al. (1994) followed on the probability density of the reconstructed tree in a linear birth-death process,
i.e. the tree obtained by pruning all extinct lineages from the full genealogical history of the process (see Fig. 1A).
The linear birth-death process was then later extended to allow rates to vary in different parts of the tree (Alfaro
et al. 2009), over time (Morlon et al. 2011), or depending on some character of interest (Maddison et al. 2007).
Although diversification histories inferred from extant species sometimes agree with those inferred from the fossil
record (Morlon et al. 2011; Xing et al. 2014; Silvestro et al. 2018), there largely remains a gap between these two
approaches in macroevolution (Marshall 2017). On the one hand, extant species provide invaluable information
regarding the dynamics of the diversification process, especially close to the present. On the other hand, the fossil
record, albeit scarce, could much better inform extinction estimates (Quental and Marshall 2010). An extension
introduced by Stadler (2010) and dubbed the Fossilized Birth-Death Process (FBD) (Heath et al. 2014) has allowed
us to model jointly extant and extinct taxa along the same tree, and thus helped bridge the gap between paleontology
and molecular phylogenetics. In this model, each species can be sampled throughout its lifetime at a fixed rate,
and appear in the reconstructed tree (see Fig. 1B). The probability density of the resulting phylogeny is derived in
closed-form, and has been successfully used as a prior in Bayesian phylodynamic analyses to study the diversification
history of hymenopterans (Zhang et al. 2015), as well as the penguins (Gavryushkina et al. 2016). The same model
was also used in the context of epidemiology, where infected individuals can as well be sampled throughout the
infectious period and appear in the reconstructed tree Stadler et al. (2013). Finally, model extensions have been
introduced to help take into account the age of species (i.e. stratigraphic ranges) or, in the context of epidemiology,
an extended period of infection (Stadler et al. 2018).
An important feature of many standard paleontological datasets, is that only a fraction of fossils have been
thoroughly described and are associated with morphological data. Similarly, in standard epidemiological surveys,
only a fraction of the recorded case count data is typically sequenced. In this paper, we call samples with character
data the subset of samples with either morphological data or molecular data, and occurrences the recorded samples
without character data. This data, while providing no useful information regarding the topology of the tree,
still contain invaluable information regarding the underlying population size (see Fig. 1C). For this reason, they
have long been used in paleontology to infer diversity trajectories (Raup 1972; Sepkoski et al. 1981), and even
preservation, origination and extinction rates in an alternative Bayesian setting (Silvestro et al. 2014, 2019). Some
authors have analyzed occurrences in the standard FBD-based Bayesian framework, considering them as leaves in
the tree with missing character data, and integrating over the unknown topology (Heath et al. 2014; Gavryushkina
et al. 2014; O’Reilly and Donoghue 2020). However, in the event both samples with character data and occurrence
data are available, applying the standard FBD model requires making the assumption that both sets of data were
generated under the same process and with the same rate. A second step towards integrating these occurrences was
performed by Vaughan et al. (2019), who explicitly modeled an additional sampling process for occurrences, allowing
for the joint analysis of the observation of a phylogeny and a record of occurrences (see Fig. 1D). Vaughan et al.
(2019) additionally proposed an inference framework based on the use of a particle filter to compute the likelihood.
Rasmussen et al. (2011) presents another method based on a particle filtering algorithm to consider occurrences and
trees in tandem, although in a coalescent framework instead of a birth-death framework. Gupta et al. (2019) built
on previous work by Vaughan et al. (2019) and described soon after a fast algorithm to compute the likelihood of
the data, focusing on a special case of the model where all individuals sampled through time are removed from the
process upon sampling. Finally, under the same model assumptions, Manceau et al. (2019) presented a method to
compute the population size distribution conditioned on a reconstructed tree and a record of occurrences.
In this paper, we extend these last two methods to include piecewise-constant parameters, allowing us to
explicitly incorporate known variation in birth, death and sampling rates through time. We implement our work
as a new distribution, coined the Occurrence Birth Death Process (OBDP), available in the Bayesian phylogenetic

2

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

a)

e)

Death
Reconstructed tree from
extant and past individuals,
with sampled occurrences

Root
Origin
Reconstructed
tree from
extant individuals

Reconstructed tree from
extant and past individuals

b)

Sampled
occurrences

Birth
Present

c)

d)

+

Figure 1: Different approaches to infer past history and population sizes. a) The full unknown history of the population. Different types of data can be used in order to infer the past history and population sizes of the population.
b) Genetic sequencing data and character data for present day individuals allows to infer the reconstructed phylogenetic tree and to estimate the past number of lineages. c) This tree can be enriched with past individuals with
documented character data (either morphological or molecular data), adding information on some extinct lineages
(red). d) Past population sized can be obtained from sampled occurrences alone. Finally, e) A more comprehensive
total evidence method integrates extant genetic sequences, samples with character data and the occurrences in a
unified framework.
software RevBayes (Höhna et al. 2016) to compute the joint probability density of a tree and a record of occurrences.
This can readily be used to sample the posterior of trees and population sizes through time, given an observed record
of occurrences and a list of samples with character data attached. We illustrate the versatility of the method on
two empirical datasets coming from the fields of epidemiology and macroevolution. In epidemiology, we infer
the prevalence through time for the Covid-19 outbreak on the Diamond Princess cruise ship, based on the joint
observation of molecular sequences and case count data. In macroevolution, we infer the diversity through time in
the Cetacean clade, based on the joint observation of molecular data for extant species, morphological character
data for some fossils and some extant species, and the record of fossil occurrences available on the Paleobiology
Database.

2

Material and methods

2.1

Phylodynamic model

We consider that a population of individuals starts at the time of origin tor with one individual, and evolves
through time under a birth-death process with piecewise constant birth rate, λt , and death rate, µt . Three different
sampling schemes are successively applied along the process. First, individuals can be sampled through time and be
included in the tree, with piecewise-constant sampling rate ψt . Second, they can be sampled through time as raw
occurrences not included in the tree, with piecewise-constant sampling rate ωt . Third, individuals reaching present
time are included in the tree with a fixed probability ρ. Finally, upon sampling, individuals are removed with a
piecewise-constant probability of removal rt .
As a result of these three sampling steps, we observe a reconstructed tree T , which is the tree spanning all

3

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Table 1: Parameters and objects of the Occurrence Birth-Death Process.
Parameter
tor
λ
µ
ψ
ω

Signification
Time of origin
Speciation rate
Extinction rate
Fossil sampling rate
Occurrence sampling rate

Object
T
O
It
kt
i

r

Removal probability at sampling

(Ot↑ , Tt↑ )

ρ

Sampling probability at present

(Ot↓ , Tt↓ )

Signification
Reconstructed tree
Record of occurrence times
Total number of lineages
Number of sampled lineages
Number of hidden lineages
Occurrences and tree
before time t
Occurrences and subtrees
after time t

ψ-sampled and ρ-sampled individuals, as well as a record of occurrences O, which is a timeline recording successive
ω-sampling events. We aim at (i) computing the probability density of (T , O), which will play the role of the
phylodynamic likelihood in our Bayesian framework, and (ii) compute the probability distribution of the total
number of lineages in the process at time t, It , conditioned on the observed (T , O). Note that the number of
lineages in T at time t, denoted kt , is an obvious lower-bound of the total number of individuals in the process
at time t, It . For this reason, we are targeting the probability distribution P(It = kt + i), where i stands for the
number of hidden individuals.
In Appendix A, we extend the method introduced by Manceau et al. (2019) to include piecewise-constant
parameters in computing two quantities. First, defining (Tt↑ , Ot↑ ) as the tree and record of occurrences constrained
to [t, tor ], we aim at numerically computing the joint probability of the partial tree and occurrence record between
time t and the origin, and the total number of lineages at time t,


(i)
∀i ∈ N, Mt := P Tt↑ , Ot↑ , It = kt + i
(2.1)
P
(i)
which can be used to compute, upon reaching present day t = 0, P(T , O) = i M0 .
Second, defining (Tt↓ , Ot↓ ) as the tree and record of occurrences constrained to [0, t], we aim at numerically computing
the probability of the partial tree and occurrence record between time t and the present, conditioned on the total
number of lineages at time t,


(i)
∀i ∈ N, Lt := P Tt↓ , Ot↓ | It = kt + i
(2.2)
(0)

which can as well be used to compute, upon reaching the time of origin tor , P(T , O) = Ltor .
We derive initializing conditions and Master equations governing the evolution of Mt and Lt through time and
compute these quantities by numerically evaluating the system ordinary differential equations (Appendix A). Note
that in this numerical evaluation, we have to make one approximation namely, assume a maximal population size
N (while in theory the population size may become arbitrarily large). In practice, N must be chosen large enough
to cover most of the high-density support of the Lt and Mt probability distributions to avoid biasing calculations.
Finally, provided we know both quantities at time t, the probability distribution Kt of the total number of individuals
living at time t is given by,
(i)

Kt

:= P(It = kt + i | T , O)
∝ P(It = kt + i, Tt↑ , Ot↑ , Tt↓ , Ot↓ )
∝ P(Tt↓ , Ot↓ | It = kt + i, Tt↑ , Ot↑ )P(It = kt + i, Tt↑ , Ot↑ )
(i)

(i)

∝ Lt Mt

(2.3)

where the last equality is due to the Markov property of the process. We summarize all the notation introduced
above in Table 1.

2.2

Bayesian inference framework

We consider a Bayesian inference framework with additional model layers for character data evolution along the
reconstructed tree T . For epidemiology applications, we superimpose a model of molecular evolution, leading to
4

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

the observation of a sequence alignment for both extant and extinct taxa in T . For macroevolution applications,
we superimpose (i) a model of morphological evolution, leading to the observation of character data for both extant
and extinct taxa in T , and (ii) a model of molecular evolution, leading to the observation of a sequence alignment
for extant taxa only. Summarizing all (molecular and morphological) character data together as A, and all model
parameters as θ, the target posterior distribution of reconstructed trees T and model parameters θ can be written as
the product of the phylodynamic likelihood, the likelihood of character data given T and θ, and prior probabilities:
P(T , θ|O, A) ∝ P(T , O|θ)P(A|T , θ)P(θ) .

(2.4)

First, we sample this posterior distribution using a Metropolis-Hastings MCMC. Second, the posterior probability
distribution of the ancestral population size can be written as,
Z
P(It |A, O) =
P(It |T , O, θ)dP(T , θ|O, A)
(2.5)
T ,θ

and is thus numerically computed as the arithmetic mean of Kt over the trace of the posterior of (T , θ).

2.3

Numerical implementation

We implement our model in RevBayes (Höhna et al. 2016, 2017), an open-source software for Bayesian inference in
phylogenetics. RevBayes is fully based on graphical models (Höhna et al. 2014), a unified framework for representing
complex probabilistic models in the form of graphs where nodes correspond to model variables and edges of their
probabilistic relationships. It allows the user to construct interactively their own phylogenetic graphical model in
the Rev language, by combining the hundreds of available models of nucleotide substitution, rate variation across
sites and along the tree, and tree priors proposed in the literature (see Supp Fig. S6B for an illustration with our
model). Our three key additions consist of (i) introducing the OBDP distribution (Supp Fig S6A) into RevBayes,
so that everyone can use it with their own graphical models; (ii) implementing the core algorithms responsible
for computing the quantities Lt and Mt through time and eventually the final log-likelihood; and (iii) including a
function to generate the posterior probability distribution of the ancestral population size through time.
Figure 2 summarizes the full workflow to go from the raw data O, A to the inferred reconstructed tree T , model
parameters θ and diversity trajectories It .

Figure 2: Workflow for using the OBD model for diversity inference. One first needs to specify a graphical model
with priors and provide some empirical (molecular, morphological, occurrence) data. A MCMC is run to sample the
posterior distribution of trees and parameters. Finally, these traces are used to compute the posterior distribution
of diversity through time.

5

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

2.4
2.4.1

Validation of the method
Direct likelihood comparison.

We verify that the phylodynamic likelihood computed using Lt or Mt coincides with (i) previous RevBayes implementations (Höhna et al. 2017; Heath et al. 2019) of linear birth-death processes that are special cases of our
framework, when no occurrences are included and r = ω = 0, and (ii) an earlier Python implementation of the
likelihood with constant parameters (Manceau et al. 2019). We use a small fixed dataset and compute the likelihood
using (i), (ii) and our implementation, under a wide range of parameters which are listed in Figure 3.
2.4.2

Qualitative validation on simulated datasets

Time-forward simulations of two full OBD processes were performed to produce two datasets. On the first one
(dataset 1), we simulated morphological data for past samples, and both morphological and molecular data for
extant samples, mimicking a macroevolution scenario. On the second one (dataset 2), we simulated only molecular
data for all samples. Parameter values and the full model specifications are described in Supp Mat C. We used
the RevBayes implementation to infer back the parameter values along with the reconstructed tree and population
sizes. We performed this validation as a blind test, with two of us being in charge of conducting the analysis, and
remaining ignorant of the true simulated scenarios.
2.4.3

Quantitative validation of the MCMC implementation

We follow a procedure called Simulation-Based Calibration (Talts et al. 2018) for validating our MCMC implementation. It consists in the following three steps: (i) we define priors (Table 2) for all the involved parameters and
simulate 1000 parameter sets, trees with sampled fossils, occurrences and genetic sequences (100 nucleotides long);
(ii) for each simulated dataset, we use the same priors to infer the posterior distribution of reconstructed trees and
parameters; and (iii) we compute the proportion of datasets for which the true (simulated) parameter values fall
within a 100α% credible interval of the posterior distribution, for a range of α values (19 evenly spaced between
0.05 and 0.95). If the MCMC is correctly sampling the posterior distribution, the proportion of posterior credible
intervals recovering the truth should be close to α.
Table 2: Prior distributions of the OBDP parameters for the quantitative validation test. Notations: U for Uniform
distribution with given lower and upper bound, Exp for Exponential with given rate parameter. The model of
molecular evolution is the Jukes-Cantor 1969 substitution model (JC69) with strict clock hypothesis.
Parameter

tor

µ

λ−µ

r

ψ

ω

ρ

Mutation
rate

Prior or
Model

U(1, 5)

Exp(1)

Exp(100)

U(0, 1)

Exp(5)

Exp(5)

U(0.8, 1)

Exp(100)

2.5
2.5.1

Covid data analysis
Molecular and occurrence dataset

We use the model implementation with piecewise constant rates to perform a phylodynamic analysis of the SARSCoV-2 epidemic aboard the Diamond Princess cruise ship, a well-documented outbreak from February 2020. The
outbreak is an example of a closely monitored, geographically constrained closed population, and thus constitutes
an ideal case study of the disease dynamics and the mitigation policies undertaken (Mallapaty 2020).
The sequenced data used for this analysis consists of a set of 71 full length viral genomes collected between
February 15th and February 17th, all acquired from GISAID (Shu and McCauley 2017). Acknowledgements for
laboratories that contributed the genome sequences used in this analysis are given in Supp. Mat. E.1. All available
sequences were aligned to reference genome MN908947 and sites subject to low sequencing accuracy were masked.

6

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Following the standard NextStrain (Hadfield et al. 2018) pipeline, sites 13402, 24389 and 24390 as well as 150 bases
at the ends of the genomes were masked, thought to be sequencing artefacts that would bias the alignment.
In this example, we define occurrences as patients testing positive for SARS-CoV-2 using polymerase chainreaction (PCR) detection methods, recorded as case counts. These case counts, i.e. the daily reports of new cases,
along with the total number of samples tested were published by the Japanese Ministry of Work throughout the
outbreak; case counts were then compiled in the JHU CSSE database (Dong et al. 2020). Out of all 712 cases
detected amongst passengers, we focus on the 705 cases detected while guests were still aboard the cruise ship,
from the beginning of the cruise on January 20th until February 27th. Sequencing dates and case counts were
communicated as daily reports throughout the outbreak. For all report entries, exact dates were randomly assigned
to all occurrences within each day. Additionally, we shift dates by a day to account for the delay between sampling
and reporting of the PCR results. The full dataset, in its original and processed formats, is presented in Figure
S12.
2.5.2

Model assumptions

The model parametrisation allows us to examine two complementary aspects of the temporal change in epidemic
spread. First, we estimate the effective reproductive number across all time intervals of interest. The reproductive
number is the expected number of secondary cases produced by a single infected individual and is a standard
λ
. Second, we infer the corresponding prevalence
epidemiological parameter, quantified in our model as Re = µ+r(ω+ψ)
trajectories, aiming to gain insight into the number of potentially undetected patients that are thought to make up
a significant proportion of the infected population (Mizumoto et al. 2020).
To achieve these two goals, we make full use of the skyline implementation of our model by allowing independent
shifts for each rate parameter. In doing so, we closely follow the exact timeline of events of the outbreak. We first
incorporate information regarding the testing and sequencing procedures. The testing strategy was initiated by
Japanese authorities after a first guest was confirmed positive for SARS-CoV-2 on February 3rd. It was then
extended to asymptomatic passengers from February 11th onward. Sequencing of some of the viral samples was
then performed between February 15th and February 17th. To these 4 sampling parameters shifts, we additionally
introduce another shift for the birth rate λ before the start of mandatory cabin isolation, on February 5th, producing
the full timeline of m = 5 intervals.
Reports of the total number of samples tested were assembled to adjust prior means for ω + ψ on different time
intervals, and account for the extension of testing to asymptotic passengers. In total, testing efforts yielded 4066
samples over the entire period of interest, with 3622 of them being obtained after February 11th. All other settings
and priors used in this analysis are presented in detail in Supp. Table S7.

2.6
2.6.1

Cetacean data analysis
Context

Cetaceans are a group of marine mammals, represented by 89 living species, that possess a remarkable and wellstudied fossil record (Fordyce 2009). Their history can be summarized by three main phases (Marx et al. 2016),
(i) starting 53 Ma, a 10 Myr land-to-sea transition accompanied by drastic morphological transformations in the
archaeocetes (stem cetaceans), (ii) the emergence of neocetes (crown cetaceans, including filter-feeding mysticetes
and echolocating odontocetes) at the Eocene-Oligocene boundary ( 34 Ma) and their radiation up to a Mid-Miocene
peak ( 12 Ma) followed by (iii) a sharp decline in diversity in the last 4-6 Ma.
Several studies have already attempted to estimate the diversity trajectory of cetaceans, using the fossil record
(Uhen and Pyenson 2007), molecular phylogenies (Morlon et al. 2011) or both (Marx and Fordyce 2015); but even
the latter total-evidence study did not include all fossil occurrences in its analyses. The initial huge discrepancies
between the history inferred from the fossil record and from molecular phylogenies (Quental and Marshall 2010)
have been partially bridged, but including occurrences may help provide a more reliable time-calibrated tree and a
robust diversity trajectory estimation.

7

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

2.6.2

Molecular, morphological and occurrence datasets

The data can be subdivided in three parts: molecular, morphological, and occurrences. Datasets were collected
and analysed separately and are stored on the Open Science Framework (https://osf.io) (Aguirre-Fernández et al.
2020). Molecular data comes from Steeman et al. (2009), and comprises 6 mitochondrial and 9 nuclear genes, for 87
of the 89 accepted extant cetacean species. Morphological data was obtained from Churchill et al. (2018), the most
recent version of a widely-used dataset first produced by Geisler and Sanders (2003). After merging 2 taxa that
are now considered synonyms on the Paleobiology Database (PBDB) and removing 3 outgroups that would have
violated our model’s assumptions, it now contains 327 variable morphological characters for 27 extant and 90 fossil
taxa (mostly identified at the species level but 21 remain undescribed). In order to speed up the analysis we further
excluded the undescribed specimens and reduced this dataset to the generic level by selecting the most complete
specimen in each genera. Indeed, the computing cost increases quadratically with the maximum number of hidden
lineages N , to the point of becoming the bottleneck in our MCMC when N > 100. Given that a mid-Miocene peak
diversity between 100 and 220 species is expected (Quental and Marshall 2010), with less than 100 observed lineages
in our inferred tree at that time, N should therefore be about 150. Inferring instead the tree of cetacean genera
allows us to reduce N to 70 hidden lineages. The final dataset thus contains 41 extant and 62 extinct genera.
Occurrences come from the PBDB (data archive 9, M. D. Uhen) on May 11, 2020. The dataset initially consisted
of all 4678 cetacean occurrences, but the cetacean fossil record is known to be subject to several biases (Uhen and
Pyenson 2007; Marx et al. 2016; Dominici et al. 2020). A detailed exploration (see Supp. Mat. D) of this occurrence
dataset revealed several notable biases. First, an artefactual cluster of occurrences in very recent times, combined
with other expected Pleistocene biases (Dominici et al. 2020), led us to remove all Late Pleistocene and Holocene
occurrences. Second, we detected substantial variations in fossil recovery per time unit across lineages (see Supp.
Fig. S10) resulting from oversampling of some species and localities, possibly due to greater abundance or spatiotemporal biases (Dominici et al. 2020). This observation violates our assumption of identical fossil sampling rates
among taxa during a given interval. In order to reduce this bias, we retained occurrences identified at the genus
level and further aggregated all occurrences belonging to an identical genus found at the same geological formation.
Occurrences for which the geological formation was not specified, we used geoplate data combined with stratigraphic
interval. This resulted in a total of 968 occurrences retained for the analysis.
2.6.3

Model assumptions

Each fossil comes along with a stratigraphic age uncertainty interval. Reducing this interval to either the midpoint,
or a uniformly drawn point, has been shown to lead to serious biases in the divergence time estimates (BaridoSottani et al. 2019). We instead follow the same procedure as Heath et al. (2019) and apply a uniform prior for the
age of fossils with morphological characters, within the bounds of their stratigraphic age uncertainty. As a result,
the age of a fossil included in the tree can slide within this interval during the MCMC.
Based on previous work showing huge discrepancies in mutation rates between odontocetes and mysticetes
(Dornburg et al. 2012), and generally between nuclear and mitochondrial sequences (Allio et al. 2017) we partitioned
between the two types of sequences and considered a relaxed clock across the tree.
Much less biological knowledge is available about the dynamics of morphological characters (Wright 2019). We
thus chose a minimal substitution model and partitioned the alignment in order to treat separately characters that
are represented by a different number of states.
All prior distributions are fully detailed in Supp. Table S6.

8

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

3

Results

3.1
3.1.1

Validation of the method
Direct Likelihood Comparison

●

0.4

0.6

0.4

0.6

0.8

0.2

ρ

●

●

1.0

E

0.4

0.6

0.8

ψ

1.0

1.2

F

−35

−35

●

●

−30

D

−25

●

0.8

●

0.6

0.8

1.0

1.2

●

1.0

1.2

1.4

ω

●

●
●

1.8

0.4

0.6

µ

0.8

1.0

I

H
python_Lt
python_Mt
dnOBDP_Lt
dnOBDP_Mt

1.6

●

λ

G
With occurrences

●

●
●

●

0.4

−40

●

●

−45

−45

●

−55

−65 −60 −55 −50 −45 −40

Log−Likelihood

r

●

●

●

−60

●

●

−70

−45

●

●

0.2

−30
−50

●

−40

−45.6

−35

●

C

−40

−30

−45.2

B

−25

A

●

−25

●
●

−46.0

Log−Likelihood

−44.8

We illustrate in Figure 3 the perfect agreement with likelihood values computed using previous functions under a
wide range of parameters, for both Lt and Mt traversal algorithms.

Without occurrence
dnFBDP●
dnOBDP_Lt
dnOBDP_Mt

Figure 3: Validation of the likelihood calculation. Each parameter is varying (A-F) while keeping the others at their
baseline values (H) and evaluating the likelihood of the toy dataset (I) where pink dots are occurrences, blue dots at
past samples, and yellow dots are extant samples. Filled dots are removed samples, unfilled are not removed. For
all parameters (A-F), our RevBayes implementation is compared to the Python code provided in Manceau et al.
(2019) and whenever possible (B,C,E,F), to earlier FBDP implementations available in RevBayes, fixing r = 0,
ω = 0 and O = ∅.

3.1.2

Qualitative Validation on simulated datasets

On Figure 4, we superimpose the true, simulated, trajectory of the total number of individuals, together with the
inferred posterior distribution. Most importantly, the true trajectory falls within, or is very close to the boundaries,
of the 95% posterior credibility interval at any point in time.

9

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

On both datasets, the topology of the tree was also well recovered but divergence dates do not always perfectly
match (see Supp. Mat. Figure S9). Due to a greater amount of data in genetic sequences of both past and extant
individuals, the divergence dates have been better inferred on dataset 2 as compared to dataset 1.
A

B

Figure 4: Results of the blind test analysis. The posterior distribution of the number of lineages through time is
in green. The inferred LTT plot, showing the number of lineages in the tree through time, is in black. The true
simulated number of individuals is in red.

3.1.3

Quantitative Validation of the Diversity Inference

Figure 5 shows a good correspondence between the proportion of posterior credible intervals containing the true
parameter value and the width of the credible interval. This indicates that the MCMC is properly calibrated, i.e.
samples adequately the targeted posterior distribution.
µ

λ

ψ

ω

ρ

r

0.75
0.50
0.25

00

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

00

0.

00

0.

75

1.

50

0.

25

0.

0.

00

0.00

0.

Truth recovery
proportion

α
1.00

Credible interval width

Figure 5: Results of the Simulation-Based Calibration. Each dot corresponds to the proportion of simulated
parameters (y axis) falling within its inferred posterior credible interval with a given level (x axis). The black line
corresponds to the expected perfect match.

3.2

Reproductive number and prevalence in the Covid outbreak

Figure 6 shows the raw data, as well as the estimates of the total prevalence and reproductive number through
time. The instantaneous prevalence is typically always slightly lower than the total number of cases sampled each
day, which corresponds to the sum of all sampled (and likely removed) individuals over a one-day period. The
reproductive number is inferred with very high uncertainty in the beginning of the epidemic, when very few cases
were observed, and with a much higher precision in the second part of the process. It decreases synchronously with
the launching of non-pharmaceutical interventions in early February (i.e. testing effort and cabin quarantine).

10

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Figure 6: Analysis of the SARS-2 COVID-19 outbreak dynamics aboard the Diamond Princess cruise ship. (A)
Occurrence and sequenced data are plotted as daily new observations. Although passengers were monitored until
July 2020 (Ministry of Health and Welfare 2020), we focus on infections detected while guests were still aboard,
until the end of the harbour quarantine. (B) Posterior probability distribution of the instantaneous total infected
population aboard the cruise ship and inferred LTT. (C) Estimates of the effective reproductive number (Re )
throughout a 38 day period starting at the beginning of the cruise.

3.3

Total diversity in the Cetacean clade

Figure 7 shows the inferred diversity of cetacean genera over the past 50 Myr. The diversity curve indicates an
Early-Eocene origin followed by a monotonous diversification up to a first Mid-Miocene peak (12 Ma), before
reaching its maximum in the Pliocene (3.5 Ma) with almost 70 inferred genera. The last million years correspond
to a sharp decline leading to the 41 extant genera.

11

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Figure 7: Posterior probability distribution of the total number of genera over time. The 95% credible intervals
are indicated in dashed lines, the expected diversity is in green and the inferred LTT is in black. Periods of biotic
or abiotic factors that are hypothesized to have driven diversification changes are adapted from Marx and Fordyce
(2015) and shown in black for information but had no influence on the analysis. ACC = Antarctic Circumpolar
Current. Black dots below represent the occurrences used in the analysis.

4
4.1

Discussion
Technical achievements and limitations

In this paper, we extend the work of Gupta et al. (2019) and Manceau et al. (2019) to consider piecewise-constant
rates through time, and implement the Occurrence Birth-Death Process in the popular phylogenetic inference
software RevBayes. This enables us to simultaneously incorporate numerous occurrences without character data,
together with taxa for which we have genetic sequences and/or morphological characters. In addition to using the
OBDP as a tree prior for inferring epidemiological or macroevolutionary parameters, tree topology and divergence
dates, it allows users to compute the posterior probability distribution of the population size through time, in a
post-MCMC analysis (see workflow in Fig. 2). We validate the framework, both qualitatively and quantitatively,
and illustrate its use in the fields of epidemiology and macroevolution.
The likelihood computation can be very fast when lineages become extinct upon sampling (r = 1), relying
on the results of Gupta et al. (2019). In practice, this assumption only makes sense for some epidemiological
applications, when infected individuals can self-quarantine and be safely assumed to be removed from the process.
For macroevolutionary applications, the r parameter typically equals zero, and the likelihood computation relies on
a more computationally intensive method to numerically solve Master equations (see details in Supp. Mat. A).
More work is thus needed to help speed up the likelihood computation when r 6= 1, on datasets for which a large
number of hidden lineages is expected. This will be especially important for further applications in macroevolution
and paleobiology, as many data sets feature thousands of fossils occurrences.

12

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

4.2

Covid-19 Diamond Princess epidemic

The application of our method to the study of a thoroughly documented outbreak highlights the versatility of our
model implementation. The ability to incorporate both incidence data and pathogen sequences, in combination
with temporal information constitutes one of the first few instances of the use of a total evidence approach for the
inference of epidemiological trajectories.
In fact, encouraging conclusions can be drawn from both our parameter estimates and the corresponding trajectory inference. First, the reproductive number is inferred to be 4.33 in the absence of any intervention and detection,
during the first 15 days of the cruise (see Fig. 6B). These values are consistent with previous studies estimating
the basic reproductive number R0 between 2.5 and 3.5 for the global pandemic (Stadler 2020a), and 3.53 for the
Diamond Princess outbreak before quarantine (Stadler 2020b). Second, we infer a decrease in the reproductive
number, that remains near or below 1 in the last 23 days of the time period of interest, suggesting that the epidemic
was contained by measures taken. Interestingly, we note that this decrease is driven by the sampling and removal
of individuals from the infectious population, with the total sampling rate going up from 1.41 to 1.79 days−1 , after
February 11th (see Figure S13 for detailed timeline). This extended sampling, stemming partly from the decision
to test asymptomatic passengers, results in occurrences having a visible impact on the reconstructed prevalence
curve. This underlines successful integration of both sequence and occurrence data, and the added value brought
about by this new implementation.
Biases inherent to many epidemiological data sets indicate important areas for development. For instance,
sampling of outbreaks is most often carried out with the aim of quickly monitoring the disease, without rigorously
following a protocol. This can result in inconsistent sampling and reporting strategies, with gaps and/or missing
data. Due to a 24 hours reporting delay for this dataset, the first detected case was, for example, originally
placed after the start of the quarantine. We tried to meticulously remove as many such biases as possible, but our
framework could be improved in the future to account for these.
Other potential biases include the effect of population structure – the Diamond princess outbreak is likely to
have spread in at least two distinct sub-populations: guests and crew members (Nishiura 2020) – and density
dependence – the outbreak being in a closed, geographically constrained population (Rocklöv et al. 2020). Further
developments of the method to cover these scenarios could provide even better insight into the dynamics of this
outbreak.

4.3

Past cetacean diversity

Molecular and paleontological data come with their inherent limitations, e.g. lack of information about extinct
lineages for the former and substantial spatiotemporal biases for the latter. Combining them into a single analysis
may gather enough signal to mitigate these limitations, but special attention should be paid to model assumptions.
We have endeavoured to respect these constraints, by (i) correcting occurrence distribution sampling biases, and
(ii) making the most of the piecewise-constant parameter framework to include shifts in diversification rates, as
detected previously (Rabosky 2014), as well as shifts in fossilization rates corresponding to the well-established low
preservation rates in the Early Oligocene (Rupelian), Early Miocene (Aquitalian) and End Miocene (Messinian)
(Marx et al. 2016).
The emerging patterns of cetacean generic diversification in Figure 7 are coherent with previous estimates (Uhen
and Pyenson 2007; Morlon et al. 2011; Marx and Fordyce 2015): (i) the “boom and bust” dynamics of prolonged
diversification followed by a recent decline is recovered, and (ii) estimated generic richness is higher than the
incomplete raw generic counts, as expected. The diversification of cetaceans, starting in the Eocene and accelerating
in the Neogene, has been associated by previous authors with the development of the Antarctic Circumpolar Current
(ACC) that fuelled a diatom radiation, via nutrient supply, prompting the diversification of bulk filtering cetaceans.
The diversity drop in the last 4 million years has been linked to the global climate deterioration and the Northern
Hemisphere glaciation, which coincides with the final establishment of modern mysticete gigantism and long-distance
migration. Our inferred diversity trajectory (Fig. 7) is compatible with these hypotheses. On the other hand, the
distinct second peak with maximum diversity in the Pliocene is unexpected and will require further investigation.
Similar to applications in epidemiology, insights into macroevolution based on our novel framework will also benefit
from developments that account for biases in fossil sampling, e.g. spatial and temporal biases (Close et al. 2020).

13

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

4.4

New avenues for phylogenetics

Over the last decade, the field of phylogenetics has expanded considerably with the development of the Fossilized
Birth-Death Process and related extensions, of which the Occurrence Birth-Death Process is the latest instance. As
a result, the long-standing opposition between molecular-based and fossil-based macroevolutionary inferences is in
the process of being bridged, and case count records can be analyzed jointly with sequencing data in epidemiology
applications. Many extant clades with a relatively rich paleontological record – e.g. turtles, sharks, angiosperms
– as well as outbreak surveillance data, could benefit from this new method to infer reliable phylogenies and
diversity/prevalence trajectories.
Future progress could be made to couple birth rates with abiotic drivers, such as biogeography (see also work on
multitype birth-death processes Scire et al. (2020)), or biotic drivers such as density-dependence (see also Etienne
et al. (2012)). Going even further down the mechanistic road for macroevolutionary applications, stratigraphic
palaeobiology could even become an explicit part of diversification models, by considering the accumulation of
sediments over finer time and spatial scales (Patzkowsky and Holland 2012). Birth-death process models also exist
for the analysis of stratigraphic ranges, or paleontological data only (Stadler et al. 2018; Silvestro et al. 2019), further
expanding the potential of phylogenetic models in quantitative paleobiology. We anticipate that these approaches
will all benefit from combining paleontological and molecular data.
Overall, our two empirical applications demonstrate that a phylogenetic framework can be successfully applied
to recover both the past outbreak prevalence and the past paleodiversity. In contrast to alternative approaches, it
maximises the use of available evidence, since it uniquely allows us to combine genetic an morphological character
data, together with occurrences. Further, our inference method relies on a generating model, incorporating explicit
assumptions about the processes giving rise to our data, including sampling, and is prospectively much more flexible
than alternative approaches to mitigating sampling biases.

References
Aguirre-Fernández, G., R. Warnock, A. M. Benites-Palomino, J. Andréoletti, and M. Manceau. 2020. Cetacean
timeline. 2.6.2
Alfaro, M. E., F. Santini, C. Brock, H. Alamillo, A. Dornburg, D. L. Rabosky, G. Carnevale, and L. J. Harmon.
2009. Nine exceptional radiations plus high turnover explain species diversity in jawed vertebrates. P. Natl. Acad.
Sci. USA 106:13410–13414. 1
Allio, R., S. Donega, N. Galtier, and B. Nabholz. 2017. Large Variation in the Ratio of Mitochondrial to Nuclear
Mutation Rate across Animals: Implications for Genetic Diversity and the Use of Mitochondrial DNA as a
Molecular Marker. Molecular Biology and Evolution 34:2762–2772 publisher: Oxford Academic. 2.6.3, S6
Barido-Sottani, J., G. Aguirre-Fernández, M. J. Hopkins, T. Stadler, and R. Warnock. 2019. Ignoring stratigraphic
age uncertainty leads to erroneous estimates of species divergence times under the fossilized birth–death process.
Proceedings of the Royal Society B: Biological Sciences 286:20190685 publisher: Royal Society. 2.6.3
Churchill, M., J. H. Geisler, B. L. Beatty, and A. Goswami. 2018. Evolution of cranial telescoping in echolocating
whales (cetacea: Odontoceti). Evolution 72:1092–1108. 2.6.2
Close, R., R. B. Benson, E. Saupe, M. Clapham, and R. Butler. 2020. The spatial structure of phanerozoic marine
animal diversity. Science 368:420–424. 4.3
Dominici, S., S. Danise, S. Cau, and A. Freschi. 2020. The awkward record of fossil whales. Earth-Science Reviews
. 2.6.2
Dong, E., H. Du, and L. Gardner. 2020. An interactive web-based dashboard to track covid-19 in real time. The
Lancet infectious diseases 20:533–534. 2.5.1
Dornburg, A., M. C. Brandley, M. R. McGowen, and T. J. Near. 2012. Relaxed Clocks and Inferences of Heterogeneous Patterns of Nucleotide Substitution and Divergence Time Estimates across Whales and Dolphins
(Mammalia: Cetacea). Molecular Biology and Evolution 29:721–736 publisher: Oxford Academic. 2.6.3, S6

14

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Etienne, R. S., B. Haegeman, T. Stadler, T. Aze, P. N. Pearson, A. Purvis, and A. B. Phillimore. 2012. Diversitydependence brings molecular phylogenies closer to agreement with the fossil record. Proceedings of the Royal
Society B: Biological Sciences 279:1300–1309. 4.4
Fordyce, R. E. 2009. Cetacean Fossil Record. Pages 207–215 in Encyclopedia of Marine Mammals (Second Edition)
(W. F. Perrin, B. Würsig, and J. G. M. Thewissen, eds.). Academic Press, London. 2.6.1
Gavryushkina, A., T. A. Heath, D. T. Ksepka, T. Stadler, D. Welch, and A. J. Drummond. 2016. Bayesian totalevidence dating reveals the recent crown radiation of penguins. Systematic Biology 66:57–73. 1
Gavryushkina, A., D. Welch, T. Stadler, and A. J. Drummond. 2014. Bayesian inference of sampled ancestor trees
for epidemiology and fossil calibration. PLoS computational biology 10:e1003919. 1
Geisler, J. H. and A. E. Sanders. 2003. Morphological Evidence for the Phylogeny of Cetacea. Journal of Mammalian
Evolution 10:23–129. 2.6.2
Gupta, A., M. Manceau, T. Vaughan, M. Khammash, and T. Stadler. 2019. The probability distribution of the
reconstructed phylogenetic tree with occurrence data. bioRxiv Page 679365. 1, 4.1, 4.4
Hadfield, J., C. Megill, S. M. Bell, J. Huddleston, B. Potter, C. Callender, P. Sagulenko, T. Bedford, and R. A.
Neher. 2018. Nextstrain: real-time tracking of pathogen evolution. Bioinformatics 34:4121–4123. 2.5.1
He, X., E. H. Lau, P. Wu, X. Deng, J. Wang, X. Hao, Y. C. Lau, J. Y. Wong, Y. Guan, X. Tan, et al. 2020.
Temporal dynamics in viral shedding and transmissibility of covid-19. Nature medicine 26:672–675. S7
Heath, T. A., J. P. Huelsenbeck, and T. Stadler. 2014. The fossilized birth–death process for coherent calibration
of divergence-time estimates. Proceedings of the National Academy of Sciences 111:2957–2966. 1
Heath, T. A., A. M. Wright, and W. Walker. 2019. RevBayes: Combined-Evidence Analysis and the Fossilized
Birth-Death Process for Stratigraphic Range Data. 2.4.1, 2.6.3, S7, S6
Höhna, S. and T. Heath. 2019. RevBayes: Simple Diversification Rate Estimation. S6
Höhna, S., T. A. Heath, B. Boussau, M. J. Landis, F. Ronquist, and J. P. Huelsenbeck. 2014. Probabilistic Graphical
Model Representation in Phylogenetics. Systematic Biology 63:753–771. 2.3
Höhna, S., M. J. Landis, and T. A. Heath. 2017. Phylogenetic Inference Using RevBayes. Current Protocols in Bioinformatics 57:6.16.1–6.16.34 _eprint: https://currentprotocols.onlinelibrary.wiley.com/doi/pdf/10.1002/cpbi.22.
2.3, 2.4.1
Höhna, S., M. J. Landis, T. A. Heath, B. Boussau, N. Lartillot, B. R. Moore, J. P. Huelsenbeck, and F. Ronquist.
2016. RevBayes: Bayesian Phylogenetic Inference Using Graphical Models and an Interactive Model-Specification
Language. Systematic Biology 65:726–736. 1, 2.3
Kendall, D. G. 1948. On the generalized ‘birth-and-death’ process. Ann. Math. Stat. 19:1–15. 1
Maddison, W. P., P. E. Midford, and S. P. Otto. 2007. Estimating a binary character’s effect on speciation and
extinction. Systematic Biology 56:701–710. 1
Mallapaty, S. 2020. What the cruise-ship outbreaks reveal about covid-19. Nature 580:18–18. 2.5.1
Manceau, M., A. Gupta, T. Vaughan, and T. Stadler. 2019. The probability distribution of ancestral population
size under birth-death processes. bioRxiv Page 679365. 1, 2.1, 2.4.1, 3, 4.1, 4.4, A.1
Marshall, C. R. 2017. Five palaeobiological laws needed to understand the evolution of the living biota. Nature
Ecology & Evolution 1:1–6. 1
Marx, F. G. and R. E. Fordyce. 2015. Baleen boom and bust: a synthesis of mysticete phylogeny, diversity and
disparity. Royal Society Open Science 2:140434 publisher: Royal Society. 2.6.1, 7, 4.3
Marx, F. G., O. Lambert, and M. D. Uhen. 2016. Cetacean Paleobiology. John Wiley & Sons google-Books-ID:
ADLOCwAAQBAJ. 2.6.1, 2.6.2, 4.3

15

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

McGowen, M. R., G. Tsagkogeorga, S. Álvarez Carretero, M. dos Reis, M. Struebig, R. Deaville, P. D. Jepson,
S. Jarman, A. Polanowski, P. A. Morin, and S. J. Rossiter. 2020. Phylogenomic Resolution of the Cetacean Tree
of Life Using Target Sequence Capture. Systematic Biology 69:479–501 publisher: Oxford Academic. S6
Ministry of Health, L. and Welfare. 2020. Situation of the covid-19 in the cruise ship diamond princess. 6, S7
Mizumoto, K., K. Kagaya, A. Zarebski, and G. Chowell. 2020. Estimating the asymptomatic proportion of coronavirus disease 2019 (covid-19) cases on board the diamond princess cruise ship, yokohama, japan, 2020. Eurosurveillance 25:2000180. 2.5.2
Morlon, H., T. L. Parsons, and J. B. Plotkin. 2011. Reconciling molecular phylogenies with the fossil record. P.
Natl. Acad. Sci. USA 108:16327–16332. 1, 2.6.1, 4.3
Nee, S., R. M. May, and P. H. Harvey. 1994. The reconstructed evolutionary process. Philosophical Transactions of
the Royal Society of London B: Biological Sciences 344:305–311. 1
Nishiura, H. 2020. Backcalculating the incidence of infection with covid-19 on the diamond princess. 4.2
O’Reilly, J. E. and P. C. Donoghue. 2020. The effect of fossil sampling on the estimation of divergence times with
the fossilized birth–death process. Systematic biology 69:124–138. 1
Patzkowsky, M. E. and S. M. Holland. 2012. Stratigraphic paleobiology: understanding the distribution of fossil
taxa in time and space. University of Chicago Press. 4.4
Quental, T. B. and C. R. Marshall. 2010. Diversity dynamics: molecular phylogenies need the fossil record. Trends
in Ecology & Evolution 25:434–441. 1, 2.6.1, 2.6.2
Rabosky, D. L. 2014. Automatic Detection of Key Innovations, Rate Shifts, and Diversity-Dependence on Phylogenetic Trees. PLOS ONE 9:e89543 publisher: Public Library of Science. 4.3, S6
Rasmussen, D. A., O. Ratmann, and K. Koelle. 2011. Inference for nonlinear epidemiological models using genealogies and time series. PLoS computational biology 7:–1002136. 1
Raup, D. M. 1972. Taxonomic Diversity during the Phanerozoic. Science 177:1065–1071 publisher: American Association for the Advancement of Science. 1
Rocklöv, J., H. Sjödin, and A. Wilder-Smith. 2020. Covid-19 outbreak on the diamond princess cruise ship: estimating the epidemic potential and effectiveness of public health countermeasures. Journal of travel medicine
27:taaa030. 4.2
Scire, J., J. Barido-Sottani, D. Kühnert, T. G. Vaughan, and T. Stadler. 2020. Improved multi-type birth-death
phylodynamic inference in beast 2. bioRxiv . 4.4
Sepkoski, J. J., R. K. Bambach, D. M. Raup, and J. W. Valentine. 1981. Phanerozoic marine diversity and the fossil
record. Nature 293:435–437 number: 5832 Publisher: Nature Publishing Group. 1
Shu, Y. and J. McCauley. 2017. Gisaid: Global initiative on sharing all influenza data–from vision to reality.
Eurosurveillance 22:30494. 2.5.1
Silvestro, D., N. Salamin, A. Antonelli, and X. Meyer. 2019. Improved estimation of macroevolutionary rates from
fossil data using a Bayesian framework. Paleobiology 45:546–570 publisher: Cambridge University Press. 1, 4.4
Silvestro, D., N. Salamin, and J. Schnitzler. 2014. PyRate: a new program to estimate speciation and
extinction rates from incomplete fossil data. Methods in Ecology and Evolution 5:1126–1131 _eprint:
https://besjournals.onlinelibrary.wiley.com/doi/pdf/10.1111/2041-210X.12263. 1
Silvestro, D., R. C. Warnock, A. Gavryushkina, and T. Stadler. 2018. Closing the gap between palaeontological and
neontological speciation and extinction rate estimates. Nature Communications 9:1–14. 1
Stadler, T. 2010. Sampling-through-time in birth–death trees. Journal of theoretical biology 267:396–404. 1
Stadler, T. 2020a. Phylodynamic analyses based on 128 sequences. 4.2, S7

16

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Stadler, T. 2020b. Phylodynamic analyses of outbreaks in china, italy, washington state (usa), and the diamond
princess. 4.2
Stadler, T., A. Gavryushkina, R. C. Warnock, A. J. Drummond, and T. A. Heath. 2018. The fossilized birth-death
model for the analysis of stratigraphic range data under different speciation modes. Journal of theoretical biology
447:41–55. 1, 4.4
Stadler, T., D. Kühnert, S. Bonhoeffer, and A. J. Drummond. 2013. Birth–death skyline plot reveals temporal
changes of epidemic spread in HIV and hepatitis c virus (HCV). Proceedings of the National Academy of Sciences
110:228–233. 1
Steeman, M. E., M. B. Hebsgaard, R. E. Fordyce, S. Y. Ho, D. L. Rabosky, R. Nielsen, C. Rahbek, H. Glenner,
M. V. Sørensen, and E. Willerslev. 2009. Radiation of extant cetaceans driven by restructuring of the oceans.
Systematic biology 58:573–585. 2.6.2
Talts, S., M. Betancourt, D. Simpson, A. Vehtari, and A. Gelman. 2018. Validating Bayesian Inference Algorithms
with Simulation-Based Calibration. arXiv:1804.06788 [stat] ArXiv: 1804.06788. 2.4.3
Uhen, M. and N. Pyenson. 2007. Diversity estimates, biases, and historiographic effects: Resolving cetacean diversity
in the Tertiary. Palaeontologia Electronica 10. 2.6.1, 2.6.2, 4.3
Vaughan, T. G., G. E. Leventhal, D. A. Rasmussen, A. J. Drummond, D. Welch, and T. Stadler. 2019. Estimating
epidemic incidence and prevalence from genomic data. Molecular Biology and Evolution . 1
Wickham, H. 2016. ggplot2: Elegant Graphics for Data Analysis. Springer google-Books-ID: XgFkDAAAQBAJ.
B.2
Wright, A. M. 2019. A systematist’s guide to estimating bayesian phylogenies from morphological data. Insect
Systematics and Diversity 3:2. 2.6.3
Wright, A. M. 2020. RevBayes: Discrete morphology - Multistate Characters. S6
Xing, Y., R. E. Onstein, R. J. Carter, T. Stadler, and H. Peter Linder. 2014. Fossils and a large molecular phylogeny
show that the evolution of species richness, generic diversity, and turnover rates are disconnected. Evolution
68:2821–2832. 1
Yule, G. U. 1925. A mathematical theory of evolution, based on the conclusions of Dr. J. C. Willis, F.R.S. Phil.
Trans. R. Soc. Lond. B . 1
Zhang, C., T. Stadler, S. Klopfstein, T. A. Heath, and F. Ronquist. 2015. Total-evidence dating under the fossilized
birth–death process. Systematic biology 65:228–249. 1

17

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

– Appendix –
A skyline birth-death process for inferring the population size from a
reconstructed tree with occurrences
This appendix presents the detailed derivation of the model used in “A skyline birth-death process for inferring the
population size from a reconstructed tree with occurrences” by Andréoletti, Zwaans et al, as well as supplementary
results and figures. We extend results of Gupta et al. (2019) and Manceau et al. (2019) to piecewise-constant
parameters, describe our implementation in the RevBayes software, and give detailed information on all priors used
for simulation or inference in our analyses.
A Method extension to piecewise-constant parameters

2

A.1 Notation and outline of the general strategy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

2

A.2 Temporal setup for piecewise constant parameters . . . . . . . . . . . . . . . . . . . . . . . . . . . .

3

A.3 Master equations governing Lt and Mt . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

4

A.4 Updates at punctual events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

5

A.5 Numerical approximation of the ODEs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

6

B RevBayes implementation

9

B.1 Core algorithms . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

9

B.2 RevGadgets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

11

C Qualitative validation: “blind test” on simulated data

13

D Macroevolution application: Inferring past cetacean diversity

17

D.1 Preliminary analysis of the cetacean occurrence fossil record . . . . . . . . . . . . . . . . . . . . . . .

17

D.2 Detailed priors used for Bayesian inference . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

17

E Epidemiology application: the Diamond Princess SARS-2 COVID-19 outbreak dynamics

19

E.1 Data acquisition on GISAID . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

19

E.2 Pre-processing the data . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

19

E.3 Detailed priors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

22

1

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

A
A.1

Method extension to piecewise-constant parameters
Notation and outline of the general strategy

We first recall in Figure S1 the notation that we introduced in the main text with the three different sampling (ψsampling for sampling of fossils with inclusion in the tree, ω-sampling for occurrences and ρ-sampling at present).
a)

b)

c)
1

2

d)

3

e)
1

2

3

Figure S1: General setting of the method. a) the full process with sampling. Pink dots correspond to ω-sampling
(sampling through time without sequencing), blue dots correspond to ψ-sampling (sampling through time with
sequencing) and yellow dots correspond to ρ-sampling at present. Filled or unfilled dots correspond respectively
to sampling with or without removal. b) Total number of individuals through time. c) Record of occurrences. d)
Reconstructed tree spanning ψ- and ρ-samples. e) Number of lineages through time in the reconstructed tree (i.e.
LTT plot).
To compute the likelihood of (T , O) under this process, we will slice horizontally our observations and perform
a breadth-first traversal of these. We thus introduce now,
Tt↑ := the tree T cut at time t
Tt↓ := the collection of trees (or forest) obtained by cutting T
at time t, and considering all subtrees descending from cut lineages
kt := number of sampled lineages in T at time t
Ot↑ := O|(t,+∞)
Ot↓ := O|(0,t)

2

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

We can now recall the definition of our two key probability densities,
∀i ∈ N, Lt := P(Tt↓ , Ot↓ | It = kt + i)
(i)

∀i ∈ N,

(i)
Mt

:=

P(Tt↑ , Ot↑ , It

(S1)

= kt + i)

(S2)

These probability densities have been introduced in Manceau et al. (2019) as a way to target the probability
distribution Kt of the total number of individuals given the data. Indeed,
(i)

:= P(It = kt + i | T , O)

Kt

∝ P(It = kt + i, Tt↑ , Ot↑ , Tt↓ , Ot↓ )
∝ P(Tt↓ , Ot↓ | It = kt + i, Tt↑ , Ot↑ )P(It = kt + i, Tt↑ , Ot↑ )
(i)

(i)

∝ Lt Mt

(S3)

The general strategy of the methods consists of (i) traversing the data backward in time to compute Lt ; (ii)
traversing the data forward in time to compute Mt ; (iii) using the results to compute Kt . This scheme is illustrated
in Figure S2.

1

2

3

1

1

2

2

3

3

Figure S2: Inferring the posterior distribution of the number of individuals (Kt ) in the OBDP. The probability
distribution of the past number of lineages Kt is obtained at each time t by combining the quantity Lt obtained
from the backward traversal algorithm (left) and the quantity Mt obtained from the forward traversal algorithm
(right). See Table 1 for notations.
In the rest of this appendix section, we present the Master equations governing the evolution of these densities
through time in a setup with piecewise-constant parameters.

A.2

Temporal setup for piecewise constant parameters

We partition time into two distinct units.
First, we define periods of time with no observations or sampling events, coined epochs, which allow for the basic
derivation of Master equations of Lt and Mt . Epochs are delimited by all n punctual events times (i.e. branching
3

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

and sampling events) in O and T pooled in an ordered list (th )nh=1 . Epoch h is thus defined as the time interval
(th , th+1 ).
Second, we account for all rate shift events, which define constant rate time intervals. If we have m such intervals,
we pool all m + 1 rate shift events in an ordered list (τl )m+1
l=0 , where by convention we consider that τ0 = 0 and
τm+1 = tor . Rate time interval l is defined as (τl , τl+1 ), with parameter set (λl , µl , ψl , ωl , rl ). We illustrate this
setup in Figure S3 below.

Figure S3: Temporal setup of the method.

A.3

Master equations governing Lt and Mt

Probability densities Lt and Mt satisfy different Master equations obtained by studying their evolution through
time along any given epoch. These are ordinary differential equations (ODE) that can be approximated numerically.
Here, we assume τl ≤ t < τl+1 meaning that parameters have values (λl , µl , ψl , ωl , rl ).
First, we can initialize Lt and Mt respectively at present time 0 and at the time of origin tor . At present, ρ
sampling of extant tips yields,
(i)

∀i ∈ N, L0 = ρk0 (1 − ρ)i

(S4)

while at the time of origin, the process starts with only one individual ktor = 1, which yields,
∀i ∈ N, Mtor = P(Itor = 1 + i) = 1i=0
(i)

(S5)

We now consider all events happening in an infinitesimal time step δt in the full underlying process which do
not result in observations or samplings. Three scenarios correspond to this case:
1. nothing happened with probability (1 − γl (k + i)δt), where γl = λl + µl + ψl + ωl
2. a birth event happened :
(a) among the k sampled lineages in Tt↓ , and it leads to an extinct or unsampled subtree to the left or to
the right with probability 2λl kδt
(b) among the i other individuals with probability λl iδt.
3. a death event happened among the i particles, with probability µl iδt

4

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

We combine these to write, ∀i ∈ N,
(i)

(i)

(i+1)

Lt+δt = (1 − γl (k + i)δt)Lt + λl (2k + i)δt)Lt

(i−1)

+ µl iδt)Lt

(S6)

Letting δt → 0 yields the following differential equation for Lt ,
(i)

∀i ∈ N, L0 = ρk0 (1 − ρ)i
(i)
L̇t

= −γl (k +

(S7)

(i)
i)Lt

+ λl (2k +

(i+1)
i)Lt

+

(i−1)
µl iLt

(S8)

Similarly, Mt is the solution of the following ODE,
∀i ∈ N, Mtor = P(Itor = 1 + i) = 1i=0
(i)

(i)
Ṁt

A.4

= −γl (k +

(i)
i)Mt

+ λl (2k + i −

(S9)
(i−1)
1)Mt

+ µl (i +

(i+1)
1)Mt

(S10)

Updates at punctual events

Figure S4: Updated sampling scheme of the method.
There are 6 types of punctual events in T and O that affect the probability densities Mt and Lt . These
correspond to all different sampling options along T and O as illustrated in Figure S4. We denote as Mt− and
Lt− the probability densities immediately prior to the event and Mt+ and Lt+ immediately after each event. We
emphasise that the expressions differ when considering the process forward in time for Mt or backward in time, for
Lt . These cases are the following :
1. sampling of a leaf:
(a) in Tt↓ , Lt+ = ψl (1 − rl )Lt−
(i)

(i+1)

(b) in Tt↑ , Mt− = ψl (1 − rl )Mt+
(i)

(i−1)

2. removed sampled leaf:
(a) in Tt↓ , Lt+ = ψl rl Lt−
(i)

(i)

(b) in Tt↑ , Mt− = ψl rl Mt+
(i)

(i)

5

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

3. sampling along a branch:
(a) in Tt↓ , Lt+ = ψl (1 − rl )Lt−
(i)

(i)

(b) in Tt↑ , Mt− = ψl (1 − rl )Mt+
(i)

(i)

4. occurrence:
(a) in Ot↓ , Lt+ = (k + i)ωl (1 − rl )Lt−
(i)

(i)

(b) in Ot↑ , Mt− = (k + i)ωl (1 − rl )Mt+
(i)

(i)

5. removed occurrence:
(a) in Ot↓ , Lt+ = ωl rl iLt−
(i)

(i−1)

(b) in Ot↑ , Mt− = ωl rl (i + 1)Mt+
(i)

(i+1)

6. branching event:
(a) in Tt↓ , Lt+ = λl Lt−
(i)

(i)

(b) in Tt↑ , Mt− = λl Mt+
(i)

A.5

(i)

Numerical approximation of the ODEs

As described in A.3, for any constant rate time interval where τl ≤ t < τl+1 , Mt and Lt are defined along epochs
as the solution to systems of differential equations S8 and S10 for th ≤ t < th+1 . Numerically, the solution to such
systems of equations is approximated by truncating the system at a fixed integer N as follows:

Lth+1 = eAl (t−th ) Lth
Mth = e

0
Al (t−th+1 )

(S11)

Mth+1

(S12)

Where Al and A0l are N × N tridiagonal matrices with ODE coefficients. When there is a rate shift τl within
an epoch (th , th+1 ), the epoch is cut in two parts and Lt and Mt are simply computed as,
Lth+1 = eAl+1 (th+1 −τl ) eAl (τl −th ) Lth

(S13)

0

A0l (th −τl ) Al+1 (τl −th+1 )

Mth = e

e

Mth+1

(S14)

This can be extended to any number of rate changes within an epoch. This strategy of solving for Lt and Mt
yields the following two algorithms. Because exponential matrices are computationally intensive to calculate, these
algorithms are only used in the most general cases, when no other analytical formula is available (i.e. when ω 6= 0
and r 6= 1).

6

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Algorithm 1 Computes a numerical approximation of Lt for a specific set of times with known rate shift events
Input:
Observed tree and occurrence data (T , O),
extant sampling probability ρ,
set of times of rate shift events (τl )m+1
l=0 ,
and corresponding sets of parameters :
vector λ = (λl )m
l=0 where λl is the birth rate in time interval [τl , τl+1 )
vector µ = (µl )m
l=0 where µl is the death rate in time interval [τl , τl+1 )
vector ψ = (ψl )m
l=0 where ψl is the sampling rate in time interval [τl , τl+1 )
vector ω = (ωl )m
l=0 where ωl is the rate of occurence sampling in time interval [τl , τl+1 )
vector r = (rl )m
l=0 where rl is the removal probability in time interval [τl , τl+1 )
set of time points (dj )Sj=1 for which we want to compute the density, and
the truncation N setting the accuracy of the algorithm.
e (i)
Output: A numerical approximation of Lt at times (dj )Sj=1 , (L
t )i∈{0,1,...,N } .
j∈{1,2,...,S}

1:
2:
3:
4:
5:
6:

Pool all (dj )Sj=1 , all branching and sampling times of (T , O) and rate shift times (τl )m+1
l=0 in an ordered list
n+m+1
(th )h=1 .
Set j = 1 and initialize B as a S × N + 1 empty matrix.
Set l = 0 and λ = λ0 , µ = µ0 , ψ = ψ0 , ω = ω0 , r = r0 , γ0 = λ0 + µ0 + ψ0 + ω0 .
e (i) = ρk0 (1 − ρ)i .
Set ∀i ∈ {0, 1, . . . , N }, L
0
for h = 1, 2, . . . , n + m + 1 do
e˙ t = AL
e t on (th , th+1 ), where matrix A is a N × N tridiagonal matrix with
Numerically solve the ODE L
entries given by,
∀i ∈ {0, 1, . . . , N } A(i,i) = γ(k + i)
∀i ∈ {0, 1, . . . , N − 1} A(i,i+1) = λ(2k + i)
∀i ∈ {1, 2, . . . , N } A(i,i−1) = µi

7:
8:
9:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:

if th = dj then
e (i)
Set B (j,i) = L
th and
Set j = j + 1.
end if
if th = tor or th = dS then
return B
else if th = τl then
Set λ = λl , µ = µl , ψ = ψl , ω = ωl , r = rl , γl = λl + µl + ψl + ωl
Set l = l + 1
else if th is a removed leaf then
e + = ψrL
e−
Set L
th
th
else if th is a non-removed leaf then
)
e (i)
e (i+1)
e (N
Set ∀i < N, L
= ψ(1 − r)L
and L
=0
t+
t−
t+
h

20:
21:
22:
23:

else if
Set
else if
Set

h

24:
25:

28:
29:

h

h

h

else if th is a non-removed occurrence then
e (i)
e (i)
Set L
= ω(1 − r)(k + i)L
t+
t−
h

26:
27:

h

th is a sampled ancestor then
e + = ψ(1 − r)L
e−
L
th
th
th is a removed occurrence then
e (i)
e (i−1)
e (0)
∀i > 0, L
= ωriL
and L
= 0.
t+
t−
t−

else th is a branching event
e−
Setet+ = λL
th
h
end if
end for

h

7

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Algorithm 2 Computes a numerical approximation of Mt for a specific set of times with known rate shift events
Input:
Observed tree and occurrence data (T , O),
parameters tor , ρ
set of times of rate shift events (τl )m+1
l=0 ,
and corresponding sets of parameters :
vector λ = (λl )m
l=0 where λl is the birth rate in time interval [τl , τl+1 )
vector µ = (µl )m
l=0 where µl is the death rate in time interval [τl , τl+1 )
vector ψ = (ψl )m
l=0 where ψl is the sampling rate in time interval [τl , τl+1 )
vector ω = (ωl )m
l=0 where ωl is the rate of occurence sampling in time interval [τl , τl+1 )
vector r = (rl )m
l=0 where rl is the removal rate in time interval [τl , τl+1 )
set of time points (dj )Sj=1 for which we want to compute the density,
and the truncation N setting the accuracy of the algorithm.
ft(i) )i∈{0,1,...,N −1} .
Output: A numerical approximation of Mt at times (dj )Sj=1 , (M
j∈{1,2,...,S}

1:
2:
3:
4:
5:
6:

Pool all (dj ), rate shift times (τl ) and all branching and sampling times of (T , O) in an ordered list (th )nh=1 .
Set j = S, k = m and B 0 as a S × N empty matrix.
ft(i) = 1i=0 .
Set ∀i ∈ {0, 1, . . . , N − 1}, M
n
Set l = m and λ = λm , µ = µm , ψ = ψm , ω = ωm , r = rm .
for h = n − 1, n − 2, . . . , 0 do
˙
0f
0
f
Numerically solve the ODE M
t = A Mt on (th , th+1 ), where matrix A is a N × N tridiagonal matrix with
entries given by,
∀i ∈ {0, 1, . . . , N − 1} A0(i,i) = γ(k + i)
∀i ∈ {0, 1, . . . , N − 2} A0(i,i+1) = −µ(i + 1)
∀i ∈ {1, 2, . . . , N − 1} A0(i,i−1) = −λ(2k + i − 1)

7:
8:
9:
10:
11:
12:
13:
14:
15:
16:
17:
18:

if th = τj then
ft(i) and j = j − 1.
Set B 0(j,i) = M
h
end if
if th = 0 or th = τS then
return B 0
else if th = τl then
Set λ = λk , µ = µk , ψ = ψk , ω = ωk , r = rk , γl = λl + µl + ψl + ωl
Set l = l − 1
else if th is a removed leaf then
f − = ψrM
f+
Set M
th
th
else if th is a non-removed leaf then
f(i)
f(i−1)
f(0)
Set ∀i ∈ {1, 2, . . . , N − 1}, M
= ψ(1 − r)M
and M
=0
t−
t+
t−
h

19:
20:
21:
22:

else if
Set
else if
Set

th is a sampled ancestor then
f − = ψ(1 − r)M
f+
M
th

th

else if th is a non-removed occurrence then
f(i)
f(i)
Set M
= ω(1 − r)(k + i)M
t−
t+
h

25:
26:
27:
28:

h

th is a removed occurrence then
−1)
f(i)
f(i+1)
f(N
∀i ∈ {0, 1, . . . , N − 2}, M
= ωr(i + 1)M
and M
= 0.
t−
t+
t−
h

23:
24:

h

else th is a branching event
f − = λM
f+
Set M
th
th
end if
end for

h

h

8

h

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

B
B.1

RevBayes implementation
Core algorithms

To enable great flexibility and ensure fast computation, RevBayes is constructed around a mirror structure (Figure
5) in which all the core functions coded in C++ are reflected in the revlanguage section that links with the Rev
language interface.

Figure S5: Simplified representation of the RevBayes structure. Modified from the RevBayes website, keeping only
descriptions of the folders we modified. Note the organizational symmetry between the core directory containing
the hard-coded features and the revlanguage directory matching the Rev syntax.
Due the multiple advantages of RevBayes and its increasing use, particularly for macroevolutionary research, we
chose this software to implement the OBDP. All our modifications have been carried out in a separate copy of its
development branch on GitHub (https://github.com/revbayes/revbayes/tree/dev-cevo-lab), and are aimed
to be integrated in a future stable release. They consist in 3 key additions detailed in Table S1.
The necessary first step was to implement the core algorithms responsible for computing the quantities Lt and
Mt through time. The final organisation is as follows: from outside of the ComputeLikelihoodsLtMt.cpp file (see
Supp. Table S1) the only functions called are ComputeLnProbabilityDensitiesOBDP – returning Lt and Mt through
time – or ComputeLnLikelihoodOBDP – returning only the final likelihood. Those functions will themselves call the
appropriate internal function (ForwardsTraversalMt or BackwardsTraversalLt) with the correct parameters. Those
rely on a key function, PoolEvents, the role of which is to construct the vector containing all the events that will be
browsed by the traversal algorithms, namely branching times, ψ- and ω-sampling times, and time points for which
we want to store the probability distribution.
Because the densities computed during the traversals very quickly reached excessively small or elevated values,
to the point of exceeding the maximum number of recorded decimals, a correction term is added at each step to
bring the densities closer to 1. At the end of the traversal, the recorded correction terms plus the factorizable
factors are added to the log-transformed densities.
In addition, the Occurrence Birth-Death Process and the traversal algorithms not only allow us to perform
a MCMC phylogenetic inference incorporating the occurrences, they can also be used to output the probability
distribution of the population size through time, Kt . We introduced this functionality into RevBayes through
InferAncestralPopSizeFunction, which can be called directly from the Rev interface. As with the OBDP distribution,
we had to design the parameter loading procedure, then call the ComputeLnProbabilityDensitiesOBDP function to
get the log(Lt ) and log(Mt )) matrices and finally combine and normalize them to obtain the log(Kt )) matrix.

9

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Table S1: Overview of the implementations carried out to incorporate the Occurrence Birth-Death Process and the
associated Diversity Inference method into RevBayes. It lists for each of our goals the associated C++ files, along
with their assignment in the RevBayes structure.
Objectives

Location

File names

1. Perform Forwards
and Backwards
traversal algorithms

core/
functions

ComputeLikelihoods
LtMt.h
ComputeLikelihoods
LtMt.cpp

core/
distributions

OccurrenceBirthDeath
Process.h
OccurrenceBirthDeath
Process.cpp

2. Encode the
OBDP distribution
revlanguage/
distributions

core/
distributions
3. Infer past
diversity
revlanguage/
distributions

Dist_occurrenceBirth
DeathProcess.cpp
Dist_occurrenceBirth
DeathProcess.h
InferAncestralPop
SizeFunction.h
InferAncestralPop
SizeFunction.cpp

Major new functions
ComputeLnProbabilityDensitiesOBDP
ComputeLnLikelihoodOBDP
PoolEvents
ForwardsTraversalMt
BackwardsTraversalLt
OccurrenceBirthDeathProcess
computeLnProbabilityDivergenceTimes

createDistribution
getParameterRules

InferAncestralPopSizeFunction

Func_inferAncestral
PopSize.h
Func_inferAncestral
PopSize.cpp

A

createFunction
getArgumentRules

B

Figure S6: A graphical model of the OBDP and its translation into the Rev language. (A) Graphical model,
modified from the RevBayes FBD tutorial, representing the OBDP parameters – labelled in orange – generating a
reconstructed tree T and a record of occurrences O. (B) Rev script corresponding to this graphical model. Note
the distinction between the ∼ notation attributing a distribution to a stochastic node and the ← notation defining
a constant node.

10

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

B.2

RevGadgets

The postprocessing step consists in computing the posterior probability of the total number of individuals through
time. It can be performed independently of the previous steps, given that one has at least a tree, a set of parameters
and optionally occurrence times. It comprises 2 steps, the first one uses the fnInferAncestralPopSize function,
implemented in RevBayes, to obtain the matrix of diversity densities Kt for each tree in the MCMC trace. Then,
in order to convert Kt matrices into a nicely rendered plot we added two functions in the auxiliary R package
RevGadgets (https://github.com/revbayes/RevGadgets/tree/dev-plotDiversity). Starting from the trace
of posterior trees, parameters, and Kt matrices one first needs to execute the rev.process.nbLineages function that
will organize the required information into the Kt_mean data frame. The goal is to incorporate all the uncertainty
concerning the inferred parameter values and tree topologies into the diversity trajectory estimation. Afterwards,
this averaged Kt_mean is used by the function rev.plot.nbLineages to realize the final plot using ggplot2 (Wickham
2016). Here it is possible to alter most of the display options, such as the types of lineages to be shown (observed,
hidden, total), as well as their colours and shapes (see e.g. Fig. S8).

11

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Table S2: Description of two novel RevGadgets functions for visualizing OBDP diversity-through-time estimations.
The input objects and display parameters are detailed, those with an asterisk always have to be provided while the
others have default values.
Function

rev.process
.nbLineages

rev.plot
.nbLineages

Description
MCMC trace of the starting times.

Option

Type

start_time_trace_file*

character

popSize_distribution
_matrices_file*

character

trees_trace_file*

character

weight_trees_posterior

Boolean

Kt_mean*

data.frame

Whether to combine trees uniformly
or weighted by their posterior probabilities.
Processed output for plotting.

xlab / ylab

character

Label of the x-axis / y-axis.

line.size / interval.line.size

numeric

Width of the lineage plot / credible interval line.

col.Hidden / col.Observed /
col.Total / col.Hidden.interval /
col.Total.interval

character

Color of the hidden / observed / total
lineages plot line. Color of the credible
interval for hidden / total lineages.

palette.Hidden / palette.Total

character

Palette of the hidden / total lineages distribution.

show.Hidden / show.Observed /
show.Total / show.intervals /
show.densities / show.expectations

Boolean

Whether to show the plot for hidden /
observed / total lineages / credible intervals /
diversity densities / diversity expectations.

use.interpolate

Boolean

Whether to interpolate densities.

12

Matrices computed with
fnInferAncestralPopSize in RevBayes.

MCMC trace of the trees.

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

C

Qualitative validation: “blind test” on simulated data

Parameter values used to simulate the two datasets used in the blind test are presented in Table S3. Two trees
with occurrences have been simulated under the OBDP (parameters 1-6). For “dataset 1”, genetic sequences along
the first tree are simulated according to a K80 model of molecular evolution (parameters 7-9) and recorded only for
extant taxa. Binary traits are simulated according to a Markov process with symmetrical rates (parameters 10-12)
and are recorded for both extant and extinct taxa. This corresponds to a classic macroevolution scenario. For
“dataset 2”, genetic sequences along the second tree are simulated according to a K80 model of molecular evolution
(parameters 7-9) and recorded for extant and extinct individuals. This allows us to have a better resolution of the
underlying tree than in the first dataset. Moreover, getting genetic sequences for individuals sampled in the past
corresponds more to an epidemiology scenario.
Table S3: Parameter values used to simulate two datasets and test our OBDP inference workflow.

λ
1

µ
0.9

ψ
0.2

ω
0.3

r
0

Parameter values
ρ
mnt
αnt
βnt
0.8 10000 0.01 0.02

mmorpho
60

q01
0.03

q10
0.03

Two of us, ignorant of the priors Joelle: values used for simulation, designed the inference protocol and conducted
the analysis, taking as input the occurrences, sequences, and morphological data only. Priors used for inference on
“dataset 1” are presented in Table S4 and the general setup for analysis is illustrated in Figure S7. Priors used for
inference on “dataset 2” were very similar, except for the absence of a model of morphological evolution, and they
are presented in Table S5.

Figure S7: Modular representation of the graphical models used in the qualitative validation analysis. Modified
from Heath et al. (2019). The simulated data, noted in the grey nodes are used to deduce the posterior distributions
of all other random variables noted in the white nodes.

13

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Table S4: Prior distributions on the OBDP parameters and models for the “Blind Test” analysis on dataset 1.
Notations: U for the Uniform distribution, Exp for Exponential, Dir for Dirichlet, GT R for the General Time
Reversible substitution model and M K for the Mk model, the analog of JC69 for an arbitrary number of character
states.
Parameter
λ
µ
ψ
ω
ρ
r
tor

Prior
Exp(10)
Exp(10)
Exp(10)
Exp(5)
U(0, 1)
0
U(7.7, 12)

Model
Molecular evolution:
GT R + Γ
Morphological evolution:
MK + Γ

Prior
Strict clock rate: Exp(10)
Exchangeability rates: Dir(1, 1, 1, 1, 1, 1)
Stationary frequencies: Dir(1, 1, 1, 1)
Gamma distribution shape: Exp(1)
Strict clock rate: Exp(1)
Gamma distribution shape: Exp(1)

Table S5: Prior distributions of the OBDP parameters and models for the “Blind Test” analysis on dataset 2.
Notations: U for the Uniform distribution, B for the Beta distribution, Exp for Exponential, Dir for Dirichlet,
GT R for the General Time Reversible substitution model.
Parameter
λ
µ
ψ
ω
ρ
r
tor

Prior
Exp(10)
Exp(10)
Exp(10)
Exp(10)
B(1.0, 1.0)
0
U(7.7, 12)

Model
Molecular evolution:
GT R + Γ

14

Prior
Strict clock rate: Exp(10)
Exchangeability rates: Dir(1, 1, 1, 1, 1, 1)
Stationary frequencies: Dir(1, 1, 1, 1)
Gamma distribution shape: Exp(1)

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

In our blind inferences, we recovered posterior distribution of diversity trajectories (Fig. S8) and trees (Fig. S9)
which are very close to the real data from the simulations. The true number of hidden lineages is most of the time
near the expectation of the inferred posterior distribution and more importantly always in the 95% posterior credible
interval. When looking at the total number of lineages – i.e. species richness in macroevolution or prevalence in
epidemiology – the estimates remains very close to the truth and almost always in the 95% credible interval.
A

B

C

D

Figure S8: Validation of the diversity dynamics inferred by OBDP compared to the true simulated data. (A)
Posterior probability distribution of the number of hidden lineages through time for “dataset 1”, plotted with the
new RevGadgets utilities. (B) Posterior probability distribution of the total number of lineages through time for
“dataset 1”. (CD) Same as (AB), but for “dataset 2”. The 95% credible intervals are indicated in dashed lines, the
expected number of lineages is in blue or green and the true, simulated, trajectory in red. The black line represents
the inferred Lineages Through Time (LTT) plot, note that the total diversity equals the LTT plus the hidden
diversity.

15

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

A

B
f34

posterior
1

f28
f25
f7
f13
f3
f6
f14
f32
f23
f5
f19
f22

f46

f37

f41
f43 f39

f52

f44

f23
f5
f19
f22
f41
f25
f28
f7
f13
f6
f3
f27
f17
f12
f39
f4
f44
f16

f16
f29
f30

f29
f30
f10
f15

f10
f15
f31
f8
f11
f21

f40

f51
f49

f45
f47

f40
f31
f8
f50
f21
f11
f49
f47

f0
f20
f18
f2
f1
f26
f24
f33
f9

f38
f35
f53
f54

f14

f37

f12
f17
f27
f4

f50

0,22

f32

f36

f42

f48

f51
f0
f20
f18
f2
f1
f26
f35
f33
f24
f9
f36
f42
f48

-9

-8

-7

-6

-5

-4

-3

-2

-1

0

-10

-9

-8

-7

-6

-5

-4

-3

-2

-1

0

D

C
posterior
1

f74
f78
f2
f58
f65
f52
f20
f33
f41
f55
f28
f43

f117

f118
f114
f116

f120

f85

f 1 0 6f 1 0 4 f 1 0 0

f126

f105

f124

f127

f122

f121

f119
f103
f102
f92
f97

0.3
f129

f128

f98
f94

f107

f111
f96
f95
f109
f113

f99
f101

f13
f15
f49
f5
f81
f31

f115
f116

f 8 f21 6
f23
f75
f27
f66
f32
f30
f70
f51
f44
f80
f48
f14
f91
f9
f11
f79
f1
f45
f73
f22
f40
f19
f18
f26
f10
f34
f86
f42
f39
f71
f36
f89
f0
f47
f77
f24
f68
f56
f7
f60
f38
f8
f35
f63
f64
f83
f37
f57
f6
f12
f46
f90
f21
f72
f29
f61
f84 f 4
f17
f67
f88
f69
f53
f62
f54
f76
f25
f59

f52
f65
f58
f2
f78
f74
f41
f55
f33
f20

f114

f43
f28

f119

f76
f54
f53
f62
f69
f59
f25

f113

f101

f87

f77
f0
f47
f39
f42
f34
f71

f89

f36
f22
f45
f73
f1
f14
f9
f11
f79
f40

f97

f83

f90

f87

f125

-8

-7

-6

-5

-4

-3

-2

-1

f50
f3

0
-8

-7

-6

-5

-4

-3

-2

-1

Figure S9: Validation of the inferred trees against the true simulated ones. (A) Inferred phylogenetic tree for
“dataset 1”, visualized in FigTree 1.4.4. The node colors refer to their posterior probability. (B) Original simulated
tree for “dataset 1”, aligned on the same temporal scale. Note that the topology is well recovered but divergence
dates do not always perfectly match. (CD) Same as (AB) but on “dataset 2”. Due to a greater amount of data in
genetic sequences of both past and extant individuals, the divergence dates tend to be better inferred.

16

f35
f38
f8
f60
f7
f56
f24
f68

f21
f72
f29
f61
f4

f125
f110
f112
f108

-9

f10
f19
f18
f26
f12
f6
f57
f46
f37
f64
f63

f67
f17

f96

f3
f50

f110
f108
f112

f123

f124

f81
f5
f49
f31
f13
f15

f93
f115

f48
f51
f70
f30
f44
f80
f66
f27
f32
f23
f75
f16

0

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

D
D.1

Macroevolution application: Inferring past cetacean diversity
Preliminary analysis of the cetacean occurrence fossil record

A detailed notebook is available at https://github.com/Jeremy-Andreoletti/Cetacea_PBDB_Occurrences to
follow our exploration of the cetacean dataset. We identified several biases in their fossil record, in particular much
more variable occurrence densities – defined as the number of occurrences by unit of time in the stratigraphic range
of a clade – than expected from our model (see Figure S10).
Since OBDP assumes that only one individual of a species will be sampled at a time, we subsampled the dataset
to aggregate all occurrences of the same taxon found in the same geological formation. This subsampling also
reduced the observed discrepancy in occurrence densities. The final subsampled dataset was composed of 968
occurrences.

Figure S10: Occurrence distributions and bias correction, for cetacean species (A) and genera (B). At the top,
occurrence distributions are compared before (red) and after (green) aggregating in geological formations. Below,
stratigraphic ranges are displayed over time and colored according to the density of occurrences (red dots).

D.2

Detailed priors used for Bayesian inference

We detail in Table S6 all priors used for the inference on the cetacean dataset.

17

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Table S6: Prior distributions for parameters and models of the Cetacea analysis. For each parameter its prior
distribution, its initial value at the origin of the MCMC chain (set to speed up convergence) and the references
that support these choices are indicated. Notations: U for the Uniform distribution, Exp for Exponential, LogN
for Log-Normal, Dir for Dirichlet, GT R for General Time Reversible and JC69 for the Jukes-Cantor 1969.
Component

tor

µ

Prior
U(max(
occurrence_ages), 60)
Exp(10)

Initial

54.0

0.1

λ−µ

LogN (ln[ lntor89 ],
0.587405)

ln 89
tor

r
ψ+ω

0
Exp(10)

0
Random

ω/(ψ + ω)

U(0, 1)

Empirical

ρ

U(0.95, 1)

Random

U(min, max)

Minimum age

Nuclear: U(0, 0.01)

0.0005

Mitochondrial: U(0, 0.1)
Uncorrelated:
Exp(1/mean)

0.02

Fossil age
uncertainty
Mean
molecular
clock rate
Clock rate
relaxation
Molecular
substitution
model:
GT R + Γ
Morphological
substitution
model:
JC69

Random

Exchangeability rates: Dir(1, 1, 1, 1, 1, 1)
Stationary frequencies: Dir(1, 1, 1, 1)
Gamma distribution shape: Exp(1)

Justification
Origin after the last occurrence. Initialised close to the
estimated Whippomorpha root age from McGowen et al. (2020)
Initialized according to estimations by Rabosky (2014)
Expected number of species under a Birth-Death process
centred around the observed number of species. Lognormal
distribution with 95% prior probability spanning exactly one
order of magnitude (Höhna and Heath 2019)
Removal probability at sampling, irrelevant in macroevolution
Unknown sampling rate for all fossils (including occurrences)
Unknown probability that morphological characters are available
for a given fossil. Initialized at the empirical proportion of
fossils with morphology among all fossils
Sequences or morphology is used for the 89 accepted extant
cetacean species, but we allow for some still unknown species
Moves shifting a fossil age outside of its range are rejected
(Heath et al. 2019)
Priors based on rates of molecular evolution for all mammals
in Allio et al. (2017). Initialised at an intermediate rate between
mysticetes and odontocetes as estimated by Dornburg et al. (2012).
Independent and identically distributed exponential rates are
defined for each branch
Sophisticated nucleotide evolution model with rate
variation across sites according to a discretized
Gamma distribution. The Dirichlet distributions
constrain vectors to sum to one (Heath et al. 2019)

Simpler character evolution model. Characters are
partitioned according to their number of states
(Wright 2020)

Strict clock rate: Exp(1)
Gamma distribution shape: Exp(1)

18

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

E

E.1

Epidemiology application: the Diamond Princess SARS-2 COVID-19
outbreak dynamics
Data acquisition on GISAID

We gratefully acknowledge the following Authors from the Originating laboratories responsible for obtaining the
specimens, as well as the Submitting laboratories where the genome data were generated and shared via GISAID,
on which this research is based. All Submitters of data may be contacted directly via www.gisaid.org
accession ID EPI_ISL_416565, EPI_ISL_416566, EPI_ISL_416567, EPI_ISL_416568, EPI_ISL_416569,
EPI_ISL_416570, EPI_ISL_416571, EPI_ISL_416572, EPI_ISL_416573, EPI_ISL_416574, EPI_ISL_416575,
EPI_ISL_416576, EPI_ISL_416577, EPI_ISL_416578, EPI_ISL_416579, EPI_ISL_416580, EPI_ISL_416581,
EPI_ISL_416582, EPI_ISL_416583, EPI_ISL_416584, EPI_ISL_416585, EPI_ISL_416586, EPI_ISL_416587,
EPI_ISL_416588, EPI_ISL_416589, EPI_ISL_416590, EPI_ISL_416591, EPI_ISL_416592, EPI_ISL_416593,
EPI_ISL_416594, EPI_ISL_416595, EPI_ISL_416596, EPI_ISL_416597, EPI_ISL_416598, EPI_ISL_416599,
EPI_ISL_416600, EPI_ISL_416601, EPI_ISL_416602, EPI_ISL_416603, EPI_ISL_416604, EPI_ISL_416605,
EPI_ISL_416606, EPI_ISL_416607, EPI_ISL_416608, EPI_ISL_416609, EPI_ISL_416610, EPI_ISL_416611,
EPI_ISL_416612, EPI_ISL_416613, EPI_ISL_416614, EPI_ISL_416615, EPI_ISL_416616, EPI_ISL_416617,
EPI_ISL_416618, EPI_ISL_416619, EPI_ISL_416620, EPI_ISL_416621, EPI_ISL_416622, EPI_ISL_416623,
EPI_ISL_416624, EPI_ISL_416625, EPI_ISL_416626, EPI_ISL_416627, EPI_ISL_416628, EPI_ISL_416629,
EPI_ISL_416630, EPI_ISL_416631, EPI_ISL_416632, EPI_ISL_416633, EPI_ISL_416634, EPI_ISL_454749
Originating Laboratory Japanese Quarantine Stations
Submitting Laboratory Pathogen Genomics Center, National Institute of Infectious Diseases
Authors Tsuyoshi Sekizuka, Kentaro Itokawa, Rina Tanaka, Masanori Hashino, Tsutomu Kageyama, Shinji Saito,
Ikuyo Takayama, Hideki Hasegawa, Takuri Takahashi, Hajime Kamiya, Takuya Yamagishi, Motoi Suzuki,
Takaji Wakita, Makoto Kuroda

We gratefully acknowledge the following Authors from the Originating laboratories responsible for obtaining the specimens, as well as the
Submitting laboratories where the genome data were generated and shared via GISAID, on which this research is based.
All Submitters of data may be contacted directly via www.gisaid.org
Accession ID

Originating Laboratory

Submitting Laboratory

Authors

EPI_ISL_416565, EPI_ISL_416566, EPI_ISL_416567, EPI_ISL_416568, EPI_ISL_416569, EPI_ISL_416570, EPI_ISL_416571, EPI_ISL_416572, EPI_ISL_416573, EPI_ISL_416574, EPI_ISL_416575, EPI_ISL_416576, EPI_ISL_416577, EPI_ISL_416578, EPI_ISL_416579, EPI_ISL_416580, EPI_ISL_416581, EPI_ISL_416582, EPI_ISL_416583, EPI_ISL_416584, EPI_ISL_416585, EPI_ISL_416586, EPI_ISL_416587, EPI_ISL_416588,
EPI_ISL_416589, EPI_ISL_416590, EPI_ISL_416591, EPI_ISL_416592, EPI_ISL_416593, EPI_ISL_416594, EPI_ISL_416595, EPI_ISL_416596, EPI_ISL_416597, EPI_ISL_416598, EPI_ISL_416599, EPI_ISL_416600, EPI_ISL_416601, EPI_ISL_416602, EPI_ISL_416603, EPI_ISL_416604, EPI_ISL_416605, EPI_ISL_416606, EPI_ISL_416607, EPI_ISL_416608, EPI_ISL_416609, EPI_ISL_416610, EPI_ISL_416611, EPI_ISL_416612,
EPI_ISL_416613, EPI_ISL_416614, EPI_ISL_416615, EPI_ISL_416616, EPI_ISL_416617, EPI_ISL_416618, EPI_ISL_416619, EPI_ISL_416620, EPI_ISL_416621, EPI_ISL_416622, EPI_ISL_416623, EPI_ISL_416624, EPI_ISL_416625, EPI_ISL_416626, EPI_ISL_416627, EPI_ISL_416628, EPI_ISL_416629, EPI_ISL_416630, EPI_ISL_416631, EPI_ISL_416632, EPI_ISL_416633, EPI_ISL_416634, EPI_ISL_454749
see above

Japanese Quarantine Stations

Pathogen Genomics Center, National Institute of Infectious
Diseases

Tsuyoshi Sekizuka, Kentaro Itokawa, Rina Tanaka, Masanori Hashino, Tsutomu Kageyama, Shinji Saito, Ikuyo Takayama, Hideki Hasegawa, Takuri Takahashi, Hajime Kamiya, Takuya Yamagishi, Motoi Suzuki, Takaji Wakita,
Makoto Kuroda

Figure S11: Genome sequences used, originating and submitting labs generated on GISAID. Content is reproduced
above.

E.2

Pre-processing the data

All case count and sequencing data were available at a resolution of days.
In order to use the main method described in this article, the case count record had to be pre-processed so that
occurrences are spread throughout the days. For a day with a case count of n newly infected individuals, we drew
n time points uniformly distributed throughout the day. The resulting dataset is shown in Figure S12.

19

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

All guests disembarked

Disembarkment starts

Sequencing campaign

Intensified testing

Start of on−board quarantine

Start of cruise, patient 0 boarded

A

Total confirmed

B
600
cases

400

sequences

200
0

b
Fe

b
Fe

b
Fe

b
Fe

n
Ja

n
Ja

24

17

10

03

27

20

Date
Figure S12: Pre-processed dataset for the Diamond Princess outbreak analysis. (A) Exact dates assigned to
occurrences and sequences for the analysis. (B) Total case counts and sequences through time.

20

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

Figure S13: Detailed parameter estimates obtained from the COVID-19 outbreak analysis. (A) Reproductive
number estimates. (B) Birth rate estimates. (C) Total sampling (sequencing and PCR testing) rate estimates.

21

bioRxiv preprint doi: https://doi.org/10.1101/2020.10.27.356758; this version posted October 27, 2020. The copyright holder for this preprint
(which was not certified by peer review) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity. It is made
available under aCC-BY 4.0 International license.

E.3

Detailed priors

We detail in Table S7 all priors used for the inference on the outbreak dataset of COVID-19 aboard the Diamond
Princess.
The mean of the prior distribution of ψ + ω is set up to be the number of tests used on the ship, per day and
per passenger, on the two periods.
• Within the first 7 days period, from February 4th to February 11th, there were 439 tests carried out, on 3711
439
≈ 1.7 × 10−2 tests per day per passenger.
passengers, leading to 7×3711
• on the following 15 days period, from February 11th to February 27th, there were 3622 tests carried out, on
3622
≈ 6.5 × 10−2 tests per day per passenger.
3711 passengers, leading to 15×3711
Table S7: Prior distributions for parameters and models of the SARS-2 COVID-19 analysis. For each parameter
its prior distribution or value and the references that support these choices are indicated.
Component

Prior/Value

Shifts

tor

38

N/A.

µ

1/20 day−1

None.

λ

U(0, 24)
U(0, 10)

tm = (04.02.2020)

ψ+ω

LogN
LogN

3622
15∗3711 , 0.5
439
7∗3711 , 0.5



tm = (11.02.2020, 04.02.2020)

r

1

None.

ρ

0

None.

ψ
ω+ψ

71
328

None.

Clock rate

8 × 10−4 substitutions
per site per year

N/A.

Molecular
substitution
model:
GT R + Γ

Justification
We study the outbreak from the start of the cruise
on January 20, until February 27, when all
guests were confirmed to have disembarked the ship,
(Ministry of Health and Welfare 2020)
spanning a total period of 38 days.
In the absence of sampling and removal,infected individuals patients are assumed to become
uninfectious on average 20 days after infection. (He et al. 2020)
The upper bound is set to 1 transmission
per hour per infected individual before cabin isolation and lowered to 10 individuals after (maximal cabin size), from February 4th onward.
Testing started on February 4th and was intensified
from February 11th onward, yielding two periods of 7 days and 15 days each. For each time period, the mean for the LogNormal distribution
is set as the number of tests taken per passenger per day.
The total numbers of tests
carried out throughout the quarantine were communicated in press releases
(Ministry of Health and Welfare 2020)
Quarantine measures are assumed to have
minimised contact between guests aboard. Patients testing positive were disembarked from the ship to a separate medical facility.
No samples were sequenced after February 17th.
Set to the fraction of the samples testing
positive for COVID-19 that were sequenced.

(Stadler 2020a)

Exchangeability rates: Dir(1, 1, 1, 1, 1, 1)
Stationary frequencies: Dir(1, 1, 1, 1)
Gamma distribution shape: Exp(1)

We allow for site rate heterogeneity, and
assume unequal base frequencies and
transition/transversion rates.

22

